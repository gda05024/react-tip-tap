var EasyDrawer=(function(exports){'use strict';var Ui=class{constructor(o,e,i){this.x=o;this.y=e;this.z=i;}get xy(){return {x:this.x,y:this.y}}at(o){if(o===0)return this.x;if(o===1)return this.y;if(o===2)return this.z;throw new Error(`${o} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.magnitudeSquared())}magnitudeSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}squareDistanceTo(o){let e=this.x-o.x,i=this.y-o.y,r=this.z-o.z;return e*e+i*i+r*r}distanceTo(o){return Math.sqrt(this.squareDistanceTo(o))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.max(Math.abs(this.y),Math.abs(this.z)))}angle(){return Math.atan2(this.y,this.x)}normalized(){let o=this.magnitude();return exports.Vec3.of(this.x/o,this.y/o,this.z/o)}normalizedOrZero(){return this.eq(exports.Vec3.zero)?exports.Vec3.zero:this.normalized()}times(o){return exports.Vec3.of(this.x*o,this.y*o,this.z*o)}plus(o){return exports.Vec3.of(this.x+o.x,this.y+o.y,this.z+o.z)}minus(o){return exports.Vec3.of(this.x-o.x,this.y-o.y,this.z-o.z)}dot(o){return this.x*o.x+this.y*o.y+this.z*o.z}cross(o){return exports.Vec3.of(this.y*o.z-o.y*this.z,o.x*this.z-this.x*o.z,this.x*o.y-o.x*this.y)}scale(o){return typeof o=="number"?this.times(o):exports.Vec3.of(this.x*o.x,this.y*o.y,this.z*o.z)}orthog(){return this.dot(exports.Vec3.unitX)===0&&this.dot(exports.Vec3.unitY)===0?this.dot(exports.Vec3.unitX)===0?exports.Vec3.unitX:this.cross(exports.Vec3.unitX).normalized():this.cross(exports.Vec3.unitZ.times(-1)).normalized()}extend(o,e){return this.plus(e.normalized().times(o))}lerp(o,e){return this.times(1-e).plus(o.times(e))}zip(o,e){return exports.Vec3.of(e(o.x,this.x),e(o.y,this.y),e(o.z,this.z))}map(o){return exports.Vec3.of(o(this.x,0),o(this.y,1),o(this.z,2))}asArray(){return [this.x,this.y,this.z]}eq(o,e=1e-10){return Math.abs(o.x-this.x)<=e&&Math.abs(o.y-this.y)<=e&&Math.abs(o.z-this.z)<=e}toString(){return `Vec(${this.x}, ${this.y}, ${this.z})`}},Wi=class{constructor(o,e){this.x=o;this.y=e;}get z(){return 0}get xy(){return {x:this.x,y:this.y}}at(o){if(o===0)return this.x;if(o===1)return this.y;if(o===2)return 0;throw new Error(`${o} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}magnitudeSquared(){return this.x*this.x+this.y*this.y}squareDistanceTo(o){let e=this.x-o.x,i=this.y-o.y;return e*e+i*i+o.z*o.z}distanceTo(o){return Math.sqrt(this.squareDistanceTo(o))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.abs(this.y))}angle(){return Math.atan2(this.y,this.x)}normalized(){let o=this.magnitude();return exports.Vec2.of(this.x/o,this.y/o)}normalizedOrZero(){return this.eq(exports.Vec3.zero)?exports.Vec3.zero:this.normalized()}times(o){return exports.Vec2.of(this.x*o,this.y*o)}plus(o){return exports.Vec3.of(this.x+o.x,this.y+o.y,o.z)}minus(o){return exports.Vec3.of(this.x-o.x,this.y-o.y,-o.z)}dot(o){return this.x*o.x+this.y*o.y}cross(o){return exports.Vec3.of(this.y*o.z,-this.x*o.z,this.x*o.y-o.x*this.y)}scale(o){return typeof o=="number"?this.times(o):exports.Vec2.of(this.x*o.x,this.y*o.y)}orthog(){return this.dot(exports.Vec3.unitX)===0&&this.dot(exports.Vec3.unitY)===0?this.dot(exports.Vec3.unitX)===0?exports.Vec3.unitX:this.cross(exports.Vec3.unitX).normalized():this.cross(exports.Vec3.unitZ.times(-1)).normalized()}extend(o,e){return this.plus(e.normalized().times(o))}lerp(o,e){return this.times(1-e).plus(o.times(e))}zip(o,e){return exports.Vec3.of(e(o.x,this.x),e(o.y,this.y),e(o.z,0))}map(o){return exports.Vec3.of(o(this.x,0),o(this.y,1),o(0,2))}asArray(){return [this.x,this.y,0]}eq(o,e=1e-10){return Math.abs(o.x-this.x)<=e&&Math.abs(o.y-this.y)<=e&&Math.abs(o.z)<=e}toString(){return `Vec(${this.x}, ${this.y})`}};exports.Vec2=void 0;(n=>{function s(a,l){return new Wi(a,l)}n.of=s;function o({x:a,y:l}){return n.of(a,l)}n.ofXY=o,n.unitX=n.of(1,0),n.unitY=n.of(0,1),n.zero=n.of(0,0);})(exports.Vec2||={});exports.Vec3=void 0;(n=>{function s(a,l,c){return c===0?exports.Vec2.of(a,l):new Ui(a,l,c)}n.of=s,n.unitX=exports.Vec2.unitX,n.unitY=exports.Vec2.unitY,n.zero=exports.Vec2.zero,n.unitZ=n.of(0,0,1);})(exports.Vec3||={});var Fo=class s{static smallValue=1e-12;distance(o){return Math.abs(this.signedDistance(o))}containsPoint(o,e=s.smallValue){return this.signedDistance(o)<e}getLooseBoundingBox(){return this.getTightBoundingBox()}},Ze=Fo;var Oo=class extends Ze{intersectsLineSegment(o){return this.argIntersectsLineSegment(o).map(e=>this.at(e))}},pt=Oo;var w=class s{constructor(o,e,i,r,n,a,l,c,d){this.a1=o;this.a2=e;this.a3=i;this.b1=r;this.b2=n;this.b3=a;this.c1=l;this.c2=c;this.c3=d;this.rows=[exports.Vec3.of(o,e,i),exports.Vec3.of(r,n,a),exports.Vec3.of(l,c,d)];}rows;static ofRows(o,e,i){return new s(o.x,o.y,o.z,e.x,e.y,e.z,i.x,i.y,i.z)}static identity=new s(1,0,0,0,1,0,0,0,1);inverse(){return this.computeInverse()??s.identity}invertable(){return this.computeInverse()!==null}cachedInverse=void 0;computeInverse(){if(this.cachedInverse!==void 0)return this.cachedInverse;let o=[this.rows[0],this.rows[1],this.rows[2]],e=[exports.Vec3.unitX,exports.Vec3.unitY,exports.Vec3.unitZ];for(let r=0;r<3;r++){let n=o[r].at(r),a=1e-10;if(Math.abs(n)<a){let p=-1;for(let m=1;m<=2;m++){let f=(r+m)%3;if(Math.abs(o[f].at(r))>=a){p=f;break}}if(p===-1)return this.cachedInverse=null,null;let u=o[r],h=e[r];o[r]=o[p],e[r]=e[p],o[p]=u,e[p]=h,n=o[r].at(r);}let l=1/n;o[r]=o[r].times(l),e[r]=e[r].times(l);let c=o[r],d=e[r];for(let p=1;p<=2;p++){let u=(r+p)%3;l=-o[u].at(r),o[u]=o[u].plus(c.times(l)),e[u]=e[u].plus(d.times(l));}}let i=s.ofRows(e[0],e[1],e[2]);return this.cachedInverse=i,i}transposed(){return new s(this.a1,this.b1,this.c1,this.a2,this.b2,this.c2,this.a3,this.b3,this.c3)}rightMul(o){o=o.transposed();let e=(i,r)=>this.rows[i].dot(o.rows[r]);return new s(e(0,0),e(0,1),e(0,2),e(1,0),e(1,1),e(1,2),e(2,0),e(2,1),e(2,2))}transformVec2(o){let e=exports.Vec3.of(o.x,o.y,1);return e=this.transformVec3(e),exports.Vec2.of(e.x,e.y)}transformVec3(o){return exports.Vec3.of(this.rows[0].dot(o),this.rows[1].dot(o),this.rows[2].dot(o))}isIdentity(){return this===s.identity?true:this.eq(s.identity)}eq(o,e=0){for(let i=0;i<3;i++)if(!this.rows[i].eq(o.rows[i],e))return  false;return  true}toString(){let o="",e=[0,0,0];for(let i of this.rows)for(let r=0;r<3;r++)e[r]=Math.max(e[0],`${i.at(r)}`.length);for(let i=0;i<3;i++){i===0?o+="\u23A1 ":i===1?o+="\u23A2 ":o+="\u23A3 ";for(let r=0;r<3;r++){let n=this.rows[i].at(r).toString(),a="";for(let l=n.length;l<e[r];l++)a+=" ";o+=n+", "+a;}i===0?o+=" \u23A4":i===1?o+=" \u23A5":o+=" \u23A6",o+=`
`;}return o.trimEnd()}toArray(){return [this.a1,this.a2,this.a3,this.b1,this.b2,this.b3,this.c1,this.c2,this.c3]}mapEntries(o){return new s(o(this.a1,[0,0]),o(this.a2,[0,1]),o(this.a3,[0,2]),o(this.b1,[1,0]),o(this.b2,[1,1]),o(this.b3,[1,2]),o(this.c1,[2,0]),o(this.c2,[2,1]),o(this.c3,[2,2]))}getScaleFactor(){return Math.hypot(this.a1,this.a2)}getColumn(o){return exports.Vec3.of(this.rows[0].at(o),this.rows[1].at(o),this.rows[2].at(o))}maximumEntryMagnitude(){let o=Math.abs(this.a1);for(let e of this.toArray())o=Math.max(o,Math.abs(e));return o}static translation(o){return new s(1,0,o.x,0,1,o.y,0,0,1)}static zRotation(o,e=exports.Vec2.zero){if(o===0)return s.identity;let i=Math.cos(o),r=Math.sin(o),n=s.translation(e);return n=n.rightMul(new s(i,-r,0,r,i,0,0,0,1)),n.rightMul(s.translation(e.times(-1)))}static scaling2D(o,e=exports.Vec2.of(0,0)){let i=s.translation(e),r,n;return typeof o=="number"?(r=o,n=o):(r=o.x,n=o.y),i=i.rightMul(new s(r,0,0,0,n,0,0,0,1)),i.rightMul(s.translation(e.times(-1)))}toCSSMatrix(){return `matrix(${this.a1},${this.b1},${this.a2},${this.b2},${this.a3},${this.b3})`}static fromCSSMatrix(o){if(o===""||o==="none")return s.identity;o=o.trim().replace(/\s+/g," ");let e=l=>l.split(/[\t\n ,]+/g).map(d=>{if(d.trim()==="")return null;let p=false;if(d.endsWith("%")&&(p=true,d=d.substring(0,d.length-1)),d=d.replace(/px$/gi,""),!/^-?\d*(?:\.\d*)?(?:e[+-]?\d+)?$/i.test(d))throw new Error(`All arguments to transform functions must be numeric (state: ${JSON.stringify({currentArgument:d,allArguments:l})})`);let h=Number.parseFloat(d);return p&&(h/=100),h}).filter(d=>d!==null),i={matrix:l=>{if(l.length!==6)throw new Error(`Invalid matrix argument: ${l}. Must have length 6`);let c=l[0],d=l[1],p=l[2],u=l[3],h=l[4],m=l[5];return new s(c,p,h,d,u,m,0,0,1)},scale:l=>{let c,d;if(l.length===1)c=l[0],d=l[0];else if(l.length===2)c=l[0],d=l[1];else throw new Error(`The scale() function only supports two arguments. Given: ${l}`);return s.scaling2D(exports.Vec2.of(c,d))},translate:l=>{let c=0,d=0;if(l.length===1)c=l[0];else if(l.length===2)c=l[0],d=l[1];else throw new Error(`The translate() function requires either 1 or 2 arguments. Given ${l}`);return s.translation(exports.Vec2.of(c,d))}},r=/(?:^|\W)(\w+)\s?\(([^)]*)\)/gi,n,a=null;for(;(n=r.exec(o))!==null;){let l=n[1].toLowerCase();if(!(l in i))throw new Error(`Unsupported CSS transform action: ${l}`);let c=e(n[2]),d=i[l](c);a?a=a.rightMul(d):a=d;}return a??s.identity}},fn=w;var I=class s extends Ze{constructor(e,i,r,n){super();this.x=e;this.y=i;this.w=r;this.h=n;r<0&&(this.x+=r,this.w=Math.abs(r)),n<0&&(this.y+=n,this.h=Math.abs(n)),this.topLeft=exports.Vec2.of(this.x,this.y),this.size=exports.Vec2.of(this.w,this.h),this.area=this.w*this.h;}topLeft;size;area;translatedBy(e){return new s(e.x+this.x,e.y+this.y,this.w,this.h)}resizedTo(e){return new s(this.x,this.y,e.x,e.y)}containsPoint(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x&&this.y+this.h>=e.y}containsRect(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x+e.w&&this.y+this.h>=e.y+e.h}intersects(e){let i=this.x,r=i+this.w,n=e.x,a=e.x+e.w;if(r<n||i>a)return  false;let l=this.y,c=l+this.h,d=e.y,p=e.y+e.h;return !(c<d||l>p)}intersection(e){if(!this.intersects(e))return null;let i=this.topLeft.zip(e.topLeft,Math.max),r=this.bottomRight.zip(e.bottomRight,Math.min);return s.fromCorners(i,r)}union(e){return s.union(this,e)}divideIntoGrid(e,i){let r=[];if(e<=0||i<=0)return r;let n=this.w/e,a=this.h/i;n===0&&(e=1),a===0&&(i=1);for(let l=0;l<i;l++)for(let c=0;c<e;c++){let d=n*c+this.x,p=a*l+this.y;r.push(new s(d,p,n,a));}return r}grownToPoint(e,i=0){let r=new s(e.x-i,e.y-i,i*2,i*2);return this.union(r)}grownBy(e){if(e===0)return this;if(e<0){let i=-Math.min(-e,this.w/2),r=-Math.min(-e,this.h/2);return new s(this.x-i,this.y-r,this.w+i*2,this.h+r*2)}return new s(this.x-e,this.y-e,this.w+e*2,this.h+e*2)}grownToSize(e){if(this.width>=e.x&&this.height>=e.y)return this;let i=Math.max(0,e.x-this.width),r=Math.max(0,e.y-this.height);return new s(this.x-i/2,this.y-r/2,this.width+i,this.height+r)}getClosestPointOnBoundaryTo(e){let i=this.getEdges().map(a=>a.closestPointTo(e)),r=null,n=null;for(let a of i){let l=a.distanceTo(e);(n===null||l<n)&&(r=a,n=l);}return r}isWithinRadiusOf(e,i){if(this.maxDimension>e)return  false;let r=e*e;return this.corners.every(n=>n.minus(i).magnitudeSquared()<r)}get corners(){return [this.bottomRight,this.topRight,this.topLeft,this.bottomLeft]}get maxDimension(){return Math.max(this.w,this.h)}get minDimension(){return Math.min(this.w,this.h)}get bottomRight(){return this.topLeft.plus(this.size)}get topRight(){return this.bottomRight.plus(exports.Vec2.of(0,-this.h))}get bottomLeft(){return this.topLeft.plus(exports.Vec2.of(0,this.h))}get width(){return this.w}get height(){return this.h}get center(){return exports.Vec2.of(this.x+this.w/2,this.y+this.h/2)}getEdges(){let e=this.corners;return [new te(e[0],e[1]),new te(e[1],e[2]),new te(e[2],e[3]),new te(e[3],e[0])]}intersectsLineSegment(e){let i=[];for(let r of this.getEdges())r.intersectsLineSegment(e).forEach(a=>i.push(a));return i}signedDistance(e){let i=this.getClosestPointOnBoundaryTo(e),r=e.minus(i).magnitude();return this.containsPoint(e)?-r:r}getTightBoundingBox(){return this}transformedBoundingBox(e){return e===fn.identity?this:s.bboxOf(this.corners.map(i=>e.transformVec2(i)))}eq(e,i=0){return this.topLeft.eq(e.topLeft,i)&&this.size.eq(e.size,i)}toString(){return `Rect(point(${this.x}, ${this.y}), size(${this.w}, ${this.h}))`}static fromCorners(e,i){return new s(Math.min(e.x,i.x),Math.min(e.y,i.y),Math.abs(e.x-i.x),Math.abs(e.y-i.y))}static bboxOf(e,i=0){let r=0,n=0,a=0,l=0,c=true;for(let d of e)c&&(r=d.x,n=d.y,a=d.x,l=d.y,c=false),r=Math.min(r,d.x),n=Math.min(n,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y);return s.fromCorners(exports.Vec2.of(r-i,n-i),exports.Vec2.of(a+i,l+i))}static union(...e){if(e.length===0)return s.empty;let i=e[0],r=i.x,n=i.y,a=i.x+i.w,l=i.y+i.h;for(let c=1;c<e.length;c++){let d=e[c];r=Math.min(r,d.x),n=Math.min(n,d.y),a=Math.max(a,d.x+d.w),l=Math.max(l,d.y+d.h);}return new s(r,n,a-r,l-n)}static of(e){let i=e.width??e.w??0,r=e.height??e.h??0;return new s(e.x,e.y,i,r)}static empty=new s(0,0,0,0);static unitSquare=new s(0,0,1,1)},X=I;var oe=class s extends pt{constructor(e,i){super();this.point1=e;this.point2=i;this.bbox=X.bboxOf([e,i]),this.direction=i.minus(e),this.length=this.direction.magnitude(),this.length>0&&(this.direction=this.direction.times(1/this.length));}direction;length;bbox;static ofSmallestContainingPoints(e){if(e.length<=1)return null;let i=[...e].sort((n,a)=>n.x!==a.x?n.x-a.x:n.y-a.y),r=new s(i[0],i[i.length-1]);for(let n of i)if(!r.containsPoint(n))return null;return r}get p1(){return this.point1}get p2(){return this.point2}get center(){return this.point1.lerp(this.point2,.5)}get(e){return this.point1.plus(this.direction.times(e))}at(e){return this.get(e*this.length)}normalAt(e){return this.direction.orthog()}tangentAt(e){return this.direction}splitAt(e){return e<=0||e>=1?[this]:[new s(this.point1,this.at(e)),new s(this.at(e),this.point2)]}intersection(e){let i,r;if(Math.abs(this.direction.x)<4e-13){if(e.direction.x===0||this.direction.y===0)return null;let p=this.point1.x,u=(this.point1.x-e.point1.x)*e.direction.y/e.direction.x+e.point1.y;i=exports.Vec2.of(p,u),r=(u-this.point1.y)/this.direction.y;}else {let p=(this.point1.y-e.point1.y)*this.direction.x*e.direction.x+this.direction.x*e.direction.y*e.point1.x-this.direction.y*e.direction.x*this.point1.x,u=e.direction.y*this.direction.x-this.direction.y*e.direction.x;if(u===0)return null;let h=p/u,m=(h-this.point1.x)/this.direction.x,f=this.point1.y+this.direction.y*m;i=exports.Vec2.of(h,f),r=(h-this.point1.x)/this.direction.x;}let a=i.distanceTo(this.point1),l=i.distanceTo(this.point2),c=i.distanceTo(e.point1),d=i.distanceTo(e.point2);return a>this.length||l>this.length||c>e.length||d>e.length?null:{point:i,t:r}}intersects(e){return this.intersection(e)!==null}argIntersectsLineSegment(e){let i=this.intersection(e);return i?[i.t/this.length]:[]}intersectsLineSegment(e){let i=this.intersection(e);return i?[i.point]:[]}closestPointTo(e){return this.nearestPointTo(e).point}nearestPointTo(e){let i=e.minus(this.p1).dot(this.direction),r=this.length-i,n=this.p1.plus(this.direction.times(i));return i>0&&i<this.length?{point:n,parameterValue:i/this.length}:Math.abs(r)<Math.abs(i)?{point:this.p2,parameterValue:1}:{point:this.p1,parameterValue:0}}signedDistance(e){return this.closestPointTo(e).minus(e).magnitude()}transformedBy(e){return new s(e.transformVec2(this.p1),e.transformVec2(this.p2))}getTightBoundingBox(){return this.bbox}toString(){return `LineSegment(${this.p1.toString()}, ${this.p2.toString()})`}eq(e,i){if(!(e instanceof s))return  false;let r=i?.tolerance,n=i?.ignoreDirection??true;return e.p1.eq(this.p1,r)&&e.p2.eq(this.p2,r)||n&&e.p1.eq(this.p2,r)&&e.p2.eq(this.p1,r)}},te=oe;var{abs:Kt,cos:Le,sin:ut,acos:Ns,atan2:Gt,sqrt:Fe,pow:me}=Math;function _t(s){return s<0?-me(-s,1/3):me(s,1/3)}var gn=Math.PI,Ho=2*gn,Oe=gn/2,Us=1e-6,$i=Number.MAX_SAFE_INTEGER||9007199254740991,Ki=Number.MIN_SAFE_INTEGER||-9007199254740991,Ws={x:0,y:0,z:0},E={Tvalues:[-0.06405689286260563,.06405689286260563,-0.1911188674736163,.1911188674736163,-0.3150426796961634,.3150426796961634,-0.4337935076260451,.4337935076260451,-0.5454214713888396,.5454214713888396,-0.6480936519369755,.6480936519369755,-0.7401241915785544,.7401241915785544,-0.820001985973903,.820001985973903,-0.8864155270044011,.8864155270044011,-0.9382745520027328,.9382745520027328,-0.9747285559713095,.9747285559713095,-0.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(s,o){let e=o(s),i=e.x*e.x+e.y*e.y;return typeof e.z<"u"&&(i+=e.z*e.z),Fe(i)},compute:function(s,o,e){if(s===0)return o[0].t=0,o[0];let i=o.length-1;if(s===1)return o[i].t=1,o[i];let r=1-s,n=o;if(i===0)return o[0].t=s,o[0];if(i===1){let l={x:r*n[0].x+s*n[1].x,y:r*n[0].y+s*n[1].y,t:s};return e&&(l.z=r*n[0].z+s*n[1].z),l}if(i<4){let l=r*r,c=s*s,d,p,u,h=0;i===2?(n=[n[0],n[1],n[2],Ws],d=l,p=r*s*2,u=c):i===3&&(d=l*r,p=l*s*3,u=r*c*3,h=s*c);let m={x:d*n[0].x+p*n[1].x+u*n[2].x+h*n[3].x,y:d*n[0].y+p*n[1].y+u*n[2].y+h*n[3].y,t:s};return e&&(m.z=d*n[0].z+p*n[1].z+u*n[2].z+h*n[3].z),m}let a=JSON.parse(JSON.stringify(o));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*s,y:a[l].y+(a[l+1].y-a[l].y)*s},typeof a[l].z<"u"&&(a[l].z=a[l].z+(a[l+1].z-a[l].z)*s);a.splice(a.length-1,1);}return a[0].t=s,a[0]},computeWithRatios:function(s,o,e,i){let r=1-s,n=e,a=o,l=n[0],c=n[1],d=n[2],p=n[3],u;if(l*=r,c*=s,a.length===2)return u=l+c,{x:(l*a[0].x+c*a[1].x)/u,y:(l*a[0].y+c*a[1].y)/u,z:i?(l*a[0].z+c*a[1].z)/u:false,t:s};if(l*=r,c*=2*r,d*=s*s,a.length===3)return u=l+c+d,{x:(l*a[0].x+c*a[1].x+d*a[2].x)/u,y:(l*a[0].y+c*a[1].y+d*a[2].y)/u,z:i?(l*a[0].z+c*a[1].z+d*a[2].z)/u:false,t:s};if(l*=r,c*=1.5*r,d*=3*r,p*=s*s*s,a.length===4)return u=l+c+d+p,{x:(l*a[0].x+c*a[1].x+d*a[2].x+p*a[3].x)/u,y:(l*a[0].y+c*a[1].y+d*a[2].y+p*a[3].y)/u,z:i?(l*a[0].z+c*a[1].z+d*a[2].z+p*a[3].z)/u:false,t:s}},derive:function(s,o){let e=[];for(let i=s,r=i.length,n=r-1;r>1;r--,n--){let a=[];for(let l=0,c;l<n;l++)c={x:n*(i[l+1].x-i[l].x),y:n*(i[l+1].y-i[l].y)},o&&(c.z=n*(i[l+1].z-i[l].z)),a.push(c);e.push(a),i=a;}return e},between:function(s,o,e){return o<=s&&s<=e||E.approximately(s,o)||E.approximately(s,e)},approximately:function(s,o,e){return Kt(s-o)<=(e||Us)},length:function(s){let e=E.Tvalues.length,i=0;for(let r=0,n;r<e;r++)n=.5*E.Tvalues[r]+.5,i+=E.Cvalues[r]*E.arcfn(n,s);return .5*i},map:function(s,o,e,i,r){let n=e-o,a=r-i,l=s-o,c=l/n;return i+a*c},lerp:function(s,o,e){let i={x:o.x+s*(e.x-o.x),y:o.y+s*(e.y-o.y)};return o.z!==void 0&&e.z!==void 0&&(i.z=o.z+s*(e.z-o.z)),i},pointToString:function(s){let o=s.x+"/"+s.y;return typeof s.z<"u"&&(o+="/"+s.z),o},pointsToString:function(s){return "["+s.map(E.pointToString).join(", ")+"]"},copy:function(s){return JSON.parse(JSON.stringify(s))},angle:function(s,o,e){let i=o.x-s.x,r=o.y-s.y,n=e.x-s.x,a=e.y-s.y,l=i*a-r*n,c=i*n+r*a;return Gt(l,c)},round:function(s,o){let e=""+s,i=e.indexOf(".");return parseFloat(e.substring(0,i+1+o))},dist:function(s,o){let e=s.x-o.x,i=s.y-o.y;return Fe(e*e+i*i)},closest:function(s,o){let e=me(2,63),i,r;return s.forEach(function(n,a){r=E.dist(o,n),r<e&&(e=r,i=a);}),{mdist:e,mpos:i}},abcratio:function(s,o){if(o!==2&&o!==3)return  false;if(typeof s>"u")s=.5;else if(s===0||s===1)return s;let e=me(s,o)+me(1-s,o),i=e-1;return Kt(i/e)},projectionratio:function(s,o){if(o!==2&&o!==3)return  false;if(typeof s>"u")s=.5;else if(s===0||s===1)return s;let e=me(1-s,o),i=me(s,o)+e;return e/i},lli8:function(s,o,e,i,r,n,a,l){let c=(s*i-o*e)*(r-a)-(s-e)*(r*l-n*a),d=(s*i-o*e)*(n-l)-(o-i)*(r*l-n*a),p=(s-e)*(n-l)-(o-i)*(r-a);return p==0?false:{x:c/p,y:d/p}},lli4:function(s,o,e,i){let r=s.x,n=s.y,a=o.x,l=o.y,c=e.x,d=e.y,p=i.x,u=i.y;return E.lli8(r,n,a,l,c,d,p,u)},lli:function(s,o){return E.lli4(s,s.c,o,o.c)},makeline:function(s,o){return new ht(s.x,s.y,(s.x+o.x)/2,(s.y+o.y)/2,o.x,o.y)},findbbox:function(s){let o=$i,e=$i,i=Ki,r=Ki;return s.forEach(function(n){let a=n.bbox();o>a.x.min&&(o=a.x.min),e>a.y.min&&(e=a.y.min),i<a.x.max&&(i=a.x.max),r<a.y.max&&(r=a.y.max);}),{x:{min:o,mid:(o+i)/2,max:i,size:i-o},y:{min:e,mid:(e+r)/2,max:r,size:r-e}}},shapeintersections:function(s,o,e,i,r){if(!E.bboxoverlap(o,i))return [];let n=[],a=[s.startcap,s.forward,s.back,s.endcap],l=[e.startcap,e.forward,e.back,e.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(d){if(d.virtual)return;let p=c.intersects(d,r);p.length>0&&(p.c1=c,p.c2=d,p.s1=s,p.s2=e,n.push(p));});}),n},makeshape:function(s,o,e){let i=o.points.length,r=s.points.length,n=E.makeline(o.points[i-1],s.points[0]),a=E.makeline(s.points[r-1],o.points[0]),l={startcap:n,forward:s,back:o,endcap:a,bbox:E.findbbox([n,s,o,a])};return l.intersections=function(c){return E.shapeintersections(l,l.bbox,c,c.bbox,e)},l},getminmax:function(s,o,e){if(!e)return {min:0,max:0};let i=$i,r=Ki,n,a;e.indexOf(0)===-1&&(e=[0].concat(e)),e.indexOf(1)===-1&&e.push(1);for(let l=0,c=e.length;l<c;l++)n=e[l],a=s.get(n),a[o]<i&&(i=a[o]),a[o]>r&&(r=a[o]);return {min:i,mid:(i+r)/2,max:r,size:r-i}},align:function(s,o){let e=o.p1.x,i=o.p1.y,r=-Gt(o.p2.y-i,o.p2.x-e),n=function(a){return {x:(a.x-e)*Le(r)-(a.y-i)*ut(r),y:(a.x-e)*ut(r)+(a.y-i)*Le(r)}};return s.map(n)},roots:function(s,o){o=o||{p1:{x:0,y:0},p2:{x:1,y:0}};let e=s.length-1,i=E.align(s,o),r=function(k){return 0<=k&&k<=1};if(e===2){let k=i[0].y,D=i[1].y,U=i[2].y,$=k-2*D+U;if($!==0){let de=-Fe(D*D-k*U),se=-k+D,pe=-(de+se)/$,Se=-(-de+se)/$;return [pe,Se].filter(r)}else if(D!==U&&$===0)return [(2*D-U)/(2*D-2*U)].filter(r);return []}let n=i[0].y,a=i[1].y,l=i[2].y,c=i[3].y,d=-n+3*a-3*l+c,p=3*n-6*a+3*l,u=-3*n+3*a,h=n;if(E.approximately(d,0)){if(E.approximately(p,0))return E.approximately(u,0)?[]:[-h/u].filter(r);let k=Fe(u*u-4*p*h),D=2*p;return [(k-u)/D,(-u-k)/D].filter(r)}p/=d,u/=d,h/=d;let m=(3*u-p*p)/3,f=m/3,g=(2*p*p*p-9*p*u+27*h)/27,y=g/2,v=y*y+f*f*f,b,S,T,C,R;if(v<0){let k=-m/3,D=k*k*k,U=Fe(D),$=-g/(2*U),de=$<-1?-1:$>1?1:$,se=Ns(de),pe=_t(U),Se=2*pe;return T=Se*Le(se/3)-p/3,C=Se*Le((se+Ho)/3)-p/3,R=Se*Le((se+2*Ho)/3)-p/3,[T,C,R].filter(r)}else {if(v===0)return b=y<0?_t(-y):-_t(y),T=2*b-p/3,C=-b-p/3,[T,C].filter(r);{let k=Fe(v);return b=_t(-y+k),S=_t(y+k),[b-S-p/3].filter(r)}}},droots:function(s){if(s.length===3){let o=s[0],e=s[1],i=s[2],r=o-2*e+i;if(r!==0){let n=-Fe(e*e-o*i),a=-o+e,l=-(n+a)/r,c=-(-n+a)/r;return [l,c]}else if(e!==i&&r===0)return [(2*e-i)/(2*(e-i))];return []}if(s.length===2){let o=s[0],e=s[1];return o!==e?[o/(o-e)]:[]}return []},curvature:function(s,o,e,i,r){let n,a,l,c,d=0,p=0,u=E.compute(s,o),h=E.compute(s,e),m=u.x*u.x+u.y*u.y;if(i?(n=Fe(me(u.y*h.z-h.y*u.z,2)+me(u.z*h.x-h.z*u.x,2)+me(u.x*h.y-h.x*u.y,2)),a=me(m+u.z*u.z,3/2)):(n=u.x*h.y-u.y*h.x,a=me(m,3/2)),n===0||a===0)return {k:0,r:0};if(d=n/a,p=a/n,!r){let f=E.curvature(s-.001,o,e,i,true).k,g=E.curvature(s+.001,o,e,i,true).k;c=(g-d+(d-f))/2,l=(Kt(g-d)+Kt(d-f))/2;}return {k:d,r:p,dk:c,adk:l}},inflections:function(s){if(s.length<4)return [];let o=E.align(s,{p1:s[0],p2:s.slice(-1)[0]}),e=o[2].x*o[1].y,i=o[3].x*o[1].y,r=o[1].x*o[2].y,n=o[3].x*o[2].y,a=18*(-3*e+2*i+3*r-n),l=18*(3*e-i-3*r),c=18*(r-e);if(E.approximately(a,0)){if(!E.approximately(l,0)){let h=-c/l;if(0<=h&&h<=1)return [h]}return []}let d=2*a;if(E.approximately(d,0))return [];let p=l*l-4*a*c;if(p<0)return [];let u=Math.sqrt(p);return [(u-l)/d,-(l+u)/d].filter(function(h){return 0<=h&&h<=1})},bboxoverlap:function(s,o){let e=["x","y"],i=e.length;for(let r=0,n,a,l,c;r<i;r++)if(n=e[r],a=s[n].mid,l=o[n].mid,c=(s[n].size+o[n].size)/2,Kt(a-l)>=c)return  false;return  true},expandbox:function(s,o){o.x.min<s.x.min&&(s.x.min=o.x.min),o.y.min<s.y.min&&(s.y.min=o.y.min),o.z&&o.z.min<s.z.min&&(s.z.min=o.z.min),o.x.max>s.x.max&&(s.x.max=o.x.max),o.y.max>s.y.max&&(s.y.max=o.y.max),o.z&&o.z.max>s.z.max&&(s.z.max=o.z.max),s.x.mid=(s.x.min+s.x.max)/2,s.y.mid=(s.y.min+s.y.max)/2,s.z&&(s.z.mid=(s.z.min+s.z.max)/2),s.x.size=s.x.max-s.x.min,s.y.size=s.y.max-s.y.min,s.z&&(s.z.size=s.z.max-s.z.min);},pairiteration:function(s,o,e){let i=s.bbox(),r=o.bbox(),n=1e5,a=e||.5;if(i.x.size+i.y.size<a&&r.x.size+r.y.size<a)return [(n*(s._t1+s._t2)/2|0)/n+"/"+(n*(o._t1+o._t2)/2|0)/n];let l=s.split(.5),c=o.split(.5),d=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];d=d.filter(function(u){return E.bboxoverlap(u.left.bbox(),u.right.bbox())});let p=[];return d.length===0||(d.forEach(function(u){p=p.concat(E.pairiteration(u.left,u.right,a));}),p=p.filter(function(u,h){return p.indexOf(u)===h})),p},getccenter:function(s,o,e){let i=o.x-s.x,r=o.y-s.y,n=e.x-o.x,a=e.y-o.y,l=i*Le(Oe)-r*ut(Oe),c=i*ut(Oe)+r*Le(Oe),d=n*Le(Oe)-a*ut(Oe),p=n*ut(Oe)+a*Le(Oe),u=(s.x+o.x)/2,h=(s.y+o.y)/2,m=(o.x+e.x)/2,f=(o.y+e.y)/2,g=u+l,y=h+c,v=m+d,b=f+p,S=E.lli8(u,h,g,y,m,f,v,b),T=E.dist(S,s),C=Gt(s.y-S.y,s.x-S.x),R=Gt(o.y-S.y,o.x-S.x),k=Gt(e.y-S.y,e.x-S.x),D;return C<k?((C>R||R>k)&&(C+=Ho),C>k&&(D=k,k=C,C=D)):k<R&&R<C?(D=k,k=C,C=D):k+=Ho,S.s=C,S.e=k,S.r=T,S},numberSort:function(s,o){return s-o}};var mt=class s{constructor(o){this.curves=[],this._3d=false,o&&(this.curves=o,this._3d=this.curves[0]._3d);}valueOf(){return this.toString()}toString(){return "["+this.curves.map(function(o){return E.pointsToString(o.points)}).join(", ")+"]"}addCurve(o){this.curves.push(o),this._3d=this._3d||o._3d;}length(){return this.curves.map(function(o){return o.length()}).reduce(function(o,e){return o+e})}curve(o){return this.curves[o]}bbox(){let o=this.curves;for(var e=o[0].bbox(),i=1;i<o.length;i++)E.expandbox(e,o[i].bbox());return e}offset(o){let e=[];return this.curves.forEach(function(i){e.push(...i.offset(o));}),new s(e)}};var{abs:qt,min:bn,max:yn,cos:$s,sin:Ks,acos:Gs,sqrt:Zt}=Math,_s=Math.PI;var ht=class s{constructor(o){let e=o&&o.forEach?o:Array.from(arguments).slice(),i=false;if(typeof e[0]=="object"){i=e.length;let m=[];e.forEach(function(f){["x","y","z"].forEach(function(g){typeof f[g]<"u"&&m.push(f[g]);});}),e=m;}let r=false,n=e.length;if(i){if(i>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");r=true;}}else if(n!==6&&n!==8&&n!==9&&n!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");let a=this._3d=!r&&(n===9||n===12)||o&&o[0]&&typeof o[0].z<"u",l=this.points=[];for(let m=0,f=a?3:2;m<n;m+=f){var c={x:e[m],y:e[m+1]};a&&(c.z=e[m+2]),l.push(c);}let d=this.order=l.length-1,p=this.dims=["x","y"];a&&p.push("z"),this.dimlen=p.length;let u=E.align(l,{p1:l[0],p2:l[d]}),h=E.dist(l[0],l[d]);this._linear=u.reduce((m,f)=>m+qt(f.y),0)<h/50,this._lut=[],this._t1=0,this._t2=1,this.update();}static quadraticFromPoints(o,e,i,r){if(typeof r>"u"&&(r=.5),r===0)return new s(e,e,i);if(r===1)return new s(o,e,e);let n=s.getABC(2,o,e,i,r);return new s(o,n.A,i)}static cubicFromPoints(o,e,i,r,n){typeof r>"u"&&(r=.5);let a=s.getABC(3,o,e,i,r);typeof n>"u"&&(n=E.dist(e,a.C));let l=n*(1-r)/r,c=E.dist(o,i),d=(i.x-o.x)/c,p=(i.y-o.y)/c,u=n*d,h=n*p,m=l*d,f=l*p,g={x:e.x-u,y:e.y-h},y={x:e.x+m,y:e.y+f},v=a.A,b={x:v.x+(g.x-v.x)/(1-r),y:v.y+(g.y-v.y)/(1-r)},S={x:v.x+(y.x-v.x)/r,y:v.y+(y.y-v.y)/r},T={x:o.x+(b.x-o.x)/r,y:o.y+(b.y-o.y)/r},C={x:i.x+(S.x-i.x)/(1-r),y:i.y+(S.y-i.y)/(1-r)};return new s(o,T,C,i)}static getUtils(){return E}getUtils(){return s.getUtils()}static get PolyBezier(){return mt}valueOf(){return this.toString()}toString(){return E.pointsToString(this.points)}toSVG(){if(this._3d)return  false;let o=this.points,e=o[0].x,i=o[0].y,r=["M",e,i,this.order===2?"Q":"C"];for(let n=1,a=o.length;n<a;n++)r.push(o[n].x),r.push(o[n].y);return r.join(" ")}setRatios(o){if(o.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=o,this._lut=[];}verify(){let o=this.coordDigest();o!==this._print&&(this._print=o,this.update());}coordDigest(){return this.points.map(function(o,e){return ""+e+o.x+o.y+(o.z?o.z:0)}).join("")}update(){this._lut=[],this.dpoints=E.derive(this.points,this._3d),this.computedirection();}computedirection(){let o=this.points,e=E.angle(o[0],o[this.order],o[1]);this.clockwise=e>0;}length(){return E.length(this.derivative.bind(this))}static getABC(o=2,e,i,r,n=.5){let a=E.projectionratio(n,o),l=1-a,c={x:a*e.x+l*r.x,y:a*e.y+l*r.y},d=E.abcratio(n,o);return {A:{x:i.x+(i.x-c.x)/d,y:i.y+(i.y-c.y)/d},B:i,C:c,S:e,E:r}}getABC(o,e){e=e||this.get(o);let i=this.points[0],r=this.points[this.order];return s.getABC(this.order,i,e,r,o)}getLUT(o){if(this.verify(),o=o||100,this._lut.length===o+1)return this._lut;this._lut=[],o++,this._lut=[];for(let e=0,i,r;e<o;e++)r=e/(o-1),i=this.compute(r),i.t=r,this._lut.push(i);return this._lut}on(o,e){e=e||5;let i=this.getLUT(),r=[];for(let n=0,a,l=0;n<i.length;n++)a=i[n],E.dist(a,o)<e&&(r.push(a),l+=n/i.length);return r.length?t/=r.length:false}project(o){let e=this.getLUT(),i=e.length-1,r=E.closest(e,o),n=r.mpos,a=(n-1)/i,l=(n+1)/i,c=.1/i,d=r.mdist,p=a,u=p,h;d+=1;for(let m;p<l+c;p+=c)h=this.compute(p),m=E.dist(o,h),m<d&&(d=m,u=p);return u=u<0?0:u>1?1:u,h=this.compute(u),h.t=u,h.d=d,h}get(o){return this.compute(o)}point(o){return this.points[o]}compute(o){return this.ratios?E.computeWithRatios(o,this.points,this.ratios,this._3d):E.compute(o,this.points,this._3d,this.ratios)}raise(){let o=this.points,e=[o[0]],i=o.length;for(let r=1,n,a;r<i;r++)n=o[r],a=o[r-1],e[r]={x:(i-r)/i*n.x+r/i*a.x,y:(i-r)/i*n.y+r/i*a.y};return e[i]=o[i-1],new s(e)}derivative(o){return E.compute(o,this.dpoints[0],this._3d)}dderivative(o){return E.compute(o,this.dpoints[1],this._3d)}align(){let o=this.points;return new s(E.align(o,{p1:o[0],p2:o[o.length-1]}))}curvature(o){return E.curvature(o,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return E.inflections(this.points)}normal(o){return this._3d?this.__normal3(o):this.__normal2(o)}__normal2(o){let e=this.derivative(o),i=Zt(e.x*e.x+e.y*e.y);return {t:o,x:-e.y/i,y:e.x/i}}__normal3(o){let e=this.derivative(o),i=this.derivative(o+.01),r=Zt(e.x*e.x+e.y*e.y+e.z*e.z),n=Zt(i.x*i.x+i.y*i.y+i.z*i.z);e.x/=r,e.y/=r,e.z/=r,i.x/=n,i.y/=n,i.z/=n;let a={x:i.y*e.z-i.z*e.y,y:i.z*e.x-i.x*e.z,z:i.x*e.y-i.y*e.x},l=Zt(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;let c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return {t:o,x:c[0]*e.x+c[1]*e.y+c[2]*e.z,y:c[3]*e.x+c[4]*e.y+c[5]*e.z,z:c[6]*e.x+c[7]*e.y+c[8]*e.z}}hull(o){let e=this.points,i=[],r=[],n=0;for(r[n++]=e[0],r[n++]=e[1],r[n++]=e[2],this.order===3&&(r[n++]=e[3]);e.length>1;){i=[];for(let a=0,l,c=e.length-1;a<c;a++)l=E.lerp(o,e[a],e[a+1]),r[n++]=l,i.push(l);e=i;}return r}split(o,e){if(o===0&&e)return this.split(e).left;if(e===1)return this.split(o).right;let i=this.hull(o),r={left:this.order===2?new s([i[0],i[3],i[5]]):new s([i[0],i[4],i[7],i[9]]),right:this.order===2?new s([i[5],i[4],i[2]]):new s([i[9],i[8],i[6],i[3]]),span:i};return r.left._t1=E.map(0,0,1,this._t1,this._t2),r.left._t2=E.map(o,0,1,this._t1,this._t2),r.right._t1=E.map(o,0,1,this._t1,this._t2),r.right._t2=E.map(1,0,1,this._t1,this._t2),e?(e=E.map(e,o,1,0,1),r.right.split(e).left):r}extrema(){let o={},e=[];return this.dims.forEach(function(i){let r=function(a){return a[i]},n=this.dpoints[0].map(r);o[i]=E.droots(n),this.order===3&&(n=this.dpoints[1].map(r),o[i]=o[i].concat(E.droots(n))),o[i]=o[i].filter(function(a){return a>=0&&a<=1}),e=e.concat(o[i].sort(E.numberSort));}.bind(this)),o.values=e.sort(E.numberSort).filter(function(i,r){return e.indexOf(i)===r}),o}bbox(){let o=this.extrema(),e={};return this.dims.forEach(function(i){e[i]=E.getminmax(this,i,o[i]);}.bind(this)),e}overlaps(o){let e=this.bbox(),i=o.bbox();return E.bboxoverlap(e,i)}offset(o,e){if(typeof e<"u"){let i=this.get(o),r=this.normal(o),n={c:i,n:r,x:i.x+r.x*e,y:i.y+r.y*e};return this._3d&&(n.z=i.z+r.z*e),n}if(this._linear){let i=this.normal(0),r=this.points.map(function(n){let a={x:n.x+o*i.x,y:n.y+o*i.y};return n.z&&i.z&&(a.z=n.z+o*i.z),a});return [new s(r)]}return this.reduce().map(function(i){return i._linear?i.offset(o)[0]:i.scale(o)})}simple(){if(this.order===3){let r=E.angle(this.points[0],this.points[3],this.points[1]),n=E.angle(this.points[0],this.points[3],this.points[2]);if(r>0&&n<0||r<0&&n>0)return  false}let o=this.normal(0),e=this.normal(1),i=o.x*e.x+o.y*e.y;return this._3d&&(i+=o.z*e.z),qt(Gs(i))<_s/3}reduce(){let o,e=0,i=0,r=.01,n,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),e=c[0],o=1;o<c.length;o++)i=c[o],n=this.split(e,i),n._t1=e,n._t2=i,a.push(n),e=i;return a.forEach(function(d){for(e=0,i=0;i<=1;)for(i=e+r;i<=1+r;i+=r)if(n=d.split(e,i),!n.simple()){if(i-=r,qt(e-i)<r)return [];n=d.split(e,i),n._t1=E.map(e,0,1,d._t1,d._t2),n._t2=E.map(i,0,1,d._t1,d._t2),l.push(n),e=i;break}e<1&&(n=d.split(e,1),n._t1=E.map(e,0,1,d._t1,d._t2),n._t2=d._t2,l.push(n));}),l}translate(o,e,i){i=typeof i=="number"?i:e;let r=this.order,n=this.points.map((a,l)=>(1-l/r)*e+l/r*i);return new s(this.points.map((a,l)=>({x:a.x+o.x*n[l],y:a.y+o.y*n[l]})))}scale(o){let e=this.order,i=false;if(typeof o=="function"&&(i=o),i&&e===2)return this.raise().scale(i);let r=this.clockwise,n=this.points;if(this._linear)return this.translate(this.normal(0),i?i(0):o,i?i(1):o);let a=i?i(0):o,l=i?i(1):o,c=[this.offset(0,10),this.offset(1,10)],d=[],p=E.lli4(c[0],c[0].c,c[1],c[1].c);if(!p)throw new Error("cannot scale this curve. Try reducing it first.");return [0,1].forEach(function(u){let h=d[u*e]=E.copy(n[u*e]);h.x+=(u?l:a)*c[u].n.x,h.y+=(u?l:a)*c[u].n.y;}),i?([0,1].forEach(function(u){if(!(e===2&&u)){var h=n[u+1],m={x:h.x-p.x,y:h.y-p.y},f=i?i((u+1)/e):o;i&&!r&&(f=-f);var g=Zt(m.x*m.x+m.y*m.y);m.x/=g,m.y/=g,d[u+1]={x:h.x+f*m.x,y:h.y+f*m.y};}}),new s(d)):([0,1].forEach(u=>{if(e===2&&u)return;let h=d[u*e],m=this.derivative(u),f={x:h.x+m.x,y:h.y+m.y};d[u+1]=E.lli4(h,f,p,n[u+1]);}),new s(d))}outline(o,e,i,r){if(e=e===void 0?o:e,this._linear){let C=this.normal(0),R=this.points[0],k=this.points[this.points.length-1],D,U,$;i===void 0&&(i=o,r=e),D={x:R.x+C.x*o,y:R.y+C.y*o},$={x:k.x+C.x*i,y:k.y+C.y*i},U={x:(D.x+$.x)/2,y:(D.y+$.y)/2};let de=[D,U,$];D={x:R.x-C.x*e,y:R.y-C.y*e},$={x:k.x-C.x*r,y:k.y-C.y*r},U={x:(D.x+$.x)/2,y:(D.y+$.y)/2};let se=[$,U,D],pe=E.makeline(se[2],de[0]),Se=E.makeline(de[2],se[0]),Ce=[pe,new s(de),Se,new s(se)];return new mt(Ce)}let n=this.reduce(),a=n.length,l=[],c=[],d,p=0,u=this.length(),h=typeof i<"u"&&typeof r<"u";function m(C,R,k,D,U){return function($){let de=D/k,se=(D+U)/k,pe=R-C;return E.map($,0,1,C+de*pe,C+se*pe)}}n.forEach(function(C){let R=C.length();h?(l.push(C.scale(m(o,i,u,p,R))),c.push(C.scale(m(-e,-r,u,p,R)))):(l.push(C.scale(o)),c.push(C.scale(-e))),p+=R;}),c=c.map(function(C){return d=C.points,d[3]?C.points=[d[3],d[2],d[1],d[0]]:C.points=[d[2],d[1],d[0]],C}).reverse();let f=l[0].points[0],g=l[a-1].points[l[a-1].points.length-1],y=c[a-1].points[c[a-1].points.length-1],v=c[0].points[0],b=E.makeline(y,f),S=E.makeline(g,v),T=[b].concat(l).concat([S]).concat(c);return new mt(T)}outlineshapes(o,e,i){e=e||o;let r=this.outline(o,e).curves,n=[];for(let a=1,l=r.length;a<l/2;a++){let c=E.makeshape(r[a],r[l-a],i);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,n.push(c);}return n}intersects(o,e){return o?o.p1&&o.p2?this.lineIntersects(o):(o instanceof s&&(o=o.reduce()),this.curveintersects(this.reduce(),o,e)):this.selfintersects(e)}lineIntersects(o){let e=bn(o.p1.x,o.p2.x),i=bn(o.p1.y,o.p2.y),r=yn(o.p1.x,o.p2.x),n=yn(o.p1.y,o.p2.y);return E.roots(this.points,o).filter(a=>{var l=this.get(a);return E.between(l.x,e,r)&&E.between(l.y,i,n)})}selfintersects(o){let e=this.reduce(),i=e.length-2,r=[];for(let n=0,a,l,c;n<i;n++)l=e.slice(n,n+1),c=e.slice(n+2),a=this.curveintersects(l,c,o),r.push(...a);return r}curveintersects(o,e,i){let r=[];o.forEach(function(a){e.forEach(function(l){a.overlaps(l)&&r.push({left:a,right:l});});});let n=[];return r.forEach(function(a){let l=E.pairiteration(a.left,a.right,i);l.length>0&&(n=n.concat(l));}),n}arcs(o){return o=o||.5,this._iterate(o,[])}_error(o,e,i,r){let n=(r-i)/4,a=this.get(i+n),l=this.get(r-n),c=E.dist(o,e),d=E.dist(o,a),p=E.dist(o,l);return qt(d-c)+qt(p-c)}_iterate(o,e){let i=0,r=1,n;do{n=0,r=1;let a=this.get(i),l,c,d,p,u=false,h=false,m,f=r,g=1;do if(h=u,p=d,f=(i+r)/2,l=this.get(f),c=this.get(r),d=E.getccenter(a,l,c),d.interval={start:i,end:r},u=this._error(d,a,i,r)<=o,m=h&&!u,m||(g=r),u){if(r>=1){if(d.interval.end=g=1,p=d,r>1){let b={x:d.x+d.r*$s(d.e),y:d.y+d.r*Ks(d.e)};d.e+=E.angle({x:d.x,y:d.y},b,this.get(1));}break}r=r+(r-i)/2;}else r=f;while(!m&&n++<100);if(n>=100)break;p=p||d,e.push(p),i=g;}while(r<1);return e}};var No=class extends pt{#e=null;constructor(o){super(),o&&(this.#e=o);}getBezier(){return this.#e||(this.#e=new ht(this.getPoints().map(o=>o.xy))),this.#e}signedDistance(o){return this.nearestPointTo(o).point.distanceTo(o)}distance(o){return this.signedDistance(o)}at(o){return exports.Vec2.ofXY(this.getBezier().get(o))}derivativeAt(o){return exports.Vec2.ofXY(this.getBezier().derivative(o))}secondDerivativeAt(o){return exports.Vec2.ofXY(this.getBezier().dderivative(o))}normal(o){return exports.Vec2.ofXY(this.getBezier().normal(o))}normalAt(o){return this.normal(o)}tangentAt(o){return this.derivativeAt(o).normalized()}getTightBoundingBox(){let o=this.getBezier().bbox(),e=o.x.max-o.x.min,i=o.y.max-o.y.min;return new X(o.x.min,o.y.min,e,i)}argIntersectsLineSegment(o){let e=te.ofSmallestContainingPoints(this.getPoints());return e?e.intersectsLineSegment(o).map(n=>this.nearestPointTo(n).parameterValue):this.getBezier().intersects(o).map(r=>{typeof r=="string"&&(r=Number.parseFloat(r));let n=exports.Vec2.ofXY(this.at(r));return n.distanceTo(o.p1)>o.length||n.distanceTo(o.p2)>o.length?null:r}).filter(r=>r!==null)}splitAt(o){if(o<=0||o>=1)return [this];let i=this.getBezier().split(o);return [new Uo(i.left.points.map(r=>exports.Vec2.ofXY(r)),i.left),new Uo(i.right.points.map(r=>exports.Vec2.ofXY(r)),i.right)]}nearestPointTo(o){let e=p=>o.squareDistanceTo(this.at(p)),i=e(0),r=0,n=i,a=4;for(let p=0;p<a;p++){let u=p/(a-1),h=e(u);h<n&&(r=u,n=h);}let l=p=>{let u=this.at(p),h=this.derivativeAt(p),m=this.secondDerivativeAt(p);return 2*h.x*h.x+2*u.x*m.x-2*o.x*m.x+2*h.y*h.y+2*u.y*m.y-2*o.y*m.y},c=p=>{let u=this.at(p),h=this.derivativeAt(p);return 2*u.x*h.x-2*o.x*h.x+2*u.y*h.y-2*o.y*h.y},d=()=>{let p=l(r);if(p===0)return;r=(0-c(r))/p+r,r>1?r=1:r<0&&(r=0);};for(let p=0;p<12;p++)d();return {parameterValue:r,point:this.at(r)}}intersectsBezier(o){let e=this.getBezier().intersects(o.getBezier());if(!e||e.length===0)return [];let i=[];for(let r of e){let n=/^([\d.Ee-]+)\/([\d.Ee-]+)$/.exec(r);if(!n)throw new Error(`Incorrect format returned by .intersects: ${e} should be array of "number/number"!`);let a=Number.parseFloat(n[1]);i.push({parameterValue:a,point:this.at(a)});}return i}toString(){return `B\xE9zier(${this.getPoints().map(o=>o.toString()).join(", ")})`}},Uo=class extends No{constructor(e,i){super(i);this.controlPoints=e;}getPoints(){return this.controlPoints}},Wo=No;var Gi=class extends Wo{constructor(e,i,r,n){super();this.p0=e;this.p1=i;this.p2=r;this.p3=n;}getPoints(){return [this.p0,this.p1,this.p2,this.p3]}getLooseBoundingBox(){return X.bboxOf([this.p0,this.p1,this.p2,this.p3])}},vn=Gi;var _i=class extends pt{constructor(e){super();this.p=e;}signedDistance(e){return this.p.distanceTo(e)}argIntersectsLineSegment(e,i){return e.containsPoint(this.p,i)?[0]:[]}getTightBoundingBox(){return new X(this.p.x,this.p.y,0,0)}at(e){return this.p}normalAt(e){return exports.Vec2.unitY}tangentAt(e){return exports.Vec2.unitX}splitAt(e){return [this]}nearestPointTo(e){return {point:this.p,parameterValue:0}}},xn=_i;function qs(s,o,e){if(s===0){let l;return o===0?l=e===0?0:Number.NaN:l=-e/o,[l,l]}let i=o*o-4*s*e;if(i<0)return [Number.NaN,Number.NaN];let r=Math.sqrt(i),n=(-o+r)/(2*s),a=(-o-r)/(2*s);return n>a?[n,a]:[a,n]}var Sn=qs;var Te=class s extends Wo{constructor(e,i,r){super();this.p0=e;this.p1=i;this.p2=r;}static componentAt(e,i,r,n){return i+e*(-2*i+2*r)+e*e*(i-2*r+n)}static derivativeComponentAt(e,i,r,n){return  -2*i+2*r+2*e*(i-2*r+n)}static secondDerivativeComponentAt(e,i,r,n){return 2*(i-2*r+n)}at(e){if(e===0)return this.p0;if(e===1)return this.p2;let i=this.p0,r=this.p1,n=this.p2;return exports.Vec2.of(s.componentAt(e,i.x,r.x,n.x),s.componentAt(e,i.y,r.y,n.y))}derivativeAt(e){let i=this.p0,r=this.p1,n=this.p2;return exports.Vec2.of(s.derivativeComponentAt(e,i.x,r.x,n.x),s.derivativeComponentAt(e,i.y,r.y,n.y))}secondDerivativeAt(e){let i=this.p0,r=this.p1,n=this.p2;return exports.Vec2.of(s.secondDerivativeComponentAt(e,i.x,r.x,n.x),s.secondDerivativeComponentAt(e,i.y,r.y,n.y))}normal(e){return this.derivativeAt(e).orthog().normalized()}getLooseBoundingBox(){return X.bboxOf([this.p0,this.p1,this.p2])}approximateDistance(e){let i=this.p0.x-e.x,r=-2*this.p0.x+2*this.p1.x,n=this.p0.x-2*this.p1.x+this.p2.x,a=this.p0.y-e.y,l=-2*this.p0.y+2*this.p1.y,c=this.p0.y-2*this.p1.y+this.p2.y,d=2*i*r+2*a*l-e.x*r-e.y*l,p=2*r*r+2*l*l+2*n*i+2*c*a-e.x*n-e.y*c,u=2*l*c+2*r*n+2*n*r+2*c*l,h=d,m=p,f=2*u,[g,y]=Sn(f/2,m,h);isNaN(g)&&(g=.25),isNaN(y)&&(y=.75);let v=this.at(g),b=this.at(y),S=v.squareDistanceTo(e),T=b.squareDistanceTo(e),C=this.at(0).squareDistanceTo(e),R=this.at(1).squareDistanceTo(e);return Math.sqrt(Math.min(S,T,C,R))}getPoints(){return [this.p0,this.p1,this.p2]}},Cn=Te;function Zs(s){if(s.indexOf("e")>0&&/[Ee]-\d{2,}$/.test(s))return "0";let o=s.charAt(s.length-1);(o==="0"||o===".")&&(s=s.replace(/(\.\d*[^0])0+$/,"$1"),s=s.replace(/\.0+$/,"."),s=s.replace(/\.$/,""));let e=s.charAt(0);return (e==="0"||e==="-")&&(s=s.replace(/^(0+)\./,"."),s=s.replace(/^-(0+)\./,"-."),s=s.replace(/^(-?)0+$/,"$10")),s==="-0"?"0":s}var $o=Zs;function ie(s){let o=/^(-?\d*\.\d{3,})0{4,}\d{1,4}$/,e=/^(-?)(\d*)\.(\d{3,}9{4,})\d{1,4}$/,i=s.toString(10);if(!i.includes("."))return i;let r=e.exec(i);if(r){let n=r[1],a=r[3],l=Number.parseInt(a.charAt(a.length-1),10),c=Number.parseInt(a,10),d=Number.parseInt(r[2],10),p=r[3],u=(c+10-l).toString(),h=0;for(u.length>c.toString().length&&(u=u.substring(1),h=1);u.length<p.length;)u=h.toString(10)+u,h=0;i=`${n+(d+h).toString()}.${u}`;}return i=i.replace(o,"$1"),$o(i)}var je=ie;var Ko=/^(-?)(\d*)\.(\d+)$/;function js(s){let o=Ko.exec(s);return o?o[3].length:s.search(/[Ee]/)!==-1||/^[A-Za-z]+$/.test(s)?-1:0}var Tn=js;function Ys(s,...o){let e=s.toString(10),i=Ko.exec(e);if(!i)return e;let r=-1;for(let d of o)r=Math.max(Tn(d),r);if(r===-1)return je(s);let n=i[3].substring(0,r),a=i[2],l=i[3].charAt(r);if(l!==""&&Number.parseInt(l,10)>=5){if(n.length>0){let p=/^(0+)(\d*)$/.exec(n),u="",h=n;p&&(u=p[1],h=p[2]),n=(Number.parseInt(n)+1).toString(),n.length>h.length&&u.length>0&&(u=u.substring(1)),n=u+n;}(n.length===0||n.length>r)&&(a=(Number.parseInt(a)+1).toString(),n=n.substring(1));}let c=i[1];return $o(`${c}${a}.${n}`)}var qi=Ys;function Xs(s){if(s.length===0)return [];let o=s.reduce((n,a)=>a.y<n.y?a:n,s[0]),e=[o],i=[...s.filter(n=>!n.eq(o))],r=exports.Vec2.of(-1,0);for(;i.length>0;){let n=e[e.length-1],a=r.dot(o.minus(n).normalizedOrZero()),l=o;for(let d of i){let p=r.dot(d.minus(n).normalizedOrZero());p<=a&&(l=d,a=p);}i=i.filter(d=>!d.eq(l));let c=l.minus(n).normalized();if(Math.abs(c.dot(r))===1&&e.length>1&&e.pop(),l.eq(o))break;e.push(l),r=n.minus(l).normalized();}return e}var wn=Xs;var q=(r=>(r[r.LineTo=0]="LineTo",r[r.MoveTo=1]="MoveTo",r[r.CubicBezierTo=2]="CubicBezierTo",r[r.QuadraticBezierTo=3]="QuadraticBezierTo",r))(q||{});function Go(s,o){let e=s.curveIndex-o.curveIndex;return e===0?s.parameterValue-o.parameterValue:e}function Zi(s,o){return s.parameterValue+o>1?{curveIndex:s.curveIndex+1,parameterValue:s.parameterValue+o-1}:s.parameterValue+o<0?s.curveIndex===0?{curveIndex:0,parameterValue:0}:{curveIndex:s.curveIndex-1,parameterValue:s.parameterValue+o+1}:{curveIndex:s.curveIndex,parameterValue:s.parameterValue+o}}var B=class s{constructor(o,e){this.startPoint=o;this.parts=e,this.bbox=X.bboxOf([o]);for(let i of this.parts)this.bbox=this.bbox.union(s.computeBBoxForSegment(o,i));}bbox;parts;getExactBBox(){let o=[];for(let e of this.geometry)o.push(e.getTightBoundingBox());return X.union(...o)}cachedGeometry=null;get geometry(){if(this.cachedGeometry)return this.cachedGeometry;let o=this.startPoint,e=[];for(let i of this.parts){let r;switch(i.kind){case 2:e.push(new vn(o,i.controlPoint1,i.controlPoint2,i.endPoint)),o=i.endPoint;break;case 3:e.push(new Cn(o,i.controlPoint,i.endPoint)),o=i.endPoint;break;case 0:e.push(new te(o,i.point)),o=i.point;break;case 1:e.push(new xn(i.point)),o=i.point;break;default:return r=i,r}}return this.cachedGeometry=e,this.cachedGeometry}*startEndPoints(){yield this.startPoint;for(let o of this.parts){let e;switch(o.kind){case 2:yield o.endPoint;break;case 3:yield o.endPoint;break;case 0:yield o.point;break;case 1:yield o.point;break;default:return e=o,e}}}cachedPolylineApproximation=null;polylineApproximation(){if(this.cachedPolylineApproximation)return this.cachedPolylineApproximation;let o=[];for(let r of this.parts)switch(r.kind){case 2:o.push(r.controlPoint1,r.controlPoint2,r.endPoint);break;case 3:o.push(r.controlPoint,r.endPoint);break;case 1:case 0:o.push(r.point);break}let e=[],i=this.startPoint;for(let r of o)e.push(new te(i,r)),i=r;return e}static computeBBoxForSegment(o,e){let i=[o],r;switch(e.kind){case 1:case 0:i.push(e.point);break;case 2:i.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case 3:i.push(e.controlPoint,e.endPoint);break;default:return r=e,r}return X.bboxOf(i)}signedDistance(o,e){let i=1/0;for(let r of this.geometry){let n=r.signedDistance(o)-e;n<i&&(i=n);}return i}raymarchIntersectionWith(o,e,i=[]){if(!o.bbox.intersects(this.bbox.grownBy(e)))return [];let r=o.length,n=[];for(let f of this.geometry){let g=f.getTightBoundingBox().grownBy(e);if(!g.intersects(o.bbox))continue;let y=b=>f.signedDistance(b),v=b=>y(b)-e;v(o.p1)>r&&v(o.p2)>r||n.push({part:f,distFn:y,bbox:g});}if(n.length===0)return [];let a=f=>{let g=1/0,y=null,v=[];for(let b of n){let{part:S,distFn:T,bbox:C}=b;if(!C.containsPoint(f)){v.push(b);continue}let R=T(f);R<=g&&(g=R,y=S);}for(let{part:b,distFn:S,bbox:T}of v){if(isFinite(g)&&!T.grownBy(g).containsPoint(f))continue;let C=S(f);C<=g&&(g=C,y=b);}return [y,g-e]},l=8,c=[o.p1,...i,o.p2],d=f=>f.minus(o.p1).dot(o.direction);c.sort((f,g)=>{let y=d(f),v=d(g);return y-v});let p=[],u=e/1e3,h=(f,g,y)=>{let v=f,[b,S]=a(v),T=d(v);if(S>r)return T;let C=o.direction.times(g);for(let k=0;k<l;k++){let D=S;if(v=v.plus(C.times(D)),T=d(v),T<=y)return T;let[U,$]=a(v);if(Math.abs($)>Math.abs(S))return null;if(S=$,b=U,Math.abs(S)<u)break}let R=T>=0&&T<=r;if(b&&R&&Math.abs(S)<u){p.push({point:v,parameterValue:b.nearestPointTo(v).parameterValue,curve:b,curveIndex:this.geometry.indexOf(b)});let k=e/20/o.length;T+=isFinite(k)?k:0;}return T},m=0;for(let f of c)m=Math.max(m,h(f,1,m)??m),m=Math.max(m,h(f,-1,m)??m);return p}intersection(o,e){let i=[];if(!o.bbox.intersects(this.bbox.grownBy(e??0)))return [];if(this.parts.length===0)return new s(this.startPoint,[{kind:1,point:this.startPoint}]).intersection(o,e);let r=0;for(let a of this.geometry){let l=a.argIntersectsLineSegment(o);for(let c of l)i.push({curve:a,curveIndex:r,point:a.at(c),parameterValue:c});r++;}if(e&&e>1e-8){let a=i.map(l=>l.point);i=this.raymarchIntersectionWith(o,e,a);}return i}nearestPointTo(o){let e=1/0,i=0,r=0,n=this.startPoint;for(let a=0;a<this.geometry.length;a++){let c=this.geometry[a].nearestPointTo(o),d=c.point.squareDistanceTo(o);(a===0||d<e)&&(i=a,e=d,r=c.parameterValue,n=c.point);}return {curve:this.geometry[i],curveIndex:i,parameterValue:r,point:n}}at(o){return o.curveIndex===0&&o.parameterValue===0?this.startPoint:this.geometry[o.curveIndex].at(o.parameterValue)}tangentAt(o){return this.geometry[o.curveIndex].tangentAt(o.parameterValue)}splitNear(o,e){let i=this.nearestPointTo(o);return this.splitAt(i,e)}spliced(o,e,i,r){if(((a,l)=>a.curveIndex<l.curveIndex||a.curveIndex===l.curveIndex&&a.parameterValue<=l.parameterValue)(o,e)){let a=this.splitAt(o,r),l=this.splitAt(e,r),c=a[0],d=l[l.length-1];return i?c.union(i).union(d):c.union(d)}else {let c=this.splitAt([o],r)[0].splitNear(this.at(e),r),d=c[c.length-1];return i?d.union(i):d}}splitAt(o,e){for(Array.isArray(o)||(o=[o]),o=[...o],o.sort(Go);o.length>0&&o[o.length-1].curveIndex>=this.parts.length-1&&o[o.length-1].parameterValue>=1;)o.pop();for(o.reverse();o.length>0&&o[o.length-1].curveIndex<=0&&o[o.length-1].parameterValue<=0;)o.pop();if(o.length===0||this.parts.length===0)return [this];let i=o.length+1,r=e?.mapNewPoint??(p=>p),n=[],a=this.startPoint,l=[],{curveIndex:c,parameterValue:d}=o.pop();for(let p=0;p<this.parts.length;p++)if(p!==c)l.push(this.parts[p]);else {let u=this.parts[p],h=this.geometry[p];for(;p===c;){let m,f=[];switch(u.kind){case 1:l.push({kind:u.kind,point:u.point}),m=u.point;break;case 0:{let y=h.splitAt(d);l.push({kind:u.kind,point:r(y[0].p2)}),m=y[0].p2,y.length>1&&(console.assert(y.length===2),f.push({kind:u.kind,point:y[1].p2}),h=y[1]);}break;case 3:case 2:{let y=h.splitAt(d),v=y.length===2;for(let b of y){h=b;let S=v?l:f,T=b.getPoints();u.kind===2?S.push({kind:u.kind,controlPoint1:r(T[1]),controlPoint2:r(T[2]),endPoint:r(T[3])}):S.push({kind:u.kind,controlPoint:r(T[1]),endPoint:r(T[2])}),v||(m=T[0]),v=false;}}break;default:return u}n.push(new s(a,[...l])),a=r(m),console.assert(!!a,"should have a start point"),l=f,u=f[f.length-1]??u;let g=o.pop();if(g)if(c=g.curveIndex,p===c){let y=this.at(g);d=h.nearestPointTo(y).parameterValue,l=[];}else d=g.parameterValue;else break}}return n.push(new s(a,l)),console.assert(n.length===i,`should split into splitAt.length + 1 splits (was ${n.length}, expected ${i})`),n}asClosed(){let o=[],e=false;for(let r of this.parts)r.kind===1?(o.push({kind:0,point:r.point}),e=true):o.push(r);if(this.getEndPoint().eq(this.startPoint)||(o.push({kind:0,point:this.startPoint}),e=true),!e)return this;let i=new s(this.startPoint,o);return console.assert(i.getEndPoint().eq(i.startPoint)),i}static mapPathCommand(o,e){switch(o.kind){case 1:case 0:return {kind:o.kind,point:e(o.point)};case 2:return {kind:o.kind,controlPoint1:e(o.controlPoint1),controlPoint2:e(o.controlPoint2),endPoint:e(o.endPoint)};case 3:return {kind:o.kind,controlPoint:e(o.controlPoint),endPoint:e(o.endPoint)}}return o}mapPoints(o){let e=o(this.startPoint),i=[];for(let r of this.parts)i.push(s.mapPathCommand(r,o));return new s(e,i)}transformedBy(o){return o.isIdentity()?this:this.mapPoints(e=>o.transformVec2(e))}closedContainsPoint(o){let e=this.getExactBBox();if(!e.containsPoint(o))return  false;let i=o.plus(exports.Vec2.of(e.width,0)),r=this.asClosed(),n=new te(o,i),a=r.intersection(n);return a.filter((c,d)=>d===0?true:!(a[d-1].parameterValue>=1&&c.parameterValue<=0)).length%2===1}closedContainsRect(o){if(!this.bbox.containsRect(o)||!o.corners.every(e=>this.closedContainsPoint(e)))return  false;for(let e of o.getEdges())if(this.intersection(e).length>0)return  false;return  true}union(o,e={allowReverse:true}){if(!o)return this;if(Array.isArray(o))return new s(this.startPoint,[...this.parts,...o]);let i=this.getEndPoint(),r=[];if(i.eq(o.startPoint))r=this.parts.concat(o.parts);else {if(e.allowReverse&&this.startPoint.eq(o.getEndPoint()))return o.union(this,{allowReverse:false});if(e.allowReverse&&this.startPoint.eq(o.startPoint))return this.union(o.reversed(),{allowReverse:false});r=[...this.parts,{kind:1,point:o.startPoint},...o.parts];}return new s(this.startPoint,r)}reversed(){let o=this.getEndPoint(),e=[],i=this.startPoint;for(let r of this.parts)switch(r.kind){case 0:case 1:e.push({kind:r.kind,point:i}),i=r.point;break;case 2:e.push({kind:r.kind,controlPoint1:r.controlPoint2,controlPoint2:r.controlPoint1,endPoint:i}),i=r.endPoint;break;case 3:e.push({kind:r.kind,controlPoint:r.controlPoint,endPoint:i}),i=r.endPoint;break;default:return r}return e.reverse(),new s(o,e)}getEndPoint(){if(this.parts.length===0)return this.startPoint;let o=this.parts[this.parts.length-1];return o.kind===3||o.kind===2?o.endPoint:o.point}roughlyIntersects(o,e=0){if(this.parts.length===0)return o.containsPoint(this.startPoint);if(this.startPoint.eq(this.getEndPoint())&&e===0)return this.closedRoughlyIntersects(o);if(o.containsRect(this.bbox))return  true;let r=this.startPoint;for(let n of this.parts){let a=s.computeBBoxForSegment(r,n).grownBy(e);if(n.kind===0||n.kind===1?r=n.point:r=n.endPoint,o.intersects(a))return  true}return  false}closedRoughlyIntersects(o){if(o.containsRect(this.bbox))return  true;let e=this.bbox.topLeft.minus(exports.Vec2.of(1,1)),i=o.corners,r=this.polylineApproximation();for(let l of i){let c=new te(l,e),d=0;for(let p of r)p.intersects(c)&&d++;if(d%2===1)return  true}let n=o.grownBy(Math.min(o.size.x,o.size.y)),a=[];for(let l of n.divideIntoGrid(4,4))a.push(...l.getEdges());for(let l of a)for(let c of r)if(l.intersects(c))return  true;return  false}eq(o,e){if(o.parts.length!==this.parts.length)return  false;for(let i=0;i<this.parts.length;i++){let r=this.parts[i],n=o.parts[i];switch(r.kind){case 0:case 1:if(r.kind!==n.kind)return  false;if(!r.point.eq(n.point,e))return  false;break;case 2:if(r.kind!==n.kind)return  false;if(!r.controlPoint1.eq(n.controlPoint1,e)||!r.controlPoint2.eq(n.controlPoint2,e)||!r.endPoint.eq(n.endPoint,e))return  false;break;case 3:if(r.kind!==n.kind)return  false;if(!r.controlPoint.eq(n.controlPoint,e)||!r.endPoint.eq(n.endPoint,e))return  false;break;default:return r}}return  true}static fromRect(o,e=null){let i=[],r,n;if(e!==null){let a=exports.Vec2.of(e,e).times(.5),l=X.fromCorners(o.topLeft.plus(a),o.bottomRight.minus(a)),c=X.fromCorners(o.topLeft.minus(a),o.bottomRight.plus(a));r=[l.corners[3],...l.corners,...c.corners.reverse()],n=c.corners[3];}else r=o.corners.slice(1),n=o.corners[0];for(let a of r)i.push({kind:0,point:a});return i.push({kind:0,point:n}),new s(n,i)}cachedStringVersion=null;toString(o,e=false){if(this.cachedStringVersion&&!e)return this.cachedStringVersion;o===void 0&&(o=Math.abs(this.bbox.topLeft.x)>10&&Math.abs(this.bbox.topLeft.y)>10);let i=s.toString(this.startPoint,this.parts,!o);return this.cachedStringVersion=i,i}serialize(){return this.toString()}static toString(o,e,i){let r=[],n,a=(c,...d)=>{let p=[],u=[],h=!n||i,m=n?je(n.x):"",f=n?je(n.y):"";for(let y of d){let v=je(y.x),b=je(y.y);if(h)p.push(`${v},${b}`);else {let S=qi(y.x-n.x,v,m,f),T=qi(y.y-n.y,b,m,f);T.charAt(0)==="-"?u.push(`${S}${T}`):u.push(`${S},${T}`);}}let g;h?g=`${c}${p.join(" ")}`:g=`${c.toLowerCase()}${u.join(" ")}`,!(g==="l0,0"||g==="m0,0")&&(r.push(g),d.length>0&&(n=d[d.length-1]));};e[0]?.kind!==1&&a("M",o);let l;for(let c of e)switch(c.kind){case 1:a("M",c.point);break;case 0:a("L",c.point);break;case 2:a("C",c.controlPoint1,c.controlPoint2,c.endPoint);break;case 3:a("Q",c.controlPoint,c.endPoint);break;default:return l=c,l}return r.join("")}static fromString(o){o=o.split(`
`).join(" ");let e=exports.Vec2.zero,i=null,r=null,n=true,a=[],l=g=>{if(n){n=false;return}a.push({kind:1,point:g});},c=g=>{if(n){n=false;return}a.push({kind:0,point:g});},d=(g,y,v)=>{a.push({kind:2,controlPoint1:g,controlPoint2:y,endPoint:v});},p=(g,y)=>{a.push({kind:3,controlPoint:g,endPoint:y});},u={m:1,l:1,c:3,q:2,z:0,h:1,v:1},h=/([achlmqstvz])\s*([^achlmqstvz]*)/gi,m;for(;(m=h.exec(o))!==null;){let y=m[2].trim().split(/[^\d.Ee-]/).filter(C=>C.length>0).reduce((C,R)=>{R=R.replace(/([^Ee])-/g,"$1 -");let k=R.split(" -");return k[0]!==""&&C.push(k[0]),C.push(...k.slice(1).map(D=>`-${D}`)),C},[]).map(C=>Number.parseFloat(C)),v=m[1].toLowerCase(),b=m[1]!==v;if(v==="v"||v==="h")y=y.reduce((C,R)=>v==="v"?C.concat(b?e.x:0,R):C.concat(R,b?e.y:0),[]),v="l";else if(v==="z"){if(i)y=[i.x,i.y],i=e;else continue;b=true,v="l";}let S=u[v]??0,T=y.reduce((C,R,k,D)=>{if(k%2!==0){let U=R,$=D[k-1];return C.concat(exports.Vec2.of($,U))}else return C},[]).map((C,R)=>{let k;return b?k=C:k=e.plus(C),(R+1)%S===0&&(e=k),k});if(T.length%S!==0)throw new Error([`Incorrect number of arguments: got ${JSON.stringify(T)} with a length of ${T.length} \u2260 ${S}k, k \u2208 \u2124.`,`The number of arguments to ${v} must be a multiple of ${S}!`,`Command: ${m[0]}`].join(`
`));for(let C=0;C<T.length;C+=S){let R=T.slice(C,C+S);switch(v.toLowerCase()){case "m":C===0?l(R[0]):c(R[0]);break;case "l":c(R[0]);break;case "c":d(R[0],R[1],R[2]);break;case "q":p(R[0],R[1]);break;default:throw new Error(`Unknown path command ${v}`)}n=false;}T.length>0&&(i??=T[0],r??=i,e=T[T.length-1]);}let f=new s(r??exports.Vec2.zero,a);return f.cachedStringVersion=o,f}static fromConvexHullOf(o){if(o.length===0)return s.empty;let e=wn(o),i=e.slice(1).map(r=>({kind:0,point:r}));return i.push({kind:0,point:e[0]}),new s(e[0],i)}static empty=new s(exports.Vec2.zero,[])};var ji=class s extends Ze{constructor(e,i,r){super();this.vertex1=e;this.vertex2=i;this.vertex3=r;}static fromVertices(e,i,r){return new s(e,i,r)}get vertices(){return [this.vertex1,this.vertex2,this.vertex3]}map(e){return new s(e(this.vertex1),e(this.vertex2),e(this.vertex3))}transformed2DBy(e){return this.map(i=>e.transformVec2(i))}transformedBy(e){return this.map(i=>e.transformVec3(i))}#e=void 0;getEdges(){if(this.#e)return this.#e;let e=new te(this.vertex1,this.vertex2),i=new te(this.vertex2,this.vertex3),r=new te(this.vertex3,this.vertex1),n=[e,i,r];return this.#e=n,n}intersectsLineSegment(e){let i=[];for(let r of this.getEdges())r.intersectsLineSegment(e).forEach(n=>i.push(n));return i}containsPoint(e,i=Ze.smallValue){let r=this.getEdges();for(let n of r){let a=n.direction.orthog(),l=a.dot(this.vertex1),c=a.dot(this.vertex2),d=a.dot(this.vertex3),p=Math.min(l,c,d),u=Math.max(l,c,d),h=a.dot(e);if(!(h>=p-i&&h<=u+i))return  false}return  true}signedDistance(e){let r=this.getEdges().map(a=>a.distance(e)),n=Math.min(...r);return this.containsPoint(e,0)?-n:n}getTightBoundingBox(){return X.bboxOf(this.vertices)}};var P=class s{constructor(o,e,i,r){this.r=o;this.g=e;this.b=i;this.a=r;}static ofRGB(o,e,i){return s.ofRGBA(o,e,i,1)}static ofRGBA(o,e,i,r){return o=Math.max(0,Math.min(o,1)),e=Math.max(0,Math.min(e,1)),i=Math.max(0,Math.min(i,1)),r=Math.max(0,Math.min(r,1)),new s(o,e,i,r)}static fromRGBArray(o,e=255){let i=o[0],r=o[1]??i,n=o[2]??i,a=255;return 3<o.length&&(a=o[3]),s.ofRGBA(i/e,r/e,n/e,a/e)}static fromHex(o){if(o=(o.match(/^#?(.*)$/)??[])[1],o=o.toUpperCase(),!/^[\dA-F]+$/.test(o))throw new Error(`${o} is not in a valid format.`);(o.length===3||o.length===4)&&(o=o.split("").map(r=>`${r}0`).join("")),o.length===6&&(o+="FF");let e=[];for(let i=2;i<=o.length;i+=2){let r=o.substring(i-2,i);e.push(Number.parseInt(r,16)/255);}if(e.length!==4)throw new Error(`Unable to parse ${o}: Wrong number of components.`);return s.ofRGBA(e[0],e[1],e[2],e[3])}static fromString(o){if(o.startsWith("#"))return s.fromHex(o);if(o==="none"||o==="transparent")return s.transparent;if(o==="")return s.black;let e=/^rgba?\(([\d,.]+)\)$/i,i=o.replace(/\s*/g,"").match(e);if(i){let u=i[1],h=JSON.parse(`[ ${u} ]`);if(h.length===3)return s.ofRGB(h[0]/255,h[1]/255,h[2]/255);if(h.length===4)return s.ofRGBA(h[0]/255,h[1]/255,h[2]/255,h[3]);throw new Error(`RGB string, ${o}, has wrong number of components: ${h.length}`)}let r=document.createElement("canvas");r.width=1,r.height=1;let n=r.getContext("2d");if(!n)return s.black;n.fillStyle=o,n.fillRect(0,0,1,1);let a=n.getImageData(0,0,1,1),l=a.data[0]/255,c=a.data[1]/255,d=a.data[2]/255,p=a.data[3]/255;return s.ofRGBA(l,c,d,p)}eq(o){return o==null?false:this.a===0&&o.a===0?true:this.toHexString()===o.toHexString()}mix(o,e){e=Math.min(Math.max(e,0),1);let i=1-e;return new s(this.r*i+o.r*e,this.g*i+o.g*e,this.b*i+o.b*e,this.a*i+o.a*e)}withAlpha(o){return new s(this.r,this.g,this.b,o)}get rgb(){return exports.Vec3.of(this.r,this.g,this.b)}relativeLuminance(){let o=[this.r,this.g,this.b].map(e=>e<.03928?e/12.92:Math.pow((e+.055)/1.055,2.4));return .2126*o[0]+.7152*o[1]+.0722*o[2]}static contrastRatio(o,e){let i=o.relativeLuminance(),r=e.relativeLuminance();return (Math.max(i,r)+.05)/(Math.min(i,r)+.05)}static average(o){let e=0,i=0,r=0,n=0;for(let a of o)e+=a.a,i+=a.r,r+=a.g,n+=a.b;return o.length>0&&(e/=o.length,i/=o.length,r/=o.length,n/=o.length),new s(i,r,n,e)}asHSV(){let o=Math.min(this.r,this.g,this.b),e=Math.max(this.r,this.g,this.b),i=e-o,r;i===0?r=0:this.r>=this.g&&this.r>=this.b?r=(this.g-this.b)/i%6:this.g>=this.r&&this.g>=this.b?r=(this.b-this.r)/i+2:r=(this.r-this.g)/i+4,r*=60,r*=Math.PI/180,r<0&&(r+=Math.PI*2);let n=e,a=n>0?i/n:0;return exports.Vec3.of(r,a,n)}static fromHSV(o,e,i){o<0&&(o+=Math.PI*2),o%=Math.PI*2,i=Math.max(0,Math.min(1,i)),e=Math.max(0,Math.min(1,e));let r=i*e,n=o/(Math.PI/3),a=r*(1-Math.abs(n%2-1)),l;n<1?l=[r,a,0]:n<2?l=[a,r,0]:n<3?l=[0,r,a]:n<4?l=[0,a,r]:n<5?l=[a,0,r]:l=[r,0,a];let c=i-r;return s.ofRGB(l[0]+c,l[1]+c,l[2]+c)}static fromRGBVector(o,e){return s.ofRGBA(o.x,o.y,o.z,e??1)}hexString=null;toHexString(){if(this.hexString)return this.hexString;let o=a=>{let l=Math.round(255*a).toString(16);return l.length===1?`0${l}`:l},e=o(this.a),i=o(this.r),r=o(this.g),n=o(this.b);return e==="ff"?`#${i}${r}${n}`:(this.hexString=`#${i}${r}${n}${e}`,this.hexString)}toString(){return this.toHexString()}static transparent=s.ofRGBA(0,0,0,0);static red=s.fromHex("#D7273D");static orange=s.fromHex("#F99F07");static green=s.fromHex("#00875A");static blue=s.fromHex("#2576B9");static purple=s.ofRGB(.5,.2,.5);static yellow=s.fromHex("#FFD95C");static clay=s.ofRGB(.8,.4,.2);static black=s.ofRGB(0,0,0);static gray=s.fromHex("#EDEEF1");static white=s.ofRGB(1,1,1);static blackHighlight=s.ofRGBA(0,0,0,.3);static redHighlight=s.ofRGBA(215/255,39/255,61/255,.3);static blueHighlight=s.ofRGBA(37/255,118/255,185/255,.3);static pink=s.fromHex("#EB9CC4");static blueLight=s.fromHex("#D5EDFF");static greenLight=s.fromHex("#E3FCEF")};function Qs(s){return (o,e)=>new Yi(s,o,e)}var W=Qs,Yi=class{constructor(o,e,i){this.sourceFactory=o;this.startPoint=e;this.viewport=i;this.builder=o(e,i),this.points=[e];}builder;points;getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(o){this.builder.preview(o);}addPoint(o){this.points.push(o),this.builder.addPoint(o);}async autocorrectShape(){let o=n=>({...n,pos:this.viewport.snapToGrid(n.pos)}),e=o(this.startPoint),i=this.sourceFactory(e,this.viewport),r=this.points.map(n=>o(n));for(let n of r)i.addPoint(n);return i.build()}};function Ye(s){return s.path?s.path:new B(s.startPoint,s.commands)}function M(s,o){return {startPoint:s.startPoint,style:o,commands:s.parts,path:s}}function Js(s,o){return s.path?s:{...s,path:o}}function _o(s,o,e={fastCheck:true,expensiveCheck:true}){let i=Ye(s),r=s.style.stroke?.width??0,n=r>0&&s.style.fill.a===0,a=i.bbox.grownBy(r),l=n&&r>o.maxDimension&&a.containsRect(o);if(e.fastCheck&&l&&s.style.stroke){let c=r/2;for(let d of i.startEndPoints())if(o.isWithinRadiusOf(c,d))return {rectangle:o,path:M(B.fromRect(o),{fill:s.style.stroke.color}),fullScreen:true}}if(e.expensiveCheck&&l&&s.style.stroke&&r>o.maxDimension*3){let c=i.signedDistance(o.center,r/2),d=r/6;if(c<-o.maxDimension/2-d)return {path:M(B.fromRect(o),{fill:s.style.stroke.color}),rectangle:o,fullScreen:true};if(c>o.maxDimension/2+d)return {path:M(B.empty,{fill:P.transparent}),rectangle:I.empty,fullScreen:false}}return null}function Xi(s,o){let e=Ye(s),i=s.style.stroke?.width??0,r=i>0&&s.style.fill.a===0,n=e.bbox.grownBy(i),a=_o(s,o,{fastCheck:true,expensiveCheck:false});if(a)return a.path;if(o.grownBy(i).transformedBoundingBox(w.scaling2D(4,o.center)).containsRect(n))return Js(s,e);let c=[],d=e.startPoint;for(let h of e.parts){let m=B.computeBBoxForSegment(d,h).grownBy(i),f;h.kind===0||h.kind===1?f=h.point:f=h.endPoint,m.intersects(o)?c.push(h):r||h.kind===1?c.push({kind:1,point:f}):c.push({kind:0,point:f}),d=f;}let p=new B(e.startPoint,c),u=s.style;return a=_o(s,o,{fastCheck:false,expensiveCheck:true}),a?a.path:M(p,u)}var Qi=class s{onDrop(o){}static union(o,e){return new class extends s{apply(i){o.apply(i),e.apply(i);}unapply(i){e.unapply(i),o.unapply(i);}description(i,r){let n=o.description(i,r),a=e.description(i,r);return n===a?n:`${n}, ${a}`}}}static empty=new class extends s{description(o,e){return ""}apply(o){}unapply(o){}}},we=Qi;function ea(s,o,e,i){let r=o.transformVec3(exports.Vec2.unitX),n=o.transformVec2(s),a=r.magnitude(),l=-(180/Math.PI)*r.angle(),c=n.minus(s),d=[];if(a>1.2?d.push(i.zoomedIn):a<.8&&d.push(i.zoomedOut),Math.floor(Math.abs(l))>0){let u=Math.round(e?-l:l);d.push(i.rotatedBy(u));}let p=1e-4;return c.x>p?d.push(e?i.movedLeft:i.movedRight):c.x<-1e-4&&d.push(e?i.movedRight:i.movedLeft),c.y<-1e-4?d.push(e?i.movedDown:i.movedUp):c.y>p&&d.push(e?i.movedUp:i.movedDown),d.join("; ")}var ft=ea;var Ji=class extends we{},ue=class s{constructor(o){this.onTransformChangeCallback=o;this.resetTransform(w.identity),this.screenRect=I.empty;}static ViewportTransform=class extends Ji{constructor(e){super();this.transform=e;this.#e=e.inverse();}#e;apply(e){let i=e.viewport;i.resetTransform(i.transform.rightMul(this.transform)),e.queueRerender();}unapply(e){let i=e.viewport;i.resetTransform(i.transform.rightMul(this.#e)),e.queueRerender();}description(e,i){return ft(e.viewport.visibleRect.center,this.transform,true,i)}};transform;inverseTransform;screenRect;getTemporaryClone(){let o=new s(()=>{});return o.transform=this.transform,o.inverseTransform=this.inverseTransform,o.screenRect=this.screenRect,o}updateScreenSize(o){this.screenRect=this.screenRect.resizedTo(o);}get visibleRect(){return this.screenRect.transformedBoundingBox(this.inverseTransform)}screenToCanvas(o){return this.inverseTransform.transformVec2(o)}canvasToScreen(o){return this.transform.transformVec2(o)}static transformBy(o){return new s.ViewportTransform(o)}resetTransform(o=w.identity){let e=this.transform;this.transform=o,this.inverseTransform=o.inverse(),this.onTransformChangeCallback?.(e,o);}get screenToCanvasTransform(){return this.inverseTransform}get canvasToScreenTransform(){return this.transform}getScreenRectSize(){return this.screenRect.size}getResolution(){return this.getScreenRectSize()}getScaleFactor(){return this.transform.transformVec3(exports.Vec3.unitX).magnitude()}getScaleFactorToNearestPowerOfTen(){return this.getScaleFactorToNearestPowerOf(10)}getScaleFactorToNearestPowerOf(o){let e=this.getScaleFactor();return Math.pow(o,Math.round(Math.log(e)/Math.log(o)))}static getGridSize(o){return 50/o}snapToGrid(o){let e=this.getScaleFactorToNearestPowerOf(2),i=n=>{let a=1/s.getGridSize(e);return Math.round(n*a)/a};return exports.Vec2.of(i(o.x),i(o.y))}getSizeOfPixelOnCanvas(){return 1/this.getScaleFactor()}getRotationAngle(){return this.transform.transformVec3(exports.Vec3.unitX).angle()}static roundPoint(o,e){let i=10**Math.floor(Math.log10(e)),r=n=>Math.round(n/i)*i;return typeof o=="number"?r(o):o.map(r)}roundPoint(o){return s.roundPoint(o,1/this.getScaleFactor())}static roundScaleRatio(o,e=1){if(Math.abs(o)<=1e-12)return 0;let i=10**Math.floor(Math.log10(Math.abs(o))),r=2**e;return o=Math.round(o/i*r)/r*i,o}computeZoomToTransform(o,e=true,i=true){let r=w.identity;if(o.w===0||o.h===0){let d=Math.max(o.w,o.h);d===0&&(d=50,e=false,i=false),o=new I(o.x,o.y,d,d);}if(isNaN(o.size.magnitude()))throw new TypeError(`${o.toString()} rectangle has NaN size! Cannot zoom to!`);let n=()=>{let d=this.visibleRect.transformedBoundingBox(r.inverse());return d.transformedBoundingBox(w.scaling2D(4/5,d.center))},a=n(),l=a.w<o.w||a.h<o.h,c=o.maxDimension/a.maxDimension<1/3;if(l&&i||c&&e){let d=Math.max(o.w/a.w,o.h/a.h),u=w.scaling2D(d,a.topLeft).inverse();r=r.rightMul(u);}if(a=n(),!a.containsRect(o)){let d=o.center.minus(a.center),u=w.translation(d).inverse();r=r.rightMul(u);}return r.invertable()||(console.warn("Unable to zoom to ",o,"! Computed transform",r,"is singular."),r=w.identity),r}zoomTo(o,e=true,i=true){let r=this.computeZoomToTransform(o,e,i);return new s.ViewportTransform(r)}},A=ue;var O=class s extends we{#e;constructor(o){if(super(),!(o in s.deserializationCallbacks))throw new Error(`Command ${o} must have a registered deserialization callback. To do this, call SerializableCommand.register.`);this.#e=o;}static deserializationCallbacks={};serialize(){return {data:this.serializeToJSON(),commandType:this.#e}}static deserialize(o,e){let i=typeof o=="string"?JSON.parse(o):o,r=i.commandType;if(!(r in s.deserializationCallbacks))throw new Error(`Unrecognised command type ${r}!`);return s.deserializationCallbacks[r](i.data,e)}static register(o,e){s.deserializationCallbacks[o]=e;}};var Xe=class extends O{component;componentID;constructor(o,e,i){super(o),this.component=i??null,this.componentID=e;}resolveComponent(o){if(this.component)return;let e=o.lookupElement(this.componentID);if(!e)throw new Error(`Unable to resolve component with ID ${this.componentID}`);this.component=e;}};var Pe=class{listeners;constructor(){this.listeners={};}dispatch(o,e){let i=this.listeners[o];if(i)for(let r of i)r(e);}on(o,e){return this.listeners[o]||(this.listeners[o]=[]),this.listeners[o].push(e),{remove:()=>{let i=this.listeners[o];return this.off(o,e),i.length!==this.listeners[o].length}}}off(o,e){let i=this.listeners[o];i&&(this.listeners[o]=i.filter(r=>r!==e));}};function Pn(s){throw new Error(`Should be unreachable. Key: ${s}.`)}function ze(s,o=false){if(typeof s!="number"||!o&&isNaN(s))throw new Error("Given value is not a number")}function er(s){if(typeof s!="string")throw new TypeError("Given value is not a string")}function En(s){if(!Array.isArray(s))throw new TypeError("Asserting isArray: Given entity is not an array")}function He(s,o=false){En(s),ze(s.length);for(let e of s)ze(e,o);}function jt(s){En(s),ze(s.length);for(let o of s)er(o);}function tr(s){if(typeof s!="boolean")throw new TypeError("Given value is not a boolean")}function In(s){if(!s)throw new Error(`${JSON.stringify(s)} is not truthy`)}function qo(s){if(typeof s!="object")throw new TypeError(`AssertIsObject: Given entity is not an object (type = ${typeof s})`)}function Qe(s){s.sort((o,e)=>o.getContent().getZIndex()-e.getContent().getZIndex());}var Zo=false,K=class s{root;background;componentsById;componentCount=0;importExportViewport;shouldAutoresizeExportViewport;notifier;constructor(o,e){this.root=new jo,this.background=new jo,this.componentsById=new Map,this.notifier=new Pe,this.importExportViewport=new A(()=>{this.onExportViewportChanged();}),this.importExportViewport.updateScreenSize(exports.Vec2.of(o||500,e||500)),this.shouldAutoresizeExportViewport=false;}updateScreenSizeImage(o,e){this.importExportViewport.updateScreenSize(exports.Vec2.of(o||500,e||500));}getBackgroundComponents(){let o=[],e=this.background.getLeaves();Qe(e);for(let i of e){let r=i.getContent();r&&o.push(r);}return o}findParent(o){return this.background.getChildWithContent(o)??this.root.getChildWithContent(o)}queueRerenderOf(o){let e=this.findParent(o);e&&(e.remove(),this.addComponentDirectly(o));}renderWithCache(o,e,i){this.background.render(o,i.visibleRect),Zo?this.root.render(o,i.visibleRect):e.render(o,this.root,i);}render(o,e){this.background.render(o,e?.visibleRect),this.root.render(o,e?.visibleRect);}async renderAllAsync(o,e){return await this.background.renderAllAsync(o,e)?await this.root.renderAllAsync(o,e):false}renderAll(o){this.render(o,null);}getAllComponents(){let o=this.root.getLeaves();return Qe(o),o.map(e=>e.getContent())}getAllElements(){return this.getAllComponents()}estimateNumElements(){return this.componentCount}getElementsIntersectingRegion(o,e=false){return this.getComponentsIntersecting(o,e)}getComponentsIntersecting(o,e=false){let i=this.root.getLeavesIntersectingRegion(o);return e&&(i=i.concat(this.background.getLeavesIntersectingRegion(o))),Qe(i),i.map(r=>r.getContent())}onDestroyElement(o){this.componentCount--;let e=o.getId();this.componentsById.delete(e),this.notifier.dispatch(3,{kind:3,image:this,componentId:e}),this.autoresizeExportViewport();}onElementAdded(o){this.componentCount++;let e=o.getId();this.componentsById.set(o.getId(),o),this.notifier.dispatch(2,{kind:2,image:this,componentId:e}),this.autoresizeExportViewport();}lookupElement(o){return this.componentsById.get(o)??null}addComponentDirectly(o){o.onAddToImage(this);let i=(o.isBackground()?this.background:this.root).addLeaf(o);return this.onElementAdded(o),i}removeElementDirectly(o){let e=this.findParent(o);return e?.remove(),e?(this.onDestroyElement(o),true):false}static addComponent(o,e=false){return new s.AddComponentCommand(o,e)}addComponent(o,e){return s.addComponent(o,e)}addElement(o,e){return this.addComponent(o,e)}static addElement(o,e=false){return this.addComponent(o,e)}static AddComponentCommand=class extends O{constructor(e,i=false){super("add-element");this.element=e;this.applyByFlattening=i;if(this.serializedElem=null,isNaN(e.getBBox().area))throw new TypeError("Elements in the image cannot have NaN bounding boxes")}serializedElem=null;apply(e){e.image.addComponentDirectly(this.element),this.applyByFlattening?(this.applyByFlattening=false,e.display.flatten()):e.queueRerender();}unapply(e){e.image.removeElementDirectly(this.element),e.queueRerender();}description(e,i){return i.addComponentAction(this.element.description(i))}serializeToJSON(){return {elemData:this.serializedElem??this.element.serialize()}}static{O.register("add-element",(e,i)=>{let r=e.elemData.id,a=i.image.lookupElement(r)??G.deserialize(e.elemData),l=new s.AddComponentCommand(a);return l.serializedElem=e.elemData,l});}};getImportExportViewport(){return this.importExportViewport}getImportExportRect(){return this.getImportExportViewport().visibleRect}setImportExportRect(o){return s.SetImportExportRectCommand.of(this,o,false)}getAutoresizeEnabled(){return this.shouldAutoresizeExportViewport}setAutoresizeEnabled(o){if(o===this.shouldAutoresizeExportViewport)return we.empty;let e=this.root.getBBox();return s.SetImportExportRectCommand.of(this,e,o)}setAutoresizeEnabledDirectly(o){o!==this.shouldAutoresizeExportViewport&&(this.shouldAutoresizeExportViewport=o,this.notifier.dispatch(1,{kind:1,image:this}));}autoresizeExportViewport(){this.shouldAutoresizeExportViewport&&this.setExportRectDirectly(this.root.getBBox());}settingExportRect=false;setExportRectDirectly(o){let e=this.getImportExportViewport(),i=e.getScreenRectSize(),r=e.canvasToScreenTransform,n=w.translation(o.topLeft.times(-1));return !i.eq(o.size)||!r.eq(n)?(this.settingExportRect=true,e.updateScreenSize(o.size),e.resetTransform(n),this.settingExportRect=false,this.onExportViewportChanged(),true):false}onExportViewportChanged(){this.settingExportRect||this.notifier.dispatch(0,{kind:0,image:this});}static setDebugMode(o){Zo=o;}static SetImportExportRectCommand=class extends O{constructor(e,i,r,n,a){super(s.SetImportExportRectCommand.commandId);this.originalSize=e;this.originalTransform=i;this.originalAutoresize=r;this.newExportRect=n;this.newAutoresize=a;}static commandId="set-import-export-rect";static of(e,i,r){let n=e.getImportExportViewport(),a=n.visibleRect.size,l=n.canvasToScreenTransform,c=e.getAutoresizeEnabled();return new s.SetImportExportRectCommand(a,l,c,i,r)}apply(e){e.image.setAutoresizeEnabledDirectly(this.newAutoresize),e.image.setExportRectDirectly(this.newExportRect),e.queueRerender();}unapply(e){let i=e.image.getImportExportViewport();e.image.setAutoresizeEnabledDirectly(this.originalAutoresize),i.updateScreenSize(this.originalSize),i.resetTransform(this.originalTransform),e.queueRerender();}description(e,i){return this.newAutoresize!==this.originalAutoresize?this.newAutoresize?i.enabledAutoresizeOutputCommand:i.disabledAutoresizeOutputCommand:i.resizeOutputCommand(this.newExportRect)}serializeToJSON(){return {originalSize:this.originalSize.xy,originalTransform:this.originalTransform.toArray(),newRegion:{x:this.newExportRect.x,y:this.newExportRect.y,w:this.newExportRect.w,h:this.newExportRect.h},autoresize:this.newAutoresize,originalAutoresize:this.originalAutoresize}}static{let e=this.commandId;O.register(e,(i,r)=>{ze(i.originalSize.x),ze(i.originalSize.y),He(i.originalTransform),He([i.newRegion.x,i.newRegion.y,i.newRegion.w,i.newRegion.h]),tr(i.autoresize??false),tr(i.originalAutoresize??false);let n=exports.Vec2.ofXY(i.originalSize),a=new w(...i.originalTransform),l=new I(i.newRegion.x,i.newRegion.y,i.newRegion.w,i.newRegion.h),c=i.autoresize??false,d=i.originalAutoresize??false;return new s.SetImportExportRectCommand(n,a,d,l,c)});}}};function or(s,o){let e=0;if(o){for(let i=s.length-1;i>=1;i--)if(s[i].getBBox().containsRect(o)&&s[i].getContent()?.occludesEverythingBelowWhenRenderedInRect(o)){e=i;break}}return e}var Yt=class s{constructor(o=null){this.parent=o;this.children=[],this.bbox=I.empty,this.content=null,this.id=s.idCounter++;}content;bbox;children;targetChildCount=30;id;static idCounter=0;getId(){return this.id}onContentChange(){this.id=s.idCounter++;}getContent(){return this.content}getParent(){return this.parent}getChildrenIntersectingRegion(o,e){return this.children.filter(i=>{let r=i.getBBox();return !e?.(r)&&r.intersects(o)})}getChildrenOrSelfIntersectingRegion(o,e){return this.content&&this.bbox.intersects(o)&&!e?.(this.bbox)?[this]:this.getChildrenIntersectingRegion(o,e)}getLeavesIntersectingRegion(o,e){let i=[],r=[];for(r.push(this);r.length>0;){let a=r.pop().getChildrenOrSelfIntersectingRegion(o,e);for(let l of a)l.content?i.push(l):r.push(l);}return i}getChildWithContent(o){let e=this.getLeavesIntersectingRegion(o.getBBox());for(let i of e)if(i.getContent()===o)return i;return null}getLeaves(){if(this.content)return [this];let o=[];for(let e of this.children)o.push(...e.getLeaves());return o}addLeaf(o){if(this.onContentChange(),this.content===null&&this.children.length===0)return this.content=o,this.recomputeBBox(true),this;if(this.content!==null){console.assert(this.children.length===0);let n=new s(this);n.content=this.content,this.content=null,this.children.push(n),n.recomputeBBox(false);}let e=o.getBBox();if(e.containsRect(this.getBBox())){let n=new s(this);if(this.children.length<this.targetChildCount)this.children.push(n);else {let a=new s(this);a.children=this.children,this.children=[n,a],a.updateParents(),a.recomputeBBox(true);}return n.addLeaf(o)}let i=this.children.filter(n=>n.getBBox().containsRect(e));if(i.length>0&&this.children.length>=this.targetChildCount){i.sort((a,l)=>a.getBBox().area-l.getBBox().area);let n=i[0].addLeaf(o);return n.rebalance(),n}let r=s.createLeafNode(this,o);return this.children.push(r),r.recomputeBBox(true),this.children.length>=this.targetChildCount&&this.rebalance(),r}static createLeafNode(o,e){let i=new s(o);return i.content=e,i}getBBox(){return this.bbox}recomputeBBox(o){let e=this.bbox;this.content!==null?this.bbox=this.content.getBBox():this.bbox=I.union(...this.children.map(i=>i.getBBox())),o&&!e.eq(this.bbox)&&(this.bbox.containsRect(e)?this.parent?.unionBBoxWith(this.bbox):this.parent?.recomputeBBox(true)),this.checkRep();}unionBBoxWith(o){this.bbox=this.bbox.union(o),this.parent?.unionBBoxWith(o);}updateParents(o=false){for(let e of this.children)e.parent=this,o&&e.updateParents(o);}rebalance(){if(this.parent&&this.parent.children.length===1){console.assert(this.parent.content===null),console.assert(this.parent.children[0]===this);let o=this.parent;if(o.parent!==null){let e=o.parent;e.children=e.children.filter(i=>i!==o),o.parent=null,o.children=[],this.parent=e,e.children.push(this),this.parent.recomputeBBox(false);}else this.content===null&&(this.parent.children=this.children,this.parent.updateParents(),this.parent=null);}if(this.children.length>this.targetChildCount*10){let o=this.getBBox().divideIntoGrid(4,4),e=[];for(;e.length<o.length;)e.push(0);for(let a of this.children)for(let[l,c]of o.entries())c.containsRect(a.getBBox())&&e[l]++;let i=0,r=e[0];for(let a=1;a<e.length;a++)e[a]>r&&(i=a,r=e[a]);let n=o[i];if(r>4){let a=[],l=[];for(let c of this.children)n.containsRect(c.getBBox())?l.push(c):a.push(c);if(l.length<this.children.length){this.children=a;let c=new s(this);this.children.push(c),c.children=l,c.updateParents(false),c.recomputeBBox(false),c.rebalance();}}}this.parent&&this.children.length===0&&this.content===null&&this.remove();}removeChild(o){this.checkRep();let e=this.children.length;this.children=this.children.filter(i=>i!==o),console.assert(this.children.length===e-1,`${e-1} \u2260 ${this.children.length} after removing all nodes equal to ${o}. Nodes should only be removed once.`),this.children.forEach(i=>{i.rebalance();}),this.recomputeBBox(true),this.rebalance(),this.checkRep();}remove(){if(this.content?.onRemoveFromImage(),!this.parent){this.content=null,this.children=[];return}this.parent.removeChild(this),this.parent=null,this.content=null,this.children=[],this.checkRep();}async renderAllAsync(o,e){let i=this.getLeaves();Qe(i);let r=i.length;for(let n=0;n<r;n++){let l=i[n].getContent();if(!l)continue;if(!await e(l,n,r))return  false;l.render(o,void 0);}return  true}render(o,e){let i;e?i=this.getLeavesIntersectingRegion(e,n=>o.isTooSmallToRender(n)):i=this.getLeaves(),Qe(i);let r=or(i);for(let n=r;n<i.length;n++)i[n].getContent().render(o,e);Zo&&e&&(r!==0&&console.log("EditorImage: skipped ",r,"nodes due to occlusion"),this.renderDebugBoundingBoxes(o,e));}renderDebugBoundingBoxes(o,e,i=0){let r=this.getBBox(),n=1/(o.getSizeOfCanvasPixelOnScreen()||1);if(r.maxDimension<3*n||!r.intersects(e))return;o.startObject(r);let a=!!this.content,l=a?P.ofRGBA(1,0,1,.4):P.ofRGBA(0,1,Math.sin(i),.6),c=a?1*n:2*n;if(o.drawRect(r.intersection(e),c,{fill:l}),o.endObject(),r.maxDimension>e.maxDimension/3){let d={fontFamily:"monospace",size:r.minDimension/20,renderingStyle:{fill:P.red}};o.drawText(`Depth: ${i}`,w.translation(r.bottomLeft),d);}for(let d of this.children)d.renderDebugBoundingBoxes(o,e,i+1);}checkRep(o=0){if(Zo){if(this.parent&&!this.parent.children.includes(this))throw new Error(`Parent does not have this node as a child. (depth: ${o})`);let e=null,i=new Set;for(let n of this.children){if(e??=n.getBBox(),e=e.union(n.getBBox()),n.parent!==this)throw new Error(`Child with bbox ${n.getBBox()} and ${n.children.length} has wrong parent (was ${n.parent}).`);if(i.has(n))throw new Error(`Child ${n} is present twice or more in its parent's child list`);i.add(n);}let r=this.bbox.minDimension/100;if(e&&!this.bbox.eq(e,r))throw new Error(`Wrong bounding box ${e} \\neq ${this.bbox} (depth: ${o})`)}}},jo=class extends Yt{fullscreenChildren=[];dataComponents=[];getChildrenIntersectingRegion(o,e){let i=super.getChildrenIntersectingRegion(o);for(let r of this.fullscreenChildren)i.push(r);return i}getChildrenOrSelfIntersectingRegion(o,e){let i=this.getContent();return i&&i.getSizingMode()===1?[this]:super.getChildrenOrSelfIntersectingRegion(o,e)}getLeaves(){let o=super.getLeaves();return this.dataComponents.concat(this.fullscreenChildren,o)}removeChild(o){let e=false,i=r=>{let n=r===o;return e||=n,!n};this.dataComponents=this.dataComponents.filter(i),this.fullscreenChildren=this.fullscreenChildren.filter(i),e||super.removeChild(o);}getChildWithContent(o){let e=()=>{let i=this.fullscreenChildren.concat(this.dataComponents);for(let r of i)if(r.getContent()===o)return r;return null};return o.getSizingMode()===0?super.getChildWithContent(o)??e():super.getChildWithContent(o)??e()}addLeaf(o){let e=o.getSizingMode();if(e===0)return super.addLeaf(o);if(e===1){this.onContentChange();let i=Yt.createLeafNode(this,o);return this.fullscreenChildren.push(i),i}else if(e===2){this.onContentChange();let i=Yt.createLeafNode(this,o);return this.dataComponents.push(i),i}else {throw new Error(`Invalid sizing mode, ${e}`)}}};var Xt=(i=>(i[i.BoundingBox=0]="BoundingBox",i[i.FillScreen=1]="FillScreen",i[i.Anywhere=2]="Anywhere",i))(Xt||{}),G=class s{constructor(o,e){this.componentKind=o;if(this.lastChangedTime=new Date().getTime(),e!==void 0?this.zIndex=e:this.zIndex=s.zIndexCounter++,this.id=`${new Date().getTime()}-${Math.random()}`,s.deserializationCallbacks[o]===void 0)throw new Error(`Component ${o} has not been registered using AbstractComponent.registerComponent`)}lastChangedTime;zIndex;id;static zIndexCounter=0;getId(){return this.id}static deserializationCallbacks={};static registerComponent(o,e){this.deserializationCallbacks[o]=e??null;}loadSaveData={};attachLoadSaveData(o,e){this.loadSaveData[o]||(this.loadSaveData[o]=[]),this.loadSaveData[o].push(e);}getLoadSaveData(){return this.loadSaveData}getZIndex(){return this.zIndex}getBBox(){return this.contentBBox}getExactBBox(){return this.getBBox()}getSizingMode(){return 0}occludesEverythingBelowWhenRenderedInRect(o){return  false}onAddToImage(o){}onRemoveFromImage(){}intersectsRect(o){return o.containsRect(this.getExactBBox())?true:o.getEdges().some(i=>this.intersects(i))}keyPoints(){return [this.getBBox().center]}isSelectable(){return  true}isBackground(){return  false}getProportionalRenderingTime(){return 1}transformBy(o){return new s.TransformElementCommand(o,this.getId(),this)}setZIndex(o){return new s.TransformElementCommand(w.identity,this.getId(),this,o)}setZIndexAndTransformBy(o,e,i){return new s.TransformElementCommand(o,this.getId(),this,e,i)}static transformElementCommandId="transform-element";static TransformElementCommand=class extends Xe{constructor(e,i,r,n,a){super(s.transformElementCommandId,i,r);this.affineTransfm=e;this.origZIndex=a;this.targetZIndex=n??s.zIndexCounter++,this.targetZIndex>=s.zIndexCounter&&(s.zIndexCounter=this.targetZIndex+1),r&&a===void 0&&(this.origZIndex=r.getZIndex());}targetZIndex;resolveComponent(e){this.component||(super.resolveComponent(e),this.origZIndex??=this.component.getZIndex());}updateTransform(e,i,r){if(!this.component)throw new Error("this.component is undefined or null!");let n=e.image.findParent(this.component),a=false;n&&(n.remove(),a=true),this.component.applyTransformation(i),this.component.zIndex=r,this.component.lastChangedTime=new Date().getTime(),r>=s.zIndexCounter&&(s.zIndexCounter=r+1),a&&K.addComponent(this.component).apply(e);}apply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm,this.targetZIndex),e.queueRerender();}unapply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm.inverse(),this.origZIndex),e.queueRerender();}description(e,i){return i.transformedElements(1,ft(exports.Vec2.zero,this.affineTransfm,false,i))}static{O.register(s.transformElementCommandId,(e,i)=>{let r=i.image.lookupElement(e.id)??void 0,n=new w(...e.transfm),a=e.targetZIndex,l=e.origZIndex??void 0;return new s.TransformElementCommand(n,e.id,r,a,l)});}serializeToJSON(){return {id:this.componentID,transfm:this.affineTransfm.toArray(),targetZIndex:this.targetZIndex,origZIndex:this.origZIndex}}};clone(){let o=this.createClone();for(let e in this.loadSaveData)for(let i of this.loadSaveData[e])o.attachLoadSaveData(e,i);return o}cloneWithId(o){let e=this.clone();return e.id=o,e}serialize(){let o=this.serializeToJSON();if(o===null)throw new Error(`${this} cannot be serialized.`);return {name:this.componentKind,zIndex:this.zIndex,id:this.id,loadSaveData:this.loadSaveData,data:o}}static isNotDeserializable(o){return typeof o=="string"&&(o=JSON.parse(o)),typeof o!="object"||!this.deserializationCallbacks[o?.name]||!o.data}static deserialize(o){if(typeof o=="string"&&(o=JSON.parse(o)),s.isNotDeserializable(o))throw new Error(`Element with data ${o} cannot be deserialized.`);er(o.id);let e=this.deserializationCallbacks[o.name](o.data);return e.id=o.id,isFinite(o.zIndex)&&(e.zIndex=o.zIndex,s.zIndexCounter=Math.max(s.zIndexCounter,e.zIndex+1)),e}};function kn(s){return {fill:s.fill,stroke:s.stroke?{...s.stroke}:void 0}}function Yo(s,o){return (s===o||s.fill.eq(o.fill)&&s.stroke==null==(o.stroke==null)&&(s.stroke?.color?.eq(o.stroke?.color)??true)&&s.stroke?.width===o.stroke?.width)??false}function Xo(s){let o=s.stroke?{color:s.stroke.color.toHexString(),width:s.stroke.width}:void 0;return {fill:s.fill.toHexString(),stroke:o}}function Qo(s){let o=s.stroke?{color:P.fromHex(s.stroke.color),width:s.stroke.width}:void 0;return {fill:P.fromHex(s.fill),stroke:o}}function ir(s){return {...s,renderingStyle:kn(s.renderingStyle)}}function Jo(s){if(typeof s=="string"&&(s=JSON.parse(s)),typeof s.fontFamily!="string")throw new TypeError("Serialized textStyle missing string fontFamily attribute!");return {renderingStyle:Qo(s.renderingStyle),size:s.size,fontWeight:s.fontWeight,fontVariant:s.fontVariant,fontFamily:s.fontFamily}}function ei(s){return {...s,renderingStyle:Xo(s.renderingStyle)}}function Rn(s){let o={};return s.color&&(o.color=s.color.toHexString()),s.textStyle&&(o.textStyle=ei(s.textStyle)),o}function Ln(s){let o=s.color?P.fromHex(s.color):void 0,e=s.textStyle?Jo(s.textStyle):void 0;return {color:o,textStyle:e}}function Je(s,o,e){return new rr(s,o,e.getId(),e)}function ti(s){return !(!("getStyle"in s&&"updateStyle"in s&&"forceStyle"in s)||!("isRestylableComponent"in s)||!s.isRestylableComponent)}var zn="default-restyle-element",rr=class s extends Xe{constructor(e,i,r,n){super(zn,r,n);this.originalStyle=e;this.newStyle=i;}getComponent(e){this.resolveComponent(e.image);let i=this.component;if(!i||!i.forceStyle||!i.updateStyle)throw new Error("this.component is missing forceStyle and/or updateStyle methods!");return i}apply(e){this.getComponent(e).forceStyle(this.newStyle,e);}unapply(e){this.getComponent(e).forceStyle(this.originalStyle,e);}description(e,i){return i.restyledElement(this.getComponent(e).description(i))}serializeToJSON(){return {id:this.componentID,originalStyle:Rn(this.originalStyle),newStyle:Rn(this.newStyle)}}static{O.register(zn,(e,i)=>{let r=Ln(e.originalStyle),n=Ln(e.newStyle),a=e.id;if(typeof e.id!="string")throw new TypeError(`json.id is of type ${typeof e.id}, not string.`);return new s(r,n,a)});}};var F=class s extends G{parts;contentBBox;isRestylableComponent=true;approximateRenderingTime;constructor(o,e){super("stroke",e),this.approximateRenderingTime=0,this.parts=[];for(let i of o){let r=Ye(i),n=this.bboxForPart(r.bbox,i.style);this.contentBBox?this.contentBBox=this.contentBBox.union(n):this.contentBBox=n,this.parts.push({path:r,startPoint:r.startPoint,style:i.style,commands:r.parts}),this.approximateRenderingTime+=r.parts.length;}this.contentBBox??=I.empty;}static fromStroked(o,e){return typeof o=="string"&&(o=B.fromString(o)),new s([M(o,{fill:P.transparent,stroke:e})])}static fromFilled(o,e){return typeof o=="string"&&(o=B.fromString(o)),new s([M(o,{fill:e})])}getStyle(){if(this.parts.length===0)return {};let o=this.parts[0];return o.style.stroke===void 0||o.style.stroke.width===0?{color:o.style.fill}:{color:o.style.stroke.color}}updateStyle(o){return Je(this.getStyle(),o,this)}forceStyle(o,e){o.color&&(this.parts=this.parts.map(i=>{let r={...i.style,stroke:i.style.stroke?{...i.style.stroke}:void 0};return r.stroke&&r.stroke.width>0?r.stroke.color=o.color:r.fill=o.color,{path:i.path,startPoint:i.startPoint,commands:i.commands,style:r}}),e&&(e.image.queueRerenderOf(this),e.queueRerender()));}withRegionErased(o,e){let i=o.polylineApproximation(),r=l=>o.closedContainsPoint(l),n=[],a=false;for(let l of this.parts){let c=l.path,d=g=>{if(l.style.fill.a>0){if(g.parts.length===0||g.parts.length===1&&g.parts[0].kind===0)return null;g=g.asClosed();}return isNaN(g.getExactBBox().area)?(console.warn("Prevented creating a stroke with NaN area"),a=true,null):new s([M(g,l.style)],this.getZIndex())},p=[];for(let g of i)p.push(...c.intersection(g));let u=false;if(p.length===0&&l.style.stroke&&l.style.stroke.width>o.bbox.minDimension*.3&&l.style.stroke.width<o.bbox.maxDimension*30){for(let g of i)p.push(...c.intersection(g,l.style.stroke.width/2));u=true;}p.sort(Go);let m=(()=>{if(p.length===0)return  false;if(u)return p[0].curveIndex===0&&p[0].parameterValue<=0;let g=Zi(p[0],-1e-10);return r(c.at(g))})()?1:0,f=(g,y)=>{let v=d(g),b=m%2===1;m++,y!==void 0&&(b=y),y===void 0&&!b&&o.closedContainsPoint(g.getExactBBox().center)&&(b=!b),v&&(a||=b&&g.getExactBBox().maxDimension>o.getExactBBox().maxDimension*2,b||n.push(v));};if(l.style.fill.a===0){if(!(o.getExactBBox().maxDimension/10>c.getExactBBox().maxDimension)){let y=c.splitAt(p,{mapNewPoint:v=>e.roundPoint(v)});for(let v of y)f(v);}}else if(p.length>=2&&p.length%2===0){let g=c.splitAt(p,{mapNewPoint:y=>e.roundPoint(y)});for(let y=0;y<Math.floor(g.length/2);y++)f(g[y].union(g[g.length-y-1]).asClosed());g.length%2!==0&&f(g[Math.floor(g.length/2)].asClosed());}else f(c,false);}return a?[this]:n}intersects(o){for(let e of this.parts){let i=e.style.stroke?.width,r=i?i/2:void 0;if(e.path.intersection(o,r).length>0)return  true}return  false}keyPoints(){return this.parts.flatMap(o=>o.startPoint)}intersectsRect(o){if(!o.intersects(this.getBBox()))return  false;for(let e of this.parts){let i=o.grownBy(-(e.style.stroke?.width??0));if(i.area!==0){for(let r of e.path.startEndPoints())if(i.containsPoint(r))return  true}}return super.intersectsRect(o)}simplifiedPath=null;computeSimplifiedPathFor(o){let e=[],i=false,r=false;for(let n of this.parts){if(r||!n.style.stroke||n.style.stroke.color.a<.99){e.push(n);continue}let a=_o(n,o);a?(e.push(a.path),a.fullScreen&&(i=true,r=true)):e.push(n);}return {forVisibleRect:o,parts:e,occludes:i}}occludesEverythingBelowWhenRenderedInRect(o){return this.getBBox().containsRect(o)?((!this.simplifiedPath||!this.simplifiedPath.forVisibleRect.eq(o))&&(this.simplifiedPath=this.computeSimplifiedPathFor(o)),this.simplifiedPath.occludes):false}render(o,e){o.startObject(this.getBBox());let i=this.parts;e&&this.simplifiedPath?.forVisibleRect?.containsRect(e)?i=this.simplifiedPath.parts:this.simplifiedPath=null;for(let r of i){let n=this.bboxForPart(r.path.bbox,r.style);e&&(!n.intersects(e)||(n.size.x>e.size.x*3||n.size.y>e.size.y*3)&&!r.path.roughlyIntersects(e,r.style.stroke?.width??0))||o.drawPath(r);}o.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return this.approximateRenderingTime}bboxForPart(o,e){return e.stroke?o.grownBy(e.stroke.width/2):o}getExactBBox(){let o=null;for(let{path:e,style:i}of this.parts){let r=this.bboxForPart(e.getExactBBox(),i);o??=r,o=o.union(r);}return o??I.empty}applyTransformation(o){this.contentBBox=I.empty;let e=true;this.parts=this.parts.map(i=>{let r=i.path.transformedBy(o),n={...i.style,stroke:i.style.stroke?{...i.style.stroke}:void 0};if(n.stroke){let l=o.getScaleFactor();n.stroke.width*=l;}let a=this.bboxForPart(r.bbox,n);return e?(this.contentBBox=a,e=false):this.contentBBox=this.contentBBox.union(a),{path:r,startPoint:r.startPoint,commands:r.parts,style:n}});}getParts(){return [...this.parts]}getPath(){let o=null;for(let e of this.parts)o?o=o.union(e.path):o??=e.path;return o??B.empty}description(o){return o.stroke}createClone(){return new s(this.parts)}serializeToJSON(){return this.parts.map(o=>({style:Xo(o.style),path:o.path.serialize()}))}static deserializeFromJSON(o){if(typeof o=="string"&&(o=JSON.parse(o)),typeof o!="object"||typeof o.length!="number")throw new TypeError(`${o} is missing required field, parts, or parts is of the wrong type.`);let e=o.map(i=>{let r=Qo(i.style);return M(B.fromString(i.path),r)});return new s(e)}};G.registerComponent("stroke",F.deserializeFromJSON);var Qt=W((s,o)=>new nr(s,o)),nr=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=[],i=Math.PI*2/6,r=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),n=this.startPoint.pos.lerp(this.endPoint.pos,.5),l=this.endPoint.pos.minus(n).length()-r/2,c=n.plus(exports.Vec2.of(l,0));for(let u=i;u<=Math.PI*2;u+=i){let h=exports.Vec2.of(l*Math.cos(u),-l*Math.sin(u)).plus(n),f=exports.Vec2.of(Math.cos(u-i/2),-Math.sin(u-i/2)).times(l*1.141).plus(n);o.push({kind:3,controlPoint:f,endPoint:h});}o.push({kind:0,point:c});let d=new B(c,o).mapPoints(u=>this.viewport.roundPoint(u));return new F([M(d,{fill:this.endPoint.color,stroke:{width:r,color:r===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Bn=W((s,o)=>new sr(s,o)),sr=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=[],e=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=this.startPoint.pos,n=this.startPoint.pos.distanceTo(this.endPoint.pos)/200,a=(u,h)=>i.plus(exports.Vec2.of((u-250)*n,(h-100)*n)),l=a(170,80);o.push({kind:1,point:l});let c=[[130,100,130,150,230,150],[250,180,320,180,340,150],[420,150,420,120,390,100],[430,40,370,30,340,50],[320,5,250,20,250,50],[200,5,150,20,170,80]];for(let[u,h,m,f,g,y]of c)o.push({kind:2,controlPoint1:a(u,h),controlPoint2:a(m,f),endPoint:a(g,y)});o.push({kind:0,point:l});let d=new B(l,o).mapPoints(u=>this.viewport.roundPoint(u));return new F([M(d,{fill:this.endPoint.color,stroke:{width:e,color:e===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var An=W((s,o)=>new Jt(s,true,o)),Jt=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=o.plus(e.minus(o).times(.5)),n={x:(e.x-o.x)*.5},a={y:(e.y-o.y)*.5},l=r.plus(exports.Vec3.of(-n.x,0,0)),c=r.plus(exports.Vec3.of(n.x,0,0)),d=r.plus(exports.Vec3.of(0,-a.y,0)),p=r.plus(exports.Vec3.of(0,a.y,0)),u=new B(l,[{kind:0,point:d},{kind:0,point:c},{kind:0,point:p},{kind:0,point:l}]).mapPoints(m=>this.viewport.roundPoint(m));return new F([M(u,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Dn=W((s,o)=>new ar(s,o)),ar=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=[],i=Math.PI*2/150,r=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),n=this.startPoint.pos.lerp(this.endPoint.pos,.5),l=this.endPoint.pos.minus(n).length(),d=[];for(let m=0;m<=150;m++){let f=m*i,g=16*Math.pow(Math.sin(f),3),y=13*Math.cos(f)-5*Math.cos(2*f)-2*Math.cos(3*f)-Math.cos(4*f),v=l/16,b=exports.Vec2.of(g*v,-y*v*.9).plus(n);d.push(b);}let p=d[0];for(let m=1;m<d.length;m+=2){let f=(m+1)%d.length,g=d[f],y=d[m];o.push({kind:3,controlPoint:y,endPoint:g});}o.push({kind:0,point:p});let u=new B(p,o).mapPoints(m=>this.viewport.roundPoint(m));return new F([M(u,{fill:this.endPoint.color,stroke:{width:r,color:r===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Mn=W((s,o)=>new eo(s,true,o)),eo=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=o.plus(e.minus(o).times(.5)),n=Math.abs(e.x-o.x)/2,a=Math.abs(e.y-o.y)/2,l=Math.min(n,a),c=[];for(let u=0;u<6;u++){let h=Math.PI/3*u,m=r.x+l*Math.cos(h),f=r.y+l*Math.sin(h);c.push(exports.Vec3.of(m,f,0));}let d=new B(c[0],[...c.slice(1).map(u=>({kind:0,point:u})),{kind:0,point:c[0]}]).mapPoints(u=>this.viewport.roundPoint(u));return new F([M(d,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Vn=W((s,o)=>new oi(s,true,o)),oi=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=e.x-o.x,n=e.y-o.y,a=Math.max(Math.abs(r),Math.abs(n)),l=Math.sign(r)||1,c=Math.sign(n)||1,d={x:o.x+a*l,y:o.y},p={x:d.x+a*l/2,y:d.y+a*c},u={x:o.x+a*l/2,y:o.y+a*c},h=new B(o,[{kind:0,point:exports.Vec3.of(d.x,d.y,0)},{kind:0,point:exports.Vec3.of(p.x,p.y,0)},{kind:0,point:exports.Vec3.of(u.x,u.y,0)},{kind:0,point:o}]).mapPoints(g=>this.viewport.roundPoint(g)),m={fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}};return new F([M(h,m)])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Fn=W((s,o)=>new to(s,true,o)),to=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=e.x-o.x,n=e.y-o.y,a=Math.max(Math.abs(r),Math.abs(n)),l=Math.sign(r)||1,c=Math.sign(n)||1,d=o.x+a*l,p=o.y+a*c,u=new B(o,[{kind:0,point:exports.Vec3.of(d,o.y,0)},{kind:0,point:exports.Vec3.of(d,p,0)},{kind:0,point:exports.Vec3.of(o.x,p,0)},{kind:0,point:o}]).mapPoints(f=>this.viewport.roundPoint(f)),h={fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}};return new F([M(u,h)])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var On=W((s,o)=>new lr(s,o)),lr=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),e=this.startPoint.pos.lerp(this.endPoint.pos,.5),i=e.distanceTo(this.endPoint.pos),r=5,a=i*.4,l=[],c=Math.PI*2/(r*2);for(let h=0;h<r*2;h++){let m=-Math.PI/2+h*c,f=h%2===0?i:a,g=exports.Vec2.of(e.x+f*Math.cos(m),e.y+f*Math.sin(m));l.push(g);}let d=[];for(let h=1;h<l.length;h++)d.push({kind:0,point:l[h]});d.push({kind:0,point:l[0]});let p=new B(l[0],d).mapPoints(h=>this.viewport.roundPoint(h));return new F([M(p,{fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var Hn=W((s,o)=>new oo(s,true,o)),oo=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=e.minus(o),n=r.orthog().normalized(),a=r.magnitude()*.866,l=o.plus(r.times(.5)).plus(n.times(a)),c=new B(o,[{kind:0,point:e},{kind:0,point:l},{kind:0,point:o}]).mapPoints(p=>this.viewport.roundPoint(p));return new F([M(c,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}getLineWidth(){return Math.max(this.startPoint.width,this.endPoint.width)}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var ta=(f=>(f[f.ToolEnabled=0]="ToolEnabled",f[f.ToolDisabled=1]="ToolDisabled",f[f.ToolUpdated=2]="ToolUpdated",f[f.UndoRedoStackUpdated=3]="UndoRedoStackUpdated",f[f.CommandDone=4]="CommandDone",f[f.CommandUndone=5]="CommandUndone",f[f.ObjectAdded=6]="ObjectAdded",f[f.ViewportChanged=7]="ViewportChanged",f[f.DisplayResized=8]="DisplayResized",f[f.SelectionUpdated=9]="SelectionUpdated",f[f.ReadOnlyModeToggled=10]="ReadOnlyModeToggled",f[f.ColorPickerToggled=11]="ColorPickerToggled",f[f.ColorPickerColorSelected=12]="ColorPickerColorSelected",f[f.ToolbarDropdownShown=13]="ToolbarDropdownShown",f))(ta||{}),oa=(i=>(i[i.CommandDone=0]="CommandDone",i[i.CommandUndone=1]="CommandUndone",i[i.CommandRedone=2]="CommandRedone",i))(oa||{});var Nn={remove(){}};function ia(){return Nn}var N=class s{waitForNextUpdate(){return new Promise(o=>{let e=this.onUpdate(i=>{e.remove(),o(i);});})}static fromInitialValue(o){return new ii(o)}static fromImmutable(o){return {get:()=>o,onUpdate:ia,onUpdateAndNow:e=>(e(o),Nn),waitForNextUpdate:()=>new Promise(()=>{})}}static fromCallback(o,e){let i=new ii(o()),r=typeof WeakRef<"u"?new WeakRef(i):{deref:()=>i};for(let n of e){let a=n.onUpdate(()=>{let l=r.deref();l?l.set(o()):a.remove();});}return i}static map(o,e,i){let r=s.fromInitialValue(e(o.get())),n=r.get();return o.onUpdate(a=>{n=e(a),r.set(n);}),i&&r.onUpdate(a=>{a!==n&&o.set(i(a));}),r}static union(o){return s.fromCallback(()=>o.map(e=>e.get()),o)}},Z=class extends N{static fromProperty(o,e){let i=N.fromInitialValue(o.get()[e]),r=typeof WeakRef<"u"?new WeakRef(i):{deref:()=>i},n=o.onUpdate(a=>{let l=r.deref();l?l.set(a[e]):n.remove();});return i.onUpdate(a=>{o.set({...o.get(),[e]:a});}),i}},ii=class extends Z{#e;#t;constructor(o){super(),this.#e=o,this.#t=[];}set(o){if(this.#e!==o){this.#e=o;for(let e of this.#t)e(o);}}get(){return this.#e}onUpdate(o){return this.#t.push(o),{remove:()=>{this.#t=this.#t.filter(e=>e!==o);}}}onUpdateAndNow(o){return o(this.get()),this.onUpdate(o)}},ri=N;var L="toolbar-";var cr=class{constructor(o,e,i){this.parent=o;this.notifier=e;this.onDestroy=i;this.visible=N.fromInitialValue(false),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add(`${L}dropdown`),this.dropdownContainer.classList.add("hidden"),o.target.insertAdjacentElement("afterend",this.dropdownContainer),this.dropdownToggleListener=this.notifier.on(0,r=>{r.dropdown!==this&&r.fromToplevelDropdown&&this.setVisible(false);});}dropdownContainer;visible;dropdownToggleListener=null;onActivated(){}repositionDropdown(){let o=this.dropdownContainer.getBoundingClientRect(),e=document.scrollingElement?.clientWidth??document.body.clientHeight,i=document.scrollingElement?.clientHeight??document.body.clientHeight,r,n;o.left>e/2&&(r=`calc(${this.parent.target.clientWidth+"px"} - 100%)`),o.bottom>i&&o.top-o.height>0&&(n=`calc(-${this.parent.target.clientHeight}px - 100%)`),r||n?this.dropdownContainer.style.translate=`${r??"0"} ${n??"0"}`:this.dropdownContainer.style.translate="";}hideDropdownTimeout=null;setVisible(o){if(this.visible.get()===o)return;this.hideDropdownTimeout&&(clearTimeout(this.hideDropdownTimeout),this.hideDropdownTimeout=null,this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown());let i=150;if(this.visible.set(o),o)this.dropdownContainer.classList.remove("hidden"),this.notifier.dispatch(0,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.repositionDropdown();else {this.notifier.dispatch(1,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.dropdownContainer.classList.add("hiding");let n=i*.95;this.hideDropdownTimeout=setTimeout(()=>{this.dropdownContainer.classList.add("hidden"),this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown();},n);}let r=`var(--dropdown-${o?"show":"hide"}-animation)`;this.dropdownContainer.style.animation=`${i}ms ease ${r}`;}requestShow(){this.setVisible(true);}requestHide(){this.setVisible(false);}appendChild(o){this.dropdownContainer.appendChild(o);}clearChildren(){this.dropdownContainer.replaceChildren();}destroy(){this.setVisible(false),this.dropdownContainer.remove(),this.dropdownToggleListener?.remove(),this.clearChildren(),this.onDestroy();}},io=class{constructor(o,e){this.localization=e;this.notifier=new Pe,this.notifier.on(0,({dropdown:i,fromToplevelDropdown:r})=>{i&&(o(this.localization.dropdownShown(i.parent.getTitle())),this.connectedNotifiers.forEach(n=>{n.dispatch(13,{kind:13,fromToplevelDropdown:r,layoutManager:this});}));}),this.notifier.on(1,({dropdown:i})=>{i&&o(this.localization.dropdownHidden(i.parent.getTitle()));});}notifier;dropdowns=new Set;listeners=[];connectedNotifiers=[];connectToEditorNotifier(o){this.connectedNotifiers.push(o),this.refreshListeners();}createToolMenu(o){let e=new cr(o,this.notifier,()=>{this.dropdowns.delete(e),this.refreshListeners();});return this.dropdowns.add(e),this.refreshListeners(),e}refreshListeners(){let o=()=>{this.listeners.forEach(e=>e.remove()),this.listeners=[];};this.dropdowns.size===0?o():this.listeners.length!==this.connectedNotifiers.length&&(o(),this.listeners=this.connectedNotifiers.map(e=>e.on(13,i=>{i.kind!==13||i.layoutManager===this||this.notifier.dispatch(0,{fromToplevelDropdown:i.fromToplevelDropdown});})));}};var ni=(p=>(p[p.PointerDownEvt=0]="PointerDownEvt",p[p.PointerMoveEvt=1]="PointerMoveEvt",p[p.PointerUpEvt=2]="PointerUpEvt",p[p.GestureCancelEvt=3]="GestureCancelEvt",p[p.WheelEvt=4]="WheelEvt",p[p.KeyPressEvent=5]="KeyPressEvent",p[p.KeyUpEvent=6]="KeyUpEvent",p[p.CopyEvent=7]="CopyEvent",p[p.PasteEvent=8]="PasteEvent",p[p.ContextMenu=9]="ContextMenu",p))(ni||{});function Un(s,o){return {kind:s,key:o.key,code:o.code,ctrlKey:o.ctrlKey||o.metaKey,altKey:o.altKey,shiftKey:o.shiftKey}}function si(s){return Un(6,s)}function ai(s){return Un(5,s)}function ro(s){return s.kind===0||s.kind===1||s.kind===2}var H=class{constructor(o,e){this.notifier=o;this.description=e;this.#e=N.fromInitialValue(true),this.#e.onUpdate(i=>{i?(this.#t?.notifyEnabled(this),this.notifier.dispatch(0,{kind:0,tool:this})):this.notifier.dispatch(1,{kind:1,tool:this});});}#e;#t=null;#o=null;#i=null;canReceiveInputInReadOnlyEditor(){return  false}setInputMapper(o){this.#o=o,o&&o.setEmitListener(e=>this.dispatchEventToCallback(e));}getInputMapper(){return this.#o}dispatchEventToCallback(o){let e;switch(o.kind){case 0:return this.onPointerDown(o);case 1:this.onPointerMove(o);break;case 2:return this.onPointerUp(o)??false;case 3:this.onGestureCancel(o);break;case 4:return this.onWheel(o);case 5:return this.onKeyPress(o);case 6:return this.onKeyUp(o);case 7:return this.onCopy(o);case 8:return this.onPaste(o);case 9:return this.onContextMenu(o);default:return e=o,e}return  true}onEvent(o){return this.#o?this.#o.onEvent(o):this.dispatchEventToCallback(o)}onPointerDown(o){return  false}onPointerMove(o){}onPointerUp(o){}onGestureCancel(o){}onWheel(o){return  false}onCopy(o){return  false}onPaste(o){return  false}onKeyPress(o){return  false}onKeyUp(o){return  false}onContextMenu(o){return  false}eventCanBeDeliveredToNonActiveTool(o){return  true}setEnabled(o){this.#e.set(o);}isEnabled(){return this.#e.get()}enabledValue(){return this.#e}setToolGroup(o){this.isEnabled()&&o.notifyEnabled(this),this.#t=o;}getToolGroup(){return this.#t?this.#t:null}onDestroy(){this.#i?.remove(),this.#i=null,this.#t=null;}};var Ne=class extends H{listeners=new Set([]);constructor(o){super(o.notifier,o.localization.changeTool);}registerListener(o){this.listeners.add(o);}removeListener(o){this.listeners.delete(o);}onKeyPress(o){let e=Array.from(this.listeners.values());for(let i of e)if(i(o))return  true;return  false}};function ra(s,o){let e=new Map,i=null,r=false,n=()=>{if(e.size===0)r?(r=false,o.onEnd()):i!==null&&(clearTimeout(i),i=null);else {let l=Date.now(),c=0;for(let u of e.values()){let h=l-u.timeEnter;c=Math.max(h,c);}let d=o.longPressTimeout??700;i!==null&&(clearTimeout(i),i=null);let p=d-c;p<=0?(o.onStart(),r=true):i=setTimeout(()=>{i=null,n();},p);}},a=l=>{let c={timeEnter:Date.now()};l.type==="pointerenter"?e.set(l.pointerId,c):(l.type==="pointerleave"||l.type==="pointercancel")&&e.clear(),n();};return s.addEventListener("pointerenter",a),s.addEventListener("pointerleave",a),s.addEventListener("pointercancel",a),{removeListeners:()=>{s.removeEventListener("pointerenter",a),s.removeEventListener("pointerleave",a),s.removeEventListener("pointercancel",a);}}}var Wn=ra;function na(s,o){let e="has-long-press-or-hover",i="no-long-press-or-hover";s.classList.add("no-long-press-or-hover");let{removeListeners:r}=Wn(s,{onStart(){s.classList.remove(i),s.classList.add(e);},onEnd(){s.classList.add(i),s.classList.remove(e);},longPressTimeout:o?.timeout});return {removeEventListeners:()=>{s.classList.remove(i),r();}}}var Ue=na;function sa(s,o){let e=[...o.draggableChildElements,s],i=0,r=0,n=0,a=0,l=false,c=null,d=y=>{if(!y)return  false;if(e.includes(y))return  true;let v=["INPUT","SELECT","IMG"],b=false,S=y.parentElement;for(;S&&!v.includes(S.tagName);){if(e.includes(S)){b=true;break}S=S.parentElement;}return !v.includes(y.tagName)&&b},p=[],u=(y,v,b)=>{s.addEventListener(y,v,b),p.push(()=>{s.removeEventListener(y,v);});},h=5,m=()=>Math.hypot(i-n,r-a)<h,f=false;u("pointerdown",y=>{y.defaultPrevented||!d(y.target)||y.isPrimary&&(f=false,i=y.clientX,r=y.clientY,n=y.clientX,a=y.clientY,c=null,l=true);},{passive:true});let g=y=>{l&&(c!==null&&(s.releasePointerCapture(c),c=null),o.onDragEnd({roughlyClick:m(),endTimestamp:performance.now(),displacement:exports.Vec2.of(i-n,r-a)}),l=false,f=false);};return u("pointermove",y=>{if(!y.isPrimary||!l)return;if(y.pointerType==="mouse"&&y.buttons===0){g();return}c===null&&!m()&&(s.setPointerCapture(y.pointerId),c=y.pointerId);let v=y.clientX,b=y.clientY,S=v-i,T=b-r;(!(Math.abs(v-n)<=h&&Math.abs(b-a)<=h)||f)&&(o.onDrag(S,T,exports.Vec2.of(v-n,b-a)),i=v,r=b,f=true);}),u("pointerleave",y=>{c===null&&l&&y.isPrimary&&(s.setPointerCapture(y.pointerId),c=y.pointerId);}),u("pointerup",g),u("pointercancel",g),{removeListeners:()=>{for(let y of p)y();}}}var li=sa;function aa(s){let o=(i,r)=>{let n=getComputedStyle(i);for(let a=0;a<n.length;a++){let l=n.item(a),c=n.getPropertyValue(l);r.style?.setProperty(l,c);}for(let a=0;a<i.children.length;a++){let l=i.children.item(a),c=r.children.item(a);l&&c?o(l,c):console.warn("CloneElement: Missing child");}},e=s.cloneNode(true);return o(s,e),e}var $n=aa;function la(s,o,e,i){let r=document.createElement("div");r.classList.add("help-page-container");let n=document.createElement("div");n.classList.add("label","-space-above"),n.setAttribute("aria-live","polite");let a=0,l=s[0]??null,c=[];r.addEventListener("click",g=>{g.target===r&&e();});let d=()=>{if(!l)return I.empty;let g=l.targetElements.map(y=>I.of(y.getBoundingClientRect()));return I.union(...g)},p=()=>{let g=d();for(let[y,v]of c.entries())for(let{container:b,bbox:S}of v)if(y===a)b.classList.add("-active"),b.classList.remove("-clickable","-background"),b.addEventListener("click",()=>{});else {S.containsRect(g)?(b.classList.add("-background"),b.classList.remove("-active","-clickable")):(b.classList.add("-clickable"),b.classList.remove("-active","-background"));let T=y;b.addEventListener("click",()=>{o(T);});}},u=()=>{let g=I.of(n.getBoundingClientRect()),y=d();if(g.intersects(y)){let v=I.of(r.getBoundingClientRect()),b=y.topLeft.y,S=v.bottomLeft.y-y.bottomLeft.y;b>S&&b>g.height/3&&(n.classList.remove("-small-space-above","-large-space-above"),n.classList.add("-large-space-below")),b<S&&S>g.height&&(n.classList.add("-large-space-above"),n.classList.remove("-large-space-below"));}},h=()=>{r.replaceChildren(),n.classList.remove("-large-space-above"),n.classList.add("-small-space-above","-large-space-below"),r.appendChild(n);let g=new I(0,0,window.innerWidth,window.innerHeight);c=[];for(let y of s){let v=[];for(let b of y.targetElements){let S=I.of(b.getBoundingClientRect());if(!g.intersects(S)){let R=g.bottomLeft.lerp(g.bottomRight,.5),k=S.bottomLeft.lerp(S.bottomRight,.5),D=R.minus(k);S=S.translatedBy(D);}let T=$n(b);for(let R of T.querySelectorAll("input"))R.disabled=true;T.style.margin="0";let C=document.createElement("div");C.classList.add("cloned-element-container"),C.role="group",C.ariaLabel=i.localization.helpControlsAccessibilityLabel,C.style.position="absolute",C.style.left=`${S.topLeft.x}px`,C.style.top=`${S.topLeft.y}px`,C.replaceChildren(T),Ue(C,{timeout:0}),v.push({container:C,bbox:S}),r.appendChild(C);}c.push(v);}p();},m=()=>{h(),u();},f=()=>{let g=document.createElement("div");g.textContent=l?.helpText??"",g.classList.add("current-item-help");let y=document.createElement("div");y.textContent=i.localization.helpScreenNavigationHelp,y.classList.add("navigation-help"),n.replaceChildren(g,...a===0?[y]:[]),p();};return f(),{addToParent:g=>{h(),g.appendChild(r),u();},refresh:m,setPageIndex:g=>{a=g,l=s[g],f();}}}var no=class{constructor(o,e){this.createOverlay=o;this.context=e;}#e=[];showHelpOverlay(){let o=document.createElement("dialog");o.setAttribute("autofocus","true"),o.classList.add("toolbar-help-overlay");let i=()=>{let b=250;o.classList.add("-hiding"),setTimeout(()=>o.close(),b);},r=0,n=()=>{performance.now()-r<100||i();},a=()=>{let b=document.createElement("button");b.classList.add("close-button"),b.appendChild(this.context.icons.makeCloseIcon());let S=this.context.localization.close;return b.setAttribute("aria-label",S),b.setAttribute("title",S),b.addEventListener("click",()=>{i();}),b},l=()=>{let b=Z.fromInitialValue(0),S=document.createElement("div");S.classList.add("navigation-content");let T=la(this.#e,k=>b.set(k),n,this.context);T.addToParent(S);let C=k=>{k>=this.#e.length||k<0?(console.warn("Help screen: Navigated to out-of-bounds page",k),S.style.display="none"):(S.style.display="",T.setPageIndex(k));};b.onUpdateAndNow(C);let R={content:S,currentPage:b,toNext:()=>{R.hasNext()&&b.set(b.get()+1);},toPrevious:()=>{R.hasPrevious()&&b.set(b.get()-1);},hasNext:()=>b.get()+1<this.#e.length,hasPrevious:()=>b.get()>0,refreshCurrent:()=>{T.refresh();}};return R},c=b=>{let S=document.createElement("div");S.classList.add("navigation-buttons");let T=document.createElement("button"),C=document.createElement("button");T.textContent=this.context.localization.next,C.textContent=this.context.localization.previous,T.classList.add("next"),C.classList.add("previous");let R=()=>{S.classList.remove("-has-next","-has-previous"),b.hasNext()?(S.classList.add("-has-next"),T.disabled=false):(S.classList.remove("-has-next"),T.disabled=true),b.hasPrevious()?(S.classList.add("-has-previous"),C.disabled=false):(S.classList.remove("-has-previous"),C.disabled=true);};return b.currentPage.onUpdateAndNow(R),T.addEventListener("click",()=>{b.toNext();}),C.addEventListener("click",()=>{b.toPrevious();}),S.replaceChildren(C,T),S},d=l(),p=c(d);o.replaceChildren(a(),p,d.content),this.createOverlay(o),o.showModal();let u=30,h=b=>{b>0&&!d.hasPrevious()&&(b=0),b<0&&!d.hasNext()&&(b=0),(b>u||b<-30)&&(b=u*Math.sign(b)),o.style.transform=`translate(${b}px, 0px)`,b>=u?p.classList.add("-highlight-previous"):p.classList.remove("-highlight-previous"),b<=-30?p.classList.add("-highlight-next"):p.classList.remove("-highlight-next");},m=li(o,{draggableChildElements:[d.content],onDrag:(b,S,T)=>{o.classList.add("-dragging"),h(T.x);},onDragEnd:b=>{if(o.classList.remove("-dragging"),h(0),!b.roughlyClick){let S=b.displacement.x;S>u?d.toPrevious():S<-30&&d.toNext(),r=b.endTimestamp;}}}),f;window.ResizeObserver&&(f=new ResizeObserver(()=>{d.refreshCurrent();}),f.observe(o));let g=()=>{requestAnimationFrame(()=>d.refreshCurrent());},y=window.matchMedia?.("(prefers-color-scheme: dark)");y?.addEventListener("change",g);let v=[d.content,p,o];o.addEventListener("click",b=>{v.includes(b.target)&&n();}),o.addEventListener("keyup",b=>{b.code==="Escape"?(i(),b.preventDefault()):b.code==="ArrowRight"?(d.toNext(),b.preventDefault()):b.code==="ArrowLeft"&&(d.toPrevious(),b.preventDefault());}),o.addEventListener("close",()=>{this.context.announceForAccessibility(this.context.localization.helpHidden),y?.removeEventListener("change",g),m.removeListeners(),f?.disconnect(),o.remove();});}registerTextHelpForElement(o,e){this.registerTextHelpForElements([o],e);}registerTextHelpForElements(o,e){this.#e.push({targetElements:[...o],helpText:e});}hasHelpText(){return this.#e.length>0}createToggleButton(){let o=document.createElement("div");o.classList.add("toolbar-help-overlay-button");let e=document.createElement("button");e.classList.add("button");let i=this.context.icons.makeHelpIcon();return i.classList.add("icon"),e.appendChild(i),e.setAttribute("aria-label",this.context.localization.help),e.addEventListener("click",()=>{this.showHelpOverlay();}),o.appendChild(e),o}};var Kn=(r=>(r.Save="save",r.Exit="exit",r.Undo="undo",r.Redo="redo",r))(Kn||{}),Q=class s{constructor(o,e,i){this.editor=o;this.id=e;this.localizationTable=i??o.localization;let r=new io(n=>this.editor.announceForAccessibility(n),this.localizationTable);r.connectToEditorNotifier(o.notifier),this.layoutManager=r,this.icon=null,this.container=document.createElement("div"),this.container.classList.add(`${L}toolContainer`,`${L}toolButtonContainer`,`${L}internalWidgetId--${e.replace(/\W/g,"-")}`),this.dropdownContent=document.createElement("div"),this.#e=false,this.button=document.createElement("div"),this.button.classList.add(`${L}button`),this.label=document.createElement("label"),this.button.setAttribute("role","button"),this.button.tabIndex=0,this.button.addEventListener("contextmenu",n=>{n.preventDefault();}),Ue(this.button);}container;button;icon;layoutManager;dropdown=null;dropdownContent;dropdownIcon;label;#e;disabled=false;#t=false;#o=[];subWidgets={};toplevel=true;localizationTable;#i=null;#r(){this.#i?.();let o=this.editor.toolController.getMatchingTools(Ne),e=null;if(o.length>0&&this.onKeyPress!==s.prototype.onKeyPress){let r=a=>this.onKeyPress(a),n=o[0];n.registerListener(r),e=()=>{n.removeListener(r);};}let i=this.editor.isReadOnlyReactiveValue().onUpdateAndNow(r=>{r&&this.shouldAutoDisableInReadOnlyEditor()&&!this.disabled?(this.setDisabled(true),this.#t=true,this.#e&&this.dropdown?.requestHide()):!r&&this.#t&&(this.#t=false,this.setDisabled(false));});this.#i=()=>{i.remove(),e?.(),this.#i=null;};}shouldAutoDisableInReadOnlyEditor(){return  true}getId(){return this.id}setTags(o){let e=i=>`toolwidget-tag--${i}`;for(let i of this.#o)this.container.classList.remove(e(i));this.#o=[...o];for(let i of this.#o)this.container.classList.add(e(i));}getTags(){return [...this.#o]}getUniqueIdIn(o){let e=this.getId(),i=0;for(;e in o&&o[e]!==this;)e=this.getId()+"-"+i.toString(),i++;return e}fillDropdown(o,e){if(Object.keys(this.subWidgets).length===0)return  false;for(let i in this.subWidgets){let r=this.subWidgets[i],n=r.addTo(o);r.setIsToplevel(false);let a=r.getHelpText();a&&e?.registerTextHelpForElement(n,a);}return  true}getHelpText(){}setupActionBtnClickListener(o){return this.setUpButtonEventListeners(o)}setUpButtonEventListeners(o){let e={Enter:true," ":true};o.addEventListener("keydown",i=>{let r=false;if(i.key in e&&(this.disabled||(this.handleClick(),r=true)),!r){let n=ai(i);r=this.editor.toolController.dispatchInputEvent(n);}r&&i.preventDefault();}),o.addEventListener("keyup",i=>{if(i.key in e)return;let r=si(i);this.editor.toolController.dispatchInputEvent(r)&&i.preventDefault();}),o.addEventListener("click",()=>{this.disabled||this.handleClick();}),o.addEventListener("dblclick",i=>{i.preventDefault();});}onKeyPress(o){return  false}get hasDropdown(){return this.#e}addSubWidget(o){let e=o.getUniqueIdIn(this.subWidgets);this.subWidgets[e]=o;}setLayoutManager(o){o!==this.layoutManager&&(this.layoutManager=o,this.container.parentElement&&this.addTo(this.container.parentElement));}addTo(o){this.icon=null,this.updateIcon(),this.label.innerText=this.getTitle();let e="long-label";this.label.innerText.length>7?this.label.classList.add(e):this.label.classList.remove(e),this.setUpButtonEventListeners(this.button),this.container.replaceChildren(),this.button.replaceChildren(this.icon,this.label),this.container.appendChild(this.button);let i=new no(n=>this.editor.createHTMLOverlay(n),this.editor),r=this.getHelpText();return r&&i.registerTextHelpForElement(this.dropdownContent,[this.getTitle(),r].join(`

`)),o.appendChild(this.container),this.container}remove(){this.container.remove(),this.#i?.();}focus(){this.button.focus();}addCSSClassToContainer(o){this.container.classList.add(o);}removeCSSClassFromContainer(o){this.container.classList.remove(o);}updateIcon(){let o=this.createIcon();o?this.container.classList.remove("no-icon"):(o=document.createElement("div"),this.container.classList.add("no-icon")),this.icon?.replaceWith(o),this.icon=o,this.icon.classList.add(`${L}icon`);}setDisabled(o){this.disabled=o,this.#t=false,this.disabled?(this.button.classList.add("disabled"),this.button.setAttribute("aria-disabled","true")):(this.button.classList.remove("disabled"),this.button.removeAttribute("aria-disabled"));}setSelected(o){this.isSelected()!==o&&(this.button.setAttribute("role","switch"),o?(this.container.classList.add("selected"),this.button.setAttribute("aria-checked","true")):(this.container.classList.remove("selected"),this.button.setAttribute("aria-checked","false")));}setDropdownVisible(o){o?this.dropdown?.requestShow():this.dropdown?.requestHide();}activateDropdown(){this.dropdown?.onActivated();}mustBeInToplevelMenu(){return  false}canBeInOverflowMenu(){return !this.mustBeInToplevelMenu()}getButtonWidth(){return this.button.clientWidth}isHidden(){return this.container.style.display==="none"}setHidden(o){this.container.style.display=o?"none":"";}setIsToplevel(o){this.toplevel=o;}isDropdownVisible(){return this.dropdown?.visible?.get()??false}isSelected(){return this.container.classList.contains("selected")}createDropdownIcon(){let o=this.editor.icons.makeDropdownIcon();return o.classList.add(`${L}showHideDropdownIcon`),o}serializeState(){let o={};for(let e in this.subWidgets)o[e]=this.subWidgets[e].serializeState();return {subwidgetState:o}}deserializeFrom(o){if(o.subwidgetState){qo(o.subwidgetState);for(let e in o.subwidgetState)if(e in this.subWidgets){let i=o.subwidgetState[e];i&&this.subWidgets[e].deserializeFrom(i);}}}};function ca(){let s=[...document.querySelectorAll("*:focus")];return s.length&&s.some(o=>o.classList.contains(`${L}button`))}var re=class extends Q{constructor(e,i,r,n){super(e,r,n);this.targetTool=i;this.targetTool.enabledValue().onUpdateAndNow(a=>{a?(this.setSelected(true),ca()&&this.focus()):(this.setSelected(false),this.setDropdownVisible(false));});}shouldAutoDisableInReadOnlyEditor(){return !this.targetTool.canReceiveInputInReadOnlyEditor()}handleClick(){this.targetTool.setEnabled(!this.targetTool.isEnabled());}onKeyPress(e){return this.isSelected()&&e.code==="Space"&&this.hasDropdown?(this.handleClick(),true):false}addTo(e){let i=super.addTo(e);return this.setSelected(this.targetTool.isEnabled()),i}};var so=class extends H{constructor(e,i){super(e.notifier,i);this.editor=e;this.enabledValue().onUpdateAndNow(()=>{this.updateSelectingStatus();});}colorPreviewListener=null;colorSelectListener=null;canReceiveInputInReadOnlyEditor(){return  true}updateSelectingStatus(){let e="pipette--color-selection-in-progress";this.isEnabled()&&this.colorSelectListener&&this.colorPreviewListener?this.editor.getRootElement().classList.add(e):this.editor.getRootElement().classList.remove(e);}setColorListener(e,i){this.colorPreviewListener=e,this.colorSelectListener=i,this.updateSelectingStatus();}clearColorListener(){this.colorPreviewListener=null,this.colorSelectListener=null,this.updateSelectingStatus();}onPointerDown({current:e,allPointers:i}){return this.colorPreviewListener&&i.length===1?(this.colorPreviewListener(this.editor.display.getColorAt(e.screenPos)),true):false}onPointerMove({current:e}){this.colorPreviewListener?.(this.editor.display.getColorAt(e.screenPos));}onPointerUp({current:e}){this.colorSelectListener?.(this.editor.display.getColorAt(e.screenPos));}onGestureCancel(){this.colorSelectListener?.(null);}};function da(s,o){let e=document.createElement("span"),i=document.createElement("span"),r=document.createElement("input");r.type="button",r.classList.add("coloris_input"),e.classList.add("color-input-container"),i.classList.add("color-input-wrapper"),i.appendChild(r),e.appendChild(i);let n=pa(s,e,h=>{r.value=h.toHexString(),c();let m=r.parentElement;m&&m.classList.contains("clr-field")&&(m.style.color=r.value);}),a,l=()=>{a=P.fromHex(r.value);},c=()=>{l(),a&&(s.announceForAccessibility(s.localization.colorChangedAnnouncement(a.toHexString())),o(a),s.notifier.dispatch(12,{kind:12,color:a}));};r.addEventListener("input",l);let d=false;r.addEventListener("open",()=>{d=true,s.notifier.dispatch(11,{kind:11,open:true}),n.cancel(),e.classList.add("picker-open"),document.querySelector("#clr-picker #clr-hue-slider")?.focus();});let p=()=>{d=false,s.notifier.dispatch(11,{kind:11,open:false}),c(),r.focus(),e.classList.remove("picker-open");};return r.addEventListener("close",()=>{p();}),{input:r,container:e,setValue:h=>{typeof h=="object"&&(h=h.toHexString()),r.value=h,r.dispatchEvent(new Event("input",{bubbles:true}));},closePicker:()=>{d&&c();},registerWithHelpTextDisplay:h=>{h.registerTextHelpForElement(i,s.localization.colorPickerToggleHelpText),n.registerWithHelpTextDisplay(h);}}}function pa(s,o,e){let i=document.createElement("button");i.classList.add("pipetteButton"),i.title=s.localization.pickColorFromScreen,i.setAttribute("alt",i.title);let r=document.createElement("span");r.classList.add("pickColorInstructions"),r.innerText=s.localization.clickToPickColorAnnouncement;let n=p=>{i.replaceChildren(s.icons.makePipetteIcon(p),r);};n();let a=s.toolController.getMatchingTools(so)[0],l=()=>{a?.clearColorListener(),n(),i.classList.remove("active");},c=p=>{l(),p&&e(p);},d=p=>{p?n(p):n();};return i.addEventListener("click",()=>{if(i.classList.contains("active")){l(),s.announceForAccessibility(s.localization.colorSelectionCanceledAnnouncement);return}a?.setColorListener(d,c),a&&(i.classList.add("active"),s.announceForAccessibility(s.localization.clickToPickColorAnnouncement));}),o.appendChild(i),{cancel:()=>{l();},registerWithHelpTextDisplay:p=>{p.registerTextHelpForElement(i,s.localization.colorPickerPipetteHelpText);}}}var Ee=da;function ua(s){let o=(e,i,r,n)=>{let a=i!==n&&e!==0,l=r+e<=0,d=r+i+e>n;return a&&!l&&!d};s.addEventListener("wheel",e=>{let i=o(e.deltaX,s.clientWidth,s.scrollLeft,s.scrollWidth),r=o(e.deltaY,s.clientHeight,s.scrollTop,s.scrollHeight);(i||r)&&e.stopPropagation();});}var gt=ua;var dr=0;function ha(s,o,e){let i=document.createElement("div");i.classList.add(`${L}grid-selector`);let r=Z.fromInitialValue(o),n=document.createElement("div");n.role="group",n.id=`${L}-grid-select-id-${dr++}`,gt(n);let a=document.createElement("label");a.textContent=s,a.htmlFor=n.id,i.appendChild(a);let l=`${L}-grid-selector-${dr++}`,c=u=>{let h=document.createElement("div");h.classList.add("choice-button");let m=document.createElement("input");m.type="radio",m.id=`${L}-grid-select-button-${dr++}`,Ue(h);let f=document.createElement("label"),g=()=>{f.setAttribute("title",u.title);let T=document.createElement("span");T.classList.add("button-label-text");let C=u.makeIcon();C.classList.add("icon"),T.innerText=u.title,f.htmlFor=m.id,f.replaceChildren(C,T);};g();let y=()=>{m.name=l;};y();let v=()=>{m.checked?h.classList.add("checked"):h.classList.remove("checked");};m.addEventListener("input",()=>{m.checked&&r.set(u.id),v();}),m.addEventListener("focus",()=>{h.querySelector(":focus-visible")&&h.classList.add("focus-visible");}),m.addEventListener("blur",()=>{h.classList.remove("focus-visible");}),h.addEventListener("contextmenu",T=>{T.preventDefault();}),h.replaceChildren(m,f),n.appendChild(h);let b=T=>{m.checked=T,v();};return b(false),{choiceRecord:u,setChecked:b,updateIcon:()=>{g();},updateButtonRadiogroupName:y}},d=[];for(let u of e)d.push(c(u));i.appendChild(n),r.onUpdateAndNow(u=>{for(let h of d)h.setChecked(h.choiceRecord.id===u);});let p={value:r,_radiogroupName:l,linkWith:u=>{p._radiogroupName=u._radiogroupName,l=u._radiogroupName;for(let h of d)h.updateButtonRadiogroupName();},updateIcons:()=>{d.forEach(u=>u.updateIcon());},getRootElement(){return i},addTo:u=>{u.appendChild(i);}};return p}var ao=ha;var ma=0;function fa(s,o){let e=document.createElement("div"),i=document.createElement("label"),r=document.createElement("input");e.classList.add(`${L}thicknessSliderContainer`),r.id=`${L}thicknessInput${ma++}`,i.innerText=s.localization.thicknessLabel,i.setAttribute("for",r.id);let n=c=>Math.log10(c),a=c=>10**c;r.type="range",r.addEventListener("input",()=>{o(a(Number.parseFloat(r.value)));}),e.appendChild(i),e.appendChild(r);let l=(c,d)=>{let p=(m,f)=>(f?Math.ceil:Math.floor)(m*100)/100,u=p(n(c),false),h=p(n(d),true);r.min=`${u}`,r.max=`${h}`,r.step=`${ie((h-u)/20)}`;};return l(2,262),{container:e,addTo:c=>{c.appendChild(e);},setBounds:l,setValue:c=>{r.value=n(c).toString();}}}var bt=fa;function Gn(s){return s.toUpperCase()===s&&s.toLowerCase()!==s&&s.length===1}function _n(s){return s.toLowerCase()===s&&s.toUpperCase()!==s&&s.length===1}var yt=class s{key;shiftKey;ctrlKey;altKey;metaKey;controlOrMeta;constructor(o){this.key=o.key,this.shiftKey=o.shiftKey,this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.metaKey=o.metaKey,this.controlOrMeta=o.controlOrMeta;}matchesEvent(o){let e=o.key?.toLowerCase(),i=Gn(o.key??""),r=_n(o.key??""),n=(o.ctrlKey??false)||e==="control",a=(o.altKey??false)||e==="alt",l=(o.metaKey??false)||e==="meta",c=(o.shiftKey??i)||e==="shift",d=o.controlOrMeta||o.ctrlKey||o.metaKey||false;if(this.key!==o.code&&(this.key.toLowerCase()!==e||(i||r)&&this.key!==o.key&&!(this.shiftKey===true&&this.key.toUpperCase()===o.key)))return  false;let p=this.controlOrMeta;return (n===this.ctrlKey&&l===this.metaKey&&!p||p&&d)&&a===this.altKey&&(c===this.shiftKey||this.shiftKey===void 0)}toString(){let o=[];return this.ctrlKey&&this.key!=="control"&&o.push("Ctrl"),this.controlOrMeta&&o.push("CtrlOrMeta"),this.altKey&&this.key!=="alt"&&o.push("Alt"),this.metaKey&&this.key!=="meta"&&o.push("Meta"),this.shiftKey&&this.key!=="shift"&&o.push("Shift"),o.push(this.key),o.join("+")}static fromString(o){let e=g=>{let y;Gn(g)?y=true:(_n(g)||g.length>1)&&(y=false);let v=g.toLowerCase();return v==="shift"&&(y=true),{shiftKey:y,ctrlKey:v==="control"||v==="ctrl",altKey:v==="alt",metaKey:v==="meta",controlOrMeta:v==="control or meta"||v==="ctrlormeta"}};if(o.search(/[+-]/)===-1||o.length===1){let g=e(o);return new s({key:o,...g})}let n=/^(.*[+-])?(.+)$/g.exec(o);if(!n)throw new Error(`Invalid shortcut expression, ${o}!`);let a=n[2],l=e(a),c=(n[1]??"").split(/[+-]/),d=l.shiftKey,p=l.ctrlKey,u=l.altKey,h=l.metaKey,m=l.controlOrMeta;for(let g of c)if(g!=="")switch(g.toLowerCase()){case "shift":d=true;break;case "anyshift":d=void 0;break;case "ctrl":case "control":p=true;break;case "meta":h=true;break;case "ctrlormeta":case "ctrl or meta":case "controlormeta":m=true;break;case "alt":u=true;break;default:throw new Error(`Unknown modifier: "${g}" in shortcut ${o}.`)}return new s({key:a,shiftKey:d,ctrlKey:p,altKey:u,metaKey:h,controlOrMeta:m})}};var qn={updatedViewport:"Transformed Viewport",transformedElements:(s,o)=>`Transformed ${s} element${s===1?"":"s"} (${o})`,resizeOutputCommand:s=>`Resized image to ${s.w}x${s.h}`,enabledAutoresizeOutputCommand:"Enabled output autoresize",disabledAutoresizeOutputCommand:"Disabled output autoresize",addComponentAction:s=>`Added ${s}`,eraseAction:(s,o)=>`Erased ${o} ${s}`,duplicateAction:(s,o)=>`Duplicated ${o} ${s}`,unionOf:(s,o)=>`Union: ${o} ${s}`,inverseOf:s=>`Inverse of ${s}`,elements:"Elements",erasedNoElements:"Erased nothing",duplicatedNoElements:"Duplicated nothing",rotatedBy:s=>`Rotated by ${Math.abs(s)} degrees ${s<0?"clockwise":"counter-clockwise"}`,movedLeft:"Moved left",movedUp:"Moved up",movedDown:"Moved down",movedRight:"Moved right",zoomedOut:"Zoomed out",zoomedIn:"Zoomed in",andNMoreCommands:s=>`And ${s} more commands.`,selectedElements:s=>`Selected ${s} element${s===1?"":"s"}`};var Zn={unlabeledImageNode:"Unlabeled image node",stroke:"Stroke",svgObject:"SVG Object",emptyBackground:"Empty background",gridBackground:"Grid background",dotBackground:"Dot background",filledBackgroundWithColor:s=>`Filled background (${s})`,text:s=>`Text object: ${s}`,imageNode:s=>`Image: ${s}`,restyledElement:s=>`Restyled ${s}`};var jn={pathNodeCount:s=>`There are ${s} visible path objects.`,textNodeCount:s=>`There are ${s} visible text nodes.`,imageNodeCount:s=>`There are ${s} visible image nodes.`,textNode:s=>`Text: ${s}`,imageNode:s=>`Image: ${s}`,unlabeledImageNode:"Unlabeled image",rerenderAsText:"Re-render as text"};var Yn={help:"Help",helpHidden:"Help hidden",next:"Next",previous:"Previous",close:"Close",helpScreenNavigationHelp:"Click on a control for more information.",helpControlsAccessibilityLabel:"Controls: Activate a control to show help."};var Xn={...Yn,pen:"Pen",eraser:"Eraser",select:"Select",handTool:"Pan",zoom:"Zoom",image:"Image",reformatSelection:"Format selection",inputAltText:"Alt text",decreaseImageSize:"Decrease size",resetImage:"Reset",chooseFile:"Choose file",dragAndDropHereOrBrowse:`Drag and drop here
or
{{browse}}`,submit:"Submit",addAll:"Add all",cancel:"Cancel",resetView:"Reset view",thicknessLabel:"Thickness",colorLabel:"Color",fontLabel:"Font",textSize:"Size",resizeImageToSelection:"Resize image to selection",deleteSelection:"Delete selection",duplicateSelection:"Duplicate selection",exit:"Exit",save:"Save",undo:"Undo",redo:"Redo",fullStrokeEraser:"Full stroke eraser",selectPenType:"Pen type",selectShape:"Shape",pickColorFromScreen:"Pick color from screen",clickToPickColorAnnouncement:"Click on the screen to pick a color",colorSelectionCanceledAnnouncement:"Color selection canceled",selectionTool__lassoSelect:"Freeform selection",selectionTool__lassoSelect__help:"When enabled, dragging creates a freeform (lasso) selection.",selectionToolKeyboardShortcuts:"Selection tool: Use arrow keys to move selected items, lowercase/uppercase \u2018i\u2019 and \u2018o\u2019 to resize.",documentProperties:"Page",backgroundColor:"Background color",imageWidthOption:"Width",imageHeightOption:"Height",useGridOption:"Grid",enableAutoresizeOption:"Auto-resize",toggleOverflow:"More",about:"About",inputStabilization:"Stabilization",strokeAutocorrect:"Autocorrect",touchPanning:"Scroll with touch",roundedTipPen:"Round",roundedTipPen2:"Polyline",flatTipPen:"Flat",arrowPen:"Arrow",linePen:"Line",outlinedRectanglePen:"Outlined rectangle",filledSquare:"Filled square",filledRectangle:"Filled rectangle",filledCircle:"Filled circle",filledTriangle:"Filled triangle",filledHexagonal:"Filled hexagonal",filledDiamond:"Filled diamond",filledArrow:"Filled arrow",outlinedCirclePen:"Outlined circle",lockRotation:"Lock rotation",paste:"Paste",errorImageHasZeroSize:"Error: Image has zero size",describeTheImage:"Image description",fileInput__loading:"Loading...",fileInput__andNMoreFiles:s=>`(...${s} more)`,penDropdown__baseHelpText:"This tool draws shapes or freehand lines.",penDropdown__colorHelpText:"Changes the pen's color",penDropdown__thicknessHelpText:"Changes the thickness of strokes drawn by the pen.",penDropdown__penTypeHelpText:`Changes the pen style.

Either a \u201Cpen\u201D style or \u201Cshape\u201D can be chosen. Choosing a \u201Cpen\u201D style draws freehand lines. Choosing a \u201Cshape\u201D draws shapes.`,penDropdown__autocorrectHelpText:`Converts approximate freehand lines and rectangles to perfect ones.

The pen must be held stationary at the end of a stroke to trigger a correction.`,penDropdown__stabilizationHelpText:`Draws smoother strokes.

This also adds a short delay between the mouse/stylus and the stroke.`,handDropdown__baseHelpText:"This tool is responsible for scrolling, rotating, and zooming the editor.",handDropdown__zoomInHelpText:"Zooms in.",handDropdown__zoomOutHelpText:"Zooms out.",handDropdown__resetViewHelpText:"Resets the zoom level to 100% and resets scroll.",handDropdown__zoomDisplayHelpText:"Shows the current zoom level. 100% shows the image at its actual size.",handDropdown__touchPanningHelpText:"When enabled, touchscreen gestures move the image rather than select or draw.",handDropdown__lockRotationHelpText:"When enabled, prevents touch gestures from rotating the screen.",eraserDropdown__baseHelpText:"This tool removes strokes, images, and text under the cursor.",eraserDropdown__thicknessHelpText:"Changes the size of the eraser.",eraserDropdown__fullStrokeEraserHelpText:`When in full-stroke mode, entire shapes are erased.

When not in full-stroke mode, shapes can be partially erased.`,selectionDropdown__baseHelpText:"Selects content and manipulates the selection",selectionDropdown__resizeToHelpText:`Crops the drawing to the size of what's currently selected.

If auto-resize is enabled, it will be disabled.`,selectionDropdown__deleteHelpText:"Erases selected items.",selectionDropdown__duplicateHelpText:"Makes a copy of selected items.",selectionDropdown__changeColorHelpText:"Changes the color of selected items.",pageDropdown__baseHelpText:"Controls the drawing canvas' background color, pattern, and size.",pageDropdown__backgroundColorHelpText:"Changes the background color of the drawing canvas.",pageDropdown__gridCheckboxHelpText:"Enables/disables a background grid pattern.",pageDropdown__autoresizeCheckboxHelpText:`When checked, the page grows to fit the drawing.

When unchecked, the page is visible and its size can be set manually.`,pageDropdown__aboutButtonHelpText:"Shows version, debug, and other information.",colorPickerPipetteHelpText:"Picks a color from the screen.",colorPickerToggleHelpText:"Opens/closes the color picker.",closeSidebar:s=>`Close sidebar for ${s}`,dropdownShown:s=>`Menu for ${s} shown`,dropdownHidden:s=>`Menu for ${s} hidden`,zoomLevel:s=>`Zoom: ${s}%`,colorChangedAnnouncement:s=>`Color changed to ${s}`,imageSize:(s,o)=>`Image size: ${s} ${o}`,imageLoadError:s=>`Error loading image: ${s}`};var Qn={penTool:s=>`pen-${s}`,selectionTool:"Selection",selectAllTool:"Select all shortcut",eraserTool:"Eraser",touchPanTool:"Touch panning",twoFingerPanZoomTool:"Panning and zooming",undoRedoTool:"Undo/Redo",rightClickDragPanTool:"Right-click drag",pipetteTool:"Pick color from screen",keyboardPanZoom:"Keyboard pan/zoom shortcuts",selectionMenu__show:"Show selection menu",selectionMenu__copyToClipboard:"Copy to clipboard",selectionMenu__duplicate:"Duplicate",selectionMenu__delete:"Delete",selectionMenu__paste:"Paste",copyPasteError__heading:"Copy/paste",copyPasteError__description:"Something went wrong \u2014 this tool may not have clipboard access.",copyPasteError__errorDetails:"Show error",copyPasteError__pasteRetry:"To retry, please paste into the input box below:",copyPasteError__copyRetry:"To retry, please copy the text in the input box below:",copyPasteError__copyMe:"Copy me!",autocorrectedTo:s=>`Autocorrected to ${s}`,autocorrectionCanceled:"Autocorrect cancelled",textTool:"Text",enterTextToInsert:"Text to insert",changeTool:"Change tool",pasteHandler:"Copy paste handler",soundExplorer:"Sound-based image exploration",disableAccessibilityExploreTool:"Disable sound-based exploration",enableAccessibilityExploreTool:"Enable sound-based exploration",soundExplorerUsageAnnouncement:"Sound-based image exploration enabled: Click/drag the screen to play a sound representation of different parts of the image.",findLabel:"Find",toNextMatch:"Next",closeDialog:"Close",findDialogShown:"Find dialog shown",findDialogHidden:"Find dialog hidden",focusedFoundText:(s,o)=>`Viewing match ${s} of ${o}`,anyDevicePanning:"Any device panning",copied:s=>`Copied ${s} item(s)`,pasted:s=>`Pasted ${s} item(s)`,toolEnabledAnnouncement:s=>`${s} enabled`,toolDisabledAnnouncement:s=>`${s} disabled`};var We={...Xn,...Qn,...qn,...Zn,...jn,accessibilityInputInstructions:['Press "t" to read the contents of the viewport as text.',"Use the arrow keys to move the viewport, click and drag to draw strokes.",'Press "w" to zoom in and "s" to zoom out.'].join(" "),loading:s=>`Loading ${s}%...`,imageEditor:"Image Editor",doneLoading:"Done loading",undoAnnouncement:s=>`Undid ${s}`,redoAnnouncement:s=>`Redid ${s}`,softwareLibraries:"Libraries",developerInformation:"Developer information"};var ga={...We,pen:"Stift",eraser:"Radierer",select:"Auswahl",handTool:"Verschieben",zoom:"Vergr\xF6\xDFerung",image:"Bild",inputAltText:"Alt-Text: ",chooseFile:"W\xE4hle Datei: ",submit:"Absenden",cancel:"Abbrechen",resetView:"Ansicht zur\xFCcksetzen",thicknessLabel:"Dicke: ",colorLabel:"Farbe: ",fontLabel:"Schriftart: ",textSize:"Gr\xF6\xDFe: ",resizeImageToSelection:"Bildgr\xF6\xDFe an Auswahl anpassen",deleteSelection:"Auswahl l\xF6schen",duplicateSelection:"Auswahl duplizieren",undo:"R\xFCckg\xE4ngig",redo:"Wiederholen",pickColorFromScreen:"Farbe von Bildschirm ausw\xE4hlen",clickToPickColorAnnouncement:"Klicke auf den Bildschirm, um eine Farbe auszuw\xE4hlen",selectionToolKeyboardShortcuts:"Auswahl-Werkzeug: Verwende die Pfeiltasten, um ausgew\xE4hlte Elemente zu verschieben und \u201Ai\u2018 und \u201Ao\u2018, um ihre Gr\xF6\xDFe zu \xE4ndern.",touchPanning:"Ansicht mit Touchscreen verschieben",anyDevicePanning:"Ansicht mit jedem Eingabeger\xE4t verschieben",selectPenType:"Objekt-Typ: ",roundedTipPen:"Freihand",flatTipPen:"Stift (druckempfindlich)",arrowPen:"Pfeil",linePen:"Linie",outlinedRectanglePen:"Umrissenes Rechteck",filledRectanglePen:"Ausgef\xFClltes Rechteck",lockRotation:"Sperre Rotation",paste:"Einf\xFCgen",dropdownShown:s=>`Dropdown-Men\xFC f\xFCr ${s} angezeigt`,dropdownHidden:s=>`Dropdown-Men\xFC f\xFCr ${s} versteckt`,zoomLevel:s=>`Verg\xF6\xDFerung: ${s}%`,colorChangedAnnouncement:s=>`Farbe zu ${s} ge\xE4ndert`,imageSize:(s,o)=>`Bild-Gr\xF6\xDFe: ${s} ${o}`,imageLoadError:s=>`Fehler beim Laden des Bildes: ${s}`,errorImageHasZeroSize:"Fehler: Bild hat Gr\xF6\xDFe Null",penTool:s=>`Stift ${s}`,selectionTool:"Auswahl",eraserTool:"Radiergummi",touchPanTool:"Ansicht mit Touchscreen verschieben",twoFingerPanZoomTool:"Ansicht verschieben und vergr\xF6\xDFern",undoRedoTool:"R\xFCckg\xE4ngig/Wiederholen",rightClickDragPanTool:"Rechtsklick-Ziehen",pipetteTool:"Farbe von Bildschirm ausw\xE4hlen",keyboardPanZoom:"Tastaturk\xFCrzel zum Verschieben/Vergr\xF6\xDFern der Ansicht",textTool:"Text",enterTextToInsert:"Einzuf\xFCgender Text",changeTool:"Wechsle Werkzeug",pasteHandler:"Copy-Paste-Handler",findLabel:"Finde",toNextMatch:"N\xE4chstes",closeDialog:"Schlie\xDFen",findDialogShown:"Finde-Dialog angezeigt",findDialogHidden:"Finde-Dialog versteckt",focusedFoundText:(s,o)=>`Sieh Treffer ${s} von ${o} an`,toolEnabledAnnouncement:s=>`${s} aktiviert`,toolDisabledAnnouncement:s=>`${s} deaktiviert`,updatedViewport:"Transformierte Ansicht",transformedElements:(s,o)=>`${s} Element${s===1?"":"e"} transformiert (${o})`,resizeOutputCommand:s=>`Bildgr\xF6\xDFe auf ${s.w}x${s.h} ge\xE4ndert`,addComponentAction:s=>`${s} hinzugef\xFCgt`,eraseAction:(s,o)=>`${o} ${s} gel\xF6scht`,duplicateAction:(s,o)=>`${o} ${s} dupliziert`,inverseOf:s=>`${s} umgekehrt`,elements:"Elemente",erasedNoElements:"Nichts entfernt",duplicatedNoElements:"Nichts dupliziert",rotatedBy:s=>`${Math.abs(s)} Grad ${s<0?"im Uhrzeigersinn":"gegen den Uhrzeigersinn"} gedreht`,movedLeft:"Nacht links bewegt",movedUp:"Nacht oben bewegt",movedDown:"Nacht unten bewegt",movedRight:"Nacht rechts bewegt",zoomedOut:"Ansicht verkleinert",zoomedIn:"Ansicht vergr\xF6\xDFert",selectedElements:s=>`${s} Element${s===1?"":"e"} ausgew\xE4hlt`,stroke:"Strich",svgObject:"SVG-Objekt",text:s=>`Text-Objekt: ${s}`,pathNodeCount:s=>`Es gibt ${s} sichtbare Pfad-Objekte.`,textNodeCount:s=>`Es gibt ${s} sichtbare Text-Knotenpunkte.`,textNode:s=>`Text: ${s}`,imageNodeCount:s=>`Es gibt ${s} sichtbare Bild-Knoten.`,imageNode:s=>`Bild: ${s}`,unlabeledImageNode:"Bild ohne Label",rerenderAsText:"Als Text darstellen",accessibilityInputInstructions:"Dr\xFCcke \u201At\u2018, um den Inhalt des Ansichtsfensters als Text zu lesen. Verwende die Pfeiltasten, um die Ansicht zu verschieben, und klicke und ziehe, um Striche zu zeichnen. Dr\xFCcke \u201Aw\u2018 zum Vergr\xF6\xDFern und \u201As\u2018 zum Verkleinern der Ansicht.",loading:s=>`Laden ${s}%...`,doneLoading:"Laden fertig",imageEditor:"Bild-Editor",undoAnnouncement:s=>`${s} r\xFCckg\xE4ngig gemacht`,redoAnnouncement:s=>`${s} wiederholt`,reformatSelection:"Formatiere Auswahl",documentProperties:"Seite",backgroundColor:"Hintergrundfarbe: ",imageWidthOption:"Breite: ",imageHeightOption:"H\xF6he: ",useGridOption:"Gitter: ",toggleOverflow:"Mehr",selectAllTool:"Alle ausw\xE4hlen",soundExplorer:"Klangbasierte Bilderkundung",disableAccessibilityExploreTool:"Deaktiviere klangbasierte Erkundung",enableAccessibilityExploreTool:"Aktiviere klangbasierte Erkundung",unionOf:(s,o)=>`Vereinigung: ${o} ${s}`,emptyBackground:"Leerer Hintergrund",filledBackgroundWithColor:s=>`Gef\xFCllter Hintergrund (${s})`,restyledElement:s=>`${s} umgestaltet`},Jn=ga;var ba={...We},es=ba;var ya={...We,pen:"Lapiz",eraser:"Borrador",select:"Selecciona",handTool:"Mover",image:"Imagen",inputAltText:"Texto alternativo",resetImage:"Reiniciar",chooseFile:"Seleccionar archivo",cancel:"Cancelar",resetView:"Reiniciar vista",thicknessLabel:"Tama\xF1o",fontLabel:"Fuente:",textSize:"Tama\xF1o",resizeImageToSelection:"Redimensionar la imagen a lo que est\xE1 seleccionado",deleteSelection:"Borra la selecci\xF3n",duplicateSelection:"Duplica la selecci\xF3n",exit:"Salir",save:"Guardar",undo:"Deshace",redo:"Rehace",selectPenType:"Punta",selectShape:"Forma",pickColorFromScreen:"Selecciona un color de la pantalla",clickToPickColorAnnouncement:"Haga un clic en la pantalla para seleccionar un color",documentProperties:"Fondo",backgroundColor:"Color de fondo",imageWidthOption:"Ancho",imageHeightOption:"Alto",enableAutoresizeOption:"Redimensionar autom\xE1tico",toggleOverflow:"M\xE1s",about:"Acerca de",touchPanning:"Mover la pantalla con un dedo",roundedTipPen:"Lapiz Redondeado",arrowPen:"Flecha",linePen:"L\xEDnea",outlinedRectanglePen:"Rect\xE1ngulo delineado",filledRectanglePen:"Rect\xE1ngulo sin borde",lockRotation:"Bloquea rotaci\xF3n",paste:"Pegar",selectionMenu__paste:"Pegar",selectionMenu__delete:"Eliminar",selectionMenu__duplicate:"Duplicar",closeSidebar:s=>`Close sidebar for ${s}`,dropdownShown:s=>`Men\xFA por ${s} es visible`,dropdownHidden:s=>`Men\xFA por ${s} fue ocultado`,zoomLevel:s=>`Zoom: ${s}%`,colorChangedAnnouncement:s=>`Color fue cambiado a ${s}`,imageSize:(s,o)=>`Tama\xF1o del imagen: ${s} ${o}`,imageLoadError:s=>`Error cargando imagen: ${s}`,penTool:s=>`Lapiz ${s}`,selectionTool:"Selecciona",eraserTool:"Borrador",touchPanTool:"Instrumento de mover la pantalla con un dedo",undoRedoTool:"Deshace/rehace",pipetteTool:"Seleccione un color de la pantalla",keyboardPanZoom:"Mover la pantalla con el teclado",textTool:"Texto",enterTextToInsert:"Entra texto",findLabel:"Buscar",toNextMatch:"Pr\xF3xima",closeDialog:"Cerrar",anyDevicePanning:"Mover la pantalla con todo dispotivo",copied:s=>`${s} cosas fueron copiados`,pasted:s=>s===1?"Pegado":`${s} cosas fueron pegados`,toolEnabledAnnouncement:s=>`${s} fue activado`,toolDisabledAnnouncement:s=>`${s} fue desactivado`,resizeOutputCommand:s=>`Tama\xF1o de imagen fue cambiado a ${s.w}x${s.h}`,eraseAction:(s,o)=>`Borrado: ${o} ${s}`,rerenderAsText:"Redibuja la pantalla al texto",loading:s=>`Cargando: ${s}%...`,imageEditor:"Editor de dibujos",doneLoading:"El cargado termin\xF3",undoAnnouncement:s=>`${s} fue deshecho`,redoAnnouncement:s=>`${s} fue rehecho`},ts=ya;var va={de:Jn,en:es,es:ts};function xa(s){let o=/^(\w+)[_-](\w+)$/.exec(s);return o?o[1]:s}function ci(s,o,e){let i;for(let r of s){let n=xa(r);if(i&&n!==i&&i in o)return o[i];if(r in o)return o[r];i=n;}return i&&i in o?o[i]:e}function Sa(s){return s??=navigator.languages,ci(s,va,We)}var pr=Sa;var V=class s{static shortcuts=Object.create(null);static shortcutDefaultDescriptions=Object.create(null);static shortcutLocalizedDescriptions=Object.create(null);shortcutOverrides=Object.create(null);constructor(o){for(let e in o)this.overrideShortcut(e,o[e]);}overrideShortcut(o,e){this.shortcutOverrides[o]=[...e];}matchesShortcut(o,e){let i=this.shortcutOverrides[o];if(!i)if(o in s.shortcuts)i=s.shortcuts[o];else throw new Error(`No shortcut with ID ${o} exists!`);for(let r of i)if(r.matchesEvent(e))return  true;return  false}static registerDefaultKeyboardShortcut(o,e,i){if(o in s.shortcuts)return  false;let r=e.map(n=>typeof n=="string"?yt.fromString(n):n);return s.shortcuts[o]=[...r],s.shortcutDefaultDescriptions[o]=i,true}static provideShortcutDescription(o,e,i){e in s.shortcutLocalizedDescriptions||(s.shortcutLocalizedDescriptions[e]=Object.create(null)),s.shortcutLocalizedDescriptions[e][o]=i;}static getAllShortcutIds(){let o=[];for(let e in this.shortcuts)o.push(e);return o}static getShortcutDefaultKeybindings(o){if(!(o in s.shortcuts))throw new Error(`No shortcut with ID ${o} exists!`);return s.shortcuts[o]}static getShortcutDescription(o,e){return ci(e??[],this.shortcutLocalizedDescriptions,this.shortcutDefaultDescriptions)[o]??this.shortcutDefaultDescriptions[o]??null}};var ur="easydraw.toolbar.SelectionTool.resizeImageToSelection";V.registerDefaultKeyboardShortcut(ur,["ctrlOrMeta+r"],"Resize image to selection");var lo=[1,2,3,4,5,6,7,8,9].map(s=>`easydraw.toolbar.PenTool.select-pen-${s}`);for(let[s,o]of lo.entries())V.registerDefaultKeyboardShortcut(o,[`CtrlOrMeta+Digit${s+1}`],"Select pen style "+(s+1));var hr="easydraw.toolbar.SaveActionWidget.save";V.registerDefaultKeyboardShortcut(hr,["ctrlOrMeta+KeyS"],"Save");var mr="easydraw.toolbar.ExitActionWidget.exit";V.registerDefaultKeyboardShortcut(mr,["Alt+KeyQ"],"Exit");var co=W((s,o)=>new di(s,o)),di=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getLineWidth(){return Math.max(this.endPoint.width||5,this.startPoint.width||5)}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=e.minus(o).normalized(),r=e.distanceTo(o),n=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),a=Math.min(n+3,r/2),l=n+3,c=n+3,d=e.minus(i.times(a)),p=i.orthog(),u=p.times(l),h=p.times(c),m=new B(d.minus(h),[{kind:0,point:o.minus(u)},{kind:0,point:o.plus(u)},{kind:0,point:d.plus(h)},{kind:0,point:d.plus(p.times(a).plus(h))},{kind:0,point:e.plus(i.times(c))},{kind:0,point:d.plus(p.times(-a).minus(h))},{kind:0,point:d.minus(h)}]).mapPoints(g=>this.viewport.roundPoint(g));return new F([{startPoint:m.startPoint,commands:m.parts,style:{fill:this.startPoint.color,stroke:{width:n,color:n===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}}}])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};function Ca(s){return (o,e)=>new fr(s,o,e)}var vt=Ca;function os(s,o,e){return {points:[s,o[o.length-1]]}}function is(s,o,e){return {points:[...e.corners,e.corners[0]]}}var fr=class{constructor(o,e,i){this.sourceFactory=o;this.startPoint=e;this.viewport=i;this.builder=o(e,i),this.points=[e];}builder;points;getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(o){this.builder.preview(o);}addPoint(o){this.points.push(o),this.builder.addPoint(o);}async autocorrectShape(){let o=this.viewport.canvasToScreen(this.startPoint.pos),e=this.points.map(C=>this.viewport.canvasToScreen(C.pos)),i=I.bboxOf(e),r=this.viewport.canvasToScreen(this.viewport.snapToGrid(this.startPoint.pos)),n=this.points.map(C=>this.viewport.canvasToScreen(this.viewport.snapToGrid(C.pos))),a=I.bboxOf(n);if(i.maxDimension<32)return null;let l=Math.min(30,i.maxDimension/4),c=[{...os(r,n),toleranceMultiplier:.5},os(o,e),{...is(r,n,a),toleranceMultiplier:.6},is(o,e,i)],p=(C=>{for(let R of c){let k=R.points,D=C*C*(R.toleranceMultiplier??1),U=Ce=>{for(;Ce<0;)Ce+=k.length;return Ce%=k.length,k[Ce]},$=null,de=1/0,se=0;for(let[Ce,dt]of k.entries()){let $t=dt.squareDistanceTo(o);(!$||$t<de)&&(de=$t,$=dt,se=Ce);}let pe=0,Se=se;for(let Ce of e){let dt=1/0,$t=Se,pn=6;for(let Ni=-6;Ni<=pn;Ni++){let Vo=Se+Ni,Ds=U(Vo-1),un=U(Vo),Ms=U(Vo+1),Vs=new oe(Ds,un),Fs=new oe(un,Ms),Os=Vs.distance(Ce),Hs=Fs.distance(Ce),hn=Math.min(Os,Hs),mn=hn*hn;mn<dt&&(dt=mn,$t=Vo);}if(Se=$t,pe=Math.max(dt,pe),pe>D)break}if(pe<D)return k}return null})(l);if(!p)return null;let u=this.points[this.points.length-1],h=this.startPoint.width,m=u.width,f=this.startPoint.color,g=u.color,y=this.startPoint.time,v=u.time,b=C=>{let R=p[Math.max(0,Math.floor(C))],k=p[Math.min(Math.ceil(C),p.length-1)],D=R.lerp(k,C-Math.floor(C)),U=C/p.length;return {pos:this.viewport.screenToCanvas(D),width:h*(1-U)+m*U,color:f.mix(g,U),time:y*(1-U)+v*U}},S=this.sourceFactory(b(0),this.viewport),T=p.length<10;for(let C=0;C<p.length;C++)T&&S.addPoint(b(C-.001)),S.addPoint(b(C)),T&&S.addPoint(b(C+.001));return S.build()}};var et=class{constructor(o,e,i,r){this.startPoint=o;this.minFitAllowed=e;this.maxFitAllowed=i;this.onCurveAdded=r;this.lastPoint=this.startPoint,this.buffer=[this.startPoint.pos],this.momentum=exports.Vec2.zero,this.currentCurve=null,this.curveStartWidth=o.width,this.bbox=new I(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;buffer;lastPoint;lastExitingVec=null;currentCurve=null;curveStartWidth;curveEndWidth;momentum;bbox;getBBox(){return this.bbox}preview(){return this.currentCurve?this.currentSegmentToPath():null}approxCurrentCurveLength(){if(!this.currentCurve)return 0;let o=this.currentCurve.p0,e=this.currentCurve.p1,i=this.currentCurve.p2,r=o.distanceTo(e),n=i.distanceTo(e);return r+n}finalizeCurrentCurve(){if(!this.currentCurve)return;this.onCurveAdded(this.currentSegmentToPath());let o=this.buffer[this.buffer.length-1];this.lastExitingVec=this.currentCurve.p2.minus(this.currentCurve.p1),console.assert(this.lastExitingVec.magnitude()!==0,"lastExitingVec has zero length!"),this.buffer=[this.buffer[this.buffer.length-2],o],this.currentCurve=null,this.isFirstSegment=false;}currentSegmentToPath(){if(this.currentCurve==null)throw new Error("Invalid State: currentCurve is null!");let o=this.currentCurve.normal(0).normalized();if(!isFinite(o.magnitude()))throw new TypeError(`startVec(${o}) is NaN or \u221E`);let e=this.currentCurve.at(0),i=this.currentCurve.at(1),r=this.currentCurve.p1;return {startPoint:e,controlPoint:r,endPoint:i,startWidth:this.curveStartWidth,endWidth:this.curveEndWidth}}computeExitingVec(){return this.momentum.normalized().times(this.lastPoint.width/2)}addPoint(o){if(this.lastPoint){let S=o.time-this.lastPoint.time;if(o.pos.eq(this.lastPoint.pos,1e-10)||S===0)return;if(isNaN(o.pos.magnitude())){console.warn("Discarding NaN point.",o);return}let T=Math.min(this.lastPoint.width,o.width)/3;if(this.startPoint.pos.distanceTo(o.pos)<T&&this.isFirstSegment)return;let R=S/1e3,k=o.pos.minus(this.lastPoint.pos).times(1/R);this.momentum=k;}let e=this.lastPoint??o;this.lastPoint=o,this.buffer.push(o.pos);let i=o.width,r=this.curveEndWidth;if(this.curveEndWidth=i,this.bbox=this.bbox.grownToPoint(o.pos,i),this.currentCurve===null){let b=e.pos,S=e.pos.plus(this.lastExitingVec??exports.Vec2.unitX),T=o.pos;this.currentCurve=new Te(b,S,T),console.assert(!isNaN(b.magnitude())&&!isNaN(S.magnitude())&&!isNaN(T.magnitude()),"Expected !NaN"),this.isFirstSegment?this.curveStartWidth=(this.curveStartWidth+i)/2:this.curveStartWidth=r;}let n=this.lastExitingVec;if(!n){let b=Math.ceil(this.buffer.length/2);(b===0||b>=this.buffer.length)&&(b=this.buffer.length-1),n=this.buffer[b].minus(this.buffer[0]);}let a=this.computeExitingVec(),l=1.7,c=this.buffer[0],d=o.pos,p=d.distanceTo(c),u=l*p;if(u===0||a.magnitude()===0||!isFinite(a.magnitude()))return;console.assert(isFinite(n.magnitude()),"Pre-normalized enteringVec has NaN or \u221E magnitude!"),n=n.normalized(),a=a.normalized(),console.assert(isFinite(n.magnitude()),"Normalized enteringVec has NaN or \u221E magnitude!");let h=new oe(c,c.plus(n.times(u))),f=new oe(d.minus(a.times(u)),d).intersection(h),g=null;f&&(g=f.point),g||(g=c.lerp(d,.5).lerp(c.plus(n.times(p)),.1)),(c.eq(g)||d.eq(g))&&(g=c.plus(n.times(p/5))),console.assert(!c.eq(g,1e-11),"Start and control points are equal!"),console.assert(!g.eq(d,1e-11),"Control and end points are equal!");let y=this.currentCurve;this.currentCurve=new Te(c,g,d),isNaN(this.currentCurve.normal(0).magnitude())&&(console.error("NaN normal at 0. Curve:",this.currentCurve),this.currentCurve=y);let v=b=>{let S=Math.min(Math.max(Math.min(this.curveStartWidth,this.curveEndWidth)/4,this.minFitAllowed),this.maxFitAllowed),T=S,C=0;for(let R of this.buffer){let k=b.approximateDistance(R);if(k>S&&(k=b.distance(R),C+=Math.max(0,k-S),C>T))return  false}return  true};if(this.buffer.length>3&&this.approxCurrentCurveLength()>this.curveStartWidth/2&&!v(this.currentCurve)){this.currentCurve=y,this.curveEndWidth=r,this.lastPoint=e,this.finalizeCurrentCurve();return}}},Ta=et;var fe=vt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*3,i=o.getSizeOfPixelOnCanvas();return new pi(s,i,e,o)}),pi=class{constructor(o,e,i,r){this.startPoint=o;this.minFitAllowed=e;this.viewport=r;this.curveFitter=new et(o,e,i,n=>this.addCurve(n)),this.averageWidth=o.width,this.bbox=new I(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;parts=[];curveFitter;bbox;averageWidth;widthAverageNumSamples=1;getBBox(){return this.bbox}getRenderingStyle(){return {fill:P.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let e=[...this.parts.slice(),...this.curveToPathCommands(this.curveFitter.preview())];return {startPoint:this.startPoint.pos,commands:e,style:this.getRenderingStyle()}}previewFullPath(){let o=this.previewCurrentPath();return o?[o]:null}previewStroke(){let o=this.previewFullPath();return o?new F(o):null}preview(o){let e=this.previewFullPath();if(e){let i=this.viewport.visibleRect;o.startObject(i);for(let r of e)o.drawPath(r);o.endObject();}}build(){return this.curveFitter.finalizeCurrentCurve(),this.previewStroke()}getMinFit(){let o=Math.min(this.minFitAllowed,this.averageWidth/3);return o<1e-10&&(o=this.minFitAllowed),o}roundPoint(o){let e=this.getMinFit();return A.roundPoint(o,e)}roundDistance(o){let e=this.getMinFit();return A.roundPoint(o,e)}curveToPathCommands(o){if(!o){if(!this.isFirstSegment)return [];let i=A.roundPoint(this.averageWidth/10,Math.min(this.minFitAllowed,this.averageWidth/10)),r=this.roundPoint(this.startPoint.pos);return [{kind:3,controlPoint:r.plus(exports.Vec2.of(i,i)),endPoint:r.plus(exports.Vec2.of(0,i))},{kind:3,controlPoint:r.plus(exports.Vec2.of(-i,i)),endPoint:r.plus(exports.Vec2.of(-i,0))},{kind:3,controlPoint:r.plus(exports.Vec2.of(-i,-i)),endPoint:r.plus(exports.Vec2.of(0,-i))},{kind:3,controlPoint:r.plus(exports.Vec2.of(i,-i)),endPoint:r.plus(exports.Vec2.of(i,0))}]}let e=[];return this.isFirstSegment&&e.push({kind:1,point:this.roundPoint(o.startPoint)}),e.push({kind:3,controlPoint:this.roundPoint(o.controlPoint),endPoint:this.roundPoint(o.endPoint)}),e}addCurve(o){let e=this.curveToPathCommands(o);this.parts.push(...e),this.isFirstSegment&&(this.isFirstSegment=false);}addPoint(o){this.curveFitter.addPoint(o),this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+o.width/this.widthAverageNumSamples;}};var Be=vt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*.65;return new ui(s,e,o)}),ui=class{constructor(o,e,i){this.minFitAllowed=e;this.viewport=i;this.averageWidth=o.width,this.startPoint={...o,pos:this.roundPoint(o.pos)},this.lastPoint=this.startPoint.pos,this.bbox=new I(this.startPoint.pos.x,this.startPoint.pos.y,0,0),this.parts=[{kind:1,point:this.startPoint.pos}];}parts=[];bbox;averageWidth;widthAverageNumSamples=1;lastPoint;startPoint;lastLineSegment=null;getBBox(){return this.bbox.grownBy(this.averageWidth)}getRenderingStyle(){return {fill:P.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let o=this.startPoint.pos,e=[...this.parts];return e.length<=1&&e.push({kind:0,point:o.plus(exports.Vec2.of(this.averageWidth/4,0))}),{startPoint:o,commands:e,style:this.getRenderingStyle()}}previewFullPath(){return [this.previewCurrentPath()]}preview(o){let e=this.previewFullPath();if(e){let i=this.viewport.visibleRect;o.startObject(i);for(let r of e)o.drawPath(r);o.endObject();}}build(){return new F(this.previewFullPath())}getMinFit(){let o=Math.min(this.minFitAllowed,this.averageWidth/4);return o<1e-10&&(o=this.minFitAllowed),o}roundPoint(o){let e=this.getMinFit();return A.roundPoint(o,e)}roundDistance(o){let e=this.getMinFit();return A.roundPoint(o,e)}addPoint(o){this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+o.width/this.widthAverageNumSamples;let e=this.roundPoint(o.pos);e.eq(this.lastPoint)||(this.lastLineSegment&&this.lastLineSegment.direction.dot(e.minus(this.lastPoint).normalized())>.997&&(this.parts.pop(),this.lastPoint=this.lastLineSegment.p1),this.parts.push({kind:0,point:this.roundPoint(o.pos)}),this.bbox=this.bbox.grownToPoint(e),this.lastLineSegment=new oe(this.lastPoint,e),this.lastPoint=e);}};var $e=vt((s,o)=>{let e=o.getSizeOfPixelOnCanvas()*3,i=o.getSizeOfPixelOnCanvas();return new hi(s,i,e,o)}),hi=class{constructor(o,e,i,r){this.startPoint=o;this.minFitAllowed=e;this.viewport=r;this.upperSegments=[],this.lowerSegments=[],this.curveFitter=new et(o,e,i,n=>this.addCurve(n)),this.curveStartWidth=o.width,this.bbox=new I(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;pathStartConnector=null;mostRecentConnector=null;nextCurveStartConnector=null;upperSegments;lowerSegments;lastUpperBezier=null;lastLowerBezier=null;parts=[];curveFitter;curveStartWidth;bbox;getBBox(){return this.bbox}getRenderingStyle(){return {fill:this.startPoint.color??null}}previewCurrentPath(o=true){let e=this.upperSegments.slice(),i=this.lowerSegments.slice(),r,n,a=this.curveFitter.preview();if(a&&o){let{upperCurveCommand:d,lowerToUpperConnector:p,upperToLowerConnector:u,lowerCurveCommand:h}=this.segmentToPath(a);e.push(d),i.push(h),r=p,n=this.pathStartConnector??[u];}else {if(this.mostRecentConnector===null||this.pathStartConnector===null)return null;r=this.mostRecentConnector,n=this.pathStartConnector;}let l,c=i[i.length-1];return c.kind===0||c.kind===1?l=c.point:l=c.endPoint,{startPoint:l,commands:[r,...e.reverse(),...n,...i],style:this.getRenderingStyle()}}previewFullPath(){let o=this.previewCurrentPath();return o?[...this.parts,o]:null}preview(o){let e=this.previewFullPath();if(e){let i=this.viewport.visibleRect;o.startObject(i);for(let r of e)o.drawPath(r);o.endObject();}}build(){return this.curveFitter.finalizeCurrentCurve(),this.isFirstSegment&&this.addCurve(null),new F(this.previewFullPath())}roundPoint(o){let e=Math.min(this.minFitAllowed,this.curveStartWidth/3);return e<1e-10&&(e=this.minFitAllowed),A.roundPoint(o,e)}shouldStartNewSegment(o,e){if(!this.lastLowerBezier||!this.lastUpperBezier)return  false;let i=(c,d)=>{let p=c.intersectsBezier(d);return p.length===0?null:p[0].point},r=c=>c.p2.minus(c.p1).normalized(),n=c=>c.p1.minus(c.p0).normalized();if(n(e).dot(r(this.lastUpperBezier))<.35||n(o).dot(r(this.lastLowerBezier))<.35||n(e).dot(r(e))<0||n(o).dot(r(o))<0)return  true;let a=i(o,this.lastUpperBezier),l=i(e,this.lastLowerBezier);return !!(a||l)}addCurve(o){if(!o){if(!this.isFirstSegment)return;let p=A.roundPoint(this.startPoint.width/2.2,Math.min(this.minFitAllowed,this.startPoint.width/4)),u=this.roundPoint(this.startPoint.pos),h=this.startPoint.pos.plus(exports.Vec2.of(p,0));this.lowerSegments.push({kind:3,controlPoint:u.plus(exports.Vec2.of(p,p)),endPoint:u.plus(exports.Vec2.of(0,p))},{kind:3,controlPoint:u.plus(exports.Vec2.of(-p,p)),endPoint:u.plus(exports.Vec2.of(-p,0))},{kind:3,controlPoint:u.plus(exports.Vec2.of(-p,-p)),endPoint:u.plus(exports.Vec2.of(0,-p))},{kind:3,controlPoint:u.plus(exports.Vec2.of(p,-p)),endPoint:u.plus(exports.Vec2.of(p,0))});let m={kind:0,point:h};this.pathStartConnector=[m],this.mostRecentConnector=m;return}let{upperCurveCommand:e,lowerToUpperConnector:i,upperToLowerConnector:r,lowerCurveCommand:n,lowerCurve:a,upperCurve:l,nextCurveStartConnector:c}=this.segmentToPath(o),d=this.shouldStartNewSegment(a,l);if(d){let p=this.previewCurrentPath(false);p?(this.parts.push(p),this.upperSegments=[],this.lowerSegments=[]):d=false;}(this.isFirstSegment||d)&&(this.pathStartConnector=this.nextCurveStartConnector??[r],this.isFirstSegment=false),this.mostRecentConnector=i,this.nextCurveStartConnector=c,this.lowerSegments.push(n),this.upperSegments.push(e),this.lastLowerBezier=a,this.lastUpperBezier=l,this.curveStartWidth=o.startWidth;}segmentToPath(o){let e=new Te(o.startPoint,o.controlPoint,o.endPoint),i=e.normal(0),r=e.normal(1);i=i.times(o.startWidth/2),r=r.times(o.endWidth/2),isFinite(i.magnitude())||(console.error("Warning: startVec is NaN or \u221E",i,r,o),i=r);let n=o.startPoint,a=o.endPoint,l=o.controlPoint,d=e.nearestPointTo(l).parameterValue,p=e.normal(d).times(o.startWidth/2*d+o.endWidth/2*(1-d)),u=this.roundPoint(n.plus(i)),h=this.roundPoint(l.plus(p)),m=this.roundPoint(a.plus(r)),f=this.roundPoint(l.minus(p)),g=this.roundPoint(a.minus(r)),y=this.roundPoint(n.minus(i)),v={kind:3,controlPoint:h,endPoint:m},b={kind:0,point:u},S={kind:0,point:g},T=[{kind:0,point:g},{kind:0,point:m}],C={kind:3,controlPoint:f,endPoint:y},R=new Te(g,f,y),k=new Te(u,h,m);return {upperCurveCommand:C,upperToLowerConnector:b,lowerToUpperConnector:S,lowerCurveCommand:v,upperCurve:R,lowerCurve:k,nextCurveStartConnector:T}}addPoint(o){this.curveFitter.addPoint(o);}};var uo=W((s,o)=>new po(s,true,o)),gr=W((s,o)=>new po(s,false,o)),po=class{constructor(o,e,i){this.startPoint=o;this.filled=e;this.viewport=i;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.viewport.getRotationAngle(),e=w.zRotation(-o),i=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=e.inverse().transformVec2(this.startPoint.pos),n=e.inverse().transformVec2(this.endPoint.pos),a=I.fromCorners(r,n),l=B.fromRect(a,this.filled?null:this.endPoint.width).transformedBy(e).mapPoints(d=>this.viewport.roundPoint(d));return new F([M(l,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var ho=class s extends re{constructor(e,i,r){super(e,i,"shape",r);this.tool=i;let n=e.getCurrentSettings().pens?.additionalPenTypes??[],a=e.getCurrentSettings().pens?.filterPenTypes??(()=>true);this.penTypes=[{name:this.localizationTable.filledSquare,id:"square",isShapeBuilder:true,factory:Fn},{name:this.localizationTable.filledRectangle,id:"rectangle",isShapeBuilder:true,factory:uo},{name:this.localizationTable.filledCircle,id:"circle",isShapeBuilder:true,factory:Qt},{name:this.localizationTable.filledTriangle,id:"triangle",isShapeBuilder:true,factory:Hn},{name:this.localizationTable.filledHexagonal,id:"hexagonal",isShapeBuilder:true,factory:Mn},{name:this.localizationTable.filledDiamond,id:"diamond",isShapeBuilder:true,factory:An},{name:this.localizationTable.filledArrow,id:"arrow",isShapeBuilder:true,factory:co},{name:this.localizationTable.linePen,id:"line",isShapeBuilder:true,factory:mo},{name:this.localizationTable.linePen,id:"heart",isShapeBuilder:true,factory:Dn},{name:this.localizationTable.linePen,id:"star",isShapeBuilder:true,factory:On},{name:this.localizationTable.linePen,id:"cloud",isShapeBuilder:true,factory:Bn},{name:this.localizationTable.linePen,id:"parallelogram",isShapeBuilder:true,factory:Vn},...n.filter(l=>l.isShapeBuilder)].filter(a),this.editor.notifier.on(2,l=>{if(l.kind!==2)throw new Error("Invalid event type!");l.tool===this.tool&&(this.updateIcon(),this.updateInputs());}),this.init();}updateInputs=()=>{};penTypes;static idCounter=0;penTypeSelect;getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){let e=this.tool.getStrokeFactory();for(let i=0;i<this.penTypes.length;i++)if(this.penTypes[i].factory===e)return i;return  -1}getCurrentPenType(){for(let e of this.penTypes)if(e.factory===this.tool.getStrokeFactory())return e;return null}createIconForRecord(e){let i={...this.tool.getStyleValue().get()};e?.factory&&(i.factory=e.factory);let r=e?.factory;return !r||r===fe||r===$e||r===Be?this.editor.icons.makePenIcon(i):this.editor.icons.makeIconFromFactory(i)}init(){this.penTypeSelect=this.createPenTypeSelector(),this.penTypeSelect.setValue(1);}getPenTypeSelect(){return this.penTypeSelect}setShapeType(e){this.penTypeSelect.setValue(e);}createIcon(){return this.createIconForRecord(this.getCurrentPenType())}createPenTypeSelector(e){let r=this.penTypes.map((l,c)=>({id:c,makeIcon:()=>this.createIconForRecord(l),title:l.name,isShapeBuilder:l.isShapeBuilder??false})).filter(l=>l.isShapeBuilder),n=ao(this.localizationTable.selectShape,this.getCurrentPenTypeIdx(),r),a=l=>{this.tool.setStrokeFactory(this.penTypes[l].factory);};return n.value.onUpdate(a),e?.registerTextHelpForElements([n.getRootElement()],this.localizationTable.penDropdown__penTypeHelpText),{setValue:l=>{n.value.set(l);},updateIcons:()=>{n.updateIcons();},addTo:l=>{r.length>0&&n.addTo(l);}}}createStrokeCorrectionOptions(e){let i=document.createElement("div");i.classList.add("action-button-row",`${L}-pen-tool-toggle-buttons`);let r=(l,c)=>{let d=document.createElement("button");d.classList.add(`${L}-toggle-button`);let p=c.cloneNode(true);p.classList.add("icon");let u=document.createElement("span");u.innerText=l,d.replaceChildren(p,u),d.setAttribute("role","switch"),i.appendChild(d);let h=false,m=g=>{},f={setChecked(g){h=g,d.setAttribute("aria-checked",`${h}`),m(h);},setOnInputListener(g){m=g;},addHelpText(g){e?.registerTextHelpForElement(d,g);}};return d.addEventListener("click",()=>{f.setChecked(!h);}),f},n=r(this.localizationTable.inputStabilization,this.editor.icons.makeStrokeSmoothingIcon());n.setOnInputListener(l=>{this.tool.setHasStabilization(l);});let a=r(this.localizationTable.strokeAutocorrect,this.editor.icons.makeShapeAutocorrectIcon());return a.setOnInputListener(l=>{this.tool.setStrokeAutocorrectEnabled(l);}),a.addHelpText(this.localizationTable.penDropdown__autocorrectHelpText),n.addHelpText(this.localizationTable.penDropdown__stabilizationHelpText),{update:()=>{n.setChecked(!!this.tool.getInputMapper()),a.setChecked(this.tool.getStrokeAutocorrectionEnabled());},addTo:l=>{l.appendChild(i);}}}getHelpText(){return this.localizationTable.penDropdown__baseHelpText}fillDropdown(e,i){let r=document.createElement("div");r.classList.add(`${L}spacedList`,`${L}nonbutton-controls-main-list`);let{container:n,setValue:a}=bt(this.editor,f=>{this.tool.setThickness(f);}),l=document.createElement("div"),c=document.createElement("label"),d=Ee(this.editor,f=>{this.tool.setColor(f);}),{input:p,container:u}=d;p.id=`${L}colorInput${s.idCounter++}`,c.innerText=this.localizationTable.colorLabel,c.setAttribute("for",p.id),l.appendChild(c),l.appendChild(u);let h=this.createStrokeCorrectionOptions(i),m=this.createPenTypeSelector(i);return i?.registerTextHelpForElement(l,this.localizationTable.penDropdown__colorHelpText),i&&d.registerWithHelpTextDisplay(i),i?.registerTextHelpForElement(n,this.localizationTable.penDropdown__thicknessHelpText),this.updateInputs=()=>{d.setValue(this.tool.getColor()),a(this.tool.getThickness()),m.updateIcons(),m.setValue(this.getCurrentPenTypeIdx()),h.update();},this.updateInputs(),r.replaceChildren(l,n),m.addTo(r),e.replaceChildren(r),h.addTo(e),true}onKeyPress(e){if(!this.isSelected())return  false;for(let[i,r]of lo.entries())if(this.editor.shortcuts.matchesShortcut(r,e)){let n=i;if(n<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[n].factory),true}return !!super.onKeyPress(e)}serializeState(){return {...super.serializeState(),color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:this.getCurrentPenType()?.id,inputStabilization:!!this.tool.getInputMapper(),strokeAutocorrect:this.tool.getStrokeAutocorrectionEnabled()}}deserializeFrom(e){super.deserializeFrom(e);let i=(r,n)=>{let a=typeof e[r];if(a!==n)throw new Error(`Deserializing property ${r}: Invalid type. Expected ${n}, was ${a}.`)};if(e.color&&(i("color","string"),this.tool.setColor(P.fromHex(e.color))),e.thickness&&(i("thickness","number"),this.tool.setThickness(e.thickness)),e.strokeFactoryId){i("strokeFactoryId","string");let r=e.strokeFactoryId;for(let n of this.penTypes)if(r===n.id){this.tool.setStrokeFactory(n.factory);break}}e.inputStabilization!==void 0&&this.tool.setHasStabilization(!!e.inputStabilization),e.strokeAutocorrect!==void 0&&this.tool.setStrokeAutocorrectEnabled(!!e.strokeAutocorrect);}};var ge=class{#e=null;constructor(){}setEmitListener(o){o&&typeof o=="object"?this.#e=e=>o.onEvent(e)??false:this.#e=o;}emit(o){return this.#e?.(o)??false}};function wa(){return new Promise(s=>{requestAnimationFrame(()=>s());})}var Ae=wa;var Pa={kind:0,mass:.4,springConstant:100,frictionCoefficient:.28,maxPointDist:10,inertiaFraction:.75,minSimilarityToFinalize:0,velocityDecayFactor:.1},br=class{constructor(o,e,i){this.updatePointer=e;this.options=i;this.strokePoint=o,this.targetPoint=o,this.targetInterval=10,this.loop();}runLoop=true;lastUpdateTime=0;targetInterval;velocity;strokePoint;targetPoint;async loop(){for(this.lastUpdateTime=performance.now();this.runLoop;)this.update(false),await Ae();}setTarget(o){this.targetPoint=o;}getNextVelocity(o){let e=this.targetPoint.minus(this.strokePoint),i=e.times(this.options.springConstant),n=this.options.mass*10,a=this.velocity.normalizedOrZero().times(-this.options.frictionCoefficient*n),l=i.plus(a).times(1/this.options.mass),c=this.options.velocityDecayFactor,d=this.velocity.times(1-c).plus(l.times(o/1e3));return e.normalizedOrZero().times(d.length()).lerp(d,this.options.inertiaFraction)}update(o){let e=performance.now(),i=e-this.lastUpdateTime,r=this.strokePoint.eq(this.targetPoint);if(i>this.targetInterval||o){if(!r){let n,a,l=1;do n=this.getNextVelocity(i/l),a=n.times(i/1e3),l++;while(a.magnitude()>this.options.maxPointDist&&l<10);for(let c=0;c<l;c++)this.velocity=this.getNextVelocity(i/l),a=this.velocity.times(i/1e3),this.strokePoint=this.strokePoint.plus(a),c<l-1&&this.updatePointer(this.strokePoint,e);}if(this.lastUpdateTime=e,o||!r)return this.updatePointer(this.strokePoint,e)}return  false}finish(){this.runLoop=false;let o=this.targetPoint.minus(this.strokePoint);this.velocity.dot(o)>this.options.minSimilarityToFinalize&&this.updatePointer(this.targetPoint,performance.now());}cancel(){this.runLoop=false;}},tt=class s extends ge{constructor(e,i=Pa){super();this.viewport=e;this.options=i;}stabilizer=null;lastPointerEvent=null;mapPointerEvent(e){return ro(e)&&e.kind!==2&&(this.lastPointerEvent=e),e.kind===3||e.allPointers.length>1||this.stabilizer===null?this.emit(e):(this.stabilizer.setTarget(e.current.screenPos),e.kind===1?this.stabilizer.update(true):e.kind===2?(this.stabilizer.finish(),this.emit(e)):this.emit(e))}emitPointerMove(e,i){if(!this.lastPointerEvent)return  false;let r=this.lastPointerEvent.current.withScreenPosition(e,this.viewport).withTimestamp(i),n={kind:1,current:r,allPointers:[r]};return this.emit(n)}onEvent(e){if(ro(e)||e.kind===3){e.kind===0&&(this.stabilizer===null?this.stabilizer=new br(e.current.screenPos,(r,n)=>this.emitPointerMove(r,n),this.options):e.allPointers.length>1&&(this.stabilizer.cancel(),this.stabilizer=null));let i=this.mapPointerEvent(e);return (e.kind===2||e.kind===3)&&(this.stabilizer?.cancel(),this.stabilizer=null),i}return this.emit(e)}static fromEditor(e){return new s(e.viewport)}};var xt="easydraw.tools.SelectionTool.selectAll";V.registerDefaultKeyboardShortcut(xt,["CtrlOrMeta+KeyA"],"Select all");var mi="easydraw.tools.SelectionTool.duplicateSelection";V.registerDefaultKeyboardShortcut(mi,["CtrlOrMeta+KeyD"],"Duplicate selection");var fi="easydraw.tools.SelectionTool.sendToBack";V.registerDefaultKeyboardShortcut(fi,["End"],"Send to back");var yr="easydraw.tools.SelectionTool.translateLeft";V.registerDefaultKeyboardShortcut(yr,["KeyA","KeyH","ArrowLeft"],"Move selection left");var vr="easydraw.tools.SelectionTool.translateRight";V.registerDefaultKeyboardShortcut(vr,["KeyD","KeyL","ArrowRight"],"Move selection right");var xr="easydraw.tools.SelectionTool.translateUp";V.registerDefaultKeyboardShortcut(xr,["KeyQ","KeyK","ArrowUp"],"Move selection up");var Sr="easydraw.tools.SelectionTool.translateDown";V.registerDefaultKeyboardShortcut(Sr,["KeyE","KeyJ","ArrowDown"],"Move selection down");var Cr="easydraw.tools.SelectionTool.rotateCCW";V.registerDefaultKeyboardShortcut(Cr,["Shift+KeyR"],"Rotate selection counter clockwise");var Tr="easydraw.tools.SelectionTool.rotateCW";V.registerDefaultKeyboardShortcut(Tr,["KeyR"],"Rotate selection clockwise");var wr="easydraw.tools.SelectionTool.shrink.x";V.registerDefaultKeyboardShortcut(wr,["KeyI"],"Decrease width");var Pr="easydraw.tools.SelectionTool.stretch.x";V.registerDefaultKeyboardShortcut(Pr,["Shift+KeyI"],"Increase width");var Er="easydraw.tools.SelectionTool.shrink.y";V.registerDefaultKeyboardShortcut(Er,["KeyO"],"Decrease height");var Ir="easydraw.tools.SelectionTool.stretch.y";V.registerDefaultKeyboardShortcut(Ir,["Shift+KeyO"],"Increase height");var kr="easydraw.tools.SelectionTool.shrink.xy";V.registerDefaultKeyboardShortcut(kr,["Comma"],"Decrease selection size");var Rr="easydraw.tools.SelectionTool.stretch.xy";V.registerDefaultKeyboardShortcut(Rr,["Period"],"Increase selection size");var ot="easydraw.tools.undo",Lr="easydraw.tools.redo";V.registerDefaultKeyboardShortcut(ot,["CtrlOrMeta+KeyZ"],"Undo");V.registerDefaultKeyboardShortcut(Lr,["CtrlOrMeta+Shift+KeyZ","CtrlOrMeta+KeyY"],"Redo");var it="easydraw.tools.increaseSize";V.registerDefaultKeyboardShortcut(it,["Equal","Shift+Equal"],"Increase pen/eraser size");var rt="easydraw.tools.decreaseSize";V.registerDefaultKeyboardShortcut(rt,["Minus","Shift+Minus"],"Decrease pen/eraser size");var St="easydraw.tools.snapToGrid";V.registerDefaultKeyboardShortcut(St,["Control","Meta"],"Snap to grid (press and hold)");var zr="easydraw.tools.lockToLine";V.registerDefaultKeyboardShortcut(zr,["Shift"],"Snap to XY axes (press and hold)");var gi="easydraw.tools.FindTool.toggleVisible";V.registerDefaultKeyboardShortcut(gi,["CtrlOrMeta+KeyF"],"Shows/hides the find tool");var Br="easydraw.tools.PanZoom.moveLeft";V.registerDefaultKeyboardShortcut(Br,["ArrowLeft","KeyH","KeyA"],"Pan left");var Ar="easydraw.tools.PanZoom.moveRight";V.registerDefaultKeyboardShortcut(Ar,["ArrowRight","KeyL","KeyD"],"Pan right");var Dr="easydraw.tools.PanZoom.moveUp";V.registerDefaultKeyboardShortcut(Dr,["ArrowUp","KeyK","KeyQ"],"Pan up");var Mr="easydraw.tools.PanZoom.moveDown";V.registerDefaultKeyboardShortcut(Mr,["ArrowDown","KeyJ","KeyE"],"Pan down");var Vr="easydraw.tools.PanZoom.rotateViewClockwise";V.registerDefaultKeyboardShortcut(Vr,["Shift+KeyR"],"Rotate viewport clockwise");var Fr="easydraw.tools.PanZoom.rotateViewCounterClockwise";V.registerDefaultKeyboardShortcut(Fr,["KeyR"],"Rotate viewport counter-clockwise");var Or="easydraw.tools.PanZoom.zoomIn";V.registerDefaultKeyboardShortcut(Or,["KeyW"],"Zoom in");var Hr="easydraw.tools.PanZoom.zoomOut";V.registerDefaultKeyboardShortcut(Hr,["KeyS"],"Zoom out");var Ct={maxSpeed:8.5,maxRadius:11,minTimeSeconds:.5},De=class{constructor(o,e,i){this.config=e;this.onStationary=i;this.stationaryStartPointer=o,this.lastPointer=o,this.averageVelocity=exports.Vec2.zero,this.setStationaryTimeout(this.config.minTimeSeconds*1e3);}stationaryStartPointer;lastPointer;averageVelocity;hasMovedOutOfRadius;timeout=null;onPointerMove(o){if(!this.stationaryStartPointer)return;if(o.id!==this.stationaryStartPointer.id)return  false;let e=o.screenPos.minus(this.lastPointer.screenPos),i=o.screenPos.minus(this.stationaryStartPointer.screenPos),r=(o.timeStamp-this.lastPointer.timeStamp)/1e3;r===0&&(r=1);let n=e.times(1/r);this.averageVelocity=this.averageVelocity.lerp(n,.5);let a=o.timeStamp-this.stationaryStartPointer.timeStamp,l=i.length()>this.config.maxRadius;if(this.hasMovedOutOfRadius||=l,l||this.averageVelocity.length()>this.config.maxSpeed||a<this.config.minTimeSeconds)return this.stationaryStartPointer=o,this.lastPointer=o,this.setStationaryTimeout(this.config.minTimeSeconds*1e3),false;let c=this.config.minTimeSeconds*1e3-a;return this.lastPointer=o,c<=0}onPointerUp(o){o.id!==this.stationaryStartPointer?.id&&this.cancelStationaryTimeout();}destroy(){this.cancelStationaryTimeout(),this.stationaryStartPointer=null;}getHasMovedOutOfRadius(){return this.hasMovedOutOfRadius}cancelStationaryTimeout(){this.timeout!==null&&(clearTimeout(this.timeout),this.timeout=null);}setStationaryTimeout(o){this.timeout===null&&(o<=0?this.onStationary(this.lastPointer):this.timeout=setTimeout(()=>{if(this.timeout=null,!this.stationaryStartPointer)return;let e=performance.now()-this.stationaryStartPointer.timeStamp,i=this.config.minTimeSeconds*1e3-e;i<=0?this.onStationary(this.lastPointer):this.setStationaryTimeout(i);},o));}};var bi=(a=>(a[a.Pen=0]="Pen",a[a.Eraser=1]="Eraser",a[a.Touch=2]="Touch",a[a.PrimaryButtonMouse=3]="PrimaryButtonMouse",a[a.RightButtonMouse=4]="RightButtonMouse",a[a.Other=5]="Other",a))(bi||{}),be=class s{constructor(o,e,i,r,n,a,l,c){this.screenPos=o;this.canvasPos=e;this.pressure=i;this.isPrimary=r;this.down=n;this.device=a;this.id=l;this.timeStamp=c;}snappedToGrid(o){let e=o.snapToGrid(this.canvasPos);return this.withCanvasPosition(e,o)}lockedToXYAxesScreen(o,e){let r=this.screenPos.minus(o),n=exports.Vec2.unitX.times(r.x),a=exports.Vec2.unitY.times(r.y),l;return r.dot(n)>r.dot(a)?l=n:l=a,l=l.plus(o),this.withScreenPosition(l,e)}withScreenPosition(o,e){let i=e.screenToCanvas(o);return this.withCanvasPosition(i,e)}withTimestamp(o){return new s(this.screenPos,this.canvasPos,this.pressure,this.isPrimary,this.down,this.device,this.id,o)}withCanvasPosition(o,e){let i=e.canvasToScreen(o);return new s(i,o,this.pressure,this.isPrimary,this.down,this.device,this.id,this.timeStamp)}static ofEvent(o,e,i,r){let n=exports.Vec2.of(o.clientX,o.clientY);if(r){let u=r.getBoundingClientRect();n=n.minus(exports.Vec2.of(u.left,u.top));}let l={mouse:3,pen:0,touch:2}[o.pointerType]??5;l===0&&(o.buttons&32)!==0&&(l=1);let d=o.timeStamp,p=i.roundPoint(i.screenToCanvas(n));return l===3&&o.buttons&2&&(l=4),new s(n,p,o.pressure??null,o.isPrimary,e,l,o.pointerId,d)}static ofCanvasPoint(o,e,i,r=0,n=0,a=true,l=null,c=null){let d=i.canvasToScreen(o);return c??=performance.now(),new s(d,o,l,a,e,n,r,c)}static ofScreenPoint(o,e,i,r=0,n=0,a=true,l=null,c=null){let d=i.screenToCanvas(o);return c??=performance.now(),new s(o,d,l,a,e,n,r,c)}};var nt=class extends H{constructor(e,i,r){super(e.notifier,i);this.editor=e;this.styleValue=N.fromInitialValue({factory:fe,color:P.black,borderColor:P.black,thickness:0,...r}),this.styleValue.onUpdateAndNow(n=>{this.style=n,this.noteUpdated();});}builder=null;lastPoint=null;startPoint=null;currentDeviceType=null;currentPointerId=null;styleValue;style;shapeAutocompletionEnabled=false;autocorrectedShape=null;lastAutocorrectedShape=null;removedAutocorrectedShapeTime=0;stationaryDetector=null;getPressureMultiplier(){let e=this.style.thickness;return 1/this.editor.viewport.getScaleFactor()*e}toStrokePoint(e){let r=Math.max(e.pressure??1,.3);return isFinite(r)||(console.warn("Non-finite pressure!",e),r=.3),console.assert(isFinite(e.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(e.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(e.timeStamp),"Non-finite timeStamp on pointer!"),{pos:e.canvasPos,width:r*this.getPressureMultiplier(),color:this.style.color,borderColor:this.style.borderColor,time:e.timeStamp}}previewStroke(){this.editor.clearWetInk();let e=this.editor.display.getWetInkRenderer();if(this.autocorrectedShape){let i=this.editor.viewport.visibleRect;this.autocorrectedShape.render(e,i);}else this.builder?.preview(e);}addPointToStroke(e){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(e),this.lastPoint=e,this.previewStroke();}onPointerDown(e){if(this.builder&&!this.eventCanCancelStroke(e))return  true;let{current:i,allPointers:r}=e,n=i.device===1,a=i.device===0;return r.length===1&&!n||a?(this.startPoint=this.toStrokePoint(i),this.builder=this.style.factory(this.startPoint,this.editor.viewport),this.currentDeviceType=i.device,this.currentPointerId=i.id,this.shapeAutocompletionEnabled?this.stationaryDetector=new De(i,Ct,l=>this.autocorrectShape(l)):this.stationaryDetector=null,this.lastAutocorrectedShape=null,this.removedAutocorrectedShapeTime=0,true):false}eventCanCancelStroke(e){let i=this.lastPoint?.time??0;if(e.current.timeStamp-i>1e3)return  true;let r=this.currentDeviceType===0,n=e.current.device===2;return !(r&&n)}eventCanBeDeliveredToNonActiveTool(e){return this.eventCanCancelStroke(e)}onPointerMove({current:e}){if(!this.builder||e.device!==this.currentDeviceType||e.id!==this.currentPointerId)return;this.stationaryDetector?.onPointerMove(e)||(this.addPointToStroke(this.toStrokePoint(e)),this.autocorrectedShape&&(this.removedAutocorrectedShapeTime=performance.now(),this.autocorrectedShape=null,this.editor.announceForAccessibility(this.editor.localization.autocorrectionCanceled)));}onPointerUp({current:e}){if(!this.builder)return  false;if(e.id!==this.currentPointerId)return  true;this.stationaryDetector?.onPointerUp(e);let i=this.toStrokePoint(e),r={...i,width:this.lastPoint?.width??i.width};return this.addPointToStroke(r),this.finalizeStroke(),false}onGestureCancel(){this.builder=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}removedAutocorrectedShapeRecently(){return this.removedAutocorrectedShapeTime>performance.now()-320}async autocorrectShape(e){if(!this.builder||!this.builder.autocorrectShape||!this.shapeAutocompletionEnabled||this.autocorrectedShape)return;let i=await this.builder.autocorrectShape();if(!this.builder||!i)return;let r=i.getBBox().area;if(r===0||!isFinite(r))return;let n=i.description(this.editor.localization);this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(n)),this.autocorrectedShape=i,this.lastAutocorrectedShape=i,this.previewStroke();}finalizeStroke(){if(this.builder){this.lastAutocorrectedShape&&this.removedAutocorrectedShapeRecently()&&(this.autocorrectedShape=this.lastAutocorrectedShape);let e=this.autocorrectedShape??this.builder.build();if(this.previewStroke(),e.getBBox().area>0){e===this.autocorrectedShape&&this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(e.description(this.editor.localization)));let r=K.addComponent(e,true);this.editor.dispatch(r);}else console.warn("Pen: Not adding empty stroke",e,"to the canvas.");}this.builder=null,this.lastPoint=null,this.autocorrectedShape=null,this.lastAutocorrectedShape=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}noteUpdated(){this.editor.notifier.dispatch(2,{kind:2,tool:this});}setColor(e){e.toHexString()!==this.style.color.toHexString()&&this.styleValue.set({...this.style,color:e});}setBorderColor(e){e.toHexString()!==this.style.borderColor.toHexString()&&this.styleValue.set({...this.style,borderColor:e});}setThickness(e){e!==this.style.thickness&&this.styleValue.set({...this.style,thickness:e});}setStrokeFactory(e){e!==this.style.factory&&this.styleValue.set({...this.style,factory:e});}setHasStabilization(e){let i=!!this.getInputMapper();e!==i&&(i?this.setInputMapper(null):this.setInputMapper(new tt(this.editor.viewport)),this.noteUpdated());}setStrokeAutocorrectEnabled(e){e!==this.shapeAutocompletionEnabled&&(this.shapeAutocompletionEnabled=e,this.noteUpdated());}getStrokeAutocorrectionEnabled(){return this.shapeAutocompletionEnabled}getThickness(){return this.style.thickness}getColor(){return this.style.color}getBorderColor(){return this.style.borderColor}getStrokeFactory(){return this.style.factory}getStyleValue(){return this.styleValue}onKeyPress(e){let i=this.editor.shortcuts,r=i.matchesShortcut(ot,e);if(this.builder&&r)return this.finalizeStroke(),false;let n;return i.matchesShortcut(rt,e)?n=this.getThickness()*2/3:i.matchesShortcut(it,e)&&(n=this.getThickness()*3/2),n!==void 0?(n=Math.min(Math.max(1,n),256),this.setThickness(n),true):false}};var Ie=class extends Q{constructor(e,i,r,n,a,l,c=false,d=true){super(e,i,l);this.makeIcon=r;this.title=n;this.clickAction=a;this.mustBeToplevel=c;this.#e=d;}#e;#t=void 0;setHelpText(e){this.#t=e;}getHelpText(){return this.#t}shouldAutoDisableInReadOnlyEditor(){return this.#e}handleClick(){this.clickAction();}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return  false}mustBeInToplevelMenu(){return this.mustBeToplevel}};var yi=(s,o)=>{if(o.length===0)return null;let e=o[0].description(s);for(let i of o)if(i.description(s)!==e)return null;return e};var _=class s extends O{toRemove;applied;constructor(o){super("erase"),this.toRemove=o.map(e=>e),this.applied=false;}apply(o){for(let e of this.toRemove){let i=o.image.findParent(e);i&&(i.remove(),o.image.onDestroyElement(e));}this.applied=true,o.queueRerender();}unapply(o){for(let e of this.toRemove)o.image.findParent(e)||K.addComponent(e).apply(o);this.applied=false,o.queueRerender();}onDrop(o){if(this.applied)for(let e of this.toRemove)o.image.onDestroyElement(e);}description(o,e){if(this.toRemove.length===0)return e.erasedNoElements;let i=yi(e,this.toRemove)??e.elements;return e.eraseAction(i,this.toRemove.length)}serializeToJSON(){return this.toRemove.map(e=>e.serialize())}static{O.register("erase",(o,e)=>{if(!Array.isArray(o))throw new TypeError("seralized erase data must be an array");let i=o.map(r=>{let n=typeof r=="string"?r:`${r.id}`;return e.image.lookupElement(n)??G.deserialize(r)});return new s(i)});}};function Ea(s){if(s.some(o=>o&&o.then))return Promise.all(s).then(()=>{})}var Nr=Ea;var vi=class extends we{constructor(e,i,r){super();this.commands=e;this.applyChunkSize=i;this.descriptionOverride=r;}apply(e){if(this.applyChunkSize===void 0){let i=this.commands.map(r=>r.apply(e));return Nr(i)}else return e.asyncApplyCommands(this.commands,this.applyChunkSize)}unapply(e){let i=[...this.commands];if(i.reverse(),this.applyChunkSize===void 0){let r=i.map(n=>n.unapply(e));return Nr(r)}else return e.asyncUnapplyCommands(i,this.applyChunkSize,false)}onDrop(e){this.commands.forEach(i=>i.onDrop(e));}description(e,i){if(this.descriptionOverride)return this.descriptionOverride;let r=[],n=null,a=0,l=0;for(let c of this.commands){let d=c.description(e,i);if(d!==n&&n!==null&&(r.push(i.unionOf(n,a)),n=null,a=0),a++,l++,n??=d,r.length>12)break}return a>1?r.push(i.unionOf(n,a)):a===1&&r.push(n),l<this.commands.length&&r.push(i.andNMoreCommands(this.commands.length-l)),r.join(", ")}},Ur=class extends O{constructor(e,i,r){super("union");this.commands=e;this.applyChunkSize=i;this.descriptionOverride=r;this.nonserializableCommand=new vi(e,i,r);}nonserializableCommand;serializedData;serializeToJSON(){return this.serializedData?this.serializedData:{applyChunkSize:this.applyChunkSize,data:this.commands.map(e=>e.serialize()),description:this.descriptionOverride}}apply(e){return this.serializedData=this.serializeToJSON(),this.nonserializableCommand.apply(e)}unapply(e){return this.nonserializableCommand.unapply(e)}onDrop(e){this.nonserializableCommand.onDrop(e);}description(e,i){return this.nonserializableCommand.description(e,i)}};function rs(s,o){let e=true;for(let n of s)if(!(n instanceof O)){e=false;break}let i,r;if(typeof o=="number"?i=o:(i=o?.applyChunkSize,r=o?.description),e){let n=s;return new Ur(n,i,r)}else return new vi(s,i,r)}O.register("union",(s,o)=>{if(typeof s.data.length!="number")throw new TypeError("Unions of commands must serialize to lists of serialization data.");let e=s.applyChunkSize;if(typeof e!="number"&&e!==void 0)throw new Error("serialized applyChunkSize is neither undefined nor a number.");let i=typeof s.description=="string"?s.description:void 0,r=[];for(let n of s.data)r.push(O.deserialize(n,o));return rs(r,{applyChunkSize:e,description:i})});var J=rs;var fo=(r=>(r[r.SolidColor=0]="SolidColor",r[r.Grid=1]="Grid",r[r.None=2]="None",r[r.Dot=3]="Dot",r))(fo||{}),Tt="easydrawer-image-background",xi="easydrawer-image-background-grid-",Wr="easydrawer-image-background-non-automatic-secondary-color",$r={1:"easydrawer-image-background-grid",3:"easydrawer-image-background-dot",0:Tt,2:""},ee=class s extends G{constructor(e,i){super("image-background",0);this.backgroundType=e;this.mainColor=i;this.contentBBox=I.empty;}contentBBox;viewportSizeChangeListener=null;autoresizeChangedListener=null;fillsScreen=false;gridSize=A.getGridSize(2);gridStrokeWidth=.7;secondaryColor=null;isRestylableComponent=true;static ofGrid(e,i,r,n){let a=new s(1,e);return i!==void 0&&(a.gridSize=i),r!==void 0&&(a.secondaryColor=r),n!==void 0&&(a.gridStrokeWidth=n),a}getBackgroundType(){return this.backgroundType}getMainColor(){return this.mainColor}getSecondaryColor(){return this.secondaryColor}getGridSize(){return this.gridSize}getStyle(){let e=this.mainColor;return this.backgroundType===2&&(e=void 0),{color:e}}updateStyle(e){return Je(this.getStyle(),e,this)}forceStyle(e,i){let r=e.color;r&&(this.mainColor=r,r.eq(P.transparent)&&this.backgroundType===0?this.backgroundType=2:this.backgroundType===2&&(this.backgroundType=0),i&&(i.image.queueRerenderOf(this),i.queueRerender()));}onAddToImage(e){this.viewportSizeChangeListener&&(console.warn("onAddToImage called when background is already in an image"),this.onRemoveFromImage()),this.viewportSizeChangeListener=e.notifier.on(0,()=>{this.recomputeBBox(e);}),this.autoresizeChangedListener=e.notifier.on(1,()=>{this.recomputeBBox(e);}),this.recomputeBBox(e);}onRemoveFromImage(){this.viewportSizeChangeListener?.remove(),this.autoresizeChangedListener?.remove(),this.viewportSizeChangeListener=null,this.autoresizeChangedListener=null;}recomputeBBox(e){let i=e.getImportExportViewport().visibleRect,r=false;this.contentBBox.eq(i)||(this.contentBBox=i,r||=!this.fillsScreen);let n=e.getAutoresizeEnabled();n!==this.fillsScreen&&(this.fillsScreen=n,r=true),r&&e.queueRerenderOf(this);}generateGridPath(e){let i=this.getFullBoundingBox(e),r=(e?.intersection(i)??i).grownBy(this.gridStrokeWidth/2),n=v=>Math.floor(v/this.gridSize)*this.gridSize,a=v=>Math.ceil(v/this.gridSize)*this.gridSize,l=a(r.y),c=n(r.y+r.h),d=a(r.x),p=n(r.x+r.w),u=[],h=(c-l)/this.gridSize,m=(p-d)/this.gridSize;if(h>1e3||m>1e3)return B.empty;let y=exports.Vec2.of(r.x,l);for(let v=l;v<=c;v+=this.gridSize)u.push({kind:1,point:exports.Vec2.of(r.x,v)}),u.push({kind:0,point:exports.Vec2.of(r.x+r.w,v)});for(let v=d;v<=p;v+=this.gridSize)u.push({kind:1,point:exports.Vec2.of(v,r.y)}),u.push({kind:0,point:exports.Vec2.of(v,r.y+r.h)});return new B(y,u)}generateDotPath(e){let i=this.getFullBoundingBox(e),r=(e?.intersection(i)??i).grownBy(this.gridStrokeWidth/2),n=v=>Math.floor(v/this.gridSize)*this.gridSize,a=v=>Math.ceil(v/this.gridSize)*this.gridSize,l=a(r.y),c=n(r.y+r.h),d=a(r.x),p=n(r.x+r.w),u=[],h=(c-l)/this.gridSize,m=(p-d)/this.gridSize;if(h>1e3||m>1e3)return B.empty;let y=exports.Vec2.of(r.x,l);for(let v=l;v<=c;v+=this.gridSize)for(let b=d;b<=p;b+=this.gridSize){exports.Vec2.of(b,v);let T=this.gridStrokeWidth;u.push({kind:1,point:exports.Vec2.of(b+T,v)}),u.push({kind:3,controlPoint:exports.Vec2.of(b+T,v-T*.55),endPoint:exports.Vec2.of(b,v-T)}),u.push({kind:3,controlPoint:exports.Vec2.of(b-T*.55,v-T),endPoint:exports.Vec2.of(b-T,v)}),u.push({kind:3,controlPoint:exports.Vec2.of(b-T,v+T*.55),endPoint:exports.Vec2.of(b,v+T)}),u.push({kind:3,controlPoint:exports.Vec2.of(b+T*.55,v+T),endPoint:exports.Vec2.of(b+T,v)});}return new B(y,u)}getFullBoundingBox(e){return (this.fillsScreen?e:this.contentBBox)??this.contentBBox}render(e,i){if(this.backgroundType===2)return;let r=!i;this.fillsScreen&&(i??=e.getVisibleRect());let n=this.backgroundType===1,a=this.getFullBoundingBox(i);if(e.startObject(a,n),this.backgroundType===0||this.backgroundType===1){let d=i?.intersection(a);d?e.fillRect(d,this.mainColor):r&&e.fillRect(a,this.mainColor);}if(this.backgroundType===1){let d=this.secondaryColor;d??=P.ofRGBA(1-this.mainColor.r,1-this.mainColor.g,1-this.mainColor.b,.2),this.mainColor.a===0&&(d=P.ofRGBA(.5,.5,.5,.2));let p={fill:P.transparent,stroke:{width:this.gridStrokeWidth,color:d}};e.drawPath(M(this.generateGridPath(i),p));}if(this.backgroundType===3){let d=this.secondaryColor;d??=P.ofRGBA(1-this.mainColor.r,1-this.mainColor.g,1-this.mainColor.b,.2),this.mainColor.a===0&&(d=P.fromHex("#cccccc"));let p={fill:d,stroke:{width:this.gridStrokeWidth,color:d}};e.drawPath(M(this.generateDotPath(i),p));}let l=$r[this.backgroundType],c=[Tt];if(l!==Tt){c.push(l);let d=ie(this.gridSize).replace(/\./g,"p");c.push(xi+d);}this.secondaryColor!==null&&c.push(Wr),e.endObject(this.getLoadSaveData(),c);}intersects(e){return this.contentBBox.getEdges().some(i=>i.intersects(e))}isSelectable(){return  false}isBackground(){return  true}getSizingMode(){return this.fillsScreen?1:0}serializeToJSON(){return {mainColor:this.mainColor.toHexString(),secondaryColor:this.secondaryColor?.toHexString(),backgroundType:this.backgroundType,gridSize:this.gridSize,gridStrokeWidth:this.gridStrokeWidth}}applyTransformation(e){}description(e){return this.backgroundType===0?e.filledBackgroundWithColor(this.mainColor.toString()):this.backgroundType===2?e.emptyBackground:this.backgroundType===1?e.gridBackground:this.backgroundType===3?e.dotBackground:this.backgroundType}createClone(){return new s(this.backgroundType,this.mainColor)}static deserializeFromJSON(e){if(typeof e=="string"&&(e=JSON.parse(e)),typeof e.mainColor!="string")throw new TypeError("Error deserializing \u2014 mainColor must be of type string.");let i,r=e.backgroundType;if(r===2||r===1||r===3||r===0)i=r;else return r;let n=P.fromHex(e.mainColor),a=e.secondaryColor?P.fromHex(e.secondaryColor):null,l=e.gridSize??void 0,c=e.gridStrokeWidth??void 0,d=new s(i,n);return d.secondaryColor=a,l&&(d.gridSize=l),c&&(d.gridStrokeWidth=c),d}};G.registerComponent("image-background",ee.deserializeFromJSON);var wt=class s extends Q{updateDropdownContent=()=>{};constructor(o,e){super(o,"document-properties-widget",e),this.container.classList.add("dropdownShowable"),this.editor.notifier.on(3,()=>{this.queueDropdownUpdate();}),this.editor.image.notifier.on(0,()=>{this.queueDropdownUpdate();});}getTitle(){return this.localizationTable.documentProperties}createIcon(){return this.editor.icons.makeConfigureDocumentIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible()),this.queueDropdownUpdate();}dropdownUpdateQueued=false;queueDropdownUpdate(){this.dropdownUpdateQueued||(requestAnimationFrame(()=>this.updateDropdown()),this.dropdownUpdateQueued=true);}updateDropdown(){this.dropdownUpdateQueued=false,this.isDropdownVisible()&&this.updateDropdownContent();}setBackgroundColor(o){this.editor.dispatch(this.editor.setBackgroundColor(o));}getBackgroundColor(){return this.editor.estimateBackgroundColor()}removeBackgroundComponents(){let o=[];for(let e of this.editor.image.getBackgroundComponents())e instanceof ee&&o.push(e);return new _(o)}setBackgroundType(o){let e=this.editor.estimateBackgroundColor(),i=new ee(o,e),r=this.editor.image.addComponent(i);return J([this.removeBackgroundComponents(),r])}getBackgroundType(){let o=this.editor.image.getBackgroundComponents();for(let e=o.length-1;e>=0;e--){let i=o[e];if(i instanceof ee)return i.getBackgroundType()}return 2}updateImportExportRectSize(o){let e=l=>(l!==void 0&&(!isFinite(l)||l<=0)&&(l=100),l),i=e(o.width),r=e(o.height),n=this.editor.getImportExportRect(),a=new I(n.x,n.y,i??n.w,r??n.h);this.editor.dispatch(this.editor.image.setImportExportRect(a)),this.editor.queueRerender();}getHelpText(){return this.localizationTable.pageDropdown__baseHelpText}setBackgroundGrid(){this.editor.dispatch(this.setBackgroundType(1)),this.editor.dispatch(this.editor.image.setAutoresizeEnabled(true));}setBackgroundDot(){this.editor.dispatch(this.setBackgroundType(3));}updateBackgroundColor(o){this.editor.dispatch(this.editor.setBackgroundColor(o));}setBackgroundSolid(){this.editor.dispatch(this.setBackgroundType(0)),this.editor.dispatch(this.editor.image.setAutoresizeEnabled(true));}removeBackground(){this.editor.dispatch(this.setBackgroundType(2));}static idCounter=0;fillDropdown(o,e){let i=document.createElement("div");i.classList.add(`${L}spacedList`,`${L}nonbutton-controls-main-list`,`${L}document-properties-widget`);let r=()=>{let v=document.createElement("div"),b=document.createElement("label");b.innerText=this.localizationTable.backgroundColor;let{input:S,container:T,setValue:C,registerWithHelpTextDisplay:R}=Ee(this.editor,D=>{D.eq(this.getBackgroundColor())||this.setBackgroundColor(D);});return S.id=`${L}docPropertiesColorInput-${s.idCounter++}`,b.htmlFor=S.id,v.replaceChildren(b,T),{setBgColorInputValue:C,backgroundColorRow:v,registerWithHelp:D=>{D&&(D?.registerTextHelpForElement(v,this.localizationTable.pageDropdown__backgroundColorHelpText),R(D));}}},{backgroundColorRow:n,setBgColorInputValue:a,registerWithHelp:l}=r(),c=(v,b)=>{let S=document.createElement("div"),T=document.createElement("label"),C=document.createElement("input");return C.id=`${L}docPropertiesCheckbox-${s.idCounter++}`,T.htmlFor=C.id,C.type="checkbox",T.innerText=v,C.addEventListener("input",()=>{b(C.checked);}),S.replaceChildren(T,C),{container:S,checkbox:C}},{container:d,checkbox:p}=c(this.localizationTable.useGridOption,v=>{if(this.getBackgroundType()===1===v)return;let T=0;v&&(T=1),this.editor.dispatch(this.setBackgroundType(T));}),u=(v,b)=>{let S=document.createElement("div"),T=document.createElement("label"),C=document.createElement("input");return T.innerText=v,C.type="number",C.min="0",C.id=`${L}docPropertiesDimensionRow-${s.idCounter++}`,T.htmlFor=C.id,C.style.flexGrow="2",C.style.width="25px",C.addEventListener("input",()=>{b(Number.parseFloat(C.value));}),S.classList.add("easydrawer-size-input-row"),S.replaceChildren(T,C),{setValue:R=>{if(document.activeElement===C&&/^0*$/.test(C.value)){let k=C.value;C.type="text",C.value=R.toString();let D=Math.max(1,C.value.length-k.length);C.setSelectionRange(0,D),C.type="number";}else C.value=R.toString();},setIsAutomaticSize:R=>{C.disabled=R;let k="size-input-row--automatic-size";R?S.classList.add(k):S.classList.remove(k);},element:S}},h=u(this.localizationTable.imageWidthOption,v=>{this.updateImportExportRectSize({width:v});}),m=u(this.localizationTable.imageHeightOption,v=>{this.updateImportExportRectSize({height:v});}),{container:f,checkbox:g}=c(this.localizationTable.enableAutoresizeOption,v=>{let b=this.editor.image;this.editor.dispatch(b.setAutoresizeEnabled(v));}),y=document.createElement("button");return y.classList.add("about-button"),y.innerText=this.localizationTable.about,y.addEventListener("click",()=>{this.editor.showAboutDialog();}),l(e),e?.registerTextHelpForElement(d,this.localizationTable.pageDropdown__gridCheckboxHelpText),e?.registerTextHelpForElement(f,this.localizationTable.pageDropdown__autoresizeCheckboxHelpText),e?.registerTextHelpForElement(y,this.localizationTable.pageDropdown__aboutButtonHelpText),this.updateDropdownContent=()=>{a(this.getBackgroundColor());let v=this.editor.image.getAutoresizeEnabled(),b=this.editor.getImportExportRect();h.setValue(b.width),m.setValue(b.height),g.checked=v,h.setIsAutomaticSize(v),m.setIsAutomaticSize(v),p.checked=this.getBackgroundType()===1;},this.updateDropdownContent(),i.replaceChildren(n,d,h.element,m.element,f,y),o.replaceChildren(i),true}};var Si=(e=>(e.PartialStroke="partial-stroke",e.FullStroke="full-stroke",e))(Si||{}),Kr=class extends H{constructor(e,i){super(e.notifier,e.localization.changeTool);this.editor=e;this.eraser=i;}previousEnabledTool;previousEraserEnabledState;onPointerDown(e){if(e.allPointers.length===1&&e.current.device===1){let r=this.editor.toolController.getPrimaryTools().filter(n=>n.isEnabled());if(r.length>0?this.previousEnabledTool=r[0]:this.previousEnabledTool=null,this.previousEraserEnabledState=this.eraser.isEnabled(),this.eraser.setEnabled(true),this.eraser.onPointerDown(e))return  true;this.restoreOriginalTool();}return  false}onPointerMove(e){this.eraser.onPointerMove(e);}restoreOriginalTool(){this.eraser.setEnabled(this.previousEraserEnabledState),this.previousEnabledTool&&this.previousEnabledTool.setEnabled(true);}onPointerUp(e){this.eraser.onPointerUp(e),this.restoreOriginalTool();}onGestureCancel(e){this.eraser.onGestureCancel(e),this.restoreOriginalTool();}},Ke=class extends H{constructor(e,i,r){super(e.notifier,i);this.editor=e;this.thickness=r?.thickness??10,this.thicknessValue=N.fromInitialValue(this.thickness),this.thicknessValue.onUpdate(n=>{this.thickness=n,this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.modeValue=N.fromInitialValue(r?.mode??"full-stroke"),this.modeValue.onUpdate(n=>{this.editor.notifier.dispatch(2,{kind:2,tool:this});});}lastPoint=null;isFirstEraseEvt=true;thickness;thicknessValue;modeValue;toRemove;toAdd=new Set;eraseCommands=[];addCommands=[];makeEraserSwitcherTool(){return new Kr(this.editor,this)}clearPreview(){this.editor.clearWetInk();}getSizeOnCanvas(){return this.thickness/this.editor.viewport.getScaleFactor()}drawPreviewAt(e){this.clearPreview();let i=this.getSizeOnCanvas(),r=this.editor.display.getWetInkRenderer(),n=this.getEraserRect(e),a=this.getEraserRect(this.lastPoint??e),l={fill:P.gray,stroke:{width:i/10,color:P.blue}};r.drawPath(M(B.fromConvexHullOf([...n.corners,...a.corners]),l));}getEraserRect(e){let i=this.getSizeOnCanvas(),r=exports.Vec2.of(i/2,i/2);return I.fromCorners(e.minus(r),e.plus(r))}eraseTo(e){if(!this.isFirstEraseEvt&&e.distanceTo(this.lastPoint)===0)return;this.isFirstEraseEvt=false;let i=this.getEraserRect(e),r=new oe(this.lastPoint,e),n=I.union(r.bbox,i),l=this.editor.image.getComponentsIntersecting(n).filter(c=>c.intersects(r)||c.intersectsRect(i)).filter(c=>c.isSelectable());if(this.modeValue.get()==="full-stroke"){this.toRemove.push(...l);let c=l.map(d=>new _([d]));c.forEach(d=>d.apply(this.editor)),this.eraseCommands.push(...c);}else {let c=[],d=[];for(let m of l){if(c.push(m),!m.withRegionErased||i.grownBy(i.maxDimension/3).containsRect(m.getExactBBox()))continue;let g=B.fromConvexHullOf([...i.corners,...this.getEraserRect(this.lastPoint??e).corners].map(y=>this.editor.viewport.roundPoint(y)));d.push(...m.withRegionErased(g,this.editor.viewport));}let p=new _(c),u=d.map(m=>K.addComponent(m));p.apply(this.editor),u.forEach(m=>m.apply(this.editor));let h=[];for(let m of c)this.toAdd.has(m)?this.toAdd.delete(m):h.push(m);this.toRemove.push(...h);for(let m of d)this.toAdd.add(m);this.eraseCommands.push(new _(h)),this.addCommands.push(...u);}this.drawPreviewAt(e),this.lastPoint=e;}onPointerDown(e){return e.allPointers.length===1||e.current.device===1?(this.lastPoint=e.current.canvasPos,this.toRemove=[],this.toAdd.clear(),this.isFirstEraseEvt=true,this.drawPreviewAt(e.current.canvasPos),true):false}onPointerMove(e){let i=e.current.canvasPos;this.eraseTo(i);}onPointerUp(e){this.eraseTo(e.current.canvasPos);let i=[];if(this.addCommands.length>0){this.addCommands.forEach(r=>r.unapply(this.editor));for(let r of this.toAdd)this.toRemove.includes(r)&&(this.toAdd.delete(r),this.toRemove=this.toRemove.filter(n=>n!==r));for(let r of this.toRemove)this.toAdd.has(r)&&(this.toAdd.delete(r),this.toRemove=this.toRemove.filter(n=>n!==r));i.push(...[...this.toAdd].map(r=>K.addComponent(r))),this.addCommands=[];}if(this.eraseCommands.length>0){this.eraseCommands.forEach(n=>n.unapply(this.editor)),this.eraseCommands=[];let r=new _(this.toRemove);i.push(r);}i.length===1?this.editor.dispatch(i[0]):this.editor.dispatch(J(i)),this.clearPreview();}onGestureCancel(e){this.addCommands.forEach(i=>i.unapply(this.editor)),this.eraseCommands.forEach(i=>i.unapply(this.editor)),this.eraseCommands=[],this.addCommands=[],this.clearPreview();}onKeyPress(e){let i=this.editor.shortcuts,r;return i.matchesShortcut(rt,e)?r=this.getThickness()*2/3:i.matchesShortcut(it,e)&&(r=this.getThickness()*3/2),r!==void 0?(r=Math.min(Math.max(1,r),200),this.setThickness(r),true):false}getThickness(){return this.thickness}setThickness(e){this.thicknessValue.set(e);}getThicknessValue(){return this.thicknessValue}getModeValue(){return this.modeValue}};var Pt=class s extends re{constructor(e,i,r){super(e,i,"eraser-tool-widget",r);this.tool=i;this.editor.notifier.on(2,n=>{n.kind===2&&n.tool===this.tool&&(this.updateInputs(),this.updateIcon());});}updateInputs=()=>{};getHelpText(){return this.localizationTable.eraserDropdown__baseHelpText}getTitle(){return this.localizationTable.eraser}makeIconForType(e){return this.editor.icons.makeEraserIcon(this.tool.getThickness(),e)}createIcon(){return this.makeIconForType(this.tool.getModeValue().get())}static idCounter=0;makeEraserTypeSelector(e){let i=document.createElement("div"),r=document.createElement("label"),n=document.createElement("input");n.id=`${L}eraserToolWidget-${s.idCounter++}`,r.htmlFor=n.id,r.innerText=this.localizationTable.fullStrokeEraser,n.type="checkbox",n.addEventListener("input",()=>{this.tool.getModeValue().set(n.checked?"full-stroke":"partial-stroke");});let a=()=>{n.checked=this.tool.getModeValue().get()==="full-stroke";};return i.replaceChildren(r,n),e?.registerTextHelpForElement(i,this.localizationTable.eraserDropdown__fullStrokeEraserHelpText),{addTo:l=>{l.appendChild(i);},updateValue:a}}fillDropdown(e,i){let r=document.createElement("div");r.classList.add(`${L}spacedList`,`${L}nonbutton-controls-main-list`);let n=bt(this.editor,l=>{this.tool.setThickness(l);});n.setBounds(10,55),i?.registerTextHelpForElement(n.container,this.localizationTable.eraserDropdown__thicknessHelpText);let a=this.makeEraserTypeSelector(i);return this.updateInputs=()=>{n.setValue(this.tool.getThickness()),a.updateValue();},this.updateInputs(),r.replaceChildren(n.container),a.addTo(r),e.replaceChildren(r),true}serializeState(){return {...super.serializeState(),thickness:this.tool.getThickness(),mode:this.tool.getModeValue().get()}}deserializeFrom(e){if(super.deserializeFrom(e),e.thickness){let i=Number.parseFloat(e.thickness);if(typeof i!="number"||!isFinite(i))throw new TypeError(`Deserializing property ${i} is not a number or is not finite.`);this.tool.setThickness(i);}if(e.mode){let i=e.mode;Object.values(Si).includes(i)&&this.tool.getModeValue().set(i);}}};var Gr=class extends Ie{constructor(o,e,i,r={}){super(o,"exit-button",()=>r.icon??o.icons.makeCloseIcon(),r.label??e.exit,i),this.setTags(["exit"]);}shouldAutoDisableInReadOnlyEditor(){return  false}onKeyPress(o){return this.editor.shortcuts.matchesShortcut(mr,o)?(this.clickAction(),true):super.onKeyPress(o)}mustBeInToplevelMenu(){return  true}},ns=Gr;function Ia(s=""){let o=document.createElement("div");return o.classList.add("tool-dropdown-separator"),o.innerText=s,{addTo:e=>{e.appendChild(o);}}}var go=Ia;var Ci=(a=>(a[a.OneFingerTouchGestures=1]="OneFingerTouchGestures",a[a.TwoFingerTouchGestures=2]="TwoFingerTouchGestures",a[a.RightClickDrags=4]="RightClickDrags",a[a.SinglePointerGestures=8]="SinglePointerGestures",a[a.Keyboard=16]="Keyboard",a[a.RotationLocked=32]="RotationLocked",a))(Ci||{}),_r=class{constructor(o,e,i){this.initialVelocity=o;this.scrollBy=e;this.onComplete=i;this.start();}running=false;currentVelocity;async start(){if(this.running)return;this.currentVelocity=this.initialVelocity;let o=performance.now();this.running=true;let e=5e3,i=200;for(this.currentVelocity.magnitude()>e&&(this.currentVelocity=this.currentVelocity.normalized().times(e));this.running&&this.currentVelocity.magnitude()>i;){let r=performance.now(),n=(r-o)/1e3;this.currentVelocity=this.currentVelocity.times(Math.pow(1/8,n)),this.scrollBy(this.currentVelocity.times(n)),await Ae(),o=r;}this.running&&this.stop();}getCurrentVelocity(){return this.running?this.currentVelocity:null}stop(){this.running&&(this.running=false,this.onComplete());}},he=class extends H{constructor(e,i,r){super(e.notifier,r);this.editor=e;this.mode=i;}transform=null;initialRotationSnapAngle=.22;afterRotationStartSnapAngle=.07;pinchZoomStartThreshold=1.08;startTouchDist;lastTouchDist;lastScreenCenter;lastTimestamp;lastPointerDownTimestamp=0;initialTouchAngle=0;initialViewportRotation=0;initialViewportScale=0;isScaling=false;isRotating=false;inertialScroller=null;velocity=null;canReceiveInputInReadOnlyEditor(){return  true}computePinchData(e,i){if(e.id<i.id){let d=e;e=i,i=d;}let r=i.screenPos.minus(e.screenPos),n=r.angle(),a=r.magnitude(),l=i.canvasPos.plus(e.canvasPos).times(.5),c=i.screenPos.plus(e.screenPos).times(.5);return {canvasCenter:l,screenCenter:c,angle:n,dist:a}}allPointersAreOfType(e,i){return e.every(r=>r.device===i)}onPointerDown({allPointers:e,current:i}){let r=false,n=this.inertialScroller?.getCurrentVelocity()??exports.Vec2.zero;this.inertialScroller?.stop(),this.velocity=n,this.lastPointerDownTimestamp=i.timeStamp;let a=this.allPointersAreOfType(e,2),l=this.allPointersAreOfType(e,4);if(a&&e.length===2&&this.mode&2){let{screenCenter:c,angle:d,dist:p}=this.computePinchData(e[0],e[1]);this.lastTouchDist=p,this.startTouchDist=p,this.lastScreenCenter=c,this.initialTouchAngle=d,this.initialViewportRotation=this.editor.viewport.getRotationAngle(),this.initialViewportScale=this.editor.viewport.getScaleFactor(),this.isScaling=false,this.isRotating=Math.abs(Math.sin(this.initialViewportRotation*2))>.001,r=true;}else e.length===1&&(this.mode&1&&a||l&&this.mode&4||this.mode&8)&&(this.lastScreenCenter=e[0].screenPos,this.isScaling=false,r=true);return r&&(this.lastTimestamp=performance.now(),this.transform??=ue.transformBy(w.identity),this.editor.display.setDraftMode(true)),r}updateVelocity(e){let i=e.minus(this.lastScreenCenter),r=(performance.now()-this.lastTimestamp)/1e3;if(i.magnitude()===0&&r<.1||r===0)return;r=Math.max(r,.01);let n=i.times(1/r),a=n;this.velocity&&(a=this.velocity.lerp(n,.5)),this.velocity=a;}getCenterDelta(e){return this.editor.viewport.screenToCanvasTransform.transformVec3(e.minus(this.lastScreenCenter))}toSnappedRotationDelta(e){let r=e-this.initialTouchAngle+this.initialViewportRotation,n=Math.PI/2,a=Math.round(r/n)*n,l=this.isRotating?this.afterRotationStartSnapAngle:this.initialRotationSnapAngle;return Math.abs(r-a)<l&&(r=a,r!==0&&(r+=1e-4)),r-this.editor.viewport.getRotationAngle()}toSnappedScaleFactor(e){let i=this.initialViewportScale*e/this.startTouchDist,r=this.editor.viewport.getScaleFactor(),n=Math.log(i)/Math.log(10),a=Math.round(n);return Math.abs(a-n)<.04?Math.pow(10,a)/r:e/this.lastTouchDist}handleTwoFingerMove(e){let{screenCenter:i,canvasCenter:r,angle:n,dist:a}=this.computePinchData(e[0],e[1]),l=this.getCenterDelta(i),c;if(this.isRotationLocked()?c=0:c=this.toSnappedRotationDelta(n),Math.abs(c)>1e-8&&(this.isRotating=true),this.updateVelocity(i),!this.isScaling){let u=a/this.startTouchDist,h=this.pinchZoomStartThreshold,m=1/this.pinchZoomStartThreshold;(u>h||u<m)&&(this.isScaling=true);}let d=1;this.isScaling&&(d=this.toSnappedScaleFactor(a),this.lastTouchDist=a);let p=w.translation(l).rightMul(w.scaling2D(d,r)).rightMul(w.zRotation(c,r));return this.lastScreenCenter=i,this.transform=ue.transformBy(this.transform.transform.rightMul(p)),p}handleOneFingerMove(e){let i=this.getCenterDelta(e.screenPos),r=w.translation(i);return this.transform=ue.transformBy(this.transform.transform.rightMul(r)),this.updateVelocity(e.screenPos),this.lastScreenCenter=e.screenPos,r}onPointerMove({allPointers:e}){this.transform??=ue.transformBy(w.identity);let i=w.identity;e.length===2?i=this.handleTwoFingerMove(e):e.length===1&&(i=this.handleOneFingerMove(e[0])),ue.transformBy(i).apply(this.editor),this.lastTimestamp=performance.now();}onPointerUp(e){let i=()=>{this.transform&&(this.transform.unapply(this.editor),this.editor.dispatch(this.transform,false)),this.editor.display.setDraftMode(false),this.transform=null,this.velocity=exports.Vec2.zero;};if(e.current.device===2&&e.allPointers.length===1&&this.velocity!==null&&e.current.timeStamp-this.lastPointerDownTimestamp>30&&this.velocity!==null){let a=this.velocity;this.updateVelocity(e.current.screenPos),a.magnitude()<this.velocity.magnitude()&&(this.velocity=a),this.inertialScroller?.stop(),this.inertialScroller=new _r(this.velocity,l=>{if(!this.transform)return;let c=this.editor.viewport.screenToCanvasTransform.transformVec3(l);this.transform.unapply(this.editor),this.transform=ue.transformBy(this.transform.transform.rightMul(w.translation(c))),this.transform.apply(this.editor);},i);}else i();}onGestureCancel(){this.inertialScroller?.stop(),this.velocity=exports.Vec2.zero,this.transform?.unapply(this.editor),this.editor.display.setDraftMode(false),this.transform=null;}updateTransform(e,i=false){let r=e;this.transform&&(r=this.transform.transform.rightMul(e)),this.transform?.unapply(this.editor),this.transform=ue.transformBy(r),this.transform.apply(this.editor),i&&this.editor.announceForAccessibility(this.transform.description(this.editor,this.editor.localization));}applyAndFinalizeTransform(e){this.updateTransform(e,true),this.transform=null;}onWheel({delta:e,screenPos:i}){this.inertialScroller?.stop(),this.transform=ue.transformBy(w.identity);let r=this.editor.viewport.screenToCanvas(i),a=this.editor.viewport.screenToCanvasTransform.transformVec3(exports.Vec3.of(-e.x,-e.y,0)),l=e.z;l=Math.atan(l/2)*2;let d=w.scaling2D(Math.max(.4,Math.min(Math.pow(1.04,-l),4)),r).rightMul(w.translation(a));return this.applyAndFinalizeTransform(d),true}onKeyPress(e){if(this.inertialScroller?.stop(),!(this.mode&16))return  false;this.transform=ue.transformBy(w.identity);let i=exports.Vec2.zero,r=1,n=0,a=this.editor.shortcuts;if(a.matchesShortcut(Br,e))i=exports.Vec2.of(-1,0);else if(a.matchesShortcut(Ar,e))i=exports.Vec2.of(1,0);else if(a.matchesShortcut(Dr,e))i=exports.Vec2.of(0,-1);else if(a.matchesShortcut(Mr,e))i=exports.Vec2.of(0,1);else if(a.matchesShortcut(Or,e))r=1/2;else if(a.matchesShortcut(Hr,e))r=2;else if(a.matchesShortcut(Vr,e))n=1;else if(a.matchesShortcut(Fr,e))n=-1;else return  false;i=i.times(30),n*=Math.PI/8,i=i.times(-1),n=n*-1,r=1/r,n!==0&&(n+=1e-4),this.isRotationLocked()&&(n=0),i=this.editor.viewport.screenToCanvasTransform.transformVec3(i);let c=this.editor.viewport.visibleRect.center,d=w.scaling2D(r,c).rightMul(w.zRotation(n,c)).rightMul(w.translation(i));return this.applyAndFinalizeTransform(d),true}isRotationLocked(){return !!(this.mode&32)}setModeEnabled(e,i){let r=this.mode;i?r|=e:r&=~e,this.setMode(r);}setMode(e){e!==this.mode&&(this.mode=e,this.editor.notifier.dispatch(2,{kind:2,tool:this}));}getMode(){return this.mode}};function ka(s,o,e){let i=document.createElement("div"),r=document.createElement("button"),n=document.createElement("button"),a=document.createElement("button"),l=document.createElement("span");r.innerText="+",n.innerText="-",a.innerText=s.resetView,i.replaceChildren(l,r,n,a),i.classList.add(`${L}zoomLevelEditor`),l.classList.add("zoomDisplay");let c,d=()=>{let u=o.viewport.getScaleFactor()*100;u>.1?u=Math.round(u*10)/10:u=Math.round(u*1e3)/1e3,u!==c&&(l.textContent=s.zoomLevel(u),c=u);};d(),o.notifier.on(7,u=>{u.kind===7&&(d(),a.disabled=u.newTransform.eq(w.identity));});let p=u=>{let h=o.viewport.visibleRect.center,m=w.scaling2D(u,h);o.dispatch(A.transformBy(m),false);};return r.addEventListener("click",()=>{p(5/4);}),n.addEventListener("click",()=>{p(4/5);}),a.addEventListener("click",()=>{o.dispatch(A.transformBy(o.viewport.canvasToScreenTransform.inverse()),false);}),e?.registerTextHelpForElement(r,s.handDropdown__zoomInHelpText),e?.registerTextHelpForElement(n,s.handDropdown__zoomOutHelpText),e?.registerTextHelpForElement(a,s.handDropdown__resetViewHelpText),e?.registerTextHelpForElement(l,s.handDropdown__zoomDisplayHelpText),i}var Ti=class extends Q{constructor(e,i,r,n,a,l,c){super(e,`pan-mode-${r}`,c);this.tool=i;this.flag=r;this.makeIcon=n;this.title=a;this.helpText=l;e.notifier.on(2,d=>{if(d.kind===2&&d.tool===i){let p=!!(i.getMode()&8);this.setSelected(!!(i.getMode()&r)||p),this.setDisabled(p&&r!==8);}}),this.setSelected(false);}shouldAutoDisableInReadOnlyEditor(){return  false}setModeFlag(e){this.tool.setModeEnabled(this.flag,e);}handleClick(){this.setModeFlag(!this.isSelected());}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return  false}getHelpText(){return this.helpText}},Et=class s extends re{allowTogglingBaseTool;overridePanZoomTool;constructor(o,e,i){let r=o.toolController.getPrimaryTools().includes(e),n=(r?e:s.getPrimaryHandTool(o.toolController))??e;super(o,n,"hand-tool-widget",i),this.overridePanZoomTool=(r?s.getOverrideHandTool(o.toolController):e)??e,this.allowTogglingBaseTool=n!==null,this.allowTogglingBaseTool||this.container.classList.add("dropdownShowable");let a=new Ti(o,this.overridePanZoomTool,1,()=>this.editor.icons.makeTouchPanningIcon(),i.touchPanning,i.handDropdown__touchPanningHelpText,i),l=new Ti(o,this.overridePanZoomTool,32,()=>this.editor.icons.makeRotationLockIcon(),i.lockRotation,i.handDropdown__lockRotationHelpText,i);this.addSubWidget(a),this.addSubWidget(l);}static getPrimaryHandTool(o){return o.getPrimaryTools().find(r=>r instanceof he)}static getOverrideHandTool(o){return o.getMatchingTools(he)[0]}shouldAutoDisableInReadOnlyEditor(){return  false}getTitle(){return this.localizationTable.handTool}createIcon(){return this.editor.icons.makeHandToolIcon()}handleClick(){this.allowTogglingBaseTool?super.handleClick():this.setDropdownVisible(!this.isDropdownVisible());}getHelpText(){return this.localizationTable.handDropdown__baseHelpText}fillDropdown(o,e){super.fillDropdown(o,e);let i=document.createElement("div");i.classList.add(`${L}nonbutton-controls-main-list`),go().addTo(i);let r=ka(this.localizationTable,this.editor,e);return i.appendChild(r),o.appendChild(i),true}setSelected(o){this.allowTogglingBaseTool&&super.setSelected(o);}serializeState(){let o=this.overridePanZoomTool.getMode();return {...super.serializeState(),touchPanning:o&1,rotationLocked:o&32}}deserializeFrom(o){o.touchPanning!==void 0&&this.overridePanZoomTool.setModeEnabled(1,!!o.touchPanning),o.rotationLocked!==void 0&&this.overridePanZoomTool.setModeEnabled(32,!!o.rotationLocked),super.deserializeFrom(o);}};var mo=W((s,o)=>new wi(s,o)),wi=class{constructor(o,e){this.startPoint=o;this.viewport=e;this.endPoint=o;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let o=this.startPoint.pos,e=this.endPoint.pos,i=e.minus(o).normalized(),r=this.endPoint.width===0?this.endPoint.width:A.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),n=r+3,a=r+3,l=i.orthog(),c=l.times(n),d=l.times(a),p=o.minus(c),u=new B(p,[{kind:0,point:o.plus(c)},{kind:0,point:e.plus(d)},{kind:0,point:e.minus(d)},{kind:0,point:o.minus(c)}]).mapPoints(m=>this.viewport.roundPoint(m));return new F([M(u,{fill:this.startPoint.color,stroke:{width:r,color:r===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(o){this.buildPreview().render(o);}addPoint(o){this.endPoint=o;}};var It=class s extends re{constructor(e,i,r){super(e,i,i.description,r);this.tool=i;this.shapelikeIDs=["pressure-sensitive-pen","freehand-pen"];let n=e.getCurrentSettings().pens?.additionalPenTypes??[],a=e.getCurrentSettings().pens?.filterPenTypes??(()=>true);this.penTypes=[{name:this.localizationTable.flatTipPen,id:"pressure-sensitive-pen",factory:$e},{name:this.localizationTable.roundedTipPen,id:"freehand-pen",factory:fe},{name:this.localizationTable.roundedTipPen2,id:"polyline-pen",factory:Be},...n.filter(l=>!l.isShapeBuilder),{name:this.localizationTable.arrowPen,id:"arrow",isShapeBuilder:true,factory:co},{name:this.localizationTable.linePen,id:"line",isShapeBuilder:true,factory:mo},{name:this.localizationTable.filledRectangle,id:"filled-rectangle",isShapeBuilder:true,factory:uo},{name:this.localizationTable.outlinedRectanglePen,id:"outlined-rectangle",isShapeBuilder:true,factory:gr},{name:this.localizationTable.outlinedCirclePen,id:"outlined-circle",isShapeBuilder:true,factory:Qt},...n.filter(l=>l.isShapeBuilder)].filter(a),this.editor.notifier.on(2,l=>{if(l.kind!==2)throw new Error("Invalid event type!");l.tool===this.tool&&(this.updateIcon(),this.updateInputs());});}updateInputs=()=>{};penTypes;shapelikeIDs;static idCounter=0;getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){let e=this.tool.getStrokeFactory();for(let i=0;i<this.penTypes.length;i++)if(this.penTypes[i].factory===e)return i;return  -1}getCurrentPenType(){for(let e of this.penTypes)if(e.factory===this.tool.getStrokeFactory())return e;return null}createIconForRecord(e){let i={...this.tool.getStyleValue().get()};e?.factory&&(i.factory=e.factory);let r=e?.factory;return !r||r===fe||r===$e||r===Be?this.editor.icons.makePenIcon(i):this.editor.icons.makeIconFromFactory(i)}createIcon(){return this.createIconForRecord(this.getCurrentPenType())}createPenTypeSelector(e){let i=this.penTypes.map((d,p)=>({id:p,makeIcon:()=>this.createIconForRecord(d),title:d.name,isShapeBuilder:d.isShapeBuilder??false})),r=i.filter(d=>!d.isShapeBuilder),n=ao(this.localizationTable.selectPenType,this.getCurrentPenTypeIdx(),r),a=i.filter(d=>d.isShapeBuilder),l=ao(this.localizationTable.selectShape,this.getCurrentPenTypeIdx(),a),c=d=>{this.tool.setStrokeFactory(this.penTypes[d].factory);};return n.value.onUpdate(c),l.value.onUpdate(c),e?.registerTextHelpForElements([n.getRootElement(),l.getRootElement()],this.localizationTable.penDropdown__penTypeHelpText),{setValue:d=>{n.value.set(d),l.value.set(d);},updateIcons:()=>{n.updateIcons(),l.updateIcons();},addTo:d=>{r.length>0&&n.addTo(d),a.length>0&&l.addTo(d);}}}createStrokeCorrectionOptions(e){let i=document.createElement("div");i.classList.add("action-button-row",`${L}-pen-tool-toggle-buttons`);let r=(l,c)=>{let d=document.createElement("button");d.classList.add(`${L}-toggle-button`);let p=c.cloneNode(true);p.classList.add("icon");let u=document.createElement("span");u.innerText=l,d.replaceChildren(p,u),d.setAttribute("role","switch"),i.appendChild(d);let h=false,m=g=>{},f={setChecked(g){h=g,d.setAttribute("aria-checked",`${h}`),m(h);},setOnInputListener(g){m=g;},addHelpText(g){e?.registerTextHelpForElement(d,g);}};return d.addEventListener("click",()=>{f.setChecked(!h);}),f},n=r(this.localizationTable.inputStabilization,this.editor.icons.makeStrokeSmoothingIcon());n.setOnInputListener(l=>{this.tool.setHasStabilization(l);});let a=r(this.localizationTable.strokeAutocorrect,this.editor.icons.makeShapeAutocorrectIcon());return a.setOnInputListener(l=>{this.tool.setStrokeAutocorrectEnabled(l);}),a.addHelpText(this.localizationTable.penDropdown__autocorrectHelpText),n.addHelpText(this.localizationTable.penDropdown__stabilizationHelpText),{update:()=>{n.setChecked(!!this.tool.getInputMapper()),a.setChecked(this.tool.getStrokeAutocorrectionEnabled());},addTo:l=>{l.appendChild(i);}}}getHelpText(){return this.localizationTable.penDropdown__baseHelpText}fillDropdown(e,i){let r=document.createElement("div");r.classList.add(`${L}spacedList`,`${L}nonbutton-controls-main-list`);let{container:n,setValue:a}=bt(this.editor,f=>{this.tool.setThickness(f);}),l=document.createElement("div"),c=document.createElement("label"),d=Ee(this.editor,f=>{this.tool.setColor(f);}),{input:p,container:u}=d;p.id=`${L}colorInput${s.idCounter++}`,c.innerText=this.localizationTable.colorLabel,c.setAttribute("for",p.id),l.appendChild(c),l.appendChild(u);let h=this.createStrokeCorrectionOptions(i),m=this.createPenTypeSelector(i);return i?.registerTextHelpForElement(l,this.localizationTable.penDropdown__colorHelpText),i&&d.registerWithHelpTextDisplay(i),i?.registerTextHelpForElement(n,this.localizationTable.penDropdown__thicknessHelpText),this.updateInputs=()=>{d.setValue(this.tool.getColor()),a(this.tool.getThickness()),m.updateIcons(),m.setValue(this.getCurrentPenTypeIdx()),h.update();},this.updateInputs(),r.replaceChildren(l,n),m.addTo(r),e.replaceChildren(r),h.addTo(e),true}onKeyPress(e){if(!this.isSelected())return  false;for(let[i,r]of lo.entries())if(this.editor.shortcuts.matchesShortcut(r,e)){let n=i;if(n<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[n].factory),true}return !!super.onKeyPress(e)}serializeState(){return {...super.serializeState(),color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:this.getCurrentPenType()?.id,inputStabilization:!!this.tool.getInputMapper(),strokeAutocorrect:this.tool.getStrokeAutocorrectionEnabled(),pressureSensitivity:this.tool.getPressureSensitivityEnabled()}}deserializeFrom(e){super.deserializeFrom(e);let i=(r,n)=>{let a=typeof e[r];if(a!==n)throw new Error(`Deserializing property ${r}: Invalid type. Expected ${n}, was ${a}.`)};if(e.color&&(i("color","string"),this.tool.setColor(P.fromHex(e.color))),e.thickness&&(i("thickness","number"),this.tool.setThickness(e.thickness)),e.strokeFactoryId){i("strokeFactoryId","string");let r=e.strokeFactoryId;for(let n of this.penTypes)if(r===n.id){this.tool.setStrokeFactory(n.factory);break}}console.log({state:e}),e.inputStabilization!==void 0&&this.tool.setHasStabilization(!!e.inputStabilization),e.strokeAutocorrect!==void 0&&this.tool.setStrokeAutocorrectEnabled(!!e.strokeAutocorrect);}};var qr=class extends Ie{constructor(o,e,i,r={}){super(o,"save-button",()=>r.icon??o.icons.makeSaveIcon(),r.label??e.save,i),this.setTags(["save"]);}shouldAutoDisableInReadOnlyEditor(){return  false}onKeyPress(o){return this.editor.shortcuts.matchesShortcut(hr,o)?(this.clickAction(),true):super.onKeyPress(o)}mustBeInToplevelMenu(){return  true}},ss=qr;function Ra(s,o){let e=document.createElement("div");e.classList.add("toolbar-button-grid"),e.style.setProperty("--column-count",`${o}`);let i=r=>{let n=document.createElement("button");n.classList.add("button");let a=r.icon();a.classList.add("icon");let l=document.createElement("label");return l.textContent=r.label,l.classList.add("button-label-text"),n.addEventListener("click",r.onClick),r.enabled&&r.enabled.onUpdateAndNow(c=>{n.disabled=!c;}),n.replaceChildren(a,l),e.appendChild(n),Ue(n),r.onCreated?.(n),n};return s.map(i),{container:e}}var as=Ra;var kt=30,Rt=class{constructor(o,e,i,r,n,a){this.presentation=o;this.parent=e;this.viewport=i;this.onDragStart=r;this.onDragUpdate=n;this.onDragEnd=a;this.element=document.createElement("div"),this.element.classList.add(`${le}handle`,`${le}${o.action}`);let l=document.createElement("div");l.classList.add(`${le}content`),this.element.appendChild(l),this.parentSide=o.side;let c=o.icon;switch(c&&(l.appendChild(c),c.classList.add("icon")),o.action==="rotate"?this.shape=0:this.shape=1,this.shape){case 0:this.element.classList.add(`${le}circle`);break;case 1:this.element.classList.add(`${le}square`);break;default:Pn(this.shape);}this.updatePosition();}element;snapToGrid;shape;parentSide;addTo(o){o.appendChild(this.element);}remove(){this.element.remove();}getBBoxParentCoords(){let o=this.parent.getScreenRegion(),e=exports.Vec2.of(kt,kt),i=o.size.scale(this.parentSide).minus(e.times(1/2));return new I(i.x,i.y,e.x,e.y)}getBBoxCanvasCoords(){let o=this.parent.region,e=exports.Vec2.of(kt,kt).times(1/this.viewport.getScaleFactor()),i=o.size.scale(this.parentSide).minus(e.times(.5));return new I(i.x,i.y,e.x,e.y).translatedBy(o.topLeft)}updatePosition(){let o=this.getBBoxParentCoords();this.element.style.marginLeft=`${o.topLeft.x}px`,this.element.style.marginTop=`${o.topLeft.y}px`,this.element.style.width=`${o.w}px`,this.element.style.height=`${o.h}px`;}containsPoint(o){let e=this.getBBoxCanvasCoords(),i=o.minus(e.center),r=e.size.x/2,n;return this.shape===0?n=i.magnitude()<=r:n=Math.abs(i.x)<=r&&Math.abs(i.y)<=r,n}dragLastPos=null;handleDragStart(o){return this.onDragStart(o.canvasPos),this.dragLastPos=o.canvasPos,true}handleDragUpdate(o){this.dragLastPos&&this.onDragUpdate(o.canvasPos);}handleDragEnd(){if(this.dragLastPos)return this.onDragEnd()}setSnapToGrid(o){this.snapToGrid=o;}isSnappingToGrid(){return this.snapToGrid}};var Zr=40,bo=class{constructor(o,e,i,r,n){this.parent=o;this.viewport=e;this.icon=i;this.localization=n;this.element=document.createElement("div"),this.element.classList.add(`${le}handle`,`${le}selection-menu`),this.element.style.setProperty("--vertical-offset",`${Zr}px`),this.onClick=()=>{this.button?.focus({preventScroll:true});let a=this.getBBoxCanvasCoords().center;r(a);},this.initUI(),this.updatePosition();}element;button;onClick;initUI(){let o=document.createElement("button");this.icon.classList.add("icon"),o.replaceChildren(this.icon),o.ariaLabel=this.localization.selectionMenu__show,o.title=o.ariaLabel,this.button=o,o.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.onClick());}),this.element.appendChild(o),requestAnimationFrame(()=>{this.updatePosition();});}addTo(o){o.appendChild(this.element);}remove(){this.element.remove();}getElementScreenSize(){return exports.Vec2.of(this.element.clientWidth,this.element.clientHeight)}getBBoxParentCoords(){let o=exports.Vec2.of(0,-40),e=this.getElementScreenSize();return new I(o.x,o.y,e.x,e.y)}getBBoxCanvasCoords(){let o=this.parent.region,e=this.viewport.getSizeOfPixelOnCanvas(),i=this.getElementScreenSize().times(e),r=Zr/this.viewport.getScaleFactor(),n=exports.Vec2.of(o.x,o.y-r),a=exports.Vec2.of(48,48).times(e);return new I(n.x,n.y,i.x,i.y).grownToSize(a)}updatePosition(){let o=this.getBBoxParentCoords();this.element.style.marginLeft=`${o.topLeft.x}px`,this.element.style.marginTop=`${o.topLeft.y}px`;}containsPoint(o){return this.getBBoxCanvasCoords().containsPoint(o)}lastDragPointer=null;handleDragStart(o){return this.lastDragPointer=o,true}handleDragUpdate(o){this.lastDragPointer=o;}handleDragEnd(){this.lastDragPointer&&this.containsPoint(this.lastDragPointer.canvasPos)&&this.onClick(),this.lastDragPointer=null;}};var yo=(e=>(e.Lasso="lasso",e.Rectangle="rect",e))(yo||{});var Pi=class{constructor(o,e){this.editor=o;this.selection=e;}dragStartPoint;onDragStart(o){this.selection.setTransform(w.identity),this.dragStartPoint=o;}onDragUpdate(o){let e=this.editor.viewport.roundPoint(o.minus(this.dragStartPoint));this.selection.setTransform(w.translation(e));}onDragEnd(){return this.selection.finalizeTransform()}},Ei=class{constructor(o,e){this.editor=o;this.selection=e;}mode=0;dragStartPoint;transformOrigin;scaleRate;onDragStart(o,e){this.selection.setTransform(w.identity),this.mode=e,this.dragStartPoint=o,this.computeOriginAndScaleRate();}computeOriginAndScaleRate(){let o=this.selection.preTransformRegion,e=o.corners,i=0;for(let a of e){let l=this.dragStartPoint.minus(a).magnitudeSquared();l>i&&(i=l,this.transformOrigin=a);}let r=1,n=1;this.transformOrigin.x>o.center.x&&(r=-1),this.transformOrigin.y>o.center.y&&(n=-1),this.scaleRate=exports.Vec2.of(r,n);}onDragUpdate(o){let e=o.minus(this.dragStartPoint),i=this.selection.preTransformRegion.width,r=this.selection.preTransformRegion.height,n=exports.Vec2.of(1,1);if(this.mode===1){let a=i+e.x*this.scaleRate.x;n=exports.Vec2.of(a/i,n.y);}if(this.mode===2){let a=r+e.y*this.scaleRate.y;n=exports.Vec2.of(n.x,a/r);}if(this.mode===0){let a=Math.abs(e.x)>Math.abs(e.y)?e.x:e.y,l=i+a;n=exports.Vec2.of(l/i,l/i);}if(n=n.map(a=>A.roundScaleRatio(a,2)),n.x!==0&&n.y!==0){let a=this.editor.viewport.roundPoint(this.transformOrigin);this.selection.setTransform(w.scaling2D(n,a));}}onDragEnd(){return this.selection.finalizeTransform()}},Ii=class{constructor(o,e){this.editor=o;this.selection=e;}startAngle=0;targetRotation=0;maximumDistFromStart=0;startPoint;startTime;getAngle(o){let e=this.selection.preTransformRegion.center;return o.minus(e).angle()}roundAngle(o){let e=8/Math.PI;return Math.round(o*e)/e}onDragStart(o){this.startPoint=o,this.selection.setTransform(w.identity),this.startAngle=this.getAngle(o),this.targetRotation=0,this.maximumDistFromStart=0,this.startTime=performance.now();}setRotationTo(o){let e=this.editor.viewport.roundPoint(this.selection.preTransformRegion.center),r=w.zRotation(o).mapEntries(a=>A.roundScaleRatio(a)),n=w.translation(e).rightMul(r).rightMul(w.translation(e.times(-1)));this.selection.setTransform(n);}onDragUpdate(o){this.targetRotation=this.roundAngle(this.getAngle(o)-this.startAngle),this.setRotationTo(this.targetRotation);let e=o.minus(this.startPoint).magnitude();e>this.maximumDistFromStart&&(this.maximumDistFromStart=e);}onDragEnd(){return (performance.now()-this.startTime)/1e3<.4&&this.maximumDistFromStart<10&&this.targetRotation===0&&this.setRotationTo(-Math.PI/2),this.selection.finalizeTransform()}};var Lt=class s extends O{constructor(e,i){super("duplicate");this.toDuplicate=e;this.duplicates=e.map((r,n)=>i&&i[n]?r.cloneWithId(i[n]):r.clone()),this.reverse=new _(this.duplicates);}duplicates;reverse;apply(e){this.reverse.unapply(e);}unapply(e){this.reverse.apply(e);}onDrop(e){this.reverse.onDrop(e);}description(e,i){return this.duplicates.length===0?i.duplicatedNoElements:i.duplicateAction(yi(i,this.duplicates)??i.elements,this.duplicates.length)}serializeToJSON(){return {originalIds:this.toDuplicate.map(e=>e.getId()),cloneIds:this.duplicates.map(e=>e.getId())}}static{O.register("duplicate",(e,i)=>{let r,n;Array.isArray(e)?(r=e,n=[]):(r=e.originalIds,n=e.cloneIds),jt(r),jt(n);let a=[],l=[];for(let[c,d]of r.entries()){let p=i.image.lookupElement(d);p?(l.push(n[c]),a.push(p)):console.warn("Duplicate command: Could not find element with ID",d);}return new s(a,l)});}};var jr=100,ls=500,vo=class s{constructor(o,e,i){this.editor=e;o=[...o],this.selectedElems=o,this.originalRegion=I.empty,this.transformers={drag:new Pi(e,this),resize:new Ei(e,this),rotate:new Ii(e,this)},this.outerContainer=document.createElement("div"),this.outerContainer.classList.add(`${le}selection-outer-container`),this.innerContainer=document.createElement("div"),this.innerContainer.classList.add(`${le}selection-inner-container`),this.backgroundElem=document.createElement("div"),this.backgroundElem.classList.add(`${le}selection-background`),this.innerContainer.appendChild(this.backgroundElem),this.outerContainer.appendChild(this.innerContainer);let r=(p,u)=>{let h={0:"resize-xy",1:"resize-x",2:"resize-y"};return new Rt({action:h[p],side:u},this,this.editor.viewport,m=>this.transformers.resize.onDragStart(m,p),m=>this.transformers.resize.onDragUpdate(m),()=>this.transformers.resize.onDragEnd())},n=[r(1,exports.Vec2.of(0,.5)),r(1,exports.Vec2.of(1,.5))],a=r(2,exports.Vec2.of(.5,1)),l=r(0,exports.Vec2.of(1,1)),c=new Rt({action:"rotate",side:exports.Vec2.of(.5,0),icon:this.editor.icons.makeRotateIcon()},this,this.editor.viewport,p=>this.transformers.rotate.onDragStart(p),p=>this.transformers.rotate.onDragUpdate(p),()=>this.transformers.rotate.onDragEnd()),d=new bo(this,this.editor.viewport,this.editor.icons.makeOverflowIcon(),i,this.editor.localization);this.childwidgets=[d,l,...n,a,c];for(let p of this.childwidgets)p.addTo(this.backgroundElem);this.recomputeRegion(),this.updateUI();}childwidgets;originalRegion;selectionTightBoundingBox=null;transformers;transform=w.identity;selectedElems=[];outerContainer;innerContainer;backgroundElem;hasParent=true;getBackgroundElem(){return this.backgroundElem}getTransform(){return this.transform}get preTransformRegion(){return this.originalRegion}get region(){let o=w.zRotation(this.regionRotation,this.originalRegion.center),e=this.transform.rightMul(o.inverse());return this.originalRegion.transformedBoundingBox(e)}computeTightBoundingBox(){return this.selectedElems.reduce((e,i)=>(e??i.getBBox()).union(i.getBBox()),null)??I.empty}get regionRotation(){return this.transform.transformVec3(exports.Vec2.unitX).angle()}get preTransformedScreenRegion(){let o=e=>this.editor.viewport.canvasToScreen(e);return I.fromCorners(o(this.preTransformRegion.topLeft),o(this.preTransformRegion.bottomRight))}get preTransformedScreenRegionRotation(){return this.editor.viewport.getRotationAngle()}getScreenRegion(){let o=this.editor.viewport.canvasToScreenTransform,e=this.editor.viewport.getScaleFactor(),i=o.transformVec2(this.region.center);return new I(i.x,i.y,e*this.region.width,e*this.region.height).translatedBy(this.region.size.times(-e/2))}get screenRegionRotation(){return this.regionRotation+this.editor.viewport.getRotationAngle()}setTransform(o,e=true){this.transform=o,e&&this.hasParent&&this.previewTransformCmds();}getDeltaZIndexToMoveSelectionToTop(){if(this.selectedElems.length===0)return 0;let o=this.selectedElems[0].getZIndex(),e=this.editor.image.getComponentsIntersecting(this.region);return (e[e.length-1]?.getZIndex()??o)+1-o}finalizeTransform(){let o=this.transform,e=this.selectedElems;this.originalRegion=this.originalRegion.transformedBoundingBox(this.transform),this.transform=w.identity,this.scrollTo();let i;if(this.selectedElems.length>0){let r=this.getDeltaZIndexToMoveSelectionToTop();i=this.editor.dispatch(new s.ApplyTransformationCommand(this,e,this.originalRegion.center,o,r));}return i}sendToBack(){let e=this.editor.image.getComponentsIntersecting(this.editor.viewport.visibleRect)[0]?.getZIndex()??0,i=this.selectedElems[this.selectedElems.length-1]?.getZIndex()??0,n=e-1-i;if(n!==0){let a=this.selectedElems.map(l=>l.setZIndex(l.getZIndex()+n));return J(a,jr)}return null}static{O.register("selection-tool-transform",(o,e)=>{let i=o.transform,r=o.selectionCenter??[0,0],n=o.elems??[];He(i),He(r),jt(n);let a=new w(...i),l=n,c=Number.parseInt(o.deltaZIndex??0),d=exports.Vec2.of(r[0]??0,r[1]??0);return new this.ApplyTransformationCommand(null,l,d,a,c)});}static ApplyTransformationCommand=class extends O{constructor(e,i,r,n,a){super("selection-tool-transform");this.selection=e;this.selectionCenter=r;this.fullTransform=n;this.deltaZIndex=a;(c=>typeof c[0]=="string")(i)?this.selectedElemIds=i:(this.selectedElemIds=i.map(c=>c.getId()),this.transformCommands=i.map(c=>c.setZIndexAndTransformBy(this.fullTransform,c.getZIndex()+a)));}transformCommands;selectedElemIds;resolveToElems(e,i){this.transformCommands||(this.transformCommands=this.selectedElemIds.map(r=>{let n=e.image.lookupElement(r);if(!n)return console.warn(`Unable to find element with ID, ${r}.`),null;let a=n.getZIndex(),l=n.getZIndex()+this.deltaZIndex;return i&&(l=n.getZIndex(),a=n.getZIndex()-this.deltaZIndex),n.setZIndexAndTransformBy(this.fullTransform,l,a)}).filter(r=>r!==null));}async apply(e){this.resolveToElems(e,false),this.selection?.setTransform(this.fullTransform,false),this.selection?.updateUI(),await e.asyncApplyCommands(this.transformCommands,jr),this.selection?.setTransform(w.identity,false),this.selection?.recomputeRegion(),this.selection?.updateUI();}async unapply(e){this.resolveToElems(e,true),this.selection?.setTransform(this.fullTransform.inverse(),false),this.selection?.updateUI(),await e.asyncUnapplyCommands(this.transformCommands,jr,true),this.selection?.setTransform(w.identity,false),this.selection?.recomputeRegion(),this.selection?.updateUI();}serializeToJSON(){return {elems:this.selectedElemIds,transform:this.fullTransform.toArray(),deltaZIndex:this.deltaZIndex,selectionCenter:this.selectionCenter.asArray()}}description(e,i){return i.transformedElements(this.selectedElemIds.length,ft(this.selectionCenter,this.fullTransform,false,i))}};previewTransformCmds(){if(this.selectedElems.length===0)return;if(this.selectedElems.length>ls){this.updateUI();return}let o=this.editor.display.getWetInkRenderer();o.clear(),o.pushTransform(this.transform);let i=this.editor.viewport.visibleRect.union(this.region).transformedBoundingBox(this.transform.inverse());for(let r of this.selectedElems)r.render(o,i);o.popTransform(),this.updateUI();}recomputeRegion(){let o=this.computeTightBoundingBox();return this.selectionTightBoundingBox=o,o?(this.originalRegion=o,this.padRegion(),true):(this.cancelSelection(),false)}padRegion(){let o=this.selectionTightBoundingBox??this.originalRegion,e=this.getMinCanvasSize();if(o.w<e||o.h<e){let i=e/2;this.originalRegion=I.bboxOf(o.corners,i),this.updateUI();}}getMinCanvasSize(){return kt/this.editor.viewport.getScaleFactor()*2}getSelectedItemCount(){return this.selectedElems.length}updateUI(){if(!this.hasParent)return;let o=this.getScreenRegion();this.backgroundElem.style.marginLeft=`${o.topLeft.x}px`,this.backgroundElem.style.marginTop=`${o.topLeft.y}px`,this.backgroundElem.style.width=`${o.width}px`,this.backgroundElem.style.height=`${o.height}px`;let e=this.screenRegionRotation*180/Math.PI;this.backgroundElem.style.transform=`rotate(${e}deg)`,this.backgroundElem.style.transformOrigin="center";let i=`${le}rotated-near-perpendicular`;Math.abs(Math.sin(this.screenRegionRotation))>.5?this.innerContainer.classList.add(i):this.innerContainer.classList.remove(i),o.width===0&&o.height===0?this.innerContainer.classList.add("-empty"):this.innerContainer.classList.remove("-empty");for(let r of this.childwidgets)r.updatePosition(this.getScreenRegion());}removedFromImage={};addRemoveSelectionFromImage(o){if(!(!o&&this.selectedElems.length>ls)){for(let e of this.selectedElems){let i=this.editor.image.findParent(e);!o&&i?(this.removedFromImage[e.getId()]=true,i.remove()):!i&&this.removedFromImage[e.getId()]&&(K.addComponent(e).apply(this.editor),this.removedFromImage[e.getId()]=false,delete this.removedFromImage[e.getId()]);}this.editor.queueRerender().then(()=>{o?this.editor.display.getWetInkRenderer().clear():this.previewTransformCmds();});}}removeDeletedElemsFromSelection(){this.selectedElems=this.selectedElems.filter(o=>{let e=!!this.editor.image.findParent(o),i=this.removedFromImage[o.getId()];return e||i});}activeHandle=null;backgroundDragging=false;onDragStart(o){if(this.selectedElems.length===0)return  false;document.getSelection()?.removeAllRanges(),this.activeHandle=null;let e=false;this.backgroundDragging=false,this.region.containsPoint(o.canvasPos)&&(this.backgroundDragging=true,e=true);for(let i of this.childwidgets)i.containsPoint(o.canvasPos)&&(this.activeHandle=i,this.backgroundDragging=false,e=true);return e&&(this.removeDeletedElemsFromSelection(),this.addRemoveSelectionFromImage(false)),this.activeHandle&&this.activeHandle.handleDragStart(o),this.backgroundDragging&&this.transformers.drag.onDragStart(o.canvasPos),e}onDragUpdate(o){this.backgroundDragging&&this.transformers.drag.onDragUpdate(o.canvasPos),this.activeHandle&&this.activeHandle.handleDragUpdate(o);}onDragEnd(){this.backgroundDragging?this.transformers.drag.onDragEnd():this.activeHandle&&this.activeHandle.handleDragEnd(),this.addRemoveSelectionFromImage(true),this.backgroundDragging=false,this.activeHandle=null,this.updateUI();}onDragCancel(){this.backgroundDragging=false,this.activeHandle=null,this.setTransform(w.identity),this.addRemoveSelectionFromImage(true),this.updateUI();}scrollTo(){if(this.selectedElems.length===0)return  false;let o=this.editor.viewport.getScreenRectSize(),e=new I(0,0,o.x,o.y),i=this.getScreenRegion();if(!e.containsPoint(i.center)){let r=i.center,n=e.getClosestPointOnBoundaryTo(r),a=this.editor.viewport.screenToCanvas(n),l=this.region.center,c=a.minus(l);return this.editor.dispatchNoAnnounce(A.transformBy(w.translation(c.times(.5))),false),this.editor.queueRerender().then(()=>{this.previewTransformCmds();}),true}return  false}deleteSelectedObjects(){return (this.backgroundDragging||this.activeHandle)&&this.onDragEnd(),new _(this.selectedElems)}selectionDuplicatedAnimationTimeout=null;runSelectionDuplicatedAnimation(){this.selectionDuplicatedAnimationTimeout&&clearTimeout(this.selectionDuplicatedAnimationTimeout);let o=400;this.backgroundElem.style.animation=`${o}ms ease selection-duplicated-animation`,this.selectionDuplicatedAnimationTimeout=setTimeout(()=>{this.backgroundElem.style.animation="",this.selectionDuplicatedAnimationTimeout=null;},o);}async duplicateSelectedObjects(){let o=this.backgroundDragging||this.activeHandle,e=null;o||this.runSelectionDuplicatedAnimation();let i;if(o){let n=this.getDeltaZIndexToMoveSelectionToTop();e=new s.ApplyTransformationCommand(null,this.selectedElems,this.region.center,this.transform,n),await e.apply(this.editor),this.addRemoveSelectionFromImage(true),i=J(this.selectedElems.map(a=>K.addComponent(a.clone()))),await e?.unapply(this.editor),this.addRemoveSelectionFromImage(false),this.previewTransformCmds(),this.updateUI();}else i=new Lt(this.selectedElems);return i}snapSelectedObjectsToGrid(){let o=this.editor.viewport,e=this.computeTightBoundingBox().topLeft,r=o.snapToGrid(e).minus(e),n=this.getTransform();this.setTransform(n.rightMul(w.translation(r))),this.finalizeTransform();}setHandlesVisible(o){o?this.innerContainer.classList.remove("-hide-handles"):this.innerContainer.classList.add("-hide-handles");}addTo(o){this.outerContainer.parentElement&&this.outerContainer.remove(),o.appendChild(this.outerContainer),this.hasParent=true;}setToPoint(o){this.originalRegion=this.originalRegion.grownToPoint(o),this.selectionTightBoundingBox=null,this.updateUI();}cancelSelection(){this.outerContainer.parentElement&&this.outerContainer.remove(),this.originalRegion=I.empty,this.selectionTightBoundingBox=null,this.hasParent=false;}getSelectedObjects(){return [...this.selectedElems]}};var st=class{render(o,e){o.drawPath(M(this.previewPath(),{fill:e}));}resolve(o,e){let i=this.previewPath(),r=c=>c.filter(d=>d.isSelectable()),n,a=e.getSizeOfPixelOnCanvas()*3;if(i.bbox.maxDimension<=a){let c=e.visibleRect.maxDimension/200,d=i.bbox.grownBy(c);n=o.getComponentsIntersecting(d).filter(p=>!!p),n=r(n),n.length>1&&(n=[n[0]]);}else n=r(this.resolveInternal(o));return n}};var xo=class extends st{constructor(e,i){super();this.viewport=i;this.boundaryPoints.push(e),this.lastPoint=e;}boundaryPoints=[];lastPoint;onPointerMove(e){let i=this.boundaryPoints[this.boundaryPoints.length-1],r=this.viewport.getSizeOfPixelOnCanvas()*8;i.distanceTo(e)>=r&&this.boundaryPoints.push(e),this.lastPoint=e;}previewPath(){let e=this.boundaryPoints.map(i=>({kind:0,point:i}));return e.push({kind:0,point:this.lastPoint}),new B(this.boundaryPoints[0],e).asClosed()}resolveInternal(e){let i=this.previewPath(),r=i.polylineApproximation(),n=e.getComponentsIntersecting(i.bbox),a=l=>{if(i.closedContainsRect(l.getExactBBox()))return  true;let c=false;for(let d of l.keyPoints())if(i.closedContainsPoint(d)){c=true;break}if(!c)return  false;for(let d of r)if(l.intersects(d))return  false;return  true};return n.filter(a)}};var So=class extends st{rect;constructor(o){super(),this.rect=I.fromCorners(o,o);}onPointerMove(o){this.rect=this.rect.grownToPoint(o);}previewPath(){return B.fromRect(this.rect)}resolveInternal(o){return o.getComponentsIntersecting(this.rect).filter(e=>e.intersectsRect(this.rect))}};var Co=class{constructor(o,e){this.viewport=o;this.scrollByCanvasDelta=e;}started=false;updateLoopId=0;updateLoopRunning=false;targetPoint=null;scrollRate=1e3;getScrollForPoint(o){let e=this.viewport.getScreenRectSize(),i=new I(0,0,e.x,e.y),r=44,n=i.grownBy(-44);if(n.containsPoint(o))return exports.Vec2.zero;let a=n.getClosestPointOnBoundaryTo(o),l=a.distanceTo(o),c=a.minus(o),p=Math.min(l/r,1.25);return c.normalizedOrZero().times(p)}start(){this.started=true;}onPointerMove(o){this.started&&(this.getScrollForPoint(o)===exports.Vec2.zero?this.stopUpdateLoop():(this.targetPoint=o,this.startUpdateLoop()));}stop(){this.targetPoint=null,this.started=false,this.stopUpdateLoop();}startUpdateLoop(){this.updateLoopRunning||(async()=>{this.updateLoopId++;let o=this.updateLoopId,e=performance.now();for(;this.updateLoopId===o&&this.targetPoint;){this.updateLoopRunning=true;let i=performance.now(),r=i-e,a=this.getScrollForPoint(this.targetPoint).times(this.scrollRate*r/1e3);this.scrollByCanvasDelta(this.viewport.screenToCanvasTransform.transformVec3(a)),e=i,await Ae();}this.updateLoopRunning=false;})();}stopUpdateLoop(){this.updateLoopId++;}};function La(s){return new Promise(o=>{setTimeout(()=>o(),s);})}var ki=La;function za(s,o){let e=document.createElement("div"),{remove:i}=s.createHTMLOverlay(e);e.classList.add("dialog-container","message-dialog-container",...o.classNames??[]);let r=document.createElement("dialog"),n=document.createElement("div");n.classList.add("message-dialog-content",...o.contentClassNames??[]);let a=document.createElement("h1");a.textContent=o.title,a.setAttribute("autofocus","true");let l=document.createElement("button");l.innerText=s.localization.closeDialog,l.classList.add("close");let c=document.createElement("div");c.classList.add("scroll"),c.addEventListener("wheel",h=>h.stopPropagation()),n.replaceChildren(a,c,l),r.replaceChildren(n),e.replaceChildren(r);let d=300;r.style.setProperty("--close-delay",`${d}ms`);let p=async()=>{r.classList.add("-closing"),await ki(d),r.close();};return (()=>{r.addEventListener("pointerdown",h=>{h.target===r&&p();}),r.addEventListener("close",()=>{i();}),l.addEventListener("click",()=>p());})(),r.showModal(),{close:()=>p(),appendChild:h=>{c.appendChild(h);}}}var Ri=za;async function Ba(s,o={}){try{let e=new FileReader;return await new Promise((i,r)=>{e.addEventListener("load",()=>i(e.result)),e.onerror=r,e.addEventListener("abort",r),e.addEventListener("progress",n=>{o.onprogress?.(n);}),e.readAsDataURL(s);})}catch(e){(o.onWarning??console.warn)("Unable to convert file to base64 with a FileReader: ",e);let i=await s.arrayBuffer(),r=new Uint8Array(i),n=30,a=[];for(let l=0;l<r.length;l+=n){let c=String.fromCharCode(...r.slice(l,l+n));a.push(btoa(c));}return `data:${s.type??"image/*"};base64,${a.join("")}`}}var zt=Ba;function cs(s){return s.endsWith("+xml")||s.startsWith("text/")}var ye=class{constructor(o,e){this.editor=o;this.callbacks=e;}#e=false;paste(o){let e=i=>{if(this.callbacks?.onPasteError)return this.callbacks.onPasteError(i),Promise.resolve(false);throw i};try{return this.pasteInternal(o).catch(e)}catch(i){return e(i)}}async pasteInternal(o){let e=this.editor,i=o?.dataTransfer??o?.clipboardData??null,r=!!i,n=(u,h)=>h&&e.toolController.dispatchInputEvent({kind:8,mime:u,data:h}),a=["image/svg+xml","text/html","image/png","image/jpeg","text/plain"],l=[],c=new Map,d=e.getCurrentSettings();if(r){l=[...i.files];for(let u of a){let h=i.getData(u);h&&c.set(u,h);}}else if(d.clipboardApi){let u=await d.clipboardApi.read();for(let[h,m]of u.entries())if(typeof m=="string")c.set(h,m);else {let f=m;f.type!==h&&(f=new Blob([f],{type:h})),l.push(f);}}else {let u=await navigator.clipboard.read();for(let h of u)for(let m of h.types)a.includes(m)&&l.push(await h.getType(m));}let p=async u=>{let h=cs(u);if(h){let m=c.get(u);if(n(u,m))return o?.preventDefault(),true}for(let m of l)if(m?.type?.toLowerCase()===u)if(h){let g=await m.text();if(n(u,g))return o?.preventDefault(),true}else {e.showLoadingWarning(0);let g=y=>{e.showLoadingWarning(y.loaded/y.total);};try{let y=await zt(m,{onprogress:g});if(n(u,y))return o?.preventDefault(),e.hideLoadingWarning(),!0}catch(y){console.error("Error reading image:",y);}e.hideLoadingWarning();}return  false};for(let u of a)if(await p(u))return  true;return  false}copy(o){let e=i=>{if(this.callbacks?.onCopyError)return this.callbacks.onCopyError(i),Promise.resolve();throw i};try{return this.copyInternal(o).catch(e)}catch(i){return e(i)}}copyInternal(o){let e=new Map;this.editor.toolController.dispatchInputEvent({kind:7,setData:(p,u)=>{e.set(p,u);}})&&o?.preventDefault();let r=[...e.keys()].some(p=>!cs(p)),n=p=>{if(!o)throw new Error(`Unable to copy -- no event provided${p?`. Original error: ${p}`:""}`);for(let[u,h]of e.entries())typeof h=="string"&&("clipboardData"in o?o.clipboardData?.setData(u,h):o.dataTransfer?.setData(u,h));},a=()=>{let h=(m=>{let f=Object.create(null);for(let[g,y]of Object.entries(m))"supports"in ClipboardItem&&typeof ClipboardItem.supports=="function"&&!ClipboardItem.supports(g)||(f[g]=y);return f})((m=>{let f=Object.create(null);for(let[g,y]of m.entries()){if(typeof y=="string"){let v=new Blob([new TextEncoder().encode(y)],{type:g});f[g]=v;}else f[g]=y;g==="image/svg+xml"&&(f["text/html"]??=f[g]);}return f})(e));return navigator.clipboard.write([new ClipboardItem(h)])},l=typeof ClipboardItem<"u"&&typeof navigator?.clipboard?.write<"u",c=!this.#e&&l&&(r||!o),d=this.editor.getCurrentSettings();if(c&&d.clipboardApi)return d.clipboardApi.write(e)??Promise.resolve();if(c){let p=null,u=h=>{console.warn("Unable to copy to the clipboard API. Future calls to .copy will use ClipboardEvents if possible.",h),this.#e=true,n(h);};try{p=a();}catch(h){u(h);}if(p)return p.catch(u)}else n();return Promise.resolve()}};function Aa(s){let o=e=>{let i=Ri(s,{title:s.localization.copyPasteError__heading,classNames:["clipboard-error-dialog"]});i.appendChild(document.createTextNode(s.localization.copyPasteError__description));let r=document.createElement("details"),n=document.createElement("summary");return n.textContent=s.localization.copyPasteError__errorDetails,r.appendChild(n),r.appendChild(document.createTextNode(`Error: ${e}`)),i.appendChild(r),i};return {onCopyError(e){let i=o(e),r=document.createElement("label");r.textContent=s.localization.copyPasteError__copyRetry;let n=document.createElement("textarea");r.appendChild(n);let a=new ye(s),l=c=>(c.preventDefault(),a.copy(c).then(()=>{i.close();}));n.addEventListener("copy",l),n.addEventListener("dragstart",l),n.value=s.localization.copyPasteError__copyMe,i.appendChild(r),n.select(),document.execCommand("copy");},onPasteError(e){let i=o(e),r=document.createElement("label");r.textContent=s.localization.copyPasteError__pasteRetry;let n=document.createElement("textarea");r.appendChild(n);let a=new ye(s),l=c=>(c.preventDefault(),a.paste(c).then(d=>{d&&i.close();}));n.addEventListener("paste",l),n.addEventListener("drop",l),i.appendChild(r),n.focus(),document.execCommand("paste");}}}var Yr=Aa;var Da=0;async function Ma(s,o,e){let i=document.createElement("div"),{remove:r}=s.createHTMLOverlay(i),n=document.createElement("dialog");n.classList.add("editor-popup-menu");let a=240;n.style.setProperty("--hide-menu-animation-timeout",`${a}ms`);let l=()=>{let u=s.getOutputBBoxInDOM(),h=s.viewport.canvasToScreen(o).plus(u.topLeft);n.style.setProperty("--anchor-x",`${h.x}px`),n.style.setProperty("--anchor-y",`${h.y}px`);};l();let c=s.notifier.on(7,l);i.appendChild(n);let d=false,p=async()=>{d||(d=true,c.remove(),n.classList.add("-hide"),await ki(a),n.close());};return new Promise(u=>{let h=false,m=null,f=()=>{h||(u(m),h=true);};n.addEventListener("close",()=>{r(),f();});let g=b=>{m=b,p(),f();};s.handlePointerEventsExceptClicksFrom(n,(b,S)=>S.target===n&&b==="pointerdown"?(p(),true):!!d,(b,S)=>S.target===n);let y=document.createElement("div");y.classList.add("content"),y.role="menu";let v=[];y.addEventListener("keydown",b=>{let S=v.indexOf(document.activeElement);if(S===-1)return;let T=S;b.key==="ArrowDown"?T++:b.key==="ArrowUp"?T--:b.key==="End"?T=v.length-1:b.key==="Home"&&(T=0),T<0&&(T+=v.length),T%=v.length,T!==S&&(b.preventDefault(),v[T].focus());});for(let b of e){let S=document.createElement("button");S.id=`menu-overlay-option-${Da++}`,S.role="menuitem",S.classList.add("option","editor-popup-menu-option"),S.replaceChildren(b.icon(),document.createTextNode(b.text)),S.addEventListener("click",T=>{T.defaultPrevented||g(b.key);}),y.appendChild(S),v.length===0&&(S.autofocus=true),v.push(S);}n.appendChild(y),n.showModal(),y.scrollIntoView({block:"nearest"});})}var ds=Ma;async function Va(s,o,e,i,r){let n=o.localization,a=s?.getSelectedItemCount()&&i,l=[{text:n.selectionMenu__paste,icon:()=>o.icons.makePasteIcon(),key:()=>{new ye(o,Yr(o)).paste();}}];(await ds(o,e,a?[{text:n.selectionMenu__duplicate,icon:()=>o.icons.makeDuplicateSelectionIcon(),key:async()=>{await o.dispatch(await s.duplicateSelectedObjects());}},{text:n.selectionMenu__delete,icon:()=>o.icons.makeDeleteSelectionIcon(),key:async()=>{await o.dispatch(s.deleteSelectedObjects()),r();}},{text:n.selectionMenu__copyToClipboard,icon:()=>o.icons.makeCopyIcon(),key:()=>{new ye(o,Yr(o)).copy();}},...l]:l))?.();}var ps=Va;var us="text";var Fa={fontFamily:"sans",size:12,renderingStyle:{fill:P.black}},Y=class s extends G{constructor(e,i,r=Fa,n=0){super(us);this.textObjects=e;this.transform=i;this.style=r;this.transformMode=n;this.recomputeBBox(),!e.some(l=>typeof l=="string")&&e.length>0&&(this.style=e[0].getTextStyle());}contentBBox;isRestylableComponent=true;static applyTextStyles(e,i){let r=i.fontFamily.match(/\s/),n=i.fontFamily.match(/^".*"$/),a=r&&!n?`"${i.fontFamily.replace(/"/g,String.raw`\"`)}"`:i.fontFamily;e.font=[i.fontStyle??"",i.fontWeight??"",(i.size??12)+"px",`${a}`].join(" "),e.textAlign="left";}static textMeasuringCtx=null;static estimateTextDimens(e,i){let r=e.length*i.size,n=i.size;return new I(0,-n*2/3,r,n)}static getTextMetrics(e,i){if(s.textMeasuringCtx??=document.createElement("canvas").getContext("2d")??null,!s.textMeasuringCtx)return null;let r=s.textMeasuringCtx;return s.applyTextStyles(r,i),r.measureText(e)}static getTextDimens(e,i){let r=this.getTextMetrics(e,i);if(!r)return this.estimateTextDimens(e,i);let n=-r.actualBoundingBoxAscent,a=r.actualBoundingBoxAscent+r.actualBoundingBoxDescent;return new I(0,n,r.width,a)}static getFontHeight(e){return e.size}computeUntransformedBBoxOfPart(e){return typeof e=="string"?s.getTextDimens(e,this.style):e.contentBBox}recomputeBBox(){let e=null,i=new s.TextCursor(this.transform,this.style);for(let r of this.textObjects){let n=i.update(r).transform,a=this.computeUntransformedBBoxOfPart(r).transformedBoundingBox(n);e??=a,e=e.union(a);}this.contentBBox=e??I.empty;}renderInternal(e,i,r=w.identity){let n=new s.TextCursor(this.transform,this.style);for(let a of this.textObjects){let{transform:l,bbox:c}=n.update(a);i&&!i.intersects(c.transformedBoundingBox(r))||(typeof a=="string"?e.drawText(a,l,this.style):(e.pushTransform(l),a.renderInternal(e,i,r.rightMul(l)),e.popTransform()));}}render(e,i){e.startObject(this.contentBBox),this.renderInternal(e,i),e.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return this.textObjects.length}intersects(e){let i=new s.TextCursor(this.transform,this.style);for(let r of this.textObjects){let n=i.update(r).transform.inverse(),a=e.transformedBy(n);if(typeof r=="string"){if(s.getTextDimens(r,this.style).getEdges().some(c=>a.intersection(c)!==null))return  true}else if(r.intersects(a))return  true}return  false}getStyle(){return {color:this.style.renderingStyle.fill,textStyle:{...this.style,renderingStyle:{...this.style.renderingStyle}}}}updateStyle(e){return Je(this.getStyle(),e,this)}forceStyle(e,i){if(e.textStyle)this.style=ir(e.textStyle);else if(e.color)this.style={...this.style,renderingStyle:{...this.style.renderingStyle,fill:e.color}};else return;for(let r of this.textObjects)r instanceof s&&r.forceStyle(e,i);i&&(i.image.queueRerenderOf(this),i.queueRerender());}getTextStyle(){return ir(this.style)}getBaselinePos(){return this.transform.transformVec2(exports.Vec2.zero)}getTransform(){return this.transform}applyTransformation(e){this.transform=e.rightMul(this.transform),this.recomputeBBox();}createClone(){let e=this.textObjects.map(i=>typeof i=="string"?i:i.createClone());return new s(e,this.transform,this.style)}getText(){let e=[];for(let i of this.textObjects)typeof i=="string"?e.push(i):e.push(i.getText());return e.join(`
`)}description(e){return e.text(this.getText())}serializeToJSON(){let e=ei(this.style);return {textObjects:this.textObjects.map(r=>typeof r=="string"?{text:r}:{json:r.serializeToJSON()}),transform:this.transform.toArray(),style:e}}static deserializeFromString(e){typeof e=="string"&&(e=JSON.parse(e));let i=Jo(e.style),r=e.textObjects.map(l=>(l.text??null)!==null?l.text:s.deserializeFromString(l.json));if(e.transform=e.transform.filter(l=>typeof l=="number"),e.transform.length!==9)throw new Error(`Unable to deserialize transform, ${e.transform}.`);let n=e.transform,a=new w(...n);return new s(r,a,i)}static fromLines(e,i,r){let n=null,a=[],l=Math.round(this.getFontHeight(r)),c=exports.Vec2.zero;for(let d of e){n&&(c=c.plus(exports.Vec2.unitY.times(l)));let p=new s([d],w.translation(c),r);a.push(p),n=p;}return new s(a,i,r)}static TextCursor=class{constructor(e=w.identity,i){this.parentTransform=e;this.parentStyle=i;}transform=w.identity;update(e){let i=w.identity,r=w.identity,n;typeof e=="string"?n=s.getTextDimens(e,this.parentStyle):(r=e.transform,n=e.getBBox());let a=typeof e=="string"?1:e.transformMode;a===1?i=this.transform.rightMul(i):(a===2||a===3)&&(i=this.transform.mapEntries((p,[u,h])=>{if(a===2)return u===1&&h===2?0:p;if(a===3)return u===0&&h===2?0:p;throw new Error("Unreachable")}).rightMul(i));let l=w.translation(exports.Vec2.of(n.width,0));this.transform=i.rightMul(r).rightMul(l);let c=this.parentTransform.rightMul(i);return {transform:c,bbox:n.transformedBoundingBox(c)}}}};G.registerComponent(us,s=>Y.deserializeFromString(s));var ve=class{constructor(o){this.viewport=o;}selfTransform=null;transformStack=[];getViewport(){return this.viewport}setDraftMode(o){}objectLevel=0;currentPaths=null;flushPath(){if(!this.currentPaths)return;let o=null;for(let e of this.currentPaths){let{startPoint:i,commands:r,style:n}=e;!o||!Yo(o,n)?(o&&this.endPath(o),this.beginPath(i),o=n):this.moveTo(i);for(let a of r)a.kind===0?this.lineTo(a.point):a.kind===1?this.moveTo(a.point):a.kind===2?this.traceCubicBezierCurve(a.controlPoint1,a.controlPoint2,a.endPoint):a.kind===3&&this.traceQuadraticBezierCurve(a.controlPoint,a.endPoint);}o&&this.endPath(o),this.currentPaths=[];}drawPath(o){this.objectLevel===0||this.currentPaths===null?(this.currentPaths=[o],this.flushPath(),this.currentPaths=null):this.currentPaths.push(o);}drawRect(o,e,i){let r=B.fromRect(o,e);this.drawPath(M(r,i));}fillRect(o,e){let i=B.fromRect(o);this.drawPath(M(i,{fill:e}));}startObject(o,e){this.objectLevel>0&&this.flushPath(),this.currentPaths=[],this.objectLevel++;}endObject(o,e){if(this.flushPath(),this.currentPaths=null,this.objectLevel--,this.objectLevel<0)throw new Error("More objects have ended than have been started (negative object nesting level)!")}getNestingLevel(){return this.objectLevel}canRenderFromWithoutDataLoss(o){return  false}renderFromOtherOfSameType(o,e){throw new Error(`Unable to render from ${e}: Not implemented`)}setTransform(o){this.selfTransform=o;}pushTransform(o){this.flushPath(),this.transformStack.push(this.selfTransform),this.setTransform(this.getCanvasToScreenTransform().rightMul(o));}popTransform(){if(this.transformStack.length===0)throw new Error("Unable to pop more transforms than have been pushed!");this.flushPath(),this.setTransform(this.transformStack.pop()??null);}getCanvasToScreenTransform(){return this.selfTransform?this.selfTransform:this.viewport.canvasToScreenTransform}canvasToScreen(o){return this.getCanvasToScreenTransform().transformVec2(o)}getSizeOfCanvasPixelOnScreen(){return this.getCanvasToScreenTransform().transformVec3(exports.Vec2.unitX).length()}visibleRectOverride;overrideVisibleRect(o){this.visibleRectOverride=o;}getVisibleRect(){return this.visibleRectOverride??this.viewport.visibleRect}};var xe=class s extends ve{constructor(e,i){super(i);this.ctx=e;this.setDraftMode(false);}ignoreObjectsAboveLevel=null;ignoringObject=false;currentObjectBBox=null;minSquareCurveApproxDist;minRenderSizeAnyDimen;minRenderSizeBothDimens;transformBy(e){this.ctx.transform(e.a1,e.b1,e.a2,e.b2,e.a3,e.b3);}canRenderFromWithoutDataLoss(e){return e instanceof s}renderFromOtherOfSameType(e,i){if(!(i instanceof s))throw new TypeError(`${i} cannot be rendered onto ${this}`);e=this.getCanvasToScreenTransform().rightMul(e),this.ctx.save(),this.transformBy(e),this.ctx.drawImage(i.ctx.canvas,0,0),this.ctx.restore();}setDraftMode(e){e?(this.minSquareCurveApproxDist=9,this.minRenderSizeBothDimens=1,this.minRenderSizeAnyDimen=.1):(this.minSquareCurveApproxDist=.5,this.minRenderSizeBothDimens=.1,this.minRenderSizeAnyDimen=1e-6);}displaySize(){return exports.Vec2.of(this.ctx.canvas.clientWidth,this.ctx.canvas.clientHeight)}clear(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore();}beginPath(e){e=this.canvasToScreen(e),this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y);}endPath(e){e.fill.a>0&&(this.ctx.fillStyle=e.fill.toHexString(),this.ctx.fill()),e.stroke&&(this.ctx.strokeStyle=e.stroke.color.toHexString(),this.ctx.lineWidth=this.getSizeOfCanvasPixelOnScreen()*e.stroke.width,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke(),this.ctx.lineWidth=1),this.ctx.closePath();}lineTo(e){e=this.canvasToScreen(e),this.ctx.lineTo(e.x,e.y);}moveTo(e){e=this.canvasToScreen(e),this.ctx.moveTo(e.x,e.y);}traceCubicBezierCurve(e,i,r){e=this.canvasToScreen(e),i=this.canvasToScreen(i),r=this.canvasToScreen(r);let n=i.minus(e),a=r.minus(i);n.magnitudeSquared()<this.minSquareCurveApproxDist&&a.magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(r.x,r.y):this.ctx.bezierCurveTo(e.x,e.y,i.x,i.y,r.x,r.y);}traceQuadraticBezierCurve(e,i){e=this.canvasToScreen(e),i=this.canvasToScreen(i),e.minus(i).magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(i.x,i.y):this.ctx.quadraticCurveTo(e.x,e.y,i.x,i.y);}drawPath(e){if(this.ignoringObject)return;let i=this.getVisibleRect();this.currentObjectBBox?.containsRect(i)&&(e=Xi(e,i)),super.drawPath(e);}drawText(e,i,r){this.ctx.save(),i=this.getCanvasToScreenTransform().rightMul(i),this.transformBy(i),Y.applyTextStyles(this.ctx,r),r.renderingStyle.fill.a!==0&&(this.ctx.fillStyle=r.renderingStyle.fill.toHexString(),this.ctx.fillText(e,0,0)),r.renderingStyle.stroke&&(this.ctx.strokeStyle=r.renderingStyle.stroke.color.toHexString(),this.ctx.lineWidth=r.renderingStyle.stroke.width,this.ctx.strokeText(e,0,0)),this.ctx.restore();}drawImage(e){if(e.image.width===0||e.image.height===0)return;this.ctx.save();let i=this.getCanvasToScreenTransform().rightMul(e.transform);this.transformBy(i),this.ctx.drawImage(e.image,0,0),this.ctx.restore();}clipLevels=[];startObject(e,i){if(this.isTooSmallToRender(e)&&(this.ignoreObjectsAboveLevel=this.getNestingLevel(),this.ignoringObject=true),super.startObject(e),this.currentObjectBBox=e,!this.ignoringObject&&i&&!e.containsRect(this.getVisibleRect())){this.clipLevels.push(this.objectLevel),this.ctx.save(),this.ctx.beginPath();for(let n of e.corners){let a=this.canvasToScreen(n);this.ctx.lineTo(a.x,a.y);}this.ctx.clip();}}endObject(){let e=this.objectLevel;this.currentObjectBBox=null,super.endObject(),!this.ignoringObject&&this.clipLevels.length>0&&this.clipLevels[this.clipLevels.length-1]===e&&(this.ctx.restore(),this.clipLevels.pop()),this.ignoreObjectsAboveLevel!==null&&this.getNestingLevel()<=this.ignoreObjectsAboveLevel&&(this.ignoreObjectsAboveLevel=null,this.ignoringObject=false);}drawWithRawRenderingContext(e){this.ctx.save(),this.transformBy(this.getCanvasToScreenTransform()),e(this.ctx),this.ctx.restore();}drawPoints(...e){for(let[r,n]of e.entries()){let a=this.canvasToScreen(n);this.ctx.beginPath(),this.ctx.arc(a.x,a.y,10,0,Math.PI*2),this.ctx.fillStyle=P.ofRGBA(.5+Math.sin(r)/2,1,.5+Math.cos(r*.2)/4,.5).toHexString(),this.ctx.lineWidth=2,this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.ctx.fillText(`${r}`,a.x,a.y,10*2);}}isTooSmallToRender(e){let i=e.size.times(this.getSizeOfCanvasPixelOnScreen()),r=this.minRenderSizeBothDimens,n=Math.abs(i.x)<r&&Math.abs(i.y)<r,a=this.minRenderSizeAnyDimen,l=Math.abs(i.x)<a||Math.abs(i.y)<a;return n||l}static fromViewport(e,i={}){let r=document.createElement("canvas"),n=e.getScreenRectSize(),a=i.canvasSize??n;i.maxCanvasDimen&&a.maximumEntryMagnitude()>i.maxCanvasDimen&&(a=a.times(i.maxCanvasDimen/a.maximumEntryMagnitude())),r.width=a.x,r.height=a.y;let l=r.getContext("2d"),c=Math.min(a.x/n.x,a.y/n.y);return l.scale(c,c),{renderer:new s(l,e),element:r}}};function Oa(s,o,e){let i=/^([\d.e-]+)px/i,r=i.exec(s.style?.fontSize??"");!r&&s.tagName.toLowerCase()==="tspan"&&s.parentElement&&(r=i.exec(s.parentElement.style?.fontSize??"")),!r&&o&&(r=i.exec(o.fontSize));let n=12;return r&&(e.add("fontSize"),n=Number.parseFloat(r[1])),n}var hs=Oa;async function Ha(s){s.complete||await new Promise((o,e)=>{s.addEventListener("load",i=>o(i)),s.onerror=i=>e(i),s.addEventListener("abort",i=>e(i));});}var ms=Ha;var ne=class s extends G{contentBBox;image;constructor(o){super("image-component"),this.image={...o,label:o.label??o.image.getAttribute("alt")??o.image.getAttribute("aria-label")??void 0},(i=>i.getAttribute("src")!==void 0)(o.image)&&!o.image.complete&&o.image.addEventListener("load",()=>this.recomputeBBox()),this.recomputeBBox();}getImageRect(){return new I(0,0,this.image.image.width,this.image.image.height)}recomputeBBox(){this.contentBBox=this.getImageRect(),this.contentBBox=this.contentBBox.transformedBoundingBox(this.image.transform);}static async fromImage(o,e){await ms(o);let i,r;typeof o.width=="number"&&typeof o.height=="number"&&o.width!==0&&o.height!==0?(i=o.width,r=o.height):(i=o.clientWidth,r=o.clientHeight);let n,a=o.src??"";if(a.startsWith("data:image/"))n=new Image,n.src=a,n.width=i,n.height=r;else {let l=document.createElement("canvas");l.width=i,l.height=r,l.getContext("2d").drawImage(o,0,0,l.width,l.height),a=l.toDataURL(),n=l;}return n.setAttribute("alt",o.getAttribute("alt")??""),n.setAttribute("aria-label",o.getAttribute("aria-label")??""),new s({image:n,base64Url:a,transform:e})}render(o,e){o.startObject(this.contentBBox),o.drawImage(this.image),o.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return 10}intersects(o){let i=this.getImageRect().getEdges().map(r=>r.transformedBy(this.image.transform));for(let r of i)if(r.intersects(o))return  true;return  false}applyTransformation(o){this.image.transform=o.rightMul(this.image.transform),this.recomputeBBox();}description(o){return this.image.label?o.imageNode(this.image.label):o.unlabeledImageNode}getAltText(){return this.image.label}getURL(){return this.image.base64Url}getTransformation(){return this.image.transform}createClone(){return new s({...this.image})}serializeToJSON(){return {src:this.image.base64Url,label:this.image.label,width:this.image.image.width,height:this.image.image.height,transform:this.image.transform.toArray()}}static deserializeFromJSON(o){if(typeof o.src!="string")throw new TypeError(`${o} has invalid format! Expected src property.`);He(o.transform),ze(o.width),ze(o.height);let e=new Image;e.src=o.src,e.width=o.width,e.height=o.height;let i=new w(...o.transform);return new s({image:e,base64Url:o.src,label:o.label,transform:i})}};G.registerComponent("image-component",ne.deserializeFromJSON);var fs="svg-global-attributes",Bt=class s extends G{contentBBox;attrs;constructor(o){super(fs),this.contentBBox=I.empty;let e=["viewBox","width","height"];this.attrs=o.filter(([i,r])=>!e.includes(i));}render(o,e){if(o instanceof ae)for(let[i,r]of this.attrs)o.setRootSVGAttribute(i,r);}intersects(o){return  false}applyTransformation(o){}isSelectable(){return  false}getSizingMode(){return 2}createClone(){return new s(this.attrs)}description(o){return o.svgObject}serializeToJSON(){return JSON.stringify(this.attrs)}static deserializeFromString(o){return new s([])}};G.registerComponent(fs,Bt.deserializeFromString);var gs="unknown-svg-object",at=class s extends G{constructor(e){super(gs);this.svgObject=e;this.contentBBox=I.of(e.getBoundingClientRect());}contentBBox;render(e,i){e instanceof ae&&(e.startObject(this.contentBBox),e.drawSVGElem(this.svgObject),e.endObject(this.getLoadSaveData()));}intersects(e){return this.contentBBox.getEdges().some(i=>i.intersection(e)!==null)}applyTransformation(e){}isSelectable(){return  false}getSizingMode(){return 2}createClone(){return new s(this.svgObject.cloneNode(true))}description(e){return e.svgObject}serializeToJSON(){return JSON.stringify({html:this.svgObject.outerHTML})}};G.registerComponent(gs,null);var Na=new I(0,0,500,500),Qr="svgAttrs",Jr="svgStyleAttrs",en="svgContainerID",Li="easydrawer--autoresize";var Xr=["stroke","fill","stroke-width"],Ge=class s{constructor(o,e,i){this.source=o;this.onFinish=e;this.plugins=i.plugins??[],this.storeUnknown=!(i.sanitize??false),this.disableUnknownObjectWarnings=!!i.disableUnknownObjectWarnings;}onAddComponent=null;onProgress=null;onDetermineExportRect=null;processedCount=0;totalToProcess=0;rootViewBox;storeUnknown;disableUnknownObjectWarnings;plugins;getStyle(o,e){let i=P.transparent,r,n=o.getAttribute("fill")??(e?.fill||o.style?.fill);if(n)try{i=P.fromString(n);}catch{console.error("Unknown fill color,",n);}let a=o.getAttribute("stroke")??e?.stroke??o.style?.stroke??"",l=o.getAttribute("stroke-width")??e?.strokeWidth??o.style?.strokeWidth??"";if(a&&l)try{let d=Number.parseFloat(l??"1");isFinite(d)||(d=0);let p=P.fromString(a);p.a>0&&(r={width:d,color:p});}catch(d){console.error("Error parsing stroke data:",d);}return {fill:i,stroke:r}}strokeDataFromElem(o){let e=[],i=o.getAttribute("d")??"",r=this.getStyle(o),n=i.split("M"),a=true;for(let l of n){let c=/^[\d\t\n ,.]+$/.exec(l);if(l!==""&&!c){let d=a?l:`M${l}`,p=B.fromString(d),u=M(p,r);e.push(u);}a=false;}return e}attachUnrecognisedAttrs(o,e,i,r){if(this.storeUnknown){for(let n of e.getAttributeNames())i.has(n)||n==="style"&&r||o.attachLoadSaveData(Qr,[n,e.getAttribute(n)]);if(r&&e.style)for(let n=0;n<e.style.length;n++){let a=e.style[n];a===""||!a||r.has(a)||o.attachLoadSaveData(Jr,{key:a,value:e.style.getPropertyValue(a),priority:e.style.getPropertyPriority(a)});}}}async addPath(o){let e;try{let i=this.strokeDataFromElem(o);e=new F(i),this.attachUnrecognisedAttrs(e,o,new Set([...Xr,"d"]),new Set(Xr));}catch(i){if(console.error("Invalid path in node",o,`
Error:`,i,`
Adding as an unknown object.`),this.storeUnknown)e=new at(o);else return}await this.addComponent(e);}async addBackground(o){if(o.classList.contains($r[1])){let e,i,r;if(o.tagName.toLowerCase()==="g"){if(o.children.length!==2){await this.addUnknownNode(o);return}let p=o.children[0],u=o.children[1];i=p.getAttribute("fill"),e=u.getAttribute("stroke"),r=u.getAttribute("stroke-width");}else i=o.getAttribute("fill"),e=o.getAttribute("stroke"),r=o.getAttribute("stroke-width");if(i??=P.transparent.toHexString(),!e){await this.addUnknownNode(o);return}let n;for(let p of o.classList)if(p.startsWith(xi)){let u=p.substring(xi.length);n=Number.parseFloat(u.replace(/p/g,"."));}let a;r&&(a=Number.parseFloat(r));let l=P.fromString(i),c=P.fromString(e);o.classList.contains(Wr)||(c=void 0);let d=ee.ofGrid(l,n,c,a);await this.addComponent(d);}else if(o.tagName.toLowerCase()==="path"){let e=P.fromString(o.getAttribute("fill")??o.style.fill??"black"),i=new ee(0,e);await this.addComponent(i);}else await this.addUnknownNode(o);}getComputedStyle(o){try{return window.getComputedStyle(o)}catch(e){console.warn("Error computing style",e);return}}getTransform(o,e,i){let r="data-highp-transform",n=o.getAttribute(r),a;if(n)try{a=w.fromCSSMatrix(n),e?.push(r);}catch(l){console.warn(`Unable to parse raw transform data, ${n}. Falling back to CSS data. Error:`,l);}if(!a){i??=this.getComputedStyle(o);let l=i?.transform;(!l||l==="none")&&(l=o.style?.transform||"none");try{a=w.fromCSSMatrix(o.style.transform);}catch(p){console.warn("matrix parse error",p),a=w.fromCSSMatrix(l);}let c=o.getAttribute("x"),d=o.getAttribute("y");if(c||d){let p=Number.parseFloat(c??"0"),u=Number.parseFloat(d??"0");!isNaN(p)&&!isNaN(u)&&(e?.push("x","y"),a=a.rightMul(w.translation(exports.Vec2.of(p,u))));}}return a}makeText(o){let e=[];for(let h of o.childNodes)if(h.nodeType===Node.TEXT_NODE)e.push(h.nodeValue??"");else if(h.nodeType===Node.ELEMENT_NODE){let m=h;if(m.tagName.toLowerCase()==="tspan")e.push(this.makeText(m));else throw new Error(`Unrecognized text child element: ${m}`)}else throw new Error(`Unrecognized text child node: ${h}.`);e.length===0&&e.push("");let i=this.getComputedStyle(o),r=new Set(["fontFamily","transform",...Xr]),n={size:hs(o,i,r),fontFamily:i?.fontFamily||o.style?.fontFamily||"sans-serif",fontWeight:i?.fontWeight||o.style?.fontWeight||void 0,fontStyle:i?.fontStyle||o.style?.fontStyle||void 0,renderingStyle:this.getStyle(o,i)},a=[],l=this.getTransform(o,a,i),c=0,d=o.getAttribute("dx");d&&(c=2,l=l.rightMul(w.translation(exports.Vec2.of(Number.parseFloat(d),0))),a.push("dx"));let p=o.getAttribute("dy");p&&(c===2?c=1:c=3,l=l.rightMul(w.translation(exports.Vec2.of(0,Number.parseFloat(p)))),a.push("dy"));let u=new Y(e,l,n,c);return this.attachUnrecognisedAttrs(u,o,new Set(a),new Set(r)),u}async addText(o){try{let e=this.makeText(o);await this.addComponent(e);}catch(e){console.error("Invalid text object in node",o,". Continuing.... Error:",e),this.addUnknownNode(o);}}async addImage(o){let e=new Image;e.src=o.getAttribute("xlink:href")??o.href.baseVal,e.setAttribute("alt",o.getAttribute("aria-label")??"");try{let i=[],r=this.getTransform(o,i),n=await ne.fromImage(e,r);this.attachUnrecognisedAttrs(n,o,new Set(i),new Set(["transform"])),await this.addComponent(n);}catch(i){console.error("Error loading image:",i,". Element: ",o,". Continuing..."),await this.addUnknownNode(o);}}async addUnknownNode(o){if(this.storeUnknown){let e=new at(o);await this.addComponent(e);}}containerGroupIDs=[];encounteredIDs=[];async startGroup(o){o=o.cloneNode(false);let e=o.id||`id-${this.encounteredIDs.length}`,i=0,r="";for(;this.encounteredIDs.includes(e+r);)i++,r="--"+i;e+=r,o.replaceChildren(),o.id=e;let n=new at(o);this.addComponent(n),this.containerGroupIDs.push(o.id),this.encounteredIDs.push(o.id);}async endGroup(){this.containerGroupIDs.pop();}async addComponent(o){this.containerGroupIDs.length>0&&o.attachLoadSaveData(en,[...this.containerGroupIDs]),await this.onAddComponent?.(o);}updateViewBox(o){let e=o.getAttribute("viewBox");if(this.rootViewBox||!e)return;let i=e.split(/[\t\n ,]+/),r=Number.parseFloat(i[0]),n=Number.parseFloat(i[1]),a=Number.parseFloat(i[2]),l=Number.parseFloat(i[3]);if(isNaN(r)||isNaN(n)||isNaN(a)||isNaN(l)){console.warn(`node ${o} has an unparsable viewbox. Viewbox: ${e}. Match: ${i}.`);return}let c=o.classList.contains(Li);this.rootViewBox=new I(r,n,a,l),this.onDetermineExportRect?.(this.rootViewBox,{autoresize:c});}async updateSVGAttrs(o){this.storeUnknown&&await this.onAddComponent?.(new Bt(this.getSourceAttrs(o)));}async visit(o){this.totalToProcess+=o.childElementCount;let e=true,i=async()=>{for(let n of this.plugins)if(await n.visit(o,{addComponent:l=>this.onAddComponent?.(l)}))return e=false,true;return  false},r=async()=>{switch(o.tagName.toLowerCase()){case "g":o.classList.contains(Tt)?(await this.addBackground(o),e=false):await this.startGroup(o);break;case "path":o.classList.contains(Tt)?await this.addBackground(o):await this.addPath(o);break;case "text":await this.addText(o),e=false;break;case "image":await this.addImage(o),e=false;break;case "svg":this.updateViewBox(o),this.updateSVGAttrs(o);break;case "style":o.getAttribute("id")!==To&&await this.addUnknownNode(o);break;default:this.disableUnknownObjectWarnings||(console.warn("Unknown SVG element,",o,o.tagName),o instanceof SVGElement||console.warn("Element",o,"is not an SVGElement!",this.storeUnknown?"Continuing anyway.":"Skipping.")),await this.addUnknownNode(o);return}};if(await i()?e=false:await r(),e){for(let n of o.children)await this.visit(n);o.tagName.toLowerCase()==="g"&&await this.endGroup();}this.processedCount++,await this.onProgress?.(this.processedCount,this.totalToProcess);}getSourceAttrs(o){return o.getAttributeNames().map(e=>[e,o.getAttribute(e)])}async start(o,e,i=null){this.onAddComponent=o,this.onProgress=e,this.onDetermineExportRect=i,this.totalToProcess=this.source.childElementCount,this.processedCount=0,this.rootViewBox=null,await this.visit(this.source),this.rootViewBox||this.onDetermineExportRect?.(Na),this.onFinish?.(),this.onFinish=null;}static fromString(o,e=false){let i=typeof e!="boolean"&&e?.loadMethod==="domparser",{svgElem:r,cleanUp:n}=(()=>{if(!i)try{let f=document.createElement("iframe");if(f.src="about:blank",f.setAttribute("sandbox","allow-same-origin"),f.setAttribute("csp","default-src 'about:blank'"),f.style.display="none",document.body.appendChild(f),!f.hasAttribute("sandbox"))throw f.remove(),new Error("SVG loading iframe is not sandboxed.");let g=f.contentWindow?.document??f.contentDocument;if(g==null)throw new Error("Unable to open a sandboxed iframe!");g.open(),g.write(`
						<!DOCTYPE html>
						<html>
							<head>
								<title>SVG Loading Sandbox</title>
								<meta name='viewport' conent='width=device-width,initial-scale=1.0'/>
								<meta charset='utf-8'/>
							</head>
							<body style='font-size: 12px;'>
								<script>
									console.error('JavaScript should not be able to run here!');
									throw new Error(
										'The SVG sandbox is broken! Please double-check the sandboxing setting.'
									);
								<\/script>
							</body>
						</html>
					`),g.close();let y=g.createElementNS("http://www.w3.org/2000/svg","svg");return y.innerHTML=o,g.body.appendChild(y),{svgElem:y,cleanUp:()=>{y.remove(),f.remove(),f.src="";}}}catch(f){console.warn("Failed loading SVG via a sandboxed iframe. Some styles may not be loaded correctly. Error: ",f);}let p=new DOMParser().parseFromString(`<svg xmlns="http://www.w3.org/2000/svg">${o}</svg>`,"text/html"),u=p.querySelector("svg"),h=p.querySelector("parsererror");if(h)throw new Error("Parse error: "+h.textContent);return {svgElem:u,cleanUp:()=>{}}})(),a,l,c;return typeof e=="boolean"?(a=e,l=false,c=[]):(a=e.sanitize??false,l=e.disableUnknownObjectWarnings??false,c=e.plugins),new s(r,n,{sanitize:a,disableUnknownObjectWarnings:l,plugins:c})}};function Ua(s,o){let e=s.length<o.length?s:o,i=e===s?o:s;for(let[r,n]of e.entries())if(n!==i[r])return  false;return  true}var bs=Ua;var To="easydrawer-style-sheet",lt="http://www.w3.org/2000/svg",tn={fontWeight:"400",fontStyle:"normal"},ae=class s extends ve{constructor(e,i,r=false){super(i);this.elem=e;this.sanitize=r;this.clear(),this.addStyleSheet();}lastPathStyle=null;lastPathString=[];lastContainerIDList=[];objectElems=null;overwrittenAttrs={};addStyleSheet(){if(!this.elem.querySelector(`#${To}`)){let e=document.createElementNS("http://www.w3.org/2000/svg","style");e.appendChild(document.createTextNode(`
				path {
					stroke-linecap: round;
					stroke-linejoin: round;
				}

				text {
					white-space: pre;
				}
			`.replace(/\s+/g,""))),e.setAttribute("id",To),this.elem.appendChild(e);}}setRootSVGAttribute(e,i){this.sanitize||(e in this.overwrittenAttrs||(this.overwrittenAttrs[e]=this.elem.getAttribute(e)),i!==null?this.elem.setAttribute(e,i):this.elem.removeAttribute(e));}displaySize(){return exports.Vec2.of(this.elem.clientWidth,this.elem.clientHeight)}clear(){if(this.lastPathString=[],this.lastContainerIDList=[],!this.sanitize){for(let e in this.overwrittenAttrs){let i=this.overwrittenAttrs[e];i?this.elem.setAttribute(e,i):this.elem.removeAttribute(e);}this.overwrittenAttrs={};}}addPathToSVG(){if(!this.lastPathStyle||this.lastPathString.length===0)return null;let e=document.createElementNS(lt,"path");e.setAttribute("d",this.lastPathString.join(" "));let i=this.lastPathStyle;return i.fill.a>0?e.setAttribute("fill",i.fill.toHexString()):e.setAttribute("fill","none"),i.stroke&&(e.setAttribute("stroke",i.stroke.color.toHexString()),e.setAttribute("stroke-width",ie(i.stroke.width*this.getSizeOfCanvasPixelOnScreen()))),this.elem.appendChild(e),this.objectElems?.push(e),e}drawPath(e){let i=e.style,r=Ye(e).transformedBy(this.getCanvasToScreenTransform());(this.lastPathString.length===0||!this.lastPathStyle||!Yo(this.lastPathStyle,i))&&(this.addPathToSVG(),this.lastPathStyle=i,this.lastPathString=[]),this.lastPathString.push(r.toString());}transformFrom(e,i,r=false){let n=r?e:this.getCanvasToScreenTransform().rightMul(e);if(n.eq(w.identity))i.style.transform="";else {let a=n.toCSSMatrix();i.style.transform=a,i.setAttribute("data-highp-transform",a);}}textContainer=null;textContainerTransform=null;textParentStyle=tn;drawText(e,i,r){let n=(a,l)=>{l.fontFamily!==this.textParentStyle?.fontFamily&&(a.style.fontFamily=l.fontFamily),l.fontVariant!==this.textParentStyle?.fontVariant&&(a.style.fontVariant=l.fontVariant??""),l.fontWeight!==this.textParentStyle?.fontWeight&&(a.style.fontWeight=l.fontWeight??""),l.fontStyle!==this.textParentStyle?.fontStyle&&(a.style.fontStyle=l.fontStyle??""),l.size!==this.textParentStyle?.size&&(a.style.fontSize=l.size+"px");let c=l.renderingStyle.fill.toHexString();if(a.style.fill=c,l.renderingStyle.stroke){let d=l.renderingStyle.stroke;a.style.stroke=d.color.toHexString(),a.style.strokeWidth=d.width+"px";}};if(i=this.getCanvasToScreenTransform().rightMul(i),this.textContainer){let a=document.createElementNS(lt,"tspan");a.appendChild(document.createTextNode(e)),this.textContainer.appendChild(a),i=this.textContainerTransform.inverse().rightMul(i);let l=i.transformVec2(exports.Vec2.zero);a.setAttribute("x",`${ie(l.x)}`),a.setAttribute("y",`${ie(l.y)}`),n(a,r);}else {let a=document.createElementNS(lt,"text");a.appendChild(document.createTextNode(e)),this.transformFrom(i,a,true),n(a,r),this.elem.appendChild(a),this.objectElems?.push(a),this.objectLevel>0&&(this.textContainer=a,this.textContainerTransform=i,this.textParentStyle={...tn,...r});}}drawImage(e){let i=e.label??e.image.getAttribute("aria-label")??"";i===""&&(i=e.image.getAttribute("alt")??"");let r=document.createElementNS(lt,"image");r.setAttribute("href",e.base64Url),r.setAttribute("width",e.image.getAttribute("width")??""),r.setAttribute("height",e.image.getAttribute("height")??""),r.setAttribute("aria-label",i),this.transformFrom(e.transform,r),this.elem.appendChild(r),this.objectElems?.push(r);}startObject(e){super.startObject(e),this.lastPathString=[],this.lastPathStyle=null,this.textContainer=null,this.textParentStyle=tn,this.objectElems=[];}endObject(e,i){if(super.endObject(e),this.addPathToSVG(),!!this.objectElems){if(e&&!this.sanitize){for(let a of this.objectElems){let l=e[Qr],c=e[Jr];if(l)for(let[d,p]of l)a.setAttribute(d,p);if(c)for(let d of c)a.style.setProperty(d.key,d.value,d.priority);}let r=e[en],n=[];if(r&&r[0]&&r[0].length>0&&(n=r[0]),n.length>0&&bs(this.lastContainerIDList,n)&&this.lastContainerIDList.length>=n.length-1){let a=n[n.length-1],l=this.elem.querySelectorAll(`g#${a}`);if(l.length>0){let c=l[0];if(c.children.length===0||this.lastContainerIDList.length>=n.length)for(let d of this.objectElems)d.remove(),c.appendChild(d);else n=[];}}else n=[];this.lastContainerIDList=n;}if(i&&this.objectElems)if(this.objectElems.length===1)this.objectElems[0].classList.add(...i);else {let r=document.createElementNS(lt,"g");r.classList.add(...i);for(let n of this.objectElems)n.remove(),r.appendChild(n);this.elem.appendChild(r);}}}unimplementedMessage(){throw new Error("Not implemenented!")}beginPath(e){this.unimplementedMessage();}endPath(e){this.unimplementedMessage();}lineTo(e){this.unimplementedMessage();}moveTo(e){this.unimplementedMessage();}traceCubicBezierCurve(e,i,r){this.unimplementedMessage();}traceQuadraticBezierCurve(e,i){this.unimplementedMessage();}drawPoints(...e){e.map(i=>{let r=document.createElementNS(lt,"circle");r.setAttribute("cx",`${i.x}`),r.setAttribute("cy",`${i.y}`),r.setAttribute("r","15"),this.elem.appendChild(r);});}drawSVGElem(e){if(this.sanitize||e.tagName.toLowerCase()==="style"&&e.getAttribute("id")===To)return;let i=e.cloneNode(true);this.elem.appendChild(i),this.objectElems?.push(i);}drawWithSVGParent(e){let i=document.createElementNS(lt,"g");this.transformFrom(w.identity,i,true),e(i,{sanitize:this.sanitize}),this.elem.appendChild(i),this.objectElems?.push(i);}isTooSmallToRender(e){return  false}static fromViewport(e,i=true){let r,n;typeof i=="boolean"?(r=i,n=false):(r=i.sanitize??true,n=i.useViewBoxForPositioning??false);let a="http://www.w3.org/2000/svg",l=document.createElementNS(a,"svg"),c=e.getScreenRectSize(),d=e.visibleRect,p;if(n){let h=e.visibleRect;p=[h.x,h.y,h.w,h.h],e=e.getTemporaryClone(),e.resetTransform(w.identity);}else p=[0,0,c.x,c.y];l.setAttribute("viewBox",p.map(h=>ie(h)).join(" ")),l.setAttribute("width",ie(c.x)),l.setAttribute("height",ie(c.y)),l.setAttribute("version","1.1"),l.setAttribute("baseProfile","full"),l.setAttribute("xmlns",a);let u=new s(l,e,r);return d.eq(e.visibleRect)||u.overrideVisibleRect(d),{element:l,renderer:u}}};var le="selection-tool-";var ce=class extends H{constructor(e,i){super(e.notifier,i);this.editor=e;this.modeValue=Z.fromInitialValue("rect"),this.modeValue.onUpdate(()=>{this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.autoscroller=new Co(e.viewport,r=>{if(e.dispatch(A.transformBy(w.translation(r)),false),this.lastPointer){let n=this.lastPointer.withScreenPosition(this.lastPointer.screenPos,e.viewport);this.onMainPointerUpdated(n);}}),this.handleOverlay=document.createElement("div"),e.createHTMLOverlay(this.handleOverlay),this.handleOverlay.style.display="none",this.handleOverlay.classList.add("handleOverlay"),e.notifier.on(7,r=>{this.editor.clearWetInk(),this.expandingSelectionBox||this.selectionBox?.padRegion(),this.selectionBox?.updateUI();}),this.editor.handleKeyEventsFrom(this.handleOverlay),this.editor.handlePointerEventsFrom(this.handleOverlay);}modeValue;selectionBuilder;handleOverlay;prevSelectionBox;selectionBox;removeSelectionScheduled=false;startPoint=null;expandingSelectionBox=false;shiftKeyPressed=false;snapToGrid=false;lastPointer=null;autoscroller;getSelectionColor(){let e=getComputedStyle(this.handleOverlay).getPropertyValue("--selection-background-color");return P.fromString(e).withAlpha(.5)}makeSelectionBox(e){this.prevSelectionBox=this.selectionBox,this.selectionBox=new vo(e,this.editor,this.showContextMenu),this.expandingSelectionBox||this.prevSelectionBox?.cancelSelection(),this.selectionBox.addTo(this.handleOverlay);}showContextMenu=async(e,i=true)=>{await ps(this.selectionBox,this.editor,e,i,()=>this.clearSelection());};onContextMenu(e){let i=this.selectionBox?.getScreenRegion()?.containsPoint(e.screenPos);return this.showContextMenu(e.canvasPos,i),true}selectionBoxHandlingEvt=false;onPointerDown({allPointers:e,current:i}){let r=this.snapToGrid;if(r&&(i=i.snappedToGrid(this.editor.viewport)),e.length===1){this.startPoint=i.canvasPos;let n=false;return this.selectionBox&&(r&&this.selectionBox.snapSelectedObjectsToGrid(),this.selectionBox.onDragStart(i)&&(n=true,this.selectionBoxHandlingEvt=true,this.expandingSelectionBox=false)),n?this.autoscroller.start():(this.expandingSelectionBox=this.shiftKeyPressed,this.removeSelectionScheduled=!this.expandingSelectionBox,this.modeValue.get()==="lasso"?this.selectionBuilder=new xo(i.canvasPos,this.editor.viewport):this.selectionBuilder=new So(i.canvasPos)),true}return  false}onPointerMove(e){this.onMainPointerUpdated(e.current);}onMainPointerUpdated(e){if(this.lastPointer=e,this.removeSelectionScheduled&&(this.removeSelectionScheduled=false,this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null),this.autoscroller.onPointerMove(e.screenPos),!this.expandingSelectionBox&&this.shiftKeyPressed&&this.startPoint){let i=this.editor.viewport.canvasToScreen(this.startPoint);e=e.lockedToXYAxesScreen(i,this.editor.viewport);}this.snapToGrid&&(e=e.snappedToGrid(this.editor.viewport)),this.selectionBoxHandlingEvt?this.selectionBox?.onDragUpdate(e):(this.selectionBuilder?.onPointerMove(e.canvasPos),this.editor.clearWetInk(),this.selectionBuilder?.render(this.editor.display.getWetInkRenderer(),this.getSelectionColor()));}onPointerUp(e){if(this.onMainPointerUpdated(e.current),this.autoscroller.stop(),this.selectionBoxHandlingEvt)this.selectionBox?.onDragEnd();else if(this.selectionBuilder){let i=this.selectionBuilder.resolve(this.editor.image,this.editor.viewport);this.selectionBuilder=null,this.editor.clearWetInk(),this.expandingSelectionBox&&this.selectionBox?this.setSelection([...this.selectionBox.getSelectedObjects(),...i]):this.setSelection(i);}this.expandingSelectionBox=false,this.removeSelectionScheduled=false,this.selectionBoxHandlingEvt=false,this.lastPointer=null;}onGestureCancel(){this.selectionBuilder&&(this.selectionBuilder=null,this.editor.clearWetInk()),this.autoscroller.stop(),this.selectionBoxHandlingEvt?this.selectionBox?.onDragCancel():this.removeSelectionScheduled||(this.selectionBox?.cancelSelection(),this.selectionBox=this.prevSelectionBox,this.selectionBox?.addTo(this.handleOverlay),this.selectionBox?.recomputeRegion(),this.prevSelectionBox=null),this.removeSelectionScheduled=false,this.expandingSelectionBox=false,this.lastPointer=null,this.selectionBoxHandlingEvt=false;}lastSelectedObjects=[];onSelectionUpdated(){let e=this.selectionBox?.getSelectedItemCount()??0,i=this.selectionBox?.getSelectedObjects()??[];(this.lastSelectedObjects.length!==e||i.some((n,a)=>this.lastSelectedObjects[a]!==n))&&(this.lastSelectedObjects=i,this.editor.notifier.dispatch(2,{kind:2,tool:this}),this.editor.notifier.dispatch(9,{kind:9,selectedComponents:i,tool:this}),e>0&&this.editor.announceForAccessibility(this.editor.localization.selectedElements(e))),e===0&&this.selectionBox&&(this.selectionBox.cancelSelection(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null);}zoomToSelection(){if(this.selectionBox){let e=this.selectionBox.region;this.editor.dispatchNoAnnounce(this.editor.viewport.zoomTo(e,false),false);}}hasUnfinalizedTransformFromKeyPress=false;onKeyPress(e){let i=this.editor.shortcuts;if(i.matchesShortcut(St,e))return this.snapToGrid=true,true;if(this.selectionBox&&(i.matchesShortcut(mi,e)||i.matchesShortcut(fi,e)))return  true;if(i.matchesShortcut(xt,e))return this.setSelection(this.editor.image.getAllComponents()),true;if(e.ctrlKey)return  false;if((e.shiftKey||e.key==="Shift")&&(this.shiftKeyPressed=true,e.key==="Shift"))return  true;let r=0,n=0,a=0,l=0,c=0;i.matchesShortcut(yr,e)?n-=1:i.matchesShortcut(vr,e)?n+=1:i.matchesShortcut(xr,e)?a-=1:i.matchesShortcut(Sr,e)?a+=1:i.matchesShortcut(Tr,e)?r+=1:i.matchesShortcut(Cr,e)?r-=1:i.matchesShortcut(wr,e)?l-=1:i.matchesShortcut(Pr,e)?l+=1:i.matchesShortcut(Er,e)?c-=1:i.matchesShortcut(Ir,e)?c+=1:i.matchesShortcut(kr,e)?(l-=1,c-=1):i.matchesShortcut(Rr,e)&&(l+=1,c+=1);let d=n!==0||a!==0||r!==0||l!==0||c!==0;if(!this.selectionBox)d=false;else if(d){let p=10*this.editor.viewport.getSizeOfPixelOnCanvas(),u=Math.PI/8,h=5/4,m=this.selectionBox.region,f=exports.Vec2.of(h**l,h**c),y=w.zRotation(r*u).mapEntries(T=>A.roundScaleRatio(T)),v=this.editor.viewport.roundPoint(m.center),b=w.scaling2D(f,this.editor.viewport.roundPoint(m.topLeft)).rightMul(w.translation(v).rightMul(y).rightMul(w.translation(v.times(-1)))).rightMul(w.translation(this.editor.viewport.roundPoint(exports.Vec2.of(n,a).times(p)))),S=this.selectionBox.getTransform();this.selectionBox.setTransform(S.rightMul(b)),this.selectionBox.scrollTo(),this.hasUnfinalizedTransformFromKeyPress=true;}return this.selectionBox&&!d&&(e.key==="Delete"||e.key==="Backspace")&&(this.editor.dispatch(this.selectionBox.deleteSelectedObjects()),this.clearSelection(),d=true),d}onKeyUp(e){let i=this.editor.shortcuts;if(i.matchesShortcut(St,e))return this.snapToGrid=false,true;if(i.matchesShortcut(xt,e))return  true;if(this.selectionBox&&i.matchesShortcut(mi,e))return this.selectionBox.duplicateSelectedObjects().then(r=>{this.editor.dispatch(r);}),true;if(this.selectionBox&&i.matchesShortcut(fi,e)){let r=this.selectionBox.sendToBack();return r&&this.editor.dispatch(r),true}return e.shiftKey===false&&(this.shiftKeyPressed=false),e.key==="Shift"?(this.shiftKeyPressed=false,true):this.hasUnfinalizedTransformFromKeyPress?this.selectionBox?(this.selectionBox.finalizeTransform(),this.hasUnfinalizedTransformFromKeyPress=false,true):false:true}onCopy(e){if(!this.selectionBox)return  false;let i=this.selectionBox.getSelectedObjects(),r=this.selectionBox.region;if(i.length===0)return  false;let n=new A(()=>{}),l=this.selectionBox.getScreenRegion().size.times(this.editor.display.getDevicePixelRatio()).maximumEntryMagnitude()/(r.size.maximumEntryMagnitude()||1);l=Math.pow(2,Math.ceil(Math.log2(l))),n.updateScreenSize(r.size.times(l)),n.resetTransform(w.scaling2D(l).rightMul(w.translation(r.topLeft.times(-1))));let{element:c,renderer:d}=ae.fromViewport(n,{sanitize:true,useViewBoxForPositioning:true}),{element:p,renderer:u}=xe.fromViewport(n,{maxCanvasDimen:4096}),h=[];for(let m of i)m.render(d),m.render(u),m instanceof Y&&h.push(m.getText());return e.setData("image/svg+xml",c.outerHTML),e.setData("text/html",c.outerHTML),e.setData("image/png",new Promise((m,f)=>{p.toBlob(g=>{g?m(g):f(new Error("Failed to convert canvas to blob."));},"image/png");})),h.length>0&&e.setData("text/plain",h.join(`
`)),true}setEnabled(e){let i=this.isEnabled();super.setEnabled(e),i!==e&&(this.selectionBox?.cancelSelection(),this.onSelectionUpdated(),this.handleOverlay.replaceChildren(),this.selectionBox=null,this.shiftKeyPressed=false,this.snapToGrid=false,this.handleOverlay.style.display=e?"block":"none",e?(this.handleOverlay.tabIndex=0,this.handleOverlay.role="group",this.handleOverlay.ariaLabel=this.editor.localization.selectionToolKeyboardShortcuts):this.handleOverlay.tabIndex=-1);}getSelection(){return this.selectionBox}isSelecting(){return !!this.selectionBuilder}getSelectedObjects(){return this.selectionBox?.getSelectedObjects()??[]}setSelection(e){e=e.filter(r=>r.isSelectable()),e.sort((r,n)=>r.getZIndex()-n.getZIndex()),e=e.filter((r,n)=>n>0?r!==e[n-1]:true);let i=null;for(let r of e)i?i=i.union(r.getBBox()):i=r.getBBox();this.clearSelectionNoUpdateEvent(),i&&this.makeSelectionBox(e),this.onSelectionUpdated();}clearSelectionNoUpdateEvent(){this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null;}clearSelection(){this.clearSelectionNoUpdateEvent(),this.onSelectionUpdated();}};function Wa(s,o,e){let i=document.createElement("div");i.classList.add("selection-format-menu",`${L}spacedList`,`${L}indentedList`);let r=document.createElement("div"),n=document.createElement("label"),a=Ee(s,p=>{let u=o.getSelection();if(u){let h=[];for(let f of u.getSelectedObjects())ti(f)&&h.push(f.updateStyle({color:p}));let m=J(h);s.dispatch(m);}}),{input:l,container:c}=a;n.innerText=e.colorLabel;let d=()=>{let p=o.getSelection();if(p&&p.getSelectedItemCount()>0){l.disabled=false,i.classList.remove("disabled");let u=[];for(let h of p.getSelectedObjects())if(ti(h)){let m=h.getStyle().color;m&&u.push(m);}a.setValue(P.average(u));}else l.disabled=true,i.classList.add("disabled"),a.setValue(P.transparent);};return r.replaceChildren(n,c),i.replaceChildren(r),{addTo:p=>{p.appendChild(i);},update:d,registerHelpText:p=>{p.registerTextHelpForElement(r,e.selectionDropdown__changeColorHelpText),a.registerWithHelpTextDisplay(p);}}}var on=class extends Q{constructor(e,i,r){super(e,"selection-mode-toggle",r);this.tool=i;e.notifier.on(2,n=>{n.kind===2&&n.tool===i&&this.setSelected(i.modeValue.get()==="lasso");}),this.setSelected(false);}shouldAutoDisableInReadOnlyEditor(){return  false}setModeFlag(e){this.tool.modeValue.set(e?"lasso":"rect");}handleClick(){this.setModeFlag(!this.isSelected());}getTitle(){return this.localizationTable.selectionTool__lassoSelect}createIcon(){return this.editor.icons.makeSelectionIcon("lasso")}fillDropdown(e){return  false}getHelpText(){return this.localizationTable.selectionTool__lassoSelect__help}},At=class extends re{constructor(e,i,r){super(e,i,"selection-tool-widget",r);this.tool=i;this.addSubWidget(new on(e,i,this.localizationTable));let n=()=>{let a=this.tool.getSelection();return !!a&&a.getSelectedItemCount()>0};this.hasSelectionValue=Z.fromInitialValue(n()),this.editor.notifier.on(2,a=>{if(a.kind!==2)throw new Error("Invalid event type!");a.tool===this.tool&&(this.hasSelectionValue.set(n()),this.updateFormatMenu());}),i.modeValue.onUpdate(()=>{this.updateIcon();});}updateFormatMenu=()=>{};hasSelectionValue;resizeImageToSelection(){let e=this.tool.getSelection();e&&this.editor.dispatch(this.editor.setImportExportRect(e.region));}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(ur,e)?(this.resizeImageToSelection(),true):!!super.onKeyPress(e)}getTitle(){return this.localizationTable.select}createIcon(){return this.editor.icons.makeSelectionIcon(this.tool.modeValue.get())}getHelpText(){return this.localizationTable.selectionDropdown__baseHelpText}createSelectionActions(e){let i=this.editor.icons;return {container:as([{icon:()=>i.makeDeleteSelectionIcon(),label:this.localizationTable.deleteSelection,onCreated:n=>{e?.registerTextHelpForElement(n,this.localizationTable.selectionDropdown__deleteHelpText);},onClick:()=>{let n=this.tool.getSelection();this.editor.dispatch(n.deleteSelectedObjects()),this.tool.clearSelection();},enabled:this.hasSelectionValue},{icon:()=>i.makeDuplicateSelectionIcon(),label:this.localizationTable.duplicateSelection,onCreated:n=>{e?.registerTextHelpForElement(n,this.localizationTable.selectionDropdown__duplicateHelpText);},onClick:async()=>{let a=await this.tool.getSelection()?.duplicateSelectedObjects();a&&this.editor.dispatch(a);},enabled:this.hasSelectionValue},{icon:()=>i.makeResizeImageToSelectionIcon(),label:this.localizationTable.resizeImageToSelection,onCreated:n=>{e?.registerTextHelpForElement(n,this.localizationTable.selectionDropdown__resizeToHelpText);},onClick:()=>{this.resizeImageToSelection();},enabled:this.hasSelectionValue}],3).container}}fillDropdown(e,i){super.fillDropdown(e,i);let r=document.createElement("div");r.classList.add(`${L}nonbutton-controls-main-list`),e.appendChild(r),go().addTo(r);let n=this.createSelectionActions(i);r.appendChild(n.container),go(this.localizationTable.reformatSelection).addTo(r);let a=Wa(this.editor,this.tool,this.localizationTable);return a.addTo(r),this.updateFormatMenu=()=>a.update(),i&&a.registerHelpText(i),a.update(),true}serializeState(){return {...super.serializeState(),selectionMode:this.tool.modeValue.get()}}deserializeFrom(e){super.deserializeFrom(e),Object.values(yo).includes(e.selectionMode)&&this.tool.modeValue.set(e.selectionMode);}};var Dt=class s extends re{constructor(e,i,r){super(e,i,"text-tool-widget",r);this.tool=i;e.notifier.on(2,n=>{n.kind===2&&n.tool===i&&(this.updateIcon(),this.updateDropdownInputs?.());});}updateDropdownInputs=null;getTitle(){return this.targetTool.description}createIcon(){let e=this.tool.getTextStyle();return this.editor.icons.makeTextIcon(e)}static idCounter=0;fillDropdown(e){let i=document.createElement("div");i.classList.add(`${L}spacedList`,`${L}nonbutton-controls-main-list`);let r=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div"),l=document.createElement("select"),c=document.createElement("label"),d=document.createElement("input"),p=document.createElement("label"),{input:u,container:h,setValue:m}=Ee(this.editor,b=>{this.tool.setColor(b);}),f=document.createElement("label"),g=new Set,y=b=>{let S=document.createElement("option");S.value=b,S.textContent=b,l.appendChild(S),g.add(b);};d.setAttribute("type","number"),d.min="1",d.max="128",c.innerText=this.localizationTable.fontLabel,f.innerText=this.localizationTable.colorLabel,p.innerText=this.localizationTable.textSize,u.id=`${L}-text-color-input-${s.idCounter++}`,f.setAttribute("for",u.id),d.id=`${L}-text-size-input-${s.idCounter++}`,p.setAttribute("for",d.id);let v=this.editor.getCurrentSettings().text?.fonts??[];for(let b of v)y(b);return l.classList.add("font-selector"),l.id=`${L}-text-font-input-${s.idCounter++}`,c.setAttribute("for",l.id),l.addEventListener("change",()=>{this.tool.setFontFamily(l.value);}),d.addEventListener("change",()=>{let b=Number.parseInt(d.value);!isNaN(b)&&b>0&&this.tool.setFontSize(b);}),n.appendChild(f),n.appendChild(h),r.appendChild(c),r.appendChild(l),a.appendChild(p),a.appendChild(d),this.updateDropdownInputs=()=>{let b=this.tool.getTextStyle();m(b.renderingStyle.fill),g.has(b.fontFamily)||y(b.fontFamily),l.value=b.fontFamily,d.value=`${b.size}`;},this.updateDropdownInputs(),i.replaceChildren(n,a,r),e.appendChild(i),true}serializeState(){let e=this.tool.getTextStyle();return {...super.serializeState(),fontFamily:e.fontFamily,textSize:e.size,color:e.renderingStyle.fill.toHexString()}}deserializeFrom(e){e.fontFamily&&typeof e.fontFamily=="string"&&this.tool.setFontFamily(e.fontFamily),e.color&&typeof e.color=="string"&&this.tool.setColor(P.fromHex(e.color)),e.textSize&&typeof e.textSize=="number"&&this.tool.setFontSize(e.textSize),super.deserializeFrom(e);}};var Me=class extends H{constructor(e,i,r){super(e.notifier,i);this.editor=e;this.styleValue=N.fromInitialValue({factory:fe,color:P.blue,thickness:1.5,...r}),this.styleValue.onUpdateAndNow(n=>{this.style=n,this.noteUpdated();});}builder=null;lastPoint=null;startPoint=null;currentDeviceType=null;currentPointerId=null;styleValue;style;shapeAutocompletionEnabled=false;pressureSensitivityEnabled=true;autocorrectedShape=null;lastAutocorrectedShape=null;removedAutocorrectedShapeTime=0;stationaryDetector=null;getPressureMultiplier(){let e=this.style.thickness;return 1/this.editor.viewport.getScaleFactor()*e}toStrokePoint(e){let n=Math.max(e.pressure??1,.3);isFinite(n)||(console.warn("Non-finite pressure!",e),n=.3),console.assert(isFinite(e.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(e.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(e.timeStamp),"Non-finite timeStamp on pointer!");let a=e.canvasPos;return this.getPressureSensitivityEnabled()||(n=.5),{pos:a,width:n*this.getPressureMultiplier(),color:this.style.color,time:e.timeStamp}}setPressureSensitivityEnabled(e){e!==this.pressureSensitivityEnabled&&(this.pressureSensitivityEnabled=e,this.noteUpdated());}getPressureSensitivityEnabled(){return this.pressureSensitivityEnabled}previewStroke(){this.editor.clearWetInk();let e=this.editor.display.getWetInkRenderer();if(this.autocorrectedShape){let i=this.editor.viewport.visibleRect;this.autocorrectedShape.render(e,i);}else this.builder?.preview(e);}addPointToStroke(e){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(e),this.lastPoint=e,this.previewStroke();}onPointerDown(e){if(this.builder&&!this.eventCanCancelStroke(e))return  true;let{current:i,allPointers:r}=e,n=i.device===1,a=i.device===0;return r.length===1&&!n||a?(this.startPoint=this.toStrokePoint(i),this.builder=this.style.factory(this.startPoint,this.editor.viewport),this.currentDeviceType=i.device,this.currentPointerId=i.id,this.shapeAutocompletionEnabled?this.stationaryDetector=new De(i,Ct,l=>this.autocorrectShape(l)):this.stationaryDetector=null,this.lastAutocorrectedShape=null,this.removedAutocorrectedShapeTime=0,true):false}eventCanCancelStroke(e){let i=this.lastPoint?.time??0;if(e.current.timeStamp-i>1e3)return  true;let r=this.currentDeviceType===0,n=e.current.device===2;return !(r&&n)}eventCanBeDeliveredToNonActiveTool(e){return this.eventCanCancelStroke(e)}onPointerMove({current:e}){if(!this.builder||e.device!==this.currentDeviceType||e.id!==this.currentPointerId)return;this.stationaryDetector?.onPointerMove(e)||(this.addPointToStroke(this.toStrokePoint(e)),this.autocorrectedShape&&(this.removedAutocorrectedShapeTime=performance.now(),this.autocorrectedShape=null,this.editor.announceForAccessibility(this.editor.localization.autocorrectionCanceled)));}onPointerUp({current:e}){if(!this.builder)return  false;if(e.id!==this.currentPointerId)return  true;this.stationaryDetector?.onPointerUp(e);let i=this.toStrokePoint(e),r={...i,width:this.lastPoint?.width??i.width};return this.addPointToStroke(r),this.finalizeStroke(),false}onGestureCancel(){this.builder=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}removedAutocorrectedShapeRecently(){return this.removedAutocorrectedShapeTime>performance.now()-320}async autocorrectShape(e){if(!this.builder||!this.builder.autocorrectShape||!this.shapeAutocompletionEnabled||this.autocorrectedShape)return;let i=await this.builder.autocorrectShape();if(!this.builder||!i)return;let r=i.getBBox().area;if(r===0||!isFinite(r))return;let n=i.description(this.editor.localization);this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(n)),this.autocorrectedShape=i,this.lastAutocorrectedShape=i,this.previewStroke();}finalizeStroke(){if(this.builder){this.lastAutocorrectedShape&&this.removedAutocorrectedShapeRecently()&&(this.autocorrectedShape=this.lastAutocorrectedShape);let e=this.autocorrectedShape??this.builder.build();if(this.previewStroke(),e.getBBox().area>0){e===this.autocorrectedShape&&this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(e.description(this.editor.localization)));let r=K.addComponent(e,true);this.editor.dispatch(r);}else console.warn("Pen: Not adding empty stroke",e,"to the canvas.");}this.builder=null,this.lastPoint=null,this.autocorrectedShape=null,this.lastAutocorrectedShape=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}noteUpdated(){this.editor.notifier.dispatch(2,{kind:2,tool:this});}setColor(e){e.toHexString()!==this.style.color.toHexString()&&this.styleValue.set({...this.style,color:e});}setThickness(e){e!==this.style.thickness&&this.styleValue.set({...this.style,thickness:e});}setStrokeFactory(e){e!==this.style.factory&&this.styleValue.set({...this.style,factory:e});}setHasStabilization(e){let i=!!this.getInputMapper();e!==i&&(i?this.setInputMapper(null):this.setInputMapper(new tt(this.editor.viewport)),this.noteUpdated());}setStrokeAutocorrectEnabled(e){e!==this.shapeAutocompletionEnabled&&(this.shapeAutocompletionEnabled=e,this.noteUpdated());}getStrokeAutocorrectionEnabled(){return this.shapeAutocompletionEnabled}getThickness(){return this.style.thickness}getColor(){return this.style.color}getStrokeFactory(){return this.style.factory}getStyleValue(){return this.styleValue}onKeyPress(e){let i=this.editor.shortcuts,r=i.matchesShortcut(ot,e);if(this.builder&&r)return this.finalizeStroke(),false;let n;return i.matchesShortcut(rt,e)?n=this.getThickness()*2/3:i.matchesShortcut(it,e)&&(n=this.getThickness()*3/2),n!==void 0?(n=Math.min(Math.max(1,n),256),this.setThickness(n),true):false}};var ys="textEditorOverlay",ke=class extends H{constructor(e,i,r){super(e.notifier,i);this.editor=e;this.localizationTable=r;let n=e.getCurrentSettings().text?.fonts??[];this.textStyleValue=N.fromInitialValue({size:32,fontFamily:n.length>0?n[0]:"sans-serif",renderingStyle:{fill:P.black}}),this.textStyleValue.onUpdateAndNow(()=>{this.textStyle=this.textStyleValue.get(),this.updateTextInput(),this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.contentTransform=N.fromInitialValue(w.identity),this.textEditOverlay=document.createElement("div"),this.textEditOverlay.classList.add(ys),this.editor.addStyleSheet(`
			.${ys} textarea {
				background-color: rgba(0, 0, 0, 0.1);

				white-space: pre;
				overflow: hidden;

				padding: 8px;
				margin: 0;

				min-width: 100px;
				min-height: 1.1em;
        border: 1px solid black;
        border-radius: 6px;
			}
		`),this.anchorControl=this.editor.anchorElementToCanvas(this.textEditOverlay,this.contentTransform);}textStyleValue;textStyle;anchorControl;contentTransform;textEditOverlay;textInputElem=null;textMeasuringCtx=null;removeExistingCommand=null;initTextMeasuringCanvas(){this.textMeasuringCtx??=document.createElement("canvas").getContext("2d");}getTextAscent(e,i){if(this.initTextMeasuringCanvas(),this.textMeasuringCtx){this.textMeasuringCtx.textBaseline="alphabetic",Y.applyTextStyles(this.textMeasuringCtx,i);let r=this.textMeasuringCtx.measureText(e);return r.fontBoundingBoxAscent??r.actualBoundingBoxAscent}return i.size*2/3}flushInput(e=true){if(!this.textInputElem)return;let i=this.textEditOverlay.parentElement,r=exports.Vec2.of(i?.scrollLeft??0,i?.scrollTop??0),n=this.textInputElem.value.trimEnd();if(this.textInputElem.value="",e){let a=this.textInputElem;this.textInputElem=null,a.remove();}if(n!==""){let a=r.times(-1),l=this.editor.viewport.screenToCanvasTransform.transformVec3(a),c=w.translation(l),d=Y.fromLines(n.split(`
`),c.rightMul(this.contentTransform.get()),this.textStyle),p=K.addComponent(d);this.removeExistingCommand?(this.removeExistingCommand.unapply(this.editor),this.editor.dispatch(J([this.removeExistingCommand,p])),this.removeExistingCommand=null):this.editor.dispatch(p);}}updateTextInput(){if(!this.textInputElem)return;this.textInputElem.placeholder=this.localizationTable.enterTextToInsert,this.textInputElem.style.fontFamily=this.textStyle.fontFamily,this.textInputElem.style.fontStyle=this.textStyle.fontStyle??"",this.textInputElem.style.fontVariant=this.textStyle.fontVariant??"",this.textInputElem.style.fontWeight=this.textStyle.fontWeight??"",this.textInputElem.style.fontSize=`${this.textStyle.size}px`,this.textInputElem.style.color=this.textStyle.renderingStyle.fill.toHexString(),this.textInputElem.style.margin="0",this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`;let r=this.getTextAscent("Testing!",this.textStyle);this.textInputElem.style.transform=`translate(0, ${-r}px)`,this.textInputElem.style.transformOrigin="top left";let n=Math.floor(this.textStyle.size);this.textInputElem.style.lineHeight=`${n}px`;}startTextInput(e,i){this.flushInput(),this.textInputElem=document.createElement("textarea"),this.textInputElem.value=i,this.textInputElem.style.display="inline-block";let r=this.editor.viewport.roundPoint(e),n=-this.editor.viewport.getRotationAngle(),a=exports.Vec2.of(1,1).times(this.editor.viewport.getSizeOfPixelOnCanvas());this.contentTransform.set(w.translation(r).rightMul(w.zRotation(n)).rightMul(w.scaling2D(a))),this.updateTextInput(),setTimeout(()=>this.updateTextInput(),0),this.textInputElem.addEventListener("input",()=>{this.textInputElem&&(this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`);}),this.textInputElem.addEventListener("blur",()=>{let l=this.textInputElem;this.flushInput(false),this.textInputElem=null,l&&l.classList.add("-hiding"),setTimeout(()=>{l?.remove();},0);}),this.textInputElem.addEventListener("keyup",l=>{l.isComposing||(l.key==="Enter"&&!l.shiftKey?(this.flushInput(),this.editor.focus()):l.key==="Escape"&&(this.textInputElem?.remove(),this.textInputElem=null,this.editor.focus(),this.removeExistingCommand?.unapply(this.editor),this.removeExistingCommand=null));}),this.textEditOverlay.replaceChildren(this.textInputElem),setTimeout(()=>this.textInputElem?.focus(),0);}setEnabled(e){super.setEnabled(e),this.isEnabled()||this.flushInput(),this.textEditOverlay.style.display=e?"block":"none";}onPointerDown({current:e,allPointers:i}){if(e.device===1)return  false;if(i.length===1){let r=e.canvasPos,n=exports.Vec2.of(4,4).times(this.editor.viewport.getSizeOfPixelOnCanvas()),a=I.fromCorners(r.minus(n),r.plus(n)),c=this.editor.image.getComponentsIntersecting(a).filter(p=>p instanceof Y),d=this.editor.viewport.visibleRect;if(c=c.filter(p=>!p.getBBox().containsRect(d)),this.flushInput(),c.length>0){let p=c[c.length-1];this.setTextStyle(p.getTextStyle()),this.removeExistingCommand=new _([p]),this.removeExistingCommand.apply(this.editor),this.startTextInput(p.getBaselinePos(),p.getText()),this.contentTransform.set(p.getTransform()),this.updateTextInput();}else this.removeExistingCommand=null,this.startTextInput(e.canvasPos,"");return  true}return  false}onGestureCancel(){this.flushInput(),this.editor.focus();}setFontFamily(e){e!==this.textStyle.fontFamily&&this.textStyleValue.set({...this.textStyle,fontFamily:e});}setColor(e){e.eq(this.textStyle.renderingStyle.fill)||this.textStyleValue.set({...this.textStyle,renderingStyle:{...this.textStyle.renderingStyle,fill:e}});}setFontSize(e){e!==this.textStyle.size&&this.textStyleValue.set({...this.textStyle,size:e});}getTextStyle(){return this.textStyle}getStyleValue(){return this.textStyleValue}setTextStyle(e){this.textStyleValue.set(e);}onDestroy(){super.onDestroy(),this.anchorControl.remove();}};var _e=class s{constructor(o,e){this.editor=o;this.localizationTable=e??o.localization,s.colorisStarted||(s.colorisStarted=true),this.setupColorPickers();}#e=[];#t={};widgetList=[];static colorisStarted=false;#o=null;localizationTable;closeColorPickerOverlay=null;setupCloseColorPickerOverlay(){this.closeColorPickerOverlay||(this.closeColorPickerOverlay=document.createElement("div"),this.closeColorPickerOverlay.className=`${L}closeColorPickerOverlay`,this.editor.createHTMLOverlay(this.closeColorPickerOverlay),this.#e.push(this.editor.handlePointerEventsExceptClicksFrom(this.closeColorPickerOverlay,o=>(o==="pointerup"&&this.editor.focus(),true))));}setupColorPickers(){if(this.#o){this.#o();return}this.setupCloseColorPickerOverlay();let o=12,e=[P.red.toHexString(),P.purple.toHexString(),P.blue.toHexString(),P.clay.toHexString(),P.black.toHexString(),P.white.toHexString()],i=e.length,n=()=>{};this.#o=n;let a=l=>{let c=false;for(let d of e)d===l&&(c=true);c||(e.push(l),e.length>o&&e.splice(i,1),n());};this.#e.push(this.editor.notifier.on(11,l=>{l.kind===11&&this.closeColorPickerOverlay&&(this.closeColorPickerOverlay.style.display=l.open?"block":"none");})),this.#e.push(this.editor.notifier.on(12,l=>{l.kind===12&&a(l.color.toHexString());}));}closeColorPickers(){}getWidgetUniqueId(o){return o.getUniqueIdIn(this.#t)}getWidgetFromId(o){return this.#t[o]}getAllWidgets(){return this.widgetList}addWidget(o){let e=o.getUniqueIdIn(this.#t);this.#t[e]=o,this.widgetList.push(o),this.addWidgetInternal(o),this.setupColorPickers();}removeWidget(o){let e=o.getUniqueIdIn(this.#t);this.removeWidgetInternal(o),delete this.#t[e],this.widgetList=this.widgetList.filter(i=>i!==o);}static rootToolbarId="root-toolbar--";serializeState(){let o={};for(let e in this.#t)o[e]=this.#t[e].serializeState();return o[s.rootToolbarId]=this.serializeInternal(),JSON.stringify(o)}deserializeState(o){let e=JSON.parse(o);qo(e),In(e);let i=s.rootToolbarId;i in e&&typeof e[i]<"u"&&this.deserializeInternal(e[i]);for(let r in e)if(r!==i){if(!(r in this.#t)){console.warn(`Unable to deserialize widget ${r} \xAD\u2014 no such widget.`);continue}typeof e[r]=="object"&&e[r]&&this.#t[r].deserializeFrom(e[r]);}}serializeInternal(){}deserializeInternal(o){}makeActionButton(o,e,i=true){typeof i=="boolean"&&(i={mustBeToplevel:i});let r=i.mustBeToplevel??true,n=i.autoDisableInReadOnlyEditors??true,a=typeof o=="string"?o:o.label,l="action-button",c=()=>typeof o=="string"?null:o.icon;return new Ie(this.editor,l,c,a,e,this.editor.localization,r,n)}addActionButton(o,e,i=true){let r=this.makeActionButton(o,e,i);return this.addWidget(r),r}addTaggedActionButton(o,e,i,r=true){let n=this.makeActionButton(e,i,r);return n.setTags(o),this.addWidget(n),n}addSaveButton(o,e={}){let i=new ss(this.editor,this.localizationTable,o,e);return this.addWidget(i),i}addExitButton(o,e={}){let i=new ns(this.editor,this.localizationTable,o,e);return this.addWidget(i),i}addUndoRedoButtons(o=true){let e=()=>this.addTaggedActionButton(["undo"],{label:this.localizationTable.undo,icon:this.editor.icons.makeUndoIcon()},()=>{this.editor.history.undo();}),i=()=>this.addTaggedActionButton(["redo"],{label:this.localizationTable.redo,icon:this.editor.icons.makeRedoIcon()},()=>{this.editor.history.redo();}),r,n;o?(r=e(),n=i()):(n=i(),r=e()),r.setDisabled(true),n.setDisabled(true),this.editor.notifier.on(3,a=>{if(a.kind!==3)throw new Error("Wrong event type!");r.setDisabled(a.undoStackSize===0),n.setDisabled(a.redoStackSize===0);});}addWidgetsForPrimaryTools(o){for(let e of this.editor.toolController.getPrimaryTools())if(!(o&&!o?.(e)))if(e instanceof Me){let i=new It(this.editor,e,this.localizationTable);this.addWidget(i);}else if(e instanceof nt){let i=new ho(this.editor,e,this.localizationTable);this.addWidget(i);}else e instanceof Ke?this.addWidget(new Pt(this.editor,e,this.localizationTable)):e instanceof ce?this.addWidget(new At(this.editor,e,this.localizationTable)):e instanceof ke?this.addWidget(new Dt(this.editor,e,this.localizationTable)):e instanceof he&&this.addWidget(new Et(this.editor,e,this.localizationTable));}addDefaultToolWidgets(){this.addWidgetsForPrimaryTools(),this.addDefaultEditorControlWidgets();}addDefaultEditorControlWidgets(){this.addWidget(new wt(this.editor,this.localizationTable));}addDefaultActionButtons(){this.addUndoRedoButtons();}remove(){this.closeColorPickerOverlay?.remove();for(let o of this.#e)o.remove();this.#e=[],this.onRemove();for(let o of this.widgetList)o.remove();}manageListener(o){this.#e.push(o);}};function vs(s){return s instanceof O?new class extends O{_command=s;serializeToJSON(){return s.serialize()}apply(o){s.unapply(o);}unapply(o){s.apply(o);}onDrop(o){s.onDrop(o);}description(o,e){return e.inverseOf(s.description(o,e))}}("inverse"):new class extends we{apply(e){s.unapply(e);}unapply(e){s.apply(e);}onDrop(e){s.onDrop(e);}description(e,i){return i.inverseOf(s.description(e,i))}}}O.register("inverse",(s,o)=>vs(O.deserialize(s,o)));var $a=vs;var xs="find-tool",wo=class extends H{constructor(e){super(e.notifier,e.localization.findLabel);this.editor=e;this.overlay=document.createElement("div"),this.fillOverlay(),e.createHTMLOverlay(this.overlay),this.overlay.style.display="none",this.overlay.classList.add(`${xs}-overlay`);}overlay;searchInput;currentMatchIdx=0;canReceiveInputInReadOnlyEditor(){return  true}getMatches(e){let i=e.toLocaleLowerCase();return this.editor.image.getAllComponents().filter(n=>{let a="";if(n instanceof Y)a=n.getText();else if(n instanceof ne)a=n.getAltText()??"";else return  false;let l=a.toLocaleLowerCase().includes(i),c=a.includes(e);return l||c}).map(n=>n.getBBox())}focusCurrentMatch(){let e=this.getMatches(this.searchInput.value),i=this.currentMatchIdx%e.length;i<0&&(i=e.length+i),i<e.length&&(this.editor.dispatch(this.editor.viewport.zoomTo(e[i],true,true),false),this.editor.announceForAccessibility(this.editor.localization.focusedFoundText(i+1,e.length)));}toNextMatch(){this.currentMatchIdx++,this.focusCurrentMatch();}toPrevMatch(){this.currentMatchIdx--,this.focusCurrentMatch();}fillOverlay(){let e=document.createElement("label");this.searchInput=document.createElement("input");let i=document.createElement("button"),r=document.createElement("button");this.searchInput.setAttribute("id",`${xs}-searchInput-${Math.random()}`),e.htmlFor=this.searchInput.getAttribute("id"),e.innerText=this.editor.localization.findLabel,i.innerText=this.editor.localization.toNextMatch,r.innerText=this.editor.localization.closeDialog,this.searchInput.addEventListener("keydown",n=>{n.key==="Enter"?n.shiftKey?this.toPrevMatch():this.toNextMatch():n.key==="Escape"?this.setVisible(false):this.editor.shortcuts.matchesShortcut(gi,n)&&(n.preventDefault(),this.toggleVisible());}),i.addEventListener("click",()=>{this.toNextMatch();}),r.addEventListener("click",()=>{this.setVisible(false);}),this.overlay.replaceChildren(e,this.searchInput,i,r);}isVisible(){return this.overlay.style.display!=="none"}setVisible(e){e!==this.isVisible()&&(this.overlay.style.display=e?"block":"none",e?(this.searchInput.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogShown)):(this.editor.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogHidden)));}toggleVisible(){this.setVisible(!this.isVisible());}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(gi,e)?(this.toggleVisible(),true):false}setEnabled(e){super.setEnabled(e),this.isEnabled()&&this.setVisible(false);}};var Po=class extends ge{#e=null;#t=null;onEvent(o){return this.#e===null?this.emit(o):this.#e.onEvent(o)}addToTail(o){this.#t?(this.#t.setEmitListener(o),this.#t=o):(this.#e=o,this.#t=this.#e),this.#t.setEmitListener(e=>this.emit(e));}};var Mt=class extends H{constructor(e){super(e.notifier,e.localization.pasteHandler);this.editor=e;}onPaste(e,i){let r=e.mime.toLowerCase(),n=(()=>{if(r==="image/svg+xml")return e.data;if(r==="text/plain"){let c=e.data.trim();if(c.startsWith("<svg")&&c.endsWith("</svg>"))return c}if(r!=="text/html"||!e.data.match(/^[^]{0,200}<svg.*/i))return  false;let l=e.data.toLowerCase().lastIndexOf("</svg>");return l===-1&&(l=e.data.length),e.data.substring(e.data.search(/<svg/i),l)})();return n?(this.doSVGPaste(n).then(i),true):r==="text/plain"?(this.doTextPaste(e.data).then(i),true):r==="image/png"||r==="image/jpeg"?(this.doImagePaste(e.data).then(i),true):false}async addComponentsFromPaste(e){await this.editor.addAndCenterComponents(e,true,this.editor.localization.pasted(e.length));}async doSVGPaste(e){this.editor.showLoadingWarning(0);try{let i=Ge.fromString(e,{sanitize:!0,plugins:this.editor.getCurrentSettings().svg?.loaderPlugins??[]}),r=[];await i.start(n=>{r.push(n);},(n,a)=>null),await this.addComponentsFromPaste(r);}finally{this.editor.hideLoadingWarning();}}async doTextPaste(e){let i=this.editor.toolController.getMatchingTools(ke);i.sort((l,c)=>!l.isEnabled()&&c.isEnabled()?-1:!c.isEnabled()&&l.isEnabled()?1:0);let r={size:12,fontFamily:"sans",renderingStyle:{fill:P.red}},n=i[0]?.getTextStyle()??r;if(e.trim()==="")return;let a=e.split(`
`);await this.addComponentsFromPaste([Y.fromLines(a,w.identity,n)]);}async doImagePaste(e){let i=new Image;i.src=e;let r=await ne.fromImage(i,w.identity);await this.addComponentsFromPaste([r]);}};var Vt=class extends H{constructor(e){super(e.notifier,e.localization.selectAllTool);this.editor=e;}canReceiveInputInReadOnlyEditor(){return  true}onKeyPress(e){if(this.editor.shortcuts.matchesShortcut(xt,e)){let i=this.editor.toolController.getMatchingTools(ce);if(i.length>0){let r=i[0];return r.setEnabled(true),r.setSelection(this.editor.image.getAllComponents()),true}}return  false}};var ct=class{activeTool;constructor(){}notifyEnabled(o){o!==this.activeTool&&(this.activeTool?.setEnabled(false),this.activeTool=o);}setEnabled(o){o!==this.activeTool||!this.activeTool?(this.activeTool?.setEnabled(false),o.setEnabled(true),this.activeTool=o):(this.activeTool?.setEnabled(false),o.setEnabled(false),this.activeTool=null);}};var Ft=class extends H{constructor(e){super(e.notifier,e.localization.changeTool);this.editor=e;}canReceiveInputInReadOnlyEditor(){return  true}onKeyPress({key:e}){let r=this.editor.toolController.getPrimaryTools(),n=/^\d$/.exec(e),a;if(n){let l=Number.parseInt(n[0],10)-1;a=r[l];}return a?(a.setEnabled(true),true):false}};var Ot=class extends H{constructor(e){super(e.notifier,e.localization.undoRedoTool);this.editor=e;}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(ot,e)?(this.editor.history.undo(),true):this.editor.shortcuts.matchesShortcut(Lr,e)?(this.editor.history.redo(),true):false}};var Ht=class{tools;activeTool=null;primaryToolGroup;inputPipeline;isEditorReadOnly;constructor(o,e){this.isEditorReadOnly=o.isReadOnlyReactiveValue(),this.inputPipeline=new Po,this.inputPipeline.setEmitListener(u=>this.onEventInternal(u));let i=new ct;this.primaryToolGroup=i;let r=new he(o,6,e.touchPanTool),n=new he(o,16,e.keyboardPanZoom),a=new Me(o,e.penTool(1),{color:P.black,thickness:1.5}),l=new nt(o,e.penTool(3),{color:P.black,borderColor:P.black,thickness:0}),c=new Ke(o,e.eraserTool),d=[new ce(o,e.selectionTool),new ke(o,e.textTool,e),a,new Me(o,e.penTool(2),{color:P.blackHighlight,thickness:40,factory:$e}),c,l];l.setEnabled(false);let p=[r,n,new he(o,8,e.anyDevicePanning)];this.tools=[...d,new Ot(o),new Ne(o),new Ft(o),c.makeEraserSwitcherTool(),new wo(o),new Mt(o),new Vt(o)],o.getCurrentSettings().disableZoom||this.tools.push(...p),d.forEach(u=>u.setToolGroup(i)),r.setEnabled(true),a.setEnabled(true),o.notifier.on(0,u=>{u.kind===0&&o.announceForAccessibility(e.toolEnabledAnnouncement(u.tool.description));}),o.notifier.on(1,u=>{u.kind===1&&o.announceForAccessibility(e.toolDisabledAnnouncement(u.tool.description));}),this.activeTool=null;}setTools(o,e){this.tools=o,this.primaryToolGroup=e??new ct;}addPrimaryTool(o){o.setToolGroup(this.primaryToolGroup),o.isEnabled()&&this.primaryToolGroup.notifyEnabled(o),this.tools.includes(o)||this.addTool(o);}getPrimaryTools(){return this.tools.filter(o=>o.getToolGroup()===this.primaryToolGroup)}setToolEnabled(o){this.primaryToolGroup.setEnabled(o);}addTool(o,e){this.tools.includes(o)||(e?.addToFront?this.tools.splice(0,0,o):this.tools.push(o));}removeAndDestroyTools(o){let e=[];for(let i of this.tools)o.includes(i)?(this.activeTool===i&&(this.activeTool=null),i.onDestroy()):e.push(i);this.tools=e;}insertTools(o,e,i){this.tools=this.tools.filter(n=>!e.includes(n));let r=[];for(let n of this.tools)i==="after"&&r.push(n),n===o&&r.push(...e),i==="before"&&r.push(n);this.tools=r;}insertToolsAfter(o,e){this.insertTools(o,e,"after");}insertToolsBefore(o,e){this.insertTools(o,e,"before");}onEventInternal(o){let e=this.isEditorReadOnly.get(),i=n=>n.isEnabled()&&(!e||n.canReceiveInputInReadOnlyEditor()),r=false;if(o.kind===0){let n=false;this.activeTool&&!this.activeTool.eventCanBeDeliveredToNonActiveTool(o)&&(n=true);for(let a of this.tools)if(!(n&&a!==this.activeTool)&&i(a)&&a.onEvent(o)){this.activeTool!==a&&this.activeTool?.onEvent({kind:3}),this.activeTool=a,r=true;break}}else if(o.kind===2)this.activeTool?.onEvent(o)&&o.allPointers.length>1||(this.activeTool=null),r=true;else if(o.kind===1)this.activeTool!==null&&(this.activeTool.onEvent(o),r=true);else if(o.kind===3)this.activeTool!==null&&(this.activeTool.onEvent(o),this.activeTool=null);else for(let n of this.tools)if(i(n)&&(r=n.onEvent(o),r))break;return r}onEvent(o){return this.dispatchInputEvent(o)}dispatchInputEvent(o){return this.inputPipeline.onEvent(o)}addInputMapper(o){this.inputPipeline.addToTail(o);}getMatchingTools(o){return this.tools.filter(e=>e instanceof o)}onEditorDestroyed(){for(let o of this.tools)o.onDestroy();}};var rn=class{ctx;colorOscHue;colorOscValue;colorOscSaturation;valueGain;colorGain;boundaryOsc;boundaryGain;closed=false;constructor(){if(!window.AudioContext){console.warn("Accessibility sound UI: Unable to open AudioContext."),this.closed=true;return}this.ctx=new AudioContext,this.colorOscHue=this.ctx.createOscillator(),this.colorOscValue=this.ctx.createOscillator(),this.colorOscSaturation=this.ctx.createOscillator(),this.colorOscHue.type="triangle",this.colorOscSaturation.type="sine",this.colorOscValue.type="sawtooth",this.valueGain=this.ctx.createGain(),this.colorOscValue.connect(this.valueGain),this.valueGain.gain.setValueAtTime(.18,this.ctx.currentTime),this.colorGain=this.ctx.createGain(),this.colorOscHue.connect(this.colorGain),this.valueGain.connect(this.colorGain),this.colorOscSaturation.connect(this.colorGain),this.colorGain.connect(this.ctx.destination),this.boundaryGain=this.ctx.createGain(),this.boundaryOsc=this.ctx.createOscillator(),this.boundaryOsc.type="sawtooth",this.boundaryGain.gain.setValueAtTime(0,this.ctx.currentTime),this.boundaryOsc.connect(this.boundaryGain),this.boundaryGain.connect(this.ctx.destination),this.colorOscHue.start(),this.colorOscSaturation.start(),this.colorOscValue.start(),this.boundaryOsc.start(),this.pause();}pause(){this.closed||(this.colorGain.gain.setValueAtTime(0,this.ctx.currentTime),this.ctx.suspend());}play(){this.closed||this.ctx.resume();}setColor(o){let e=o.asHSV(),i=-Math.cos(e.x/2)*220+440,r=e.y*440+220,n=(e.z+.1)*440,a=.25*Math.min(1,o.a)/(1+Math.exp(-(e.z-.5)*3));this.colorOscHue.frequency.setValueAtTime(i,this.ctx.currentTime),this.colorOscSaturation.frequency.setValueAtTime(r,this.ctx.currentTime),this.colorOscValue.frequency.setValueAtTime(n,this.ctx.currentTime),this.valueGain.gain.setValueAtTime((1-e.z)*.4,this.ctx.currentTime),this.colorGain.gain.setValueAtTime(a,this.ctx.currentTime);}announceBoundaryCross(o){this.boundaryGain.gain.cancelScheduledValues(this.ctx.currentTime),this.boundaryGain.gain.setValueAtTime(0,this.ctx.currentTime),this.boundaryGain.gain.linearRampToValueAtTime(.018,this.ctx.currentTime+.1),this.boundaryOsc.frequency.setValueAtTime(440+Math.atan(o/2)*100,this.ctx.currentTime),this.boundaryGain.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.25);}close(){this.ctx.close(),this.closed=true;}},zi=class extends H{constructor(e,i){super(e.notifier,i);this.editor=e;this.toggleButtonContainer=document.createElement("div"),this.toggleButtonContainer.classList.add("easydrawer-sound-ui-toggle"),this.toggleButton=document.createElement("button"),this.toggleButton.addEventListener("click",()=>{this.setEnabled(!this.isEnabled());}),this.toggleButtonContainer.appendChild(this.toggleButton),this.updateToggleButtonText(),e.createHTMLOverlay(this.toggleButtonContainer);}soundFeedback=null;toggleButton;toggleButtonContainer;canReceiveInputInReadOnlyEditor(){return  true}updateToggleButtonText(){let e="sound-ui-tool-enabled";this.isEnabled()?(this.toggleButton.innerText=this.editor.localization.disableAccessibilityExploreTool,this.toggleButtonContainer.classList.add(e)):(this.toggleButton.innerText=this.editor.localization.enableAccessibilityExploreTool,this.toggleButtonContainer.classList.remove(e));}setEnabled(e){super.setEnabled(e),this.isEnabled()?this.editor.announceForAccessibility(this.editor.localization.soundExplorerUsageAnnouncement):(this.soundFeedback?.close(),this.soundFeedback=null),this.updateToggleButtonText();}onKeyPress(e){return e.code==="Escape"?(this.setEnabled(false),true):false}lastPointerPos;onPointerDown({current:e,allPointers:i}){return this.soundFeedback||(this.soundFeedback=new rn),i.length>=2?false:(this.soundFeedback?.play(),this.soundFeedback?.setColor(this.editor.display.getColorAt(e.screenPos)??P.black),this.lastPointerPos=e.canvasPos,true)}onPointerMove({current:e}){this.soundFeedback?.setColor(this.editor.display.getColorAt(e.screenPos)??P.black);let i=new oe(this.lastPointerPos,e.canvasPos),r=this.editor.image.getComponentsIntersecting(i.bbox).filter(n=>n.intersects(i));this.lastPointerPos=e.canvasPos,r.length>0&&this.soundFeedback?.announceBoundaryCross(r.length);}onPointerUp(e){this.soundFeedback?.pause();}onGestureCancel(){this.soundFeedback?.pause();}};async function Ka(s){let o=[],e=new Image,i=await zt(s);return i&&o.push({image:e,base64Url:i,transform:w.identity}),o}var Ss=Ka;var Eo=class s{constructor(o,e,i){this.imageBase64Url=o;this.preview=e;this.onUrlUpdate=i;this.originalSrc=o,e.src=o;}originalSrc;altText;updateImageData(o){this.preview.src=o,this.imageBase64Url=o,this.onUrlUpdate();}decreaseSize(o=3/4){let e=document.createElement("canvas");e.width=this.preview.naturalWidth*o,e.height=this.preview.naturalHeight*o,e.getContext("2d")?.drawImage(this.preview,0,0,e.width,e.height);let r=this.originalSrc?.startsWith("data:image/jpeg;")?"image/jpeg":"image/png";this.updateImageData(e.toDataURL(r));}reset(){this.updateImageData(this.originalSrc);}isChanged(){return this.imageBase64Url!==this.originalSrc}isLarge(){return this.getBase64Url().length>125829.12}getBase64Url(){return this.imageBase64Url}getAltText(){return this.altText}setAltText(o){this.altText=o,this.preview.alt=o;}static fromSrcAndPreview(o,e,i){return new s(o,e,i)}static fromRenderable(o,e){let i=new Image;i.src=o.base64Url;let r=new s(o.base64Url,i,e),n=o.label??o.image.getAttribute("alt");return n&&r.setAltText(n),{wrapper:r,preview:i}}};function Ga(s){let o=s/1024,e=o/1024,i=e/1024,r="B",n=s;return i>=1?(n=i,r="GiB"):e>=1?(n=e,r="MiB"):o>=1&&(n=o,r="KiB"),{size:n,units:r}}var Cs=Ga;var _a=0;function qa(s,o,{accepts:e="*",allowMultiSelect:i=false,customPickerAction:r}={}){let n=document.createElement("div"),a=document.createElement("label"),l=document.createElement("input"),c=document.createElement("div");c.classList.add("toolbar--file-input-description");let d=document.createElement("span");n.classList.add("toolbar--file-input-container"),a.appendChild(document.createTextNode(s)),l.accept=e,l.type=r?"button":"file",l.classList.add("file-input"),l.multiple=i;let p=`easydrawer-file-input-${_a++}`;l.setAttribute("id",p),a.htmlFor=p;let u=o.icons.makeUploadFileIcon();u.classList.add("icon"),c.replaceChildren(u,d),a.appendChild(c),n.replaceChildren(a,l);let h=ri.fromInitialValue([]),m=false,f=null,g=()=>{let v=h.get();if(m){if(d.textContent=o.localization.fileInput__loading,f){let b=document.createElement("b");b.textContent=o.localization.cancel,b.classList.add("cancel-button"),d.appendChild(b);}u.style.display="none";}else if(v.length>0){let b=v.map(T=>T.name),S=5;if(b.length<=S)d.textContent=b.join(`
`);else {let T=b.slice(0,S-1);d.textContent=[...T,o.localization.fileInput__andNMoreFiles(b.length-T.length)].join(`
`);}u.style.display="none";}else {u.style.display="";let S=o.localization.dragAndDropHereOrBrowse.split(/{{2}(.*)}{2}/g);d.replaceChildren();for(let[T,C]of S.entries())if(T%2===1){let R=document.createElement("b");R.textContent=C,d.appendChild(R);}else d.appendChild(document.createTextNode(C));}};if((()=>{a.addEventListener("dragover",v=>{v.preventDefault(),a.classList.add("drag-target");}),a.addEventListener("dragenter",v=>{v.preventDefault(),a.classList.add("drag-target");}),a.addEventListener("dragleave",v=>{v.preventDefault();let b=v.relatedTarget;(!b||!a.contains(b))&&a.classList.remove("drag-target");}),a.addEventListener("drop",v=>{v.preventDefault(),a.classList.remove("drag-target");let b=[];v.dataTransfer&&b.push(...v.dataTransfer.files),h.set(b);}),l.addEventListener("change",()=>{let v=l.files??[];h.set([...v]);});})(),r){let v=async()=>{if(m){f?.();return}n.classList.add("-loading"),m=true,g();try{let b=await r({setOnCancelCallback:S=>{if(!m)throw new Error("Task already completed. Can't register cancel handler.");f=()=>{f=null,g(),S();},g();}});b&&h.set(b);}finally{n.classList.remove("-loading"),m=false,g();}};l.addEventListener("click",v);}return h.onUpdate(v=>{v.length===0&&l.files&&l.files.length>0&&(l.value=""),f?.();}),h.onUpdateAndNow(g),{container:n,input:l,selectedFiles:h,addTo:v=>{v.appendChild(n);}}}var Ts=qa;function Za(s){let o=document.createElement("div");o.classList.add("toolbar-snapped-scroll-list");let e=document.createElement("div");e.classList.add("scroller");let i=Z.fromInitialValue(0),r=null,n=()=>{let u=document.createElement("div");u.classList.add("page-markers"),u.setAttribute("tabindex","-1");let h=[];return N.union([i,s]).onUpdateAndNow(([f,g])=>{let y=false;for(;g.length<h.length;)h.pop(),y=true;let v;for(let b=0;b<g.length;b++){let S;if(b>=h.length){S=document.createElement("div");let C=document.createElement("div");C.classList.add("content"),S.replaceChildren(C),h.push(S),y=true;}else S=h[b];S.classList.add("marker"),b===f?(S.classList.add("-active"),v=S):S.classList.remove("-active");let T=b;S.addEventListener("click",()=>{c.get()[T]?.element?.scrollIntoView({block:"nearest",behavior:"smooth"});});}y&&u.replaceChildren(...h),v&&u.scrollHeight>o.clientHeight&&v.scrollIntoView({block:"nearest"}),h.length===1?u.classList.add("-one-element"):u.classList.remove("-one-element");}),u},a=()=>{r=new IntersectionObserver(u=>{for(let h of u)if(h.isIntersecting&&h.intersectionRatio>.7){let m=h.target.getAttribute("data-item-index");if(m===null)throw new Error("Could not find attribute data-item-index");let f=Number(m);i.set(f);break}},{root:e,threshold:.9});},l=()=>{r&&(r.disconnect(),i.set(0),r=null);},c=N.map(s,u=>u.map((h,m)=>{let f=document.createElement("div");return h.element.parentElement&&h.element.remove(),f.appendChild(h.element),f.classList.add("item"),f.setAttribute("data-item-index",`${m}`),{element:f,data:h.data}})),d=[];c.onUpdateAndNow(u=>{i.set(-1);for(let h of d)r?.unobserve(h.element);e.replaceChildren(),u.length>1?a():l(),u.length===0?o.classList.add("-empty"):o.classList.remove("-empty");for(let h of u)e.appendChild(h.element);if(i.set(0),r)for(let h of u)r.observe(h.element);});let p=N.map(i,u=>{let h=s.get();return 0<=u&&u<h.length?h[u].data:null});return gt(e),o.replaceChildren(n(),e),{container:o,visibleItem:p}}var ws=Za;var Bi=class s extends Q{images;imagesPreview;selectedFiles;imageAltTextInput;statusView;submitButton;constructor(o,e){e??=o.localization,super(o,"insert-image-widget",e),this.container.classList.add("dropdownShowable"),o.notifier.on(9,i=>{i.kind===9&&this.isDropdownVisible()&&this.updateInputs();}),this.images=Z.fromInitialValue([]),this.images.onUpdateAndNow(()=>{this.onImageDataUpdate();});}getTitle(){return this.localizationTable.image}createIcon(){return this.editor.icons.makeInsertImageIcon()}setDropdownVisible(o){super.setDropdownVisible(o),this.isDropdownVisible()?this.updateInputs():this.selectedFiles?.set([]);}handleClick(){this.setDropdownVisible(!this.isDropdownVisible());}static nextInputId=0;fillDropdown(o){let e=document.createElement("div");e.classList.add("insert-image-widget-dropdown-content",`${L}spacedList`,`${L}nonbutton-controls-main-list`);let{container:i,selectedFiles:r}=Ts(this.localizationTable.chooseFile,this.editor,{accepts:"image/*",allowMultiSelect:true,customPickerAction:this.editor.getCurrentSettings().image?.showImagePicker}),n=document.createElement("div");this.imagesPreview=ws(this.images),this.statusView=document.createElement("div");let a=document.createElement("div");a.classList.add("action-button-row"),this.statusView.classList.add("insert-image-image-status-view"),this.submitButton=document.createElement("button"),this.selectedFiles=r,this.imageAltTextInput=document.createElement("input");let l=document.createElement("label"),c=`insert-image-alt-text-input-${s.nextInputId++}`;return this.imageAltTextInput.setAttribute("id",c),l.htmlFor=c,l.innerText=this.localizationTable.inputAltText,this.imageAltTextInput.type="text",this.imageAltTextInput.placeholder=this.localizationTable.describeTheImage,this.statusView.setAttribute("aria-live","polite"),this.submitButton.innerText=this.localizationTable.submit,this.imagesPreview.visibleItem.onUpdateAndNow(()=>this.onImageDataUpdate()),this.imageAltTextInput.addEventListener("input",()=>{let d=this.imagesPreview.visibleItem.get();d&&(d.setAltText(this.imageAltTextInput.value),this.submitButton.style.display="");}),this.selectedFiles.onUpdateAndNow(async d=>{if(d.length===0){this.images.set([]);return}let p=(await Promise.all(d.map(async u=>{let h;try{h=await Ss(u);}catch(m){console.error("Image load error",m);let f=this.localizationTable.imageLoadError("Image load error");return this.statusView.innerText=f,[]}return h.map(m=>{let{wrapper:f,preview:g}=Eo.fromRenderable(m,()=>this.onImageDataUpdate());return {data:f,element:g}})}))).flat();this.images.set(p);}),n.replaceChildren(l,this.imageAltTextInput),a.replaceChildren(this.submitButton),e.replaceChildren(i,n,this.imagesPreview.container,this.statusView,a),o.replaceChildren(e),true}onImageDataUpdate(){if(!this.imagesPreview)return;let o=this.imagesPreview.visibleItem.get(),e=o?.getBase64Url();this.imageAltTextInput.value=o?.getAltText()??"",e?(this.submitButton.disabled=false,this.submitButton.style.display="",this.updateImageSizeDisplay()):(this.submitButton.disabled=true,this.submitButton.style.display="none",this.statusView.innerText="",this.submitButton.disabled=true),this.images.get().length<=1?this.submitButton.innerText=this.localizationTable.submit:this.submitButton.innerText=this.localizationTable.addAll;}hideDialog(){this.setDropdownVisible(false);}updateImageSizeDisplay(){let o=this.imagesPreview.visibleItem.get(),e=o?.getBase64Url()??"",{size:i,units:r}=Cs(e.length),n=document.createElement("span");n.innerText=this.localizationTable.imageSize(Math.round(i),r);let a=document.createElement("button");a.innerText=this.localizationTable.decreaseImageSize,a.addEventListener("click",()=>{o?.decreaseSize();});let l=document.createElement("button");l.innerText=this.localizationTable.resetImage,l.addEventListener("click",()=>{o?.reset();}),this.statusView.replaceChildren(n),o?.isLarge()?this.statusView.appendChild(a):o?.isChanged()?this.statusView.appendChild(l):this.images.get().some(d=>d.data?.isChanged()||d.data?.isLarge())&&(a.disabled=true,this.statusView.appendChild(a));}updateInputs(){(()=>{this.selectedFiles?.set([]),this.imageAltTextInput.value="",this.submitButton.disabled=true,this.statusView.innerText="",this.submitButton.style.display="";})();let e=this.editor.toolController.getMatchingTools(ce),i=e.flatMap(n=>n.getSelectedObjects()),r=null;if(i.length===1&&i[0]instanceof ne){r=i[0];let n=new Image,a=Eo.fromSrcAndPreview(r.getURL(),n,()=>this.onImageDataUpdate());a.setAltText(r.getAltText()??""),this.images.set([{data:a,element:n}]);}else i.length>0&&e.forEach(n=>n.clearSelection());this.submitButton.style.display="none",this.submitButton.addEventListener("click",async()=>{let n=[],a=w.identity,l=null;for(let{data:c}of this.images.get()){if(!c)continue;let d=new Image;d.src=c.getBase64Url();let p=c.getAltText();p&&d.setAttribute("alt",p);let u;try{u=await ne.fromImage(d,a);}catch(f){console.error("Error loading image",f),this.statusView.innerText=this.localizationTable.imageLoadError("Image load error");return}let h=u.getBBox();if(h.area===0){this.statusView.innerText=this.localizationTable.errorImageHasZeroSize;return}n.push(u),l??=h,l.union(h);let m=exports.Vec2.of(0,h.height);a=a.rightMul(w.translation(m));}if(n.length>0){if(!l)throw new Error("Logic error: Full bounding box must be calculated when components are to be added.");if(this.hideDialog(),r){let c=new _([r]),d=r.getTransformation(),p=r.getBBox().width||1,u=l.transformedBoundingBox(d).width||1,h=w.scaling2D(p/u),m=[];for(let f of n)m.push(K.addComponent(f),f.transformBy(d.rightMul(h)),f.setZIndex(r.getZIndex()));this.editor.dispatch(J([...m,c])),e[0]?.setSelection(n);}else await this.editor.addAndCenterComponents(n);}});}};function ja(s,o,e="html"){let i;if(e==="html")i=document.createElement(s);else if(e==="svg")i=document.createElementNS("http://www.w3.org/2000/svg",s);else throw new Error(`Unknown element type ${e}`);for(let[r,n]of Object.entries(o))if(r!=="children"){if(typeof n!="string"&&typeof n!="number")throw new TypeError(`Unsupported value type ${typeof n}`);i.setAttribute(r,n.toString());}if(o.children)for(let r of o.children)i.appendChild(r);return i}function Re(s,o){return ja(s,o,"svg")}function Ai(s,o){return o.map(e=>Re(s,e))}function Di(...s){return Ai("path",s)}var j="http://www.w3.org/2000/svg",Ya=0;function Mi(){let s=`checkerboard-${Ya++}`,o=Re("pattern",{id:s,viewBox:"0,0,10,10",width:"20%",height:"20%",patternUnits:"userSpaceOnUse",children:Ai("rect",[{x:0,y:0,width:10,height:10,fill:"white"},{x:0,y:0,width:5,height:5,fill:"gray"},{x:5,y:5,width:5,height:5,fill:"gray"}])}),e=`url(#${s})`;return {patternDefElement:o,get patternDef(){return o.innerHTML},patternRef:e}}function Ps(s){let o=document.createElementNS(j,"svg");o.innerHTML=`
		<style>
			.toolbar-svg-undo-redo-icon {
				stroke: var(--icon-color);
				stroke-width: 12;
				stroke-linejoin: round;
				stroke-linecap: round;
				fill: none;

				transform-origin: center;
			}
		</style>
	`;let e=document.createElementNS(j,"path");return e.setAttribute("d","M20,20 A15,15 0 0 1 70,80 L80,90 L60,70 L65,90 L87,90 L65,80"),e.classList.add("toolbar-svg-undo-redo-icon"),s&&(e.style.transform="scale(-1, 1)"),o.appendChild(e),o.setAttribute("viewBox","0 0 100 100"),o}var Nt=class{makeUndoIcon(){return Ps(true)}makeRedoIcon(){return Ps(false)}makeDropdownIcon(){let o=this.makeIconFromPath("M5,10 L50,90 L95,10 Z");return o.setAttribute("viewBox","-10 -10 110 110"),o}makeEraserIcon(o,e){o??=10;let i=o/4,r="#ff70af";return Re("svg",{viewBox:"0 0 120 120",children:[Re("defs",{children:[Re("linearGradient",{id:"dash-pattern",children:Ai("stop",[{offset:"80%","stop-color":r},{offset:"85%","stop-color":"white"},{offset:"90%","stop-color":r}])})]}),Re("path",{fill:e==="partial-stroke"?"url(#dash-pattern)":r,stroke:"black",transform:"rotate(41.35)",d:`
						M 52.5 27
						C 50 28.9 48.9 31.7 48.9 34.8
						L 48.9 39.8
						C 48.9 45.3 53.4 49.8 58.9 49.8
						L 103.9 49.8
						C 105.8 49.8 107.6 49.2 109.1 48.3
						L 110.2 ${i+49.5} L 159.7 ${i+5}
						L 157.7 ${-i+5.2} L 112.4 ${49.5-i}
						C 113.4 43.5 113.9 41.7 113.9 39.8
						L 113.9 34.8
						C 113.9 29.3 109.4 24.8 103.9 24.8
						L 58.9 24.8
						C 56.5 24.8 54.3 25.7 52.5 27
						z
					`}),Re("rect",{stroke:"#cc8077",fill:"var(--icon-color)",width:65,height:75,x:48.9,y:-38.7,transform:"rotate(41.35)"})]})}makeSelectionIcon(o="rect"){let e=document.createElementNS(j,"svg");return o==="rect"?e.innerHTML=`
			<g>
				<rect x="10" y="10" width="70" height="70" fill="pink" stroke="black" stroke-dasharray="32 9"/>
				<rect x="75" y="75" width="10" height="10" fill="white" stroke="black"/>
			</g>
			`:e.innerHTML=`
			<g>
				<rect x="10" y="10" width="76" height="76" rx="50" stroke-dasharray="32 9" fill="pink" stroke="black"/>
				<rect x="71" y="71" width="10" height="10" fill="white" stroke="black"/>
			</g>
			`,e.setAttribute("viewBox","0 0 100 100"),e}makeRotateIcon(){let o=document.createElementNS(j,"svg");return o.innerHTML=`
			<defs>
				<marker
					id="arrow-marker"
					viewBox="0 0 10 10"
					refX="3" refY="5"
					markerWidth="3" markerHeight="3"
					orient="auto-start-reverse"
				>
					<path
						d="M0,0 L8,5 L0,10z"
						fill="var(--icon-color)"
					/>
				</marker>
			</defs>

			<path
				marker-start="url(#arrow-marker)"
				d="
					M20,20
					A30,30 0 1 1 80 80
				"
				fill="none"
				stroke="var(--icon-color)"
				stroke-width="12"
			/>
			<path
				d="
					M80,80
					A30,30 0 1 1 20 20
				"
				fill="none"
				stroke="var(--icon-color)"
				stroke-width="12"
				stroke-dasharray="30 10 20 10 20 10 10"
				style="stroke-linecap: butt;"
			/>
		`,o.setAttribute("viewBox","-5 -5 110 110"),o}makeHandToolIcon(){return this.makeIconFromPath(`
			m 10,60
				5,30
			H 90
			V 30
			C 90,20 75,20 75,30
			V 60
				20
			C 75,10 60,10 60,20
			V 60
				15
			C 60,5 45,5 45,15
			V 60
				25
			C 45,15 30,15 30,25
			V 60
				75
			L 25,60
			C 20,45 10,50 10,60
			Z
		`,"none","var(--icon-color)","3")}makeTouchPanningIcon(){return this.makeIconFromPath(`
			M 5,5.5
			V 17.2
			L 16.25,5.46
			Z

			m 33.75,0
			L 50,17
			V 5.5
			Z

			M 5,40.7
			v 11.7
			h 11.25
			z

			M 26,19
			C 19.8,19.4 17.65,30.4 21.9,34.8
			L 50,70
			H 27.5
			c -11.25,0 -11.25,17.6 0,17.6
			H 61.25
			C 94.9,87.8 95,87.6 95,40.7 78.125,23 67,29 55.6,46.5
			L 33.1,23
			C 30.3125,20.128192 27.9,19 25.830078,19.119756
			Z
		`,"none","var(--icon-color)","3")}makeAllDevicePanningIcon(){return this.makeIconFromPath(`
			M 5 5
			L 5 17.5
				17.5 5
				5 5
			z

			M 42.5 5
			L 55 17.5
				55 5
				42.5 5
			z

			M 70 10
			L 70 21
				61 15
				55.5 23
				66 30
				56 37
				61 45
				70 39
				70 50
				80 50
				80 39
				89 45
				95 36
				84 30
				95 23
				89 15
				80 21
				80 10
				70 10
			z

			M 27.5 26.25
			L 27.5 91.25
			L 43.75 83.125
			L 52 99
			L 68 91
			L 60 75
			L 76.25 66.875
			L 27.5 26.25
			z

			M 5 42.5
			L 5 55
			L 17.5 55
			L 5 42.5
			z
		`,"none","var(--icon-color)","3")}makeZoomIcon(){let o=document.createElementNS(j,"svg");o.setAttribute("viewBox","0 0 100 100");let e=(i,r,n)=>{let a=document.createElementNS(j,"text");a.appendChild(document.createTextNode(i)),a.setAttribute("x",r.toString()),a.setAttribute("y",n.toString()),a.style.textAlign="center",a.style.textAnchor="middle",a.style.fontSize="55px",a.style.fill="var(--icon-color)",a.style.fontFamily="monospace",o.appendChild(a);};return e("+",40,45),e("-",70,75),o}makeRotationLockIcon(){let o=this.makeIconFromPath(`
			M 40.1 25.1
			C 32.5 25 27.9 34.1 27.9 34.1
			L 25.7 30
			L 28 44.7
			L 36.6 40.3
			L 32.3 38.3
			C 33.6 28 38.1 25.2 45.1 31.8
			L 49.4 29.6
			C 45.9 26.3 42.8 25.1 40.1 25.1
			z

			M 51.7 34.2
			L 43.5 39.1
			L 48 40.8
			C 47.4 51.1 43.1 54.3 35.7 48.2
			L 31.6 50.7
			C 45.5 62.1 52.6 44.6 52.6 44.6
			L 55.1 48.6
			L 51.7 34.2
			z

			M 56.9 49.9
			C 49.8 49.9 49.2 57.3 49.3 60.9
			L 47.6 60.9
			L 47.6 73.7
			L 66.1 73.7
			L 66.1 60.9
			L 64.4 60.9
			C 64.5 57.3 63.9 49.9 56.9 49.9
			z

			M 56.9 53.5
			C 60.8 53.5 61 58.2 60.8 60.9
			L 52.9 60.9
			C 52.7 58.2 52.9 53.5 56.9 53.5
			z
		`);return o.setAttribute("viewBox","10 10 70 70"),o}makeInsertImageIcon(){return this.makeIconFromPath(`
			M 5 10 L 5 90 L 95 90 L 95 10 L 5 10 z
			M 10 15 L 90 15 L 90 50 L 70 75 L 40 50 L 10 75 L 10 15 z
			M 22.5 25 A 7.5 7.5 0 0 0 15 32.5 A 7.5 7.5 0 0 0 22.5 40 A 7.5 7.5 0 0 0 30 32.5 A 7.5 7.5 0 0 0 22.5 25 z
		`)}makeUploadFileIcon(){return this.makeIconFromPath(`
			M 48,10 32,34 43,33 42,68
			H 54
			L 53,33 64,34 Z

			M 8,66 V 86 H 88 V 66 H 78 V 76 H 18 V 66 Z
		`)}makeTextIcon(o){let e=document.createElementNS(j,"svg");e.setAttribute("viewBox","0 0 100 100");let i=document.createElementNS(j,"text");return i.appendChild(document.createTextNode("T")),i.style.fontFamily=o.fontFamily,i.style.fontWeight=o.fontWeight??"",i.style.fontVariant=o.fontVariant??"",i.style.fill=o.renderingStyle.fill.toHexString(),i.style.textAnchor="middle",i.setAttribute("x","50"),i.setAttribute("y","75"),i.style.fontSize="65px",i.style.filter="drop-shadow(0px 0px 10px var(--shadow-color))",e.appendChild(i),e}makePenIcon(o){let e=Math.round(Math.sqrt(o.thickness)*4),i=o.color,r=this.isRoundedTipPen(o),n=e/2,a=`
			M ${15-n},${80-n}
			  ${15-n},${80+n}
			  30,83
			  15,65
			Z
		`,l=80+n,c=`
			m ${15-n*1.1},${l}
			c 35,10 55,15 60,30
			l ${35+n*1.2},${ -10-n}
			C 80.47,98.32 50.5,${90+n} 20,${l} Z
		`,d=`
			M 72.45,35.67
			A 10,15 41.8 0 1 55,40.2 10,15 41.8 0 1 57.55,22.3 10,15 41.8 0 1 75,17.8 10,15 41.8 0 1 72.5,35.67
			Z
		`,p="M 85,-25 25,35 h 10 v 10 h 10 v 10 h 10 v 10 h 10 l -5,10 60,-60 z",u="M 25,35 H 35 L 90,-15 85,-25 Z",h="M 60,75 65,65 H 55 l 55,-55 10,5 z";r&&(p="M 85,-25 25,35 c 15,0 40,30 35,40 l 60,-60 z",u="m 25,35 c 3.92361,0.384473 7.644275,0.980572 10,3 l 55,-53 -5,-10 z",h="M 60,75 C 61,66 59,65 56,59 l 54,-54 10,10 z");let m=`M 25,35 ${10-n/4},${70-n/2} 20,75 25,85 60,75 70,55 45,25 Z`,g=P.fromHex("#f4d7d7").mix(i,n/40-.1).toHexString(),y=Mi(),v=i.toHexString(),b=Di({fill:y.patternRef,d:a},{fill:y.patternRef,d:c},{fill:v,d:a},{fill:v,d:c}),S=Di({fill:y.patternRef,d:m},{fill:g,stroke:v,d:m}),T=Di({fill:"var(--icon-color)",stroke:"var(--icon-color)",d:p},{fill:"rgba(150, 150, 150, 0.3)",d:u},{fill:"rgba(100, 100, 100, 0.2)",d:h},{fill:y.patternRef,d},{fill:v,d}),C=document.createElementNS(j,"svg");C.setAttribute("viewBox","0 0 100 100");let R=Re("g",{children:[b,S,T].flat()}),k=Re("defs",{children:[y.patternDefElement]});return C.replaceChildren(k,R),C}makeIconFromFactory(o){let e=Math.sqrt(o.thickness)*3,i=performance.now(),r={pos:exports.Vec2.of(10,10),width:e,color:o.color,time:i-100},n={pos:exports.Vec2.of(90,90),width:e,color:o.color,time:i},a=new A(()=>{}),l=o.factory(r,a);l.addPoint(n);let c=document.createElementNS(j,"svg");c.setAttribute("viewBox","0 0 100 100"),a.updateScreenSize(exports.Vec2.of(100,100));let d;if(o.color.a<1){let h=Mi(),m=document.createElementNS(j,"defs");m.appendChild(h.patternDefElement),c.appendChild(m);let f=document.createElementNS(j,"g");c.appendChild(f),d=new class extends ae{constructor(){super(c,a);}addPathToSVG(){let g=super.addPathToSVG();if(g){let y=g.cloneNode(true);y.style.zIndex="-1",y.hasAttribute("stroke")?y.setAttribute("stroke",h.patternRef):y.hasAttribute("fill")&&y.setAttribute("fill",h.patternRef),f.appendChild(y);}return g}};}else d=new ae(c,a);l.preview(d);let u=l.getBBox();return c.setAttribute("viewBox",`${u.x} ${u.y} ${u.w} ${u.h}`),c}makePipetteIcon(o){let e=document.createElementNS(j,"svg"),i=document.createElementNS(j,"g");i.style.rotate="45deg",i.style.transformOrigin="center";let r=document.createElementNS(j,"g");if(r.innerHTML=`
		<path
			style="fill: var(--icon-color); stroke-linecap:round; stroke-linejoin:round;"
			d="
				m 32,12 v 68
				c 0,1 0.5,2 1.33,2.5 1.67,1.15 3.67,2.1 5.17,3.2 1.4,1.1 2.3,2.1 2.5,3.1 0.6,2.1 1,4.6 1,6.2 0,3.7 5.45,4.1 6,0.4 l 0.9,-6.8
				c 0.3,-0.9 1.1,-1.9 2.6,-2.9 1.5,-1.1 3.4,-2 5.1,-3.2
				C 57.5,82 58,81 58,80
				V 12 Z m 20,25 v 41.3
				c 0,1.7 -2.5,1.6 -4,2.7 -1,0.76 -2.1,1.5 -3,2.6
				C 44,82.5 43.02,81.75 42,81 40.51,79.92 38,80 38,78.34
				V 51 Z
			"
		/>
		<rect
			style="fill: var(--icon-color);"
			width="32"
			height="9"
			x="29"
			y="2"
			ry="4.5"
		/>
		<path
			style="fill: var(--icon-color);"
			d="m 45,-25 c -5.54,0 -11,4.26 -11,9 V 0 h 22 v -16 c 0,-4.74 -5.46,-9 -11,-9 z"
		/>
		`,o){let n=Mi(),a=document.createElementNS(j,"defs");a.appendChild(n.patternDefElement),e.appendChild(a);let l=document.createElementNS(j,"path"),c=document.createElementNS(j,"path"),d=`
				M 35,36 H 55 V 78.678012 83 L 45,87 35,83 Z
			`;c.setAttribute("d",d),l.setAttribute("d",d),c.style.fill=o.toHexString(),l.style.fill=n.patternRef,i.appendChild(l),i.appendChild(c);}return i.appendChild(r),e.appendChild(i),e.setAttribute("viewBox","5 -40 140 140"),e}makeShapeAutocorrectIcon(){return this.makeIconFromPath(`
			m 79.129476,33.847107 9.967823,-0.03218 v 55 h -55 l 0.03218,-9.96782
			M 71.1,40.8 a 30,30 0 0 1 -30,30 30,30 0 0 1 -30,-30 30,30 0 0 1 30,-30 30,30 0 0 1 30,30 L 71.1,40.8
			M 34.1,58.8 v -25 h 25 v 0
		`,"none","var(--icon-color)","7px")}makeStrokeSmoothingIcon(){return this.makeIconFromPath(`
			m 31,83.2 c -50,0 30,-65 -20,-65
			M 75,17.3 40,59.7 38.2,77.6 55.5,72.4 90.5,30 Z
		`,"none","var(--icon-color)","7px")}makeFormatSelectionIcon(){return this.makeIconFromPath(`
			M 5 10
			L 5 20 L 10 20 L 10 15 L 20 15 L 20 40 L 15 40 L 15 45 L 35 45 L 35 40 L 30 40 L 30 15 L 40 15 L 40 20 L 45 20 L 45 15 L 45 10 L 5 10 z
			M 90 10 C 90 10 86.5 13.8 86 14 C 86 14 76.2 24.8 76 25 L 60 25 L 60 65 C 75 70 85 70 90 65 L 90 25 L 80 25 L 76.7 25 L 90 10 z
			M 60 25 L 55 25 L 50 30 L 60 25 z
			M 10 55 L 10 90 L 41 90 L 41 86 L 45 86 L 45 55 L 10 55 z
			M 42 87 L 42 93 L 48 93 L 48 87 L 42 87 z
		`)}makeResizeImageToSelectionIcon(){return this.makeIconFromPath(`
			M 75 5 75 10 90 10 90 25 95 25 95 5 75 5 z
			M 15 15 15 30 20 30 20 20 30 20 30 15 15 15 z
			M 84 15 82 17 81 16 81 20 85 20 84 19 86 17 84 15 z
			M 26 24 24 26 26 28 25 29 29 29 29 25 28 26 26 24 z
			M 25 71 26 72 24 74 26 76 28 74 29 75 29 71 25 71 z
			M 15 75 15 85 25 85 25 80 20 80 20 75 15 75 z
			M 90 75 90 90 75 90 75 95 95 95 95 75 90 75 z
			M 81 81 81 85 82 84 84 86 86 84 84 82 85 81 81 81 z
		`)}makeResizeViewportIcon(){return this.makeResizeImageToSelectionIcon()}makeDuplicateSelectionIcon(){return this.makeIconFromPath(`
			M 45,10 45,55 90,55 90,10 45,10 z
			M 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z
		`)}makeCopyIcon(){return this.makeIconFromPath(`
			M 45,10 45,55 90,55 90,10 45,10 z
			M 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z
		`)}makePasteIcon(){let o=this.makeIconFromPath(`
			M 50 0 L 50 5 L 35 5 L 40 24.75 L 20 25 L 20 100 L 85 100 L 100 90 L 100 24 L 75.1 24.3 L 80 5 L 65 5 L 65 0 L 50 0 z
			M 10 15 L 10 115 L 110 115 L 110 15 L 85 15 L 83 20 L 105 20 L 105 110 L 15 110 L 15 20 L 32 20 L 30 15 L 10 15 z
			M 25 35 L 90 35 L 90 40 L 25 40 L 25 35 z
			M 25 45 L 90 45 L 90 50 L 25 50 L 25 45 z
			M 25 55 L 85 55 L 85 60 L 25 60 L 25 55 z
			M 25 65 L 90 65 L 90 70 L 25 70 L 25 65 z
		`);return o.setAttribute("viewBox","0 0 120 120"),o}#e(){return this.makeIconFromPath(`
			M 15,15 85,85
			M 15,85 85,15
		`,"none","var(--icon-color)","6px")}makeDeleteSelectionIcon(){return this.#e()}makeCloseIcon(){return this.#e()}makeSaveIcon(){let o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.innerHTML=`
			<style>
				.toolbar-save-icon {
					stroke: var(--icon-color);
					stroke-width: 6;
					stroke-linejoin: round;
					stroke-linecap: round;
					fill: none;
				}
			</style>
			<path
				d='
					M 15,55 30,70 85,20
				'
				class='toolbar-save-icon'
			/>
		`,o.setAttribute("viewBox","0 0 100 100"),o}makeConfigureDocumentIcon(){let o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.innerHTML=`
			<path
				d='
					M 5,5 V 95 H 95 V 5 Z m 5,5 H 90 V 90 H 10 Z
					m 5,10 V 30 H 50 V 25 H 20 v -5 z
					m 40,0 V 50 H 85 V 20 Z
					m 2,2 H 83 V 39 L 77,28 70,42 64,35 57,45 Z
					m 8.5,5 C 64.67,27 64,27.67 64,28.5 64,29.33 64.67,30 65.5,30 66.33,30 67,29.33 67,28.5 67,27.67 66.33,27 65.5,27 Z
					M 15,40 v 5 h 35 v -5 z
					m 0,15 v 5 h 70 v -5 z
					m 0,15 v 5 h 70 v -5 z
				'
				style='fill: var(--icon-color);'
			/>
		`,o.setAttribute("viewBox","0 0 100 100"),o}makeOverflowIcon(){return this.makeIconFromPath(`
			M 15 40
			A 12.5 12.5 0 0 0 2.5 52.5
			A 12.5 12.5 0 0 0 15 65
			A 12.5 12.5 0 0 0 27.5 52.5
			A 12.5 12.5 0 0 0 15 40
			z

			M 50 40
			A 12.5 12.5 0 0 0 37.5 52.5
			A 12.5 12.5 0 0 0 50 65
			A 12.5 12.5 0 0 0 62.5 52.5
			A 12.5 12.5 0 0 0 50 40
			z

			M 85 40
			A 12.5 12.5 0 0 0 72.5 52.5
			A 12.5 12.5 0 0 0 85 65
			A 12.5 12.5 0 0 0 97.5 52.5
			A 12.5 12.5 0 0 0 85 40
			z
		`)}makeHelpIcon(){let o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.innerHTML=`
			<circle
				style="stroke-width:1.587; stroke: var(--icon-color);"
				fill="none"
				cx="13.23"
				cy="13.23"
				r="11.9"
			/>
			<path
				style="stroke-width: 3; stroke-linecap: butt; stroke: var(--icon-color);"
				fill="none"
				d="M 9.26,6.61 C 18.7,3.25 19.95,10.4 14.3,13.4 c -1.15,0.61 -1.32,1.32 -1.32,2.65 v 2.12"
			/>
			<circle
				style="fill: var(--icon-color);"
				cx="13"
				cy="21.32"
				r="1.9"
			/>
		`,o.setAttribute("viewBox","0 0 26.46 26.46"),o.setAttribute("width","100"),o.setAttribute("height","100"),o}makeIconFromPath(o,e="var(--icon-color)",i="none",r="0px"){let n=document.createElementNS(j,"svg"),a=document.createElementNS(j,"path");return a.setAttribute("d",o),a.style.fill=e,a.style.stroke=i,a.style.strokeWidth=r,n.appendChild(a),n.setAttribute("viewBox","0 0 100 100"),n}makeCheckerboardPattern(){return Mi()}isRoundedTipPen(o){return o.factory===fe||o.factory===Be}isPolylinePen(o){return o.factory===Be}licenseInfo(){return null}};var Io=class extends Q{overflowChildren=[];overflowContainer;constructor(o,e){super(o,"overflow-widget",e),this.container.classList.add("toolbar-overflow-widget"),this.container.classList.add("dropdownShowable"),this.overflowContainer??=document.createElement("div");}shouldAutoDisableInReadOnlyEditor(){return  false}getTitle(){return this.localizationTable.toggleOverflow}createIcon(){return this.editor.icons.makeOverflowIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible());}fillDropdown(o){return this.overflowContainer??=document.createElement("div"),this.overflowContainer.parentElement&&this.overflowContainer.remove(),this.overflowContainer.classList.add("toolbar-overflow-widget-overflow-list"),o.appendChild(this.overflowContainer),true}clearChildren(){this.overflowContainer.replaceChildren(),this.container.classList.remove("horizontal");let o=this.overflowChildren;return this.overflowChildren=[],o}getChildWidgets(){return [...this.overflowChildren]}hasAsChild(o){for(let e of this.overflowChildren)if(o===e)return  true;return  false}addToOverflow(o){this.overflowChildren.push(o),o.addTo(this.overflowContainer),o.setIsToplevel(false),this.overflowChildren.length>2&&this.container.classList.add("horizontal");}canBeInOverflowMenu(){return  false}};function Xa(s){return new Vi(s,s.getRootElement(),s.localization)}var Vi=class extends _e{container;resizeObserver;widgetOrderCounter=0;overflowWidget=null;constructor(o,e,i){super(o,i),this.container=document.createElement("div"),this.container.classList.add(`${L}root`),this.container.classList.add(`${L}element`),this.container.classList.add(`${L}dropdown-toolbar`),this.container.setAttribute("role","toolbar"),e.appendChild(this.container),"ResizeObserver"in window?(this.resizeObserver=new ResizeObserver(r=>{this.reLayout();}),this.resizeObserver.observe(this.container)):console.warn("ResizeObserver not supported. Toolbar will not resize.");}reLayoutQueued=false;queueReLayout(){this.reLayoutQueued||(this.reLayoutQueued=true,requestAnimationFrame(()=>this.reLayout()));}reLayout(){if(this.reLayoutQueued=false,!this.overflowWidget)return;let o=c=>{let d=0;for(let p of c)p.isHidden()||(d+=p.getButtonWidth());return d},e=c=>{let d=this.overflowWidget?.getChildWidgets()??[];return d.length===0?false:d[0].getButtonWidth()<=c},i=this.getAllWidgets(),r=o(this.overflowWidget.getChildWidgets()),n=o(i)-r,a=this.container.clientWidth*.87;window.innerHeight>a*1.75&&(a*=1.75);let l=false;if(e(a-n)){let c=this.overflowWidget.clearChildren();for(let d of c)d.addTo(this.container),d.setIsToplevel(true),d.isHidden()||(n+=d.getButtonWidth());r=0,l=true;}if(n>=a){for(let c=i.length-1;c>=0&&n>=a;c--){let d=i[c];this.overflowWidget.hasAsChild(d)||d.canBeInOverflowMenu()&&(n-=d.getButtonWidth(),this.overflowWidget.addToOverflow(d));}l=true;}this.overflowWidget.setHidden(this.overflowWidget.getChildWidgets().length===0),l&&this.setupColorPickers();}addWidgetInternal(o){let e=o.addTo(this.container);e.style.order=`${this.widgetOrderCounter++}`,this.queueReLayout();}removeWidgetInternal(o){o.remove(),this.queueReLayout();}addSpacer(o={}){let e=document.createElement("div");e.classList.add(`${L}spacer`),o.grow&&(e.style.flexGrow=`${o.grow}`),o.minSize&&(e.style.minWidth=o.minSize),o.maxSize&&(e.style.maxWidth=o.maxSize),e.style.order=`${this.widgetOrderCounter++}`,this.container.appendChild(e);}addOverflowWidget(){this.overflowWidget=new Io(this.editor,this.localizationTable),this.addWidget(this.overflowWidget);}addDefaults(){this.addDefaultToolWidgets(),this.addOverflowWidget(),this.addDefaultActionButtons();}onRemove(){this.container.remove(),this.resizeObserver.disconnect();}getWidgetById(o){for(let e of this.getAllWidgets())if(e.getId()===o)return e;return null}};var ko=class{constructor(o,e,i,r,n){this.setSidebarContent=o;this.sidebarTitle=e;this.sidebarVisibility=i;this.announceForAccessibility=r;this.localization=n;}visibleWidgetContent=N.fromInitialValue(null);createToolMenu(o){let e=document.createElement("div"),i=null,r=N.fromCallback(()=>this.visibleWidgetContent.get()===i&&this.sidebarVisibility.get(),[this.visibleWidgetContent,this.sidebarVisibility]);return i={visible:r,requestShow:()=>{this.setSidebarContent(e),this.sidebarTitle.set(o.getTitle()),this.visibleWidgetContent.set(i),this.sidebarVisibility.set(true),this.announceForAccessibility(this.localization.dropdownShown(o.getTitle()));},onActivated:()=>{},requestHide:()=>{r.get()&&this.sidebarVisibility.set(false);},appendChild:n=>{e.appendChild(n);},clearChildren:()=>{e.replaceChildren();},destroy:()=>{i?.requestHide(),e.parentElement&&e.remove(),this.visibleWidgetContent.get()===i&&this.visibleWidgetContent.set(null);}},i}};function Qa(s){return new Ut(s,s.getRootElement(),s.localization)}var Ut=class extends _e{toolbarContainer;toolbarActionRow;toolbarToolRow;toolRowResizeObserver;menuContainer;sidebarContainer;sidebarContent;closeButton;layoutManager;sidebarVisible;sidebarY;sidebarTitle;clearDragListeners=null;constructor(o,e,i){super(o,i),this.toolbarContainer=document.createElement("div"),this.toolbarContainer.classList.add(`${L}root`),this.toolbarContainer.classList.add(`${L}element`),this.toolbarContainer.classList.add(`${L}edge-toolbar`),this.toolbarContainer.setAttribute("role","toolbar"),this.toolbarActionRow=document.createElement("div"),this.toolbarActionRow.classList.add("toolbar-element","toolbar-action-row"),this.toolbarToolRow=document.createElement("div"),this.toolbarToolRow.classList.add("toolbar-element","toolbar-tool-row"),gt(this.toolbarToolRow),"ResizeObserver"in window?(this.toolRowResizeObserver=new ResizeObserver(n=>{this.onToolbarRowResize();}),this.toolRowResizeObserver.observe(this.toolbarToolRow)):console.warn("ResizeObserver not supported. Toolbar will not resize."),this.toolbarContainer.replaceChildren(this.toolbarActionRow,this.toolbarToolRow),e.appendChild(this.toolbarContainer),this.sidebarVisible=N.fromInitialValue(false),this.sidebarY=N.fromInitialValue(0),this.menuContainer=document.createElement("div"),this.menuContainer.classList.add(`${L}edgemenu-container`),this.sidebarContainer=document.createElement("div"),this.sidebarContainer.classList.add(`${L}edgemenu`,`${L}element`),this.sidebarContainer.classList.add(`${L}tool-properties`),this.sidebarContent=document.createElement("div"),this.sidebarY.onUpdateAndNow(n=>{let a="dropdown-below-edge";n>0?(this.sidebarContainer.style.transform=`translate(0, ${n}px)`,this.sidebarContainer.style.paddingBottom="",this.menuContainer.classList.add(a)):(this.sidebarContainer.style.transform="",this.sidebarContainer.style.paddingBottom=`${-n}px`,this.menuContainer.classList.remove(a));}),this.closeButton=document.createElement("button"),this.closeButton.classList.add("drag-elem"),this.editor.handleKeyEventsFrom(this.closeButton,n=>n.code!=="Space"&&n.code!=="Enter"&&n.code!=="Tab"),this.sidebarContainer.addEventListener("keyup",n=>{!n.defaultPrevented&&n.code==="Escape"&&(this.sidebarVisible.set(false),n.preventDefault());}),this.initDragListeners();let r=(...n)=>{this.sidebarContent.replaceChildren(...n),this.setupColorPickers();};this.sidebarTitle=Z.fromInitialValue(""),this.layoutManager=new ko(r,this.sidebarTitle,this.sidebarVisible,o.announceForAccessibility.bind(o),i),this.sidebarTitle.onUpdateAndNow(n=>{this.closeButton.setAttribute("aria-label",i.closeSidebar(n));}),this.listenForVisibilityChanges(),this.sidebarContainer.replaceChildren(this.closeButton,this.sidebarContent),this.menuContainer.replaceChildren(this.sidebarContainer),e.appendChild(this.menuContainer);}listenForVisibilityChanges(){let o=null,e=170;this.sidebarVisible.get()||(this.menuContainer.style.display="none",this.menuContainer.style.opacity="0");let i=window.matchMedia?.("(prefers-reduced-motion: reduce)")??"";this.sidebarVisible.onUpdate(r=>{let n=`${e}ms ease`,a=i.matches?"-reduce-motion":"";r?(this.sidebarY.set(this.snappedSidebarY()),o&&(clearTimeout(o),o=null),this.menuContainer.style.display="",this.sidebarContainer.style.animation=`${n} ${L}-edgemenu-transition-in${a}`,this.menuContainer.style.animation=`${n} ${L}-edgemenu-container-transition-in${a}`,this.menuContainer.style.opacity="1",this.closeButton.focus({preventScroll:true})):(this.closeColorPickers(),o===null&&(this.sidebarContainer.style.animation=`${n} ${L}-edgemenu-transition-out${a}`,this.menuContainer.style.animation=`${n} ${L}-edgemenu-container-transition-out${a}`,this.menuContainer.style.opacity="0",this.editor.announceForAccessibility(this.localizationTable.dropdownHidden(this.sidebarTitle.get())),o=setTimeout(()=>{this.menuContainer.style.display="none",this.menuContainer.style.overflowY="",o=null;},e)));});}onToolbarRowResize(){let o=()=>{let n=this.toolbarToolRow.clientWidth,a=0,l=0,c=0;for(let p of this.toolbarToolRow.children){let u=p.clientHeight;if(a+=u,c++,a>n){l=n-a+u/2,l<0&&(l+=u);break}}let d=Math.round(l/c*10)/10;this.toolbarToolRow.style.setProperty("--extra-left-right-padding",`${d}px`);},e=this.toolbarActionRow.getBoundingClientRect(),i=this.toolbarToolRow.getBoundingClientRect();e.y+e.height<=i.y?this.toolbarContainer.classList.remove("one-row"):this.toolbarContainer.classList.add("one-row"),this.toolbarToolRow.clientWidth<this.toolbarToolRow.scrollWidth?(this.toolbarToolRow.classList.add("has-scroll"),o()):this.toolbarToolRow.classList.remove("has-scroll","extra-padding");}addSpacer(o){}addUndoRedoButtons(){super.addUndoRedoButtons(false);}addDefaults(){this.addDefaultActionButtons(),this.addDefaultToolWidgets();}updateWidgetCSSClasses(o){let e=o.getTags();o.removeCSSClassFromContainer("label-inline"),o.removeCSSClassFromContainer("label-left"),o.removeCSSClassFromContainer("label-right"),e.includes("save")&&(o.addCSSClassToContainer("label-inline"),o.addCSSClassToContainer("label-left")),e.includes("exit")&&(o.addCSSClassToContainer("label-inline"),o.addCSSClassToContainer("label-right"));}addWidgetInternal(o){this.updateWidgetCSSClasses(o),o.setLayoutManager(this.layoutManager),o.mustBeInToplevelMenu()?o.addTo(this.toolbarActionRow):o.addTo(this.toolbarToolRow);}removeWidgetInternal(o){o.remove();}onRemove(){this.toolbarContainer.remove(),this.menuContainer.remove(),this.toolRowResizeObserver.disconnect(),this.clearDragListeners?.();}initDragListeners(){let o=[this.closeButton,this.sidebarContainer,this.sidebarContent];this.manageListener(this.editor.handlePointerEventsExceptClicksFrom(this.menuContainer,(n,a)=>a.target===this.menuContainer?(n==="pointerdown"&&(this.sidebarVisible.set(false),setTimeout(()=>this.editor.focus(),0)),true):!this.sidebarVisible.get(),(n,a)=>a.target===this.menuContainer));let e=true,i=0,r=li(this.sidebarContainer,{draggableChildElements:o,onDrag:(n,a)=>this.handleDrag(n,a),onDragEnd:n=>{i=n.endTimestamp,e=n.roughlyClick,this.finalizeDrag();}});this.clearDragListeners=()=>r.removeListeners(),this.closeButton.addEventListener("click",()=>{let n=performance.now()-i<100;(n&&e||!n)&&this.sidebarVisible.set(false);});}handleDrag(o,e){this.sidebarContainer.style.transition="none",this.sidebarY.set(this.sidebarY.get()+e);}snappedSidebarY(o){let e=o??this.sidebarY.get(),i=[-100,0];this.sidebarContainer.clientHeight>window.innerHeight&&i.push(100);let r=i[0];for(let n of i)Math.abs(n-e)<Math.abs(r-e)&&(r=n);return r}finalizeDrag(){this.sidebarContainer.style.transition="",this.sidebarY.get()>this.sidebarContainer.clientHeight/2?this.sidebarVisible.set(false):this.sidebarY.set(this.snappedSidebarY());}serializeInternal(){return {menuSizeY:this.snappedSidebarY()}}deserializeInternal(o){typeof o=="object"&&typeof o.menuSizeY=="number"&&this.sidebarY.set(this.snappedSidebarY(o.menuSizeY));}};var qe=class s extends ve{clearedCount=0;renderedPathCount=0;lastFillStyle=null;lastPoint=null;objectNestingLevel=0;lastText=null;lastImage=null;pointBuffer=[];constructor(o){super(o);}displaySize(){let o=this.getViewport().getScreenRectSize();return o.x===0||o.y===0?exports.Vec2.of(640,480):o}clear(){if(this.clearedCount++,this.renderedPathCount=0,this.pointBuffer=[],this.lastText=null,this.lastImage=null,this.objectNestingLevel>0)throw new Error(`Within an object while clearing! Nesting level: ${this.objectNestingLevel}`)}beginPath(o){this.lastPoint=o,this.pointBuffer.push(o);}endPath(o){this.renderedPathCount++,this.lastFillStyle=o;}lineTo(o){o=this.canvasToScreen(o),this.lastPoint=o,this.pointBuffer.push(o);}moveTo(o){o=this.canvasToScreen(o),this.lastPoint=o,this.pointBuffer.push(o);}traceCubicBezierCurve(o,e,i){o=this.canvasToScreen(o),e=this.canvasToScreen(e),i=this.canvasToScreen(i),this.lastPoint=i,this.pointBuffer.push(o,e,i);}traceQuadraticBezierCurve(o,e){o=this.canvasToScreen(o),e=this.canvasToScreen(e),this.lastPoint=e,this.pointBuffer.push(o,e);}drawPoints(...o){}drawText(o,e,i){this.lastText=o;}drawImage(o){this.lastImage=o;}startObject(o,e){super.startObject(o),this.objectNestingLevel+=1;}endObject(){super.endObject(),this.objectNestingLevel-=1;}isTooSmallToRender(o){return  false}canRenderFromWithoutDataLoss(o){return o instanceof s}renderFromOtherOfSameType(o,e){if(!(e instanceof s))throw new TypeError(`${e} cannot be rendered onto ${this}`);this.renderedPathCount+=e.renderedPathCount,this.lastFillStyle=e.lastFillStyle,this.lastPoint=e.lastPoint,this.pointBuffer.push(...e.pointBuffer.map(i=>o.transformVec2(i)));}toString(){return "[DummyRenderer]"}};var Ro=class{constructor(o,e){this.onBeforeDeallocCallback=o;this.cacheState=e;this.renderer=e.props.createRenderer(),this.lastUsedCycle=-1,this.allocd=true;}renderer;lastUsedCycle;allocd=false;allocCount=0;startRender(){if(this.lastUsedCycle=this.cacheState.currentRenderingCycle,!this.allocd)throw new Error("Only alloc'd canvases can be rendered to");return this.renderer}dealloc(){this.onBeforeDeallocCallback?.(),this.allocd=false,this.onBeforeDeallocCallback=null,this.lastUsedCycle=0;}isAllocd(){return this.allocd}realloc(o){this.allocd&&this.dealloc(),this.allocd=true,this.onBeforeDeallocCallback=o,this.lastUsedCycle=this.cacheState.currentRenderingCycle,this.allocCount++;}getLastUsedCycle(){return this.lastUsedCycle}getTransform(o){return w.scaling2D(this.cacheState.props.blockResolution.x/o.size.x).rightMul(w.translation(o.topLeft.times(-1)))}setRenderingRegion(o){let e=this.getTransform(o);this.renderer.setTransform(e),this.renderer.overrideVisibleRect(o.grownBy(1/e.getScaleFactor()));}};var Fi=class{cacheRecords=[];maxCanvases;cacheState;constructor(o){this.maxCanvases=Math.ceil(o.cacheSize/4/o.blockResolution.x/o.blockResolution.y);}setSharedState(o){this.cacheState=o;}allocCanvas(o,e){if(this.cacheRecords.length<this.maxCanvases){let i=new Ro(e,this.cacheState);return i.setRenderingRegion(o),this.cacheRecords.push(i),this.cacheState.debugMode&&console.log("[Cache] Cache spaces used: ",this.cacheRecords.length," of ",this.maxCanvases),i}else {let i=this.getLeastRecentlyUsedRecord();return this.cacheState.debugMode&&console.log("[Cache] Re-alloc. Times allocated: ",i.allocCount,`
Last used cycle: `,i.getLastUsedCycle(),`
Current cycle: `,this.cacheState.currentRenderingCycle),i.realloc(e),i.setRenderingRegion(o),this.cacheState.debugMode&&(console.log("[Cache] Now re-alloc'd. Last used cycle: ",i.getLastUsedCycle()),console.assert(i.cacheState===this.cacheState,"[Cache] Unequal cache states! cacheState should be a shared object!")),i}}getLeastRecentlyUsedRecord(){return this.cacheRecords.sort((o,e)=>o.getLastUsedCycle()-e.getLastUsedCycle()),this.cacheRecords[0]}getDebugInfo(){let o=0,e=0;for(let r of this.cacheRecords)e+=r.allocCount,r.isAllocd()&&o++;return e/=Math.max(this.cacheRecords.length,1),[`${this.cacheRecords.length} cache records (max ${this.maxCanvases})`,`${o} assigned to screen regions`,`Average number of times reassigned: ${Math.round(e*100)/100}`].join(`
`)}};var Ve=3,Lo=class s{constructor(o,e){this.region=o;this.cacheState=e;}instantiatedChildren=[];parent=null;cachedRenderer=null;renderedIds=[];renderedMaxZIndex=null;generateParent(){if(this.parent)return this.parent;let o=I.fromCorners(this.region.topLeft.minus(this.region.size),this.region.bottomRight.plus(this.region.size)),e=new s(o,this.cacheState);e.generateChildren();let i=this.region.maxDimension/100,r=(e.instantiatedChildren.length-1)/2;if(!e.instantiatedChildren[r].region.eq(this.region,i))throw console.error(e.instantiatedChildren[r].region,"\u2260",this.region),new Error("Logic error: [this] is not contained within its parent's center child");return e.instantiatedChildren[r]=this,this.parent=e,e}generateChildren(){if(this.instantiatedChildren.length===0){if(this.region.size.x/Ve===0||this.region.size.y/Ve===0){console.warn("Cache element has zero size! Not generating children.");return}let o=this.region.divideIntoGrid(Ve,Ve);console.assert(o.length===Ve*Ve,"Warning: divideIntoGrid created the wrong number of subrectangles!");for(let e of o){let i=new s(e,this.cacheState);i.parent=this,this.instantiatedChildren.push(i);}}this.checkRep();}getChildren(){return this.checkRep(),this.generateChildren(),this.instantiatedChildren}smallestChildContaining(o){let e=o.maxDimension>this.region.maxDimension/Ve;if(!this.region.containsRect(o)||e)return null;for(let i of this.getChildren())if(i.region.containsRect(o))return i.smallestChildContaining(o)??i;return null}renderingWouldBeHighEnoughResolution(o){let e=this.region.w/this.cacheState.props.blockResolution.x;return !(o.getScaleFactor()*e>this.cacheState.props.maxScale)}allChildrenCanRender(o,e){if(this.instantiatedChildren.length===0)return  false;for(let i of this.instantiatedChildren)if(i.region.intersects(o.visibleRect)&&!i.renderingIsUpToDate(this.idsOfIntersecting(e)))return  false;return  true}computeSortedByLeafIds(o){let e=o.slice();return e.sort((i,r)=>i.getId()-r.getId()),e}idsOfIntersecting(o){let e=[];for(let i of o)i.getBBox().intersects(this.region)&&e.push(i.getId());return e}allRenderedIdsIn(o){if(this.renderedIds.length>o.length)return  false;for(let e=0;e<this.renderedIds.length;e++)if(o[e]!==this.renderedIds[e])return  false;return  true}renderingIsUpToDate(o){return this.cachedRenderer===null||o.length!==this.renderedIds.length?false:this.allRenderedIdsIn(o)}renderItems(o,e,i){if(!i.visibleRect.intersects(this.region)||e.length===0)return;if(e=(a=>{let l=[];for(let c of a){let d=c.getBBox();d.intersects(this.region)&&(d.maxDimension>=this.region.maxDimension?l.push(...c.getChildrenOrSelfIntersectingRegion(this.region)):l.push(c));}return l})(e),!this.cacheState.props.isOfCorrectType(o)){for(let a of e)a.render(o,i.visibleRect);return}if(this.cacheState.debugMode&&o.drawRect(this.region,i.getSizeOfPixelOnCanvas(),{fill:P.yellow}),this.renderingWouldBeHighEnoughResolution(i)){let a=u=>u.w/this.region.w<1/this.cacheState.props.blockResolution.x,l=[];for(let u of e)l.push(...u.getLeavesIntersectingRegion(this.region,a));Qe(l);let c=this.computeSortedByLeafIds(l);if(c.length===0)return;let d=c.map(u=>u.getId()),p;if(this.renderingIsUpToDate(d))p=this.cachedRenderer.startRender();else {if(this.allChildrenCanRender(i,c)){for(let h of this.getChildren())h.renderItems(o,e,i);return}let u=0;for(let h of c)a(h.getBBox())||(u+=h.getContent().getProportionalRenderingTime());if(u>this.cacheState.props.minProportionalRenderTimePerCache){let h=true;if(!this.cachedRenderer)this.cachedRenderer=this.cacheState.recordManager.allocCanvas(this.region,()=>this.onRegionDealloc());else if(c.length>this.renderedIds.length&&this.allRenderedIdsIn(d)&&this.renderedMaxZIndex!==null){let f=null;for(let[g,y]of c.entries()){let b=y.getContent().getZIndex();(g>=this.renderedIds.length||y.getId()!==this.renderedIds[g])&&((f===null||b<f)&&(f=b));}if(f!==null&&f>this.renderedMaxZIndex){h=false,p=this.cachedRenderer.startRender();for(let g of l){let y=g.getContent().getZIndex();y>this.renderedMaxZIndex&&(g.render(p,this.region),this.renderedMaxZIndex=y);}this.cacheState.debugMode&&o.drawRect(this.region,2*i.getSizeOfPixelOnCanvas(),{fill:P.clay});}}else this.cacheState.debugMode&&console.log("Decided on a full re-render. Reason: At least one of the following is false:",`
 leafIds.length > this.renderedIds.length: `,d.length>this.renderedIds.length,`
 this.allRenderedIdsIn(leafIds): `,this.allRenderedIdsIn(d),`
 this.renderedMaxZIndex !== null: `,this.renderedMaxZIndex!==null,`

this.rerenderedIds: `,this.renderedIds,", leafIds: ",d);if(h){p=this.cachedRenderer.startRender(),p.clear(),this.renderedMaxZIndex=null;let m=or(l,this.region);for(let f=m;f<l.length;f++){let g=l[f],y=g.getContent();this.renderedMaxZIndex??=y.getZIndex(),this.renderedMaxZIndex=Math.max(this.renderedMaxZIndex,y.getZIndex()),g.render(p,this.region);}this.cacheState.debugMode&&o.drawRect(this.region,3*i.getSizeOfPixelOnCanvas(),{fill:P.red});}this.renderedIds=d;}else {this.cachedRenderer?.dealloc();let h=i.getSizeOfPixelOnCanvas(),m=new I(this.region.x,this.region.y,this.region.w+h,this.region.h+h);o.startObject(m,true);for(let g of l)g.render(o,this.region.intersection(i.visibleRect));o.endObject(),this.cacheState.debugMode&&o.drawRect(this.region,2*i.getSizeOfPixelOnCanvas(),{fill:P.green});}}if(p){let u=this.cachedRenderer.getTransform(this.region).inverse();o.renderFromOtherOfSameType(u,p);}this.instantiatedChildren.every(u=>u.isEmpty())&&(this.instantiatedChildren=[]);}else for(let a of this.getChildren())a.renderItems(o,e.filter(l=>l.getBBox().intersects(a.region)),i);this.checkRep();}isEmpty(){return this.cachedRenderer!==null?false:this.instantiatedChildren.every(o=>o.isEmpty())}onRegionDealloc(){this.cachedRenderer=null,this.isEmpty()&&(this.instantiatedChildren=[]);}checkRep(){if(this.instantiatedChildren.length!==Ve*Ve&&this.instantiatedChildren.length>0)throw new Error(`Repcheck: Wrong number of children. Got ${this.instantiatedChildren.length}`);if(this.renderedIds[1]!==void 0&&this.renderedIds[0]>=this.renderedIds[1])throw console.error(this.renderedIds),new Error("Repcheck: First two ids are not in ascending order!");for(let o of this.instantiatedChildren)if(o.parent!==this)throw new Error("Children should be linked to their parents!");if(this.cachedRenderer&&!this.cachedRenderer.isAllocd())throw new Error("this' cachedRenderer != null, but is dealloc'd")}};var zo=class{sharedState;recordManager;rootNode;constructor(o){this.recordManager=new Fi(o),this.sharedState={props:o,currentRenderingCycle:0,recordManager:this.recordManager,debugMode:false},this.recordManager.setSharedState(this.sharedState);}render(o,e,i){let r=i.visibleRect;if(this.sharedState.currentRenderingCycle++,!this.sharedState.props.isOfCorrectType(o)){e.render(o,r);return}if(!this.rootNode){let l=this.sharedState.props.blockResolution,c=r.topLeft;this.rootNode=new Lo(new I(c.x,c.y,l.x,l.y),this.sharedState);}for(;!this.rootNode.region.containsRect(r);)this.rootNode=this.rootNode.generateParent();this.rootNode=this.rootNode.smallestChildContaining(r)??this.rootNode;let n=e.getLeavesIntersectingRegion(i.visibleRect,l=>o.isTooSmallToRender(l)),a=0;for(let l of n)a+=l.getContent().getProportionalRenderingTime();a>this.sharedState.props.minProportionalRenderTimeToUseCache?this.rootNode.renderItems(o,[e],i):e.render(o,r);}getDebugInfo(){return this.recordManager.getDebugInfo()}setIsDebugMode(o){this.sharedState.debugMode=o;}};var Bo=class extends ve{constructor(e,i){super(e);this.localizationTable=i;}descriptionBuilder=[];pathCount=0;textNodeCount=0;imageNodeCount=0;displaySize(){return exports.Vec2.of(500,500)}clear(){this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0,this.imageNodeCount=0;}getDescription(){return [this.localizationTable.pathNodeCount(this.pathCount),...this.textNodeCount>0?[this.localizationTable.textNodeCount(this.textNodeCount)]:[],...this.imageNodeCount>0?[this.localizationTable.imageNodeCount(this.imageNodeCount)]:[],...this.descriptionBuilder].join(`
`)}beginPath(e){}endPath(e){this.pathCount++;}lineTo(e){}moveTo(e){}traceCubicBezierCurve(e,i,r){}traceQuadraticBezierCurve(e,i){}drawText(e,i,r){this.descriptionBuilder.push(this.localizationTable.textNode(e)),this.textNodeCount++;}drawImage(e){let i=e.label?this.localizationTable.imageNode(e.label):this.localizationTable.unlabeledImageNode;this.descriptionBuilder.push(i),this.imageNodeCount++;}isTooSmallToRender(e){return e.maxDimension<15/this.getSizeOfCanvasPixelOnScreen()}drawPoints(...e){}};var nn=(e=>(e[e.DummyRenderer=0]="DummyRenderer",e[e.CanvasRenderer=1]="CanvasRenderer",e))(nn||{}),Wt=class{constructor(o,e,i){this.editor=o;this.parent=i;if(e===1)this.initializeCanvasRendering();else if(e===0)this.dryInkRenderer=new qe(o.viewport),this.wetInkRenderer=new qe(o.viewport);else throw new Error(`Unknown rendering mode, ${e}!`);this.textRenderer=new Bo(o.viewport,o.localization),this.initializeTextRendering();let r=exports.Vec2.of(600,600);this.cache=new zo({createRenderer:()=>{if(e===0)return new qe(o.viewport);if(e!==1)throw new Error("Unspported rendering mode");let n=document.createElement("canvas");n.width=r.x+1,n.height=r.y+1;let a=n.getContext("2d");return new xe(a,o.viewport)},isOfCorrectType:n=>this.dryInkRenderer.canRenderFromWithoutDataLoss(n),blockResolution:r,cacheSize:600*600*4*90,maxScale:Math.max(1,1.3/window.devicePixelRatio),minProportionalRenderTimePerCache:20*4,minProportionalRenderTimeToUseCache:105*4}),this.editor.notifier.on(8,n=>{if(n.kind!==8)throw new Error("Mismatched event.kinds!");this.resizeSurfacesCallback?.();});}dryInkRenderer;wetInkRenderer;textRenderer;textRerenderOutput=null;cache;devicePixelRatio=window.devicePixelRatio??1;resizeSurfacesCallback;flattenCallback;get width(){return this.dryInkRenderer.displaySize().x}get height(){return this.dryInkRenderer.displaySize().y}getCache(){return this.cache}getColorAt=o=>null;initializeCanvasRendering(){let o=document.createElement("canvas"),e=document.createElement("canvas"),i=o.getContext("2d"),r=e.getContext("2d");this.dryInkRenderer=new xe(i,this.editor.viewport),this.wetInkRenderer=new xe(r,this.editor.viewport),o.className="dryInkCanvas",e.className="wetInkCanvas",this.parent&&(this.parent.appendChild(o),this.parent.appendChild(e)),this.resizeSurfacesCallback=()=>{let n=c=>Math.ceil(c.clientWidth*this.devicePixelRatio)||c.width,a=c=>Math.ceil(c.clientHeight*this.devicePixelRatio)||c.height,l=c=>a(c)!==c.height||n(c)!==c.width;(l(o)||l(e))&&(o.width=n(o),o.height=a(o),e.width=n(e),e.height=a(e),r.resetTransform(),i.resetTransform(),i.scale(this.devicePixelRatio,this.devicePixelRatio),r.scale(this.devicePixelRatio,this.devicePixelRatio),this.editor.notifier.dispatch(8,{kind:8,newSize:exports.Vec2.of(this.width,this.height)}));},this.resizeSurfacesCallback(),this.flattenCallback=()=>{i.save(),i.resetTransform(),i.drawImage(e,0,0),i.restore();},this.getColorAt=n=>{let a=n.times(this.devicePixelRatio),c=i.getImageData(a.x,a.y,1,1)?.data;return c?P.ofRGBA(c[0]/255,c[1]/255,c[2]/255,c[3]/255):null};}initializeTextRendering(){let o=document.createElement("div");o.classList.add("textRendererOutputContainer");let e=document.createElement("button");e.classList.add("rerenderButton"),e.innerText=this.editor.localization.rerenderAsText,this.textRerenderOutput=document.createElement("div"),this.textRerenderOutput.setAttribute("aria-live","polite"),e.addEventListener("click",()=>{this.rerenderAsText();}),o.replaceChildren(e,this.textRerenderOutput),this.editor.createHTMLOverlay(o);}setDevicePixelRatio(o){if(isFinite(o)&&o>=.001&&o<=10&&o!==this.devicePixelRatio)return this.devicePixelRatio=o,this.resizeSurfacesCallback?.(),this.editor.queueRerender()}getDevicePixelRatio(){return this.devicePixelRatio}rerenderAsText(){this.textRenderer.clear(),this.editor.image.render(this.textRenderer,this.editor.viewport),this.textRerenderOutput&&(this.textRerenderOutput.innerText=this.textRenderer.getDescription());}startRerender(){return this.resizeSurfacesCallback?.(),this.dryInkRenderer.clear(),this.dryInkRenderer}setDraftMode(o){this.dryInkRenderer.setDraftMode(o);}getDryInkRenderer(){return this.dryInkRenderer}getWetInkRenderer(){return this.wetInkRenderer}flatten(){this.flattenCallback?.();}};function Ja(s){let o=0,e=s.map(i=>i.id);e.sort();for(let i of e)o===i&&(o=i+1);return o}var Oi=Ja;function el(s,o,e,i,r=0){let n=Oi(i??[]),a=be.ofCanvasPoint(e,o!==2,s.viewport,n,r);return s.toolController.dispatchInputEvent({kind:o,allPointers:i??[a],current:a}),a}var sn=el;function tl(s,o,e,i){let r=s.viewport.screenToCanvas(e),n=Oi(i??[]),a=be.ofCanvasPoint(r,o!==2,s.viewport,n,2);return s.toolController.dispatchInputEvent({kind:o,allPointers:[...i??[],a],current:a}),a}var ol=tl;var an=class{constructor(o,e,i){this.editor=o;this.announceRedoCallback=e;this.announceUndoCallback=i;this.#e=[],this.#t=[];}#e;#t;maxUndoRedoStackSize=700;fireUpdateEvent(o,e){this.editor.notifier.dispatch(3,{kind:3,undoStackSize:this.#e.length,redoStackSize:this.#t.length,command:e,stackUpdateType:o});}push(o,e=true){e&&o.apply(this.editor),this.#e.push(o);for(let i of this.#t)i.onDrop(this.editor);if(this.#t=[],this.#e.length>this.maxUndoRedoStackSize){let i=Math.ceil(this.maxUndoRedoStackSize/100);this.#e.splice(0,i).forEach(n=>n.onDrop(this.editor));}this.fireUpdateEvent(0,o),this.editor.notifier.dispatch(4,{kind:4,command:o});}undo(){let o=this.#e.pop();if(o){this.#t.push(o);let e=o.unapply(this.editor);return this.announceUndoCallback(o),this.fireUpdateEvent(1,o),this.editor.notifier.dispatch(5,{kind:5,command:o}),e}}redo(){let o=this.#t.pop();if(o){this.#e.push(o);let e=o.apply(this.editor);return this.announceRedoCallback(o),this.fireUpdateEvent(2,o),this.editor.notifier.dispatch(4,{kind:4,command:o}),e}}get undoStackSize(){return this.#e.length}get redoStackSize(){return this.#t.length}clearAll(){for(;this.undoStackSize>0;)this.undo();this.#e=[],this.#t=[];}},ln=an;function il(s,o){let e=s.getRootElement(),i=[["--background-color-1","--foreground-color-1",true,true],["--background-color-2","--foreground-color-2",true,true],["--background-color-3","--foreground-color-3",true,true],["--background-color-2","--primary-action-foreground-color",false,true],["--selection-background-color","--selection-foreground-color",false,true]];if(!o?.dontClearOverrides)for(let[l,c]of i)e.style.setProperty(l,null),e.style.setProperty(c,null);let r=getComputedStyle(e),n=Object.create(null),a=(l,c,d,p,u)=>{let h=n[l]?n[l]:P.fromString(r.getPropertyValue(l)),m=n[c]?n[c]:P.fromString(r.getPropertyValue(c));if(h.relativeLuminance()<m.relativeLuminance()){let v=h;h=m,m=v;let b=c;c=l,l=b;let S=p;p=u,u=S;}let f=false,g=P.contrastRatio(h,m),y=0;for(;g<d&&y<8;){let v=exports.Vec3.of(.1,.1,.1);p&&(m.eq(P.white)&&!u&&(m=P.black),h=P.fromRGBVector(h.rgb.plus(v))),u&&(m.eq(P.black)&&!p&&(m=P.white),m=P.fromRGBVector(m.rgb.minus(v))),g=P.contrastRatio(h,m),f=true,y++;}f&&(e.style.setProperty(l,h.toHexString()),e.style.setProperty(c,m.toHexString()),n[l]=h,n[c]=m);};a("--selection-background-color","--background-color-2",1.29,true,false);for(let[l,c,d,p]of i)a(l,c,4.5,d,p);}var rl=il;var Ao={number:"1.28.0"};function nl(s,o){let e=Ri(s,{title:s.localization.about,contentClassNames:["about-dialog-content"]});for(let i of o){let r=document.createElement(i.minimized?"details":"div");r.classList.add("about-entry");let n=document.createElement(i.minimized?"summary":"h2");if(typeof i.heading=="string")n.innerText=i.heading;else {let a=document.createElement("a");a.href=i.heading.href.replace(/^javascript:/i,""),a.text=i.heading.text,n.appendChild(a);}if(r.appendChild(n),i.text){let a=document.createElement("div");a.innerText=i.text,r.appendChild(a);}e.appendChild(r);}return {close:()=>e.close()}}var Es=nl;function sl(s,o,e){let i=o.w,r=o.h;if(e?.minDimension&&i<e.minDimension){let n=e.minDimension;r*=n/(i||1),i=n;}if(e?.minDimension&&r<e.minDimension){let n=e.minDimension;i*=n/(r||1),r=n;}s.setAttribute("width",ie(i)),s.setAttribute("height",ie(r));}var Is=sl;function ks(s,o,e){let i=s.getImportExportViewport().getTemporaryClone();if(e?.minDimension){let a=i.visibleRect,l=a;l.w<=0&&(l=new I(l.x,l.y,e.minDimension,l.h)),l.h<=0&&(l=new I(l.x,l.y,l.w,e.minDimension)),l.eq(a)||i.updateScreenSize(l.size);}let{element:r,renderer:n}=ae.fromViewport(i,{sanitize:e.sanitize??false,useViewBoxForPositioning:true});return o(n,()=>{s.getAutoresizeEnabled()?r.classList.add(Li):r.classList.remove(Li);let a=i.visibleRect;return Is(r,a,e),r}),r}function Rs(s,o){return ks(s,(e,i)=>{s.renderAll(e),i();},o)}function Ls(s,o,e){return new Promise(i=>{ks(s,async(r,n)=>{await s.renderAllAsync(r,o);let a=n();i(a);},e);})}var Do=class extends ge{canShowContextMenu=false;contextMenuTriggerPointer;contextMenuStartPoint;stationaryDetector=null;clickTolerance=12;constructor(){super();}canMakeLongPressMenuEvent(o){let e=[2];return o.allPointers.length===1&&e.includes(o.current.device)}onEvent(o){let e=()=>ro(o)&&this.canShowContextMenu&&this.emit({kind:9,screenPos:o.current.screenPos,canvasPos:o.current.canvasPos})?(this.emit({kind:3}),true):false;if(o.kind===0)o.allPointers.length===1?(this.canShowContextMenu=true,this.contextMenuTriggerPointer=o.current,this.contextMenuStartPoint=o.current.screenPos,this.canMakeLongPressMenuEvent(o)&&(this.stationaryDetector=new De(o.current,Ct,e))):this.canShowContextMenu=false;else if(o.kind===1){if(this.canShowContextMenu){this.stationaryDetector?.onPointerMove(o.current);let i=o.current.screenPos.minus(this.contextMenuStartPoint),r=this.clickTolerance;i.length()>r&&(this.canShowContextMenu=false);}}else if(o.kind===2&&(this.stationaryDetector?.destroy(),this.contextMenuTriggerPointer?.id===o.current.id&&this.contextMenuTriggerPointer.device===4&&e()))return  true;return this.emit(o)}};var Mo=class s extends ge{constructor(e,i){super();this.shortcuts=e;this.viewport=i;}snapToGridEnabled=false;angleLockEnabled=false;startPointCanvas=null;xyAxesSnap(e){if(!this.startPointCanvas)return e;let i=this.viewport.canvasToScreen(this.startPointCanvas);return e.lockedToXYAxesScreen(i,this.viewport)}mapPointerEvent(e){let i=r=>e.allPointers.length>1?r:this.snapToGridEnabled?r.snappedToGrid(this.viewport):this.angleLockEnabled&&this.startPointCanvas?this.xyAxesSnap(r):r;return {kind:e.kind,current:i(e.current),allPointers:e.allPointers.map(i)}}onEvent(e){let i=this.shortcuts;(e.kind===0||e.kind===1||e.kind===2)&&(e.kind===0&&(this.startPointCanvas=e.current.canvasPos),e=this.mapPointerEvent(e));let r=this.emit(e);if(e.kind===6||!r&&e.kind===5){let n=e.kind===5;i.matchesShortcut(St,e)&&(this.snapToGridEnabled=n,r=true),i.matchesShortcut(zr,e)&&(this.angleLockEnabled=n,r=true);}return r}static fromEditor(e){return new s(e.shortcuts,e.viewport)}};var zs={Control:"ControlLeft","=":"Equal","-":"Minus",";":"Semicolon"," ":"Space"};function al(s){let o=s.toUpperCase();return "A"<=o&&o<="Z"?`Key${o}`:"0"<=s&&s<="9"?`Digit${s}`:s in zs?zs[s]:s}var Bs=al;function ll(s,o){let e=[],i=(c,d)=>c.key===d.key&&c.code===d.code,r=c=>e.some(d=>i(d,c)),n=c=>({code:c.code,key:c.key,ctrlKey:c.ctrlKey,altKey:c.altKey,shiftKey:c.shiftKey,metaKey:c.metaKey}),a=c=>{if(c.type==="keydown"){if(r(c)||e.push(n(c)),!o.filter(c))return;o.handleKeyDown(c);}else {if(console.assert(c.type==="keyup"),e=e.filter(d=>!i(d,c)),!o.filter(c))return;o.handleKeyUp(c);}};s.addEventListener("keydown",c=>{a(c);}),s.addEventListener("keyup",c=>{a(c);}),s.addEventListener("focusout",c=>{let d=false;if(c.relatedTarget){let p=c.relatedTarget;d=s.contains(p)||o.getHandlesKeyEventsFrom(p);}if(!d){for(let p of e)o.handleKeyUp(new KeyboardEvent("keyup",{...p}));e=[];}});let l=c=>{let d=false,p=false,u=false,h=false;for(let g of e){let y=g.code;d||=!!/^Shift(Left|Right)$/.test(y),p||=!!/^Control(Left|Right)$/.test(y),u||=!!/^Alt(Left|Right)$/.test(y),h||=!!/^Meta(Left|Right)$/.test(y);}let m=g=>g?"keydown":"keyup",f={shiftKey:c.shiftKey,altKey:c.altKey,metaKey:c.metaKey,ctrlKey:c.ctrlKey};c.shiftKey!==d&&a(new KeyboardEvent(m(c.shiftKey),{...f,key:"Shift",code:"ShiftLeft"})),c.altKey!==u&&a(new KeyboardEvent(m(c.altKey),{...f,key:"Alt",code:"AltLeft"})),c.ctrlKey!==p&&a(new KeyboardEvent(m(c.ctrlKey),{...f,key:"Control",code:"ControlLeft"})),c.metaKey!==h&&a(new KeyboardEvent(m(c.metaKey),{...f,key:"Meta",code:"MetaLeft"}));};s.addEventListener("mousedown",c=>{l(c);}),s.addEventListener("mousemove",c=>{l(c);});}var As=ll;function cl(s){return (e=>e.replace(/([^\n])\n([^\n])/g,"$1 $2"))(`
MIT License

Copyright (c) ${s}

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.`)}var Hi=cl;var dn=class{container;renderingRegion;display;history;image;viewport;localization;icons;shortcuts;toolController;notifier;loadingWarning;accessibilityAnnounceArea;accessibilityControlArea;eventListenerTargets=[];readOnly;settings;constructor(o,e={}){if(this.localization={...pr(),...e.localization},this.settings={wheelEventsEnabled:e.wheelEventsEnabled??true,renderingMode:e.renderingMode??1,localization:this.localization,minZoom:e.minZoom??2e-10,maxZoom:e.maxZoom??1e12,keyboardShortcutOverrides:e.keyboardShortcutOverrides??{},iconProvider:e.iconProvider??new Nt,notices:e.notices??[],appInfo:e.appInfo?{...e.appInfo}:null,pens:{additionalPenTypes:e.pens?.additionalPenTypes??[],filterPenTypes:e.pens?.filterPenTypes??(()=>true)},text:{fonts:e.text?.fonts??["sans-serif","serif","monospace"]},image:{showImagePicker:e.image?.showImagePicker??void 0},svg:{loaderPlugins:e.svg?.loaderPlugins??[]},clipboardApi:e.clipboardApi??null,disableZoom:e.disableZoom??false},this.settings.minZoom>this.settings.maxZoom)throw new Error("Minimum zoom must be lesser than maximum zoom!");this.readOnly=Z.fromInitialValue(false),this.icons=this.settings.iconProvider,this.shortcuts=new V(this.settings.keyboardShortcutOverrides),this.container=document.createElement("div"),this.renderingRegion=document.createElement("div"),this.container.appendChild(this.renderingRegion),this.container.classList.add("imageEditorContainer","easydrawer"),this.loadingWarning=document.createElement("div"),this.loadingWarning.classList.add("loadingMessage"),this.loadingWarning.ariaLive="polite",this.container.appendChild(this.loadingWarning),this.accessibilityControlArea=document.createElement("textarea"),this.accessibilityControlArea.setAttribute("placeholder",this.localization.accessibilityInputInstructions),this.accessibilityControlArea.style.opacity="0",this.accessibilityControlArea.style.width="0",this.accessibilityControlArea.style.height="0",this.accessibilityControlArea.style.position="absolute",this.accessibilityAnnounceArea=document.createElement("div"),this.accessibilityAnnounceArea.setAttribute("aria-live","assertive"),this.accessibilityAnnounceArea.className="accessibilityAnnouncement",this.container.appendChild(this.accessibilityAnnounceArea),this.renderingRegion.style.touchAction="none",this.renderingRegion.className="imageEditorRenderArea",this.renderingRegion.appendChild(this.accessibilityControlArea),this.renderingRegion.setAttribute("tabIndex","0"),this.renderingRegion.setAttribute("alt",""),this.notifier=new Pe,this.viewport=new A((i,r)=>{this.notifier.dispatch(7,{kind:7,newTransform:r,oldTransform:i});}),this.display=new Wt(this,this.settings.renderingMode,this.renderingRegion),this.history=new ln(this,this.announceRedoCallback,this.announceUndoCallback),this.toolController=new Ht(this,this.localization),this.toolController.addInputMapper(Mo.fromEditor(this)),this.toolController.addInputMapper(new Do),o.appendChild(this.container),this.image=new K(this.display.width,this.display.height),this.viewport.updateScreenSize(exports.Vec2.of(this.display.width,this.display.height)),this.registerListeners(),this.queueRerender(),this.hideLoadingWarning(),this.notifier.on(7,i=>{if(i.kind!==7)return;let r=a=>a.transformVec3(exports.Vec2.unitX).length(),n=r(i.newTransform);if(n>this.settings.maxZoom||n<this.settings.minZoom){let a=r(i.oldTransform),l=w.identity;a<=this.settings.maxZoom&&a>=this.settings.minZoom?l=i.oldTransform:l=w.scaling2D((this.settings.minZoom+this.settings.maxZoom)/2),this.viewport.resetTransform(l);}else isFinite(n)||(console.warn(`Non-finite zoom (${n}) detected. Resetting the viewport. This was likely caused by division by zero.`),isFinite(r(i.oldTransform))?this.viewport.resetTransform(i.oldTransform):this.viewport.resetTransform());});}getCurrentSettings(){return {...this.settings}}getRootElement(){return this.container}getOutputBBoxInDOM(){return I.of(this.renderingRegion.getBoundingClientRect())}showLoadingWarning(o){let e=Math.round(o*100);this.loadingWarning.innerText=this.localization.loading(e),this.loadingWarning.style.display="block";}hideLoadingWarning(){this.loadingWarning.style.display="none",this.announceForAccessibility(this.localization.doneLoading);}previousAccessibilityAnnouncement="";announceForAccessibility(o){o===this.previousAccessibilityAnnouncement&&(o=o+". "),this.accessibilityAnnounceArea.innerText=o,this.previousAccessibilityAnnouncement=o;}addToolbar(o=true){let e=new Ut(this,this.container,this.localization);return o&&e.addDefaults(),e}registerListeners(){this.handlePointerEventsFrom(this.renderingRegion),this.handleKeyEventsFrom(this.renderingRegion),this.handlePointerEventsFrom(this.accessibilityAnnounceArea);let o=[this.renderingRegion,this.accessibilityAnnounceArea,this.accessibilityControlArea,this.loadingWarning];for(let r of o)r.addEventListener("drag",n=>(n.preventDefault(),false)),r.addEventListener("dragstart",n=>(n.preventDefault(),false));this.container.addEventListener("wheel",r=>{this.handleHTMLWheelEvent(r);});let e=()=>{this.viewport.updateScreenSize(exports.Vec2.of(this.display.width,this.display.height)),this.image.updateScreenSizeImage(this.display.width,this.display.height),this.rerender(),this.updateEditorSizeVariables();};if("ResizeObserver"in window){let r=new ResizeObserver(e);r.observe(this.renderingRegion),r.observe(this.container);}else addEventListener("resize",e);this.accessibilityControlArea.addEventListener("input",()=>{this.accessibilityControlArea.value="";});let i=new ye(this);document.addEventListener("copy",async r=>{this.isEventSink(document.querySelector(":focus"))&&i.copy(r);}),document.addEventListener("paste",r=>{this.handlePaste(r);});}updateEditorSizeVariables(){this.container.style.setProperty("--editor-current-width-px",`${this.container.clientWidth}px`),this.container.style.setProperty("--editor-current-height-px",`${this.container.clientHeight}px`),this.container.style.setProperty("--editor-current-display-width-px",`${this.renderingRegion.clientWidth}px`),this.container.style.setProperty("--editor-current-display-height-px",`${this.renderingRegion.clientHeight}px`);}handleHTMLWheelEvent(o){let e=exports.Vec3.of(o.deltaX,o.deltaY,o.deltaZ);if(!o.ctrlKey&&!o.metaKey)if(this.settings.wheelEventsEnabled){if(this.settings.wheelEventsEnabled==="only-if-focused"&&!this.container.querySelector(":focus"))return}else return;o.deltaMode===WheelEvent.DOM_DELTA_LINE?e=e.times(15):o.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(e=e.times(100)),(o.ctrlKey||o.metaKey)&&(e=exports.Vec3.of(0,0,o.deltaY));let i=this.getOutputBBoxInDOM(),r=exports.Vec2.of(o.clientX,o.clientY).minus(i.topLeft);return this.toolController.dispatchInputEvent({kind:4,delta:e,screenPos:r})?(o.preventDefault(),true):false}pointers={};getPointerList(){let o=performance.now(),e=[];for(let i in this.pointers)this.pointers[i]&&o-this.pointers[i].timeStamp<2e3&&e.push(this.pointers[i]);return e}setPointerCapture(o,e){try{o.setPointerCapture(e);}catch(i){console.warn("Failed to setPointerCapture",i);}}releasePointerCapture(o,e){try{o.releasePointerCapture(e);}catch(i){console.warn("Failed to releasePointerCapture",i);}}handleHTMLPointerEvent(o,e){let i=this.renderingRegion,r=e.target??this.renderingRegion;if(o==="pointerdown"){let n=be.ofEvent(e,true,this.viewport,i);this.pointers[n.id]=n,this.setPointerCapture(r,n.id);let a={kind:0,current:n,allPointers:this.getPointerList()};return this.toolController.dispatchInputEvent(a),true}else if(o==="pointermove"){let n=be.ofEvent(e,this.pointers[e.pointerId]?.down??false,this.viewport,i);if(n.down){let a=this.pointers[n.id];if(a&&n.screenPos.distanceTo(a.screenPos)<2)return  false;this.pointers[n.id]=n,this.toolController.dispatchInputEvent({kind:1,current:n,allPointers:this.getPointerList()})&&e.preventDefault();}return  true}else if(o==="pointercancel"||o==="pointerup"){let n=be.ofEvent(e,false,this.viewport,i);return this.pointers[n.id]?(this.pointers[n.id]=n,this.releasePointerCapture(r,n.id),this.toolController.dispatchInputEvent({kind:2,current:n,allPointers:this.getPointerList()})&&e.preventDefault(),delete this.pointers[n.id],true):false}return o}isEventSink(o){let e=o;for(;e!==null;){for(let i of this.eventListenerTargets)if(i===e)return  true;e=e.parentElement;}return  false}async handleDrop(o){o.preventDefault(),await this.handlePaste(o);}async handlePaste(o){let e=document.querySelector(":focus")??o.target;if(this.isEventSink(e))return await new ye(this).paste(o)}handlePointerEventsFrom(o,e,i){let a={touchstart:c=>{i&&!i("touchstart",c)||c.preventDefault();},contextmenu:c=>{i&&!i("contextmenu",c)||c.preventDefault();}},l=["pointerdown","pointermove","pointerup","pointercancel"];for(let c of l)a[c]=d=>{let p=d;if(!(e&&!e(c,p)))return this.handleHTMLPointerEvent(c,p)};for(let c in a)o.addEventListener(c,a[c]);return {remove:()=>{for(let c in a)o.removeEventListener(c,a[c]);}}}handlePointerEventsExceptClicksFrom(o,e,i){let r=Object.create(null);return this.handlePointerEventsFrom(o,(n,a)=>{if(e&&!e(n,a))return  false;let l=exports.Vec2.of(a.pageX??a.clientX,a.pageY??a.clientY),c=a.pointerId??0,d=true;if(n==="pointerdown")r[c]={eventBuffer:[[n,a]],startPoint:l,hasMovedSignificantly:false},this.setPointerCapture(o,a.pointerId),d=false;else if(n==="pointermove"&&r[c]){let p=r[c].startPoint,u=r[c].eventBuffer;if(p&&l.distanceTo(p)<10&&!r[c].hasMovedSignificantly)u.push([n,a]),d=false;else {for(let[f,g]of u)this.handleHTMLPointerEvent(f,g);r[c].eventBuffer=[],r[c].hasMovedSignificantly=true,d=true;}}else n==="pointermove"?d=true:(n==="pointerup"||n==="pointercancel")&&r[c]&&r[c].eventBuffer.length>0&&(this.releasePointerCapture(o,a.pointerId),d=false,delete r[c]);return d},i)}handleHTMLKeyDownEvent(o){console.assert(o.type==="keydown",`handling a keydown event with type ${o.type}`);let e=ai(o);return this.toolController.dispatchInputEvent(e)?(o.preventDefault(),true):e.key==="t"||e.key==="T"?(o.preventDefault(),this.display.rerenderAsText(),true):e.key==="Escape"?(this.renderingRegion.blur(),true):false}handleHTMLKeyUpEvent(o){console.assert(o.type==="keyup",`Handling a keyup event with type ${o.type}`);let e=si(o);return this.toolController.dispatchInputEvent(e)?(o.preventDefault(),true):false}handleKeyEventsFrom(o,e=()=>true){As(o,{filter:e,handleKeyDown:i=>{this.handleHTMLKeyDownEvent(i);},handleKeyUp:i=>{this.handleHTMLKeyUpEvent(i);},getHandlesKeyEventsFrom:i=>this.eventListenerTargets.includes(i)}),o.addEventListener("dragover",i=>{i.preventDefault();}),o.addEventListener("drop",i=>{this.handleDrop(i);}),this.eventListenerTargets.push(o);}setReadOnly(o){o!==this.readOnly.get()&&(this.readOnly.set(o),this.notifier.dispatch(10,{kind:10,editorIsReadOnly:o}));}isReadOnlyReactiveValue(){return this.readOnly}isReadOnly(){return this.readOnly}dispatch(o,e=true){let i=this.dispatchNoAnnounce(o,e),r=o.description(this,this.localization);return this.announceForAccessibility(r),i}dispatchNoAnnounce(o,e=false){let i=o.apply(this);return e&&this.history.push(o,false),i}async asyncApplyOrUnapplyCommands(o,e,i){console.assert(i>0),this.display.setDraftMode(true);for(let r=0;r<o.length;r+=i){this.showLoadingWarning(r/o.length);for(let n=r;n<o.length&&n<r+i;n++){let a=o[n];e?a.apply(this):a.unapply(this);}r+i<o.length&&await new Promise(n=>{this.rerender(),requestAnimationFrame(n);});}this.display.setDraftMode(false),this.hideLoadingWarning();}asyncApplyCommands(o,e){return this.asyncApplyOrUnapplyCommands(o,true,e)}asyncUnapplyCommands(o,e,i=false){return i&&(o=[...o],o.reverse()),this.asyncApplyOrUnapplyCommands(o,false,e)}announceUndoCallback=o=>{this.announceForAccessibility(this.localization.undoAnnouncement(o.description(this,this.localization)));};announceRedoCallback=o=>{this.announceForAccessibility(this.localization.redoAnnouncement(o.description(this,this.localization)));};nextRerenderListeners=[];rerenderQueued=false;queueRerender(){return this.rerenderQueued||(this.rerenderQueued=true,requestAnimationFrame(()=>{this.rerenderQueued&&(this.rerender(),this.rerenderQueued=false);})),new Promise(o=>{this.nextRerenderListeners.push(()=>o());})}isRerenderQueued(){return this.rerenderQueued}rerender(o=true){if(this.display.startRerender(),this.display.width===0||this.display.height===0)return;let e=this.display.getDryInkRenderer();this.image.renderWithCache(e,this.display.getCache(),this.viewport),this.rerenderQueued=false,this.nextRerenderListeners.forEach(i=>i()),this.nextRerenderListeners=[];}drawWetInk(...o){for(let e of o)this.display.getWetInkRenderer().drawPath(e);}clearWetInk(){this.display.getWetInkRenderer().clear();}focus(){this.renderingRegion.focus();}createHTMLOverlay(o){return o.classList.add("overlay","easydrawer-editor-overlay"),this.container.appendChild(o),{remove:()=>o.remove()}}anchorElementToCanvas(o,e){e instanceof w&&(e=ri.fromImmutable(e));let i=document.createElement("div");i.classList.add("anchored-element-overlay");let r=document.createElement("div");r.classList.add("content-wrapper"),o.classList.add("content");let n=()=>{let p=e.get().transformVec3(exports.Vec2.unitX).angle()+this.viewport.getRotationAngle(),u=this.viewport.canvasToScreenTransform.rightMul(e.get());i.style.setProperty("--full-transform",u.toCSSMatrix());let h=u.transformVec2(exports.Vec2.zero);i.style.setProperty("--position-x",`${h.x}px`),i.style.setProperty("--position-y",`${h.y}px`),i.style.setProperty("--rotation",`${p*180/Math.PI}deg`),i.style.setProperty("--scale",`${u.getScaleFactor()}`);};n();let a=e.onUpdate(n),l=this.notifier.on(7,n);return r.appendChild(o),i.appendChild(r),i.classList.add("overlay","easydrawer-editor-overlay"),this.renderingRegion.insertAdjacentElement("afterend",i),{remove:()=>{i.remove(),a.remove(),l.remove();}}}addStyleSheet(o){let e=document.createElement("style");return e.innerText=o,this.container.appendChild(e),e}sendKeyboardEvent(o,e,i=false,r=false,n=void 0){n??=e.toUpperCase()===e&&e.toLowerCase()!==e,this.toolController.dispatchInputEvent({kind:o,key:e,code:Bs(e),ctrlKey:i,altKey:r,shiftKey:n});}sendPenEvent(o,e,i){sn(this,o,e,i);}async addAndCenterComponents(o,e=true,i){let r=null;for(let h of o)r?r=r.union(h.getBBox()):r=h.getBBox();if(!r)return;let n=this.viewport.visibleRect,a=n.width/r.width,l=n.height/r.height,c=a;(r.width*c>n.width||r.height*c>n.height)&&(c=l),c*=2/3,c=A.roundScaleRatio(c);let d=w.translation(n.center.minus(r.center)).rightMul(w.scaling2D(c,r.center)),p=[];for(let h of o)p.push(K.addComponent(h)),p.push(h.transformBy(d));if(await this.dispatch(J(p,{applyChunkSize:100,description:i}),true),e)for(let h of this.toolController.getMatchingTools(ce))h.setEnabled(true),h.setSelection(o);}toDataURL(o="image/png",e){let{element:i,renderer:r}=xe.fromViewport(this.image.getImportExportViewport(),{canvasSize:e});return this.image.renderAll(r),i.toDataURL(o)}toSVG(o){return Rs(this.image,o??{})}async toSVGAsync(o={}){let e=o.pauseAfterCount??100;return await Ls(this.image,async(i,r,n)=>o.onProgress&&await o.onProgress(r,n)===false?false:(r%e===0&&await Ae(),true),{minDimension:o.minDimension})}async loadFrom(o){this.showLoadingWarning(0),this.display.setDraftMode(true);let e=this.image.getBackgroundComponents(),i=new _(e);await o.start(async r=>{await this.dispatchNoAnnounce(K.addComponent(r));},(r,n)=>r%500===0?(this.showLoadingWarning(r/n),this.rerender(),Ae()):null,(r,n)=>{this.dispatchNoAnnounce(this.setImportExportRect(r),false),this.dispatchNoAnnounce(this.viewport.zoomTo(r),false),n&&this.dispatchNoAnnounce(this.image.setAutoresizeEnabled(n.autoresize),false);}),this.image.getBackgroundComponents().length!==e.length&&await this.dispatchNoAnnounce(i),this.hideLoadingWarning(),this.display.setDraftMode(false),this.queueRerender();}getTopmostBackgroundComponent(){let o=null;for(let e of this.image.getBackgroundComponents())e instanceof ee&&(o=e);return o}setBackgroundStyle(o){let e=this.getTopmostBackgroundComponent(),i=[];e&&i.push(new _([e]));let r=e?.getBackgroundType?.()??2,n=e?.getStyle?.().color??P.transparent,a=this.image.getAutoresizeEnabled(),l=o.color&&r===2?0:r,c=o.type??l,d=o.color??n,p=o.autoresize??a;if(c!==2){let u=new ee(c,d);i.push(K.addComponent(u));}return p!==a&&(i.push(this.image.setAutoresizeEnabled(p)),!p&&this.image.getImportExportRect().maxDimension===0&&i.push(this.image.setImportExportRect(this.image.getImportExportRect().resizedTo(exports.Vec2.of(500,500))))),J(i)}setBackgroundColor(o){let e=this.getTopmostBackgroundComponent();if(e)return e.updateStyle({color:o});{let i=o.eq(P.transparent)?2:0;return e=new ee(i,o),this.image.addComponent(e)}}estimateBackgroundColor(){let o=[];for(let e of this.image.getBackgroundComponents())e instanceof ee&&o.push(e.getStyle().color??P.transparent);return P.average(o)}getImportExportRect(){return this.image.getImportExportViewport().visibleRect}setImportExportRect(o){return this.image.setImportExportRect(o)}async loadFromSVG(o,e=false){let i=Ge.fromString(o,{sanitize:e,plugins:this.getCurrentSettings().svg?.loaderPlugins});await this.loadFrom(i);}closeAboutDialog=null;showAboutDialog(){let o=this.icons.licenseInfo(),e=[];if(this.settings.appInfo){let r=[];this.settings.appInfo.version&&r.push(`v${this.settings.appInfo.version}`,""),this.settings.appInfo.description?r.push(this.settings.appInfo.description+`
`):r.push(`easydrawer v${Ao.number}`),e.push({heading:`${this.settings.appInfo.name}`,text:r.join(`
`)});}else e.push({heading:"easydrawer",text:`v${Ao.number}`});let i=this.viewport.getScreenRectSize();e.push({heading:this.localization.developerInformation,text:["Image debug information (from when this dialog was opened):",`    ${this.viewport.getScaleFactor()}x zoom, ${180/Math.PI*this.viewport.getRotationAngle()}\xB0 rotation`,`    ${this.image.estimateNumElements()} components`,`    auto-resize: ${this.image.getAutoresizeEnabled()?"enabled":"disabled"}`,`    image size: ${this.getImportExportRect().w}x${this.getImportExportRect().h}`,`    screen size: ${i.x}x${i.y}`,`    device pixel ratio: ${this.display.getDevicePixelRatio()}`,"    cache:",`        ${this.display.getCache().getDebugInfo().replace(/(\n)/g,`
        `)}`].join(`
`),minimized:true}),e.push({heading:this.localization.softwareLibraries,text:[`This image editor is powered by easydrawer v${Ao.number}.`,"","At runtime, easydrawer uses"," - The Coloris color picker: https://github.com/mdbassit/Coloris"," - The bezier.js B\xE9zier curve library: https://github.com/Pomax/bezierjs","","Both are licensed under the MIT license:","","","== Coloris ==",Hi("2021 Mohammed Bassit"),"","","== Bezier.js ==",Hi('2023 Mike "Pomax" Kamermans'),"","","== easydrawer ==",Hi("2023-2025 Henry Heino"),""].join(`
`),minimized:true}),o&&e.push({heading:"Icon Pack",text:o,minimized:true}),e.push(...this.settings.notices),this.closeAboutDialog?.(),this.closeAboutDialog=Es(this,e).close;}remove(){this.container.remove(),this.toolController.onEditorDestroyed();}async uploadImages(o){let e=Array.from(o);if(e.length===0)return;let i=(await Promise.all(e.map(async l=>zt(l)))).flat(),r=[],n=w.identity,a=null;for(let l of i){let c=new Image;c.src=l;let d;try{d=await ne.fromImage(c,n);}catch(h){console.error("Error loading image",h);return}let p=d.getBBox();if(p.area===0)return;r.push(d),a??=p,a.union(p);let u=exports.Vec2.of(0,p.height);n=n.rightMul(w.translation(u));}r.length>0&&this.addAndCenterComponents(r);}},cn=dn;var cP=cn;exports.Abstract2DShape=Fo;exports.AbstractComponent=G;exports.AbstractRenderer=ve;exports.AbstractToolbar=_e;exports.ActionButtonWidget=Ie;exports.BackgroundComponent=ee;exports.BackgroundComponentBackgroundType=fo;exports.BaseTool=H;exports.BaseToolWidget=re;exports.BaseWidget=Q;exports.CanvasRenderer=xe;exports.Color4=P;exports.Command=we;exports.ComponentSizingMode=Xt;exports.Display=Wt;exports.DocumentPropertiesWidget=wt;exports.DummyRenderer=qe;exports.Duplicate=Lt;exports.Editor=cn;exports.EditorEventType=ta;exports.EditorImage=K;exports.Erase=_;exports.EraserMode=Si;exports.EraserTool=Ke;exports.EraserToolWidget=Pt;exports.EventDispatcher=Pe;exports.HTMLToolbar=_e;exports.HandToolWidget=Et;exports.IconProvider=Nt;exports.ImageComponent=ne;exports.InputEvtType=ni;exports.InputMapper=ge;exports.InsertImageWidget=Bi;exports.KeyBinding=yt;exports.KeyboardShortcutManager=V;exports.LineSegment2=oe;exports.Mat33=w;exports.MutableReactiveValue=Z;exports.PanZoomMode=Ci;exports.PanZoomTool=he;exports.Parameterized2DShape=Oo;exports.PasteHandler=Mt;exports.Path=B;exports.PathCommandType=q;exports.PenTool=Me;exports.PenToolWidget=It;exports.Pointer=be;exports.PointerDevice=bi;exports.QuadraticBezier=Te;exports.ReactiveValue=N;exports.Rect2=I;exports.RenderingMode=nn;exports.SVGLoader=Ge;exports.SVGRenderer=ae;exports.SelectAllShortcutHandler=Vt;exports.SelectionMode=yo;exports.SelectionTool=ce;exports.SelectionToolWidget=At;exports.SerializableCommand=O;exports.SoundUITool=zi;exports.Stroke=F;exports.StrokeComponent=F;exports.StrokeSmoother=Ta;exports.Text=Y;exports.TextComponent=Y;exports.TextTool=ke;exports.TextToolWidget=Dt;exports.ToolController=Ht;exports.ToolEnabledGroup=ct;exports.ToolSwitcherShortcut=Ft;exports.ToolbarShortcutHandler=Ne;exports.ToolbarWidgetTag=Kn;exports.Triangle=ji;exports.UndoEventType=oa;exports.UndoRedoHistory=ln;exports.UndoRedoShortcut=Ot;exports.Viewport=A;exports.__easy_draw__version=Ao;exports.adjustEditorThemeForContrast=rl;exports.comparePathIndices=Go;exports.createRestyleComponentCommand=Je;exports.default=cP;exports.defaultEditorLocalization=We;exports.getLocalizationTable=pr;exports.invertCommand=$a;exports.isPointerEvt=ro;exports.isRestylableComponent=ti;exports.keyPressEventFromHTMLEvent=ai;exports.keyUpEventFromHTMLEvent=si;exports.makeArrowBuilder=co;exports.makeCircleBuilder=Qt;exports.makeColorInput=da;exports.makeDropdownToolbar=Xa;exports.makeEdgeToolbar=Qa;exports.makeFilledRectangleBuilder=uo;exports.makeFreehandLineBuilder=fe;exports.makeLineBuilder=mo;exports.makeOutlinedRectangleBuilder=gr;exports.makePolylineBuilder=Be;exports.makePressureSensitiveFreehandLineBuilder=$e;exports.matchingLocalizationTable=ci;exports.pathFromRenderable=Ye;exports.pathToRenderable=M;exports.pathVisualEquivalent=Xi;exports.sendPenEvent=sn;exports.sendTouchEvent=ol;exports.stepPathIndexBy=Zi;exports.toRoundedString=ie;exports.uniteCommands=J;Object.defineProperty(exports,'__esModule',{value:true});return exports;})({});