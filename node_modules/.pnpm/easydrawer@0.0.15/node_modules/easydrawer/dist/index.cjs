'use strict';Object.defineProperty(exports,'__esModule',{value:true});var bezierJs=require('bezier-js');var wi=class{constructor(t,e,o){this.x=t;this.y=e;this.z=o;}get xy(){return {x:this.x,y:this.y}}at(t){if(t===0)return this.x;if(t===1)return this.y;if(t===2)return this.z;throw new Error(`${t} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.magnitudeSquared())}magnitudeSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}squareDistanceTo(t){let e=this.x-t.x,o=this.y-t.y,i=this.z-t.z;return e*e+o*o+i*i}distanceTo(t){return Math.sqrt(this.squareDistanceTo(t))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.max(Math.abs(this.y),Math.abs(this.z)))}angle(){return Math.atan2(this.y,this.x)}normalized(){let t=this.magnitude();return exports.Vec3.of(this.x/t,this.y/t,this.z/t)}normalizedOrZero(){return this.eq(exports.Vec3.zero)?exports.Vec3.zero:this.normalized()}times(t){return exports.Vec3.of(this.x*t,this.y*t,this.z*t)}plus(t){return exports.Vec3.of(this.x+t.x,this.y+t.y,this.z+t.z)}minus(t){return exports.Vec3.of(this.x-t.x,this.y-t.y,this.z-t.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return exports.Vec3.of(this.y*t.z-t.y*this.z,t.x*this.z-this.x*t.z,this.x*t.y-t.x*this.y)}scale(t){return typeof t=="number"?this.times(t):exports.Vec3.of(this.x*t.x,this.y*t.y,this.z*t.z)}orthog(){return this.dot(exports.Vec3.unitX)===0&&this.dot(exports.Vec3.unitY)===0?this.dot(exports.Vec3.unitX)===0?exports.Vec3.unitX:this.cross(exports.Vec3.unitX).normalized():this.cross(exports.Vec3.unitZ.times(-1)).normalized()}extend(t,e){return this.plus(e.normalized().times(t))}lerp(t,e){return this.times(1-e).plus(t.times(e))}zip(t,e){return exports.Vec3.of(e(t.x,this.x),e(t.y,this.y),e(t.z,this.z))}map(t){return exports.Vec3.of(t(this.x,0),t(this.y,1),t(this.z,2))}asArray(){return [this.x,this.y,this.z]}eq(t,e=1e-10){return Math.abs(t.x-this.x)<=e&&Math.abs(t.y-this.y)<=e&&Math.abs(t.z-this.z)<=e}toString(){return `Vec(${this.x}, ${this.y}, ${this.z})`}},Pi=class{constructor(t,e){this.x=t;this.y=e;}get z(){return 0}get xy(){return {x:this.x,y:this.y}}at(t){if(t===0)return this.x;if(t===1)return this.y;if(t===2)return 0;throw new Error(`${t} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}magnitudeSquared(){return this.x*this.x+this.y*this.y}squareDistanceTo(t){let e=this.x-t.x,o=this.y-t.y;return e*e+o*o+t.z*t.z}distanceTo(t){return Math.sqrt(this.squareDistanceTo(t))}maximumEntryMagnitude(){return Math.max(Math.abs(this.x),Math.abs(this.y))}angle(){return Math.atan2(this.y,this.x)}normalized(){let t=this.magnitude();return exports.Vec2.of(this.x/t,this.y/t)}normalizedOrZero(){return this.eq(exports.Vec3.zero)?exports.Vec3.zero:this.normalized()}times(t){return exports.Vec2.of(this.x*t,this.y*t)}plus(t){return exports.Vec3.of(this.x+t.x,this.y+t.y,t.z)}minus(t){return exports.Vec3.of(this.x-t.x,this.y-t.y,-t.z)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return exports.Vec3.of(this.y*t.z,-this.x*t.z,this.x*t.y-t.x*this.y)}scale(t){return typeof t=="number"?this.times(t):exports.Vec2.of(this.x*t.x,this.y*t.y)}orthog(){return this.dot(exports.Vec3.unitX)===0&&this.dot(exports.Vec3.unitY)===0?this.dot(exports.Vec3.unitX)===0?exports.Vec3.unitX:this.cross(exports.Vec3.unitX).normalized():this.cross(exports.Vec3.unitZ.times(-1)).normalized()}extend(t,e){return this.plus(e.normalized().times(t))}lerp(t,e){return this.times(1-e).plus(t.times(e))}zip(t,e){return exports.Vec3.of(e(t.x,this.x),e(t.y,this.y),e(t.z,0))}map(t){return exports.Vec3.of(t(this.x,0),t(this.y,1),t(0,2))}asArray(){return [this.x,this.y,0]}eq(t,e=1e-10){return Math.abs(t.x-this.x)<=e&&Math.abs(t.y-this.y)<=e&&Math.abs(t.z)<=e}toString(){return `Vec(${this.x}, ${this.y})`}};exports.Vec2=void 0;(r=>{function n(s,a){return new Pi(s,a)}r.of=n;function t({x:s,y:a}){return r.of(s,a)}r.ofXY=t,r.unitX=r.of(1,0),r.unitY=r.of(0,1),r.zero=r.of(0,0);})(exports.Vec2||={});exports.Vec3=void 0;(r=>{function n(s,a,l){return l===0?exports.Vec2.of(s,a):new wi(s,a,l)}r.of=n,r.unitX=exports.Vec2.unitX,r.unitY=exports.Vec2.unitY,r.zero=exports.Vec2.zero,r.unitZ=r.of(0,0,1);})(exports.Vec3||={});var xo=class n{static smallValue=1e-12;distance(t){return Math.abs(this.signedDistance(t))}containsPoint(t,e=n.smallValue){return this.signedDistance(t)<e}getLooseBoundingBox(){return this.getTightBoundingBox()}},Oe=xo;var So=class extends Oe{intersectsLineSegment(t){return this.argIntersectsLineSegment(t).map(e=>this.at(e))}},tt=So;var T=class n{constructor(t,e,o,i,r,s,a,l,c){this.a1=t;this.a2=e;this.a3=o;this.b1=i;this.b2=r;this.b3=s;this.c1=a;this.c2=l;this.c3=c;this.rows=[exports.Vec3.of(t,e,o),exports.Vec3.of(i,r,s),exports.Vec3.of(a,l,c)];}rows;static ofRows(t,e,o){return new n(t.x,t.y,t.z,e.x,e.y,e.z,o.x,o.y,o.z)}static identity=new n(1,0,0,0,1,0,0,0,1);inverse(){return this.computeInverse()??n.identity}invertable(){return this.computeInverse()!==null}cachedInverse=void 0;computeInverse(){if(this.cachedInverse!==void 0)return this.cachedInverse;let t=[this.rows[0],this.rows[1],this.rows[2]],e=[exports.Vec3.unitX,exports.Vec3.unitY,exports.Vec3.unitZ];for(let i=0;i<3;i++){let r=t[i].at(i),s=1e-10;if(Math.abs(r)<s){let d=-1;for(let h=1;h<=2;h++){let m=(i+h)%3;if(Math.abs(t[m].at(i))>=s){d=m;break}}if(d===-1)return this.cachedInverse=null,null;let p=t[i],u=e[i];t[i]=t[d],e[i]=e[d],t[d]=p,e[d]=u,r=t[i].at(i);}let a=1/r;t[i]=t[i].times(a),e[i]=e[i].times(a);let l=t[i],c=e[i];for(let d=1;d<=2;d++){let p=(i+d)%3;a=-t[p].at(i),t[p]=t[p].plus(l.times(a)),e[p]=e[p].plus(c.times(a));}}let o=n.ofRows(e[0],e[1],e[2]);return this.cachedInverse=o,o}transposed(){return new n(this.a1,this.b1,this.c1,this.a2,this.b2,this.c2,this.a3,this.b3,this.c3)}rightMul(t){t=t.transposed();let e=(o,i)=>this.rows[o].dot(t.rows[i]);return new n(e(0,0),e(0,1),e(0,2),e(1,0),e(1,1),e(1,2),e(2,0),e(2,1),e(2,2))}transformVec2(t){let e=exports.Vec3.of(t.x,t.y,1);return e=this.transformVec3(e),exports.Vec2.of(e.x,e.y)}transformVec3(t){return exports.Vec3.of(this.rows[0].dot(t),this.rows[1].dot(t),this.rows[2].dot(t))}isIdentity(){return this===n.identity?true:this.eq(n.identity)}eq(t,e=0){for(let o=0;o<3;o++)if(!this.rows[o].eq(t.rows[o],e))return  false;return  true}toString(){let t="",e=[0,0,0];for(let o of this.rows)for(let i=0;i<3;i++)e[i]=Math.max(e[0],`${o.at(i)}`.length);for(let o=0;o<3;o++){o===0?t+="\u23A1 ":o===1?t+="\u23A2 ":t+="\u23A3 ";for(let i=0;i<3;i++){let r=this.rows[o].at(i).toString(),s="";for(let a=r.length;a<e[i];a++)s+=" ";t+=r+", "+s;}o===0?t+=" \u23A4":o===1?t+=" \u23A5":t+=" \u23A6",t+=`
`;}return t.trimEnd()}toArray(){return [this.a1,this.a2,this.a3,this.b1,this.b2,this.b3,this.c1,this.c2,this.c3]}mapEntries(t){return new n(t(this.a1,[0,0]),t(this.a2,[0,1]),t(this.a3,[0,2]),t(this.b1,[1,0]),t(this.b2,[1,1]),t(this.b3,[1,2]),t(this.c1,[2,0]),t(this.c2,[2,1]),t(this.c3,[2,2]))}getScaleFactor(){return Math.hypot(this.a1,this.a2)}getColumn(t){return exports.Vec3.of(this.rows[0].at(t),this.rows[1].at(t),this.rows[2].at(t))}maximumEntryMagnitude(){let t=Math.abs(this.a1);for(let e of this.toArray())t=Math.max(t,Math.abs(e));return t}static translation(t){return new n(1,0,t.x,0,1,t.y,0,0,1)}static zRotation(t,e=exports.Vec2.zero){if(t===0)return n.identity;let o=Math.cos(t),i=Math.sin(t),r=n.translation(e);return r=r.rightMul(new n(o,-i,0,i,o,0,0,0,1)),r.rightMul(n.translation(e.times(-1)))}static scaling2D(t,e=exports.Vec2.of(0,0)){let o=n.translation(e),i,r;return typeof t=="number"?(i=t,r=t):(i=t.x,r=t.y),o=o.rightMul(new n(i,0,0,0,r,0,0,0,1)),o.rightMul(n.translation(e.times(-1)))}toCSSMatrix(){return `matrix(${this.a1},${this.b1},${this.a2},${this.b2},${this.a3},${this.b3})`}static fromCSSMatrix(t){if(t===""||t==="none")return n.identity;t=t.trim().replace(/\s+/g," ");let e=a=>a.split(/[\t\n ,]+/g).map(c=>{if(c.trim()==="")return null;let d=false;if(c.endsWith("%")&&(d=true,c=c.substring(0,c.length-1)),c=c.replace(/px$/gi,""),!/^-?\d*(?:\.\d*)?(?:e[+-]?\d+)?$/i.test(c))throw new Error(`All arguments to transform functions must be numeric (state: ${JSON.stringify({currentArgument:c,allArguments:a})})`);let u=Number.parseFloat(c);return d&&(u/=100),u}).filter(c=>c!==null),o={matrix:a=>{if(a.length!==6)throw new Error(`Invalid matrix argument: ${a}. Must have length 6`);let l=a[0],c=a[1],d=a[2],p=a[3],u=a[4],h=a[5];return new n(l,d,u,c,p,h,0,0,1)},scale:a=>{let l,c;if(a.length===1)l=a[0],c=a[0];else if(a.length===2)l=a[0],c=a[1];else throw new Error(`The scale() function only supports two arguments. Given: ${a}`);return n.scaling2D(exports.Vec2.of(l,c))},translate:a=>{let l=0,c=0;if(a.length===1)l=a[0];else if(a.length===2)l=a[0],c=a[1];else throw new Error(`The translate() function requires either 1 or 2 arguments. Given ${a}`);return n.translation(exports.Vec2.of(l,c))}},i=/(?:^|\W)(\w+)\s?\(([^)]*)\)/gi,r,s=null;for(;(r=i.exec(t))!==null;){let a=r[1].toLowerCase();if(!(a in o))throw new Error(`Unsupported CSS transform action: ${a}`);let l=e(r[2]),c=o[a](l);s?s=s.rightMul(c):s=c;}return s??n.identity}},Xr=T;var P=class n extends Oe{constructor(e,o,i,r){super();this.x=e;this.y=o;this.w=i;this.h=r;i<0&&(this.x+=i,this.w=Math.abs(i)),r<0&&(this.y+=r,this.h=Math.abs(r)),this.topLeft=exports.Vec2.of(this.x,this.y),this.size=exports.Vec2.of(this.w,this.h),this.area=this.w*this.h;}topLeft;size;area;translatedBy(e){return new n(e.x+this.x,e.y+this.y,this.w,this.h)}resizedTo(e){return new n(this.x,this.y,e.x,e.y)}containsPoint(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x&&this.y+this.h>=e.y}containsRect(e){return this.x<=e.x&&this.y<=e.y&&this.x+this.w>=e.x+e.w&&this.y+this.h>=e.y+e.h}intersects(e){let o=this.x,i=o+this.w,r=e.x,s=e.x+e.w;if(i<r||o>s)return  false;let a=this.y,l=a+this.h,c=e.y,d=e.y+e.h;return !(l<c||a>d)}intersection(e){if(!this.intersects(e))return null;let o=this.topLeft.zip(e.topLeft,Math.max),i=this.bottomRight.zip(e.bottomRight,Math.min);return n.fromCorners(o,i)}union(e){return n.union(this,e)}divideIntoGrid(e,o){let i=[];if(e<=0||o<=0)return i;let r=this.w/e,s=this.h/o;r===0&&(e=1),s===0&&(o=1);for(let a=0;a<o;a++)for(let l=0;l<e;l++){let c=r*l+this.x,d=s*a+this.y;i.push(new n(c,d,r,s));}return i}grownToPoint(e,o=0){let i=new n(e.x-o,e.y-o,o*2,o*2);return this.union(i)}grownBy(e){if(e===0)return this;if(e<0){let o=-Math.min(-e,this.w/2),i=-Math.min(-e,this.h/2);return new n(this.x-o,this.y-i,this.w+o*2,this.h+i*2)}return new n(this.x-e,this.y-e,this.w+e*2,this.h+e*2)}grownToSize(e){if(this.width>=e.x&&this.height>=e.y)return this;let o=Math.max(0,e.x-this.width),i=Math.max(0,e.y-this.height);return new n(this.x-o/2,this.y-i/2,this.width+o,this.height+i)}getClosestPointOnBoundaryTo(e){let o=this.getEdges().map(s=>s.closestPointTo(e)),i=null,r=null;for(let s of o){let a=s.distanceTo(e);(r===null||a<r)&&(i=s,r=a);}return i}isWithinRadiusOf(e,o){if(this.maxDimension>e)return  false;let i=e*e;return this.corners.every(r=>r.minus(o).magnitudeSquared()<i)}get corners(){return [this.bottomRight,this.topRight,this.topLeft,this.bottomLeft]}get maxDimension(){return Math.max(this.w,this.h)}get minDimension(){return Math.min(this.w,this.h)}get bottomRight(){return this.topLeft.plus(this.size)}get topRight(){return this.bottomRight.plus(exports.Vec2.of(0,-this.h))}get bottomLeft(){return this.topLeft.plus(exports.Vec2.of(0,this.h))}get width(){return this.w}get height(){return this.h}get center(){return exports.Vec2.of(this.x+this.w/2,this.y+this.h/2)}getEdges(){let e=this.corners;return [new X(e[0],e[1]),new X(e[1],e[2]),new X(e[2],e[3]),new X(e[3],e[0])]}intersectsLineSegment(e){let o=[];for(let i of this.getEdges())i.intersectsLineSegment(e).forEach(s=>o.push(s));return o}signedDistance(e){let o=this.getClosestPointOnBoundaryTo(e),i=e.minus(o).magnitude();return this.containsPoint(e)?-i:i}getTightBoundingBox(){return this}transformedBoundingBox(e){return e===Xr.identity?this:n.bboxOf(this.corners.map(o=>e.transformVec2(o)))}eq(e,o=0){return this.topLeft.eq(e.topLeft,o)&&this.size.eq(e.size,o)}toString(){return `Rect(point(${this.x}, ${this.y}), size(${this.w}, ${this.h}))`}static fromCorners(e,o){return new n(Math.min(e.x,o.x),Math.min(e.y,o.y),Math.abs(e.x-o.x),Math.abs(e.y-o.y))}static bboxOf(e,o=0){let i=0,r=0,s=0,a=0,l=true;for(let c of e)l&&(i=c.x,r=c.y,s=c.x,a=c.y,l=false),i=Math.min(i,c.x),r=Math.min(r,c.y),s=Math.max(s,c.x),a=Math.max(a,c.y);return n.fromCorners(exports.Vec2.of(i-o,r-o),exports.Vec2.of(s+o,a+o))}static union(...e){if(e.length===0)return n.empty;let o=e[0],i=o.x,r=o.y,s=o.x+o.w,a=o.y+o.h;for(let l=1;l<e.length;l++){let c=e[l];i=Math.min(i,c.x),r=Math.min(r,c.y),s=Math.max(s,c.x+c.w),a=Math.max(a,c.y+c.h);}return new n(i,r,s-i,a-r)}static of(e){let o=e.width??e.w??0,i=e.height??e.h??0;return new n(e.x,e.y,o,i)}static empty=new n(0,0,0,0);static unitSquare=new n(0,0,1,1)},Z=P;var Q=class n extends tt{constructor(e,o){super();this.point1=e;this.point2=o;this.bbox=Z.bboxOf([e,o]),this.direction=o.minus(e),this.length=this.direction.magnitude(),this.length>0&&(this.direction=this.direction.times(1/this.length));}direction;length;bbox;static ofSmallestContainingPoints(e){if(e.length<=1)return null;let o=[...e].sort((r,s)=>r.x!==s.x?r.x-s.x:r.y-s.y),i=new n(o[0],o[o.length-1]);for(let r of o)if(!i.containsPoint(r))return null;return i}get p1(){return this.point1}get p2(){return this.point2}get center(){return this.point1.lerp(this.point2,.5)}get(e){return this.point1.plus(this.direction.times(e))}at(e){return this.get(e*this.length)}normalAt(e){return this.direction.orthog()}tangentAt(e){return this.direction}splitAt(e){return e<=0||e>=1?[this]:[new n(this.point1,this.at(e)),new n(this.at(e),this.point2)]}intersection(e){let o,i;if(Math.abs(this.direction.x)<4e-13){if(e.direction.x===0||this.direction.y===0)return null;let d=this.point1.x,p=(this.point1.x-e.point1.x)*e.direction.y/e.direction.x+e.point1.y;o=exports.Vec2.of(d,p),i=(p-this.point1.y)/this.direction.y;}else {let d=(this.point1.y-e.point1.y)*this.direction.x*e.direction.x+this.direction.x*e.direction.y*e.point1.x-this.direction.y*e.direction.x*this.point1.x,p=e.direction.y*this.direction.x-this.direction.y*e.direction.x;if(p===0)return null;let u=d/p,h=(u-this.point1.x)/this.direction.x,m=this.point1.y+this.direction.y*h;o=exports.Vec2.of(u,m),i=(u-this.point1.x)/this.direction.x;}let s=o.distanceTo(this.point1),a=o.distanceTo(this.point2),l=o.distanceTo(e.point1),c=o.distanceTo(e.point2);return s>this.length||a>this.length||l>e.length||c>e.length?null:{point:o,t:i}}intersects(e){return this.intersection(e)!==null}argIntersectsLineSegment(e){let o=this.intersection(e);return o?[o.t/this.length]:[]}intersectsLineSegment(e){let o=this.intersection(e);return o?[o.point]:[]}closestPointTo(e){return this.nearestPointTo(e).point}nearestPointTo(e){let o=e.minus(this.p1).dot(this.direction),i=this.length-o,r=this.p1.plus(this.direction.times(o));return o>0&&o<this.length?{point:r,parameterValue:o/this.length}:Math.abs(i)<Math.abs(o)?{point:this.p2,parameterValue:1}:{point:this.p1,parameterValue:0}}signedDistance(e){return this.closestPointTo(e).minus(e).magnitude()}transformedBy(e){return new n(e.transformVec2(this.p1),e.transformVec2(this.p2))}getTightBoundingBox(){return this.bbox}toString(){return `LineSegment(${this.p1.toString()}, ${this.p2.toString()})`}eq(e,o){if(!(e instanceof n))return  false;let i=o?.tolerance,r=o?.ignoreDirection??true;return e.p1.eq(this.p1,i)&&e.p2.eq(this.p2,i)||r&&e.p1.eq(this.p2,i)&&e.p2.eq(this.p1,i)}},X=Q;var Co=class extends tt{#e=null;constructor(t){super(),t&&(this.#e=t);}getBezier(){return this.#e||(this.#e=new bezierJs.Bezier(this.getPoints().map(t=>t.xy))),this.#e}signedDistance(t){return this.nearestPointTo(t).point.distanceTo(t)}distance(t){return this.signedDistance(t)}at(t){return exports.Vec2.ofXY(this.getBezier().get(t))}derivativeAt(t){return exports.Vec2.ofXY(this.getBezier().derivative(t))}secondDerivativeAt(t){return exports.Vec2.ofXY(this.getBezier().dderivative(t))}normal(t){return exports.Vec2.ofXY(this.getBezier().normal(t))}normalAt(t){return this.normal(t)}tangentAt(t){return this.derivativeAt(t).normalized()}getTightBoundingBox(){let t=this.getBezier().bbox(),e=t.x.max-t.x.min,o=t.y.max-t.y.min;return new Z(t.x.min,t.y.min,e,o)}argIntersectsLineSegment(t){let e=X.ofSmallestContainingPoints(this.getPoints());return e?e.intersectsLineSegment(t).map(r=>this.nearestPointTo(r).parameterValue):this.getBezier().intersects(t).map(i=>{typeof i=="string"&&(i=Number.parseFloat(i));let r=exports.Vec2.ofXY(this.at(i));return r.distanceTo(t.p1)>t.length||r.distanceTo(t.p2)>t.length?null:i}).filter(i=>i!==null)}splitAt(t){if(t<=0||t>=1)return [this];let o=this.getBezier().split(t);return [new To(o.left.points.map(i=>exports.Vec2.ofXY(i)),o.left),new To(o.right.points.map(i=>exports.Vec2.ofXY(i)),o.right)]}nearestPointTo(t){let e=d=>t.squareDistanceTo(this.at(d)),o=e(0),i=0,r=o,s=4;for(let d=0;d<s;d++){let p=d/(s-1),u=e(p);u<r&&(i=p,r=u);}let a=d=>{let p=this.at(d),u=this.derivativeAt(d),h=this.secondDerivativeAt(d);return 2*u.x*u.x+2*p.x*h.x-2*t.x*h.x+2*u.y*u.y+2*p.y*h.y-2*t.y*h.y},l=d=>{let p=this.at(d),u=this.derivativeAt(d);return 2*p.x*u.x-2*t.x*u.x+2*p.y*u.y-2*t.y*u.y},c=()=>{let d=a(i);if(d===0)return;i=(0-l(i))/d+i,i>1?i=1:i<0&&(i=0);};for(let d=0;d<12;d++)c();return {parameterValue:i,point:this.at(i)}}intersectsBezier(t){let e=this.getBezier().intersects(t.getBezier());if(!e||e.length===0)return [];let o=[];for(let i of e){let r=/^([\d.Ee-]+)\/([\d.Ee-]+)$/.exec(i);if(!r)throw new Error(`Incorrect format returned by .intersects: ${e} should be array of "number/number"!`);let s=Number.parseFloat(r[1]);o.push({parameterValue:s,point:this.at(s)});}return o}toString(){return `B\xE9zier(${this.getPoints().map(t=>t.toString()).join(", ")})`}},To=class extends Co{constructor(e,o){super(o);this.controlPoints=e;}getPoints(){return this.controlPoints}},wo=Co;var Ei=class extends wo{constructor(e,o,i,r){super();this.p0=e;this.p1=o;this.p2=i;this.p3=r;}getPoints(){return [this.p0,this.p1,this.p2,this.p3]}getLooseBoundingBox(){return Z.bboxOf([this.p0,this.p1,this.p2,this.p3])}},Qr=Ei;var Ii=class extends tt{constructor(e){super();this.p=e;}signedDistance(e){return this.p.distanceTo(e)}argIntersectsLineSegment(e,o){return e.containsPoint(this.p,o)?[0]:[]}getTightBoundingBox(){return new Z(this.p.x,this.p.y,0,0)}at(e){return this.p}normalAt(e){return exports.Vec2.unitY}tangentAt(e){return exports.Vec2.unitX}splitAt(e){return [this]}nearestPointTo(e){return {point:this.p,parameterValue:0}}},Jr=Ii;function Ss(n,t,e){if(n===0){let a;return t===0?a=e===0?0:Number.NaN:a=-e/t,[a,a]}let o=t*t-4*n*e;if(o<0)return [Number.NaN,Number.NaN];let i=Math.sqrt(o),r=(-t+i)/(2*n),s=(-t-i)/(2*n);return r>s?[r,s]:[s,r]}var en=Ss;var me=class n extends wo{constructor(e,o,i){super();this.p0=e;this.p1=o;this.p2=i;}static componentAt(e,o,i,r){return o+e*(-2*o+2*i)+e*e*(o-2*i+r)}static derivativeComponentAt(e,o,i,r){return  -2*o+2*i+2*e*(o-2*i+r)}static secondDerivativeComponentAt(e,o,i,r){return 2*(o-2*i+r)}at(e){if(e===0)return this.p0;if(e===1)return this.p2;let o=this.p0,i=this.p1,r=this.p2;return exports.Vec2.of(n.componentAt(e,o.x,i.x,r.x),n.componentAt(e,o.y,i.y,r.y))}derivativeAt(e){let o=this.p0,i=this.p1,r=this.p2;return exports.Vec2.of(n.derivativeComponentAt(e,o.x,i.x,r.x),n.derivativeComponentAt(e,o.y,i.y,r.y))}secondDerivativeAt(e){let o=this.p0,i=this.p1,r=this.p2;return exports.Vec2.of(n.secondDerivativeComponentAt(e,o.x,i.x,r.x),n.secondDerivativeComponentAt(e,o.y,i.y,r.y))}normal(e){return this.derivativeAt(e).orthog().normalized()}getLooseBoundingBox(){return Z.bboxOf([this.p0,this.p1,this.p2])}approximateDistance(e){let o=this.p0.x-e.x,i=-2*this.p0.x+2*this.p1.x,r=this.p0.x-2*this.p1.x+this.p2.x,s=this.p0.y-e.y,a=-2*this.p0.y+2*this.p1.y,l=this.p0.y-2*this.p1.y+this.p2.y,c=2*o*i+2*s*a-e.x*i-e.y*a,d=2*i*i+2*a*a+2*r*o+2*l*s-e.x*r-e.y*l,p=2*a*l+2*i*r+2*r*i+2*l*a,u=c,h=d,m=2*p,[g,b]=en(m/2,h,u);isNaN(g)&&(g=.25),isNaN(b)&&(b=.75);let v=this.at(g),f=this.at(b),x=v.squareDistanceTo(e),S=f.squareDistanceTo(e),C=this.at(0).squareDistanceTo(e),k=this.at(1).squareDistanceTo(e);return Math.sqrt(Math.min(x,S,C,k))}getPoints(){return [this.p0,this.p1,this.p2]}},tn=me;function Cs(n){if(n.indexOf("e")>0&&/[Ee]-\d{2,}$/.test(n))return "0";let t=n.charAt(n.length-1);(t==="0"||t===".")&&(n=n.replace(/(\.\d*[^0])0+$/,"$1"),n=n.replace(/\.0+$/,"."),n=n.replace(/\.$/,""));let e=n.charAt(0);return (e==="0"||e==="-")&&(n=n.replace(/^(0+)\./,"."),n=n.replace(/^-(0+)\./,"-."),n=n.replace(/^(-?)0+$/,"$10")),n==="-0"?"0":n}var Po=Cs;function J(n){let t=/^(-?\d*\.\d{3,})0{4,}\d{1,4}$/,e=/^(-?)(\d*)\.(\d{3,}9{4,})\d{1,4}$/,o=n.toString(10);if(!o.includes("."))return o;let i=e.exec(o);if(i){let r=i[1],s=i[3],a=Number.parseInt(s.charAt(s.length-1),10),l=Number.parseInt(s,10),c=Number.parseInt(i[2],10),d=i[3],p=(l+10-a).toString(),u=0;for(p.length>l.toString().length&&(p=p.substring(1),u=1);p.length<d.length;)p=u.toString(10)+p,u=0;o=`${r+(c+u).toString()}.${p}`;}return o=o.replace(t,"$1"),Po(o)}var He=J;var Eo=/^(-?)(\d*)\.(\d+)$/;function Ts(n){let t=Eo.exec(n);return t?t[3].length:n.search(/[Ee]/)!==-1||/^[A-Za-z]+$/.test(n)?-1:0}var on=Ts;function ws(n,...t){let e=n.toString(10),o=Eo.exec(e);if(!o)return e;let i=-1;for(let c of t)i=Math.max(on(c),i);if(i===-1)return He(n);let r=o[3].substring(0,i),s=o[2],a=o[3].charAt(i);if(a!==""&&Number.parseInt(a,10)>=5){if(r.length>0){let d=/^(0+)(\d*)$/.exec(r),p="",u=r;d&&(p=d[1],u=d[2]),r=(Number.parseInt(r)+1).toString(),r.length>u.length&&p.length>0&&(p=p.substring(1)),r=p+r;}(r.length===0||r.length>i)&&(s=(Number.parseInt(s)+1).toString(),r=r.substring(1));}let l=o[1];return Po(`${l}${s}.${r}`)}var ki=ws;function Ps(n){if(n.length===0)return [];let t=n.reduce((r,s)=>s.y<r.y?s:r,n[0]),e=[t],o=[...n.filter(r=>!r.eq(t))],i=exports.Vec2.of(-1,0);for(;o.length>0;){let r=e[e.length-1],s=i.dot(t.minus(r).normalizedOrZero()),a=t;for(let c of o){let d=i.dot(c.minus(r).normalizedOrZero());d<=s&&(a=c,s=d);}o=o.filter(c=>!c.eq(a));let l=a.minus(r).normalized();if(Math.abs(l.dot(i))===1&&e.length>1&&e.pop(),a.eq(t))break;e.push(a),i=r.minus(a).normalized();}return e}var rn=Ps;var $=(i=>(i[i.LineTo=0]="LineTo",i[i.MoveTo=1]="MoveTo",i[i.CubicBezierTo=2]="CubicBezierTo",i[i.QuadraticBezierTo=3]="QuadraticBezierTo",i))($||{});function Io(n,t){let e=n.curveIndex-t.curveIndex;return e===0?n.parameterValue-t.parameterValue:e}function Ri(n,t){return n.parameterValue+t>1?{curveIndex:n.curveIndex+1,parameterValue:n.parameterValue+t-1}:n.parameterValue+t<0?n.curveIndex===0?{curveIndex:0,parameterValue:0}:{curveIndex:n.curveIndex-1,parameterValue:n.parameterValue+t+1}:{curveIndex:n.curveIndex,parameterValue:n.parameterValue+t}}var R=class n{constructor(t,e){this.startPoint=t;this.parts=e,this.bbox=Z.bboxOf([t]);for(let o of this.parts)this.bbox=this.bbox.union(n.computeBBoxForSegment(t,o));}bbox;parts;getExactBBox(){let t=[];for(let e of this.geometry)t.push(e.getTightBoundingBox());return Z.union(...t)}cachedGeometry=null;get geometry(){if(this.cachedGeometry)return this.cachedGeometry;let t=this.startPoint,e=[];for(let o of this.parts){let i;switch(o.kind){case 2:e.push(new Qr(t,o.controlPoint1,o.controlPoint2,o.endPoint)),t=o.endPoint;break;case 3:e.push(new tn(t,o.controlPoint,o.endPoint)),t=o.endPoint;break;case 0:e.push(new X(t,o.point)),t=o.point;break;case 1:e.push(new Jr(o.point)),t=o.point;break;default:return i=o,i}}return this.cachedGeometry=e,this.cachedGeometry}*startEndPoints(){yield this.startPoint;for(let t of this.parts){let e;switch(t.kind){case 2:yield t.endPoint;break;case 3:yield t.endPoint;break;case 0:yield t.point;break;case 1:yield t.point;break;default:return e=t,e}}}cachedPolylineApproximation=null;polylineApproximation(){if(this.cachedPolylineApproximation)return this.cachedPolylineApproximation;let t=[];for(let i of this.parts)switch(i.kind){case 2:t.push(i.controlPoint1,i.controlPoint2,i.endPoint);break;case 3:t.push(i.controlPoint,i.endPoint);break;case 1:case 0:t.push(i.point);break}let e=[],o=this.startPoint;for(let i of t)e.push(new X(o,i)),o=i;return e}static computeBBoxForSegment(t,e){let o=[t],i;switch(e.kind){case 1:case 0:o.push(e.point);break;case 2:o.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case 3:o.push(e.controlPoint,e.endPoint);break;default:return i=e,i}return Z.bboxOf(o)}signedDistance(t,e){let o=1/0;for(let i of this.geometry){let r=i.signedDistance(t)-e;r<o&&(o=r);}return o}raymarchIntersectionWith(t,e,o=[]){if(!t.bbox.intersects(this.bbox.grownBy(e)))return [];let i=t.length,r=[];for(let m of this.geometry){let g=m.getTightBoundingBox().grownBy(e);if(!g.intersects(t.bbox))continue;let b=f=>m.signedDistance(f),v=f=>b(f)-e;v(t.p1)>i&&v(t.p2)>i||r.push({part:m,distFn:b,bbox:g});}if(r.length===0)return [];let s=m=>{let g=1/0,b=null,v=[];for(let f of r){let{part:x,distFn:S,bbox:C}=f;if(!C.containsPoint(m)){v.push(f);continue}let k=S(m);k<=g&&(g=k,b=x);}for(let{part:f,distFn:x,bbox:S}of v){if(isFinite(g)&&!S.grownBy(g).containsPoint(m))continue;let C=x(m);C<=g&&(g=C,b=f);}return [b,g-e]},a=8,l=[t.p1,...o,t.p2],c=m=>m.minus(t.p1).dot(t.direction);l.sort((m,g)=>{let b=c(m),v=c(g);return b-v});let d=[],p=e/1e3,u=(m,g,b)=>{let v=m,[f,x]=s(v),S=c(v);if(x>i)return S;let C=t.direction.times(g);for(let B=0;B<a;B++){let W=x;if(v=v.plus(C.times(W)),S=c(v),S<=b)return S;let[ne,Fe]=s(v);if(Math.abs(Fe)>Math.abs(x))return null;if(x=Fe,f=ne,Math.abs(x)<p)break}let k=S>=0&&S<=i;if(f&&k&&Math.abs(x)<p){d.push({point:v,parameterValue:f.nearestPointTo(v).parameterValue,curve:f,curveIndex:this.geometry.indexOf(f)});let B=e/20/t.length;S+=isFinite(B)?B:0;}return S},h=0;for(let m of l)h=Math.max(h,u(m,1,h)??h),h=Math.max(h,u(m,-1,h)??h);return d}intersection(t,e){let o=[];if(!t.bbox.intersects(this.bbox.grownBy(e??0)))return [];if(this.parts.length===0)return new n(this.startPoint,[{kind:1,point:this.startPoint}]).intersection(t,e);let i=0;for(let s of this.geometry){let a=s.argIntersectsLineSegment(t);for(let l of a)o.push({curve:s,curveIndex:i,point:s.at(l),parameterValue:l});i++;}if(e&&e>1e-8){let s=o.map(a=>a.point);o=this.raymarchIntersectionWith(t,e,s);}return o}nearestPointTo(t){let e=1/0,o=0,i=0,r=this.startPoint;for(let s=0;s<this.geometry.length;s++){let l=this.geometry[s].nearestPointTo(t),c=l.point.squareDistanceTo(t);(s===0||c<e)&&(o=s,e=c,i=l.parameterValue,r=l.point);}return {curve:this.geometry[o],curveIndex:o,parameterValue:i,point:r}}at(t){return t.curveIndex===0&&t.parameterValue===0?this.startPoint:this.geometry[t.curveIndex].at(t.parameterValue)}tangentAt(t){return this.geometry[t.curveIndex].tangentAt(t.parameterValue)}splitNear(t,e){let o=this.nearestPointTo(t);return this.splitAt(o,e)}spliced(t,e,o,i){if(((s,a)=>s.curveIndex<a.curveIndex||s.curveIndex===a.curveIndex&&s.parameterValue<=a.parameterValue)(t,e)){let s=this.splitAt(t,i),a=this.splitAt(e,i),l=s[0],c=a[a.length-1];return o?l.union(o).union(c):l.union(c)}else {let l=this.splitAt([t],i)[0].splitNear(this.at(e),i),c=l[l.length-1];return o?c.union(o):c}}splitAt(t,e){for(Array.isArray(t)||(t=[t]),t=[...t],t.sort(Io);t.length>0&&t[t.length-1].curveIndex>=this.parts.length-1&&t[t.length-1].parameterValue>=1;)t.pop();for(t.reverse();t.length>0&&t[t.length-1].curveIndex<=0&&t[t.length-1].parameterValue<=0;)t.pop();if(t.length===0||this.parts.length===0)return [this];let o=t.length+1,i=e?.mapNewPoint??(d=>d),r=[],s=this.startPoint,a=[],{curveIndex:l,parameterValue:c}=t.pop();for(let d=0;d<this.parts.length;d++)if(d!==l)a.push(this.parts[d]);else {let p=this.parts[d],u=this.geometry[d];for(;d===l;){let h,m=[];switch(p.kind){case 1:a.push({kind:p.kind,point:p.point}),h=p.point;break;case 0:{let b=u.splitAt(c);a.push({kind:p.kind,point:i(b[0].p2)}),h=b[0].p2,b.length>1&&(console.assert(b.length===2),m.push({kind:p.kind,point:b[1].p2}),u=b[1]);}break;case 3:case 2:{let b=u.splitAt(c),v=b.length===2;for(let f of b){u=f;let x=v?a:m,S=f.getPoints();p.kind===2?x.push({kind:p.kind,controlPoint1:i(S[1]),controlPoint2:i(S[2]),endPoint:i(S[3])}):x.push({kind:p.kind,controlPoint:i(S[1]),endPoint:i(S[2])}),v||(h=S[0]),v=false;}}break;default:return p}r.push(new n(s,[...a])),s=i(h),console.assert(!!s,"should have a start point"),a=m,p=m[m.length-1]??p;let g=t.pop();if(g)if(l=g.curveIndex,d===l){let b=this.at(g);c=u.nearestPointTo(b).parameterValue,a=[];}else c=g.parameterValue;else break}}return r.push(new n(s,a)),console.assert(r.length===o,`should split into splitAt.length + 1 splits (was ${r.length}, expected ${o})`),r}asClosed(){let t=[],e=false;for(let i of this.parts)i.kind===1?(t.push({kind:0,point:i.point}),e=true):t.push(i);if(this.getEndPoint().eq(this.startPoint)||(t.push({kind:0,point:this.startPoint}),e=true),!e)return this;let o=new n(this.startPoint,t);return console.assert(o.getEndPoint().eq(o.startPoint)),o}static mapPathCommand(t,e){switch(t.kind){case 1:case 0:return {kind:t.kind,point:e(t.point)};case 2:return {kind:t.kind,controlPoint1:e(t.controlPoint1),controlPoint2:e(t.controlPoint2),endPoint:e(t.endPoint)};case 3:return {kind:t.kind,controlPoint:e(t.controlPoint),endPoint:e(t.endPoint)}}return t}mapPoints(t){let e=t(this.startPoint),o=[];for(let i of this.parts)o.push(n.mapPathCommand(i,t));return new n(e,o)}transformedBy(t){return t.isIdentity()?this:this.mapPoints(e=>t.transformVec2(e))}closedContainsPoint(t){let e=this.getExactBBox();if(!e.containsPoint(t))return  false;let o=t.plus(exports.Vec2.of(e.width,0)),i=this.asClosed(),r=new X(t,o),s=i.intersection(r);return s.filter((l,c)=>c===0?true:!(s[c-1].parameterValue>=1&&l.parameterValue<=0)).length%2===1}closedContainsRect(t){if(!this.bbox.containsRect(t)||!t.corners.every(e=>this.closedContainsPoint(e)))return  false;for(let e of t.getEdges())if(this.intersection(e).length>0)return  false;return  true}union(t,e={allowReverse:true}){if(!t)return this;if(Array.isArray(t))return new n(this.startPoint,[...this.parts,...t]);let o=this.getEndPoint(),i=[];if(o.eq(t.startPoint))i=this.parts.concat(t.parts);else {if(e.allowReverse&&this.startPoint.eq(t.getEndPoint()))return t.union(this,{allowReverse:false});if(e.allowReverse&&this.startPoint.eq(t.startPoint))return this.union(t.reversed(),{allowReverse:false});i=[...this.parts,{kind:1,point:t.startPoint},...t.parts];}return new n(this.startPoint,i)}reversed(){let t=this.getEndPoint(),e=[],o=this.startPoint;for(let i of this.parts)switch(i.kind){case 0:case 1:e.push({kind:i.kind,point:o}),o=i.point;break;case 2:e.push({kind:i.kind,controlPoint1:i.controlPoint2,controlPoint2:i.controlPoint1,endPoint:o}),o=i.endPoint;break;case 3:e.push({kind:i.kind,controlPoint:i.controlPoint,endPoint:o}),o=i.endPoint;break;default:return i}return e.reverse(),new n(t,e)}getEndPoint(){if(this.parts.length===0)return this.startPoint;let t=this.parts[this.parts.length-1];return t.kind===3||t.kind===2?t.endPoint:t.point}roughlyIntersects(t,e=0){if(this.parts.length===0)return t.containsPoint(this.startPoint);if(this.startPoint.eq(this.getEndPoint())&&e===0)return this.closedRoughlyIntersects(t);if(t.containsRect(this.bbox))return  true;let i=this.startPoint;for(let r of this.parts){let s=n.computeBBoxForSegment(i,r).grownBy(e);if(r.kind===0||r.kind===1?i=r.point:i=r.endPoint,t.intersects(s))return  true}return  false}closedRoughlyIntersects(t){if(t.containsRect(this.bbox))return  true;let e=this.bbox.topLeft.minus(exports.Vec2.of(1,1)),o=t.corners,i=this.polylineApproximation();for(let a of o){let l=new X(a,e),c=0;for(let d of i)d.intersects(l)&&c++;if(c%2===1)return  true}let r=t.grownBy(Math.min(t.size.x,t.size.y)),s=[];for(let a of r.divideIntoGrid(4,4))s.push(...a.getEdges());for(let a of s)for(let l of i)if(a.intersects(l))return  true;return  false}eq(t,e){if(t.parts.length!==this.parts.length)return  false;for(let o=0;o<this.parts.length;o++){let i=this.parts[o],r=t.parts[o];switch(i.kind){case 0:case 1:if(i.kind!==r.kind)return  false;if(!i.point.eq(r.point,e))return  false;break;case 2:if(i.kind!==r.kind)return  false;if(!i.controlPoint1.eq(r.controlPoint1,e)||!i.controlPoint2.eq(r.controlPoint2,e)||!i.endPoint.eq(r.endPoint,e))return  false;break;case 3:if(i.kind!==r.kind)return  false;if(!i.controlPoint.eq(r.controlPoint,e)||!i.endPoint.eq(r.endPoint,e))return  false;break;default:return i}}return  true}static fromRect(t,e=null){let o=[],i,r;if(e!==null){let s=exports.Vec2.of(e,e).times(.5),a=Z.fromCorners(t.topLeft.plus(s),t.bottomRight.minus(s)),l=Z.fromCorners(t.topLeft.minus(s),t.bottomRight.plus(s));i=[a.corners[3],...a.corners,...l.corners.reverse()],r=l.corners[3];}else i=t.corners.slice(1),r=t.corners[0];for(let s of i)o.push({kind:0,point:s});return o.push({kind:0,point:r}),new n(r,o)}cachedStringVersion=null;toString(t,e=false){if(this.cachedStringVersion&&!e)return this.cachedStringVersion;t===void 0&&(t=Math.abs(this.bbox.topLeft.x)>10&&Math.abs(this.bbox.topLeft.y)>10);let o=n.toString(this.startPoint,this.parts,!t);return this.cachedStringVersion=o,o}serialize(){return this.toString()}static toString(t,e,o){let i=[],r,s=(l,...c)=>{let d=[],p=[],u=!r||o,h=r?He(r.x):"",m=r?He(r.y):"";for(let b of c){let v=He(b.x),f=He(b.y);if(u)d.push(`${v},${f}`);else {let x=ki(b.x-r.x,v,h,m),S=ki(b.y-r.y,f,h,m);S.charAt(0)==="-"?p.push(`${x}${S}`):p.push(`${x},${S}`);}}let g;u?g=`${l}${d.join(" ")}`:g=`${l.toLowerCase()}${p.join(" ")}`,!(g==="l0,0"||g==="m0,0")&&(i.push(g),c.length>0&&(r=c[c.length-1]));};e[0]?.kind!==1&&s("M",t);let a;for(let l of e)switch(l.kind){case 1:s("M",l.point);break;case 0:s("L",l.point);break;case 2:s("C",l.controlPoint1,l.controlPoint2,l.endPoint);break;case 3:s("Q",l.controlPoint,l.endPoint);break;default:return a=l,a}return i.join("")}static fromString(t){t=t.split(`
`).join(" ");let e=exports.Vec2.zero,o=null,i=null,r=true,s=[],a=g=>{if(r){r=false;return}s.push({kind:1,point:g});},l=g=>{if(r){r=false;return}s.push({kind:0,point:g});},c=(g,b,v)=>{s.push({kind:2,controlPoint1:g,controlPoint2:b,endPoint:v});},d=(g,b)=>{s.push({kind:3,controlPoint:g,endPoint:b});},p={m:1,l:1,c:3,q:2,z:0,h:1,v:1},u=/([achlmqstvz])\s*([^achlmqstvz]*)/gi,h;for(;(h=u.exec(t))!==null;){let b=h[2].trim().split(/[^\d.Ee-]/).filter(C=>C.length>0).reduce((C,k)=>{k=k.replace(/([^Ee])-/g,"$1 -");let B=k.split(" -");return B[0]!==""&&C.push(B[0]),C.push(...B.slice(1).map(W=>`-${W}`)),C},[]).map(C=>Number.parseFloat(C)),v=h[1].toLowerCase(),f=h[1]!==v;if(v==="v"||v==="h")b=b.reduce((C,k)=>v==="v"?C.concat(f?e.x:0,k):C.concat(k,f?e.y:0),[]),v="l";else if(v==="z"){if(o)b=[o.x,o.y],o=e;else continue;f=true,v="l";}let x=p[v]??0,S=b.reduce((C,k,B,W)=>{if(B%2!==0){let ne=k,Fe=W[B-1];return C.concat(exports.Vec2.of(Fe,ne))}else return C},[]).map((C,k)=>{let B;return f?B=C:B=e.plus(C),(k+1)%x===0&&(e=B),B});if(S.length%x!==0)throw new Error([`Incorrect number of arguments: got ${JSON.stringify(S)} with a length of ${S.length} \u2260 ${x}k, k \u2208 \u2124.`,`The number of arguments to ${v} must be a multiple of ${x}!`,`Command: ${h[0]}`].join(`
`));for(let C=0;C<S.length;C+=x){let k=S.slice(C,C+x);switch(v.toLowerCase()){case "m":C===0?a(k[0]):l(k[0]);break;case "l":l(k[0]);break;case "c":c(k[0],k[1],k[2]);break;case "q":d(k[0],k[1]);break;default:throw new Error(`Unknown path command ${v}`)}r=false;}S.length>0&&(o??=S[0],i??=o,e=S[S.length-1]);}let m=new n(i??exports.Vec2.zero,s);return m.cachedStringVersion=t,m}static fromConvexHullOf(t){if(t.length===0)return n.empty;let e=rn(t),o=e.slice(1).map(i=>({kind:0,point:i}));return o.push({kind:0,point:e[0]}),new n(e[0],o)}static empty=new n(exports.Vec2.zero,[])};var Li=class n extends Oe{constructor(e,o,i){super();this.vertex1=e;this.vertex2=o;this.vertex3=i;}static fromVertices(e,o,i){return new n(e,o,i)}get vertices(){return [this.vertex1,this.vertex2,this.vertex3]}map(e){return new n(e(this.vertex1),e(this.vertex2),e(this.vertex3))}transformed2DBy(e){return this.map(o=>e.transformVec2(o))}transformedBy(e){return this.map(o=>e.transformVec3(o))}#e=void 0;getEdges(){if(this.#e)return this.#e;let e=new X(this.vertex1,this.vertex2),o=new X(this.vertex2,this.vertex3),i=new X(this.vertex3,this.vertex1),r=[e,o,i];return this.#e=r,r}intersectsLineSegment(e){let o=[];for(let i of this.getEdges())i.intersectsLineSegment(e).forEach(r=>o.push(r));return o}containsPoint(e,o=Oe.smallValue){let i=this.getEdges();for(let r of i){let s=r.direction.orthog(),a=s.dot(this.vertex1),l=s.dot(this.vertex2),c=s.dot(this.vertex3),d=Math.min(a,l,c),p=Math.max(a,l,c),u=s.dot(e);if(!(u>=d-o&&u<=p+o))return  false}return  true}signedDistance(e){let i=this.getEdges().map(s=>s.distance(e)),r=Math.min(...i);return this.containsPoint(e,0)?-r:r}getTightBoundingBox(){return Z.bboxOf(this.vertices)}};var w=class n{constructor(t,e,o,i){this.r=t;this.g=e;this.b=o;this.a=i;}static ofRGB(t,e,o){return n.ofRGBA(t,e,o,1)}static ofRGBA(t,e,o,i){return t=Math.max(0,Math.min(t,1)),e=Math.max(0,Math.min(e,1)),o=Math.max(0,Math.min(o,1)),i=Math.max(0,Math.min(i,1)),new n(t,e,o,i)}static fromRGBArray(t,e=255){let o=t[0],i=t[1]??o,r=t[2]??o,s=255;return 3<t.length&&(s=t[3]),n.ofRGBA(o/e,i/e,r/e,s/e)}static fromHex(t){if(t=(t.match(/^#?(.*)$/)??[])[1],t=t.toUpperCase(),!/^[\dA-F]+$/.test(t))throw new Error(`${t} is not in a valid format.`);(t.length===3||t.length===4)&&(t=t.split("").map(i=>`${i}0`).join("")),t.length===6&&(t+="FF");let e=[];for(let o=2;o<=t.length;o+=2){let i=t.substring(o-2,o);e.push(Number.parseInt(i,16)/255);}if(e.length!==4)throw new Error(`Unable to parse ${t}: Wrong number of components.`);return n.ofRGBA(e[0],e[1],e[2],e[3])}static fromString(t){if(t.startsWith("#"))return n.fromHex(t);if(t==="none"||t==="transparent")return n.transparent;if(t==="")return n.black;let e=/^rgba?\(([\d,.]+)\)$/i,o=t.replace(/\s*/g,"").match(e);if(o){let p=o[1],u=JSON.parse(`[ ${p} ]`);if(u.length===3)return n.ofRGB(u[0]/255,u[1]/255,u[2]/255);if(u.length===4)return n.ofRGBA(u[0]/255,u[1]/255,u[2]/255,u[3]);throw new Error(`RGB string, ${t}, has wrong number of components: ${u.length}`)}let i=document.createElement("canvas");i.width=1,i.height=1;let r=i.getContext("2d");if(!r)return n.black;r.fillStyle=t,r.fillRect(0,0,1,1);let s=r.getImageData(0,0,1,1),a=s.data[0]/255,l=s.data[1]/255,c=s.data[2]/255,d=s.data[3]/255;return n.ofRGBA(a,l,c,d)}eq(t){return t==null?false:this.a===0&&t.a===0?true:this.toHexString()===t.toHexString()}mix(t,e){e=Math.min(Math.max(e,0),1);let o=1-e;return new n(this.r*o+t.r*e,this.g*o+t.g*e,this.b*o+t.b*e,this.a*o+t.a*e)}withAlpha(t){return new n(this.r,this.g,this.b,t)}get rgb(){return exports.Vec3.of(this.r,this.g,this.b)}relativeLuminance(){let t=[this.r,this.g,this.b].map(e=>e<.03928?e/12.92:Math.pow((e+.055)/1.055,2.4));return .2126*t[0]+.7152*t[1]+.0722*t[2]}static contrastRatio(t,e){let o=t.relativeLuminance(),i=e.relativeLuminance();return (Math.max(o,i)+.05)/(Math.min(o,i)+.05)}static average(t){let e=0,o=0,i=0,r=0;for(let s of t)e+=s.a,o+=s.r,i+=s.g,r+=s.b;return t.length>0&&(e/=t.length,o/=t.length,i/=t.length,r/=t.length),new n(o,i,r,e)}asHSV(){let t=Math.min(this.r,this.g,this.b),e=Math.max(this.r,this.g,this.b),o=e-t,i;o===0?i=0:this.r>=this.g&&this.r>=this.b?i=(this.g-this.b)/o%6:this.g>=this.r&&this.g>=this.b?i=(this.b-this.r)/o+2:i=(this.r-this.g)/o+4,i*=60,i*=Math.PI/180,i<0&&(i+=Math.PI*2);let r=e,s=r>0?o/r:0;return exports.Vec3.of(i,s,r)}static fromHSV(t,e,o){t<0&&(t+=Math.PI*2),t%=Math.PI*2,o=Math.max(0,Math.min(1,o)),e=Math.max(0,Math.min(1,e));let i=o*e,r=t/(Math.PI/3),s=i*(1-Math.abs(r%2-1)),a;r<1?a=[i,s,0]:r<2?a=[s,i,0]:r<3?a=[0,i,s]:r<4?a=[0,s,i]:r<5?a=[s,0,i]:a=[i,0,s];let l=o-i;return n.ofRGB(a[0]+l,a[1]+l,a[2]+l)}static fromRGBVector(t,e){return n.ofRGBA(t.x,t.y,t.z,e??1)}hexString=null;toHexString(){if(this.hexString)return this.hexString;let t=s=>{let a=Math.round(255*s).toString(16);return a.length===1?`0${a}`:a},e=t(this.a),o=t(this.r),i=t(this.g),r=t(this.b);return e==="ff"?`#${o}${i}${r}`:(this.hexString=`#${o}${i}${r}${e}`,this.hexString)}toString(){return this.toHexString()}static transparent=n.ofRGBA(0,0,0,0);static red=n.fromHex("#D7273D");static orange=n.fromHex("#F99F07");static green=n.fromHex("#00875A");static blue=n.fromHex("#2576B9");static purple=n.ofRGB(.5,.2,.5);static yellow=n.fromHex("#FFD95C");static clay=n.ofRGB(.8,.4,.2);static black=n.ofRGB(0,0,0);static gray=n.fromHex("#EDEEF1");static white=n.ofRGB(1,1,1);static blackHighlight=n.ofRGBA(0,0,0,.3);static redHighlight=n.ofRGBA(215/255,39/255,61/255,.3);static blueHighlight=n.ofRGBA(37/255,118/255,185/255,.3);static pink=n.fromHex("#EB9CC4");static blueLight=n.fromHex("#D5EDFF");static greenLight=n.fromHex("#E3FCEF")};function Es(n){return (t,e)=>new Bi(n,t,e)}var O=Es,Bi=class{constructor(t,e,o){this.sourceFactory=t;this.startPoint=e;this.viewport=o;this.builder=t(e,o),this.points=[e];}builder;points;getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(t){this.builder.preview(t);}addPoint(t){this.points.push(t),this.builder.addPoint(t);}async autocorrectShape(){let t=r=>({...r,pos:this.viewport.snapToGrid(r.pos)}),e=t(this.startPoint),o=this.sourceFactory(e,this.viewport),i=this.points.map(r=>t(r));for(let r of i)o.addPoint(r);return o.build()}};function Ne(n){return n.path?n.path:new R(n.startPoint,n.commands)}function z(n,t){return {startPoint:n.startPoint,style:t,commands:n.parts,path:n}}function Is(n,t){return n.path?n:{...n,path:t}}function ko(n,t,e={fastCheck:true,expensiveCheck:true}){let o=Ne(n),i=n.style.stroke?.width??0,r=i>0&&n.style.fill.a===0,s=o.bbox.grownBy(i),a=r&&i>t.maxDimension&&s.containsRect(t);if(e.fastCheck&&a&&n.style.stroke){let l=i/2;for(let c of o.startEndPoints())if(t.isWithinRadiusOf(l,c))return {rectangle:t,path:z(R.fromRect(t),{fill:n.style.stroke.color}),fullScreen:true}}if(e.expensiveCheck&&a&&n.style.stroke&&i>t.maxDimension*3){let l=o.signedDistance(t.center,i/2),c=i/6;if(l<-t.maxDimension/2-c)return {path:z(R.fromRect(t),{fill:n.style.stroke.color}),rectangle:t,fullScreen:true};if(l>t.maxDimension/2+c)return {path:z(R.empty,{fill:w.transparent}),rectangle:P.empty,fullScreen:false}}return null}function zi(n,t){let e=Ne(n),o=n.style.stroke?.width??0,i=o>0&&n.style.fill.a===0,r=e.bbox.grownBy(o),s=ko(n,t,{fastCheck:true,expensiveCheck:false});if(s)return s.path;if(t.grownBy(o).transformedBoundingBox(T.scaling2D(4,t.center)).containsRect(r))return Is(n,e);let l=[],c=e.startPoint;for(let u of e.parts){let h=R.computeBBoxForSegment(c,u).grownBy(o),m;u.kind===0||u.kind===1?m=u.point:m=u.endPoint,h.intersects(t)?l.push(u):i||u.kind===1?l.push({kind:1,point:m}):l.push({kind:0,point:m}),c=m;}let d=new R(e.startPoint,l),p=n.style;return s=ko(n,t,{fastCheck:false,expensiveCheck:true}),s?s.path:z(d,p)}var Ai=class n{onDrop(t){}static union(t,e){return new class extends n{apply(o){t.apply(o),e.apply(o);}unapply(o){e.unapply(o),t.unapply(o);}description(o,i){let r=t.description(o,i),s=e.description(o,i);return r===s?r:`${r}, ${s}`}}}static empty=new class extends n{description(t,e){return ""}apply(t){}unapply(t){}}},fe=Ai;function ks(n,t,e,o){let i=t.transformVec3(exports.Vec2.unitX),r=t.transformVec2(n),s=i.magnitude(),a=-(180/Math.PI)*i.angle(),l=r.minus(n),c=[];if(s>1.2?c.push(o.zoomedIn):s<.8&&c.push(o.zoomedOut),Math.floor(Math.abs(a))>0){let p=Math.round(e?-a:a);c.push(o.rotatedBy(p));}let d=1e-4;return l.x>d?c.push(e?o.movedLeft:o.movedRight):l.x<-1e-4&&c.push(e?o.movedRight:o.movedLeft),l.y<-1e-4?c.push(e?o.movedDown:o.movedUp):l.y>d&&c.push(e?o.movedUp:o.movedDown),c.join("; ")}var ot=ks;var Di=class extends fe{},se=class n{constructor(t){this.onTransformChangeCallback=t;this.resetTransform(T.identity),this.screenRect=P.empty;}static ViewportTransform=class extends Di{constructor(e){super();this.transform=e;this.#e=e.inverse();}#e;apply(e){let o=e.viewport;o.resetTransform(o.transform.rightMul(this.transform)),e.queueRerender();}unapply(e){let o=e.viewport;o.resetTransform(o.transform.rightMul(this.#e)),e.queueRerender();}description(e,o){return ot(e.viewport.visibleRect.center,this.transform,true,o)}};transform;inverseTransform;screenRect;getTemporaryClone(){let t=new n(()=>{});return t.transform=this.transform,t.inverseTransform=this.inverseTransform,t.screenRect=this.screenRect,t}updateScreenSize(t){this.screenRect=this.screenRect.resizedTo(t);}get visibleRect(){return this.screenRect.transformedBoundingBox(this.inverseTransform)}screenToCanvas(t){return this.inverseTransform.transformVec2(t)}canvasToScreen(t){return this.transform.transformVec2(t)}static transformBy(t){return new n.ViewportTransform(t)}resetTransform(t=T.identity){let e=this.transform;this.transform=t,this.inverseTransform=t.inverse(),this.onTransformChangeCallback?.(e,t);}get screenToCanvasTransform(){return this.inverseTransform}get canvasToScreenTransform(){return this.transform}getScreenRectSize(){return this.screenRect.size}getResolution(){return this.getScreenRectSize()}getScaleFactor(){return this.transform.transformVec3(exports.Vec3.unitX).magnitude()}getScaleFactorToNearestPowerOfTen(){return this.getScaleFactorToNearestPowerOf(10)}getScaleFactorToNearestPowerOf(t){let e=this.getScaleFactor();return Math.pow(t,Math.round(Math.log(e)/Math.log(t)))}static getGridSize(t){return 50/t}snapToGrid(t){let e=this.getScaleFactorToNearestPowerOf(2),o=r=>{let s=1/n.getGridSize(e);return Math.round(r*s)/s};return exports.Vec2.of(o(t.x),o(t.y))}getSizeOfPixelOnCanvas(){return 1/this.getScaleFactor()}getRotationAngle(){return this.transform.transformVec3(exports.Vec3.unitX).angle()}static roundPoint(t,e){let o=10**Math.floor(Math.log10(e)),i=r=>Math.round(r/o)*o;return typeof t=="number"?i(t):t.map(i)}roundPoint(t){return n.roundPoint(t,1/this.getScaleFactor())}static roundScaleRatio(t,e=1){if(Math.abs(t)<=1e-12)return 0;let o=10**Math.floor(Math.log10(Math.abs(t))),i=2**e;return t=Math.round(t/o*i)/i*o,t}computeZoomToTransform(t,e=true,o=true){let i=T.identity;if(t.w===0||t.h===0){let c=Math.max(t.w,t.h);c===0&&(c=50,e=false,o=false),t=new P(t.x,t.y,c,c);}if(isNaN(t.size.magnitude()))throw new TypeError(`${t.toString()} rectangle has NaN size! Cannot zoom to!`);let r=()=>{let c=this.visibleRect.transformedBoundingBox(i.inverse());return c.transformedBoundingBox(T.scaling2D(4/5,c.center))},s=r(),a=s.w<t.w||s.h<t.h,l=t.maxDimension/s.maxDimension<1/3;if(a&&o||l&&e){let c=Math.max(t.w/s.w,t.h/s.h),p=T.scaling2D(c,s.topLeft).inverse();i=i.rightMul(p);}if(s=r(),!s.containsRect(t)){let c=t.center.minus(s.center),p=T.translation(c).inverse();i=i.rightMul(p);}return i.invertable()||(console.warn("Unable to zoom to ",t,"! Computed transform",i,"is singular."),i=T.identity),i}zoomTo(t,e=true,o=true){let i=this.computeZoomToTransform(t,e,o);return new n.ViewportTransform(i)}},L=se;var V=class n extends fe{#e;constructor(t){if(super(),!(t in n.deserializationCallbacks))throw new Error(`Command ${t} must have a registered deserialization callback. To do this, call SerializableCommand.register.`);this.#e=t;}static deserializationCallbacks={};serialize(){return {data:this.serializeToJSON(),commandType:this.#e}}static deserialize(t,e){let o=typeof t=="string"?JSON.parse(t):t,i=o.commandType;if(!(i in n.deserializationCallbacks))throw new Error(`Unrecognised command type ${i}!`);return n.deserializationCallbacks[i](o.data,e)}static register(t,e){n.deserializationCallbacks[t]=e;}};var Ue=class extends V{component;componentID;constructor(t,e,o){super(t),this.component=o??null,this.componentID=e;}resolveComponent(t){if(this.component)return;let e=t.lookupElement(this.componentID);if(!e)throw new Error(`Unable to resolve component with ID ${this.componentID}`);this.component=e;}};var ge=class{listeners;constructor(){this.listeners={};}dispatch(t,e){let o=this.listeners[t];if(o)for(let i of o)i(e);}on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),{remove:()=>{let o=this.listeners[t];return this.off(t,e),o.length!==this.listeners[t].length}}}off(t,e){let o=this.listeners[t];o&&(this.listeners[t]=o.filter(i=>i!==e));}};function nn(n){throw new Error(`Should be unreachable. Key: ${n}.`)}function Ce(n,t=false){if(typeof n!="number"||!t&&isNaN(n))throw new Error("Given value is not a number")}function Vi(n){if(typeof n!="string")throw new TypeError("Given value is not a string")}function sn(n){if(!Array.isArray(n))throw new TypeError("Asserting isArray: Given entity is not an array")}function ke(n,t=false){sn(n),Ce(n.length);for(let e of n)Ce(e,t);}function Bt(n){sn(n),Ce(n.length);for(let t of n)Vi(t);}function Mi(n){if(typeof n!="boolean")throw new TypeError("Given value is not a boolean")}function an(n){if(!n)throw new Error(`${JSON.stringify(n)} is not truthy`)}function Ro(n){if(typeof n!="object")throw new TypeError(`AssertIsObject: Given entity is not an object (type = ${typeof n})`)}function We(n){n.sort((t,e)=>t.getContent().getZIndex()-e.getContent().getZIndex());}var Lo=false,H=class n{root;background;componentsById;componentCount=0;importExportViewport;shouldAutoresizeExportViewport;notifier;constructor(t,e){this.root=new Bo,this.background=new Bo,this.componentsById=new Map,this.notifier=new ge,this.importExportViewport=new L(()=>{this.onExportViewportChanged();}),this.importExportViewport.updateScreenSize(exports.Vec2.of(t||500,e||500)),this.shouldAutoresizeExportViewport=false;}updateScreenSizeImage(t,e){this.importExportViewport.updateScreenSize(exports.Vec2.of(t||500,e||500));}getBackgroundComponents(){let t=[],e=this.background.getLeaves();We(e);for(let o of e){let i=o.getContent();i&&t.push(i);}return t}findParent(t){return this.background.getChildWithContent(t)??this.root.getChildWithContent(t)}queueRerenderOf(t){let e=this.findParent(t);e&&(e.remove(),this.addComponentDirectly(t));}renderWithCache(t,e,o){this.background.render(t,o.visibleRect),Lo?this.root.render(t,o.visibleRect):e.render(t,this.root,o);}render(t,e){this.background.render(t,e?.visibleRect),this.root.render(t,e?.visibleRect);}async renderAllAsync(t,e){return await this.background.renderAllAsync(t,e)?await this.root.renderAllAsync(t,e):false}renderAll(t){this.render(t,null);}getAllComponents(){let t=this.root.getLeaves();return We(t),t.map(e=>e.getContent())}getAllElements(){return this.getAllComponents()}estimateNumElements(){return this.componentCount}getElementsIntersectingRegion(t,e=false){return this.getComponentsIntersecting(t,e)}getComponentsIntersecting(t,e=false){let o=this.root.getLeavesIntersectingRegion(t);return e&&(o=o.concat(this.background.getLeavesIntersectingRegion(t))),We(o),o.map(i=>i.getContent())}onDestroyElement(t){this.componentCount--;let e=t.getId();this.componentsById.delete(e),this.notifier.dispatch(3,{kind:3,image:this,componentId:e}),this.autoresizeExportViewport();}onElementAdded(t){this.componentCount++;let e=t.getId();this.componentsById.set(t.getId(),t),this.notifier.dispatch(2,{kind:2,image:this,componentId:e}),this.autoresizeExportViewport();}lookupElement(t){return this.componentsById.get(t)??null}addComponentDirectly(t){t.onAddToImage(this);let o=(t.isBackground()?this.background:this.root).addLeaf(t);return this.onElementAdded(t),o}removeElementDirectly(t){let e=this.findParent(t);return e?.remove(),e?(this.onDestroyElement(t),true):false}static addComponent(t,e=false){return new n.AddComponentCommand(t,e)}addComponent(t,e){return n.addComponent(t,e)}addElement(t,e){return this.addComponent(t,e)}static addElement(t,e=false){return this.addComponent(t,e)}static AddComponentCommand=class extends V{constructor(e,o=false){super("add-element");this.element=e;this.applyByFlattening=o;if(this.serializedElem=null,isNaN(e.getBBox().area))throw new TypeError("Elements in the image cannot have NaN bounding boxes")}serializedElem=null;apply(e){e.image.addComponentDirectly(this.element),this.applyByFlattening?(this.applyByFlattening=false,e.display.flatten()):e.queueRerender();}unapply(e){e.image.removeElementDirectly(this.element),e.queueRerender();}description(e,o){return o.addComponentAction(this.element.description(o))}serializeToJSON(){return {elemData:this.serializedElem??this.element.serialize()}}static{V.register("add-element",(e,o)=>{let i=e.elemData.id,s=o.image.lookupElement(i)??N.deserialize(e.elemData),a=new n.AddComponentCommand(s);return a.serializedElem=e.elemData,a});}};getImportExportViewport(){return this.importExportViewport}getImportExportRect(){return this.getImportExportViewport().visibleRect}setImportExportRect(t){return n.SetImportExportRectCommand.of(this,t,false)}getAutoresizeEnabled(){return this.shouldAutoresizeExportViewport}setAutoresizeEnabled(t){if(t===this.shouldAutoresizeExportViewport)return fe.empty;let e=this.root.getBBox();return n.SetImportExportRectCommand.of(this,e,t)}setAutoresizeEnabledDirectly(t){t!==this.shouldAutoresizeExportViewport&&(this.shouldAutoresizeExportViewport=t,this.notifier.dispatch(1,{kind:1,image:this}));}autoresizeExportViewport(){this.shouldAutoresizeExportViewport&&this.setExportRectDirectly(this.root.getBBox());}settingExportRect=false;setExportRectDirectly(t){let e=this.getImportExportViewport(),o=e.getScreenRectSize(),i=e.canvasToScreenTransform,r=T.translation(t.topLeft.times(-1));return !o.eq(t.size)||!i.eq(r)?(this.settingExportRect=true,e.updateScreenSize(t.size),e.resetTransform(r),this.settingExportRect=false,this.onExportViewportChanged(),true):false}onExportViewportChanged(){this.settingExportRect||this.notifier.dispatch(0,{kind:0,image:this});}static setDebugMode(t){Lo=t;}static SetImportExportRectCommand=class extends V{constructor(e,o,i,r,s){super(n.SetImportExportRectCommand.commandId);this.originalSize=e;this.originalTransform=o;this.originalAutoresize=i;this.newExportRect=r;this.newAutoresize=s;}static commandId="set-import-export-rect";static of(e,o,i){let r=e.getImportExportViewport(),s=r.visibleRect.size,a=r.canvasToScreenTransform,l=e.getAutoresizeEnabled();return new n.SetImportExportRectCommand(s,a,l,o,i)}apply(e){e.image.setAutoresizeEnabledDirectly(this.newAutoresize),e.image.setExportRectDirectly(this.newExportRect),e.queueRerender();}unapply(e){let o=e.image.getImportExportViewport();e.image.setAutoresizeEnabledDirectly(this.originalAutoresize),o.updateScreenSize(this.originalSize),o.resetTransform(this.originalTransform),e.queueRerender();}description(e,o){return this.newAutoresize!==this.originalAutoresize?this.newAutoresize?o.enabledAutoresizeOutputCommand:o.disabledAutoresizeOutputCommand:o.resizeOutputCommand(this.newExportRect)}serializeToJSON(){return {originalSize:this.originalSize.xy,originalTransform:this.originalTransform.toArray(),newRegion:{x:this.newExportRect.x,y:this.newExportRect.y,w:this.newExportRect.w,h:this.newExportRect.h},autoresize:this.newAutoresize,originalAutoresize:this.originalAutoresize}}static{let e=this.commandId;V.register(e,(o,i)=>{Ce(o.originalSize.x),Ce(o.originalSize.y),ke(o.originalTransform),ke([o.newRegion.x,o.newRegion.y,o.newRegion.w,o.newRegion.h]),Mi(o.autoresize??false),Mi(o.originalAutoresize??false);let r=exports.Vec2.ofXY(o.originalSize),s=new T(...o.originalTransform),a=new P(o.newRegion.x,o.newRegion.y,o.newRegion.w,o.newRegion.h),l=o.autoresize??false,c=o.originalAutoresize??false;return new n.SetImportExportRectCommand(r,s,c,a,l)});}}};function Fi(n,t){let e=0;if(t){for(let o=n.length-1;o>=1;o--)if(n[o].getBBox().containsRect(t)&&n[o].getContent()?.occludesEverythingBelowWhenRenderedInRect(t)){e=o;break}}return e}var zt=class n{constructor(t=null){this.parent=t;this.children=[],this.bbox=P.empty,this.content=null,this.id=n.idCounter++;}content;bbox;children;targetChildCount=30;id;static idCounter=0;getId(){return this.id}onContentChange(){this.id=n.idCounter++;}getContent(){return this.content}getParent(){return this.parent}getChildrenIntersectingRegion(t,e){return this.children.filter(o=>{let i=o.getBBox();return !e?.(i)&&i.intersects(t)})}getChildrenOrSelfIntersectingRegion(t,e){return this.content&&this.bbox.intersects(t)&&!e?.(this.bbox)?[this]:this.getChildrenIntersectingRegion(t,e)}getLeavesIntersectingRegion(t,e){let o=[],i=[];for(i.push(this);i.length>0;){let s=i.pop().getChildrenOrSelfIntersectingRegion(t,e);for(let a of s)a.content?o.push(a):i.push(a);}return o}getChildWithContent(t){let e=this.getLeavesIntersectingRegion(t.getBBox());for(let o of e)if(o.getContent()===t)return o;return null}getLeaves(){if(this.content)return [this];let t=[];for(let e of this.children)t.push(...e.getLeaves());return t}addLeaf(t){if(this.onContentChange(),this.content===null&&this.children.length===0)return this.content=t,this.recomputeBBox(true),this;if(this.content!==null){console.assert(this.children.length===0);let r=new n(this);r.content=this.content,this.content=null,this.children.push(r),r.recomputeBBox(false);}let e=t.getBBox();if(e.containsRect(this.getBBox())){let r=new n(this);if(this.children.length<this.targetChildCount)this.children.push(r);else {let s=new n(this);s.children=this.children,this.children=[r,s],s.updateParents(),s.recomputeBBox(true);}return r.addLeaf(t)}let o=this.children.filter(r=>r.getBBox().containsRect(e));if(o.length>0&&this.children.length>=this.targetChildCount){o.sort((s,a)=>s.getBBox().area-a.getBBox().area);let r=o[0].addLeaf(t);return r.rebalance(),r}let i=n.createLeafNode(this,t);return this.children.push(i),i.recomputeBBox(true),this.children.length>=this.targetChildCount&&this.rebalance(),i}static createLeafNode(t,e){let o=new n(t);return o.content=e,o}getBBox(){return this.bbox}recomputeBBox(t){let e=this.bbox;this.content!==null?this.bbox=this.content.getBBox():this.bbox=P.union(...this.children.map(o=>o.getBBox())),t&&!e.eq(this.bbox)&&(this.bbox.containsRect(e)?this.parent?.unionBBoxWith(this.bbox):this.parent?.recomputeBBox(true)),this.checkRep();}unionBBoxWith(t){this.bbox=this.bbox.union(t),this.parent?.unionBBoxWith(t);}updateParents(t=false){for(let e of this.children)e.parent=this,t&&e.updateParents(t);}rebalance(){if(this.parent&&this.parent.children.length===1){console.assert(this.parent.content===null),console.assert(this.parent.children[0]===this);let t=this.parent;if(t.parent!==null){let e=t.parent;e.children=e.children.filter(o=>o!==t),t.parent=null,t.children=[],this.parent=e,e.children.push(this),this.parent.recomputeBBox(false);}else this.content===null&&(this.parent.children=this.children,this.parent.updateParents(),this.parent=null);}if(this.children.length>this.targetChildCount*10){let t=this.getBBox().divideIntoGrid(4,4),e=[];for(;e.length<t.length;)e.push(0);for(let s of this.children)for(let[a,l]of t.entries())l.containsRect(s.getBBox())&&e[a]++;let o=0,i=e[0];for(let s=1;s<e.length;s++)e[s]>i&&(o=s,i=e[s]);let r=t[o];if(i>4){let s=[],a=[];for(let l of this.children)r.containsRect(l.getBBox())?a.push(l):s.push(l);if(a.length<this.children.length){this.children=s;let l=new n(this);this.children.push(l),l.children=a,l.updateParents(false),l.recomputeBBox(false),l.rebalance();}}}this.parent&&this.children.length===0&&this.content===null&&this.remove();}removeChild(t){this.checkRep();let e=this.children.length;this.children=this.children.filter(o=>o!==t),console.assert(this.children.length===e-1,`${e-1} \u2260 ${this.children.length} after removing all nodes equal to ${t}. Nodes should only be removed once.`),this.children.forEach(o=>{o.rebalance();}),this.recomputeBBox(true),this.rebalance(),this.checkRep();}remove(){if(this.content?.onRemoveFromImage(),!this.parent){this.content=null,this.children=[];return}this.parent.removeChild(this),this.parent=null,this.content=null,this.children=[],this.checkRep();}async renderAllAsync(t,e){let o=this.getLeaves();We(o);let i=o.length;for(let r=0;r<i;r++){let a=o[r].getContent();if(!a)continue;if(!await e(a,r,i))return  false;a.render(t,void 0);}return  true}render(t,e){let o;e?o=this.getLeavesIntersectingRegion(e,r=>t.isTooSmallToRender(r)):o=this.getLeaves(),We(o);let i=Fi(o);for(let r=i;r<o.length;r++)o[r].getContent().render(t,e);Lo&&e&&(i!==0&&console.log("EditorImage: skipped ",i,"nodes due to occlusion"),this.renderDebugBoundingBoxes(t,e));}renderDebugBoundingBoxes(t,e,o=0){let i=this.getBBox(),r=1/(t.getSizeOfCanvasPixelOnScreen()||1);if(i.maxDimension<3*r||!i.intersects(e))return;t.startObject(i);let s=!!this.content,a=s?w.ofRGBA(1,0,1,.4):w.ofRGBA(0,1,Math.sin(o),.6),l=s?1*r:2*r;if(t.drawRect(i.intersection(e),l,{fill:a}),t.endObject(),i.maxDimension>e.maxDimension/3){let c={fontFamily:"monospace",size:i.minDimension/20,renderingStyle:{fill:w.red}};t.drawText(`Depth: ${o}`,T.translation(i.bottomLeft),c);}for(let c of this.children)c.renderDebugBoundingBoxes(t,e,o+1);}checkRep(t=0){if(Lo){if(this.parent&&!this.parent.children.includes(this))throw new Error(`Parent does not have this node as a child. (depth: ${t})`);let e=null,o=new Set;for(let r of this.children){if(e??=r.getBBox(),e=e.union(r.getBBox()),r.parent!==this)throw new Error(`Child with bbox ${r.getBBox()} and ${r.children.length} has wrong parent (was ${r.parent}).`);if(o.has(r))throw new Error(`Child ${r} is present twice or more in its parent's child list`);o.add(r);}let i=this.bbox.minDimension/100;if(e&&!this.bbox.eq(e,i))throw new Error(`Wrong bounding box ${e} \\neq ${this.bbox} (depth: ${t})`)}}},Bo=class extends zt{fullscreenChildren=[];dataComponents=[];getChildrenIntersectingRegion(t,e){let o=super.getChildrenIntersectingRegion(t);for(let i of this.fullscreenChildren)o.push(i);return o}getChildrenOrSelfIntersectingRegion(t,e){let o=this.getContent();return o&&o.getSizingMode()===1?[this]:super.getChildrenOrSelfIntersectingRegion(t,e)}getLeaves(){let t=super.getLeaves();return this.dataComponents.concat(this.fullscreenChildren,t)}removeChild(t){let e=false,o=i=>{let r=i===t;return e||=r,!r};this.dataComponents=this.dataComponents.filter(o),this.fullscreenChildren=this.fullscreenChildren.filter(o),e||super.removeChild(t);}getChildWithContent(t){let e=()=>{let o=this.fullscreenChildren.concat(this.dataComponents);for(let i of o)if(i.getContent()===t)return i;return null};return t.getSizingMode()===0?super.getChildWithContent(t)??e():super.getChildWithContent(t)??e()}addLeaf(t){let e=t.getSizingMode();if(e===0)return super.addLeaf(t);if(e===1){this.onContentChange();let o=zt.createLeafNode(this,t);return this.fullscreenChildren.push(o),o}else if(e===2){this.onContentChange();let o=zt.createLeafNode(this,t);return this.dataComponents.push(o),o}else {throw new Error(`Invalid sizing mode, ${e}`)}}};var At=(o=>(o[o.BoundingBox=0]="BoundingBox",o[o.FillScreen=1]="FillScreen",o[o.Anywhere=2]="Anywhere",o))(At||{}),N=class n{constructor(t,e){this.componentKind=t;if(this.lastChangedTime=new Date().getTime(),e!==void 0?this.zIndex=e:this.zIndex=n.zIndexCounter++,this.id=`${new Date().getTime()}-${Math.random()}`,n.deserializationCallbacks[t]===void 0)throw new Error(`Component ${t} has not been registered using AbstractComponent.registerComponent`)}lastChangedTime;zIndex;id;static zIndexCounter=0;getId(){return this.id}static deserializationCallbacks={};static registerComponent(t,e){this.deserializationCallbacks[t]=e??null;}loadSaveData={};attachLoadSaveData(t,e){this.loadSaveData[t]||(this.loadSaveData[t]=[]),this.loadSaveData[t].push(e);}getLoadSaveData(){return this.loadSaveData}getZIndex(){return this.zIndex}getBBox(){return this.contentBBox}getExactBBox(){return this.getBBox()}getSizingMode(){return 0}occludesEverythingBelowWhenRenderedInRect(t){return  false}onAddToImage(t){}onRemoveFromImage(){}intersectsRect(t){return t.containsRect(this.getExactBBox())?true:t.getEdges().some(o=>this.intersects(o))}keyPoints(){return [this.getBBox().center]}isSelectable(){return  true}isBackground(){return  false}getProportionalRenderingTime(){return 1}transformBy(t){return new n.TransformElementCommand(t,this.getId(),this)}setZIndex(t){return new n.TransformElementCommand(T.identity,this.getId(),this,t)}setZIndexAndTransformBy(t,e,o){return new n.TransformElementCommand(t,this.getId(),this,e,o)}static transformElementCommandId="transform-element";static TransformElementCommand=class extends Ue{constructor(e,o,i,r,s){super(n.transformElementCommandId,o,i);this.affineTransfm=e;this.origZIndex=s;this.targetZIndex=r??n.zIndexCounter++,this.targetZIndex>=n.zIndexCounter&&(n.zIndexCounter=this.targetZIndex+1),i&&s===void 0&&(this.origZIndex=i.getZIndex());}targetZIndex;resolveComponent(e){this.component||(super.resolveComponent(e),this.origZIndex??=this.component.getZIndex());}updateTransform(e,o,i){if(!this.component)throw new Error("this.component is undefined or null!");let r=e.image.findParent(this.component),s=false;r&&(r.remove(),s=true),this.component.applyTransformation(o),this.component.zIndex=i,this.component.lastChangedTime=new Date().getTime(),i>=n.zIndexCounter&&(n.zIndexCounter=i+1),s&&H.addComponent(this.component).apply(e);}apply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm,this.targetZIndex),e.queueRerender();}unapply(e){this.resolveComponent(e.image),this.updateTransform(e,this.affineTransfm.inverse(),this.origZIndex),e.queueRerender();}description(e,o){return o.transformedElements(1,ot(exports.Vec2.zero,this.affineTransfm,false,o))}static{V.register(n.transformElementCommandId,(e,o)=>{let i=o.image.lookupElement(e.id)??void 0,r=new T(...e.transfm),s=e.targetZIndex,a=e.origZIndex??void 0;return new n.TransformElementCommand(r,e.id,i,s,a)});}serializeToJSON(){return {id:this.componentID,transfm:this.affineTransfm.toArray(),targetZIndex:this.targetZIndex,origZIndex:this.origZIndex}}};clone(){let t=this.createClone();for(let e in this.loadSaveData)for(let o of this.loadSaveData[e])t.attachLoadSaveData(e,o);return t}cloneWithId(t){let e=this.clone();return e.id=t,e}serialize(){let t=this.serializeToJSON();if(t===null)throw new Error(`${this} cannot be serialized.`);return {name:this.componentKind,zIndex:this.zIndex,id:this.id,loadSaveData:this.loadSaveData,data:t}}static isNotDeserializable(t){return typeof t=="string"&&(t=JSON.parse(t)),typeof t!="object"||!this.deserializationCallbacks[t?.name]||!t.data}static deserialize(t){if(typeof t=="string"&&(t=JSON.parse(t)),n.isNotDeserializable(t))throw new Error(`Element with data ${t} cannot be deserialized.`);Vi(t.id);let e=this.deserializationCallbacks[t.name](t.data);return e.id=t.id,isFinite(t.zIndex)&&(e.zIndex=t.zIndex,n.zIndexCounter=Math.max(n.zIndexCounter,e.zIndex+1)),e}};function ln(n){return {fill:n.fill,stroke:n.stroke?{...n.stroke}:void 0}}function zo(n,t){return (n===t||n.fill.eq(t.fill)&&n.stroke==null==(t.stroke==null)&&(n.stroke?.color?.eq(t.stroke?.color)??true)&&n.stroke?.width===t.stroke?.width)??false}function Ao(n){let t=n.stroke?{color:n.stroke.color.toHexString(),width:n.stroke.width}:void 0;return {fill:n.fill.toHexString(),stroke:t}}function Do(n){let t=n.stroke?{color:w.fromHex(n.stroke.color),width:n.stroke.width}:void 0;return {fill:w.fromHex(n.fill),stroke:t}}function Oi(n){return {...n,renderingStyle:ln(n.renderingStyle)}}function Vo(n){if(typeof n=="string"&&(n=JSON.parse(n)),typeof n.fontFamily!="string")throw new TypeError("Serialized textStyle missing string fontFamily attribute!");return {renderingStyle:Do(n.renderingStyle),size:n.size,fontWeight:n.fontWeight,fontVariant:n.fontVariant,fontFamily:n.fontFamily}}function Mo(n){return {...n,renderingStyle:Ao(n.renderingStyle)}}function cn(n){let t={};return n.color&&(t.color=n.color.toHexString()),n.textStyle&&(t.textStyle=Mo(n.textStyle)),t}function dn(n){let t=n.color?w.fromHex(n.color):void 0,e=n.textStyle?Vo(n.textStyle):void 0;return {color:t,textStyle:e}}function $e(n,t,e){return new Hi(n,t,e.getId(),e)}function Fo(n){return !(!("getStyle"in n&&"updateStyle"in n&&"forceStyle"in n)||!("isRestylableComponent"in n)||!n.isRestylableComponent)}var pn="default-restyle-element",Hi=class n extends Ue{constructor(e,o,i,r){super(pn,i,r);this.originalStyle=e;this.newStyle=o;}getComponent(e){this.resolveComponent(e.image);let o=this.component;if(!o||!o.forceStyle||!o.updateStyle)throw new Error("this.component is missing forceStyle and/or updateStyle methods!");return o}apply(e){this.getComponent(e).forceStyle(this.newStyle,e);}unapply(e){this.getComponent(e).forceStyle(this.originalStyle,e);}description(e,o){return o.restyledElement(this.getComponent(e).description(o))}serializeToJSON(){return {id:this.componentID,originalStyle:cn(this.originalStyle),newStyle:cn(this.newStyle)}}static{V.register(pn,(e,o)=>{let i=dn(e.originalStyle),r=dn(e.newStyle),s=e.id;if(typeof e.id!="string")throw new TypeError(`json.id is of type ${typeof e.id}, not string.`);return new n(i,r,s)});}};var D=class n extends N{parts;contentBBox;isRestylableComponent=true;approximateRenderingTime;constructor(t,e){super("stroke",e),this.approximateRenderingTime=0,this.parts=[];for(let o of t){let i=Ne(o),r=this.bboxForPart(i.bbox,o.style);this.contentBBox?this.contentBBox=this.contentBBox.union(r):this.contentBBox=r,this.parts.push({path:i,startPoint:i.startPoint,style:o.style,commands:i.parts}),this.approximateRenderingTime+=i.parts.length;}this.contentBBox??=P.empty;}static fromStroked(t,e){return typeof t=="string"&&(t=R.fromString(t)),new n([z(t,{fill:w.transparent,stroke:e})])}static fromFilled(t,e){return typeof t=="string"&&(t=R.fromString(t)),new n([z(t,{fill:e})])}getStyle(){if(this.parts.length===0)return {};let t=this.parts[0];return t.style.stroke===void 0||t.style.stroke.width===0?{color:t.style.fill}:{color:t.style.stroke.color}}updateStyle(t){return $e(this.getStyle(),t,this)}forceStyle(t,e){t.color&&(this.parts=this.parts.map(o=>{let i={...o.style,stroke:o.style.stroke?{...o.style.stroke}:void 0};return i.stroke&&i.stroke.width>0?i.stroke.color=t.color:i.fill=t.color,{path:o.path,startPoint:o.startPoint,commands:o.commands,style:i}}),e&&(e.image.queueRerenderOf(this),e.queueRerender()));}withRegionErased(t,e){let o=t.polylineApproximation(),i=a=>t.closedContainsPoint(a),r=[],s=false;for(let a of this.parts){let l=a.path,c=g=>{if(a.style.fill.a>0){if(g.parts.length===0||g.parts.length===1&&g.parts[0].kind===0)return null;g=g.asClosed();}return isNaN(g.getExactBBox().area)?(console.warn("Prevented creating a stroke with NaN area"),s=true,null):new n([z(g,a.style)],this.getZIndex())},d=[];for(let g of o)d.push(...l.intersection(g));let p=false;if(d.length===0&&a.style.stroke&&a.style.stroke.width>t.bbox.minDimension*.3&&a.style.stroke.width<t.bbox.maxDimension*30){for(let g of o)d.push(...l.intersection(g,a.style.stroke.width/2));p=true;}d.sort(Io);let h=(()=>{if(d.length===0)return  false;if(p)return d[0].curveIndex===0&&d[0].parameterValue<=0;let g=Ri(d[0],-1e-10);return i(l.at(g))})()?1:0,m=(g,b)=>{let v=c(g),f=h%2===1;h++,b!==void 0&&(f=b),b===void 0&&!f&&t.closedContainsPoint(g.getExactBBox().center)&&(f=!f),v&&(s||=f&&g.getExactBBox().maxDimension>t.getExactBBox().maxDimension*2,f||r.push(v));};if(a.style.fill.a===0){if(!(t.getExactBBox().maxDimension/10>l.getExactBBox().maxDimension)){let b=l.splitAt(d,{mapNewPoint:v=>e.roundPoint(v)});for(let v of b)m(v);}}else if(d.length>=2&&d.length%2===0){let g=l.splitAt(d,{mapNewPoint:b=>e.roundPoint(b)});for(let b=0;b<Math.floor(g.length/2);b++)m(g[b].union(g[g.length-b-1]).asClosed());g.length%2!==0&&m(g[Math.floor(g.length/2)].asClosed());}else m(l,false);}return s?[this]:r}intersects(t){for(let e of this.parts){let o=e.style.stroke?.width,i=o?o/2:void 0;if(e.path.intersection(t,i).length>0)return  true}return  false}keyPoints(){return this.parts.flatMap(t=>t.startPoint)}intersectsRect(t){if(!t.intersects(this.getBBox()))return  false;for(let e of this.parts){let o=t.grownBy(-(e.style.stroke?.width??0));if(o.area!==0){for(let i of e.path.startEndPoints())if(o.containsPoint(i))return  true}}return super.intersectsRect(t)}simplifiedPath=null;computeSimplifiedPathFor(t){let e=[],o=false,i=false;for(let r of this.parts){if(i||!r.style.stroke||r.style.stroke.color.a<.99){e.push(r);continue}let s=ko(r,t);s?(e.push(s.path),s.fullScreen&&(o=true,i=true)):e.push(r);}return {forVisibleRect:t,parts:e,occludes:o}}occludesEverythingBelowWhenRenderedInRect(t){return this.getBBox().containsRect(t)?((!this.simplifiedPath||!this.simplifiedPath.forVisibleRect.eq(t))&&(this.simplifiedPath=this.computeSimplifiedPathFor(t)),this.simplifiedPath.occludes):false}render(t,e){t.startObject(this.getBBox());let o=this.parts;e&&this.simplifiedPath?.forVisibleRect?.containsRect(e)?o=this.simplifiedPath.parts:this.simplifiedPath=null;for(let i of o){let r=this.bboxForPart(i.path.bbox,i.style);e&&(!r.intersects(e)||(r.size.x>e.size.x*3||r.size.y>e.size.y*3)&&!i.path.roughlyIntersects(e,i.style.stroke?.width??0))||t.drawPath(i);}t.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return this.approximateRenderingTime}bboxForPart(t,e){return e.stroke?t.grownBy(e.stroke.width/2):t}getExactBBox(){let t=null;for(let{path:e,style:o}of this.parts){let i=this.bboxForPart(e.getExactBBox(),o);t??=i,t=t.union(i);}return t??P.empty}applyTransformation(t){this.contentBBox=P.empty;let e=true;this.parts=this.parts.map(o=>{let i=o.path.transformedBy(t),r={...o.style,stroke:o.style.stroke?{...o.style.stroke}:void 0};if(r.stroke){let a=t.getScaleFactor();r.stroke.width*=a;}let s=this.bboxForPart(i.bbox,r);return e?(this.contentBBox=s,e=false):this.contentBBox=this.contentBBox.union(s),{path:i,startPoint:i.startPoint,commands:i.parts,style:r}});}getParts(){return [...this.parts]}getPath(){let t=null;for(let e of this.parts)t?t=t.union(e.path):t??=e.path;return t??R.empty}description(t){return t.stroke}createClone(){return new n(this.parts)}serializeToJSON(){return this.parts.map(t=>({style:Ao(t.style),path:t.path.serialize()}))}static deserializeFromJSON(t){if(typeof t=="string"&&(t=JSON.parse(t)),typeof t!="object"||typeof t.length!="number")throw new TypeError(`${t} is missing required field, parts, or parts is of the wrong type.`);let e=t.map(o=>{let i=Do(o.style);return z(R.fromString(o.path),i)});return new n(e)}};N.registerComponent("stroke",D.deserializeFromJSON);var Dt=O((n,t)=>new Ni(n,t)),Ni=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=[],o=Math.PI*2/6,i=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=this.startPoint.pos.lerp(this.endPoint.pos,.5),a=this.endPoint.pos.minus(r).length()-i/2,l=r.plus(exports.Vec2.of(a,0));for(let p=o;p<=Math.PI*2;p+=o){let u=exports.Vec2.of(a*Math.cos(p),-a*Math.sin(p)).plus(r),m=exports.Vec2.of(Math.cos(p-o/2),-Math.sin(p-o/2)).times(a*1.141).plus(r);t.push({kind:3,controlPoint:m,endPoint:u});}t.push({kind:0,point:l});let c=new R(l,t).mapPoints(p=>this.viewport.roundPoint(p));return new D([z(c,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var un=O((n,t)=>new Ui(n,t)),Ui=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=[],e=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),o=this.startPoint.pos,r=this.startPoint.pos.distanceTo(this.endPoint.pos)/200,s=(p,u)=>o.plus(exports.Vec2.of((p-250)*r,(u-100)*r)),a=s(170,80);t.push({kind:1,point:a});let l=[[130,100,130,150,230,150],[250,180,320,180,340,150],[420,150,420,120,390,100],[430,40,370,30,340,50],[320,5,250,20,250,50],[200,5,150,20,170,80]];for(let[p,u,h,m,g,b]of l)t.push({kind:2,controlPoint1:s(p,u),controlPoint2:s(h,m),endPoint:s(g,b)});t.push({kind:0,point:a});let c=new R(a,t).mapPoints(p=>this.viewport.roundPoint(p));return new D([z(c,{fill:this.endPoint.color,stroke:{width:e,color:e===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var hn=O((n,t)=>new Vt(n,true,t)),Vt=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=t.plus(e.minus(t).times(.5)),r={x:(e.x-t.x)*.5},s={y:(e.y-t.y)*.5},a=i.plus(exports.Vec3.of(-r.x,0,0)),l=i.plus(exports.Vec3.of(r.x,0,0)),c=i.plus(exports.Vec3.of(0,-s.y,0)),d=i.plus(exports.Vec3.of(0,s.y,0)),p=new R(a,[{kind:0,point:c},{kind:0,point:l},{kind:0,point:d},{kind:0,point:a}]).mapPoints(h=>this.viewport.roundPoint(h));return new D([z(p,{fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var mn=O((n,t)=>new Wi(n,t)),Wi=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=[],o=Math.PI*2/150,i=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=this.startPoint.pos.lerp(this.endPoint.pos,.5),a=this.endPoint.pos.minus(r).length(),c=[];for(let h=0;h<=150;h++){let m=h*o,g=16*Math.pow(Math.sin(m),3),b=13*Math.cos(m)-5*Math.cos(2*m)-2*Math.cos(3*m)-Math.cos(4*m),v=a/16,f=exports.Vec2.of(g*v,-b*v*.9).plus(r);c.push(f);}let d=c[0];for(let h=1;h<c.length;h+=2){let m=(h+1)%c.length,g=c[m],b=c[h];t.push({kind:3,controlPoint:b,endPoint:g});}t.push({kind:0,point:d});let p=new R(d,t).mapPoints(h=>this.viewport.roundPoint(h));return new D([z(p,{fill:this.endPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var fn=O((n,t)=>new Mt(n,true,t)),Mt=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=t.plus(e.minus(t).times(.5)),r=Math.abs(e.x-t.x)/2,s=Math.abs(e.y-t.y)/2,a=Math.min(r,s),l=[];for(let p=0;p<6;p++){let u=Math.PI/3*p,h=i.x+a*Math.cos(u),m=i.y+a*Math.sin(u);l.push(exports.Vec3.of(h,m,0));}let c=new R(l[0],[...l.slice(1).map(p=>({kind:0,point:p})),{kind:0,point:l[0]}]).mapPoints(p=>this.viewport.roundPoint(p));return new D([z(c,{fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var gn=O((n,t)=>new Oo(n,true,t)),Oo=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=e.x-t.x,r=e.y-t.y,s=Math.max(Math.abs(i),Math.abs(r)),a=Math.sign(i)||1,l=Math.sign(r)||1,c={x:t.x+s*a,y:t.y},d={x:c.x+s*a/2,y:c.y+s*l},p={x:t.x+s*a/2,y:t.y+s*l},u=new R(t,[{kind:0,point:exports.Vec3.of(c.x,c.y,0)},{kind:0,point:exports.Vec3.of(d.x,d.y,0)},{kind:0,point:exports.Vec3.of(p.x,p.y,0)},{kind:0,point:t}]).mapPoints(g=>this.viewport.roundPoint(g)),h={fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}};return new D([z(u,h)])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var bn=O((n,t)=>new Ft(n,true,t)),Ft=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=e.x-t.x,r=e.y-t.y,s=Math.max(Math.abs(i),Math.abs(r)),a=Math.sign(i)||1,l=Math.sign(r)||1,c=t.x+s*a,d=t.y+s*l,p=new R(t,[{kind:0,point:exports.Vec3.of(c,t.y,0)},{kind:0,point:exports.Vec3.of(c,d,0)},{kind:0,point:exports.Vec3.of(t.x,d,0)},{kind:0,point:t}]).mapPoints(m=>this.viewport.roundPoint(m)),u={fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}};return new D([z(p,u)])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var yn=O((n,t)=>new $i(n,t)),$i=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),e=this.startPoint.pos.lerp(this.endPoint.pos,.5),o=e.distanceTo(this.endPoint.pos),i=5,s=o*.4,a=[],l=Math.PI*2/(i*2);for(let u=0;u<i*2;u++){let h=-Math.PI/2+u*l,m=u%2===0?o:s,g=exports.Vec2.of(e.x+m*Math.cos(h),e.y+m*Math.sin(h));a.push(g);}let c=[];for(let u=1;u<a.length;u++)c.push({kind:0,point:a[u]});c.push({kind:0,point:a[0]});let d=new R(a[0],c).mapPoints(u=>this.viewport.roundPoint(u));return new D([z(d,{fill:this.endPoint.color,stroke:{width:t,color:t===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var vn=O((n,t)=>new Ot(n,true,t)),Ot=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=e.minus(t),r=i.orthog().normalized(),s=i.magnitude()*.866,a=t.plus(i.times(.5)).plus(r.times(s)),l=new R(t,[{kind:0,point:e},{kind:0,point:a},{kind:0,point:t}]).mapPoints(d=>this.viewport.roundPoint(d));return new D([z(l,{fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}getLineWidth(){return Math.max(this.startPoint.width,this.endPoint.width)}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var Rs=(m=>(m[m.ToolEnabled=0]="ToolEnabled",m[m.ToolDisabled=1]="ToolDisabled",m[m.ToolUpdated=2]="ToolUpdated",m[m.UndoRedoStackUpdated=3]="UndoRedoStackUpdated",m[m.CommandDone=4]="CommandDone",m[m.CommandUndone=5]="CommandUndone",m[m.ObjectAdded=6]="ObjectAdded",m[m.ViewportChanged=7]="ViewportChanged",m[m.DisplayResized=8]="DisplayResized",m[m.SelectionUpdated=9]="SelectionUpdated",m[m.ReadOnlyModeToggled=10]="ReadOnlyModeToggled",m[m.ColorPickerToggled=11]="ColorPickerToggled",m[m.ColorPickerColorSelected=12]="ColorPickerColorSelected",m[m.ToolbarDropdownShown=13]="ToolbarDropdownShown",m))(Rs||{}),Ls=(o=>(o[o.CommandDone=0]="CommandDone",o[o.CommandUndone=1]="CommandUndone",o[o.CommandRedone=2]="CommandRedone",o))(Ls||{});var xn={remove(){}};function Bs(){return xn}var F=class n{waitForNextUpdate(){return new Promise(t=>{let e=this.onUpdate(o=>{e.remove(),t(o);});})}static fromInitialValue(t){return new Ho(t)}static fromImmutable(t){return {get:()=>t,onUpdate:Bs,onUpdateAndNow:e=>(e(t),xn),waitForNextUpdate:()=>new Promise(()=>{})}}static fromCallback(t,e){let o=new Ho(t()),i=typeof WeakRef<"u"?new WeakRef(o):{deref:()=>o};for(let r of e){let s=r.onUpdate(()=>{let a=i.deref();a?a.set(t()):s.remove();});}return o}static map(t,e,o){let i=n.fromInitialValue(e(t.get())),r=i.get();return t.onUpdate(s=>{r=e(s),i.set(r);}),o&&i.onUpdate(s=>{s!==r&&t.set(o(s));}),i}static union(t){return n.fromCallback(()=>t.map(e=>e.get()),t)}},K=class extends F{static fromProperty(t,e){let o=F.fromInitialValue(t.get()[e]),i=typeof WeakRef<"u"?new WeakRef(o):{deref:()=>o},r=t.onUpdate(s=>{let a=i.deref();a?a.set(s[e]):r.remove();});return o.onUpdate(s=>{t.set({...t.get(),[e]:s});}),o}},Ho=class extends K{#e;#t;constructor(t){super(),this.#e=t,this.#t=[];}set(t){if(this.#e!==t){this.#e=t;for(let e of this.#t)e(t);}}get(){return this.#e}onUpdate(t){return this.#t.push(t),{remove:()=>{this.#t=this.#t.filter(e=>e!==t);}}}onUpdateAndNow(t){return t(this.get()),this.onUpdate(t)}},No=F;var E="toolbar-";var Ki=class{constructor(t,e,o){this.parent=t;this.notifier=e;this.onDestroy=o;this.visible=F.fromInitialValue(false),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add(`${E}dropdown`),this.dropdownContainer.classList.add("hidden"),t.target.insertAdjacentElement("afterend",this.dropdownContainer),this.dropdownToggleListener=this.notifier.on(0,i=>{i.dropdown!==this&&i.fromToplevelDropdown&&this.setVisible(false);});}dropdownContainer;visible;dropdownToggleListener=null;onActivated(){}repositionDropdown(){let t=this.dropdownContainer.getBoundingClientRect(),e=document.scrollingElement?.clientWidth??document.body.clientHeight,o=document.scrollingElement?.clientHeight??document.body.clientHeight,i,r;t.left>e/2&&(i=`calc(${this.parent.target.clientWidth+"px"} - 100%)`),t.bottom>o&&t.top-t.height>0&&(r=`calc(-${this.parent.target.clientHeight}px - 100%)`),i||r?this.dropdownContainer.style.translate=`${i??"0"} ${r??"0"}`:this.dropdownContainer.style.translate="";}hideDropdownTimeout=null;setVisible(t){if(this.visible.get()===t)return;this.hideDropdownTimeout&&(clearTimeout(this.hideDropdownTimeout),this.hideDropdownTimeout=null,this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown());let o=150;if(this.visible.set(t),t)this.dropdownContainer.classList.remove("hidden"),this.notifier.dispatch(0,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.repositionDropdown();else {this.notifier.dispatch(1,{dropdown:this,fromToplevelDropdown:this.parent.isToplevel()}),this.dropdownContainer.classList.add("hiding");let r=o*.95;this.hideDropdownTimeout=setTimeout(()=>{this.dropdownContainer.classList.add("hidden"),this.dropdownContainer.classList.remove("hiding"),this.repositionDropdown();},r);}let i=`var(--dropdown-${t?"show":"hide"}-animation)`;this.dropdownContainer.style.animation=`${o}ms ease ${i}`;}requestShow(){this.setVisible(true);}requestHide(){this.setVisible(false);}appendChild(t){this.dropdownContainer.appendChild(t);}clearChildren(){this.dropdownContainer.replaceChildren();}destroy(){this.setVisible(false),this.dropdownContainer.remove(),this.dropdownToggleListener?.remove(),this.clearChildren(),this.onDestroy();}},Ht=class{constructor(t,e){this.localization=e;this.notifier=new ge,this.notifier.on(0,({dropdown:o,fromToplevelDropdown:i})=>{o&&(t(this.localization.dropdownShown(o.parent.getTitle())),this.connectedNotifiers.forEach(r=>{r.dispatch(13,{kind:13,fromToplevelDropdown:i,layoutManager:this});}));}),this.notifier.on(1,({dropdown:o})=>{o&&t(this.localization.dropdownHidden(o.parent.getTitle()));});}notifier;dropdowns=new Set;listeners=[];connectedNotifiers=[];connectToEditorNotifier(t){this.connectedNotifiers.push(t),this.refreshListeners();}createToolMenu(t){let e=new Ki(t,this.notifier,()=>{this.dropdowns.delete(e),this.refreshListeners();});return this.dropdowns.add(e),this.refreshListeners(),e}refreshListeners(){let t=()=>{this.listeners.forEach(e=>e.remove()),this.listeners=[];};this.dropdowns.size===0?t():this.listeners.length!==this.connectedNotifiers.length&&(t(),this.listeners=this.connectedNotifiers.map(e=>e.on(13,o=>{o.kind!==13||o.layoutManager===this||this.notifier.dispatch(0,{fromToplevelDropdown:o.fromToplevelDropdown});})));}};var Uo=(d=>(d[d.PointerDownEvt=0]="PointerDownEvt",d[d.PointerMoveEvt=1]="PointerMoveEvt",d[d.PointerUpEvt=2]="PointerUpEvt",d[d.GestureCancelEvt=3]="GestureCancelEvt",d[d.WheelEvt=4]="WheelEvt",d[d.KeyPressEvent=5]="KeyPressEvent",d[d.KeyUpEvent=6]="KeyUpEvent",d[d.CopyEvent=7]="CopyEvent",d[d.PasteEvent=8]="PasteEvent",d[d.ContextMenu=9]="ContextMenu",d))(Uo||{});function Sn(n,t){return {kind:n,key:t.key,code:t.code,ctrlKey:t.ctrlKey||t.metaKey,altKey:t.altKey,shiftKey:t.shiftKey}}function Wo(n){return Sn(6,n)}function $o(n){return Sn(5,n)}function Nt(n){return n.kind===0||n.kind===1||n.kind===2}var M=class{constructor(t,e){this.notifier=t;this.description=e;this.#e=F.fromInitialValue(true),this.#e.onUpdate(o=>{o?(this.#t?.notifyEnabled(this),this.notifier.dispatch(0,{kind:0,tool:this})):this.notifier.dispatch(1,{kind:1,tool:this});});}#e;#t=null;#o=null;#i=null;canReceiveInputInReadOnlyEditor(){return  false}setInputMapper(t){this.#o=t,t&&t.setEmitListener(e=>this.dispatchEventToCallback(e));}getInputMapper(){return this.#o}dispatchEventToCallback(t){let e;switch(t.kind){case 0:return this.onPointerDown(t);case 1:this.onPointerMove(t);break;case 2:return this.onPointerUp(t)??false;case 3:this.onGestureCancel(t);break;case 4:return this.onWheel(t);case 5:return this.onKeyPress(t);case 6:return this.onKeyUp(t);case 7:return this.onCopy(t);case 8:return this.onPaste(t);case 9:return this.onContextMenu(t);default:return e=t,e}return  true}onEvent(t){return this.#o?this.#o.onEvent(t):this.dispatchEventToCallback(t)}onPointerDown(t){return  false}onPointerMove(t){}onPointerUp(t){}onGestureCancel(t){}onWheel(t){return  false}onCopy(t){return  false}onPaste(t){return  false}onKeyPress(t){return  false}onKeyUp(t){return  false}onContextMenu(t){return  false}eventCanBeDeliveredToNonActiveTool(t){return  true}setEnabled(t){this.#e.set(t);}isEnabled(){return this.#e.get()}enabledValue(){return this.#e}setToolGroup(t){this.isEnabled()&&t.notifyEnabled(this),this.#t=t;}getToolGroup(){return this.#t?this.#t:null}onDestroy(){this.#i?.remove(),this.#i=null,this.#t=null;}};var Re=class extends M{listeners=new Set([]);constructor(t){super(t.notifier,t.localization.changeTool);}registerListener(t){this.listeners.add(t);}removeListener(t){this.listeners.delete(t);}onKeyPress(t){let e=Array.from(this.listeners.values());for(let o of e)if(o(t))return  true;return  false}};function zs(n,t){let e=new Map,o=null,i=false,r=()=>{if(e.size===0)i?(i=false,t.onEnd()):o!==null&&(clearTimeout(o),o=null);else {let a=Date.now(),l=0;for(let p of e.values()){let u=a-p.timeEnter;l=Math.max(u,l);}let c=t.longPressTimeout??700;o!==null&&(clearTimeout(o),o=null);let d=c-l;d<=0?(t.onStart(),i=true):o=setTimeout(()=>{o=null,r();},d);}},s=a=>{let l={timeEnter:Date.now()};a.type==="pointerenter"?e.set(a.pointerId,l):(a.type==="pointerleave"||a.type==="pointercancel")&&e.clear(),r();};return n.addEventListener("pointerenter",s),n.addEventListener("pointerleave",s),n.addEventListener("pointercancel",s),{removeListeners:()=>{n.removeEventListener("pointerenter",s),n.removeEventListener("pointerleave",s),n.removeEventListener("pointercancel",s);}}}var Cn=zs;function As(n,t){let e="has-long-press-or-hover",o="no-long-press-or-hover";n.classList.add("no-long-press-or-hover");let{removeListeners:i}=Cn(n,{onStart(){n.classList.remove(o),n.classList.add(e);},onEnd(){n.classList.add(o),n.classList.remove(e);},longPressTimeout:t?.timeout});return {removeEventListeners:()=>{n.classList.remove(o),i();}}}var Le=As;function Ds(n,t){let e=[...t.draggableChildElements,n],o=0,i=0,r=0,s=0,a=false,l=null,c=b=>{if(!b)return  false;if(e.includes(b))return  true;let v=["INPUT","SELECT","IMG"],f=false,x=b.parentElement;for(;x&&!v.includes(x.tagName);){if(e.includes(x)){f=true;break}x=x.parentElement;}return !v.includes(b.tagName)&&f},d=[],p=(b,v,f)=>{n.addEventListener(b,v,f),d.push(()=>{n.removeEventListener(b,v);});},u=5,h=()=>Math.hypot(o-r,i-s)<u,m=false;p("pointerdown",b=>{b.defaultPrevented||!c(b.target)||b.isPrimary&&(m=false,o=b.clientX,i=b.clientY,r=b.clientX,s=b.clientY,l=null,a=true);},{passive:true});let g=b=>{a&&(l!==null&&(n.releasePointerCapture(l),l=null),t.onDragEnd({roughlyClick:h(),endTimestamp:performance.now(),displacement:exports.Vec2.of(o-r,i-s)}),a=false,m=false);};return p("pointermove",b=>{if(!b.isPrimary||!a)return;if(b.pointerType==="mouse"&&b.buttons===0){g();return}l===null&&!h()&&(n.setPointerCapture(b.pointerId),l=b.pointerId);let v=b.clientX,f=b.clientY,x=v-o,S=f-i;(!(Math.abs(v-r)<=u&&Math.abs(f-s)<=u)||m)&&(t.onDrag(x,S,exports.Vec2.of(v-r,f-s)),o=v,i=f,m=true);}),p("pointerleave",b=>{l===null&&a&&b.isPrimary&&(n.setPointerCapture(b.pointerId),l=b.pointerId);}),p("pointerup",g),p("pointercancel",g),{removeListeners:()=>{for(let b of d)b();}}}var Ko=Ds;function Vs(n){let t=(o,i)=>{let r=getComputedStyle(o);for(let s=0;s<r.length;s++){let a=r.item(s),l=r.getPropertyValue(a);i.style?.setProperty(a,l);}for(let s=0;s<o.children.length;s++){let a=o.children.item(s),l=i.children.item(s);a&&l?t(a,l):console.warn("CloneElement: Missing child");}},e=n.cloneNode(true);return t(n,e),e}var Tn=Vs;function Ms(n,t,e,o){let i=document.createElement("div");i.classList.add("help-page-container");let r=document.createElement("div");r.classList.add("label","-space-above"),r.setAttribute("aria-live","polite");let s=0,a=n[0]??null,l=[];i.addEventListener("click",g=>{g.target===i&&e();});let c=()=>{if(!a)return P.empty;let g=a.targetElements.map(b=>P.of(b.getBoundingClientRect()));return P.union(...g)},d=()=>{let g=c();for(let[b,v]of l.entries())for(let{container:f,bbox:x}of v)if(b===s)f.classList.add("-active"),f.classList.remove("-clickable","-background"),f.addEventListener("click",()=>{});else {x.containsRect(g)?(f.classList.add("-background"),f.classList.remove("-active","-clickable")):(f.classList.add("-clickable"),f.classList.remove("-active","-background"));let S=b;f.addEventListener("click",()=>{t(S);});}},p=()=>{let g=P.of(r.getBoundingClientRect()),b=c();if(g.intersects(b)){let v=P.of(i.getBoundingClientRect()),f=b.topLeft.y,x=v.bottomLeft.y-b.bottomLeft.y;f>x&&f>g.height/3&&(r.classList.remove("-small-space-above","-large-space-above"),r.classList.add("-large-space-below")),f<x&&x>g.height&&(r.classList.add("-large-space-above"),r.classList.remove("-large-space-below"));}},u=()=>{i.replaceChildren(),r.classList.remove("-large-space-above"),r.classList.add("-small-space-above","-large-space-below"),i.appendChild(r);let g=new P(0,0,window.innerWidth,window.innerHeight);l=[];for(let b of n){let v=[];for(let f of b.targetElements){let x=P.of(f.getBoundingClientRect());if(!g.intersects(x)){let k=g.bottomLeft.lerp(g.bottomRight,.5),B=x.bottomLeft.lerp(x.bottomRight,.5),W=k.minus(B);x=x.translatedBy(W);}let S=Tn(f);for(let k of S.querySelectorAll("input"))k.disabled=true;S.style.margin="0";let C=document.createElement("div");C.classList.add("cloned-element-container"),C.role="group",C.ariaLabel=o.localization.helpControlsAccessibilityLabel,C.style.position="absolute",C.style.left=`${x.topLeft.x}px`,C.style.top=`${x.topLeft.y}px`,C.replaceChildren(S),Le(C,{timeout:0}),v.push({container:C,bbox:x}),i.appendChild(C);}l.push(v);}d();},h=()=>{u(),p();},m=()=>{let g=document.createElement("div");g.textContent=a?.helpText??"",g.classList.add("current-item-help");let b=document.createElement("div");b.textContent=o.localization.helpScreenNavigationHelp,b.classList.add("navigation-help"),r.replaceChildren(g,...s===0?[b]:[]),d();};return m(),{addToParent:g=>{u(),g.appendChild(i),p();},refresh:h,setPageIndex:g=>{s=g,a=n[g],m();}}}var Ut=class{constructor(t,e){this.createOverlay=t;this.context=e;}#e=[];showHelpOverlay(){let t=document.createElement("dialog");t.setAttribute("autofocus","true"),t.classList.add("toolbar-help-overlay");let o=()=>{let f=250;t.classList.add("-hiding"),setTimeout(()=>t.close(),f);},i=0,r=()=>{performance.now()-i<100||o();},s=()=>{let f=document.createElement("button");f.classList.add("close-button"),f.appendChild(this.context.icons.makeCloseIcon());let x=this.context.localization.close;return f.setAttribute("aria-label",x),f.setAttribute("title",x),f.addEventListener("click",()=>{o();}),f},a=()=>{let f=K.fromInitialValue(0),x=document.createElement("div");x.classList.add("navigation-content");let S=Ms(this.#e,B=>f.set(B),r,this.context);S.addToParent(x);let C=B=>{B>=this.#e.length||B<0?(console.warn("Help screen: Navigated to out-of-bounds page",B),x.style.display="none"):(x.style.display="",S.setPageIndex(B));};f.onUpdateAndNow(C);let k={content:x,currentPage:f,toNext:()=>{k.hasNext()&&f.set(f.get()+1);},toPrevious:()=>{k.hasPrevious()&&f.set(f.get()-1);},hasNext:()=>f.get()+1<this.#e.length,hasPrevious:()=>f.get()>0,refreshCurrent:()=>{S.refresh();}};return k},l=f=>{let x=document.createElement("div");x.classList.add("navigation-buttons");let S=document.createElement("button"),C=document.createElement("button");S.textContent=this.context.localization.next,C.textContent=this.context.localization.previous,S.classList.add("next"),C.classList.add("previous");let k=()=>{x.classList.remove("-has-next","-has-previous"),f.hasNext()?(x.classList.add("-has-next"),S.disabled=false):(x.classList.remove("-has-next"),S.disabled=true),f.hasPrevious()?(x.classList.add("-has-previous"),C.disabled=false):(x.classList.remove("-has-previous"),C.disabled=true);};return f.currentPage.onUpdateAndNow(k),S.addEventListener("click",()=>{f.toNext();}),C.addEventListener("click",()=>{f.toPrevious();}),x.replaceChildren(C,S),x},c=a(),d=l(c);t.replaceChildren(s(),d,c.content),this.createOverlay(t),t.showModal();let p=30,u=f=>{f>0&&!c.hasPrevious()&&(f=0),f<0&&!c.hasNext()&&(f=0),(f>p||f<-30)&&(f=p*Math.sign(f)),t.style.transform=`translate(${f}px, 0px)`,f>=p?d.classList.add("-highlight-previous"):d.classList.remove("-highlight-previous"),f<=-30?d.classList.add("-highlight-next"):d.classList.remove("-highlight-next");},h=Ko(t,{draggableChildElements:[c.content],onDrag:(f,x,S)=>{t.classList.add("-dragging"),u(S.x);},onDragEnd:f=>{if(t.classList.remove("-dragging"),u(0),!f.roughlyClick){let x=f.displacement.x;x>p?c.toPrevious():x<-30&&c.toNext(),i=f.endTimestamp;}}}),m;window.ResizeObserver&&(m=new ResizeObserver(()=>{c.refreshCurrent();}),m.observe(t));let g=()=>{requestAnimationFrame(()=>c.refreshCurrent());},b=window.matchMedia?.("(prefers-color-scheme: dark)");b?.addEventListener("change",g);let v=[c.content,d,t];t.addEventListener("click",f=>{v.includes(f.target)&&r();}),t.addEventListener("keyup",f=>{f.code==="Escape"?(o(),f.preventDefault()):f.code==="ArrowRight"?(c.toNext(),f.preventDefault()):f.code==="ArrowLeft"&&(c.toPrevious(),f.preventDefault());}),t.addEventListener("close",()=>{this.context.announceForAccessibility(this.context.localization.helpHidden),b?.removeEventListener("change",g),h.removeListeners(),m?.disconnect(),t.remove();});}registerTextHelpForElement(t,e){this.registerTextHelpForElements([t],e);}registerTextHelpForElements(t,e){this.#e.push({targetElements:[...t],helpText:e});}hasHelpText(){return this.#e.length>0}createToggleButton(){let t=document.createElement("div");t.classList.add("toolbar-help-overlay-button");let e=document.createElement("button");e.classList.add("button");let o=this.context.icons.makeHelpIcon();return o.classList.add("icon"),e.appendChild(o),e.setAttribute("aria-label",this.context.localization.help),e.addEventListener("click",()=>{this.showHelpOverlay();}),t.appendChild(e),t}};var wn=(i=>(i.Save="save",i.Exit="exit",i.Undo="undo",i.Redo="redo",i))(wn||{}),_=class n{constructor(t,e,o){this.editor=t;this.id=e;this.localizationTable=o??t.localization;let i=new Ht(r=>this.editor.announceForAccessibility(r),this.localizationTable);i.connectToEditorNotifier(t.notifier),this.layoutManager=i,this.icon=null,this.container=document.createElement("div"),this.container.classList.add(`${E}toolContainer`,`${E}toolButtonContainer`,`${E}internalWidgetId--${e.replace(/\W/g,"-")}`),this.dropdownContent=document.createElement("div"),this.#e=false,this.button=document.createElement("div"),this.button.classList.add(`${E}button`),this.label=document.createElement("label"),this.button.setAttribute("role","button"),this.button.tabIndex=0,this.button.addEventListener("contextmenu",r=>{r.preventDefault();}),Le(this.button);}container;button;icon;layoutManager;dropdown=null;dropdownContent;dropdownIcon;label;#e;disabled=false;#t=false;#o=[];subWidgets={};toplevel=true;localizationTable;#i=null;#r(){this.#i?.();let t=this.editor.toolController.getMatchingTools(Re),e=null;if(t.length>0&&this.onKeyPress!==n.prototype.onKeyPress){let i=s=>this.onKeyPress(s),r=t[0];r.registerListener(i),e=()=>{r.removeListener(i);};}let o=this.editor.isReadOnlyReactiveValue().onUpdateAndNow(i=>{i&&this.shouldAutoDisableInReadOnlyEditor()&&!this.disabled?(this.setDisabled(true),this.#t=true,this.#e&&this.dropdown?.requestHide()):!i&&this.#t&&(this.#t=false,this.setDisabled(false));});this.#i=()=>{o.remove(),e?.(),this.#i=null;};}shouldAutoDisableInReadOnlyEditor(){return  true}getId(){return this.id}setTags(t){let e=o=>`toolwidget-tag--${o}`;for(let o of this.#o)this.container.classList.remove(e(o));this.#o=[...t];for(let o of this.#o)this.container.classList.add(e(o));}getTags(){return [...this.#o]}getUniqueIdIn(t){let e=this.getId(),o=0;for(;e in t&&t[e]!==this;)e=this.getId()+"-"+o.toString(),o++;return e}fillDropdown(t,e){if(Object.keys(this.subWidgets).length===0)return  false;for(let o in this.subWidgets){let i=this.subWidgets[o],r=i.addTo(t);i.setIsToplevel(false);let s=i.getHelpText();s&&e?.registerTextHelpForElement(r,s);}return  true}getHelpText(){}setupActionBtnClickListener(t){return this.setUpButtonEventListeners(t)}setUpButtonEventListeners(t){let e={Enter:true," ":true};t.addEventListener("keydown",o=>{let i=false;if(o.key in e&&(this.disabled||(this.handleClick(),i=true)),!i){let r=$o(o);i=this.editor.toolController.dispatchInputEvent(r);}i&&o.preventDefault();}),t.addEventListener("keyup",o=>{if(o.key in e)return;let i=Wo(o);this.editor.toolController.dispatchInputEvent(i)&&o.preventDefault();}),t.addEventListener("click",()=>{this.disabled||this.handleClick();}),t.addEventListener("dblclick",o=>{o.preventDefault();});}onKeyPress(t){return  false}get hasDropdown(){return this.#e}addSubWidget(t){let e=t.getUniqueIdIn(this.subWidgets);this.subWidgets[e]=t;}setLayoutManager(t){t!==this.layoutManager&&(this.layoutManager=t,this.container.parentElement&&this.addTo(this.container.parentElement));}addTo(t){this.icon=null,this.updateIcon(),this.label.innerText=this.getTitle();let e="long-label";this.label.innerText.length>7?this.label.classList.add(e):this.label.classList.remove(e),this.setUpButtonEventListeners(this.button),this.container.replaceChildren(),this.button.replaceChildren(this.icon,this.label),this.container.appendChild(this.button);let o=new Ut(r=>this.editor.createHTMLOverlay(r),this.editor),i=this.getHelpText();return i&&o.registerTextHelpForElement(this.dropdownContent,[this.getTitle(),i].join(`

`)),t.appendChild(this.container),this.container}remove(){this.container.remove(),this.#i?.();}focus(){this.button.focus();}addCSSClassToContainer(t){this.container.classList.add(t);}removeCSSClassFromContainer(t){this.container.classList.remove(t);}updateIcon(){let t=this.createIcon();t?this.container.classList.remove("no-icon"):(t=document.createElement("div"),this.container.classList.add("no-icon")),this.icon?.replaceWith(t),this.icon=t,this.icon.classList.add(`${E}icon`);}setDisabled(t){this.disabled=t,this.#t=false,this.disabled?(this.button.classList.add("disabled"),this.button.setAttribute("aria-disabled","true")):(this.button.classList.remove("disabled"),this.button.removeAttribute("aria-disabled"));}setSelected(t){this.isSelected()!==t&&(this.button.setAttribute("role","switch"),t?(this.container.classList.add("selected"),this.button.setAttribute("aria-checked","true")):(this.container.classList.remove("selected"),this.button.setAttribute("aria-checked","false")));}setDropdownVisible(t){t?this.dropdown?.requestShow():this.dropdown?.requestHide();}activateDropdown(){this.dropdown?.onActivated();}mustBeInToplevelMenu(){return  false}canBeInOverflowMenu(){return !this.mustBeInToplevelMenu()}getButtonWidth(){return this.button.clientWidth}isHidden(){return this.container.style.display==="none"}setHidden(t){this.container.style.display=t?"none":"";}setIsToplevel(t){this.toplevel=t;}isDropdownVisible(){return this.dropdown?.visible?.get()??false}isSelected(){return this.container.classList.contains("selected")}createDropdownIcon(){let t=this.editor.icons.makeDropdownIcon();return t.classList.add(`${E}showHideDropdownIcon`),t}serializeState(){let t={};for(let e in this.subWidgets)t[e]=this.subWidgets[e].serializeState();return {subwidgetState:t}}deserializeFrom(t){if(t.subwidgetState){Ro(t.subwidgetState);for(let e in t.subwidgetState)if(e in this.subWidgets){let o=t.subwidgetState[e];o&&this.subWidgets[e].deserializeFrom(o);}}}};function Fs(){let n=[...document.querySelectorAll("*:focus")];return n.length&&n.some(t=>t.classList.contains(`${E}button`))}var ee=class extends _{constructor(e,o,i,r){super(e,i,r);this.targetTool=o;this.targetTool.enabledValue().onUpdateAndNow(s=>{s?(this.setSelected(true),Fs()&&this.focus()):(this.setSelected(false),this.setDropdownVisible(false));});}shouldAutoDisableInReadOnlyEditor(){return !this.targetTool.canReceiveInputInReadOnlyEditor()}handleClick(){this.targetTool.setEnabled(!this.targetTool.isEnabled());}onKeyPress(e){return this.isSelected()&&e.code==="Space"&&this.hasDropdown?(this.handleClick(),true):false}addTo(e){let o=super.addTo(e);return this.setSelected(this.targetTool.isEnabled()),o}};var Wt=class extends M{constructor(e,o){super(e.notifier,o);this.editor=e;this.enabledValue().onUpdateAndNow(()=>{this.updateSelectingStatus();});}colorPreviewListener=null;colorSelectListener=null;canReceiveInputInReadOnlyEditor(){return  true}updateSelectingStatus(){let e="pipette--color-selection-in-progress";this.isEnabled()&&this.colorSelectListener&&this.colorPreviewListener?this.editor.getRootElement().classList.add(e):this.editor.getRootElement().classList.remove(e);}setColorListener(e,o){this.colorPreviewListener=e,this.colorSelectListener=o,this.updateSelectingStatus();}clearColorListener(){this.colorPreviewListener=null,this.colorSelectListener=null,this.updateSelectingStatus();}onPointerDown({current:e,allPointers:o}){return this.colorPreviewListener&&o.length===1?(this.colorPreviewListener(this.editor.display.getColorAt(e.screenPos)),true):false}onPointerMove({current:e}){this.colorPreviewListener?.(this.editor.display.getColorAt(e.screenPos));}onPointerUp({current:e}){this.colorSelectListener?.(this.editor.display.getColorAt(e.screenPos));}onGestureCancel(){this.colorSelectListener?.(null);}};function Os(n,t){let e=document.createElement("span"),o=document.createElement("span"),i=document.createElement("input");i.type="button",i.classList.add("coloris_input"),e.classList.add("color-input-container"),o.classList.add("color-input-wrapper"),o.appendChild(i),e.appendChild(o);let r=Hs(n,e,u=>{i.value=u.toHexString(),l();let h=i.parentElement;h&&h.classList.contains("clr-field")&&(h.style.color=i.value);}),s,a=()=>{s=w.fromHex(i.value);},l=()=>{a(),s&&(n.announceForAccessibility(n.localization.colorChangedAnnouncement(s.toHexString())),t(s),n.notifier.dispatch(12,{kind:12,color:s}));};i.addEventListener("input",a);let c=false;i.addEventListener("open",()=>{c=true,n.notifier.dispatch(11,{kind:11,open:true}),r.cancel(),e.classList.add("picker-open"),document.querySelector("#clr-picker #clr-hue-slider")?.focus();});let d=()=>{c=false,n.notifier.dispatch(11,{kind:11,open:false}),l(),i.focus(),e.classList.remove("picker-open");};return i.addEventListener("close",()=>{d();}),{input:i,container:e,setValue:u=>{typeof u=="object"&&(u=u.toHexString()),i.value=u,i.dispatchEvent(new Event("input",{bubbles:true}));},closePicker:()=>{c&&l();},registerWithHelpTextDisplay:u=>{u.registerTextHelpForElement(o,n.localization.colorPickerToggleHelpText),r.registerWithHelpTextDisplay(u);}}}function Hs(n,t,e){let o=document.createElement("button");o.classList.add("pipetteButton"),o.title=n.localization.pickColorFromScreen,o.setAttribute("alt",o.title);let i=document.createElement("span");i.classList.add("pickColorInstructions"),i.innerText=n.localization.clickToPickColorAnnouncement;let r=d=>{o.replaceChildren(n.icons.makePipetteIcon(d),i);};r();let s=n.toolController.getMatchingTools(Wt)[0],a=()=>{s?.clearColorListener(),r(),o.classList.remove("active");},l=d=>{a(),d&&e(d);},c=d=>{d?r(d):r();};return o.addEventListener("click",()=>{if(o.classList.contains("active")){a(),n.announceForAccessibility(n.localization.colorSelectionCanceledAnnouncement);return}s?.setColorListener(c,l),s&&(o.classList.add("active"),n.announceForAccessibility(n.localization.clickToPickColorAnnouncement));}),t.appendChild(o),{cancel:()=>{a();},registerWithHelpTextDisplay:d=>{d.registerTextHelpForElement(o,n.localization.colorPickerPipetteHelpText);}}}var be=Os;function Ns(n){let t=(e,o,i,r)=>{let s=o!==r&&e!==0,a=i+e<=0,c=i+o+e>r;return s&&!a&&!c};n.addEventListener("wheel",e=>{let o=t(e.deltaX,n.clientWidth,n.scrollLeft,n.scrollWidth),i=t(e.deltaY,n.clientHeight,n.scrollTop,n.scrollHeight);(o||i)&&e.stopPropagation();});}var it=Ns;var Gi=0;function Us(n,t,e){let o=document.createElement("div");o.classList.add(`${E}grid-selector`);let i=K.fromInitialValue(t),r=document.createElement("div");r.role="group",r.id=`${E}-grid-select-id-${Gi++}`,it(r);let s=document.createElement("label");s.textContent=n,s.htmlFor=r.id,o.appendChild(s);let a=`${E}-grid-selector-${Gi++}`,l=p=>{let u=document.createElement("div");u.classList.add("choice-button");let h=document.createElement("input");h.type="radio",h.id=`${E}-grid-select-button-${Gi++}`,Le(u);let m=document.createElement("label"),g=()=>{m.setAttribute("title",p.title);let S=document.createElement("span");S.classList.add("button-label-text");let C=p.makeIcon();C.classList.add("icon"),S.innerText=p.title,m.htmlFor=h.id,m.replaceChildren(C,S);};g();let b=()=>{h.name=a;};b();let v=()=>{h.checked?u.classList.add("checked"):u.classList.remove("checked");};h.addEventListener("input",()=>{h.checked&&i.set(p.id),v();}),h.addEventListener("focus",()=>{u.querySelector(":focus-visible")&&u.classList.add("focus-visible");}),h.addEventListener("blur",()=>{u.classList.remove("focus-visible");}),u.addEventListener("contextmenu",S=>{S.preventDefault();}),u.replaceChildren(h,m),r.appendChild(u);let f=S=>{h.checked=S,v();};return f(false),{choiceRecord:p,setChecked:f,updateIcon:()=>{g();},updateButtonRadiogroupName:b}},c=[];for(let p of e)c.push(l(p));o.appendChild(r),i.onUpdateAndNow(p=>{for(let u of c)u.setChecked(u.choiceRecord.id===p);});let d={value:i,_radiogroupName:a,linkWith:p=>{d._radiogroupName=p._radiogroupName,a=p._radiogroupName;for(let u of c)u.updateButtonRadiogroupName();},updateIcons:()=>{c.forEach(p=>p.updateIcon());},getRootElement(){return o},addTo:p=>{p.appendChild(o);}};return d}var $t=Us;var Ws=0;function $s(n,t){let e=document.createElement("div"),o=document.createElement("label"),i=document.createElement("input");e.classList.add(`${E}thicknessSliderContainer`),i.id=`${E}thicknessInput${Ws++}`,o.innerText=n.localization.thicknessLabel,o.setAttribute("for",i.id);let r=l=>Math.log10(l),s=l=>10**l;i.type="range",i.addEventListener("input",()=>{t(s(Number.parseFloat(i.value)));}),e.appendChild(o),e.appendChild(i);let a=(l,c)=>{let d=(h,m)=>(m?Math.ceil:Math.floor)(h*100)/100,p=d(r(l),false),u=d(r(c),true);i.min=`${p}`,i.max=`${u}`,i.step=`${J((u-p)/20)}`;};return a(2,262),{container:e,addTo:l=>{l.appendChild(e);},setBounds:a,setValue:l=>{i.value=r(l).toString();}}}var rt=$s;function Pn(n){return n.toUpperCase()===n&&n.toLowerCase()!==n&&n.length===1}function En(n){return n.toLowerCase()===n&&n.toUpperCase()!==n&&n.length===1}var nt=class n{key;shiftKey;ctrlKey;altKey;metaKey;controlOrMeta;constructor(t){this.key=t.key,this.shiftKey=t.shiftKey,this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.metaKey=t.metaKey,this.controlOrMeta=t.controlOrMeta;}matchesEvent(t){let e=t.key?.toLowerCase(),o=Pn(t.key??""),i=En(t.key??""),r=(t.ctrlKey??false)||e==="control",s=(t.altKey??false)||e==="alt",a=(t.metaKey??false)||e==="meta",l=(t.shiftKey??o)||e==="shift",c=t.controlOrMeta||t.ctrlKey||t.metaKey||false;if(this.key!==t.code&&(this.key.toLowerCase()!==e||(o||i)&&this.key!==t.key&&!(this.shiftKey===true&&this.key.toUpperCase()===t.key)))return  false;let d=this.controlOrMeta;return (r===this.ctrlKey&&a===this.metaKey&&!d||d&&c)&&s===this.altKey&&(l===this.shiftKey||this.shiftKey===void 0)}toString(){let t=[];return this.ctrlKey&&this.key!=="control"&&t.push("Ctrl"),this.controlOrMeta&&t.push("CtrlOrMeta"),this.altKey&&this.key!=="alt"&&t.push("Alt"),this.metaKey&&this.key!=="meta"&&t.push("Meta"),this.shiftKey&&this.key!=="shift"&&t.push("Shift"),t.push(this.key),t.join("+")}static fromString(t){let e=g=>{let b;Pn(g)?b=true:(En(g)||g.length>1)&&(b=false);let v=g.toLowerCase();return v==="shift"&&(b=true),{shiftKey:b,ctrlKey:v==="control"||v==="ctrl",altKey:v==="alt",metaKey:v==="meta",controlOrMeta:v==="control or meta"||v==="ctrlormeta"}};if(t.search(/[+-]/)===-1||t.length===1){let g=e(t);return new n({key:t,...g})}let r=/^(.*[+-])?(.+)$/g.exec(t);if(!r)throw new Error(`Invalid shortcut expression, ${t}!`);let s=r[2],a=e(s),l=(r[1]??"").split(/[+-]/),c=a.shiftKey,d=a.ctrlKey,p=a.altKey,u=a.metaKey,h=a.controlOrMeta;for(let g of l)if(g!=="")switch(g.toLowerCase()){case "shift":c=true;break;case "anyshift":c=void 0;break;case "ctrl":case "control":d=true;break;case "meta":u=true;break;case "ctrlormeta":case "ctrl or meta":case "controlormeta":h=true;break;case "alt":p=true;break;default:throw new Error(`Unknown modifier: "${g}" in shortcut ${t}.`)}return new n({key:s,shiftKey:c,ctrlKey:d,altKey:p,metaKey:u,controlOrMeta:h})}};var In={updatedViewport:"Transformed Viewport",transformedElements:(n,t)=>`Transformed ${n} element${n===1?"":"s"} (${t})`,resizeOutputCommand:n=>`Resized image to ${n.w}x${n.h}`,enabledAutoresizeOutputCommand:"Enabled output autoresize",disabledAutoresizeOutputCommand:"Disabled output autoresize",addComponentAction:n=>`Added ${n}`,eraseAction:(n,t)=>`Erased ${t} ${n}`,duplicateAction:(n,t)=>`Duplicated ${t} ${n}`,unionOf:(n,t)=>`Union: ${t} ${n}`,inverseOf:n=>`Inverse of ${n}`,elements:"Elements",erasedNoElements:"Erased nothing",duplicatedNoElements:"Duplicated nothing",rotatedBy:n=>`Rotated by ${Math.abs(n)} degrees ${n<0?"clockwise":"counter-clockwise"}`,movedLeft:"Moved left",movedUp:"Moved up",movedDown:"Moved down",movedRight:"Moved right",zoomedOut:"Zoomed out",zoomedIn:"Zoomed in",andNMoreCommands:n=>`And ${n} more commands.`,selectedElements:n=>`Selected ${n} element${n===1?"":"s"}`};var kn={unlabeledImageNode:"Unlabeled image node",stroke:"Stroke",svgObject:"SVG Object",emptyBackground:"Empty background",gridBackground:"Grid background",dotBackground:"Dot background",filledBackgroundWithColor:n=>`Filled background (${n})`,text:n=>`Text object: ${n}`,imageNode:n=>`Image: ${n}`,restyledElement:n=>`Restyled ${n}`};var Rn={pathNodeCount:n=>`There are ${n} visible path objects.`,textNodeCount:n=>`There are ${n} visible text nodes.`,imageNodeCount:n=>`There are ${n} visible image nodes.`,textNode:n=>`Text: ${n}`,imageNode:n=>`Image: ${n}`,unlabeledImageNode:"Unlabeled image",rerenderAsText:"Re-render as text"};var Ln={help:"Help",helpHidden:"Help hidden",next:"Next",previous:"Previous",close:"Close",helpScreenNavigationHelp:"Click on a control for more information.",helpControlsAccessibilityLabel:"Controls: Activate a control to show help."};var Bn={...Ln,pen:"Pen",eraser:"Eraser",select:"Select",handTool:"Pan",zoom:"Zoom",image:"Image",reformatSelection:"Format selection",inputAltText:"Alt text",decreaseImageSize:"Decrease size",resetImage:"Reset",chooseFile:"Choose file",dragAndDropHereOrBrowse:`Drag and drop here
or
{{browse}}`,submit:"Submit",addAll:"Add all",cancel:"Cancel",resetView:"Reset view",thicknessLabel:"Thickness",colorLabel:"Color",fontLabel:"Font",textSize:"Size",resizeImageToSelection:"Resize image to selection",deleteSelection:"Delete selection",duplicateSelection:"Duplicate selection",exit:"Exit",save:"Save",undo:"Undo",redo:"Redo",fullStrokeEraser:"Full stroke eraser",selectPenType:"Pen type",selectShape:"Shape",pickColorFromScreen:"Pick color from screen",clickToPickColorAnnouncement:"Click on the screen to pick a color",colorSelectionCanceledAnnouncement:"Color selection canceled",selectionTool__lassoSelect:"Freeform selection",selectionTool__lassoSelect__help:"When enabled, dragging creates a freeform (lasso) selection.",selectionToolKeyboardShortcuts:"Selection tool: Use arrow keys to move selected items, lowercase/uppercase \u2018i\u2019 and \u2018o\u2019 to resize.",documentProperties:"Page",backgroundColor:"Background color",imageWidthOption:"Width",imageHeightOption:"Height",useGridOption:"Grid",enableAutoresizeOption:"Auto-resize",toggleOverflow:"More",about:"About",inputStabilization:"Stabilization",strokeAutocorrect:"Autocorrect",touchPanning:"Scroll with touch",roundedTipPen:"Round",roundedTipPen2:"Polyline",flatTipPen:"Flat",arrowPen:"Arrow",linePen:"Line",outlinedRectanglePen:"Outlined rectangle",filledSquare:"Filled square",filledRectangle:"Filled rectangle",filledCircle:"Filled circle",filledTriangle:"Filled triangle",filledHexagonal:"Filled hexagonal",filledDiamond:"Filled diamond",filledArrow:"Filled arrow",outlinedCirclePen:"Outlined circle",lockRotation:"Lock rotation",paste:"Paste",errorImageHasZeroSize:"Error: Image has zero size",describeTheImage:"Image description",fileInput__loading:"Loading...",fileInput__andNMoreFiles:n=>`(...${n} more)`,penDropdown__baseHelpText:"This tool draws shapes or freehand lines.",penDropdown__colorHelpText:"Changes the pen's color",penDropdown__thicknessHelpText:"Changes the thickness of strokes drawn by the pen.",penDropdown__penTypeHelpText:`Changes the pen style.

Either a \u201Cpen\u201D style or \u201Cshape\u201D can be chosen. Choosing a \u201Cpen\u201D style draws freehand lines. Choosing a \u201Cshape\u201D draws shapes.`,penDropdown__autocorrectHelpText:`Converts approximate freehand lines and rectangles to perfect ones.

The pen must be held stationary at the end of a stroke to trigger a correction.`,penDropdown__stabilizationHelpText:`Draws smoother strokes.

This also adds a short delay between the mouse/stylus and the stroke.`,handDropdown__baseHelpText:"This tool is responsible for scrolling, rotating, and zooming the editor.",handDropdown__zoomInHelpText:"Zooms in.",handDropdown__zoomOutHelpText:"Zooms out.",handDropdown__resetViewHelpText:"Resets the zoom level to 100% and resets scroll.",handDropdown__zoomDisplayHelpText:"Shows the current zoom level. 100% shows the image at its actual size.",handDropdown__touchPanningHelpText:"When enabled, touchscreen gestures move the image rather than select or draw.",handDropdown__lockRotationHelpText:"When enabled, prevents touch gestures from rotating the screen.",eraserDropdown__baseHelpText:"This tool removes strokes, images, and text under the cursor.",eraserDropdown__thicknessHelpText:"Changes the size of the eraser.",eraserDropdown__fullStrokeEraserHelpText:`When in full-stroke mode, entire shapes are erased.

When not in full-stroke mode, shapes can be partially erased.`,selectionDropdown__baseHelpText:"Selects content and manipulates the selection",selectionDropdown__resizeToHelpText:`Crops the drawing to the size of what's currently selected.

If auto-resize is enabled, it will be disabled.`,selectionDropdown__deleteHelpText:"Erases selected items.",selectionDropdown__duplicateHelpText:"Makes a copy of selected items.",selectionDropdown__changeColorHelpText:"Changes the color of selected items.",pageDropdown__baseHelpText:"Controls the drawing canvas' background color, pattern, and size.",pageDropdown__backgroundColorHelpText:"Changes the background color of the drawing canvas.",pageDropdown__gridCheckboxHelpText:"Enables/disables a background grid pattern.",pageDropdown__autoresizeCheckboxHelpText:`When checked, the page grows to fit the drawing.

When unchecked, the page is visible and its size can be set manually.`,pageDropdown__aboutButtonHelpText:"Shows version, debug, and other information.",colorPickerPipetteHelpText:"Picks a color from the screen.",colorPickerToggleHelpText:"Opens/closes the color picker.",closeSidebar:n=>`Close sidebar for ${n}`,dropdownShown:n=>`Menu for ${n} shown`,dropdownHidden:n=>`Menu for ${n} hidden`,zoomLevel:n=>`Zoom: ${n}%`,colorChangedAnnouncement:n=>`Color changed to ${n}`,imageSize:(n,t)=>`Image size: ${n} ${t}`,imageLoadError:n=>`Error loading image: ${n}`};var zn={penTool:n=>`pen-${n}`,selectionTool:"Selection",selectAllTool:"Select all shortcut",eraserTool:"Eraser",touchPanTool:"Touch panning",twoFingerPanZoomTool:"Panning and zooming",undoRedoTool:"Undo/Redo",rightClickDragPanTool:"Right-click drag",pipetteTool:"Pick color from screen",keyboardPanZoom:"Keyboard pan/zoom shortcuts",selectionMenu__show:"Show selection menu",selectionMenu__copyToClipboard:"Copy to clipboard",selectionMenu__duplicate:"Duplicate",selectionMenu__delete:"Delete",selectionMenu__paste:"Paste",copyPasteError__heading:"Copy/paste",copyPasteError__description:"Something went wrong \u2014 this tool may not have clipboard access.",copyPasteError__errorDetails:"Show error",copyPasteError__pasteRetry:"To retry, please paste into the input box below:",copyPasteError__copyRetry:"To retry, please copy the text in the input box below:",copyPasteError__copyMe:"Copy me!",autocorrectedTo:n=>`Autocorrected to ${n}`,autocorrectionCanceled:"Autocorrect cancelled",textTool:"Text",enterTextToInsert:"Text to insert",changeTool:"Change tool",pasteHandler:"Copy paste handler",soundExplorer:"Sound-based image exploration",disableAccessibilityExploreTool:"Disable sound-based exploration",enableAccessibilityExploreTool:"Enable sound-based exploration",soundExplorerUsageAnnouncement:"Sound-based image exploration enabled: Click/drag the screen to play a sound representation of different parts of the image.",findLabel:"Find",toNextMatch:"Next",closeDialog:"Close",findDialogShown:"Find dialog shown",findDialogHidden:"Find dialog hidden",focusedFoundText:(n,t)=>`Viewing match ${n} of ${t}`,anyDevicePanning:"Any device panning",copied:n=>`Copied ${n} item(s)`,pasted:n=>`Pasted ${n} item(s)`,toolEnabledAnnouncement:n=>`${n} enabled`,toolDisabledAnnouncement:n=>`${n} disabled`};var Be={...Bn,...zn,...In,...kn,...Rn,accessibilityInputInstructions:['Press "t" to read the contents of the viewport as text.',"Use the arrow keys to move the viewport, click and drag to draw strokes.",'Press "w" to zoom in and "s" to zoom out.'].join(" "),loading:n=>`Loading ${n}%...`,imageEditor:"Image Editor",doneLoading:"Done loading",undoAnnouncement:n=>`Undid ${n}`,redoAnnouncement:n=>`Redid ${n}`,softwareLibraries:"Libraries",developerInformation:"Developer information"};var Ks={...Be,pen:"Stift",eraser:"Radierer",select:"Auswahl",handTool:"Verschieben",zoom:"Vergr\xF6\xDFerung",image:"Bild",inputAltText:"Alt-Text: ",chooseFile:"W\xE4hle Datei: ",submit:"Absenden",cancel:"Abbrechen",resetView:"Ansicht zur\xFCcksetzen",thicknessLabel:"Dicke: ",colorLabel:"Farbe: ",fontLabel:"Schriftart: ",textSize:"Gr\xF6\xDFe: ",resizeImageToSelection:"Bildgr\xF6\xDFe an Auswahl anpassen",deleteSelection:"Auswahl l\xF6schen",duplicateSelection:"Auswahl duplizieren",undo:"R\xFCckg\xE4ngig",redo:"Wiederholen",pickColorFromScreen:"Farbe von Bildschirm ausw\xE4hlen",clickToPickColorAnnouncement:"Klicke auf den Bildschirm, um eine Farbe auszuw\xE4hlen",selectionToolKeyboardShortcuts:"Auswahl-Werkzeug: Verwende die Pfeiltasten, um ausgew\xE4hlte Elemente zu verschieben und \u201Ai\u2018 und \u201Ao\u2018, um ihre Gr\xF6\xDFe zu \xE4ndern.",touchPanning:"Ansicht mit Touchscreen verschieben",anyDevicePanning:"Ansicht mit jedem Eingabeger\xE4t verschieben",selectPenType:"Objekt-Typ: ",roundedTipPen:"Freihand",flatTipPen:"Stift (druckempfindlich)",arrowPen:"Pfeil",linePen:"Linie",outlinedRectanglePen:"Umrissenes Rechteck",filledRectanglePen:"Ausgef\xFClltes Rechteck",lockRotation:"Sperre Rotation",paste:"Einf\xFCgen",dropdownShown:n=>`Dropdown-Men\xFC f\xFCr ${n} angezeigt`,dropdownHidden:n=>`Dropdown-Men\xFC f\xFCr ${n} versteckt`,zoomLevel:n=>`Verg\xF6\xDFerung: ${n}%`,colorChangedAnnouncement:n=>`Farbe zu ${n} ge\xE4ndert`,imageSize:(n,t)=>`Bild-Gr\xF6\xDFe: ${n} ${t}`,imageLoadError:n=>`Fehler beim Laden des Bildes: ${n}`,errorImageHasZeroSize:"Fehler: Bild hat Gr\xF6\xDFe Null",penTool:n=>`Stift ${n}`,selectionTool:"Auswahl",eraserTool:"Radiergummi",touchPanTool:"Ansicht mit Touchscreen verschieben",twoFingerPanZoomTool:"Ansicht verschieben und vergr\xF6\xDFern",undoRedoTool:"R\xFCckg\xE4ngig/Wiederholen",rightClickDragPanTool:"Rechtsklick-Ziehen",pipetteTool:"Farbe von Bildschirm ausw\xE4hlen",keyboardPanZoom:"Tastaturk\xFCrzel zum Verschieben/Vergr\xF6\xDFern der Ansicht",textTool:"Text",enterTextToInsert:"Einzuf\xFCgender Text",changeTool:"Wechsle Werkzeug",pasteHandler:"Copy-Paste-Handler",findLabel:"Finde",toNextMatch:"N\xE4chstes",closeDialog:"Schlie\xDFen",findDialogShown:"Finde-Dialog angezeigt",findDialogHidden:"Finde-Dialog versteckt",focusedFoundText:(n,t)=>`Sieh Treffer ${n} von ${t} an`,toolEnabledAnnouncement:n=>`${n} aktiviert`,toolDisabledAnnouncement:n=>`${n} deaktiviert`,updatedViewport:"Transformierte Ansicht",transformedElements:(n,t)=>`${n} Element${n===1?"":"e"} transformiert (${t})`,resizeOutputCommand:n=>`Bildgr\xF6\xDFe auf ${n.w}x${n.h} ge\xE4ndert`,addComponentAction:n=>`${n} hinzugef\xFCgt`,eraseAction:(n,t)=>`${t} ${n} gel\xF6scht`,duplicateAction:(n,t)=>`${t} ${n} dupliziert`,inverseOf:n=>`${n} umgekehrt`,elements:"Elemente",erasedNoElements:"Nichts entfernt",duplicatedNoElements:"Nichts dupliziert",rotatedBy:n=>`${Math.abs(n)} Grad ${n<0?"im Uhrzeigersinn":"gegen den Uhrzeigersinn"} gedreht`,movedLeft:"Nacht links bewegt",movedUp:"Nacht oben bewegt",movedDown:"Nacht unten bewegt",movedRight:"Nacht rechts bewegt",zoomedOut:"Ansicht verkleinert",zoomedIn:"Ansicht vergr\xF6\xDFert",selectedElements:n=>`${n} Element${n===1?"":"e"} ausgew\xE4hlt`,stroke:"Strich",svgObject:"SVG-Objekt",text:n=>`Text-Objekt: ${n}`,pathNodeCount:n=>`Es gibt ${n} sichtbare Pfad-Objekte.`,textNodeCount:n=>`Es gibt ${n} sichtbare Text-Knotenpunkte.`,textNode:n=>`Text: ${n}`,imageNodeCount:n=>`Es gibt ${n} sichtbare Bild-Knoten.`,imageNode:n=>`Bild: ${n}`,unlabeledImageNode:"Bild ohne Label",rerenderAsText:"Als Text darstellen",accessibilityInputInstructions:"Dr\xFCcke \u201At\u2018, um den Inhalt des Ansichtsfensters als Text zu lesen. Verwende die Pfeiltasten, um die Ansicht zu verschieben, und klicke und ziehe, um Striche zu zeichnen. Dr\xFCcke \u201Aw\u2018 zum Vergr\xF6\xDFern und \u201As\u2018 zum Verkleinern der Ansicht.",loading:n=>`Laden ${n}%...`,doneLoading:"Laden fertig",imageEditor:"Bild-Editor",undoAnnouncement:n=>`${n} r\xFCckg\xE4ngig gemacht`,redoAnnouncement:n=>`${n} wiederholt`,reformatSelection:"Formatiere Auswahl",documentProperties:"Seite",backgroundColor:"Hintergrundfarbe: ",imageWidthOption:"Breite: ",imageHeightOption:"H\xF6he: ",useGridOption:"Gitter: ",toggleOverflow:"Mehr",selectAllTool:"Alle ausw\xE4hlen",soundExplorer:"Klangbasierte Bilderkundung",disableAccessibilityExploreTool:"Deaktiviere klangbasierte Erkundung",enableAccessibilityExploreTool:"Aktiviere klangbasierte Erkundung",unionOf:(n,t)=>`Vereinigung: ${t} ${n}`,emptyBackground:"Leerer Hintergrund",filledBackgroundWithColor:n=>`Gef\xFCllter Hintergrund (${n})`,restyledElement:n=>`${n} umgestaltet`},An=Ks;var Gs={...Be},Dn=Gs;var qs={...Be,pen:"Lapiz",eraser:"Borrador",select:"Selecciona",handTool:"Mover",image:"Imagen",inputAltText:"Texto alternativo",resetImage:"Reiniciar",chooseFile:"Seleccionar archivo",cancel:"Cancelar",resetView:"Reiniciar vista",thicknessLabel:"Tama\xF1o",fontLabel:"Fuente:",textSize:"Tama\xF1o",resizeImageToSelection:"Redimensionar la imagen a lo que est\xE1 seleccionado",deleteSelection:"Borra la selecci\xF3n",duplicateSelection:"Duplica la selecci\xF3n",exit:"Salir",save:"Guardar",undo:"Deshace",redo:"Rehace",selectPenType:"Punta",selectShape:"Forma",pickColorFromScreen:"Selecciona un color de la pantalla",clickToPickColorAnnouncement:"Haga un clic en la pantalla para seleccionar un color",documentProperties:"Fondo",backgroundColor:"Color de fondo",imageWidthOption:"Ancho",imageHeightOption:"Alto",enableAutoresizeOption:"Redimensionar autom\xE1tico",toggleOverflow:"M\xE1s",about:"Acerca de",touchPanning:"Mover la pantalla con un dedo",roundedTipPen:"Lapiz Redondeado",arrowPen:"Flecha",linePen:"L\xEDnea",outlinedRectanglePen:"Rect\xE1ngulo delineado",filledRectanglePen:"Rect\xE1ngulo sin borde",lockRotation:"Bloquea rotaci\xF3n",paste:"Pegar",selectionMenu__paste:"Pegar",selectionMenu__delete:"Eliminar",selectionMenu__duplicate:"Duplicar",closeSidebar:n=>`Close sidebar for ${n}`,dropdownShown:n=>`Men\xFA por ${n} es visible`,dropdownHidden:n=>`Men\xFA por ${n} fue ocultado`,zoomLevel:n=>`Zoom: ${n}%`,colorChangedAnnouncement:n=>`Color fue cambiado a ${n}`,imageSize:(n,t)=>`Tama\xF1o del imagen: ${n} ${t}`,imageLoadError:n=>`Error cargando imagen: ${n}`,penTool:n=>`Lapiz ${n}`,selectionTool:"Selecciona",eraserTool:"Borrador",touchPanTool:"Instrumento de mover la pantalla con un dedo",undoRedoTool:"Deshace/rehace",pipetteTool:"Seleccione un color de la pantalla",keyboardPanZoom:"Mover la pantalla con el teclado",textTool:"Texto",enterTextToInsert:"Entra texto",findLabel:"Buscar",toNextMatch:"Pr\xF3xima",closeDialog:"Cerrar",anyDevicePanning:"Mover la pantalla con todo dispotivo",copied:n=>`${n} cosas fueron copiados`,pasted:n=>n===1?"Pegado":`${n} cosas fueron pegados`,toolEnabledAnnouncement:n=>`${n} fue activado`,toolDisabledAnnouncement:n=>`${n} fue desactivado`,resizeOutputCommand:n=>`Tama\xF1o de imagen fue cambiado a ${n.w}x${n.h}`,eraseAction:(n,t)=>`Borrado: ${t} ${n}`,rerenderAsText:"Redibuja la pantalla al texto",loading:n=>`Cargando: ${n}%...`,imageEditor:"Editor de dibujos",doneLoading:"El cargado termin\xF3",undoAnnouncement:n=>`${n} fue deshecho`,redoAnnouncement:n=>`${n} fue rehecho`},Vn=qs;var Zs={de:An,en:Dn,es:Vn};function _s(n){let t=/^(\w+)[_-](\w+)$/.exec(n);return t?t[1]:n}function Go(n,t,e){let o;for(let i of n){let r=_s(i);if(o&&r!==o&&o in t)return t[o];if(i in t)return t[i];o=r;}return o&&o in t?t[o]:e}function js(n){return n??=navigator.languages,Go(n,Zs,Be)}var qi=js;var A=class n{static shortcuts=Object.create(null);static shortcutDefaultDescriptions=Object.create(null);static shortcutLocalizedDescriptions=Object.create(null);shortcutOverrides=Object.create(null);constructor(t){for(let e in t)this.overrideShortcut(e,t[e]);}overrideShortcut(t,e){this.shortcutOverrides[t]=[...e];}matchesShortcut(t,e){let o=this.shortcutOverrides[t];if(!o)if(t in n.shortcuts)o=n.shortcuts[t];else throw new Error(`No shortcut with ID ${t} exists!`);for(let i of o)if(i.matchesEvent(e))return  true;return  false}static registerDefaultKeyboardShortcut(t,e,o){if(t in n.shortcuts)return  false;let i=e.map(r=>typeof r=="string"?nt.fromString(r):r);return n.shortcuts[t]=[...i],n.shortcutDefaultDescriptions[t]=o,true}static provideShortcutDescription(t,e,o){e in n.shortcutLocalizedDescriptions||(n.shortcutLocalizedDescriptions[e]=Object.create(null)),n.shortcutLocalizedDescriptions[e][t]=o;}static getAllShortcutIds(){let t=[];for(let e in this.shortcuts)t.push(e);return t}static getShortcutDefaultKeybindings(t){if(!(t in n.shortcuts))throw new Error(`No shortcut with ID ${t} exists!`);return n.shortcuts[t]}static getShortcutDescription(t,e){return Go(e??[],this.shortcutLocalizedDescriptions,this.shortcutDefaultDescriptions)[t]??this.shortcutDefaultDescriptions[t]??null}};var Zi="easydraw.toolbar.SelectionTool.resizeImageToSelection";A.registerDefaultKeyboardShortcut(Zi,["ctrlOrMeta+r"],"Resize image to selection");var Kt=[1,2,3,4,5,6,7,8,9].map(n=>`easydraw.toolbar.PenTool.select-pen-${n}`);for(let[n,t]of Kt.entries())A.registerDefaultKeyboardShortcut(t,[`CtrlOrMeta+Digit${n+1}`],"Select pen style "+(n+1));var _i="easydraw.toolbar.SaveActionWidget.save";A.registerDefaultKeyboardShortcut(_i,["ctrlOrMeta+KeyS"],"Save");var ji="easydraw.toolbar.ExitActionWidget.exit";A.registerDefaultKeyboardShortcut(ji,["Alt+KeyQ"],"Exit");var Gt=O((n,t)=>new qo(n,t)),qo=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getLineWidth(){return Math.max(this.endPoint.width||5,this.startPoint.width||5)}getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=e.minus(t).normalized(),i=e.distanceTo(t),r=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),s=Math.min(r+3,i/2),a=r+3,l=r+3,c=e.minus(o.times(s)),d=o.orthog(),p=d.times(a),u=d.times(l),h=new R(c.minus(u),[{kind:0,point:t.minus(p)},{kind:0,point:t.plus(p)},{kind:0,point:c.plus(u)},{kind:0,point:c.plus(d.times(s).plus(u))},{kind:0,point:e.plus(o.times(l))},{kind:0,point:c.plus(d.times(-s).minus(u))},{kind:0,point:c.minus(u)}]).mapPoints(g=>this.viewport.roundPoint(g));return new D([{startPoint:h.startPoint,commands:h.parts,style:{fill:this.startPoint.color,stroke:{width:r,color:r===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}}}])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};function Ys(n){return (t,e)=>new Yi(n,t,e)}var st=Ys;function Mn(n,t,e){return {points:[n,t[t.length-1]]}}function Fn(n,t,e){return {points:[...e.corners,e.corners[0]]}}var Yi=class{constructor(t,e,o){this.sourceFactory=t;this.startPoint=e;this.viewport=o;this.builder=t(e,o),this.points=[e];}builder;points;getBBox(){return this.builder.getBBox()}build(){return this.builder.build()}preview(t){this.builder.preview(t);}addPoint(t){this.points.push(t),this.builder.addPoint(t);}async autocorrectShape(){let t=this.viewport.canvasToScreen(this.startPoint.pos),e=this.points.map(C=>this.viewport.canvasToScreen(C.pos)),o=P.bboxOf(e),i=this.viewport.canvasToScreen(this.viewport.snapToGrid(this.startPoint.pos)),r=this.points.map(C=>this.viewport.canvasToScreen(this.viewport.snapToGrid(C.pos))),s=P.bboxOf(r);if(o.maxDimension<32)return null;let a=Math.min(30,o.maxDimension/4),l=[{...Mn(i,r),toleranceMultiplier:.5},Mn(t,e),{...Fn(i,r,s),toleranceMultiplier:.6},Fn(t,e,o)],d=(C=>{for(let k of l){let B=k.points,W=C*C*(k.toleranceMultiplier??1),ne=Se=>{for(;Se<0;)Se+=B.length;return Se%=B.length,B[Se]},Fe=null,Gr=1/0,qr=0;for(let[Se,et]of B.entries()){let Lt=et.squareDistanceTo(t);(!Fe||Lt<Gr)&&(Gr=Lt,Fe=et,qr=Se);}let yo=0,Ci=qr;for(let Se of e){let et=1/0,Lt=Ci,Zr=6;for(let Ti=-6;Ti<=Zr;Ti++){let vo=Ci+Ti,ms=ne(vo-1),_r=ne(vo),fs=ne(vo+1),gs=new Q(ms,_r),bs=new Q(_r,fs),ys=gs.distance(Se),vs=bs.distance(Se),jr=Math.min(ys,vs),Yr=jr*jr;Yr<et&&(et=Yr,Lt=vo);}if(Ci=Lt,yo=Math.max(et,yo),yo>W)break}if(yo<W)return B}return null})(a);if(!d)return null;let p=this.points[this.points.length-1],u=this.startPoint.width,h=p.width,m=this.startPoint.color,g=p.color,b=this.startPoint.time,v=p.time,f=C=>{let k=d[Math.max(0,Math.floor(C))],B=d[Math.min(Math.ceil(C),d.length-1)],W=k.lerp(B,C-Math.floor(C)),ne=C/d.length;return {pos:this.viewport.screenToCanvas(W),width:u*(1-ne)+h*ne,color:m.mix(g,ne),time:b*(1-ne)+v*ne}},x=this.sourceFactory(f(0),this.viewport),S=d.length<10;for(let C=0;C<d.length;C++)S&&x.addPoint(f(C-.001)),x.addPoint(f(C)),S&&x.addPoint(f(C+.001));return x.build()}};var Ke=class{constructor(t,e,o,i){this.startPoint=t;this.minFitAllowed=e;this.maxFitAllowed=o;this.onCurveAdded=i;this.lastPoint=this.startPoint,this.buffer=[this.startPoint.pos],this.momentum=exports.Vec2.zero,this.currentCurve=null,this.curveStartWidth=t.width,this.bbox=new P(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;buffer;lastPoint;lastExitingVec=null;currentCurve=null;curveStartWidth;curveEndWidth;momentum;bbox;getBBox(){return this.bbox}preview(){return this.currentCurve?this.currentSegmentToPath():null}approxCurrentCurveLength(){if(!this.currentCurve)return 0;let t=this.currentCurve.p0,e=this.currentCurve.p1,o=this.currentCurve.p2,i=t.distanceTo(e),r=o.distanceTo(e);return i+r}finalizeCurrentCurve(){if(!this.currentCurve)return;this.onCurveAdded(this.currentSegmentToPath());let t=this.buffer[this.buffer.length-1];this.lastExitingVec=this.currentCurve.p2.minus(this.currentCurve.p1),console.assert(this.lastExitingVec.magnitude()!==0,"lastExitingVec has zero length!"),this.buffer=[this.buffer[this.buffer.length-2],t],this.currentCurve=null,this.isFirstSegment=false;}currentSegmentToPath(){if(this.currentCurve==null)throw new Error("Invalid State: currentCurve is null!");let t=this.currentCurve.normal(0).normalized();if(!isFinite(t.magnitude()))throw new TypeError(`startVec(${t}) is NaN or \u221E`);let e=this.currentCurve.at(0),o=this.currentCurve.at(1),i=this.currentCurve.p1;return {startPoint:e,controlPoint:i,endPoint:o,startWidth:this.curveStartWidth,endWidth:this.curveEndWidth}}computeExitingVec(){return this.momentum.normalized().times(this.lastPoint.width/2)}addPoint(t){if(this.lastPoint){let x=t.time-this.lastPoint.time;if(t.pos.eq(this.lastPoint.pos,1e-10)||x===0)return;if(isNaN(t.pos.magnitude())){console.warn("Discarding NaN point.",t);return}let S=Math.min(this.lastPoint.width,t.width)/3;if(this.startPoint.pos.distanceTo(t.pos)<S&&this.isFirstSegment)return;let k=x/1e3,B=t.pos.minus(this.lastPoint.pos).times(1/k);this.momentum=B;}let e=this.lastPoint??t;this.lastPoint=t,this.buffer.push(t.pos);let o=t.width,i=this.curveEndWidth;if(this.curveEndWidth=o,this.bbox=this.bbox.grownToPoint(t.pos,o),this.currentCurve===null){let f=e.pos,x=e.pos.plus(this.lastExitingVec??exports.Vec2.unitX),S=t.pos;this.currentCurve=new me(f,x,S),console.assert(!isNaN(f.magnitude())&&!isNaN(x.magnitude())&&!isNaN(S.magnitude()),"Expected !NaN"),this.isFirstSegment?this.curveStartWidth=(this.curveStartWidth+o)/2:this.curveStartWidth=i;}let r=this.lastExitingVec;if(!r){let f=Math.ceil(this.buffer.length/2);(f===0||f>=this.buffer.length)&&(f=this.buffer.length-1),r=this.buffer[f].minus(this.buffer[0]);}let s=this.computeExitingVec(),a=1.7,l=this.buffer[0],c=t.pos,d=c.distanceTo(l),p=a*d;if(p===0||s.magnitude()===0||!isFinite(s.magnitude()))return;console.assert(isFinite(r.magnitude()),"Pre-normalized enteringVec has NaN or \u221E magnitude!"),r=r.normalized(),s=s.normalized(),console.assert(isFinite(r.magnitude()),"Normalized enteringVec has NaN or \u221E magnitude!");let u=new Q(l,l.plus(r.times(p))),m=new Q(c.minus(s.times(p)),c).intersection(u),g=null;m&&(g=m.point),g||(g=l.lerp(c,.5).lerp(l.plus(r.times(d)),.1)),(l.eq(g)||c.eq(g))&&(g=l.plus(r.times(d/5))),console.assert(!l.eq(g,1e-11),"Start and control points are equal!"),console.assert(!g.eq(c,1e-11),"Control and end points are equal!");let b=this.currentCurve;this.currentCurve=new me(l,g,c),isNaN(this.currentCurve.normal(0).magnitude())&&(console.error("NaN normal at 0. Curve:",this.currentCurve),this.currentCurve=b);let v=f=>{let x=Math.min(Math.max(Math.min(this.curveStartWidth,this.curveEndWidth)/4,this.minFitAllowed),this.maxFitAllowed),S=x,C=0;for(let k of this.buffer){let B=f.approximateDistance(k);if(B>x&&(B=f.distance(k),C+=Math.max(0,B-x),C>S))return  false}return  true};if(this.buffer.length>3&&this.approxCurrentCurveLength()>this.curveStartWidth/2&&!v(this.currentCurve)){this.currentCurve=b,this.curveEndWidth=i,this.lastPoint=e,this.finalizeCurrentCurve();return}}},Xs=Ke;var le=st((n,t)=>{let e=t.getSizeOfPixelOnCanvas()*3,o=t.getSizeOfPixelOnCanvas();return new Zo(n,o,e,t)}),Zo=class{constructor(t,e,o,i){this.startPoint=t;this.minFitAllowed=e;this.viewport=i;this.curveFitter=new Ke(t,e,o,r=>this.addCurve(r)),this.averageWidth=t.width,this.bbox=new P(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;parts=[];curveFitter;bbox;averageWidth;widthAverageNumSamples=1;getBBox(){return this.bbox}getRenderingStyle(){return {fill:w.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let e=[...this.parts.slice(),...this.curveToPathCommands(this.curveFitter.preview())];return {startPoint:this.startPoint.pos,commands:e,style:this.getRenderingStyle()}}previewFullPath(){let t=this.previewCurrentPath();return t?[t]:null}previewStroke(){let t=this.previewFullPath();return t?new D(t):null}preview(t){let e=this.previewFullPath();if(e){let o=this.viewport.visibleRect;t.startObject(o);for(let i of e)t.drawPath(i);t.endObject();}}build(){return this.curveFitter.finalizeCurrentCurve(),this.previewStroke()}getMinFit(){let t=Math.min(this.minFitAllowed,this.averageWidth/3);return t<1e-10&&(t=this.minFitAllowed),t}roundPoint(t){let e=this.getMinFit();return L.roundPoint(t,e)}roundDistance(t){let e=this.getMinFit();return L.roundPoint(t,e)}curveToPathCommands(t){if(!t){if(!this.isFirstSegment)return [];let o=L.roundPoint(this.averageWidth/10,Math.min(this.minFitAllowed,this.averageWidth/10)),i=this.roundPoint(this.startPoint.pos);return [{kind:3,controlPoint:i.plus(exports.Vec2.of(o,o)),endPoint:i.plus(exports.Vec2.of(0,o))},{kind:3,controlPoint:i.plus(exports.Vec2.of(-o,o)),endPoint:i.plus(exports.Vec2.of(-o,0))},{kind:3,controlPoint:i.plus(exports.Vec2.of(-o,-o)),endPoint:i.plus(exports.Vec2.of(0,-o))},{kind:3,controlPoint:i.plus(exports.Vec2.of(o,-o)),endPoint:i.plus(exports.Vec2.of(o,0))}]}let e=[];return this.isFirstSegment&&e.push({kind:1,point:this.roundPoint(t.startPoint)}),e.push({kind:3,controlPoint:this.roundPoint(t.controlPoint),endPoint:this.roundPoint(t.endPoint)}),e}addCurve(t){let e=this.curveToPathCommands(t);this.parts.push(...e),this.isFirstSegment&&(this.isFirstSegment=false);}addPoint(t){this.curveFitter.addPoint(t),this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+t.width/this.widthAverageNumSamples;}};var Te=st((n,t)=>{let e=t.getSizeOfPixelOnCanvas()*.65;return new _o(n,e,t)}),_o=class{constructor(t,e,o){this.minFitAllowed=e;this.viewport=o;this.averageWidth=t.width,this.startPoint={...t,pos:this.roundPoint(t.pos)},this.lastPoint=this.startPoint.pos,this.bbox=new P(this.startPoint.pos.x,this.startPoint.pos.y,0,0),this.parts=[{kind:1,point:this.startPoint.pos}];}parts=[];bbox;averageWidth;widthAverageNumSamples=1;lastPoint;startPoint;lastLineSegment=null;getBBox(){return this.bbox.grownBy(this.averageWidth)}getRenderingStyle(){return {fill:w.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){let t=this.startPoint.pos,e=[...this.parts];return e.length<=1&&e.push({kind:0,point:t.plus(exports.Vec2.of(this.averageWidth/4,0))}),{startPoint:t,commands:e,style:this.getRenderingStyle()}}previewFullPath(){return [this.previewCurrentPath()]}preview(t){let e=this.previewFullPath();if(e){let o=this.viewport.visibleRect;t.startObject(o);for(let i of e)t.drawPath(i);t.endObject();}}build(){return new D(this.previewFullPath())}getMinFit(){let t=Math.min(this.minFitAllowed,this.averageWidth/4);return t<1e-10&&(t=this.minFitAllowed),t}roundPoint(t){let e=this.getMinFit();return L.roundPoint(t,e)}roundDistance(t){let e=this.getMinFit();return L.roundPoint(t,e)}addPoint(t){this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+t.width/this.widthAverageNumSamples;let e=this.roundPoint(t.pos);e.eq(this.lastPoint)||(this.lastLineSegment&&this.lastLineSegment.direction.dot(e.minus(this.lastPoint).normalized())>.997&&(this.parts.pop(),this.lastPoint=this.lastLineSegment.p1),this.parts.push({kind:0,point:this.roundPoint(t.pos)}),this.bbox=this.bbox.grownToPoint(e),this.lastLineSegment=new Q(this.lastPoint,e),this.lastPoint=e);}};var ze=st((n,t)=>{let e=t.getSizeOfPixelOnCanvas()*3,o=t.getSizeOfPixelOnCanvas();return new jo(n,o,e,t)}),jo=class{constructor(t,e,o,i){this.startPoint=t;this.minFitAllowed=e;this.viewport=i;this.upperSegments=[],this.lowerSegments=[],this.curveFitter=new Ke(t,e,o,r=>this.addCurve(r)),this.curveStartWidth=t.width,this.bbox=new P(this.startPoint.pos.x,this.startPoint.pos.y,0,0);}isFirstSegment=true;pathStartConnector=null;mostRecentConnector=null;nextCurveStartConnector=null;upperSegments;lowerSegments;lastUpperBezier=null;lastLowerBezier=null;parts=[];curveFitter;curveStartWidth;bbox;getBBox(){return this.bbox}getRenderingStyle(){return {fill:this.startPoint.color??null}}previewCurrentPath(t=true){let e=this.upperSegments.slice(),o=this.lowerSegments.slice(),i,r,s=this.curveFitter.preview();if(s&&t){let{upperCurveCommand:c,lowerToUpperConnector:d,upperToLowerConnector:p,lowerCurveCommand:u}=this.segmentToPath(s);e.push(c),o.push(u),i=d,r=this.pathStartConnector??[p];}else {if(this.mostRecentConnector===null||this.pathStartConnector===null)return null;i=this.mostRecentConnector,r=this.pathStartConnector;}let a,l=o[o.length-1];return l.kind===0||l.kind===1?a=l.point:a=l.endPoint,{startPoint:a,commands:[i,...e.reverse(),...r,...o],style:this.getRenderingStyle()}}previewFullPath(){let t=this.previewCurrentPath();return t?[...this.parts,t]:null}preview(t){let e=this.previewFullPath();if(e){let o=this.viewport.visibleRect;t.startObject(o);for(let i of e)t.drawPath(i);t.endObject();}}build(){return this.curveFitter.finalizeCurrentCurve(),this.isFirstSegment&&this.addCurve(null),new D(this.previewFullPath())}roundPoint(t){let e=Math.min(this.minFitAllowed,this.curveStartWidth/3);return e<1e-10&&(e=this.minFitAllowed),L.roundPoint(t,e)}shouldStartNewSegment(t,e){if(!this.lastLowerBezier||!this.lastUpperBezier)return  false;let o=(l,c)=>{let d=l.intersectsBezier(c);return d.length===0?null:d[0].point},i=l=>l.p2.minus(l.p1).normalized(),r=l=>l.p1.minus(l.p0).normalized();if(r(e).dot(i(this.lastUpperBezier))<.35||r(t).dot(i(this.lastLowerBezier))<.35||r(e).dot(i(e))<0||r(t).dot(i(t))<0)return  true;let s=o(t,this.lastUpperBezier),a=o(e,this.lastLowerBezier);return !!(s||a)}addCurve(t){if(!t){if(!this.isFirstSegment)return;let d=L.roundPoint(this.startPoint.width/2.2,Math.min(this.minFitAllowed,this.startPoint.width/4)),p=this.roundPoint(this.startPoint.pos),u=this.startPoint.pos.plus(exports.Vec2.of(d,0));this.lowerSegments.push({kind:3,controlPoint:p.plus(exports.Vec2.of(d,d)),endPoint:p.plus(exports.Vec2.of(0,d))},{kind:3,controlPoint:p.plus(exports.Vec2.of(-d,d)),endPoint:p.plus(exports.Vec2.of(-d,0))},{kind:3,controlPoint:p.plus(exports.Vec2.of(-d,-d)),endPoint:p.plus(exports.Vec2.of(0,-d))},{kind:3,controlPoint:p.plus(exports.Vec2.of(d,-d)),endPoint:p.plus(exports.Vec2.of(d,0))});let h={kind:0,point:u};this.pathStartConnector=[h],this.mostRecentConnector=h;return}let{upperCurveCommand:e,lowerToUpperConnector:o,upperToLowerConnector:i,lowerCurveCommand:r,lowerCurve:s,upperCurve:a,nextCurveStartConnector:l}=this.segmentToPath(t),c=this.shouldStartNewSegment(s,a);if(c){let d=this.previewCurrentPath(false);d?(this.parts.push(d),this.upperSegments=[],this.lowerSegments=[]):c=false;}(this.isFirstSegment||c)&&(this.pathStartConnector=this.nextCurveStartConnector??[i],this.isFirstSegment=false),this.mostRecentConnector=o,this.nextCurveStartConnector=l,this.lowerSegments.push(r),this.upperSegments.push(e),this.lastLowerBezier=s,this.lastUpperBezier=a,this.curveStartWidth=t.startWidth;}segmentToPath(t){let e=new me(t.startPoint,t.controlPoint,t.endPoint),o=e.normal(0),i=e.normal(1);o=o.times(t.startWidth/2),i=i.times(t.endWidth/2),isFinite(o.magnitude())||(console.error("Warning: startVec is NaN or \u221E",o,i,t),o=i);let r=t.startPoint,s=t.endPoint,a=t.controlPoint,c=e.nearestPointTo(a).parameterValue,d=e.normal(c).times(t.startWidth/2*c+t.endWidth/2*(1-c)),p=this.roundPoint(r.plus(o)),u=this.roundPoint(a.plus(d)),h=this.roundPoint(s.plus(i)),m=this.roundPoint(a.minus(d)),g=this.roundPoint(s.minus(i)),b=this.roundPoint(r.minus(o)),v={kind:3,controlPoint:u,endPoint:h},f={kind:0,point:p},x={kind:0,point:g},S=[{kind:0,point:g},{kind:0,point:h}],C={kind:3,controlPoint:m,endPoint:b},k=new me(g,m,b),B=new me(p,u,h);return {upperCurveCommand:C,upperToLowerConnector:f,lowerToUpperConnector:x,lowerCurveCommand:v,upperCurve:k,lowerCurve:B,nextCurveStartConnector:S}}addPoint(t){this.curveFitter.addPoint(t);}};var Zt=O((n,t)=>new qt(n,true,t)),Xi=O((n,t)=>new qt(n,false,t)),qt=class{constructor(t,e,o){this.startPoint=t;this.filled=e;this.viewport=o;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.viewport.getRotationAngle(),e=T.zRotation(-t),o=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),i=e.inverse().transformVec2(this.startPoint.pos),r=e.inverse().transformVec2(this.endPoint.pos),s=P.fromCorners(i,r),a=R.fromRect(s,this.filled?null:this.endPoint.width).transformedBy(e).mapPoints(c=>this.viewport.roundPoint(c));return new D([z(a,{fill:this.endPoint.color,stroke:{width:o,color:o===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var _t=class n extends ee{constructor(e,o,i){super(e,o,"shape",i);this.tool=o;let r=e.getCurrentSettings().pens?.additionalPenTypes??[],s=e.getCurrentSettings().pens?.filterPenTypes??(()=>true);this.penTypes=[{name:this.localizationTable.filledSquare,id:"square",isShapeBuilder:true,factory:bn},{name:this.localizationTable.filledRectangle,id:"rectangle",isShapeBuilder:true,factory:Zt},{name:this.localizationTable.filledCircle,id:"circle",isShapeBuilder:true,factory:Dt},{name:this.localizationTable.filledTriangle,id:"triangle",isShapeBuilder:true,factory:vn},{name:this.localizationTable.filledHexagonal,id:"hexagonal",isShapeBuilder:true,factory:fn},{name:this.localizationTable.filledDiamond,id:"diamond",isShapeBuilder:true,factory:hn},{name:this.localizationTable.filledArrow,id:"arrow",isShapeBuilder:true,factory:Gt},{name:this.localizationTable.linePen,id:"line",isShapeBuilder:true,factory:jt},{name:this.localizationTable.linePen,id:"heart",isShapeBuilder:true,factory:mn},{name:this.localizationTable.linePen,id:"star",isShapeBuilder:true,factory:yn},{name:this.localizationTable.linePen,id:"cloud",isShapeBuilder:true,factory:un},{name:this.localizationTable.linePen,id:"parallelogram",isShapeBuilder:true,factory:gn},...r.filter(a=>a.isShapeBuilder)].filter(s),this.editor.notifier.on(2,a=>{if(a.kind!==2)throw new Error("Invalid event type!");a.tool===this.tool&&(this.updateIcon(),this.updateInputs());}),this.init();}updateInputs=()=>{};penTypes;static idCounter=0;penTypeSelect;getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){let e=this.tool.getStrokeFactory();for(let o=0;o<this.penTypes.length;o++)if(this.penTypes[o].factory===e)return o;return  -1}getCurrentPenType(){for(let e of this.penTypes)if(e.factory===this.tool.getStrokeFactory())return e;return null}createIconForRecord(e){let o={...this.tool.getStyleValue().get()};e?.factory&&(o.factory=e.factory);let i=e?.factory;return !i||i===le||i===ze||i===Te?this.editor.icons.makePenIcon(o):this.editor.icons.makeIconFromFactory(o)}init(){this.penTypeSelect=this.createPenTypeSelector(),this.penTypeSelect.setValue(1);}getPenTypeSelect(){return this.penTypeSelect}setShapeType(e){this.penTypeSelect.setValue(e);}createIcon(){return this.createIconForRecord(this.getCurrentPenType())}createPenTypeSelector(e){let i=this.penTypes.map((a,l)=>({id:l,makeIcon:()=>this.createIconForRecord(a),title:a.name,isShapeBuilder:a.isShapeBuilder??false})).filter(a=>a.isShapeBuilder),r=$t(this.localizationTable.selectShape,this.getCurrentPenTypeIdx(),i),s=a=>{this.tool.setStrokeFactory(this.penTypes[a].factory);};return r.value.onUpdate(s),e?.registerTextHelpForElements([r.getRootElement()],this.localizationTable.penDropdown__penTypeHelpText),{setValue:a=>{r.value.set(a);},updateIcons:()=>{r.updateIcons();},addTo:a=>{i.length>0&&r.addTo(a);}}}createStrokeCorrectionOptions(e){let o=document.createElement("div");o.classList.add("action-button-row",`${E}-pen-tool-toggle-buttons`);let i=(a,l)=>{let c=document.createElement("button");c.classList.add(`${E}-toggle-button`);let d=l.cloneNode(true);d.classList.add("icon");let p=document.createElement("span");p.innerText=a,c.replaceChildren(d,p),c.setAttribute("role","switch"),o.appendChild(c);let u=false,h=g=>{},m={setChecked(g){u=g,c.setAttribute("aria-checked",`${u}`),h(u);},setOnInputListener(g){h=g;},addHelpText(g){e?.registerTextHelpForElement(c,g);}};return c.addEventListener("click",()=>{m.setChecked(!u);}),m},r=i(this.localizationTable.inputStabilization,this.editor.icons.makeStrokeSmoothingIcon());r.setOnInputListener(a=>{this.tool.setHasStabilization(a);});let s=i(this.localizationTable.strokeAutocorrect,this.editor.icons.makeShapeAutocorrectIcon());return s.setOnInputListener(a=>{this.tool.setStrokeAutocorrectEnabled(a);}),s.addHelpText(this.localizationTable.penDropdown__autocorrectHelpText),r.addHelpText(this.localizationTable.penDropdown__stabilizationHelpText),{update:()=>{r.setChecked(!!this.tool.getInputMapper()),s.setChecked(this.tool.getStrokeAutocorrectionEnabled());},addTo:a=>{a.appendChild(o);}}}getHelpText(){return this.localizationTable.penDropdown__baseHelpText}fillDropdown(e,o){let i=document.createElement("div");i.classList.add(`${E}spacedList`,`${E}nonbutton-controls-main-list`);let{container:r,setValue:s}=rt(this.editor,m=>{this.tool.setThickness(m);}),a=document.createElement("div"),l=document.createElement("label"),c=be(this.editor,m=>{this.tool.setColor(m);}),{input:d,container:p}=c;d.id=`${E}colorInput${n.idCounter++}`,l.innerText=this.localizationTable.colorLabel,l.setAttribute("for",d.id),a.appendChild(l),a.appendChild(p);let u=this.createStrokeCorrectionOptions(o),h=this.createPenTypeSelector(o);return o?.registerTextHelpForElement(a,this.localizationTable.penDropdown__colorHelpText),o&&c.registerWithHelpTextDisplay(o),o?.registerTextHelpForElement(r,this.localizationTable.penDropdown__thicknessHelpText),this.updateInputs=()=>{c.setValue(this.tool.getColor()),s(this.tool.getThickness()),h.updateIcons(),h.setValue(this.getCurrentPenTypeIdx()),u.update();},this.updateInputs(),i.replaceChildren(a,r),h.addTo(i),e.replaceChildren(i),u.addTo(e),true}onKeyPress(e){if(!this.isSelected())return  false;for(let[o,i]of Kt.entries())if(this.editor.shortcuts.matchesShortcut(i,e)){let r=o;if(r<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[r].factory),true}return !!super.onKeyPress(e)}serializeState(){return {...super.serializeState(),color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:this.getCurrentPenType()?.id,inputStabilization:!!this.tool.getInputMapper(),strokeAutocorrect:this.tool.getStrokeAutocorrectionEnabled()}}deserializeFrom(e){super.deserializeFrom(e);let o=(i,r)=>{let s=typeof e[i];if(s!==r)throw new Error(`Deserializing property ${i}: Invalid type. Expected ${r}, was ${s}.`)};if(e.color&&(o("color","string"),this.tool.setColor(w.fromHex(e.color))),e.thickness&&(o("thickness","number"),this.tool.setThickness(e.thickness)),e.strokeFactoryId){o("strokeFactoryId","string");let i=e.strokeFactoryId;for(let r of this.penTypes)if(i===r.id){this.tool.setStrokeFactory(r.factory);break}}e.inputStabilization!==void 0&&this.tool.setHasStabilization(!!e.inputStabilization),e.strokeAutocorrect!==void 0&&this.tool.setStrokeAutocorrectEnabled(!!e.strokeAutocorrect);}};var ce=class{#e=null;constructor(){}setEmitListener(t){t&&typeof t=="object"?this.#e=e=>t.onEvent(e)??false:this.#e=t;}emit(t){return this.#e?.(t)??false}};function Qs(){return new Promise(n=>{requestAnimationFrame(()=>n());})}var we=Qs;var Js={kind:0,mass:.4,springConstant:100,frictionCoefficient:.28,maxPointDist:10,inertiaFraction:.75,minSimilarityToFinalize:0,velocityDecayFactor:.1},Qi=class{constructor(t,e,o){this.updatePointer=e;this.options=o;this.strokePoint=t,this.targetPoint=t,this.targetInterval=10,this.loop();}runLoop=true;lastUpdateTime=0;targetInterval;velocity;strokePoint;targetPoint;async loop(){for(this.lastUpdateTime=performance.now();this.runLoop;)this.update(false),await we();}setTarget(t){this.targetPoint=t;}getNextVelocity(t){let e=this.targetPoint.minus(this.strokePoint),o=e.times(this.options.springConstant),r=this.options.mass*10,s=this.velocity.normalizedOrZero().times(-this.options.frictionCoefficient*r),a=o.plus(s).times(1/this.options.mass),l=this.options.velocityDecayFactor,c=this.velocity.times(1-l).plus(a.times(t/1e3));return e.normalizedOrZero().times(c.length()).lerp(c,this.options.inertiaFraction)}update(t){let e=performance.now(),o=e-this.lastUpdateTime,i=this.strokePoint.eq(this.targetPoint);if(o>this.targetInterval||t){if(!i){let r,s,a=1;do r=this.getNextVelocity(o/a),s=r.times(o/1e3),a++;while(s.magnitude()>this.options.maxPointDist&&a<10);for(let l=0;l<a;l++)this.velocity=this.getNextVelocity(o/a),s=this.velocity.times(o/1e3),this.strokePoint=this.strokePoint.plus(s),l<a-1&&this.updatePointer(this.strokePoint,e);}if(this.lastUpdateTime=e,t||!i)return this.updatePointer(this.strokePoint,e)}return  false}finish(){this.runLoop=false;let t=this.targetPoint.minus(this.strokePoint);this.velocity.dot(t)>this.options.minSimilarityToFinalize&&this.updatePointer(this.targetPoint,performance.now());}cancel(){this.runLoop=false;}},Ge=class n extends ce{constructor(e,o=Js){super();this.viewport=e;this.options=o;}stabilizer=null;lastPointerEvent=null;mapPointerEvent(e){return Nt(e)&&e.kind!==2&&(this.lastPointerEvent=e),e.kind===3||e.allPointers.length>1||this.stabilizer===null?this.emit(e):(this.stabilizer.setTarget(e.current.screenPos),e.kind===1?this.stabilizer.update(true):e.kind===2?(this.stabilizer.finish(),this.emit(e)):this.emit(e))}emitPointerMove(e,o){if(!this.lastPointerEvent)return  false;let i=this.lastPointerEvent.current.withScreenPosition(e,this.viewport).withTimestamp(o),r={kind:1,current:i,allPointers:[i]};return this.emit(r)}onEvent(e){if(Nt(e)||e.kind===3){e.kind===0&&(this.stabilizer===null?this.stabilizer=new Qi(e.current.screenPos,(i,r)=>this.emitPointerMove(i,r),this.options):e.allPointers.length>1&&(this.stabilizer.cancel(),this.stabilizer=null));let o=this.mapPointerEvent(e);return (e.kind===2||e.kind===3)&&(this.stabilizer?.cancel(),this.stabilizer=null),o}return this.emit(e)}static fromEditor(e){return new n(e.viewport)}};var at="easydraw.tools.SelectionTool.selectAll";A.registerDefaultKeyboardShortcut(at,["CtrlOrMeta+KeyA"],"Select all");var Yo="easydraw.tools.SelectionTool.duplicateSelection";A.registerDefaultKeyboardShortcut(Yo,["CtrlOrMeta+KeyD"],"Duplicate selection");var Xo="easydraw.tools.SelectionTool.sendToBack";A.registerDefaultKeyboardShortcut(Xo,["End"],"Send to back");var Ji="easydraw.tools.SelectionTool.translateLeft";A.registerDefaultKeyboardShortcut(Ji,["KeyA","KeyH","ArrowLeft"],"Move selection left");var er="easydraw.tools.SelectionTool.translateRight";A.registerDefaultKeyboardShortcut(er,["KeyD","KeyL","ArrowRight"],"Move selection right");var tr="easydraw.tools.SelectionTool.translateUp";A.registerDefaultKeyboardShortcut(tr,["KeyQ","KeyK","ArrowUp"],"Move selection up");var or="easydraw.tools.SelectionTool.translateDown";A.registerDefaultKeyboardShortcut(or,["KeyE","KeyJ","ArrowDown"],"Move selection down");var ir="easydraw.tools.SelectionTool.rotateCCW";A.registerDefaultKeyboardShortcut(ir,["Shift+KeyR"],"Rotate selection counter clockwise");var rr="easydraw.tools.SelectionTool.rotateCW";A.registerDefaultKeyboardShortcut(rr,["KeyR"],"Rotate selection clockwise");var nr="easydraw.tools.SelectionTool.shrink.x";A.registerDefaultKeyboardShortcut(nr,["KeyI"],"Decrease width");var sr="easydraw.tools.SelectionTool.stretch.x";A.registerDefaultKeyboardShortcut(sr,["Shift+KeyI"],"Increase width");var ar="easydraw.tools.SelectionTool.shrink.y";A.registerDefaultKeyboardShortcut(ar,["KeyO"],"Decrease height");var lr="easydraw.tools.SelectionTool.stretch.y";A.registerDefaultKeyboardShortcut(lr,["Shift+KeyO"],"Increase height");var cr="easydraw.tools.SelectionTool.shrink.xy";A.registerDefaultKeyboardShortcut(cr,["Comma"],"Decrease selection size");var dr="easydraw.tools.SelectionTool.stretch.xy";A.registerDefaultKeyboardShortcut(dr,["Period"],"Increase selection size");var qe="easydraw.tools.undo",pr="easydraw.tools.redo";A.registerDefaultKeyboardShortcut(qe,["CtrlOrMeta+KeyZ"],"Undo");A.registerDefaultKeyboardShortcut(pr,["CtrlOrMeta+Shift+KeyZ","CtrlOrMeta+KeyY"],"Redo");var Ze="easydraw.tools.increaseSize";A.registerDefaultKeyboardShortcut(Ze,["Equal","Shift+Equal"],"Increase pen/eraser size");var _e="easydraw.tools.decreaseSize";A.registerDefaultKeyboardShortcut(_e,["Minus","Shift+Minus"],"Decrease pen/eraser size");var lt="easydraw.tools.snapToGrid";A.registerDefaultKeyboardShortcut(lt,["Control","Meta"],"Snap to grid (press and hold)");var ur="easydraw.tools.lockToLine";A.registerDefaultKeyboardShortcut(ur,["Shift"],"Snap to XY axes (press and hold)");var Qo="easydraw.tools.FindTool.toggleVisible";A.registerDefaultKeyboardShortcut(Qo,["CtrlOrMeta+KeyF"],"Shows/hides the find tool");var hr="easydraw.tools.PanZoom.moveLeft";A.registerDefaultKeyboardShortcut(hr,["ArrowLeft","KeyH","KeyA"],"Pan left");var mr="easydraw.tools.PanZoom.moveRight";A.registerDefaultKeyboardShortcut(mr,["ArrowRight","KeyL","KeyD"],"Pan right");var fr="easydraw.tools.PanZoom.moveUp";A.registerDefaultKeyboardShortcut(fr,["ArrowUp","KeyK","KeyQ"],"Pan up");var gr="easydraw.tools.PanZoom.moveDown";A.registerDefaultKeyboardShortcut(gr,["ArrowDown","KeyJ","KeyE"],"Pan down");var br="easydraw.tools.PanZoom.rotateViewClockwise";A.registerDefaultKeyboardShortcut(br,["Shift+KeyR"],"Rotate viewport clockwise");var yr="easydraw.tools.PanZoom.rotateViewCounterClockwise";A.registerDefaultKeyboardShortcut(yr,["KeyR"],"Rotate viewport counter-clockwise");var vr="easydraw.tools.PanZoom.zoomIn";A.registerDefaultKeyboardShortcut(vr,["KeyW"],"Zoom in");var xr="easydraw.tools.PanZoom.zoomOut";A.registerDefaultKeyboardShortcut(xr,["KeyS"],"Zoom out");var ct={maxSpeed:8.5,maxRadius:11,minTimeSeconds:.5},Pe=class{constructor(t,e,o){this.config=e;this.onStationary=o;this.stationaryStartPointer=t,this.lastPointer=t,this.averageVelocity=exports.Vec2.zero,this.setStationaryTimeout(this.config.minTimeSeconds*1e3);}stationaryStartPointer;lastPointer;averageVelocity;hasMovedOutOfRadius;timeout=null;onPointerMove(t){if(!this.stationaryStartPointer)return;if(t.id!==this.stationaryStartPointer.id)return  false;let e=t.screenPos.minus(this.lastPointer.screenPos),o=t.screenPos.minus(this.stationaryStartPointer.screenPos),i=(t.timeStamp-this.lastPointer.timeStamp)/1e3;i===0&&(i=1);let r=e.times(1/i);this.averageVelocity=this.averageVelocity.lerp(r,.5);let s=t.timeStamp-this.stationaryStartPointer.timeStamp,a=o.length()>this.config.maxRadius;if(this.hasMovedOutOfRadius||=a,a||this.averageVelocity.length()>this.config.maxSpeed||s<this.config.minTimeSeconds)return this.stationaryStartPointer=t,this.lastPointer=t,this.setStationaryTimeout(this.config.minTimeSeconds*1e3),false;let l=this.config.minTimeSeconds*1e3-s;return this.lastPointer=t,l<=0}onPointerUp(t){t.id!==this.stationaryStartPointer?.id&&this.cancelStationaryTimeout();}destroy(){this.cancelStationaryTimeout(),this.stationaryStartPointer=null;}getHasMovedOutOfRadius(){return this.hasMovedOutOfRadius}cancelStationaryTimeout(){this.timeout!==null&&(clearTimeout(this.timeout),this.timeout=null);}setStationaryTimeout(t){this.timeout===null&&(t<=0?this.onStationary(this.lastPointer):this.timeout=setTimeout(()=>{if(this.timeout=null,!this.stationaryStartPointer)return;let e=performance.now()-this.stationaryStartPointer.timeStamp,o=this.config.minTimeSeconds*1e3-e;o<=0?this.onStationary(this.lastPointer):this.setStationaryTimeout(o);},t));}};var Jo=(s=>(s[s.Pen=0]="Pen",s[s.Eraser=1]="Eraser",s[s.Touch=2]="Touch",s[s.PrimaryButtonMouse=3]="PrimaryButtonMouse",s[s.RightButtonMouse=4]="RightButtonMouse",s[s.Other=5]="Other",s))(Jo||{}),de=class n{constructor(t,e,o,i,r,s,a,l){this.screenPos=t;this.canvasPos=e;this.pressure=o;this.isPrimary=i;this.down=r;this.device=s;this.id=a;this.timeStamp=l;}snappedToGrid(t){let e=t.snapToGrid(this.canvasPos);return this.withCanvasPosition(e,t)}lockedToXYAxesScreen(t,e){let i=this.screenPos.minus(t),r=exports.Vec2.unitX.times(i.x),s=exports.Vec2.unitY.times(i.y),a;return i.dot(r)>i.dot(s)?a=r:a=s,a=a.plus(t),this.withScreenPosition(a,e)}withScreenPosition(t,e){let o=e.screenToCanvas(t);return this.withCanvasPosition(o,e)}withTimestamp(t){return new n(this.screenPos,this.canvasPos,this.pressure,this.isPrimary,this.down,this.device,this.id,t)}withCanvasPosition(t,e){let o=e.canvasToScreen(t);return new n(o,t,this.pressure,this.isPrimary,this.down,this.device,this.id,this.timeStamp)}static ofEvent(t,e,o,i){let r=exports.Vec2.of(t.clientX,t.clientY);if(i){let p=i.getBoundingClientRect();r=r.minus(exports.Vec2.of(p.left,p.top));}let a={mouse:3,pen:0,touch:2}[t.pointerType]??5;a===0&&(t.buttons&32)!==0&&(a=1);let c=t.timeStamp,d=o.roundPoint(o.screenToCanvas(r));return a===3&&t.buttons&2&&(a=4),new n(r,d,t.pressure??null,t.isPrimary,e,a,t.pointerId,c)}static ofCanvasPoint(t,e,o,i=0,r=0,s=true,a=null,l=null){let c=o.canvasToScreen(t);return l??=performance.now(),new n(c,t,a,s,e,r,i,l)}static ofScreenPoint(t,e,o,i=0,r=0,s=true,a=null,l=null){let c=o.screenToCanvas(t);return l??=performance.now(),new n(t,c,a,s,e,r,i,l)}};var je=class extends M{constructor(e,o,i){super(e.notifier,o);this.editor=e;this.styleValue=F.fromInitialValue({factory:le,color:w.black,borderColor:w.black,thickness:0,...i}),this.styleValue.onUpdateAndNow(r=>{this.style=r,this.noteUpdated();});}builder=null;lastPoint=null;startPoint=null;currentDeviceType=null;currentPointerId=null;styleValue;style;shapeAutocompletionEnabled=false;autocorrectedShape=null;lastAutocorrectedShape=null;removedAutocorrectedShapeTime=0;stationaryDetector=null;getPressureMultiplier(){let e=this.style.thickness;return 1/this.editor.viewport.getScaleFactor()*e}toStrokePoint(e){let i=Math.max(e.pressure??1,.3);return isFinite(i)||(console.warn("Non-finite pressure!",e),i=.3),console.assert(isFinite(e.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(e.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(e.timeStamp),"Non-finite timeStamp on pointer!"),{pos:e.canvasPos,width:i*this.getPressureMultiplier(),color:this.style.color,borderColor:this.style.borderColor,time:e.timeStamp}}previewStroke(){this.editor.clearWetInk();let e=this.editor.display.getWetInkRenderer();if(this.autocorrectedShape){let o=this.editor.viewport.visibleRect;this.autocorrectedShape.render(e,o);}else this.builder?.preview(e);}addPointToStroke(e){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(e),this.lastPoint=e,this.previewStroke();}onPointerDown(e){if(this.builder&&!this.eventCanCancelStroke(e))return  true;let{current:o,allPointers:i}=e,r=o.device===1,s=o.device===0;return i.length===1&&!r||s?(this.startPoint=this.toStrokePoint(o),this.builder=this.style.factory(this.startPoint,this.editor.viewport),this.currentDeviceType=o.device,this.currentPointerId=o.id,this.shapeAutocompletionEnabled?this.stationaryDetector=new Pe(o,ct,a=>this.autocorrectShape(a)):this.stationaryDetector=null,this.lastAutocorrectedShape=null,this.removedAutocorrectedShapeTime=0,true):false}eventCanCancelStroke(e){let o=this.lastPoint?.time??0;if(e.current.timeStamp-o>1e3)return  true;let i=this.currentDeviceType===0,r=e.current.device===2;return !(i&&r)}eventCanBeDeliveredToNonActiveTool(e){return this.eventCanCancelStroke(e)}onPointerMove({current:e}){if(!this.builder||e.device!==this.currentDeviceType||e.id!==this.currentPointerId)return;this.stationaryDetector?.onPointerMove(e)||(this.addPointToStroke(this.toStrokePoint(e)),this.autocorrectedShape&&(this.removedAutocorrectedShapeTime=performance.now(),this.autocorrectedShape=null,this.editor.announceForAccessibility(this.editor.localization.autocorrectionCanceled)));}onPointerUp({current:e}){if(!this.builder)return  false;if(e.id!==this.currentPointerId)return  true;this.stationaryDetector?.onPointerUp(e);let o=this.toStrokePoint(e),i={...o,width:this.lastPoint?.width??o.width};return this.addPointToStroke(i),this.finalizeStroke(),false}onGestureCancel(){this.builder=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}removedAutocorrectedShapeRecently(){return this.removedAutocorrectedShapeTime>performance.now()-320}async autocorrectShape(e){if(!this.builder||!this.builder.autocorrectShape||!this.shapeAutocompletionEnabled||this.autocorrectedShape)return;let o=await this.builder.autocorrectShape();if(!this.builder||!o)return;let i=o.getBBox().area;if(i===0||!isFinite(i))return;let r=o.description(this.editor.localization);this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(r)),this.autocorrectedShape=o,this.lastAutocorrectedShape=o,this.previewStroke();}finalizeStroke(){if(this.builder){this.lastAutocorrectedShape&&this.removedAutocorrectedShapeRecently()&&(this.autocorrectedShape=this.lastAutocorrectedShape);let e=this.autocorrectedShape??this.builder.build();if(this.previewStroke(),e.getBBox().area>0){e===this.autocorrectedShape&&this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(e.description(this.editor.localization)));let i=H.addComponent(e,true);this.editor.dispatch(i);}else console.warn("Pen: Not adding empty stroke",e,"to the canvas.");}this.builder=null,this.lastPoint=null,this.autocorrectedShape=null,this.lastAutocorrectedShape=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}noteUpdated(){this.editor.notifier.dispatch(2,{kind:2,tool:this});}setColor(e){e.toHexString()!==this.style.color.toHexString()&&this.styleValue.set({...this.style,color:e});}setBorderColor(e){e.toHexString()!==this.style.borderColor.toHexString()&&this.styleValue.set({...this.style,borderColor:e});}setThickness(e){e!==this.style.thickness&&this.styleValue.set({...this.style,thickness:e});}setStrokeFactory(e){e!==this.style.factory&&this.styleValue.set({...this.style,factory:e});}setHasStabilization(e){let o=!!this.getInputMapper();e!==o&&(o?this.setInputMapper(null):this.setInputMapper(new Ge(this.editor.viewport)),this.noteUpdated());}setStrokeAutocorrectEnabled(e){e!==this.shapeAutocompletionEnabled&&(this.shapeAutocompletionEnabled=e,this.noteUpdated());}getStrokeAutocorrectionEnabled(){return this.shapeAutocompletionEnabled}getThickness(){return this.style.thickness}getColor(){return this.style.color}getBorderColor(){return this.style.borderColor}getStrokeFactory(){return this.style.factory}getStyleValue(){return this.styleValue}onKeyPress(e){let o=this.editor.shortcuts,i=o.matchesShortcut(qe,e);if(this.builder&&i)return this.finalizeStroke(),false;let r;return o.matchesShortcut(_e,e)?r=this.getThickness()*2/3:o.matchesShortcut(Ze,e)&&(r=this.getThickness()*3/2),r!==void 0?(r=Math.min(Math.max(1,r),256),this.setThickness(r),true):false}};var ye=class extends _{constructor(e,o,i,r,s,a,l=false,c=true){super(e,o,a);this.makeIcon=i;this.title=r;this.clickAction=s;this.mustBeToplevel=l;this.#e=c;}#e;#t=void 0;setHelpText(e){this.#t=e;}getHelpText(){return this.#t}shouldAutoDisableInReadOnlyEditor(){return this.#e}handleClick(){this.clickAction();}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return  false}mustBeInToplevelMenu(){return this.mustBeToplevel}};var ei=(n,t)=>{if(t.length===0)return null;let e=t[0].description(n);for(let o of t)if(o.description(n)!==e)return null;return e};var U=class n extends V{toRemove;applied;constructor(t){super("erase"),this.toRemove=t.map(e=>e),this.applied=false;}apply(t){for(let e of this.toRemove){let o=t.image.findParent(e);o&&(o.remove(),t.image.onDestroyElement(e));}this.applied=true,t.queueRerender();}unapply(t){for(let e of this.toRemove)t.image.findParent(e)||H.addComponent(e).apply(t);this.applied=false,t.queueRerender();}onDrop(t){if(this.applied)for(let e of this.toRemove)t.image.onDestroyElement(e);}description(t,e){if(this.toRemove.length===0)return e.erasedNoElements;let o=ei(e,this.toRemove)??e.elements;return e.eraseAction(o,this.toRemove.length)}serializeToJSON(){return this.toRemove.map(e=>e.serialize())}static{V.register("erase",(t,e)=>{if(!Array.isArray(t))throw new TypeError("seralized erase data must be an array");let o=t.map(i=>{let r=typeof i=="string"?i:`${i.id}`;return e.image.lookupElement(r)??N.deserialize(i)});return new n(o)});}};function ea(n){if(n.some(t=>t&&t.then))return Promise.all(n).then(()=>{})}var Sr=ea;var ti=class extends fe{constructor(e,o,i){super();this.commands=e;this.applyChunkSize=o;this.descriptionOverride=i;}apply(e){if(this.applyChunkSize===void 0){let o=this.commands.map(i=>i.apply(e));return Sr(o)}else return e.asyncApplyCommands(this.commands,this.applyChunkSize)}unapply(e){let o=[...this.commands];if(o.reverse(),this.applyChunkSize===void 0){let i=o.map(r=>r.unapply(e));return Sr(i)}else return e.asyncUnapplyCommands(o,this.applyChunkSize,false)}onDrop(e){this.commands.forEach(o=>o.onDrop(e));}description(e,o){if(this.descriptionOverride)return this.descriptionOverride;let i=[],r=null,s=0,a=0;for(let l of this.commands){let c=l.description(e,o);if(c!==r&&r!==null&&(i.push(o.unionOf(r,s)),r=null,s=0),s++,a++,r??=c,i.length>12)break}return s>1?i.push(o.unionOf(r,s)):s===1&&i.push(r),a<this.commands.length&&i.push(o.andNMoreCommands(this.commands.length-a)),i.join(", ")}},Cr=class extends V{constructor(e,o,i){super("union");this.commands=e;this.applyChunkSize=o;this.descriptionOverride=i;this.nonserializableCommand=new ti(e,o,i);}nonserializableCommand;serializedData;serializeToJSON(){return this.serializedData?this.serializedData:{applyChunkSize:this.applyChunkSize,data:this.commands.map(e=>e.serialize()),description:this.descriptionOverride}}apply(e){return this.serializedData=this.serializeToJSON(),this.nonserializableCommand.apply(e)}unapply(e){return this.nonserializableCommand.unapply(e)}onDrop(e){this.nonserializableCommand.onDrop(e);}description(e,o){return this.nonserializableCommand.description(e,o)}};function On(n,t){let e=true;for(let r of n)if(!(r instanceof V)){e=false;break}let o,i;if(typeof t=="number"?o=t:(o=t?.applyChunkSize,i=t?.description),e){let r=n;return new Cr(r,o,i)}else return new ti(n,o,i)}V.register("union",(n,t)=>{if(typeof n.data.length!="number")throw new TypeError("Unions of commands must serialize to lists of serialization data.");let e=n.applyChunkSize;if(typeof e!="number"&&e!==void 0)throw new Error("serialized applyChunkSize is neither undefined nor a number.");let o=typeof n.description=="string"?n.description:void 0,i=[];for(let r of n.data)i.push(V.deserialize(r,t));return On(i,{applyChunkSize:e,description:o})});var j=On;var Yt=(i=>(i[i.SolidColor=0]="SolidColor",i[i.Grid=1]="Grid",i[i.None=2]="None",i[i.Dot=3]="Dot",i))(Yt||{}),dt="easydrawer-image-background",oi="easydrawer-image-background-grid-",Tr="easydrawer-image-background-non-automatic-secondary-color",wr={1:"easydrawer-image-background-grid",3:"easydrawer-image-background-dot",0:dt,2:""},Y=class n extends N{constructor(e,o){super("image-background",0);this.backgroundType=e;this.mainColor=o;this.contentBBox=P.empty;}contentBBox;viewportSizeChangeListener=null;autoresizeChangedListener=null;fillsScreen=false;gridSize=L.getGridSize(2);gridStrokeWidth=.7;secondaryColor=null;isRestylableComponent=true;static ofGrid(e,o,i,r){let s=new n(1,e);return o!==void 0&&(s.gridSize=o),i!==void 0&&(s.secondaryColor=i),r!==void 0&&(s.gridStrokeWidth=r),s}getBackgroundType(){return this.backgroundType}getMainColor(){return this.mainColor}getSecondaryColor(){return this.secondaryColor}getGridSize(){return this.gridSize}getStyle(){let e=this.mainColor;return this.backgroundType===2&&(e=void 0),{color:e}}updateStyle(e){return $e(this.getStyle(),e,this)}forceStyle(e,o){let i=e.color;i&&(this.mainColor=i,i.eq(w.transparent)&&this.backgroundType===0?this.backgroundType=2:this.backgroundType===2&&(this.backgroundType=0),o&&(o.image.queueRerenderOf(this),o.queueRerender()));}onAddToImage(e){this.viewportSizeChangeListener&&(console.warn("onAddToImage called when background is already in an image"),this.onRemoveFromImage()),this.viewportSizeChangeListener=e.notifier.on(0,()=>{this.recomputeBBox(e);}),this.autoresizeChangedListener=e.notifier.on(1,()=>{this.recomputeBBox(e);}),this.recomputeBBox(e);}onRemoveFromImage(){this.viewportSizeChangeListener?.remove(),this.autoresizeChangedListener?.remove(),this.viewportSizeChangeListener=null,this.autoresizeChangedListener=null;}recomputeBBox(e){let o=e.getImportExportViewport().visibleRect,i=false;this.contentBBox.eq(o)||(this.contentBBox=o,i||=!this.fillsScreen);let r=e.getAutoresizeEnabled();r!==this.fillsScreen&&(this.fillsScreen=r,i=true),i&&e.queueRerenderOf(this);}generateGridPath(e){let o=this.getFullBoundingBox(e),i=(e?.intersection(o)??o).grownBy(this.gridStrokeWidth/2),r=v=>Math.floor(v/this.gridSize)*this.gridSize,s=v=>Math.ceil(v/this.gridSize)*this.gridSize,a=s(i.y),l=r(i.y+i.h),c=s(i.x),d=r(i.x+i.w),p=[],u=(l-a)/this.gridSize,h=(d-c)/this.gridSize;if(u>1e3||h>1e3)return R.empty;let b=exports.Vec2.of(i.x,a);for(let v=a;v<=l;v+=this.gridSize)p.push({kind:1,point:exports.Vec2.of(i.x,v)}),p.push({kind:0,point:exports.Vec2.of(i.x+i.w,v)});for(let v=c;v<=d;v+=this.gridSize)p.push({kind:1,point:exports.Vec2.of(v,i.y)}),p.push({kind:0,point:exports.Vec2.of(v,i.y+i.h)});return new R(b,p)}generateDotPath(e){let o=this.getFullBoundingBox(e),i=(e?.intersection(o)??o).grownBy(this.gridStrokeWidth/2),r=v=>Math.floor(v/this.gridSize)*this.gridSize,s=v=>Math.ceil(v/this.gridSize)*this.gridSize,a=s(i.y),l=r(i.y+i.h),c=s(i.x),d=r(i.x+i.w),p=[],u=(l-a)/this.gridSize,h=(d-c)/this.gridSize;if(u>1e3||h>1e3)return R.empty;let b=exports.Vec2.of(i.x,a);for(let v=a;v<=l;v+=this.gridSize)for(let f=c;f<=d;f+=this.gridSize){exports.Vec2.of(f,v);let S=this.gridStrokeWidth;p.push({kind:1,point:exports.Vec2.of(f+S,v)}),p.push({kind:3,controlPoint:exports.Vec2.of(f+S,v-S*.55),endPoint:exports.Vec2.of(f,v-S)}),p.push({kind:3,controlPoint:exports.Vec2.of(f-S*.55,v-S),endPoint:exports.Vec2.of(f-S,v)}),p.push({kind:3,controlPoint:exports.Vec2.of(f-S,v+S*.55),endPoint:exports.Vec2.of(f,v+S)}),p.push({kind:3,controlPoint:exports.Vec2.of(f+S*.55,v+S),endPoint:exports.Vec2.of(f+S,v)});}return new R(b,p)}getFullBoundingBox(e){return (this.fillsScreen?e:this.contentBBox)??this.contentBBox}render(e,o){if(this.backgroundType===2)return;let i=!o;this.fillsScreen&&(o??=e.getVisibleRect());let r=this.backgroundType===1,s=this.getFullBoundingBox(o);if(e.startObject(s,r),this.backgroundType===0||this.backgroundType===1){let c=o?.intersection(s);c?e.fillRect(c,this.mainColor):i&&e.fillRect(s,this.mainColor);}if(this.backgroundType===1){let c=this.secondaryColor;c??=w.ofRGBA(1-this.mainColor.r,1-this.mainColor.g,1-this.mainColor.b,.2),this.mainColor.a===0&&(c=w.ofRGBA(.5,.5,.5,.2));let d={fill:w.transparent,stroke:{width:this.gridStrokeWidth,color:c}};e.drawPath(z(this.generateGridPath(o),d));}if(this.backgroundType===3){let c=this.secondaryColor;c??=w.ofRGBA(1-this.mainColor.r,1-this.mainColor.g,1-this.mainColor.b,.2),this.mainColor.a===0&&(c=w.fromHex("#cccccc"));let d={fill:c,stroke:{width:this.gridStrokeWidth,color:c}};e.drawPath(z(this.generateDotPath(o),d));}let a=wr[this.backgroundType],l=[dt];if(a!==dt){l.push(a);let c=J(this.gridSize).replace(/\./g,"p");l.push(oi+c);}this.secondaryColor!==null&&l.push(Tr),e.endObject(this.getLoadSaveData(),l);}intersects(e){return this.contentBBox.getEdges().some(o=>o.intersects(e))}isSelectable(){return  false}isBackground(){return  true}getSizingMode(){return this.fillsScreen?1:0}serializeToJSON(){return {mainColor:this.mainColor.toHexString(),secondaryColor:this.secondaryColor?.toHexString(),backgroundType:this.backgroundType,gridSize:this.gridSize,gridStrokeWidth:this.gridStrokeWidth}}applyTransformation(e){}description(e){return this.backgroundType===0?e.filledBackgroundWithColor(this.mainColor.toString()):this.backgroundType===2?e.emptyBackground:this.backgroundType===1?e.gridBackground:this.backgroundType===3?e.dotBackground:this.backgroundType}createClone(){return new n(this.backgroundType,this.mainColor)}static deserializeFromJSON(e){if(typeof e=="string"&&(e=JSON.parse(e)),typeof e.mainColor!="string")throw new TypeError("Error deserializing \u2014 mainColor must be of type string.");let o,i=e.backgroundType;if(i===2||i===1||i===3||i===0)o=i;else return i;let r=w.fromHex(e.mainColor),s=e.secondaryColor?w.fromHex(e.secondaryColor):null,a=e.gridSize??void 0,l=e.gridStrokeWidth??void 0,c=new n(o,r);return c.secondaryColor=s,a&&(c.gridSize=a),l&&(c.gridStrokeWidth=l),c}};N.registerComponent("image-background",Y.deserializeFromJSON);var pt=class n extends _{updateDropdownContent=()=>{};constructor(t,e){super(t,"document-properties-widget",e),this.container.classList.add("dropdownShowable"),this.editor.notifier.on(3,()=>{this.queueDropdownUpdate();}),this.editor.image.notifier.on(0,()=>{this.queueDropdownUpdate();});}getTitle(){return this.localizationTable.documentProperties}createIcon(){return this.editor.icons.makeConfigureDocumentIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible()),this.queueDropdownUpdate();}dropdownUpdateQueued=false;queueDropdownUpdate(){this.dropdownUpdateQueued||(requestAnimationFrame(()=>this.updateDropdown()),this.dropdownUpdateQueued=true);}updateDropdown(){this.dropdownUpdateQueued=false,this.isDropdownVisible()&&this.updateDropdownContent();}setBackgroundColor(t){this.editor.dispatch(this.editor.setBackgroundColor(t));}getBackgroundColor(){return this.editor.estimateBackgroundColor()}removeBackgroundComponents(){let t=[];for(let e of this.editor.image.getBackgroundComponents())e instanceof Y&&t.push(e);return new U(t)}setBackgroundType(t){let e=this.editor.estimateBackgroundColor(),o=new Y(t,e),i=this.editor.image.addComponent(o);return j([this.removeBackgroundComponents(),i])}getBackgroundType(){let t=this.editor.image.getBackgroundComponents();for(let e=t.length-1;e>=0;e--){let o=t[e];if(o instanceof Y)return o.getBackgroundType()}return 2}updateImportExportRectSize(t){let e=a=>(a!==void 0&&(!isFinite(a)||a<=0)&&(a=100),a),o=e(t.width),i=e(t.height),r=this.editor.getImportExportRect(),s=new P(r.x,r.y,o??r.w,i??r.h);this.editor.dispatch(this.editor.image.setImportExportRect(s)),this.editor.queueRerender();}getHelpText(){return this.localizationTable.pageDropdown__baseHelpText}setBackgroundGrid(){this.editor.dispatch(this.setBackgroundType(1)),this.editor.dispatch(this.editor.image.setAutoresizeEnabled(true));}setBackgroundDot(){this.editor.dispatch(this.setBackgroundType(3));}updateBackgroundColor(t){this.editor.dispatch(this.editor.setBackgroundColor(t));}setBackgroundSolid(){this.editor.dispatch(this.setBackgroundType(0)),this.editor.dispatch(this.editor.image.setAutoresizeEnabled(true));}removeBackground(){this.editor.dispatch(this.setBackgroundType(2));}static idCounter=0;fillDropdown(t,e){let o=document.createElement("div");o.classList.add(`${E}spacedList`,`${E}nonbutton-controls-main-list`,`${E}document-properties-widget`);let i=()=>{let v=document.createElement("div"),f=document.createElement("label");f.innerText=this.localizationTable.backgroundColor;let{input:x,container:S,setValue:C,registerWithHelpTextDisplay:k}=be(this.editor,W=>{W.eq(this.getBackgroundColor())||this.setBackgroundColor(W);});return x.id=`${E}docPropertiesColorInput-${n.idCounter++}`,f.htmlFor=x.id,v.replaceChildren(f,S),{setBgColorInputValue:C,backgroundColorRow:v,registerWithHelp:W=>{W&&(W?.registerTextHelpForElement(v,this.localizationTable.pageDropdown__backgroundColorHelpText),k(W));}}},{backgroundColorRow:r,setBgColorInputValue:s,registerWithHelp:a}=i(),l=(v,f)=>{let x=document.createElement("div"),S=document.createElement("label"),C=document.createElement("input");return C.id=`${E}docPropertiesCheckbox-${n.idCounter++}`,S.htmlFor=C.id,C.type="checkbox",S.innerText=v,C.addEventListener("input",()=>{f(C.checked);}),x.replaceChildren(S,C),{container:x,checkbox:C}},{container:c,checkbox:d}=l(this.localizationTable.useGridOption,v=>{if(this.getBackgroundType()===1===v)return;let S=0;v&&(S=1),this.editor.dispatch(this.setBackgroundType(S));}),p=(v,f)=>{let x=document.createElement("div"),S=document.createElement("label"),C=document.createElement("input");return S.innerText=v,C.type="number",C.min="0",C.id=`${E}docPropertiesDimensionRow-${n.idCounter++}`,S.htmlFor=C.id,C.style.flexGrow="2",C.style.width="25px",C.addEventListener("input",()=>{f(Number.parseFloat(C.value));}),x.classList.add("easydrawer-size-input-row"),x.replaceChildren(S,C),{setValue:k=>{if(document.activeElement===C&&/^0*$/.test(C.value)){let B=C.value;C.type="text",C.value=k.toString();let W=Math.max(1,C.value.length-B.length);C.setSelectionRange(0,W),C.type="number";}else C.value=k.toString();},setIsAutomaticSize:k=>{C.disabled=k;let B="size-input-row--automatic-size";k?x.classList.add(B):x.classList.remove(B);},element:x}},u=p(this.localizationTable.imageWidthOption,v=>{this.updateImportExportRectSize({width:v});}),h=p(this.localizationTable.imageHeightOption,v=>{this.updateImportExportRectSize({height:v});}),{container:m,checkbox:g}=l(this.localizationTable.enableAutoresizeOption,v=>{let f=this.editor.image;this.editor.dispatch(f.setAutoresizeEnabled(v));}),b=document.createElement("button");return b.classList.add("about-button"),b.innerText=this.localizationTable.about,b.addEventListener("click",()=>{this.editor.showAboutDialog();}),a(e),e?.registerTextHelpForElement(c,this.localizationTable.pageDropdown__gridCheckboxHelpText),e?.registerTextHelpForElement(m,this.localizationTable.pageDropdown__autoresizeCheckboxHelpText),e?.registerTextHelpForElement(b,this.localizationTable.pageDropdown__aboutButtonHelpText),this.updateDropdownContent=()=>{s(this.getBackgroundColor());let v=this.editor.image.getAutoresizeEnabled(),f=this.editor.getImportExportRect();u.setValue(f.width),h.setValue(f.height),g.checked=v,u.setIsAutomaticSize(v),h.setIsAutomaticSize(v),d.checked=this.getBackgroundType()===1;},this.updateDropdownContent(),o.replaceChildren(r,c,u.element,h.element,m,b),t.replaceChildren(o),true}};var ii=(e=>(e.PartialStroke="partial-stroke",e.FullStroke="full-stroke",e))(ii||{}),Pr=class extends M{constructor(e,o){super(e.notifier,e.localization.changeTool);this.editor=e;this.eraser=o;}previousEnabledTool;previousEraserEnabledState;onPointerDown(e){if(e.allPointers.length===1&&e.current.device===1){let i=this.editor.toolController.getPrimaryTools().filter(r=>r.isEnabled());if(i.length>0?this.previousEnabledTool=i[0]:this.previousEnabledTool=null,this.previousEraserEnabledState=this.eraser.isEnabled(),this.eraser.setEnabled(true),this.eraser.onPointerDown(e))return  true;this.restoreOriginalTool();}return  false}onPointerMove(e){this.eraser.onPointerMove(e);}restoreOriginalTool(){this.eraser.setEnabled(this.previousEraserEnabledState),this.previousEnabledTool&&this.previousEnabledTool.setEnabled(true);}onPointerUp(e){this.eraser.onPointerUp(e),this.restoreOriginalTool();}onGestureCancel(e){this.eraser.onGestureCancel(e),this.restoreOriginalTool();}},Ae=class extends M{constructor(e,o,i){super(e.notifier,o);this.editor=e;this.thickness=i?.thickness??10,this.thicknessValue=F.fromInitialValue(this.thickness),this.thicknessValue.onUpdate(r=>{this.thickness=r,this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.modeValue=F.fromInitialValue(i?.mode??"full-stroke"),this.modeValue.onUpdate(r=>{this.editor.notifier.dispatch(2,{kind:2,tool:this});});}lastPoint=null;isFirstEraseEvt=true;thickness;thicknessValue;modeValue;toRemove;toAdd=new Set;eraseCommands=[];addCommands=[];makeEraserSwitcherTool(){return new Pr(this.editor,this)}clearPreview(){this.editor.clearWetInk();}getSizeOnCanvas(){return this.thickness/this.editor.viewport.getScaleFactor()}drawPreviewAt(e){this.clearPreview();let o=this.getSizeOnCanvas(),i=this.editor.display.getWetInkRenderer(),r=this.getEraserRect(e),s=this.getEraserRect(this.lastPoint??e),a={fill:w.gray,stroke:{width:o/10,color:w.blue}};i.drawPath(z(R.fromConvexHullOf([...r.corners,...s.corners]),a));}getEraserRect(e){let o=this.getSizeOnCanvas(),i=exports.Vec2.of(o/2,o/2);return P.fromCorners(e.minus(i),e.plus(i))}eraseTo(e){if(!this.isFirstEraseEvt&&e.distanceTo(this.lastPoint)===0)return;this.isFirstEraseEvt=false;let o=this.getEraserRect(e),i=new Q(this.lastPoint,e),r=P.union(i.bbox,o),a=this.editor.image.getComponentsIntersecting(r).filter(l=>l.intersects(i)||l.intersectsRect(o)).filter(l=>l.isSelectable());if(this.modeValue.get()==="full-stroke"){this.toRemove.push(...a);let l=a.map(c=>new U([c]));l.forEach(c=>c.apply(this.editor)),this.eraseCommands.push(...l);}else {let l=[],c=[];for(let h of a){if(l.push(h),!h.withRegionErased||o.grownBy(o.maxDimension/3).containsRect(h.getExactBBox()))continue;let g=R.fromConvexHullOf([...o.corners,...this.getEraserRect(this.lastPoint??e).corners].map(b=>this.editor.viewport.roundPoint(b)));c.push(...h.withRegionErased(g,this.editor.viewport));}let d=new U(l),p=c.map(h=>H.addComponent(h));d.apply(this.editor),p.forEach(h=>h.apply(this.editor));let u=[];for(let h of l)this.toAdd.has(h)?this.toAdd.delete(h):u.push(h);this.toRemove.push(...u);for(let h of c)this.toAdd.add(h);this.eraseCommands.push(new U(u)),this.addCommands.push(...p);}this.drawPreviewAt(e),this.lastPoint=e;}onPointerDown(e){return e.allPointers.length===1||e.current.device===1?(this.lastPoint=e.current.canvasPos,this.toRemove=[],this.toAdd.clear(),this.isFirstEraseEvt=true,this.drawPreviewAt(e.current.canvasPos),true):false}onPointerMove(e){let o=e.current.canvasPos;this.eraseTo(o);}onPointerUp(e){this.eraseTo(e.current.canvasPos);let o=[];if(this.addCommands.length>0){this.addCommands.forEach(i=>i.unapply(this.editor));for(let i of this.toAdd)this.toRemove.includes(i)&&(this.toAdd.delete(i),this.toRemove=this.toRemove.filter(r=>r!==i));for(let i of this.toRemove)this.toAdd.has(i)&&(this.toAdd.delete(i),this.toRemove=this.toRemove.filter(r=>r!==i));o.push(...[...this.toAdd].map(i=>H.addComponent(i))),this.addCommands=[];}if(this.eraseCommands.length>0){this.eraseCommands.forEach(r=>r.unapply(this.editor)),this.eraseCommands=[];let i=new U(this.toRemove);o.push(i);}o.length===1?this.editor.dispatch(o[0]):this.editor.dispatch(j(o)),this.clearPreview();}onGestureCancel(e){this.addCommands.forEach(o=>o.unapply(this.editor)),this.eraseCommands.forEach(o=>o.unapply(this.editor)),this.eraseCommands=[],this.addCommands=[],this.clearPreview();}onKeyPress(e){let o=this.editor.shortcuts,i;return o.matchesShortcut(_e,e)?i=this.getThickness()*2/3:o.matchesShortcut(Ze,e)&&(i=this.getThickness()*3/2),i!==void 0?(i=Math.min(Math.max(1,i),200),this.setThickness(i),true):false}getThickness(){return this.thickness}setThickness(e){this.thicknessValue.set(e);}getThicknessValue(){return this.thicknessValue}getModeValue(){return this.modeValue}};var ut=class n extends ee{constructor(e,o,i){super(e,o,"eraser-tool-widget",i);this.tool=o;this.editor.notifier.on(2,r=>{r.kind===2&&r.tool===this.tool&&(this.updateInputs(),this.updateIcon());});}updateInputs=()=>{};getHelpText(){return this.localizationTable.eraserDropdown__baseHelpText}getTitle(){return this.localizationTable.eraser}makeIconForType(e){return this.editor.icons.makeEraserIcon(this.tool.getThickness(),e)}createIcon(){return this.makeIconForType(this.tool.getModeValue().get())}static idCounter=0;makeEraserTypeSelector(e){let o=document.createElement("div"),i=document.createElement("label"),r=document.createElement("input");r.id=`${E}eraserToolWidget-${n.idCounter++}`,i.htmlFor=r.id,i.innerText=this.localizationTable.fullStrokeEraser,r.type="checkbox",r.addEventListener("input",()=>{this.tool.getModeValue().set(r.checked?"full-stroke":"partial-stroke");});let s=()=>{r.checked=this.tool.getModeValue().get()==="full-stroke";};return o.replaceChildren(i,r),e?.registerTextHelpForElement(o,this.localizationTable.eraserDropdown__fullStrokeEraserHelpText),{addTo:a=>{a.appendChild(o);},updateValue:s}}fillDropdown(e,o){let i=document.createElement("div");i.classList.add(`${E}spacedList`,`${E}nonbutton-controls-main-list`);let r=rt(this.editor,a=>{this.tool.setThickness(a);});r.setBounds(10,55),o?.registerTextHelpForElement(r.container,this.localizationTable.eraserDropdown__thicknessHelpText);let s=this.makeEraserTypeSelector(o);return this.updateInputs=()=>{r.setValue(this.tool.getThickness()),s.updateValue();},this.updateInputs(),i.replaceChildren(r.container),s.addTo(i),e.replaceChildren(i),true}serializeState(){return {...super.serializeState(),thickness:this.tool.getThickness(),mode:this.tool.getModeValue().get()}}deserializeFrom(e){if(super.deserializeFrom(e),e.thickness){let o=Number.parseFloat(e.thickness);if(typeof o!="number"||!isFinite(o))throw new TypeError(`Deserializing property ${o} is not a number or is not finite.`);this.tool.setThickness(o);}if(e.mode){let o=e.mode;Object.values(ii).includes(o)&&this.tool.getModeValue().set(o);}}};var Er=class extends ye{constructor(t,e,o,i={}){super(t,"exit-button",()=>i.icon??t.icons.makeCloseIcon(),i.label??e.exit,o),this.setTags(["exit"]);}shouldAutoDisableInReadOnlyEditor(){return  false}onKeyPress(t){return this.editor.shortcuts.matchesShortcut(ji,t)?(this.clickAction(),true):super.onKeyPress(t)}mustBeInToplevelMenu(){return  true}},Hn=Er;function ta(n=""){let t=document.createElement("div");return t.classList.add("tool-dropdown-separator"),t.innerText=n,{addTo:e=>{e.appendChild(t);}}}var Xt=ta;var ri=(s=>(s[s.OneFingerTouchGestures=1]="OneFingerTouchGestures",s[s.TwoFingerTouchGestures=2]="TwoFingerTouchGestures",s[s.RightClickDrags=4]="RightClickDrags",s[s.SinglePointerGestures=8]="SinglePointerGestures",s[s.Keyboard=16]="Keyboard",s[s.RotationLocked=32]="RotationLocked",s))(ri||{}),Ir=class{constructor(t,e,o){this.initialVelocity=t;this.scrollBy=e;this.onComplete=o;this.start();}running=false;currentVelocity;async start(){if(this.running)return;this.currentVelocity=this.initialVelocity;let t=performance.now();this.running=true;let e=5e3,o=200;for(this.currentVelocity.magnitude()>e&&(this.currentVelocity=this.currentVelocity.normalized().times(e));this.running&&this.currentVelocity.magnitude()>o;){let i=performance.now(),r=(i-t)/1e3;this.currentVelocity=this.currentVelocity.times(Math.pow(1/8,r)),this.scrollBy(this.currentVelocity.times(r)),await we(),t=i;}this.running&&this.stop();}getCurrentVelocity(){return this.running?this.currentVelocity:null}stop(){this.running&&(this.running=false,this.onComplete());}},ae=class extends M{constructor(e,o,i){super(e.notifier,i);this.editor=e;this.mode=o;}transform=null;initialRotationSnapAngle=.22;afterRotationStartSnapAngle=.07;pinchZoomStartThreshold=1.08;startTouchDist;lastTouchDist;lastScreenCenter;lastTimestamp;lastPointerDownTimestamp=0;initialTouchAngle=0;initialViewportRotation=0;initialViewportScale=0;isScaling=false;isRotating=false;inertialScroller=null;velocity=null;canReceiveInputInReadOnlyEditor(){return  true}computePinchData(e,o){if(e.id<o.id){let c=e;e=o,o=c;}let i=o.screenPos.minus(e.screenPos),r=i.angle(),s=i.magnitude(),a=o.canvasPos.plus(e.canvasPos).times(.5),l=o.screenPos.plus(e.screenPos).times(.5);return {canvasCenter:a,screenCenter:l,angle:r,dist:s}}allPointersAreOfType(e,o){return e.every(i=>i.device===o)}onPointerDown({allPointers:e,current:o}){let i=false,r=this.inertialScroller?.getCurrentVelocity()??exports.Vec2.zero;this.inertialScroller?.stop(),this.velocity=r,this.lastPointerDownTimestamp=o.timeStamp;let s=this.allPointersAreOfType(e,2),a=this.allPointersAreOfType(e,4);if(s&&e.length===2&&this.mode&2){let{screenCenter:l,angle:c,dist:d}=this.computePinchData(e[0],e[1]);this.lastTouchDist=d,this.startTouchDist=d,this.lastScreenCenter=l,this.initialTouchAngle=c,this.initialViewportRotation=this.editor.viewport.getRotationAngle(),this.initialViewportScale=this.editor.viewport.getScaleFactor(),this.isScaling=false,this.isRotating=Math.abs(Math.sin(this.initialViewportRotation*2))>.001,i=true;}else e.length===1&&(this.mode&1&&s||a&&this.mode&4||this.mode&8)&&(this.lastScreenCenter=e[0].screenPos,this.isScaling=false,i=true);return i&&(this.lastTimestamp=performance.now(),this.transform??=se.transformBy(T.identity),this.editor.display.setDraftMode(true)),i}updateVelocity(e){let o=e.minus(this.lastScreenCenter),i=(performance.now()-this.lastTimestamp)/1e3;if(o.magnitude()===0&&i<.1||i===0)return;i=Math.max(i,.01);let r=o.times(1/i),s=r;this.velocity&&(s=this.velocity.lerp(r,.5)),this.velocity=s;}getCenterDelta(e){return this.editor.viewport.screenToCanvasTransform.transformVec3(e.minus(this.lastScreenCenter))}toSnappedRotationDelta(e){let i=e-this.initialTouchAngle+this.initialViewportRotation,r=Math.PI/2,s=Math.round(i/r)*r,a=this.isRotating?this.afterRotationStartSnapAngle:this.initialRotationSnapAngle;return Math.abs(i-s)<a&&(i=s,i!==0&&(i+=1e-4)),i-this.editor.viewport.getRotationAngle()}toSnappedScaleFactor(e){let o=this.initialViewportScale*e/this.startTouchDist,i=this.editor.viewport.getScaleFactor(),r=Math.log(o)/Math.log(10),s=Math.round(r);return Math.abs(s-r)<.04?Math.pow(10,s)/i:e/this.lastTouchDist}handleTwoFingerMove(e){let{screenCenter:o,canvasCenter:i,angle:r,dist:s}=this.computePinchData(e[0],e[1]),a=this.getCenterDelta(o),l;if(this.isRotationLocked()?l=0:l=this.toSnappedRotationDelta(r),Math.abs(l)>1e-8&&(this.isRotating=true),this.updateVelocity(o),!this.isScaling){let p=s/this.startTouchDist,u=this.pinchZoomStartThreshold,h=1/this.pinchZoomStartThreshold;(p>u||p<h)&&(this.isScaling=true);}let c=1;this.isScaling&&(c=this.toSnappedScaleFactor(s),this.lastTouchDist=s);let d=T.translation(a).rightMul(T.scaling2D(c,i)).rightMul(T.zRotation(l,i));return this.lastScreenCenter=o,this.transform=se.transformBy(this.transform.transform.rightMul(d)),d}handleOneFingerMove(e){let o=this.getCenterDelta(e.screenPos),i=T.translation(o);return this.transform=se.transformBy(this.transform.transform.rightMul(i)),this.updateVelocity(e.screenPos),this.lastScreenCenter=e.screenPos,i}onPointerMove({allPointers:e}){this.transform??=se.transformBy(T.identity);let o=T.identity;e.length===2?o=this.handleTwoFingerMove(e):e.length===1&&(o=this.handleOneFingerMove(e[0])),se.transformBy(o).apply(this.editor),this.lastTimestamp=performance.now();}onPointerUp(e){let o=()=>{this.transform&&(this.transform.unapply(this.editor),this.editor.dispatch(this.transform,false)),this.editor.display.setDraftMode(false),this.transform=null,this.velocity=exports.Vec2.zero;};if(e.current.device===2&&e.allPointers.length===1&&this.velocity!==null&&e.current.timeStamp-this.lastPointerDownTimestamp>30&&this.velocity!==null){let s=this.velocity;this.updateVelocity(e.current.screenPos),s.magnitude()<this.velocity.magnitude()&&(this.velocity=s),this.inertialScroller?.stop(),this.inertialScroller=new Ir(this.velocity,a=>{if(!this.transform)return;let l=this.editor.viewport.screenToCanvasTransform.transformVec3(a);this.transform.unapply(this.editor),this.transform=se.transformBy(this.transform.transform.rightMul(T.translation(l))),this.transform.apply(this.editor);},o);}else o();}onGestureCancel(){this.inertialScroller?.stop(),this.velocity=exports.Vec2.zero,this.transform?.unapply(this.editor),this.editor.display.setDraftMode(false),this.transform=null;}updateTransform(e,o=false){let i=e;this.transform&&(i=this.transform.transform.rightMul(e)),this.transform?.unapply(this.editor),this.transform=se.transformBy(i),this.transform.apply(this.editor),o&&this.editor.announceForAccessibility(this.transform.description(this.editor,this.editor.localization));}applyAndFinalizeTransform(e){this.updateTransform(e,true),this.transform=null;}onWheel({delta:e,screenPos:o}){this.inertialScroller?.stop(),this.transform=se.transformBy(T.identity);let i=this.editor.viewport.screenToCanvas(o),s=this.editor.viewport.screenToCanvasTransform.transformVec3(exports.Vec3.of(-e.x,-e.y,0)),a=e.z;a=Math.atan(a/2)*2;let c=T.scaling2D(Math.max(.4,Math.min(Math.pow(1.04,-a),4)),i).rightMul(T.translation(s));return this.applyAndFinalizeTransform(c),true}onKeyPress(e){if(this.inertialScroller?.stop(),!(this.mode&16))return  false;this.transform=se.transformBy(T.identity);let o=exports.Vec2.zero,i=1,r=0,s=this.editor.shortcuts;if(s.matchesShortcut(hr,e))o=exports.Vec2.of(-1,0);else if(s.matchesShortcut(mr,e))o=exports.Vec2.of(1,0);else if(s.matchesShortcut(fr,e))o=exports.Vec2.of(0,-1);else if(s.matchesShortcut(gr,e))o=exports.Vec2.of(0,1);else if(s.matchesShortcut(vr,e))i=1/2;else if(s.matchesShortcut(xr,e))i=2;else if(s.matchesShortcut(br,e))r=1;else if(s.matchesShortcut(yr,e))r=-1;else return  false;o=o.times(30),r*=Math.PI/8,o=o.times(-1),r=r*-1,i=1/i,r!==0&&(r+=1e-4),this.isRotationLocked()&&(r=0),o=this.editor.viewport.screenToCanvasTransform.transformVec3(o);let l=this.editor.viewport.visibleRect.center,c=T.scaling2D(i,l).rightMul(T.zRotation(r,l)).rightMul(T.translation(o));return this.applyAndFinalizeTransform(c),true}isRotationLocked(){return !!(this.mode&32)}setModeEnabled(e,o){let i=this.mode;o?i|=e:i&=~e,this.setMode(i);}setMode(e){e!==this.mode&&(this.mode=e,this.editor.notifier.dispatch(2,{kind:2,tool:this}));}getMode(){return this.mode}};function oa(n,t,e){let o=document.createElement("div"),i=document.createElement("button"),r=document.createElement("button"),s=document.createElement("button"),a=document.createElement("span");i.innerText="+",r.innerText="-",s.innerText=n.resetView,o.replaceChildren(a,i,r,s),o.classList.add(`${E}zoomLevelEditor`),a.classList.add("zoomDisplay");let l,c=()=>{let p=t.viewport.getScaleFactor()*100;p>.1?p=Math.round(p*10)/10:p=Math.round(p*1e3)/1e3,p!==l&&(a.textContent=n.zoomLevel(p),l=p);};c(),t.notifier.on(7,p=>{p.kind===7&&(c(),s.disabled=p.newTransform.eq(T.identity));});let d=p=>{let u=t.viewport.visibleRect.center,h=T.scaling2D(p,u);t.dispatch(L.transformBy(h),false);};return i.addEventListener("click",()=>{d(5/4);}),r.addEventListener("click",()=>{d(4/5);}),s.addEventListener("click",()=>{t.dispatch(L.transformBy(t.viewport.canvasToScreenTransform.inverse()),false);}),e?.registerTextHelpForElement(i,n.handDropdown__zoomInHelpText),e?.registerTextHelpForElement(r,n.handDropdown__zoomOutHelpText),e?.registerTextHelpForElement(s,n.handDropdown__resetViewHelpText),e?.registerTextHelpForElement(a,n.handDropdown__zoomDisplayHelpText),o}var ni=class extends _{constructor(e,o,i,r,s,a,l){super(e,`pan-mode-${i}`,l);this.tool=o;this.flag=i;this.makeIcon=r;this.title=s;this.helpText=a;e.notifier.on(2,c=>{if(c.kind===2&&c.tool===o){let d=!!(o.getMode()&8);this.setSelected(!!(o.getMode()&i)||d),this.setDisabled(d&&i!==8);}}),this.setSelected(false);}shouldAutoDisableInReadOnlyEditor(){return  false}setModeFlag(e){this.tool.setModeEnabled(this.flag,e);}handleClick(){this.setModeFlag(!this.isSelected());}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(e){return  false}getHelpText(){return this.helpText}},ht=class n extends ee{allowTogglingBaseTool;overridePanZoomTool;constructor(t,e,o){let i=t.toolController.getPrimaryTools().includes(e),r=(i?e:n.getPrimaryHandTool(t.toolController))??e;super(t,r,"hand-tool-widget",o),this.overridePanZoomTool=(i?n.getOverrideHandTool(t.toolController):e)??e,this.allowTogglingBaseTool=r!==null,this.allowTogglingBaseTool||this.container.classList.add("dropdownShowable");let s=new ni(t,this.overridePanZoomTool,1,()=>this.editor.icons.makeTouchPanningIcon(),o.touchPanning,o.handDropdown__touchPanningHelpText,o),a=new ni(t,this.overridePanZoomTool,32,()=>this.editor.icons.makeRotationLockIcon(),o.lockRotation,o.handDropdown__lockRotationHelpText,o);this.addSubWidget(s),this.addSubWidget(a);}static getPrimaryHandTool(t){return t.getPrimaryTools().find(i=>i instanceof ae)}static getOverrideHandTool(t){return t.getMatchingTools(ae)[0]}shouldAutoDisableInReadOnlyEditor(){return  false}getTitle(){return this.localizationTable.handTool}createIcon(){return this.editor.icons.makeHandToolIcon()}handleClick(){this.allowTogglingBaseTool?super.handleClick():this.setDropdownVisible(!this.isDropdownVisible());}getHelpText(){return this.localizationTable.handDropdown__baseHelpText}fillDropdown(t,e){super.fillDropdown(t,e);let o=document.createElement("div");o.classList.add(`${E}nonbutton-controls-main-list`),Xt().addTo(o);let i=oa(this.localizationTable,this.editor,e);return o.appendChild(i),t.appendChild(o),true}setSelected(t){this.allowTogglingBaseTool&&super.setSelected(t);}serializeState(){let t=this.overridePanZoomTool.getMode();return {...super.serializeState(),touchPanning:t&1,rotationLocked:t&32}}deserializeFrom(t){t.touchPanning!==void 0&&this.overridePanZoomTool.setModeEnabled(1,!!t.touchPanning),t.rotationLocked!==void 0&&this.overridePanZoomTool.setModeEnabled(32,!!t.rotationLocked),super.deserializeFrom(t);}};var jt=O((n,t)=>new si(n,t)),si=class{constructor(t,e){this.startPoint=t;this.viewport=e;this.endPoint=t;}endPoint;getBBox(){return this.buildPreview().getBBox()}buildPreview(){let t=this.startPoint.pos,e=this.endPoint.pos,o=e.minus(t).normalized(),i=this.endPoint.width===0?this.endPoint.width:L.roundPoint(this.endPoint.width,5/this.viewport.getScaleFactor()),r=i+3,s=i+3,a=o.orthog(),l=a.times(r),c=a.times(s),d=t.minus(l),p=new R(d,[{kind:0,point:t.plus(l)},{kind:0,point:e.plus(c)},{kind:0,point:e.minus(c)},{kind:0,point:t.minus(l)}]).mapPoints(h=>this.viewport.roundPoint(h));return new D([z(p,{fill:this.startPoint.color,stroke:{width:i,color:i===0?this.endPoint.color:this.endPoint.borderColor||this.endPoint.color}})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t);}addPoint(t){this.endPoint=t;}};var mt=class n extends ee{constructor(e,o,i){super(e,o,o.description,i);this.tool=o;this.shapelikeIDs=["pressure-sensitive-pen","freehand-pen"];let r=e.getCurrentSettings().pens?.additionalPenTypes??[],s=e.getCurrentSettings().pens?.filterPenTypes??(()=>true);this.penTypes=[{name:this.localizationTable.flatTipPen,id:"pressure-sensitive-pen",factory:ze},{name:this.localizationTable.roundedTipPen,id:"freehand-pen",factory:le},{name:this.localizationTable.roundedTipPen2,id:"polyline-pen",factory:Te},...r.filter(a=>!a.isShapeBuilder),{name:this.localizationTable.arrowPen,id:"arrow",isShapeBuilder:true,factory:Gt},{name:this.localizationTable.linePen,id:"line",isShapeBuilder:true,factory:jt},{name:this.localizationTable.filledRectangle,id:"filled-rectangle",isShapeBuilder:true,factory:Zt},{name:this.localizationTable.outlinedRectanglePen,id:"outlined-rectangle",isShapeBuilder:true,factory:Xi},{name:this.localizationTable.outlinedCirclePen,id:"outlined-circle",isShapeBuilder:true,factory:Dt},...r.filter(a=>a.isShapeBuilder)].filter(s),this.editor.notifier.on(2,a=>{if(a.kind!==2)throw new Error("Invalid event type!");a.tool===this.tool&&(this.updateIcon(),this.updateInputs());});}updateInputs=()=>{};penTypes;shapelikeIDs;static idCounter=0;getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){let e=this.tool.getStrokeFactory();for(let o=0;o<this.penTypes.length;o++)if(this.penTypes[o].factory===e)return o;return  -1}getCurrentPenType(){for(let e of this.penTypes)if(e.factory===this.tool.getStrokeFactory())return e;return null}createIconForRecord(e){let o={...this.tool.getStyleValue().get()};e?.factory&&(o.factory=e.factory);let i=e?.factory;return !i||i===le||i===ze||i===Te?this.editor.icons.makePenIcon(o):this.editor.icons.makeIconFromFactory(o)}createIcon(){return this.createIconForRecord(this.getCurrentPenType())}createPenTypeSelector(e){let o=this.penTypes.map((c,d)=>({id:d,makeIcon:()=>this.createIconForRecord(c),title:c.name,isShapeBuilder:c.isShapeBuilder??false})),i=o.filter(c=>!c.isShapeBuilder),r=$t(this.localizationTable.selectPenType,this.getCurrentPenTypeIdx(),i),s=o.filter(c=>c.isShapeBuilder),a=$t(this.localizationTable.selectShape,this.getCurrentPenTypeIdx(),s),l=c=>{this.tool.setStrokeFactory(this.penTypes[c].factory);};return r.value.onUpdate(l),a.value.onUpdate(l),e?.registerTextHelpForElements([r.getRootElement(),a.getRootElement()],this.localizationTable.penDropdown__penTypeHelpText),{setValue:c=>{r.value.set(c),a.value.set(c);},updateIcons:()=>{r.updateIcons(),a.updateIcons();},addTo:c=>{i.length>0&&r.addTo(c),s.length>0&&a.addTo(c);}}}createStrokeCorrectionOptions(e){let o=document.createElement("div");o.classList.add("action-button-row",`${E}-pen-tool-toggle-buttons`);let i=(a,l)=>{let c=document.createElement("button");c.classList.add(`${E}-toggle-button`);let d=l.cloneNode(true);d.classList.add("icon");let p=document.createElement("span");p.innerText=a,c.replaceChildren(d,p),c.setAttribute("role","switch"),o.appendChild(c);let u=false,h=g=>{},m={setChecked(g){u=g,c.setAttribute("aria-checked",`${u}`),h(u);},setOnInputListener(g){h=g;},addHelpText(g){e?.registerTextHelpForElement(c,g);}};return c.addEventListener("click",()=>{m.setChecked(!u);}),m},r=i(this.localizationTable.inputStabilization,this.editor.icons.makeStrokeSmoothingIcon());r.setOnInputListener(a=>{this.tool.setHasStabilization(a);});let s=i(this.localizationTable.strokeAutocorrect,this.editor.icons.makeShapeAutocorrectIcon());return s.setOnInputListener(a=>{this.tool.setStrokeAutocorrectEnabled(a);}),s.addHelpText(this.localizationTable.penDropdown__autocorrectHelpText),r.addHelpText(this.localizationTable.penDropdown__stabilizationHelpText),{update:()=>{r.setChecked(!!this.tool.getInputMapper()),s.setChecked(this.tool.getStrokeAutocorrectionEnabled());},addTo:a=>{a.appendChild(o);}}}getHelpText(){return this.localizationTable.penDropdown__baseHelpText}fillDropdown(e,o){let i=document.createElement("div");i.classList.add(`${E}spacedList`,`${E}nonbutton-controls-main-list`);let{container:r,setValue:s}=rt(this.editor,m=>{this.tool.setThickness(m);}),a=document.createElement("div"),l=document.createElement("label"),c=be(this.editor,m=>{this.tool.setColor(m);}),{input:d,container:p}=c;d.id=`${E}colorInput${n.idCounter++}`,l.innerText=this.localizationTable.colorLabel,l.setAttribute("for",d.id),a.appendChild(l),a.appendChild(p);let u=this.createStrokeCorrectionOptions(o),h=this.createPenTypeSelector(o);return o?.registerTextHelpForElement(a,this.localizationTable.penDropdown__colorHelpText),o&&c.registerWithHelpTextDisplay(o),o?.registerTextHelpForElement(r,this.localizationTable.penDropdown__thicknessHelpText),this.updateInputs=()=>{c.setValue(this.tool.getColor()),s(this.tool.getThickness()),h.updateIcons(),h.setValue(this.getCurrentPenTypeIdx()),u.update();},this.updateInputs(),i.replaceChildren(a,r),h.addTo(i),e.replaceChildren(i),u.addTo(e),true}onKeyPress(e){if(!this.isSelected())return  false;for(let[o,i]of Kt.entries())if(this.editor.shortcuts.matchesShortcut(i,e)){let r=o;if(r<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[r].factory),true}return !!super.onKeyPress(e)}serializeState(){return {...super.serializeState(),color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:this.getCurrentPenType()?.id,inputStabilization:!!this.tool.getInputMapper(),strokeAutocorrect:this.tool.getStrokeAutocorrectionEnabled(),pressureSensitivity:this.tool.getPressureSensitivityEnabled()}}deserializeFrom(e){super.deserializeFrom(e);let o=(i,r)=>{let s=typeof e[i];if(s!==r)throw new Error(`Deserializing property ${i}: Invalid type. Expected ${r}, was ${s}.`)};if(e.color&&(o("color","string"),this.tool.setColor(w.fromHex(e.color))),e.thickness&&(o("thickness","number"),this.tool.setThickness(e.thickness)),e.strokeFactoryId){o("strokeFactoryId","string");let i=e.strokeFactoryId;for(let r of this.penTypes)if(i===r.id){this.tool.setStrokeFactory(r.factory);break}}console.log({state:e}),e.inputStabilization!==void 0&&this.tool.setHasStabilization(!!e.inputStabilization),e.strokeAutocorrect!==void 0&&this.tool.setStrokeAutocorrectEnabled(!!e.strokeAutocorrect);}};var kr=class extends ye{constructor(t,e,o,i={}){super(t,"save-button",()=>i.icon??t.icons.makeSaveIcon(),i.label??e.save,o),this.setTags(["save"]);}shouldAutoDisableInReadOnlyEditor(){return  false}onKeyPress(t){return this.editor.shortcuts.matchesShortcut(_i,t)?(this.clickAction(),true):super.onKeyPress(t)}mustBeInToplevelMenu(){return  true}},Nn=kr;function ia(n,t){let e=document.createElement("div");e.classList.add("toolbar-button-grid"),e.style.setProperty("--column-count",`${t}`);let o=i=>{let r=document.createElement("button");r.classList.add("button");let s=i.icon();s.classList.add("icon");let a=document.createElement("label");return a.textContent=i.label,a.classList.add("button-label-text"),r.addEventListener("click",i.onClick),i.enabled&&i.enabled.onUpdateAndNow(l=>{r.disabled=!l;}),r.replaceChildren(s,a),e.appendChild(r),Le(r),i.onCreated?.(r),r};return n.map(o),{container:e}}var Un=ia;var ft=30,gt=class{constructor(t,e,o,i,r,s){this.presentation=t;this.parent=e;this.viewport=o;this.onDragStart=i;this.onDragUpdate=r;this.onDragEnd=s;this.element=document.createElement("div"),this.element.classList.add(`${ie}handle`,`${ie}${t.action}`);let a=document.createElement("div");a.classList.add(`${ie}content`),this.element.appendChild(a),this.parentSide=t.side;let l=t.icon;switch(l&&(a.appendChild(l),l.classList.add("icon")),t.action==="rotate"?this.shape=0:this.shape=1,this.shape){case 0:this.element.classList.add(`${ie}circle`);break;case 1:this.element.classList.add(`${ie}square`);break;default:nn(this.shape);}this.updatePosition();}element;snapToGrid;shape;parentSide;addTo(t){t.appendChild(this.element);}remove(){this.element.remove();}getBBoxParentCoords(){let t=this.parent.getScreenRegion(),e=exports.Vec2.of(ft,ft),o=t.size.scale(this.parentSide).minus(e.times(1/2));return new P(o.x,o.y,e.x,e.y)}getBBoxCanvasCoords(){let t=this.parent.region,e=exports.Vec2.of(ft,ft).times(1/this.viewport.getScaleFactor()),o=t.size.scale(this.parentSide).minus(e.times(.5));return new P(o.x,o.y,e.x,e.y).translatedBy(t.topLeft)}updatePosition(){let t=this.getBBoxParentCoords();this.element.style.marginLeft=`${t.topLeft.x}px`,this.element.style.marginTop=`${t.topLeft.y}px`,this.element.style.width=`${t.w}px`,this.element.style.height=`${t.h}px`;}containsPoint(t){let e=this.getBBoxCanvasCoords(),o=t.minus(e.center),i=e.size.x/2,r;return this.shape===0?r=o.magnitude()<=i:r=Math.abs(o.x)<=i&&Math.abs(o.y)<=i,r}dragLastPos=null;handleDragStart(t){return this.onDragStart(t.canvasPos),this.dragLastPos=t.canvasPos,true}handleDragUpdate(t){this.dragLastPos&&this.onDragUpdate(t.canvasPos);}handleDragEnd(){if(this.dragLastPos)return this.onDragEnd()}setSnapToGrid(t){this.snapToGrid=t;}isSnappingToGrid(){return this.snapToGrid}};var Rr=40,Qt=class{constructor(t,e,o,i,r){this.parent=t;this.viewport=e;this.icon=o;this.localization=r;this.element=document.createElement("div"),this.element.classList.add(`${ie}handle`,`${ie}selection-menu`),this.element.style.setProperty("--vertical-offset",`${Rr}px`),this.onClick=()=>{this.button?.focus({preventScroll:true});let s=this.getBBoxCanvasCoords().center;i(s);},this.initUI(),this.updatePosition();}element;button;onClick;initUI(){let t=document.createElement("button");this.icon.classList.add("icon"),t.replaceChildren(this.icon),t.ariaLabel=this.localization.selectionMenu__show,t.title=t.ariaLabel,this.button=t,t.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.onClick());}),this.element.appendChild(t),requestAnimationFrame(()=>{this.updatePosition();});}addTo(t){t.appendChild(this.element);}remove(){this.element.remove();}getElementScreenSize(){return exports.Vec2.of(this.element.clientWidth,this.element.clientHeight)}getBBoxParentCoords(){let t=exports.Vec2.of(0,-40),e=this.getElementScreenSize();return new P(t.x,t.y,e.x,e.y)}getBBoxCanvasCoords(){let t=this.parent.region,e=this.viewport.getSizeOfPixelOnCanvas(),o=this.getElementScreenSize().times(e),i=Rr/this.viewport.getScaleFactor(),r=exports.Vec2.of(t.x,t.y-i),s=exports.Vec2.of(48,48).times(e);return new P(r.x,r.y,o.x,o.y).grownToSize(s)}updatePosition(){let t=this.getBBoxParentCoords();this.element.style.marginLeft=`${t.topLeft.x}px`,this.element.style.marginTop=`${t.topLeft.y}px`;}containsPoint(t){return this.getBBoxCanvasCoords().containsPoint(t)}lastDragPointer=null;handleDragStart(t){return this.lastDragPointer=t,true}handleDragUpdate(t){this.lastDragPointer=t;}handleDragEnd(){this.lastDragPointer&&this.containsPoint(this.lastDragPointer.canvasPos)&&this.onClick(),this.lastDragPointer=null;}};var Jt=(e=>(e.Lasso="lasso",e.Rectangle="rect",e))(Jt||{});var ai=class{constructor(t,e){this.editor=t;this.selection=e;}dragStartPoint;onDragStart(t){this.selection.setTransform(T.identity),this.dragStartPoint=t;}onDragUpdate(t){let e=this.editor.viewport.roundPoint(t.minus(this.dragStartPoint));this.selection.setTransform(T.translation(e));}onDragEnd(){return this.selection.finalizeTransform()}},li=class{constructor(t,e){this.editor=t;this.selection=e;}mode=0;dragStartPoint;transformOrigin;scaleRate;onDragStart(t,e){this.selection.setTransform(T.identity),this.mode=e,this.dragStartPoint=t,this.computeOriginAndScaleRate();}computeOriginAndScaleRate(){let t=this.selection.preTransformRegion,e=t.corners,o=0;for(let s of e){let a=this.dragStartPoint.minus(s).magnitudeSquared();a>o&&(o=a,this.transformOrigin=s);}let i=1,r=1;this.transformOrigin.x>t.center.x&&(i=-1),this.transformOrigin.y>t.center.y&&(r=-1),this.scaleRate=exports.Vec2.of(i,r);}onDragUpdate(t){let e=t.minus(this.dragStartPoint),o=this.selection.preTransformRegion.width,i=this.selection.preTransformRegion.height,r=exports.Vec2.of(1,1);if(this.mode===1){let s=o+e.x*this.scaleRate.x;r=exports.Vec2.of(s/o,r.y);}if(this.mode===2){let s=i+e.y*this.scaleRate.y;r=exports.Vec2.of(r.x,s/i);}if(this.mode===0){let s=Math.abs(e.x)>Math.abs(e.y)?e.x:e.y,a=o+s;r=exports.Vec2.of(a/o,a/o);}if(r=r.map(s=>L.roundScaleRatio(s,2)),r.x!==0&&r.y!==0){let s=this.editor.viewport.roundPoint(this.transformOrigin);this.selection.setTransform(T.scaling2D(r,s));}}onDragEnd(){return this.selection.finalizeTransform()}},ci=class{constructor(t,e){this.editor=t;this.selection=e;}startAngle=0;targetRotation=0;maximumDistFromStart=0;startPoint;startTime;getAngle(t){let e=this.selection.preTransformRegion.center;return t.minus(e).angle()}roundAngle(t){let e=8/Math.PI;return Math.round(t*e)/e}onDragStart(t){this.startPoint=t,this.selection.setTransform(T.identity),this.startAngle=this.getAngle(t),this.targetRotation=0,this.maximumDistFromStart=0,this.startTime=performance.now();}setRotationTo(t){let e=this.editor.viewport.roundPoint(this.selection.preTransformRegion.center),i=T.zRotation(t).mapEntries(s=>L.roundScaleRatio(s)),r=T.translation(e).rightMul(i).rightMul(T.translation(e.times(-1)));this.selection.setTransform(r);}onDragUpdate(t){this.targetRotation=this.roundAngle(this.getAngle(t)-this.startAngle),this.setRotationTo(this.targetRotation);let e=t.minus(this.startPoint).magnitude();e>this.maximumDistFromStart&&(this.maximumDistFromStart=e);}onDragEnd(){return (performance.now()-this.startTime)/1e3<.4&&this.maximumDistFromStart<10&&this.targetRotation===0&&this.setRotationTo(-Math.PI/2),this.selection.finalizeTransform()}};var bt=class n extends V{constructor(e,o){super("duplicate");this.toDuplicate=e;this.duplicates=e.map((i,r)=>o&&o[r]?i.cloneWithId(o[r]):i.clone()),this.reverse=new U(this.duplicates);}duplicates;reverse;apply(e){this.reverse.unapply(e);}unapply(e){this.reverse.apply(e);}onDrop(e){this.reverse.onDrop(e);}description(e,o){return this.duplicates.length===0?o.duplicatedNoElements:o.duplicateAction(ei(o,this.duplicates)??o.elements,this.duplicates.length)}serializeToJSON(){return {originalIds:this.toDuplicate.map(e=>e.getId()),cloneIds:this.duplicates.map(e=>e.getId())}}static{V.register("duplicate",(e,o)=>{let i,r;Array.isArray(e)?(i=e,r=[]):(i=e.originalIds,r=e.cloneIds),Bt(i),Bt(r);let s=[],a=[];for(let[l,c]of i.entries()){let d=o.image.lookupElement(c);d?(a.push(r[l]),s.push(d)):console.warn("Duplicate command: Could not find element with ID",c);}return new n(s,a)});}};var Lr=100,Wn=500,eo=class n{constructor(t,e,o){this.editor=e;t=[...t],this.selectedElems=t,this.originalRegion=P.empty,this.transformers={drag:new ai(e,this),resize:new li(e,this),rotate:new ci(e,this)},this.outerContainer=document.createElement("div"),this.outerContainer.classList.add(`${ie}selection-outer-container`),this.innerContainer=document.createElement("div"),this.innerContainer.classList.add(`${ie}selection-inner-container`),this.backgroundElem=document.createElement("div"),this.backgroundElem.classList.add(`${ie}selection-background`),this.innerContainer.appendChild(this.backgroundElem),this.outerContainer.appendChild(this.innerContainer);let i=(d,p)=>{let u={0:"resize-xy",1:"resize-x",2:"resize-y"};return new gt({action:u[d],side:p},this,this.editor.viewport,h=>this.transformers.resize.onDragStart(h,d),h=>this.transformers.resize.onDragUpdate(h),()=>this.transformers.resize.onDragEnd())},r=[i(1,exports.Vec2.of(0,.5)),i(1,exports.Vec2.of(1,.5))],s=i(2,exports.Vec2.of(.5,1)),a=i(0,exports.Vec2.of(1,1)),l=new gt({action:"rotate",side:exports.Vec2.of(.5,0),icon:this.editor.icons.makeRotateIcon()},this,this.editor.viewport,d=>this.transformers.rotate.onDragStart(d),d=>this.transformers.rotate.onDragUpdate(d),()=>this.transformers.rotate.onDragEnd()),c=new Qt(this,this.editor.viewport,this.editor.icons.makeOverflowIcon(),o,this.editor.localization);this.childwidgets=[c,a,...r,s,l];for(let d of this.childwidgets)d.addTo(this.backgroundElem);this.recomputeRegion(),this.updateUI();}childwidgets;originalRegion;selectionTightBoundingBox=null;transformers;transform=T.identity;selectedElems=[];outerContainer;innerContainer;backgroundElem;hasParent=true;getBackgroundElem(){return this.backgroundElem}getTransform(){return this.transform}get preTransformRegion(){return this.originalRegion}get region(){let t=T.zRotation(this.regionRotation,this.originalRegion.center),e=this.transform.rightMul(t.inverse());return this.originalRegion.transformedBoundingBox(e)}computeTightBoundingBox(){return this.selectedElems.reduce((e,o)=>(e??o.getBBox()).union(o.getBBox()),null)??P.empty}get regionRotation(){return this.transform.transformVec3(exports.Vec2.unitX).angle()}get preTransformedScreenRegion(){let t=e=>this.editor.viewport.canvasToScreen(e);return P.fromCorners(t(this.preTransformRegion.topLeft),t(this.preTransformRegion.bottomRight))}get preTransformedScreenRegionRotation(){return this.editor.viewport.getRotationAngle()}getScreenRegion(){let t=this.editor.viewport.canvasToScreenTransform,e=this.editor.viewport.getScaleFactor(),o=t.transformVec2(this.region.center);return new P(o.x,o.y,e*this.region.width,e*this.region.height).translatedBy(this.region.size.times(-e/2))}get screenRegionRotation(){return this.regionRotation+this.editor.viewport.getRotationAngle()}setTransform(t,e=true){this.transform=t,e&&this.hasParent&&this.previewTransformCmds();}getDeltaZIndexToMoveSelectionToTop(){if(this.selectedElems.length===0)return 0;let t=this.selectedElems[0].getZIndex(),e=this.editor.image.getComponentsIntersecting(this.region);return (e[e.length-1]?.getZIndex()??t)+1-t}finalizeTransform(){let t=this.transform,e=this.selectedElems;this.originalRegion=this.originalRegion.transformedBoundingBox(this.transform),this.transform=T.identity,this.scrollTo();let o;if(this.selectedElems.length>0){let i=this.getDeltaZIndexToMoveSelectionToTop();o=this.editor.dispatch(new n.ApplyTransformationCommand(this,e,this.originalRegion.center,t,i));}return o}sendToBack(){let e=this.editor.image.getComponentsIntersecting(this.editor.viewport.visibleRect)[0]?.getZIndex()??0,o=this.selectedElems[this.selectedElems.length-1]?.getZIndex()??0,r=e-1-o;if(r!==0){let s=this.selectedElems.map(a=>a.setZIndex(a.getZIndex()+r));return j(s,Lr)}return null}static{V.register("selection-tool-transform",(t,e)=>{let o=t.transform,i=t.selectionCenter??[0,0],r=t.elems??[];ke(o),ke(i),Bt(r);let s=new T(...o),a=r,l=Number.parseInt(t.deltaZIndex??0),c=exports.Vec2.of(i[0]??0,i[1]??0);return new this.ApplyTransformationCommand(null,a,c,s,l)});}static ApplyTransformationCommand=class extends V{constructor(e,o,i,r,s){super("selection-tool-transform");this.selection=e;this.selectionCenter=i;this.fullTransform=r;this.deltaZIndex=s;(l=>typeof l[0]=="string")(o)?this.selectedElemIds=o:(this.selectedElemIds=o.map(l=>l.getId()),this.transformCommands=o.map(l=>l.setZIndexAndTransformBy(this.fullTransform,l.getZIndex()+s)));}transformCommands;selectedElemIds;resolveToElems(e,o){this.transformCommands||(this.transformCommands=this.selectedElemIds.map(i=>{let r=e.image.lookupElement(i);if(!r)return console.warn(`Unable to find element with ID, ${i}.`),null;let s=r.getZIndex(),a=r.getZIndex()+this.deltaZIndex;return o&&(a=r.getZIndex(),s=r.getZIndex()-this.deltaZIndex),r.setZIndexAndTransformBy(this.fullTransform,a,s)}).filter(i=>i!==null));}async apply(e){this.resolveToElems(e,false),this.selection?.setTransform(this.fullTransform,false),this.selection?.updateUI(),await e.asyncApplyCommands(this.transformCommands,Lr),this.selection?.setTransform(T.identity,false),this.selection?.recomputeRegion(),this.selection?.updateUI();}async unapply(e){this.resolveToElems(e,true),this.selection?.setTransform(this.fullTransform.inverse(),false),this.selection?.updateUI(),await e.asyncUnapplyCommands(this.transformCommands,Lr,true),this.selection?.setTransform(T.identity,false),this.selection?.recomputeRegion(),this.selection?.updateUI();}serializeToJSON(){return {elems:this.selectedElemIds,transform:this.fullTransform.toArray(),deltaZIndex:this.deltaZIndex,selectionCenter:this.selectionCenter.asArray()}}description(e,o){return o.transformedElements(this.selectedElemIds.length,ot(this.selectionCenter,this.fullTransform,false,o))}};previewTransformCmds(){if(this.selectedElems.length===0)return;if(this.selectedElems.length>Wn){this.updateUI();return}let t=this.editor.display.getWetInkRenderer();t.clear(),t.pushTransform(this.transform);let o=this.editor.viewport.visibleRect.union(this.region).transformedBoundingBox(this.transform.inverse());for(let i of this.selectedElems)i.render(t,o);t.popTransform(),this.updateUI();}recomputeRegion(){let t=this.computeTightBoundingBox();return this.selectionTightBoundingBox=t,t?(this.originalRegion=t,this.padRegion(),true):(this.cancelSelection(),false)}padRegion(){let t=this.selectionTightBoundingBox??this.originalRegion,e=this.getMinCanvasSize();if(t.w<e||t.h<e){let o=e/2;this.originalRegion=P.bboxOf(t.corners,o),this.updateUI();}}getMinCanvasSize(){return ft/this.editor.viewport.getScaleFactor()*2}getSelectedItemCount(){return this.selectedElems.length}updateUI(){if(!this.hasParent)return;let t=this.getScreenRegion();this.backgroundElem.style.marginLeft=`${t.topLeft.x}px`,this.backgroundElem.style.marginTop=`${t.topLeft.y}px`,this.backgroundElem.style.width=`${t.width}px`,this.backgroundElem.style.height=`${t.height}px`;let e=this.screenRegionRotation*180/Math.PI;this.backgroundElem.style.transform=`rotate(${e}deg)`,this.backgroundElem.style.transformOrigin="center";let o=`${ie}rotated-near-perpendicular`;Math.abs(Math.sin(this.screenRegionRotation))>.5?this.innerContainer.classList.add(o):this.innerContainer.classList.remove(o),t.width===0&&t.height===0?this.innerContainer.classList.add("-empty"):this.innerContainer.classList.remove("-empty");for(let i of this.childwidgets)i.updatePosition(this.getScreenRegion());}removedFromImage={};addRemoveSelectionFromImage(t){if(!(!t&&this.selectedElems.length>Wn)){for(let e of this.selectedElems){let o=this.editor.image.findParent(e);!t&&o?(this.removedFromImage[e.getId()]=true,o.remove()):!o&&this.removedFromImage[e.getId()]&&(H.addComponent(e).apply(this.editor),this.removedFromImage[e.getId()]=false,delete this.removedFromImage[e.getId()]);}this.editor.queueRerender().then(()=>{t?this.editor.display.getWetInkRenderer().clear():this.previewTransformCmds();});}}removeDeletedElemsFromSelection(){this.selectedElems=this.selectedElems.filter(t=>{let e=!!this.editor.image.findParent(t),o=this.removedFromImage[t.getId()];return e||o});}activeHandle=null;backgroundDragging=false;onDragStart(t){if(this.selectedElems.length===0)return  false;document.getSelection()?.removeAllRanges(),this.activeHandle=null;let e=false;this.backgroundDragging=false,this.region.containsPoint(t.canvasPos)&&(this.backgroundDragging=true,e=true);for(let o of this.childwidgets)o.containsPoint(t.canvasPos)&&(this.activeHandle=o,this.backgroundDragging=false,e=true);return e&&(this.removeDeletedElemsFromSelection(),this.addRemoveSelectionFromImage(false)),this.activeHandle&&this.activeHandle.handleDragStart(t),this.backgroundDragging&&this.transformers.drag.onDragStart(t.canvasPos),e}onDragUpdate(t){this.backgroundDragging&&this.transformers.drag.onDragUpdate(t.canvasPos),this.activeHandle&&this.activeHandle.handleDragUpdate(t);}onDragEnd(){this.backgroundDragging?this.transformers.drag.onDragEnd():this.activeHandle&&this.activeHandle.handleDragEnd(),this.addRemoveSelectionFromImage(true),this.backgroundDragging=false,this.activeHandle=null,this.updateUI();}onDragCancel(){this.backgroundDragging=false,this.activeHandle=null,this.setTransform(T.identity),this.addRemoveSelectionFromImage(true),this.updateUI();}scrollTo(){if(this.selectedElems.length===0)return  false;let t=this.editor.viewport.getScreenRectSize(),e=new P(0,0,t.x,t.y),o=this.getScreenRegion();if(!e.containsPoint(o.center)){let i=o.center,r=e.getClosestPointOnBoundaryTo(i),s=this.editor.viewport.screenToCanvas(r),a=this.region.center,l=s.minus(a);return this.editor.dispatchNoAnnounce(L.transformBy(T.translation(l.times(.5))),false),this.editor.queueRerender().then(()=>{this.previewTransformCmds();}),true}return  false}deleteSelectedObjects(){return (this.backgroundDragging||this.activeHandle)&&this.onDragEnd(),new U(this.selectedElems)}selectionDuplicatedAnimationTimeout=null;runSelectionDuplicatedAnimation(){this.selectionDuplicatedAnimationTimeout&&clearTimeout(this.selectionDuplicatedAnimationTimeout);let t=400;this.backgroundElem.style.animation=`${t}ms ease selection-duplicated-animation`,this.selectionDuplicatedAnimationTimeout=setTimeout(()=>{this.backgroundElem.style.animation="",this.selectionDuplicatedAnimationTimeout=null;},t);}async duplicateSelectedObjects(){let t=this.backgroundDragging||this.activeHandle,e=null;t||this.runSelectionDuplicatedAnimation();let o;if(t){let r=this.getDeltaZIndexToMoveSelectionToTop();e=new n.ApplyTransformationCommand(null,this.selectedElems,this.region.center,this.transform,r),await e.apply(this.editor),this.addRemoveSelectionFromImage(true),o=j(this.selectedElems.map(s=>H.addComponent(s.clone()))),await e?.unapply(this.editor),this.addRemoveSelectionFromImage(false),this.previewTransformCmds(),this.updateUI();}else o=new bt(this.selectedElems);return o}snapSelectedObjectsToGrid(){let t=this.editor.viewport,e=this.computeTightBoundingBox().topLeft,i=t.snapToGrid(e).minus(e),r=this.getTransform();this.setTransform(r.rightMul(T.translation(i))),this.finalizeTransform();}setHandlesVisible(t){t?this.innerContainer.classList.remove("-hide-handles"):this.innerContainer.classList.add("-hide-handles");}addTo(t){this.outerContainer.parentElement&&this.outerContainer.remove(),t.appendChild(this.outerContainer),this.hasParent=true;}setToPoint(t){this.originalRegion=this.originalRegion.grownToPoint(t),this.selectionTightBoundingBox=null,this.updateUI();}cancelSelection(){this.outerContainer.parentElement&&this.outerContainer.remove(),this.originalRegion=P.empty,this.selectionTightBoundingBox=null,this.hasParent=false;}getSelectedObjects(){return [...this.selectedElems]}};var Ye=class{render(t,e){t.drawPath(z(this.previewPath(),{fill:e}));}resolve(t,e){let o=this.previewPath(),i=l=>l.filter(c=>c.isSelectable()),r,s=e.getSizeOfPixelOnCanvas()*3;if(o.bbox.maxDimension<=s){let l=e.visibleRect.maxDimension/200,c=o.bbox.grownBy(l);r=t.getComponentsIntersecting(c).filter(d=>!!d),r=i(r),r.length>1&&(r=[r[0]]);}else r=i(this.resolveInternal(t));return r}};var to=class extends Ye{constructor(e,o){super();this.viewport=o;this.boundaryPoints.push(e),this.lastPoint=e;}boundaryPoints=[];lastPoint;onPointerMove(e){let o=this.boundaryPoints[this.boundaryPoints.length-1],i=this.viewport.getSizeOfPixelOnCanvas()*8;o.distanceTo(e)>=i&&this.boundaryPoints.push(e),this.lastPoint=e;}previewPath(){let e=this.boundaryPoints.map(o=>({kind:0,point:o}));return e.push({kind:0,point:this.lastPoint}),new R(this.boundaryPoints[0],e).asClosed()}resolveInternal(e){let o=this.previewPath(),i=o.polylineApproximation(),r=e.getComponentsIntersecting(o.bbox),s=a=>{if(o.closedContainsRect(a.getExactBBox()))return  true;let l=false;for(let c of a.keyPoints())if(o.closedContainsPoint(c)){l=true;break}if(!l)return  false;for(let c of i)if(a.intersects(c))return  false;return  true};return r.filter(s)}};var oo=class extends Ye{rect;constructor(t){super(),this.rect=P.fromCorners(t,t);}onPointerMove(t){this.rect=this.rect.grownToPoint(t);}previewPath(){return R.fromRect(this.rect)}resolveInternal(t){return t.getComponentsIntersecting(this.rect).filter(e=>e.intersectsRect(this.rect))}};var io=class{constructor(t,e){this.viewport=t;this.scrollByCanvasDelta=e;}started=false;updateLoopId=0;updateLoopRunning=false;targetPoint=null;scrollRate=1e3;getScrollForPoint(t){let e=this.viewport.getScreenRectSize(),o=new P(0,0,e.x,e.y),i=44,r=o.grownBy(-44);if(r.containsPoint(t))return exports.Vec2.zero;let s=r.getClosestPointOnBoundaryTo(t),a=s.distanceTo(t),l=s.minus(t),d=Math.min(a/i,1.25);return l.normalizedOrZero().times(d)}start(){this.started=true;}onPointerMove(t){this.started&&(this.getScrollForPoint(t)===exports.Vec2.zero?this.stopUpdateLoop():(this.targetPoint=t,this.startUpdateLoop()));}stop(){this.targetPoint=null,this.started=false,this.stopUpdateLoop();}startUpdateLoop(){this.updateLoopRunning||(async()=>{this.updateLoopId++;let t=this.updateLoopId,e=performance.now();for(;this.updateLoopId===t&&this.targetPoint;){this.updateLoopRunning=true;let o=performance.now(),i=o-e,s=this.getScrollForPoint(this.targetPoint).times(this.scrollRate*i/1e3);this.scrollByCanvasDelta(this.viewport.screenToCanvasTransform.transformVec3(s)),e=o,await we();}this.updateLoopRunning=false;})();}stopUpdateLoop(){this.updateLoopId++;}};function ra(n){return new Promise(t=>{setTimeout(()=>t(),n);})}var di=ra;function na(n,t){let e=document.createElement("div"),{remove:o}=n.createHTMLOverlay(e);e.classList.add("dialog-container","message-dialog-container",...t.classNames??[]);let i=document.createElement("dialog"),r=document.createElement("div");r.classList.add("message-dialog-content",...t.contentClassNames??[]);let s=document.createElement("h1");s.textContent=t.title,s.setAttribute("autofocus","true");let a=document.createElement("button");a.innerText=n.localization.closeDialog,a.classList.add("close");let l=document.createElement("div");l.classList.add("scroll"),l.addEventListener("wheel",u=>u.stopPropagation()),r.replaceChildren(s,l,a),i.replaceChildren(r),e.replaceChildren(i);let c=300;i.style.setProperty("--close-delay",`${c}ms`);let d=async()=>{i.classList.add("-closing"),await di(c),i.close();};return (()=>{i.addEventListener("pointerdown",u=>{u.target===i&&d();}),i.addEventListener("close",()=>{o();}),a.addEventListener("click",()=>d());})(),i.showModal(),{close:()=>d(),appendChild:u=>{l.appendChild(u);}}}var pi=na;async function sa(n,t={}){try{let e=new FileReader;return await new Promise((o,i)=>{e.addEventListener("load",()=>o(e.result)),e.onerror=i,e.addEventListener("abort",i),e.addEventListener("progress",r=>{t.onprogress?.(r);}),e.readAsDataURL(n);})}catch(e){(t.onWarning??console.warn)("Unable to convert file to base64 with a FileReader: ",e);let o=await n.arrayBuffer(),i=new Uint8Array(o),r=30,s=[];for(let a=0;a<i.length;a+=r){let l=String.fromCharCode(...i.slice(a,a+r));s.push(btoa(l));}return `data:${n.type??"image/*"};base64,${s.join("")}`}}var yt=sa;function $n(n){return n.endsWith("+xml")||n.startsWith("text/")}var pe=class{constructor(t,e){this.editor=t;this.callbacks=e;}#e=false;paste(t){let e=o=>{if(this.callbacks?.onPasteError)return this.callbacks.onPasteError(o),Promise.resolve(false);throw o};try{return this.pasteInternal(t).catch(e)}catch(o){return e(o)}}async pasteInternal(t){let e=this.editor,o=t?.dataTransfer??t?.clipboardData??null,i=!!o,r=(p,u)=>u&&e.toolController.dispatchInputEvent({kind:8,mime:p,data:u}),s=["image/svg+xml","text/html","image/png","image/jpeg","text/plain"],a=[],l=new Map,c=e.getCurrentSettings();if(i){a=[...o.files];for(let p of s){let u=o.getData(p);u&&l.set(p,u);}}else if(c.clipboardApi){let p=await c.clipboardApi.read();for(let[u,h]of p.entries())if(typeof h=="string")l.set(u,h);else {let m=h;m.type!==u&&(m=new Blob([m],{type:u})),a.push(m);}}else {let p=await navigator.clipboard.read();for(let u of p)for(let h of u.types)s.includes(h)&&a.push(await u.getType(h));}let d=async p=>{let u=$n(p);if(u){let h=l.get(p);if(r(p,h))return t?.preventDefault(),true}for(let h of a)if(h?.type?.toLowerCase()===p)if(u){let g=await h.text();if(r(p,g))return t?.preventDefault(),true}else {e.showLoadingWarning(0);let g=b=>{e.showLoadingWarning(b.loaded/b.total);};try{let b=await yt(h,{onprogress:g});if(r(p,b))return t?.preventDefault(),e.hideLoadingWarning(),!0}catch(b){console.error("Error reading image:",b);}e.hideLoadingWarning();}return  false};for(let p of s)if(await d(p))return  true;return  false}copy(t){let e=o=>{if(this.callbacks?.onCopyError)return this.callbacks.onCopyError(o),Promise.resolve();throw o};try{return this.copyInternal(t).catch(e)}catch(o){return e(o)}}copyInternal(t){let e=new Map;this.editor.toolController.dispatchInputEvent({kind:7,setData:(d,p)=>{e.set(d,p);}})&&t?.preventDefault();let i=[...e.keys()].some(d=>!$n(d)),r=d=>{if(!t)throw new Error(`Unable to copy -- no event provided${d?`. Original error: ${d}`:""}`);for(let[p,u]of e.entries())typeof u=="string"&&("clipboardData"in t?t.clipboardData?.setData(p,u):t.dataTransfer?.setData(p,u));},s=()=>{let u=(h=>{let m=Object.create(null);for(let[g,b]of Object.entries(h))"supports"in ClipboardItem&&typeof ClipboardItem.supports=="function"&&!ClipboardItem.supports(g)||(m[g]=b);return m})((h=>{let m=Object.create(null);for(let[g,b]of h.entries()){if(typeof b=="string"){let v=new Blob([new TextEncoder().encode(b)],{type:g});m[g]=v;}else m[g]=b;g==="image/svg+xml"&&(m["text/html"]??=m[g]);}return m})(e));return navigator.clipboard.write([new ClipboardItem(u)])},a=typeof ClipboardItem<"u"&&typeof navigator?.clipboard?.write<"u",l=!this.#e&&a&&(i||!t),c=this.editor.getCurrentSettings();if(l&&c.clipboardApi)return c.clipboardApi.write(e)??Promise.resolve();if(l){let d=null,p=u=>{console.warn("Unable to copy to the clipboard API. Future calls to .copy will use ClipboardEvents if possible.",u),this.#e=true,r(u);};try{d=s();}catch(u){p(u);}if(d)return d.catch(p)}else r();return Promise.resolve()}};function aa(n){let t=e=>{let o=pi(n,{title:n.localization.copyPasteError__heading,classNames:["clipboard-error-dialog"]});o.appendChild(document.createTextNode(n.localization.copyPasteError__description));let i=document.createElement("details"),r=document.createElement("summary");return r.textContent=n.localization.copyPasteError__errorDetails,i.appendChild(r),i.appendChild(document.createTextNode(`Error: ${e}`)),o.appendChild(i),o};return {onCopyError(e){let o=t(e),i=document.createElement("label");i.textContent=n.localization.copyPasteError__copyRetry;let r=document.createElement("textarea");i.appendChild(r);let s=new pe(n),a=l=>(l.preventDefault(),s.copy(l).then(()=>{o.close();}));r.addEventListener("copy",a),r.addEventListener("dragstart",a),r.value=n.localization.copyPasteError__copyMe,o.appendChild(i),r.select(),document.execCommand("copy");},onPasteError(e){let o=t(e),i=document.createElement("label");i.textContent=n.localization.copyPasteError__pasteRetry;let r=document.createElement("textarea");i.appendChild(r);let s=new pe(n),a=l=>(l.preventDefault(),s.paste(l).then(c=>{c&&o.close();}));r.addEventListener("paste",a),r.addEventListener("drop",a),o.appendChild(i),r.focus(),document.execCommand("paste");}}}var Br=aa;var la=0;async function ca(n,t,e){let o=document.createElement("div"),{remove:i}=n.createHTMLOverlay(o),r=document.createElement("dialog");r.classList.add("editor-popup-menu");let s=240;r.style.setProperty("--hide-menu-animation-timeout",`${s}ms`);let a=()=>{let p=n.getOutputBBoxInDOM(),u=n.viewport.canvasToScreen(t).plus(p.topLeft);r.style.setProperty("--anchor-x",`${u.x}px`),r.style.setProperty("--anchor-y",`${u.y}px`);};a();let l=n.notifier.on(7,a);o.appendChild(r);let c=false,d=async()=>{c||(c=true,l.remove(),r.classList.add("-hide"),await di(s),r.close());};return new Promise(p=>{let u=false,h=null,m=()=>{u||(p(h),u=true);};r.addEventListener("close",()=>{i(),m();});let g=f=>{h=f,d(),m();};n.handlePointerEventsExceptClicksFrom(r,(f,x)=>x.target===r&&f==="pointerdown"?(d(),true):!!c,(f,x)=>x.target===r);let b=document.createElement("div");b.classList.add("content"),b.role="menu";let v=[];b.addEventListener("keydown",f=>{let x=v.indexOf(document.activeElement);if(x===-1)return;let S=x;f.key==="ArrowDown"?S++:f.key==="ArrowUp"?S--:f.key==="End"?S=v.length-1:f.key==="Home"&&(S=0),S<0&&(S+=v.length),S%=v.length,S!==x&&(f.preventDefault(),v[S].focus());});for(let f of e){let x=document.createElement("button");x.id=`menu-overlay-option-${la++}`,x.role="menuitem",x.classList.add("option","editor-popup-menu-option"),x.replaceChildren(f.icon(),document.createTextNode(f.text)),x.addEventListener("click",S=>{S.defaultPrevented||g(f.key);}),b.appendChild(x),v.length===0&&(x.autofocus=true),v.push(x);}r.appendChild(b),r.showModal(),b.scrollIntoView({block:"nearest"});})}var Kn=ca;async function da(n,t,e,o,i){let r=t.localization,s=n?.getSelectedItemCount()&&o,a=[{text:r.selectionMenu__paste,icon:()=>t.icons.makePasteIcon(),key:()=>{new pe(t,Br(t)).paste();}}];(await Kn(t,e,s?[{text:r.selectionMenu__duplicate,icon:()=>t.icons.makeDuplicateSelectionIcon(),key:async()=>{await t.dispatch(await n.duplicateSelectedObjects());}},{text:r.selectionMenu__delete,icon:()=>t.icons.makeDeleteSelectionIcon(),key:async()=>{await t.dispatch(n.deleteSelectedObjects()),i();}},{text:r.selectionMenu__copyToClipboard,icon:()=>t.icons.makeCopyIcon(),key:()=>{new pe(t,Br(t)).copy();}},...a]:a))?.();}var Gn=da;var qn="text";var pa={fontFamily:"sans",size:12,renderingStyle:{fill:w.black}},q=class n extends N{constructor(e,o,i=pa,r=0){super(qn);this.textObjects=e;this.transform=o;this.style=i;this.transformMode=r;this.recomputeBBox(),!e.some(a=>typeof a=="string")&&e.length>0&&(this.style=e[0].getTextStyle());}contentBBox;isRestylableComponent=true;static applyTextStyles(e,o){let i=o.fontFamily.match(/\s/),r=o.fontFamily.match(/^".*"$/),s=i&&!r?`"${o.fontFamily.replace(/"/g,String.raw`\"`)}"`:o.fontFamily;e.font=[o.fontStyle??"",o.fontWeight??"",(o.size??12)+"px",`${s}`].join(" "),e.textAlign="left";}static textMeasuringCtx=null;static estimateTextDimens(e,o){let i=e.length*o.size,r=o.size;return new P(0,-r*2/3,i,r)}static getTextMetrics(e,o){if(n.textMeasuringCtx??=document.createElement("canvas").getContext("2d")??null,!n.textMeasuringCtx)return null;let i=n.textMeasuringCtx;return n.applyTextStyles(i,o),i.measureText(e)}static getTextDimens(e,o){let i=this.getTextMetrics(e,o);if(!i)return this.estimateTextDimens(e,o);let r=-i.actualBoundingBoxAscent,s=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;return new P(0,r,i.width,s)}static getFontHeight(e){return e.size}computeUntransformedBBoxOfPart(e){return typeof e=="string"?n.getTextDimens(e,this.style):e.contentBBox}recomputeBBox(){let e=null,o=new n.TextCursor(this.transform,this.style);for(let i of this.textObjects){let r=o.update(i).transform,s=this.computeUntransformedBBoxOfPart(i).transformedBoundingBox(r);e??=s,e=e.union(s);}this.contentBBox=e??P.empty;}renderInternal(e,o,i=T.identity){let r=new n.TextCursor(this.transform,this.style);for(let s of this.textObjects){let{transform:a,bbox:l}=r.update(s);o&&!o.intersects(l.transformedBoundingBox(i))||(typeof s=="string"?e.drawText(s,a,this.style):(e.pushTransform(a),s.renderInternal(e,o,i.rightMul(a)),e.popTransform()));}}render(e,o){e.startObject(this.contentBBox),this.renderInternal(e,o),e.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return this.textObjects.length}intersects(e){let o=new n.TextCursor(this.transform,this.style);for(let i of this.textObjects){let r=o.update(i).transform.inverse(),s=e.transformedBy(r);if(typeof i=="string"){if(n.getTextDimens(i,this.style).getEdges().some(l=>s.intersection(l)!==null))return  true}else if(i.intersects(s))return  true}return  false}getStyle(){return {color:this.style.renderingStyle.fill,textStyle:{...this.style,renderingStyle:{...this.style.renderingStyle}}}}updateStyle(e){return $e(this.getStyle(),e,this)}forceStyle(e,o){if(e.textStyle)this.style=Oi(e.textStyle);else if(e.color)this.style={...this.style,renderingStyle:{...this.style.renderingStyle,fill:e.color}};else return;for(let i of this.textObjects)i instanceof n&&i.forceStyle(e,o);o&&(o.image.queueRerenderOf(this),o.queueRerender());}getTextStyle(){return Oi(this.style)}getBaselinePos(){return this.transform.transformVec2(exports.Vec2.zero)}getTransform(){return this.transform}applyTransformation(e){this.transform=e.rightMul(this.transform),this.recomputeBBox();}createClone(){let e=this.textObjects.map(o=>typeof o=="string"?o:o.createClone());return new n(e,this.transform,this.style)}getText(){let e=[];for(let o of this.textObjects)typeof o=="string"?e.push(o):e.push(o.getText());return e.join(`
`)}description(e){return e.text(this.getText())}serializeToJSON(){let e=Mo(this.style);return {textObjects:this.textObjects.map(i=>typeof i=="string"?{text:i}:{json:i.serializeToJSON()}),transform:this.transform.toArray(),style:e}}static deserializeFromString(e){typeof e=="string"&&(e=JSON.parse(e));let o=Vo(e.style),i=e.textObjects.map(a=>(a.text??null)!==null?a.text:n.deserializeFromString(a.json));if(e.transform=e.transform.filter(a=>typeof a=="number"),e.transform.length!==9)throw new Error(`Unable to deserialize transform, ${e.transform}.`);let r=e.transform,s=new T(...r);return new n(i,s,o)}static fromLines(e,o,i){let r=null,s=[],a=Math.round(this.getFontHeight(i)),l=exports.Vec2.zero;for(let c of e){r&&(l=l.plus(exports.Vec2.unitY.times(a)));let d=new n([c],T.translation(l),i);s.push(d),r=d;}return new n(s,o,i)}static TextCursor=class{constructor(e=T.identity,o){this.parentTransform=e;this.parentStyle=o;}transform=T.identity;update(e){let o=T.identity,i=T.identity,r;typeof e=="string"?r=n.getTextDimens(e,this.parentStyle):(i=e.transform,r=e.getBBox());let s=typeof e=="string"?1:e.transformMode;s===1?o=this.transform.rightMul(o):(s===2||s===3)&&(o=this.transform.mapEntries((d,[p,u])=>{if(s===2)return p===1&&u===2?0:d;if(s===3)return p===0&&u===2?0:d;throw new Error("Unreachable")}).rightMul(o));let a=T.translation(exports.Vec2.of(r.width,0));this.transform=o.rightMul(i).rightMul(a);let l=this.parentTransform.rightMul(o);return {transform:l,bbox:r.transformedBoundingBox(l)}}}};N.registerComponent(qn,n=>q.deserializeFromString(n));var ue=class{constructor(t){this.viewport=t;}selfTransform=null;transformStack=[];getViewport(){return this.viewport}setDraftMode(t){}objectLevel=0;currentPaths=null;flushPath(){if(!this.currentPaths)return;let t=null;for(let e of this.currentPaths){let{startPoint:o,commands:i,style:r}=e;!t||!zo(t,r)?(t&&this.endPath(t),this.beginPath(o),t=r):this.moveTo(o);for(let s of i)s.kind===0?this.lineTo(s.point):s.kind===1?this.moveTo(s.point):s.kind===2?this.traceCubicBezierCurve(s.controlPoint1,s.controlPoint2,s.endPoint):s.kind===3&&this.traceQuadraticBezierCurve(s.controlPoint,s.endPoint);}t&&this.endPath(t),this.currentPaths=[];}drawPath(t){this.objectLevel===0||this.currentPaths===null?(this.currentPaths=[t],this.flushPath(),this.currentPaths=null):this.currentPaths.push(t);}drawRect(t,e,o){let i=R.fromRect(t,e);this.drawPath(z(i,o));}fillRect(t,e){let o=R.fromRect(t);this.drawPath(z(o,{fill:e}));}startObject(t,e){this.objectLevel>0&&this.flushPath(),this.currentPaths=[],this.objectLevel++;}endObject(t,e){if(this.flushPath(),this.currentPaths=null,this.objectLevel--,this.objectLevel<0)throw new Error("More objects have ended than have been started (negative object nesting level)!")}getNestingLevel(){return this.objectLevel}canRenderFromWithoutDataLoss(t){return  false}renderFromOtherOfSameType(t,e){throw new Error(`Unable to render from ${e}: Not implemented`)}setTransform(t){this.selfTransform=t;}pushTransform(t){this.flushPath(),this.transformStack.push(this.selfTransform),this.setTransform(this.getCanvasToScreenTransform().rightMul(t));}popTransform(){if(this.transformStack.length===0)throw new Error("Unable to pop more transforms than have been pushed!");this.flushPath(),this.setTransform(this.transformStack.pop()??null);}getCanvasToScreenTransform(){return this.selfTransform?this.selfTransform:this.viewport.canvasToScreenTransform}canvasToScreen(t){return this.getCanvasToScreenTransform().transformVec2(t)}getSizeOfCanvasPixelOnScreen(){return this.getCanvasToScreenTransform().transformVec3(exports.Vec2.unitX).length()}visibleRectOverride;overrideVisibleRect(t){this.visibleRectOverride=t;}getVisibleRect(){return this.visibleRectOverride??this.viewport.visibleRect}};var he=class n extends ue{constructor(e,o){super(o);this.ctx=e;this.setDraftMode(false);}ignoreObjectsAboveLevel=null;ignoringObject=false;currentObjectBBox=null;minSquareCurveApproxDist;minRenderSizeAnyDimen;minRenderSizeBothDimens;transformBy(e){this.ctx.transform(e.a1,e.b1,e.a2,e.b2,e.a3,e.b3);}canRenderFromWithoutDataLoss(e){return e instanceof n}renderFromOtherOfSameType(e,o){if(!(o instanceof n))throw new TypeError(`${o} cannot be rendered onto ${this}`);e=this.getCanvasToScreenTransform().rightMul(e),this.ctx.save(),this.transformBy(e),this.ctx.drawImage(o.ctx.canvas,0,0),this.ctx.restore();}setDraftMode(e){e?(this.minSquareCurveApproxDist=9,this.minRenderSizeBothDimens=1,this.minRenderSizeAnyDimen=.1):(this.minSquareCurveApproxDist=.5,this.minRenderSizeBothDimens=.1,this.minRenderSizeAnyDimen=1e-6);}displaySize(){return exports.Vec2.of(this.ctx.canvas.clientWidth,this.ctx.canvas.clientHeight)}clear(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore();}beginPath(e){e=this.canvasToScreen(e),this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y);}endPath(e){e.fill.a>0&&(this.ctx.fillStyle=e.fill.toHexString(),this.ctx.fill()),e.stroke&&(this.ctx.strokeStyle=e.stroke.color.toHexString(),this.ctx.lineWidth=this.getSizeOfCanvasPixelOnScreen()*e.stroke.width,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke(),this.ctx.lineWidth=1),this.ctx.closePath();}lineTo(e){e=this.canvasToScreen(e),this.ctx.lineTo(e.x,e.y);}moveTo(e){e=this.canvasToScreen(e),this.ctx.moveTo(e.x,e.y);}traceCubicBezierCurve(e,o,i){e=this.canvasToScreen(e),o=this.canvasToScreen(o),i=this.canvasToScreen(i);let r=o.minus(e),s=i.minus(o);r.magnitudeSquared()<this.minSquareCurveApproxDist&&s.magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(i.x,i.y):this.ctx.bezierCurveTo(e.x,e.y,o.x,o.y,i.x,i.y);}traceQuadraticBezierCurve(e,o){e=this.canvasToScreen(e),o=this.canvasToScreen(o),e.minus(o).magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(o.x,o.y):this.ctx.quadraticCurveTo(e.x,e.y,o.x,o.y);}drawPath(e){if(this.ignoringObject)return;let o=this.getVisibleRect();this.currentObjectBBox?.containsRect(o)&&(e=zi(e,o)),super.drawPath(e);}drawText(e,o,i){this.ctx.save(),o=this.getCanvasToScreenTransform().rightMul(o),this.transformBy(o),q.applyTextStyles(this.ctx,i),i.renderingStyle.fill.a!==0&&(this.ctx.fillStyle=i.renderingStyle.fill.toHexString(),this.ctx.fillText(e,0,0)),i.renderingStyle.stroke&&(this.ctx.strokeStyle=i.renderingStyle.stroke.color.toHexString(),this.ctx.lineWidth=i.renderingStyle.stroke.width,this.ctx.strokeText(e,0,0)),this.ctx.restore();}drawImage(e){if(e.image.width===0||e.image.height===0)return;this.ctx.save();let o=this.getCanvasToScreenTransform().rightMul(e.transform);this.transformBy(o),this.ctx.drawImage(e.image,0,0),this.ctx.restore();}clipLevels=[];startObject(e,o){if(this.isTooSmallToRender(e)&&(this.ignoreObjectsAboveLevel=this.getNestingLevel(),this.ignoringObject=true),super.startObject(e),this.currentObjectBBox=e,!this.ignoringObject&&o&&!e.containsRect(this.getVisibleRect())){this.clipLevels.push(this.objectLevel),this.ctx.save(),this.ctx.beginPath();for(let r of e.corners){let s=this.canvasToScreen(r);this.ctx.lineTo(s.x,s.y);}this.ctx.clip();}}endObject(){let e=this.objectLevel;this.currentObjectBBox=null,super.endObject(),!this.ignoringObject&&this.clipLevels.length>0&&this.clipLevels[this.clipLevels.length-1]===e&&(this.ctx.restore(),this.clipLevels.pop()),this.ignoreObjectsAboveLevel!==null&&this.getNestingLevel()<=this.ignoreObjectsAboveLevel&&(this.ignoreObjectsAboveLevel=null,this.ignoringObject=false);}drawWithRawRenderingContext(e){this.ctx.save(),this.transformBy(this.getCanvasToScreenTransform()),e(this.ctx),this.ctx.restore();}drawPoints(...e){for(let[i,r]of e.entries()){let s=this.canvasToScreen(r);this.ctx.beginPath(),this.ctx.arc(s.x,s.y,10,0,Math.PI*2),this.ctx.fillStyle=w.ofRGBA(.5+Math.sin(i)/2,1,.5+Math.cos(i*.2)/4,.5).toHexString(),this.ctx.lineWidth=2,this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.ctx.fillText(`${i}`,s.x,s.y,10*2);}}isTooSmallToRender(e){let o=e.size.times(this.getSizeOfCanvasPixelOnScreen()),i=this.minRenderSizeBothDimens,r=Math.abs(o.x)<i&&Math.abs(o.y)<i,s=this.minRenderSizeAnyDimen,a=Math.abs(o.x)<s||Math.abs(o.y)<s;return r||a}static fromViewport(e,o={}){let i=document.createElement("canvas"),r=e.getScreenRectSize(),s=o.canvasSize??r;o.maxCanvasDimen&&s.maximumEntryMagnitude()>o.maxCanvasDimen&&(s=s.times(o.maxCanvasDimen/s.maximumEntryMagnitude())),i.width=s.x,i.height=s.y;let a=i.getContext("2d"),l=Math.min(s.x/r.x,s.y/r.y);return a.scale(l,l),{renderer:new n(a,e),element:i}}};function ua(n,t,e){let o=/^([\d.e-]+)px/i,i=o.exec(n.style?.fontSize??"");!i&&n.tagName.toLowerCase()==="tspan"&&n.parentElement&&(i=o.exec(n.parentElement.style?.fontSize??"")),!i&&t&&(i=o.exec(t.fontSize));let r=12;return i&&(e.add("fontSize"),r=Number.parseFloat(i[1])),r}var Zn=ua;async function ha(n){n.complete||await new Promise((t,e)=>{n.addEventListener("load",o=>t(o)),n.onerror=o=>e(o),n.addEventListener("abort",o=>e(o));});}var _n=ha;var te=class n extends N{contentBBox;image;constructor(t){super("image-component"),this.image={...t,label:t.label??t.image.getAttribute("alt")??t.image.getAttribute("aria-label")??void 0},(o=>o.getAttribute("src")!==void 0)(t.image)&&!t.image.complete&&t.image.addEventListener("load",()=>this.recomputeBBox()),this.recomputeBBox();}getImageRect(){return new P(0,0,this.image.image.width,this.image.image.height)}recomputeBBox(){this.contentBBox=this.getImageRect(),this.contentBBox=this.contentBBox.transformedBoundingBox(this.image.transform);}static async fromImage(t,e){await _n(t);let o,i;typeof t.width=="number"&&typeof t.height=="number"&&t.width!==0&&t.height!==0?(o=t.width,i=t.height):(o=t.clientWidth,i=t.clientHeight);let r,s=t.src??"";if(s.startsWith("data:image/"))r=new Image,r.src=s,r.width=o,r.height=i;else {let a=document.createElement("canvas");a.width=o,a.height=i,a.getContext("2d").drawImage(t,0,0,a.width,a.height),s=a.toDataURL(),r=a;}return r.setAttribute("alt",t.getAttribute("alt")??""),r.setAttribute("aria-label",t.getAttribute("aria-label")??""),new n({image:r,base64Url:s,transform:e})}render(t,e){t.startObject(this.contentBBox),t.drawImage(this.image),t.endObject(this.getLoadSaveData());}getProportionalRenderingTime(){return 10}intersects(t){let o=this.getImageRect().getEdges().map(i=>i.transformedBy(this.image.transform));for(let i of o)if(i.intersects(t))return  true;return  false}applyTransformation(t){this.image.transform=t.rightMul(this.image.transform),this.recomputeBBox();}description(t){return this.image.label?t.imageNode(this.image.label):t.unlabeledImageNode}getAltText(){return this.image.label}getURL(){return this.image.base64Url}getTransformation(){return this.image.transform}createClone(){return new n({...this.image})}serializeToJSON(){return {src:this.image.base64Url,label:this.image.label,width:this.image.image.width,height:this.image.image.height,transform:this.image.transform.toArray()}}static deserializeFromJSON(t){if(typeof t.src!="string")throw new TypeError(`${t} has invalid format! Expected src property.`);ke(t.transform),Ce(t.width),Ce(t.height);let e=new Image;e.src=t.src,e.width=t.width,e.height=t.height;let o=new T(...t.transform);return new n({image:e,base64Url:t.src,label:t.label,transform:o})}};N.registerComponent("image-component",te.deserializeFromJSON);var jn="svg-global-attributes",vt=class n extends N{contentBBox;attrs;constructor(t){super(jn),this.contentBBox=P.empty;let e=["viewBox","width","height"];this.attrs=t.filter(([o,i])=>!e.includes(o));}render(t,e){if(t instanceof oe)for(let[o,i]of this.attrs)t.setRootSVGAttribute(o,i);}intersects(t){return  false}applyTransformation(t){}isSelectable(){return  false}getSizingMode(){return 2}createClone(){return new n(this.attrs)}description(t){return t.svgObject}serializeToJSON(){return JSON.stringify(this.attrs)}static deserializeFromString(t){return new n([])}};N.registerComponent(jn,vt.deserializeFromString);var Yn="unknown-svg-object",Xe=class n extends N{constructor(e){super(Yn);this.svgObject=e;this.contentBBox=P.of(e.getBoundingClientRect());}contentBBox;render(e,o){e instanceof oe&&(e.startObject(this.contentBBox),e.drawSVGElem(this.svgObject),e.endObject(this.getLoadSaveData()));}intersects(e){return this.contentBBox.getEdges().some(o=>o.intersection(e)!==null)}applyTransformation(e){}isSelectable(){return  false}getSizingMode(){return 2}createClone(){return new n(this.svgObject.cloneNode(true))}description(e){return e.svgObject}serializeToJSON(){return JSON.stringify({html:this.svgObject.outerHTML})}};N.registerComponent(Yn,null);var ma=new P(0,0,500,500),Ar="svgAttrs",Dr="svgStyleAttrs",Vr="svgContainerID",ui="easydrawer--autoresize";var zr=["stroke","fill","stroke-width"],De=class n{constructor(t,e,o){this.source=t;this.onFinish=e;this.plugins=o.plugins??[],this.storeUnknown=!(o.sanitize??false),this.disableUnknownObjectWarnings=!!o.disableUnknownObjectWarnings;}onAddComponent=null;onProgress=null;onDetermineExportRect=null;processedCount=0;totalToProcess=0;rootViewBox;storeUnknown;disableUnknownObjectWarnings;plugins;getStyle(t,e){let o=w.transparent,i,r=t.getAttribute("fill")??(e?.fill||t.style?.fill);if(r)try{o=w.fromString(r);}catch{console.error("Unknown fill color,",r);}let s=t.getAttribute("stroke")??e?.stroke??t.style?.stroke??"",a=t.getAttribute("stroke-width")??e?.strokeWidth??t.style?.strokeWidth??"";if(s&&a)try{let c=Number.parseFloat(a??"1");isFinite(c)||(c=0);let d=w.fromString(s);d.a>0&&(i={width:c,color:d});}catch(c){console.error("Error parsing stroke data:",c);}return {fill:o,stroke:i}}strokeDataFromElem(t){let e=[],o=t.getAttribute("d")??"",i=this.getStyle(t),r=o.split("M"),s=true;for(let a of r){let l=/^[\d\t\n ,.]+$/.exec(a);if(a!==""&&!l){let c=s?a:`M${a}`,d=R.fromString(c),p=z(d,i);e.push(p);}s=false;}return e}attachUnrecognisedAttrs(t,e,o,i){if(this.storeUnknown){for(let r of e.getAttributeNames())o.has(r)||r==="style"&&i||t.attachLoadSaveData(Ar,[r,e.getAttribute(r)]);if(i&&e.style)for(let r=0;r<e.style.length;r++){let s=e.style[r];s===""||!s||i.has(s)||t.attachLoadSaveData(Dr,{key:s,value:e.style.getPropertyValue(s),priority:e.style.getPropertyPriority(s)});}}}async addPath(t){let e;try{let o=this.strokeDataFromElem(t);e=new D(o),this.attachUnrecognisedAttrs(e,t,new Set([...zr,"d"]),new Set(zr));}catch(o){if(console.error("Invalid path in node",t,`
Error:`,o,`
Adding as an unknown object.`),this.storeUnknown)e=new Xe(t);else return}await this.addComponent(e);}async addBackground(t){if(t.classList.contains(wr[1])){let e,o,i;if(t.tagName.toLowerCase()==="g"){if(t.children.length!==2){await this.addUnknownNode(t);return}let d=t.children[0],p=t.children[1];o=d.getAttribute("fill"),e=p.getAttribute("stroke"),i=p.getAttribute("stroke-width");}else o=t.getAttribute("fill"),e=t.getAttribute("stroke"),i=t.getAttribute("stroke-width");if(o??=w.transparent.toHexString(),!e){await this.addUnknownNode(t);return}let r;for(let d of t.classList)if(d.startsWith(oi)){let p=d.substring(oi.length);r=Number.parseFloat(p.replace(/p/g,"."));}let s;i&&(s=Number.parseFloat(i));let a=w.fromString(o),l=w.fromString(e);t.classList.contains(Tr)||(l=void 0);let c=Y.ofGrid(a,r,l,s);await this.addComponent(c);}else if(t.tagName.toLowerCase()==="path"){let e=w.fromString(t.getAttribute("fill")??t.style.fill??"black"),o=new Y(0,e);await this.addComponent(o);}else await this.addUnknownNode(t);}getComputedStyle(t){try{return window.getComputedStyle(t)}catch(e){console.warn("Error computing style",e);return}}getTransform(t,e,o){let i="data-highp-transform",r=t.getAttribute(i),s;if(r)try{s=T.fromCSSMatrix(r),e?.push(i);}catch(a){console.warn(`Unable to parse raw transform data, ${r}. Falling back to CSS data. Error:`,a);}if(!s){o??=this.getComputedStyle(t);let a=o?.transform;(!a||a==="none")&&(a=t.style?.transform||"none");try{s=T.fromCSSMatrix(t.style.transform);}catch(d){console.warn("matrix parse error",d),s=T.fromCSSMatrix(a);}let l=t.getAttribute("x"),c=t.getAttribute("y");if(l||c){let d=Number.parseFloat(l??"0"),p=Number.parseFloat(c??"0");!isNaN(d)&&!isNaN(p)&&(e?.push("x","y"),s=s.rightMul(T.translation(exports.Vec2.of(d,p))));}}return s}makeText(t){let e=[];for(let u of t.childNodes)if(u.nodeType===Node.TEXT_NODE)e.push(u.nodeValue??"");else if(u.nodeType===Node.ELEMENT_NODE){let h=u;if(h.tagName.toLowerCase()==="tspan")e.push(this.makeText(h));else throw new Error(`Unrecognized text child element: ${h}`)}else throw new Error(`Unrecognized text child node: ${u}.`);e.length===0&&e.push("");let o=this.getComputedStyle(t),i=new Set(["fontFamily","transform",...zr]),r={size:Zn(t,o,i),fontFamily:o?.fontFamily||t.style?.fontFamily||"sans-serif",fontWeight:o?.fontWeight||t.style?.fontWeight||void 0,fontStyle:o?.fontStyle||t.style?.fontStyle||void 0,renderingStyle:this.getStyle(t,o)},s=[],a=this.getTransform(t,s,o),l=0,c=t.getAttribute("dx");c&&(l=2,a=a.rightMul(T.translation(exports.Vec2.of(Number.parseFloat(c),0))),s.push("dx"));let d=t.getAttribute("dy");d&&(l===2?l=1:l=3,a=a.rightMul(T.translation(exports.Vec2.of(0,Number.parseFloat(d)))),s.push("dy"));let p=new q(e,a,r,l);return this.attachUnrecognisedAttrs(p,t,new Set(s),new Set(i)),p}async addText(t){try{let e=this.makeText(t);await this.addComponent(e);}catch(e){console.error("Invalid text object in node",t,". Continuing.... Error:",e),this.addUnknownNode(t);}}async addImage(t){let e=new Image;e.src=t.getAttribute("xlink:href")??t.href.baseVal,e.setAttribute("alt",t.getAttribute("aria-label")??"");try{let o=[],i=this.getTransform(t,o),r=await te.fromImage(e,i);this.attachUnrecognisedAttrs(r,t,new Set(o),new Set(["transform"])),await this.addComponent(r);}catch(o){console.error("Error loading image:",o,". Element: ",t,". Continuing..."),await this.addUnknownNode(t);}}async addUnknownNode(t){if(this.storeUnknown){let e=new Xe(t);await this.addComponent(e);}}containerGroupIDs=[];encounteredIDs=[];async startGroup(t){t=t.cloneNode(false);let e=t.id||`id-${this.encounteredIDs.length}`,o=0,i="";for(;this.encounteredIDs.includes(e+i);)o++,i="--"+o;e+=i,t.replaceChildren(),t.id=e;let r=new Xe(t);this.addComponent(r),this.containerGroupIDs.push(t.id),this.encounteredIDs.push(t.id);}async endGroup(){this.containerGroupIDs.pop();}async addComponent(t){this.containerGroupIDs.length>0&&t.attachLoadSaveData(Vr,[...this.containerGroupIDs]),await this.onAddComponent?.(t);}updateViewBox(t){let e=t.getAttribute("viewBox");if(this.rootViewBox||!e)return;let o=e.split(/[\t\n ,]+/),i=Number.parseFloat(o[0]),r=Number.parseFloat(o[1]),s=Number.parseFloat(o[2]),a=Number.parseFloat(o[3]);if(isNaN(i)||isNaN(r)||isNaN(s)||isNaN(a)){console.warn(`node ${t} has an unparsable viewbox. Viewbox: ${e}. Match: ${o}.`);return}let l=t.classList.contains(ui);this.rootViewBox=new P(i,r,s,a),this.onDetermineExportRect?.(this.rootViewBox,{autoresize:l});}async updateSVGAttrs(t){this.storeUnknown&&await this.onAddComponent?.(new vt(this.getSourceAttrs(t)));}async visit(t){this.totalToProcess+=t.childElementCount;let e=true,o=async()=>{for(let r of this.plugins)if(await r.visit(t,{addComponent:a=>this.onAddComponent?.(a)}))return e=false,true;return  false},i=async()=>{switch(t.tagName.toLowerCase()){case "g":t.classList.contains(dt)?(await this.addBackground(t),e=false):await this.startGroup(t);break;case "path":t.classList.contains(dt)?await this.addBackground(t):await this.addPath(t);break;case "text":await this.addText(t),e=false;break;case "image":await this.addImage(t),e=false;break;case "svg":this.updateViewBox(t),this.updateSVGAttrs(t);break;case "style":t.getAttribute("id")!==ro&&await this.addUnknownNode(t);break;default:this.disableUnknownObjectWarnings||(console.warn("Unknown SVG element,",t,t.tagName),t instanceof SVGElement||console.warn("Element",t,"is not an SVGElement!",this.storeUnknown?"Continuing anyway.":"Skipping.")),await this.addUnknownNode(t);return}};if(await o()?e=false:await i(),e){for(let r of t.children)await this.visit(r);t.tagName.toLowerCase()==="g"&&await this.endGroup();}this.processedCount++,await this.onProgress?.(this.processedCount,this.totalToProcess);}getSourceAttrs(t){return t.getAttributeNames().map(e=>[e,t.getAttribute(e)])}async start(t,e,o=null){this.onAddComponent=t,this.onProgress=e,this.onDetermineExportRect=o,this.totalToProcess=this.source.childElementCount,this.processedCount=0,this.rootViewBox=null,await this.visit(this.source),this.rootViewBox||this.onDetermineExportRect?.(ma),this.onFinish?.(),this.onFinish=null;}static fromString(t,e=false){let o=typeof e!="boolean"&&e?.loadMethod==="domparser",{svgElem:i,cleanUp:r}=(()=>{if(!o)try{let m=document.createElement("iframe");if(m.src="about:blank",m.setAttribute("sandbox","allow-same-origin"),m.setAttribute("csp","default-src 'about:blank'"),m.style.display="none",document.body.appendChild(m),!m.hasAttribute("sandbox"))throw m.remove(),new Error("SVG loading iframe is not sandboxed.");let g=m.contentWindow?.document??m.contentDocument;if(g==null)throw new Error("Unable to open a sandboxed iframe!");g.open(),g.write(`
						<!DOCTYPE html>
						<html>
							<head>
								<title>SVG Loading Sandbox</title>
								<meta name='viewport' conent='width=device-width,initial-scale=1.0'/>
								<meta charset='utf-8'/>
							</head>
							<body style='font-size: 12px;'>
								<script>
									console.error('JavaScript should not be able to run here!');
									throw new Error(
										'The SVG sandbox is broken! Please double-check the sandboxing setting.'
									);
								<\/script>
							</body>
						</html>
					`),g.close();let b=g.createElementNS("http://www.w3.org/2000/svg","svg");return b.innerHTML=t,g.body.appendChild(b),{svgElem:b,cleanUp:()=>{b.remove(),m.remove(),m.src="";}}}catch(m){console.warn("Failed loading SVG via a sandboxed iframe. Some styles may not be loaded correctly. Error: ",m);}let d=new DOMParser().parseFromString(`<svg xmlns="http://www.w3.org/2000/svg">${t}</svg>`,"text/html"),p=d.querySelector("svg"),u=d.querySelector("parsererror");if(u)throw new Error("Parse error: "+u.textContent);return {svgElem:p,cleanUp:()=>{}}})(),s,a,l;return typeof e=="boolean"?(s=e,a=false,l=[]):(s=e.sanitize??false,a=e.disableUnknownObjectWarnings??false,l=e.plugins),new n(i,r,{sanitize:s,disableUnknownObjectWarnings:a,plugins:l})}};function fa(n,t){let e=n.length<t.length?n:t,o=e===n?t:n;for(let[i,r]of e.entries())if(r!==o[i])return  false;return  true}var Xn=fa;var ro="easydrawer-style-sheet",Qe="http://www.w3.org/2000/svg",Mr={fontWeight:"400",fontStyle:"normal"},oe=class n extends ue{constructor(e,o,i=false){super(o);this.elem=e;this.sanitize=i;this.clear(),this.addStyleSheet();}lastPathStyle=null;lastPathString=[];lastContainerIDList=[];objectElems=null;overwrittenAttrs={};addStyleSheet(){if(!this.elem.querySelector(`#${ro}`)){let e=document.createElementNS("http://www.w3.org/2000/svg","style");e.appendChild(document.createTextNode(`
				path {
					stroke-linecap: round;
					stroke-linejoin: round;
				}

				text {
					white-space: pre;
				}
			`.replace(/\s+/g,""))),e.setAttribute("id",ro),this.elem.appendChild(e);}}setRootSVGAttribute(e,o){this.sanitize||(e in this.overwrittenAttrs||(this.overwrittenAttrs[e]=this.elem.getAttribute(e)),o!==null?this.elem.setAttribute(e,o):this.elem.removeAttribute(e));}displaySize(){return exports.Vec2.of(this.elem.clientWidth,this.elem.clientHeight)}clear(){if(this.lastPathString=[],this.lastContainerIDList=[],!this.sanitize){for(let e in this.overwrittenAttrs){let o=this.overwrittenAttrs[e];o?this.elem.setAttribute(e,o):this.elem.removeAttribute(e);}this.overwrittenAttrs={};}}addPathToSVG(){if(!this.lastPathStyle||this.lastPathString.length===0)return null;let e=document.createElementNS(Qe,"path");e.setAttribute("d",this.lastPathString.join(" "));let o=this.lastPathStyle;return o.fill.a>0?e.setAttribute("fill",o.fill.toHexString()):e.setAttribute("fill","none"),o.stroke&&(e.setAttribute("stroke",o.stroke.color.toHexString()),e.setAttribute("stroke-width",J(o.stroke.width*this.getSizeOfCanvasPixelOnScreen()))),this.elem.appendChild(e),this.objectElems?.push(e),e}drawPath(e){let o=e.style,i=Ne(e).transformedBy(this.getCanvasToScreenTransform());(this.lastPathString.length===0||!this.lastPathStyle||!zo(this.lastPathStyle,o))&&(this.addPathToSVG(),this.lastPathStyle=o,this.lastPathString=[]),this.lastPathString.push(i.toString());}transformFrom(e,o,i=false){let r=i?e:this.getCanvasToScreenTransform().rightMul(e);if(r.eq(T.identity))o.style.transform="";else {let s=r.toCSSMatrix();o.style.transform=s,o.setAttribute("data-highp-transform",s);}}textContainer=null;textContainerTransform=null;textParentStyle=Mr;drawText(e,o,i){let r=(s,a)=>{a.fontFamily!==this.textParentStyle?.fontFamily&&(s.style.fontFamily=a.fontFamily),a.fontVariant!==this.textParentStyle?.fontVariant&&(s.style.fontVariant=a.fontVariant??""),a.fontWeight!==this.textParentStyle?.fontWeight&&(s.style.fontWeight=a.fontWeight??""),a.fontStyle!==this.textParentStyle?.fontStyle&&(s.style.fontStyle=a.fontStyle??""),a.size!==this.textParentStyle?.size&&(s.style.fontSize=a.size+"px");let l=a.renderingStyle.fill.toHexString();if(s.style.fill=l,a.renderingStyle.stroke){let c=a.renderingStyle.stroke;s.style.stroke=c.color.toHexString(),s.style.strokeWidth=c.width+"px";}};if(o=this.getCanvasToScreenTransform().rightMul(o),this.textContainer){let s=document.createElementNS(Qe,"tspan");s.appendChild(document.createTextNode(e)),this.textContainer.appendChild(s),o=this.textContainerTransform.inverse().rightMul(o);let a=o.transformVec2(exports.Vec2.zero);s.setAttribute("x",`${J(a.x)}`),s.setAttribute("y",`${J(a.y)}`),r(s,i);}else {let s=document.createElementNS(Qe,"text");s.appendChild(document.createTextNode(e)),this.transformFrom(o,s,true),r(s,i),this.elem.appendChild(s),this.objectElems?.push(s),this.objectLevel>0&&(this.textContainer=s,this.textContainerTransform=o,this.textParentStyle={...Mr,...i});}}drawImage(e){let o=e.label??e.image.getAttribute("aria-label")??"";o===""&&(o=e.image.getAttribute("alt")??"");let i=document.createElementNS(Qe,"image");i.setAttribute("href",e.base64Url),i.setAttribute("width",e.image.getAttribute("width")??""),i.setAttribute("height",e.image.getAttribute("height")??""),i.setAttribute("aria-label",o),this.transformFrom(e.transform,i),this.elem.appendChild(i),this.objectElems?.push(i);}startObject(e){super.startObject(e),this.lastPathString=[],this.lastPathStyle=null,this.textContainer=null,this.textParentStyle=Mr,this.objectElems=[];}endObject(e,o){if(super.endObject(e),this.addPathToSVG(),!!this.objectElems){if(e&&!this.sanitize){for(let s of this.objectElems){let a=e[Ar],l=e[Dr];if(a)for(let[c,d]of a)s.setAttribute(c,d);if(l)for(let c of l)s.style.setProperty(c.key,c.value,c.priority);}let i=e[Vr],r=[];if(i&&i[0]&&i[0].length>0&&(r=i[0]),r.length>0&&Xn(this.lastContainerIDList,r)&&this.lastContainerIDList.length>=r.length-1){let s=r[r.length-1],a=this.elem.querySelectorAll(`g#${s}`);if(a.length>0){let l=a[0];if(l.children.length===0||this.lastContainerIDList.length>=r.length)for(let c of this.objectElems)c.remove(),l.appendChild(c);else r=[];}}else r=[];this.lastContainerIDList=r;}if(o&&this.objectElems)if(this.objectElems.length===1)this.objectElems[0].classList.add(...o);else {let i=document.createElementNS(Qe,"g");i.classList.add(...o);for(let r of this.objectElems)r.remove(),i.appendChild(r);this.elem.appendChild(i);}}}unimplementedMessage(){throw new Error("Not implemenented!")}beginPath(e){this.unimplementedMessage();}endPath(e){this.unimplementedMessage();}lineTo(e){this.unimplementedMessage();}moveTo(e){this.unimplementedMessage();}traceCubicBezierCurve(e,o,i){this.unimplementedMessage();}traceQuadraticBezierCurve(e,o){this.unimplementedMessage();}drawPoints(...e){e.map(o=>{let i=document.createElementNS(Qe,"circle");i.setAttribute("cx",`${o.x}`),i.setAttribute("cy",`${o.y}`),i.setAttribute("r","15"),this.elem.appendChild(i);});}drawSVGElem(e){if(this.sanitize||e.tagName.toLowerCase()==="style"&&e.getAttribute("id")===ro)return;let o=e.cloneNode(true);this.elem.appendChild(o),this.objectElems?.push(o);}drawWithSVGParent(e){let o=document.createElementNS(Qe,"g");this.transformFrom(T.identity,o,true),e(o,{sanitize:this.sanitize}),this.elem.appendChild(o),this.objectElems?.push(o);}isTooSmallToRender(e){return  false}static fromViewport(e,o=true){let i,r;typeof o=="boolean"?(i=o,r=false):(i=o.sanitize??true,r=o.useViewBoxForPositioning??false);let s="http://www.w3.org/2000/svg",a=document.createElementNS(s,"svg"),l=e.getScreenRectSize(),c=e.visibleRect,d;if(r){let u=e.visibleRect;d=[u.x,u.y,u.w,u.h],e=e.getTemporaryClone(),e.resetTransform(T.identity);}else d=[0,0,l.x,l.y];a.setAttribute("viewBox",d.map(u=>J(u)).join(" ")),a.setAttribute("width",J(l.x)),a.setAttribute("height",J(l.y)),a.setAttribute("version","1.1"),a.setAttribute("baseProfile","full"),a.setAttribute("xmlns",s);let p=new n(a,e,i);return c.eq(e.visibleRect)||p.overrideVisibleRect(c),{element:a,renderer:p}}};var ie="selection-tool-";var re=class extends M{constructor(e,o){super(e.notifier,o);this.editor=e;this.modeValue=K.fromInitialValue("rect"),this.modeValue.onUpdate(()=>{this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.autoscroller=new io(e.viewport,i=>{if(e.dispatch(L.transformBy(T.translation(i)),false),this.lastPointer){let r=this.lastPointer.withScreenPosition(this.lastPointer.screenPos,e.viewport);this.onMainPointerUpdated(r);}}),this.handleOverlay=document.createElement("div"),e.createHTMLOverlay(this.handleOverlay),this.handleOverlay.style.display="none",this.handleOverlay.classList.add("handleOverlay"),e.notifier.on(7,i=>{this.editor.clearWetInk(),this.expandingSelectionBox||this.selectionBox?.padRegion(),this.selectionBox?.updateUI();}),this.editor.handleKeyEventsFrom(this.handleOverlay),this.editor.handlePointerEventsFrom(this.handleOverlay);}modeValue;selectionBuilder;handleOverlay;prevSelectionBox;selectionBox;removeSelectionScheduled=false;startPoint=null;expandingSelectionBox=false;shiftKeyPressed=false;snapToGrid=false;lastPointer=null;autoscroller;getSelectionColor(){let e=getComputedStyle(this.handleOverlay).getPropertyValue("--selection-background-color");return w.fromString(e).withAlpha(.5)}makeSelectionBox(e){this.prevSelectionBox=this.selectionBox,this.selectionBox=new eo(e,this.editor,this.showContextMenu),this.expandingSelectionBox||this.prevSelectionBox?.cancelSelection(),this.selectionBox.addTo(this.handleOverlay);}showContextMenu=async(e,o=true)=>{await Gn(this.selectionBox,this.editor,e,o,()=>this.clearSelection());};onContextMenu(e){let o=this.selectionBox?.getScreenRegion()?.containsPoint(e.screenPos);return this.showContextMenu(e.canvasPos,o),true}selectionBoxHandlingEvt=false;onPointerDown({allPointers:e,current:o}){let i=this.snapToGrid;if(i&&(o=o.snappedToGrid(this.editor.viewport)),e.length===1){this.startPoint=o.canvasPos;let r=false;return this.selectionBox&&(i&&this.selectionBox.snapSelectedObjectsToGrid(),this.selectionBox.onDragStart(o)&&(r=true,this.selectionBoxHandlingEvt=true,this.expandingSelectionBox=false)),r?this.autoscroller.start():(this.expandingSelectionBox=this.shiftKeyPressed,this.removeSelectionScheduled=!this.expandingSelectionBox,this.modeValue.get()==="lasso"?this.selectionBuilder=new to(o.canvasPos,this.editor.viewport):this.selectionBuilder=new oo(o.canvasPos)),true}return  false}onPointerMove(e){this.onMainPointerUpdated(e.current);}onMainPointerUpdated(e){if(this.lastPointer=e,this.removeSelectionScheduled&&(this.removeSelectionScheduled=false,this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null),this.autoscroller.onPointerMove(e.screenPos),!this.expandingSelectionBox&&this.shiftKeyPressed&&this.startPoint){let o=this.editor.viewport.canvasToScreen(this.startPoint);e=e.lockedToXYAxesScreen(o,this.editor.viewport);}this.snapToGrid&&(e=e.snappedToGrid(this.editor.viewport)),this.selectionBoxHandlingEvt?this.selectionBox?.onDragUpdate(e):(this.selectionBuilder?.onPointerMove(e.canvasPos),this.editor.clearWetInk(),this.selectionBuilder?.render(this.editor.display.getWetInkRenderer(),this.getSelectionColor()));}onPointerUp(e){if(this.onMainPointerUpdated(e.current),this.autoscroller.stop(),this.selectionBoxHandlingEvt)this.selectionBox?.onDragEnd();else if(this.selectionBuilder){let o=this.selectionBuilder.resolve(this.editor.image,this.editor.viewport);this.selectionBuilder=null,this.editor.clearWetInk(),this.expandingSelectionBox&&this.selectionBox?this.setSelection([...this.selectionBox.getSelectedObjects(),...o]):this.setSelection(o);}this.expandingSelectionBox=false,this.removeSelectionScheduled=false,this.selectionBoxHandlingEvt=false,this.lastPointer=null;}onGestureCancel(){this.selectionBuilder&&(this.selectionBuilder=null,this.editor.clearWetInk()),this.autoscroller.stop(),this.selectionBoxHandlingEvt?this.selectionBox?.onDragCancel():this.removeSelectionScheduled||(this.selectionBox?.cancelSelection(),this.selectionBox=this.prevSelectionBox,this.selectionBox?.addTo(this.handleOverlay),this.selectionBox?.recomputeRegion(),this.prevSelectionBox=null),this.removeSelectionScheduled=false,this.expandingSelectionBox=false,this.lastPointer=null,this.selectionBoxHandlingEvt=false;}lastSelectedObjects=[];onSelectionUpdated(){let e=this.selectionBox?.getSelectedItemCount()??0,o=this.selectionBox?.getSelectedObjects()??[];(this.lastSelectedObjects.length!==e||o.some((r,s)=>this.lastSelectedObjects[s]!==r))&&(this.lastSelectedObjects=o,this.editor.notifier.dispatch(2,{kind:2,tool:this}),this.editor.notifier.dispatch(9,{kind:9,selectedComponents:o,tool:this}),e>0&&this.editor.announceForAccessibility(this.editor.localization.selectedElements(e))),e===0&&this.selectionBox&&(this.selectionBox.cancelSelection(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null);}zoomToSelection(){if(this.selectionBox){let e=this.selectionBox.region;this.editor.dispatchNoAnnounce(this.editor.viewport.zoomTo(e,false),false);}}hasUnfinalizedTransformFromKeyPress=false;onKeyPress(e){let o=this.editor.shortcuts;if(o.matchesShortcut(lt,e))return this.snapToGrid=true,true;if(this.selectionBox&&(o.matchesShortcut(Yo,e)||o.matchesShortcut(Xo,e)))return  true;if(o.matchesShortcut(at,e))return this.setSelection(this.editor.image.getAllComponents()),true;if(e.ctrlKey)return  false;if((e.shiftKey||e.key==="Shift")&&(this.shiftKeyPressed=true,e.key==="Shift"))return  true;let i=0,r=0,s=0,a=0,l=0;o.matchesShortcut(Ji,e)?r-=1:o.matchesShortcut(er,e)?r+=1:o.matchesShortcut(tr,e)?s-=1:o.matchesShortcut(or,e)?s+=1:o.matchesShortcut(rr,e)?i+=1:o.matchesShortcut(ir,e)?i-=1:o.matchesShortcut(nr,e)?a-=1:o.matchesShortcut(sr,e)?a+=1:o.matchesShortcut(ar,e)?l-=1:o.matchesShortcut(lr,e)?l+=1:o.matchesShortcut(cr,e)?(a-=1,l-=1):o.matchesShortcut(dr,e)&&(a+=1,l+=1);let c=r!==0||s!==0||i!==0||a!==0||l!==0;if(!this.selectionBox)c=false;else if(c){let d=10*this.editor.viewport.getSizeOfPixelOnCanvas(),p=Math.PI/8,u=5/4,h=this.selectionBox.region,m=exports.Vec2.of(u**a,u**l),b=T.zRotation(i*p).mapEntries(S=>L.roundScaleRatio(S)),v=this.editor.viewport.roundPoint(h.center),f=T.scaling2D(m,this.editor.viewport.roundPoint(h.topLeft)).rightMul(T.translation(v).rightMul(b).rightMul(T.translation(v.times(-1)))).rightMul(T.translation(this.editor.viewport.roundPoint(exports.Vec2.of(r,s).times(d)))),x=this.selectionBox.getTransform();this.selectionBox.setTransform(x.rightMul(f)),this.selectionBox.scrollTo(),this.hasUnfinalizedTransformFromKeyPress=true;}return this.selectionBox&&!c&&(e.key==="Delete"||e.key==="Backspace")&&(this.editor.dispatch(this.selectionBox.deleteSelectedObjects()),this.clearSelection(),c=true),c}onKeyUp(e){let o=this.editor.shortcuts;if(o.matchesShortcut(lt,e))return this.snapToGrid=false,true;if(o.matchesShortcut(at,e))return  true;if(this.selectionBox&&o.matchesShortcut(Yo,e))return this.selectionBox.duplicateSelectedObjects().then(i=>{this.editor.dispatch(i);}),true;if(this.selectionBox&&o.matchesShortcut(Xo,e)){let i=this.selectionBox.sendToBack();return i&&this.editor.dispatch(i),true}return e.shiftKey===false&&(this.shiftKeyPressed=false),e.key==="Shift"?(this.shiftKeyPressed=false,true):this.hasUnfinalizedTransformFromKeyPress?this.selectionBox?(this.selectionBox.finalizeTransform(),this.hasUnfinalizedTransformFromKeyPress=false,true):false:true}onCopy(e){if(!this.selectionBox)return  false;let o=this.selectionBox.getSelectedObjects(),i=this.selectionBox.region;if(o.length===0)return  false;let r=new L(()=>{}),a=this.selectionBox.getScreenRegion().size.times(this.editor.display.getDevicePixelRatio()).maximumEntryMagnitude()/(i.size.maximumEntryMagnitude()||1);a=Math.pow(2,Math.ceil(Math.log2(a))),r.updateScreenSize(i.size.times(a)),r.resetTransform(T.scaling2D(a).rightMul(T.translation(i.topLeft.times(-1))));let{element:l,renderer:c}=oe.fromViewport(r,{sanitize:true,useViewBoxForPositioning:true}),{element:d,renderer:p}=he.fromViewport(r,{maxCanvasDimen:4096}),u=[];for(let h of o)h.render(c),h.render(p),h instanceof q&&u.push(h.getText());return e.setData("image/svg+xml",l.outerHTML),e.setData("text/html",l.outerHTML),e.setData("image/png",new Promise((h,m)=>{d.toBlob(g=>{g?h(g):m(new Error("Failed to convert canvas to blob."));},"image/png");})),u.length>0&&e.setData("text/plain",u.join(`
`)),true}setEnabled(e){let o=this.isEnabled();super.setEnabled(e),o!==e&&(this.selectionBox?.cancelSelection(),this.onSelectionUpdated(),this.handleOverlay.replaceChildren(),this.selectionBox=null,this.shiftKeyPressed=false,this.snapToGrid=false,this.handleOverlay.style.display=e?"block":"none",e?(this.handleOverlay.tabIndex=0,this.handleOverlay.role="group",this.handleOverlay.ariaLabel=this.editor.localization.selectionToolKeyboardShortcuts):this.handleOverlay.tabIndex=-1);}getSelection(){return this.selectionBox}isSelecting(){return !!this.selectionBuilder}getSelectedObjects(){return this.selectionBox?.getSelectedObjects()??[]}setSelection(e){e=e.filter(i=>i.isSelectable()),e.sort((i,r)=>i.getZIndex()-r.getZIndex()),e=e.filter((i,r)=>r>0?i!==e[r-1]:true);let o=null;for(let i of e)o?o=o.union(i.getBBox()):o=i.getBBox();this.clearSelectionNoUpdateEvent(),o&&this.makeSelectionBox(e),this.onSelectionUpdated();}clearSelectionNoUpdateEvent(){this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null;}clearSelection(){this.clearSelectionNoUpdateEvent(),this.onSelectionUpdated();}};function ga(n,t,e){let o=document.createElement("div");o.classList.add("selection-format-menu",`${E}spacedList`,`${E}indentedList`);let i=document.createElement("div"),r=document.createElement("label"),s=be(n,d=>{let p=t.getSelection();if(p){let u=[];for(let m of p.getSelectedObjects())Fo(m)&&u.push(m.updateStyle({color:d}));let h=j(u);n.dispatch(h);}}),{input:a,container:l}=s;r.innerText=e.colorLabel;let c=()=>{let d=t.getSelection();if(d&&d.getSelectedItemCount()>0){a.disabled=false,o.classList.remove("disabled");let p=[];for(let u of d.getSelectedObjects())if(Fo(u)){let h=u.getStyle().color;h&&p.push(h);}s.setValue(w.average(p));}else a.disabled=true,o.classList.add("disabled"),s.setValue(w.transparent);};return i.replaceChildren(r,l),o.replaceChildren(i),{addTo:d=>{d.appendChild(o);},update:c,registerHelpText:d=>{d.registerTextHelpForElement(i,e.selectionDropdown__changeColorHelpText),s.registerWithHelpTextDisplay(d);}}}var Fr=class extends _{constructor(e,o,i){super(e,"selection-mode-toggle",i);this.tool=o;e.notifier.on(2,r=>{r.kind===2&&r.tool===o&&this.setSelected(o.modeValue.get()==="lasso");}),this.setSelected(false);}shouldAutoDisableInReadOnlyEditor(){return  false}setModeFlag(e){this.tool.modeValue.set(e?"lasso":"rect");}handleClick(){this.setModeFlag(!this.isSelected());}getTitle(){return this.localizationTable.selectionTool__lassoSelect}createIcon(){return this.editor.icons.makeSelectionIcon("lasso")}fillDropdown(e){return  false}getHelpText(){return this.localizationTable.selectionTool__lassoSelect__help}},xt=class extends ee{constructor(e,o,i){super(e,o,"selection-tool-widget",i);this.tool=o;this.addSubWidget(new Fr(e,o,this.localizationTable));let r=()=>{let s=this.tool.getSelection();return !!s&&s.getSelectedItemCount()>0};this.hasSelectionValue=K.fromInitialValue(r()),this.editor.notifier.on(2,s=>{if(s.kind!==2)throw new Error("Invalid event type!");s.tool===this.tool&&(this.hasSelectionValue.set(r()),this.updateFormatMenu());}),o.modeValue.onUpdate(()=>{this.updateIcon();});}updateFormatMenu=()=>{};hasSelectionValue;resizeImageToSelection(){let e=this.tool.getSelection();e&&this.editor.dispatch(this.editor.setImportExportRect(e.region));}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(Zi,e)?(this.resizeImageToSelection(),true):!!super.onKeyPress(e)}getTitle(){return this.localizationTable.select}createIcon(){return this.editor.icons.makeSelectionIcon(this.tool.modeValue.get())}getHelpText(){return this.localizationTable.selectionDropdown__baseHelpText}createSelectionActions(e){let o=this.editor.icons;return {container:Un([{icon:()=>o.makeDeleteSelectionIcon(),label:this.localizationTable.deleteSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__deleteHelpText);},onClick:()=>{let r=this.tool.getSelection();this.editor.dispatch(r.deleteSelectedObjects()),this.tool.clearSelection();},enabled:this.hasSelectionValue},{icon:()=>o.makeDuplicateSelectionIcon(),label:this.localizationTable.duplicateSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__duplicateHelpText);},onClick:async()=>{let s=await this.tool.getSelection()?.duplicateSelectedObjects();s&&this.editor.dispatch(s);},enabled:this.hasSelectionValue},{icon:()=>o.makeResizeImageToSelectionIcon(),label:this.localizationTable.resizeImageToSelection,onCreated:r=>{e?.registerTextHelpForElement(r,this.localizationTable.selectionDropdown__resizeToHelpText);},onClick:()=>{this.resizeImageToSelection();},enabled:this.hasSelectionValue}],3).container}}fillDropdown(e,o){super.fillDropdown(e,o);let i=document.createElement("div");i.classList.add(`${E}nonbutton-controls-main-list`),e.appendChild(i),Xt().addTo(i);let r=this.createSelectionActions(o);i.appendChild(r.container),Xt(this.localizationTable.reformatSelection).addTo(i);let s=ga(this.editor,this.tool,this.localizationTable);return s.addTo(i),this.updateFormatMenu=()=>s.update(),o&&s.registerHelpText(o),s.update(),true}serializeState(){return {...super.serializeState(),selectionMode:this.tool.modeValue.get()}}deserializeFrom(e){super.deserializeFrom(e),Object.values(Jt).includes(e.selectionMode)&&this.tool.modeValue.set(e.selectionMode);}};var St=class n extends ee{constructor(e,o,i){super(e,o,"text-tool-widget",i);this.tool=o;e.notifier.on(2,r=>{r.kind===2&&r.tool===o&&(this.updateIcon(),this.updateDropdownInputs?.());});}updateDropdownInputs=null;getTitle(){return this.targetTool.description}createIcon(){let e=this.tool.getTextStyle();return this.editor.icons.makeTextIcon(e)}static idCounter=0;fillDropdown(e){let o=document.createElement("div");o.classList.add(`${E}spacedList`,`${E}nonbutton-controls-main-list`);let i=document.createElement("div"),r=document.createElement("div"),s=document.createElement("div"),a=document.createElement("select"),l=document.createElement("label"),c=document.createElement("input"),d=document.createElement("label"),{input:p,container:u,setValue:h}=be(this.editor,f=>{this.tool.setColor(f);}),m=document.createElement("label"),g=new Set,b=f=>{let x=document.createElement("option");x.value=f,x.textContent=f,a.appendChild(x),g.add(f);};c.setAttribute("type","number"),c.min="1",c.max="128",l.innerText=this.localizationTable.fontLabel,m.innerText=this.localizationTable.colorLabel,d.innerText=this.localizationTable.textSize,p.id=`${E}-text-color-input-${n.idCounter++}`,m.setAttribute("for",p.id),c.id=`${E}-text-size-input-${n.idCounter++}`,d.setAttribute("for",c.id);let v=this.editor.getCurrentSettings().text?.fonts??[];for(let f of v)b(f);return a.classList.add("font-selector"),a.id=`${E}-text-font-input-${n.idCounter++}`,l.setAttribute("for",a.id),a.addEventListener("change",()=>{this.tool.setFontFamily(a.value);}),c.addEventListener("change",()=>{let f=Number.parseInt(c.value);!isNaN(f)&&f>0&&this.tool.setFontSize(f);}),r.appendChild(m),r.appendChild(u),i.appendChild(l),i.appendChild(a),s.appendChild(d),s.appendChild(c),this.updateDropdownInputs=()=>{let f=this.tool.getTextStyle();h(f.renderingStyle.fill),g.has(f.fontFamily)||b(f.fontFamily),a.value=f.fontFamily,c.value=`${f.size}`;},this.updateDropdownInputs(),o.replaceChildren(r,s,i),e.appendChild(o),true}serializeState(){let e=this.tool.getTextStyle();return {...super.serializeState(),fontFamily:e.fontFamily,textSize:e.size,color:e.renderingStyle.fill.toHexString()}}deserializeFrom(e){e.fontFamily&&typeof e.fontFamily=="string"&&this.tool.setFontFamily(e.fontFamily),e.color&&typeof e.color=="string"&&this.tool.setColor(w.fromHex(e.color)),e.textSize&&typeof e.textSize=="number"&&this.tool.setFontSize(e.textSize),super.deserializeFrom(e);}};var Ee=class extends M{constructor(e,o,i){super(e.notifier,o);this.editor=e;this.styleValue=F.fromInitialValue({factory:le,color:w.blue,thickness:1.5,...i}),this.styleValue.onUpdateAndNow(r=>{this.style=r,this.noteUpdated();});}builder=null;lastPoint=null;startPoint=null;currentDeviceType=null;currentPointerId=null;styleValue;style;shapeAutocompletionEnabled=false;pressureSensitivityEnabled=true;autocorrectedShape=null;lastAutocorrectedShape=null;removedAutocorrectedShapeTime=0;stationaryDetector=null;getPressureMultiplier(){let e=this.style.thickness;return 1/this.editor.viewport.getScaleFactor()*e}toStrokePoint(e){let r=Math.max(e.pressure??1,.3);isFinite(r)||(console.warn("Non-finite pressure!",e),r=.3),console.assert(isFinite(e.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(e.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(e.timeStamp),"Non-finite timeStamp on pointer!");let s=e.canvasPos;return this.getPressureSensitivityEnabled()||(r=.5),{pos:s,width:r*this.getPressureMultiplier(),color:this.style.color,time:e.timeStamp}}setPressureSensitivityEnabled(e){e!==this.pressureSensitivityEnabled&&(this.pressureSensitivityEnabled=e,this.noteUpdated());}getPressureSensitivityEnabled(){return this.pressureSensitivityEnabled}previewStroke(){this.editor.clearWetInk();let e=this.editor.display.getWetInkRenderer();if(this.autocorrectedShape){let o=this.editor.viewport.visibleRect;this.autocorrectedShape.render(e,o);}else this.builder?.preview(e);}addPointToStroke(e){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(e),this.lastPoint=e,this.previewStroke();}onPointerDown(e){if(this.builder&&!this.eventCanCancelStroke(e))return  true;let{current:o,allPointers:i}=e,r=o.device===1,s=o.device===0;return i.length===1&&!r||s?(this.startPoint=this.toStrokePoint(o),this.builder=this.style.factory(this.startPoint,this.editor.viewport),this.currentDeviceType=o.device,this.currentPointerId=o.id,this.shapeAutocompletionEnabled?this.stationaryDetector=new Pe(o,ct,a=>this.autocorrectShape(a)):this.stationaryDetector=null,this.lastAutocorrectedShape=null,this.removedAutocorrectedShapeTime=0,true):false}eventCanCancelStroke(e){let o=this.lastPoint?.time??0;if(e.current.timeStamp-o>1e3)return  true;let i=this.currentDeviceType===0,r=e.current.device===2;return !(i&&r)}eventCanBeDeliveredToNonActiveTool(e){return this.eventCanCancelStroke(e)}onPointerMove({current:e}){if(!this.builder||e.device!==this.currentDeviceType||e.id!==this.currentPointerId)return;this.stationaryDetector?.onPointerMove(e)||(this.addPointToStroke(this.toStrokePoint(e)),this.autocorrectedShape&&(this.removedAutocorrectedShapeTime=performance.now(),this.autocorrectedShape=null,this.editor.announceForAccessibility(this.editor.localization.autocorrectionCanceled)));}onPointerUp({current:e}){if(!this.builder)return  false;if(e.id!==this.currentPointerId)return  true;this.stationaryDetector?.onPointerUp(e);let o=this.toStrokePoint(e),i={...o,width:this.lastPoint?.width??o.width};return this.addPointToStroke(i),this.finalizeStroke(),false}onGestureCancel(){this.builder=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}removedAutocorrectedShapeRecently(){return this.removedAutocorrectedShapeTime>performance.now()-320}async autocorrectShape(e){if(!this.builder||!this.builder.autocorrectShape||!this.shapeAutocompletionEnabled||this.autocorrectedShape)return;let o=await this.builder.autocorrectShape();if(!this.builder||!o)return;let i=o.getBBox().area;if(i===0||!isFinite(i))return;let r=o.description(this.editor.localization);this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(r)),this.autocorrectedShape=o,this.lastAutocorrectedShape=o,this.previewStroke();}finalizeStroke(){if(this.builder){this.lastAutocorrectedShape&&this.removedAutocorrectedShapeRecently()&&(this.autocorrectedShape=this.lastAutocorrectedShape);let e=this.autocorrectedShape??this.builder.build();if(this.previewStroke(),e.getBBox().area>0){e===this.autocorrectedShape&&this.editor.announceForAccessibility(this.editor.localization.autocorrectedTo(e.description(this.editor.localization)));let i=H.addComponent(e,true);this.editor.dispatch(i);}else console.warn("Pen: Not adding empty stroke",e,"to the canvas.");}this.builder=null,this.lastPoint=null,this.autocorrectedShape=null,this.lastAutocorrectedShape=null,this.editor.clearWetInk(),this.stationaryDetector?.destroy(),this.stationaryDetector=null;}noteUpdated(){this.editor.notifier.dispatch(2,{kind:2,tool:this});}setColor(e){e.toHexString()!==this.style.color.toHexString()&&this.styleValue.set({...this.style,color:e});}setThickness(e){e!==this.style.thickness&&this.styleValue.set({...this.style,thickness:e});}setStrokeFactory(e){e!==this.style.factory&&this.styleValue.set({...this.style,factory:e});}setHasStabilization(e){let o=!!this.getInputMapper();e!==o&&(o?this.setInputMapper(null):this.setInputMapper(new Ge(this.editor.viewport)),this.noteUpdated());}setStrokeAutocorrectEnabled(e){e!==this.shapeAutocompletionEnabled&&(this.shapeAutocompletionEnabled=e,this.noteUpdated());}getStrokeAutocorrectionEnabled(){return this.shapeAutocompletionEnabled}getThickness(){return this.style.thickness}getColor(){return this.style.color}getStrokeFactory(){return this.style.factory}getStyleValue(){return this.styleValue}onKeyPress(e){let o=this.editor.shortcuts,i=o.matchesShortcut(qe,e);if(this.builder&&i)return this.finalizeStroke(),false;let r;return o.matchesShortcut(_e,e)?r=this.getThickness()*2/3:o.matchesShortcut(Ze,e)&&(r=this.getThickness()*3/2),r!==void 0?(r=Math.min(Math.max(1,r),256),this.setThickness(r),true):false}};var Qn="textEditorOverlay",ve=class extends M{constructor(e,o,i){super(e.notifier,o);this.editor=e;this.localizationTable=i;let r=e.getCurrentSettings().text?.fonts??[];this.textStyleValue=F.fromInitialValue({size:32,fontFamily:r.length>0?r[0]:"sans-serif",renderingStyle:{fill:w.black}}),this.textStyleValue.onUpdateAndNow(()=>{this.textStyle=this.textStyleValue.get(),this.updateTextInput(),this.editor.notifier.dispatch(2,{kind:2,tool:this});}),this.contentTransform=F.fromInitialValue(T.identity),this.textEditOverlay=document.createElement("div"),this.textEditOverlay.classList.add(Qn),this.editor.addStyleSheet(`
			.${Qn} textarea {
				background-color: rgba(0, 0, 0, 0.1);

				white-space: pre;
				overflow: hidden;

				padding: 8px;
				margin: 0;

				min-width: 100px;
				min-height: 1.1em;
        border: 1px solid black;
        border-radius: 6px;
			}
		`),this.anchorControl=this.editor.anchorElementToCanvas(this.textEditOverlay,this.contentTransform);}textStyleValue;textStyle;anchorControl;contentTransform;textEditOverlay;textInputElem=null;textMeasuringCtx=null;removeExistingCommand=null;initTextMeasuringCanvas(){this.textMeasuringCtx??=document.createElement("canvas").getContext("2d");}getTextAscent(e,o){if(this.initTextMeasuringCanvas(),this.textMeasuringCtx){this.textMeasuringCtx.textBaseline="alphabetic",q.applyTextStyles(this.textMeasuringCtx,o);let i=this.textMeasuringCtx.measureText(e);return i.fontBoundingBoxAscent??i.actualBoundingBoxAscent}return o.size*2/3}flushInput(e=true){if(!this.textInputElem)return;let o=this.textEditOverlay.parentElement,i=exports.Vec2.of(o?.scrollLeft??0,o?.scrollTop??0),r=this.textInputElem.value.trimEnd();if(this.textInputElem.value="",e){let s=this.textInputElem;this.textInputElem=null,s.remove();}if(r!==""){let s=i.times(-1),a=this.editor.viewport.screenToCanvasTransform.transformVec3(s),l=T.translation(a),c=q.fromLines(r.split(`
`),l.rightMul(this.contentTransform.get()),this.textStyle),d=H.addComponent(c);this.removeExistingCommand?(this.removeExistingCommand.unapply(this.editor),this.editor.dispatch(j([this.removeExistingCommand,d])),this.removeExistingCommand=null):this.editor.dispatch(d);}}updateTextInput(){if(!this.textInputElem)return;this.textInputElem.placeholder=this.localizationTable.enterTextToInsert,this.textInputElem.style.fontFamily=this.textStyle.fontFamily,this.textInputElem.style.fontStyle=this.textStyle.fontStyle??"",this.textInputElem.style.fontVariant=this.textStyle.fontVariant??"",this.textInputElem.style.fontWeight=this.textStyle.fontWeight??"",this.textInputElem.style.fontSize=`${this.textStyle.size}px`,this.textInputElem.style.color=this.textStyle.renderingStyle.fill.toHexString(),this.textInputElem.style.margin="0",this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`;let i=this.getTextAscent("Testing!",this.textStyle);this.textInputElem.style.transform=`translate(0, ${-i}px)`,this.textInputElem.style.transformOrigin="top left";let r=Math.floor(this.textStyle.size);this.textInputElem.style.lineHeight=`${r}px`;}startTextInput(e,o){this.flushInput(),this.textInputElem=document.createElement("textarea"),this.textInputElem.value=o,this.textInputElem.style.display="inline-block";let i=this.editor.viewport.roundPoint(e),r=-this.editor.viewport.getRotationAngle(),s=exports.Vec2.of(1,1).times(this.editor.viewport.getSizeOfPixelOnCanvas());this.contentTransform.set(T.translation(i).rightMul(T.zRotation(r)).rightMul(T.scaling2D(s))),this.updateTextInput(),setTimeout(()=>this.updateTextInput(),0),this.textInputElem.addEventListener("input",()=>{this.textInputElem&&(this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`);}),this.textInputElem.addEventListener("blur",()=>{let a=this.textInputElem;this.flushInput(false),this.textInputElem=null,a&&a.classList.add("-hiding"),setTimeout(()=>{a?.remove();},0);}),this.textInputElem.addEventListener("keyup",a=>{a.isComposing||(a.key==="Enter"&&!a.shiftKey?(this.flushInput(),this.editor.focus()):a.key==="Escape"&&(this.textInputElem?.remove(),this.textInputElem=null,this.editor.focus(),this.removeExistingCommand?.unapply(this.editor),this.removeExistingCommand=null));}),this.textEditOverlay.replaceChildren(this.textInputElem),setTimeout(()=>this.textInputElem?.focus(),0);}setEnabled(e){super.setEnabled(e),this.isEnabled()||this.flushInput(),this.textEditOverlay.style.display=e?"block":"none";}onPointerDown({current:e,allPointers:o}){if(e.device===1)return  false;if(o.length===1){let i=e.canvasPos,r=exports.Vec2.of(4,4).times(this.editor.viewport.getSizeOfPixelOnCanvas()),s=P.fromCorners(i.minus(r),i.plus(r)),l=this.editor.image.getComponentsIntersecting(s).filter(d=>d instanceof q),c=this.editor.viewport.visibleRect;if(l=l.filter(d=>!d.getBBox().containsRect(c)),this.flushInput(),l.length>0){let d=l[l.length-1];this.setTextStyle(d.getTextStyle()),this.removeExistingCommand=new U([d]),this.removeExistingCommand.apply(this.editor),this.startTextInput(d.getBaselinePos(),d.getText()),this.contentTransform.set(d.getTransform()),this.updateTextInput();}else this.removeExistingCommand=null,this.startTextInput(e.canvasPos,"");return  true}return  false}onGestureCancel(){this.flushInput(),this.editor.focus();}setFontFamily(e){e!==this.textStyle.fontFamily&&this.textStyleValue.set({...this.textStyle,fontFamily:e});}setColor(e){e.eq(this.textStyle.renderingStyle.fill)||this.textStyleValue.set({...this.textStyle,renderingStyle:{...this.textStyle.renderingStyle,fill:e}});}setFontSize(e){e!==this.textStyle.size&&this.textStyleValue.set({...this.textStyle,size:e});}getTextStyle(){return this.textStyle}getStyleValue(){return this.textStyleValue}setTextStyle(e){this.textStyleValue.set(e);}onDestroy(){super.onDestroy(),this.anchorControl.remove();}};var Ve=class n{constructor(t,e){this.editor=t;this.localizationTable=e??t.localization,n.colorisStarted||(n.colorisStarted=true),this.setupColorPickers();}#e=[];#t={};widgetList=[];static colorisStarted=false;#o=null;localizationTable;closeColorPickerOverlay=null;setupCloseColorPickerOverlay(){this.closeColorPickerOverlay||(this.closeColorPickerOverlay=document.createElement("div"),this.closeColorPickerOverlay.className=`${E}closeColorPickerOverlay`,this.editor.createHTMLOverlay(this.closeColorPickerOverlay),this.#e.push(this.editor.handlePointerEventsExceptClicksFrom(this.closeColorPickerOverlay,t=>(t==="pointerup"&&this.editor.focus(),true))));}setupColorPickers(){if(this.#o){this.#o();return}this.setupCloseColorPickerOverlay();let t=12,e=[w.red.toHexString(),w.purple.toHexString(),w.blue.toHexString(),w.clay.toHexString(),w.black.toHexString(),w.white.toHexString()],o=e.length,r=()=>{};this.#o=r;let s=a=>{let l=false;for(let c of e)c===a&&(l=true);l||(e.push(a),e.length>t&&e.splice(o,1),r());};this.#e.push(this.editor.notifier.on(11,a=>{a.kind===11&&this.closeColorPickerOverlay&&(this.closeColorPickerOverlay.style.display=a.open?"block":"none");})),this.#e.push(this.editor.notifier.on(12,a=>{a.kind===12&&s(a.color.toHexString());}));}closeColorPickers(){}getWidgetUniqueId(t){return t.getUniqueIdIn(this.#t)}getWidgetFromId(t){return this.#t[t]}getAllWidgets(){return this.widgetList}addWidget(t){let e=t.getUniqueIdIn(this.#t);this.#t[e]=t,this.widgetList.push(t),this.addWidgetInternal(t),this.setupColorPickers();}removeWidget(t){let e=t.getUniqueIdIn(this.#t);this.removeWidgetInternal(t),delete this.#t[e],this.widgetList=this.widgetList.filter(o=>o!==t);}static rootToolbarId="root-toolbar--";serializeState(){let t={};for(let e in this.#t)t[e]=this.#t[e].serializeState();return t[n.rootToolbarId]=this.serializeInternal(),JSON.stringify(t)}deserializeState(t){let e=JSON.parse(t);Ro(e),an(e);let o=n.rootToolbarId;o in e&&typeof e[o]<"u"&&this.deserializeInternal(e[o]);for(let i in e)if(i!==o){if(!(i in this.#t)){console.warn(`Unable to deserialize widget ${i} \xAD\u2014 no such widget.`);continue}typeof e[i]=="object"&&e[i]&&this.#t[i].deserializeFrom(e[i]);}}serializeInternal(){}deserializeInternal(t){}makeActionButton(t,e,o=true){typeof o=="boolean"&&(o={mustBeToplevel:o});let i=o.mustBeToplevel??true,r=o.autoDisableInReadOnlyEditors??true,s=typeof t=="string"?t:t.label,a="action-button",l=()=>typeof t=="string"?null:t.icon;return new ye(this.editor,a,l,s,e,this.editor.localization,i,r)}addActionButton(t,e,o=true){let i=this.makeActionButton(t,e,o);return this.addWidget(i),i}addTaggedActionButton(t,e,o,i=true){let r=this.makeActionButton(e,o,i);return r.setTags(t),this.addWidget(r),r}addSaveButton(t,e={}){let o=new Nn(this.editor,this.localizationTable,t,e);return this.addWidget(o),o}addExitButton(t,e={}){let o=new Hn(this.editor,this.localizationTable,t,e);return this.addWidget(o),o}addUndoRedoButtons(t=true){let e=()=>this.addTaggedActionButton(["undo"],{label:this.localizationTable.undo,icon:this.editor.icons.makeUndoIcon()},()=>{this.editor.history.undo();}),o=()=>this.addTaggedActionButton(["redo"],{label:this.localizationTable.redo,icon:this.editor.icons.makeRedoIcon()},()=>{this.editor.history.redo();}),i,r;t?(i=e(),r=o()):(r=o(),i=e()),i.setDisabled(true),r.setDisabled(true),this.editor.notifier.on(3,s=>{if(s.kind!==3)throw new Error("Wrong event type!");i.setDisabled(s.undoStackSize===0),r.setDisabled(s.redoStackSize===0);});}addWidgetsForPrimaryTools(t){for(let e of this.editor.toolController.getPrimaryTools())if(!(t&&!t?.(e)))if(e instanceof Ee){let o=new mt(this.editor,e,this.localizationTable);this.addWidget(o);}else if(e instanceof je){let o=new _t(this.editor,e,this.localizationTable);this.addWidget(o);}else e instanceof Ae?this.addWidget(new ut(this.editor,e,this.localizationTable)):e instanceof re?this.addWidget(new xt(this.editor,e,this.localizationTable)):e instanceof ve?this.addWidget(new St(this.editor,e,this.localizationTable)):e instanceof ae&&this.addWidget(new ht(this.editor,e,this.localizationTable));}addDefaultToolWidgets(){this.addWidgetsForPrimaryTools(),this.addDefaultEditorControlWidgets();}addDefaultEditorControlWidgets(){this.addWidget(new pt(this.editor,this.localizationTable));}addDefaultActionButtons(){this.addUndoRedoButtons();}remove(){this.closeColorPickerOverlay?.remove();for(let t of this.#e)t.remove();this.#e=[],this.onRemove();for(let t of this.widgetList)t.remove();}manageListener(t){this.#e.push(t);}};function Jn(n){return n instanceof V?new class extends V{_command=n;serializeToJSON(){return n.serialize()}apply(t){n.unapply(t);}unapply(t){n.apply(t);}onDrop(t){n.onDrop(t);}description(t,e){return e.inverseOf(n.description(t,e))}}("inverse"):new class extends fe{apply(e){n.unapply(e);}unapply(e){n.apply(e);}onDrop(e){n.onDrop(e);}description(e,o){return o.inverseOf(n.description(e,o))}}}V.register("inverse",(n,t)=>Jn(V.deserialize(n,t)));var ba=Jn;var es="find-tool",no=class extends M{constructor(e){super(e.notifier,e.localization.findLabel);this.editor=e;this.overlay=document.createElement("div"),this.fillOverlay(),e.createHTMLOverlay(this.overlay),this.overlay.style.display="none",this.overlay.classList.add(`${es}-overlay`);}overlay;searchInput;currentMatchIdx=0;canReceiveInputInReadOnlyEditor(){return  true}getMatches(e){let o=e.toLocaleLowerCase();return this.editor.image.getAllComponents().filter(r=>{let s="";if(r instanceof q)s=r.getText();else if(r instanceof te)s=r.getAltText()??"";else return  false;let a=s.toLocaleLowerCase().includes(o),l=s.includes(e);return a||l}).map(r=>r.getBBox())}focusCurrentMatch(){let e=this.getMatches(this.searchInput.value),o=this.currentMatchIdx%e.length;o<0&&(o=e.length+o),o<e.length&&(this.editor.dispatch(this.editor.viewport.zoomTo(e[o],true,true),false),this.editor.announceForAccessibility(this.editor.localization.focusedFoundText(o+1,e.length)));}toNextMatch(){this.currentMatchIdx++,this.focusCurrentMatch();}toPrevMatch(){this.currentMatchIdx--,this.focusCurrentMatch();}fillOverlay(){let e=document.createElement("label");this.searchInput=document.createElement("input");let o=document.createElement("button"),i=document.createElement("button");this.searchInput.setAttribute("id",`${es}-searchInput-${Math.random()}`),e.htmlFor=this.searchInput.getAttribute("id"),e.innerText=this.editor.localization.findLabel,o.innerText=this.editor.localization.toNextMatch,i.innerText=this.editor.localization.closeDialog,this.searchInput.addEventListener("keydown",r=>{r.key==="Enter"?r.shiftKey?this.toPrevMatch():this.toNextMatch():r.key==="Escape"?this.setVisible(false):this.editor.shortcuts.matchesShortcut(Qo,r)&&(r.preventDefault(),this.toggleVisible());}),o.addEventListener("click",()=>{this.toNextMatch();}),i.addEventListener("click",()=>{this.setVisible(false);}),this.overlay.replaceChildren(e,this.searchInput,o,i);}isVisible(){return this.overlay.style.display!=="none"}setVisible(e){e!==this.isVisible()&&(this.overlay.style.display=e?"block":"none",e?(this.searchInput.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogShown)):(this.editor.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogHidden)));}toggleVisible(){this.setVisible(!this.isVisible());}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(Qo,e)?(this.toggleVisible(),true):false}setEnabled(e){super.setEnabled(e),this.isEnabled()&&this.setVisible(false);}};var so=class extends ce{#e=null;#t=null;onEvent(t){return this.#e===null?this.emit(t):this.#e.onEvent(t)}addToTail(t){this.#t?(this.#t.setEmitListener(t),this.#t=t):(this.#e=t,this.#t=this.#e),this.#t.setEmitListener(e=>this.emit(e));}};var Ct=class extends M{constructor(e){super(e.notifier,e.localization.pasteHandler);this.editor=e;}onPaste(e,o){let i=e.mime.toLowerCase(),r=(()=>{if(i==="image/svg+xml")return e.data;if(i==="text/plain"){let l=e.data.trim();if(l.startsWith("<svg")&&l.endsWith("</svg>"))return l}if(i!=="text/html"||!e.data.match(/^[^]{0,200}<svg.*/i))return  false;let a=e.data.toLowerCase().lastIndexOf("</svg>");return a===-1&&(a=e.data.length),e.data.substring(e.data.search(/<svg/i),a)})();return r?(this.doSVGPaste(r).then(o),true):i==="text/plain"?(this.doTextPaste(e.data).then(o),true):i==="image/png"||i==="image/jpeg"?(this.doImagePaste(e.data).then(o),true):false}async addComponentsFromPaste(e){await this.editor.addAndCenterComponents(e,true,this.editor.localization.pasted(e.length));}async doSVGPaste(e){this.editor.showLoadingWarning(0);try{let o=De.fromString(e,{sanitize:!0,plugins:this.editor.getCurrentSettings().svg?.loaderPlugins??[]}),i=[];await o.start(r=>{i.push(r);},(r,s)=>null),await this.addComponentsFromPaste(i);}finally{this.editor.hideLoadingWarning();}}async doTextPaste(e){let o=this.editor.toolController.getMatchingTools(ve);o.sort((a,l)=>!a.isEnabled()&&l.isEnabled()?-1:!l.isEnabled()&&a.isEnabled()?1:0);let i={size:12,fontFamily:"sans",renderingStyle:{fill:w.red}},r=o[0]?.getTextStyle()??i;if(e.trim()==="")return;let s=e.split(`
`);await this.addComponentsFromPaste([q.fromLines(s,T.identity,r)]);}async doImagePaste(e){let o=new Image;o.src=e;let i=await te.fromImage(o,T.identity);await this.addComponentsFromPaste([i]);}};var Tt=class extends M{constructor(e){super(e.notifier,e.localization.selectAllTool);this.editor=e;}canReceiveInputInReadOnlyEditor(){return  true}onKeyPress(e){if(this.editor.shortcuts.matchesShortcut(at,e)){let o=this.editor.toolController.getMatchingTools(re);if(o.length>0){let i=o[0];return i.setEnabled(true),i.setSelection(this.editor.image.getAllComponents()),true}}return  false}};var Je=class{activeTool;constructor(){}notifyEnabled(t){t!==this.activeTool&&(this.activeTool?.setEnabled(false),this.activeTool=t);}setEnabled(t){t!==this.activeTool||!this.activeTool?(this.activeTool?.setEnabled(false),t.setEnabled(true),this.activeTool=t):(this.activeTool?.setEnabled(false),t.setEnabled(false),this.activeTool=null);}};var wt=class extends M{constructor(e){super(e.notifier,e.localization.changeTool);this.editor=e;}canReceiveInputInReadOnlyEditor(){return  true}onKeyPress({key:e}){let i=this.editor.toolController.getPrimaryTools(),r=/^\d$/.exec(e),s;if(r){let a=Number.parseInt(r[0],10)-1;s=i[a];}return s?(s.setEnabled(true),true):false}};var Pt=class extends M{constructor(e){super(e.notifier,e.localization.undoRedoTool);this.editor=e;}onKeyPress(e){return this.editor.shortcuts.matchesShortcut(qe,e)?(this.editor.history.undo(),true):this.editor.shortcuts.matchesShortcut(pr,e)?(this.editor.history.redo(),true):false}};var Et=class{tools;activeTool=null;primaryToolGroup;inputPipeline;isEditorReadOnly;constructor(t,e){this.isEditorReadOnly=t.isReadOnlyReactiveValue(),this.inputPipeline=new so,this.inputPipeline.setEmitListener(p=>this.onEventInternal(p));let o=new Je;this.primaryToolGroup=o;let i=new ae(t,6,e.touchPanTool),r=new ae(t,16,e.keyboardPanZoom),s=new Ee(t,e.penTool(1),{color:w.black,thickness:1.5}),a=new je(t,e.penTool(3),{color:w.black,borderColor:w.black,thickness:0}),l=new Ae(t,e.eraserTool),c=[new re(t,e.selectionTool),new ve(t,e.textTool,e),s,new Ee(t,e.penTool(2),{color:w.blackHighlight,thickness:40,factory:ze}),l,a];a.setEnabled(false);let d=[i,r,new ae(t,8,e.anyDevicePanning)];this.tools=[...c,new Pt(t),new Re(t),new wt(t),l.makeEraserSwitcherTool(),new no(t),new Ct(t),new Tt(t)],t.getCurrentSettings().disableZoom||this.tools.push(...d),c.forEach(p=>p.setToolGroup(o)),i.setEnabled(true),s.setEnabled(true),t.notifier.on(0,p=>{p.kind===0&&t.announceForAccessibility(e.toolEnabledAnnouncement(p.tool.description));}),t.notifier.on(1,p=>{p.kind===1&&t.announceForAccessibility(e.toolDisabledAnnouncement(p.tool.description));}),this.activeTool=null;}setTools(t,e){this.tools=t,this.primaryToolGroup=e??new Je;}addPrimaryTool(t){t.setToolGroup(this.primaryToolGroup),t.isEnabled()&&this.primaryToolGroup.notifyEnabled(t),this.tools.includes(t)||this.addTool(t);}getPrimaryTools(){return this.tools.filter(t=>t.getToolGroup()===this.primaryToolGroup)}setToolEnabled(t){this.primaryToolGroup.setEnabled(t);}addTool(t,e){this.tools.includes(t)||(e?.addToFront?this.tools.splice(0,0,t):this.tools.push(t));}removeAndDestroyTools(t){let e=[];for(let o of this.tools)t.includes(o)?(this.activeTool===o&&(this.activeTool=null),o.onDestroy()):e.push(o);this.tools=e;}insertTools(t,e,o){this.tools=this.tools.filter(r=>!e.includes(r));let i=[];for(let r of this.tools)o==="after"&&i.push(r),r===t&&i.push(...e),o==="before"&&i.push(r);this.tools=i;}insertToolsAfter(t,e){this.insertTools(t,e,"after");}insertToolsBefore(t,e){this.insertTools(t,e,"before");}onEventInternal(t){let e=this.isEditorReadOnly.get(),o=r=>r.isEnabled()&&(!e||r.canReceiveInputInReadOnlyEditor()),i=false;if(t.kind===0){let r=false;this.activeTool&&!this.activeTool.eventCanBeDeliveredToNonActiveTool(t)&&(r=true);for(let s of this.tools)if(!(r&&s!==this.activeTool)&&o(s)&&s.onEvent(t)){this.activeTool!==s&&this.activeTool?.onEvent({kind:3}),this.activeTool=s,i=true;break}}else if(t.kind===2)this.activeTool?.onEvent(t)&&t.allPointers.length>1||(this.activeTool=null),i=true;else if(t.kind===1)this.activeTool!==null&&(this.activeTool.onEvent(t),i=true);else if(t.kind===3)this.activeTool!==null&&(this.activeTool.onEvent(t),this.activeTool=null);else for(let r of this.tools)if(o(r)&&(i=r.onEvent(t),i))break;return i}onEvent(t){return this.dispatchInputEvent(t)}dispatchInputEvent(t){return this.inputPipeline.onEvent(t)}addInputMapper(t){this.inputPipeline.addToTail(t);}getMatchingTools(t){return this.tools.filter(e=>e instanceof t)}onEditorDestroyed(){for(let t of this.tools)t.onDestroy();}};var Or=class{ctx;colorOscHue;colorOscValue;colorOscSaturation;valueGain;colorGain;boundaryOsc;boundaryGain;closed=false;constructor(){if(!window.AudioContext){console.warn("Accessibility sound UI: Unable to open AudioContext."),this.closed=true;return}this.ctx=new AudioContext,this.colorOscHue=this.ctx.createOscillator(),this.colorOscValue=this.ctx.createOscillator(),this.colorOscSaturation=this.ctx.createOscillator(),this.colorOscHue.type="triangle",this.colorOscSaturation.type="sine",this.colorOscValue.type="sawtooth",this.valueGain=this.ctx.createGain(),this.colorOscValue.connect(this.valueGain),this.valueGain.gain.setValueAtTime(.18,this.ctx.currentTime),this.colorGain=this.ctx.createGain(),this.colorOscHue.connect(this.colorGain),this.valueGain.connect(this.colorGain),this.colorOscSaturation.connect(this.colorGain),this.colorGain.connect(this.ctx.destination),this.boundaryGain=this.ctx.createGain(),this.boundaryOsc=this.ctx.createOscillator(),this.boundaryOsc.type="sawtooth",this.boundaryGain.gain.setValueAtTime(0,this.ctx.currentTime),this.boundaryOsc.connect(this.boundaryGain),this.boundaryGain.connect(this.ctx.destination),this.colorOscHue.start(),this.colorOscSaturation.start(),this.colorOscValue.start(),this.boundaryOsc.start(),this.pause();}pause(){this.closed||(this.colorGain.gain.setValueAtTime(0,this.ctx.currentTime),this.ctx.suspend());}play(){this.closed||this.ctx.resume();}setColor(t){let e=t.asHSV(),o=-Math.cos(e.x/2)*220+440,i=e.y*440+220,r=(e.z+.1)*440,s=.25*Math.min(1,t.a)/(1+Math.exp(-(e.z-.5)*3));this.colorOscHue.frequency.setValueAtTime(o,this.ctx.currentTime),this.colorOscSaturation.frequency.setValueAtTime(i,this.ctx.currentTime),this.colorOscValue.frequency.setValueAtTime(r,this.ctx.currentTime),this.valueGain.gain.setValueAtTime((1-e.z)*.4,this.ctx.currentTime),this.colorGain.gain.setValueAtTime(s,this.ctx.currentTime);}announceBoundaryCross(t){this.boundaryGain.gain.cancelScheduledValues(this.ctx.currentTime),this.boundaryGain.gain.setValueAtTime(0,this.ctx.currentTime),this.boundaryGain.gain.linearRampToValueAtTime(.018,this.ctx.currentTime+.1),this.boundaryOsc.frequency.setValueAtTime(440+Math.atan(t/2)*100,this.ctx.currentTime),this.boundaryGain.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.25);}close(){this.ctx.close(),this.closed=true;}},hi=class extends M{constructor(e,o){super(e.notifier,o);this.editor=e;this.toggleButtonContainer=document.createElement("div"),this.toggleButtonContainer.classList.add("easydrawer-sound-ui-toggle"),this.toggleButton=document.createElement("button"),this.toggleButton.addEventListener("click",()=>{this.setEnabled(!this.isEnabled());}),this.toggleButtonContainer.appendChild(this.toggleButton),this.updateToggleButtonText(),e.createHTMLOverlay(this.toggleButtonContainer);}soundFeedback=null;toggleButton;toggleButtonContainer;canReceiveInputInReadOnlyEditor(){return  true}updateToggleButtonText(){let e="sound-ui-tool-enabled";this.isEnabled()?(this.toggleButton.innerText=this.editor.localization.disableAccessibilityExploreTool,this.toggleButtonContainer.classList.add(e)):(this.toggleButton.innerText=this.editor.localization.enableAccessibilityExploreTool,this.toggleButtonContainer.classList.remove(e));}setEnabled(e){super.setEnabled(e),this.isEnabled()?this.editor.announceForAccessibility(this.editor.localization.soundExplorerUsageAnnouncement):(this.soundFeedback?.close(),this.soundFeedback=null),this.updateToggleButtonText();}onKeyPress(e){return e.code==="Escape"?(this.setEnabled(false),true):false}lastPointerPos;onPointerDown({current:e,allPointers:o}){return this.soundFeedback||(this.soundFeedback=new Or),o.length>=2?false:(this.soundFeedback?.play(),this.soundFeedback?.setColor(this.editor.display.getColorAt(e.screenPos)??w.black),this.lastPointerPos=e.canvasPos,true)}onPointerMove({current:e}){this.soundFeedback?.setColor(this.editor.display.getColorAt(e.screenPos)??w.black);let o=new Q(this.lastPointerPos,e.canvasPos),i=this.editor.image.getComponentsIntersecting(o.bbox).filter(r=>r.intersects(o));this.lastPointerPos=e.canvasPos,i.length>0&&this.soundFeedback?.announceBoundaryCross(i.length);}onPointerUp(e){this.soundFeedback?.pause();}onGestureCancel(){this.soundFeedback?.pause();}};async function ya(n){let t=[],e=new Image,o=await yt(n);return o&&t.push({image:e,base64Url:o,transform:T.identity}),t}var ts=ya;var ao=class n{constructor(t,e,o){this.imageBase64Url=t;this.preview=e;this.onUrlUpdate=o;this.originalSrc=t,e.src=t;}originalSrc;altText;updateImageData(t){this.preview.src=t,this.imageBase64Url=t,this.onUrlUpdate();}decreaseSize(t=3/4){let e=document.createElement("canvas");e.width=this.preview.naturalWidth*t,e.height=this.preview.naturalHeight*t,e.getContext("2d")?.drawImage(this.preview,0,0,e.width,e.height);let i=this.originalSrc?.startsWith("data:image/jpeg;")?"image/jpeg":"image/png";this.updateImageData(e.toDataURL(i));}reset(){this.updateImageData(this.originalSrc);}isChanged(){return this.imageBase64Url!==this.originalSrc}isLarge(){return this.getBase64Url().length>125829.12}getBase64Url(){return this.imageBase64Url}getAltText(){return this.altText}setAltText(t){this.altText=t,this.preview.alt=t;}static fromSrcAndPreview(t,e,o){return new n(t,e,o)}static fromRenderable(t,e){let o=new Image;o.src=t.base64Url;let i=new n(t.base64Url,o,e),r=t.label??t.image.getAttribute("alt");return r&&i.setAltText(r),{wrapper:i,preview:o}}};function va(n){let t=n/1024,e=t/1024,o=e/1024,i="B",r=n;return o>=1?(r=o,i="GiB"):e>=1?(r=e,i="MiB"):t>=1&&(r=t,i="KiB"),{size:r,units:i}}var os=va;var xa=0;function Sa(n,t,{accepts:e="*",allowMultiSelect:o=false,customPickerAction:i}={}){let r=document.createElement("div"),s=document.createElement("label"),a=document.createElement("input"),l=document.createElement("div");l.classList.add("toolbar--file-input-description");let c=document.createElement("span");r.classList.add("toolbar--file-input-container"),s.appendChild(document.createTextNode(n)),a.accept=e,a.type=i?"button":"file",a.classList.add("file-input"),a.multiple=o;let d=`easydrawer-file-input-${xa++}`;a.setAttribute("id",d),s.htmlFor=d;let p=t.icons.makeUploadFileIcon();p.classList.add("icon"),l.replaceChildren(p,c),s.appendChild(l),r.replaceChildren(s,a);let u=No.fromInitialValue([]),h=false,m=null,g=()=>{let v=u.get();if(h){if(c.textContent=t.localization.fileInput__loading,m){let f=document.createElement("b");f.textContent=t.localization.cancel,f.classList.add("cancel-button"),c.appendChild(f);}p.style.display="none";}else if(v.length>0){let f=v.map(S=>S.name),x=5;if(f.length<=x)c.textContent=f.join(`
`);else {let S=f.slice(0,x-1);c.textContent=[...S,t.localization.fileInput__andNMoreFiles(f.length-S.length)].join(`
`);}p.style.display="none";}else {p.style.display="";let x=t.localization.dragAndDropHereOrBrowse.split(/{{2}(.*)}{2}/g);c.replaceChildren();for(let[S,C]of x.entries())if(S%2===1){let k=document.createElement("b");k.textContent=C,c.appendChild(k);}else c.appendChild(document.createTextNode(C));}};if((()=>{s.addEventListener("dragover",v=>{v.preventDefault(),s.classList.add("drag-target");}),s.addEventListener("dragenter",v=>{v.preventDefault(),s.classList.add("drag-target");}),s.addEventListener("dragleave",v=>{v.preventDefault();let f=v.relatedTarget;(!f||!s.contains(f))&&s.classList.remove("drag-target");}),s.addEventListener("drop",v=>{v.preventDefault(),s.classList.remove("drag-target");let f=[];v.dataTransfer&&f.push(...v.dataTransfer.files),u.set(f);}),a.addEventListener("change",()=>{let v=a.files??[];u.set([...v]);});})(),i){let v=async()=>{if(h){m?.();return}r.classList.add("-loading"),h=true,g();try{let f=await i({setOnCancelCallback:x=>{if(!h)throw new Error("Task already completed. Can't register cancel handler.");m=()=>{m=null,g(),x();},g();}});f&&u.set(f);}finally{r.classList.remove("-loading"),h=false,g();}};a.addEventListener("click",v);}return u.onUpdate(v=>{v.length===0&&a.files&&a.files.length>0&&(a.value=""),m?.();}),u.onUpdateAndNow(g),{container:r,input:a,selectedFiles:u,addTo:v=>{v.appendChild(r);}}}var is=Sa;function Ca(n){let t=document.createElement("div");t.classList.add("toolbar-snapped-scroll-list");let e=document.createElement("div");e.classList.add("scroller");let o=K.fromInitialValue(0),i=null,r=()=>{let p=document.createElement("div");p.classList.add("page-markers"),p.setAttribute("tabindex","-1");let u=[];return F.union([o,n]).onUpdateAndNow(([m,g])=>{let b=false;for(;g.length<u.length;)u.pop(),b=true;let v;for(let f=0;f<g.length;f++){let x;if(f>=u.length){x=document.createElement("div");let C=document.createElement("div");C.classList.add("content"),x.replaceChildren(C),u.push(x),b=true;}else x=u[f];x.classList.add("marker"),f===m?(x.classList.add("-active"),v=x):x.classList.remove("-active");let S=f;x.addEventListener("click",()=>{l.get()[S]?.element?.scrollIntoView({block:"nearest",behavior:"smooth"});});}b&&p.replaceChildren(...u),v&&p.scrollHeight>t.clientHeight&&v.scrollIntoView({block:"nearest"}),u.length===1?p.classList.add("-one-element"):p.classList.remove("-one-element");}),p},s=()=>{i=new IntersectionObserver(p=>{for(let u of p)if(u.isIntersecting&&u.intersectionRatio>.7){let h=u.target.getAttribute("data-item-index");if(h===null)throw new Error("Could not find attribute data-item-index");let m=Number(h);o.set(m);break}},{root:e,threshold:.9});},a=()=>{i&&(i.disconnect(),o.set(0),i=null);},l=F.map(n,p=>p.map((u,h)=>{let m=document.createElement("div");return u.element.parentElement&&u.element.remove(),m.appendChild(u.element),m.classList.add("item"),m.setAttribute("data-item-index",`${h}`),{element:m,data:u.data}})),c=[];l.onUpdateAndNow(p=>{o.set(-1);for(let u of c)i?.unobserve(u.element);e.replaceChildren(),p.length>1?s():a(),p.length===0?t.classList.add("-empty"):t.classList.remove("-empty");for(let u of p)e.appendChild(u.element);if(o.set(0),i)for(let u of p)i.observe(u.element);});let d=F.map(o,p=>{let u=n.get();return 0<=p&&p<u.length?u[p].data:null});return it(e),t.replaceChildren(r(),e),{container:t,visibleItem:d}}var rs=Ca;var mi=class n extends _{images;imagesPreview;selectedFiles;imageAltTextInput;statusView;submitButton;constructor(t,e){e??=t.localization,super(t,"insert-image-widget",e),this.container.classList.add("dropdownShowable"),t.notifier.on(9,o=>{o.kind===9&&this.isDropdownVisible()&&this.updateInputs();}),this.images=K.fromInitialValue([]),this.images.onUpdateAndNow(()=>{this.onImageDataUpdate();});}getTitle(){return this.localizationTable.image}createIcon(){return this.editor.icons.makeInsertImageIcon()}setDropdownVisible(t){super.setDropdownVisible(t),this.isDropdownVisible()?this.updateInputs():this.selectedFiles?.set([]);}handleClick(){this.setDropdownVisible(!this.isDropdownVisible());}static nextInputId=0;fillDropdown(t){let e=document.createElement("div");e.classList.add("insert-image-widget-dropdown-content",`${E}spacedList`,`${E}nonbutton-controls-main-list`);let{container:o,selectedFiles:i}=is(this.localizationTable.chooseFile,this.editor,{accepts:"image/*",allowMultiSelect:true,customPickerAction:this.editor.getCurrentSettings().image?.showImagePicker}),r=document.createElement("div");this.imagesPreview=rs(this.images),this.statusView=document.createElement("div");let s=document.createElement("div");s.classList.add("action-button-row"),this.statusView.classList.add("insert-image-image-status-view"),this.submitButton=document.createElement("button"),this.selectedFiles=i,this.imageAltTextInput=document.createElement("input");let a=document.createElement("label"),l=`insert-image-alt-text-input-${n.nextInputId++}`;return this.imageAltTextInput.setAttribute("id",l),a.htmlFor=l,a.innerText=this.localizationTable.inputAltText,this.imageAltTextInput.type="text",this.imageAltTextInput.placeholder=this.localizationTable.describeTheImage,this.statusView.setAttribute("aria-live","polite"),this.submitButton.innerText=this.localizationTable.submit,this.imagesPreview.visibleItem.onUpdateAndNow(()=>this.onImageDataUpdate()),this.imageAltTextInput.addEventListener("input",()=>{let c=this.imagesPreview.visibleItem.get();c&&(c.setAltText(this.imageAltTextInput.value),this.submitButton.style.display="");}),this.selectedFiles.onUpdateAndNow(async c=>{if(c.length===0){this.images.set([]);return}let d=(await Promise.all(c.map(async p=>{let u;try{u=await ts(p);}catch(h){console.error("Image load error",h);let m=this.localizationTable.imageLoadError("Image load error");return this.statusView.innerText=m,[]}return u.map(h=>{let{wrapper:m,preview:g}=ao.fromRenderable(h,()=>this.onImageDataUpdate());return {data:m,element:g}})}))).flat();this.images.set(d);}),r.replaceChildren(a,this.imageAltTextInput),s.replaceChildren(this.submitButton),e.replaceChildren(o,r,this.imagesPreview.container,this.statusView,s),t.replaceChildren(e),true}onImageDataUpdate(){if(!this.imagesPreview)return;let t=this.imagesPreview.visibleItem.get(),e=t?.getBase64Url();this.imageAltTextInput.value=t?.getAltText()??"",e?(this.submitButton.disabled=false,this.submitButton.style.display="",this.updateImageSizeDisplay()):(this.submitButton.disabled=true,this.submitButton.style.display="none",this.statusView.innerText="",this.submitButton.disabled=true),this.images.get().length<=1?this.submitButton.innerText=this.localizationTable.submit:this.submitButton.innerText=this.localizationTable.addAll;}hideDialog(){this.setDropdownVisible(false);}updateImageSizeDisplay(){let t=this.imagesPreview.visibleItem.get(),e=t?.getBase64Url()??"",{size:o,units:i}=os(e.length),r=document.createElement("span");r.innerText=this.localizationTable.imageSize(Math.round(o),i);let s=document.createElement("button");s.innerText=this.localizationTable.decreaseImageSize,s.addEventListener("click",()=>{t?.decreaseSize();});let a=document.createElement("button");a.innerText=this.localizationTable.resetImage,a.addEventListener("click",()=>{t?.reset();}),this.statusView.replaceChildren(r),t?.isLarge()?this.statusView.appendChild(s):t?.isChanged()?this.statusView.appendChild(a):this.images.get().some(c=>c.data?.isChanged()||c.data?.isLarge())&&(s.disabled=true,this.statusView.appendChild(s));}updateInputs(){(()=>{this.selectedFiles?.set([]),this.imageAltTextInput.value="",this.submitButton.disabled=true,this.statusView.innerText="",this.submitButton.style.display="";})();let e=this.editor.toolController.getMatchingTools(re),o=e.flatMap(r=>r.getSelectedObjects()),i=null;if(o.length===1&&o[0]instanceof te){i=o[0];let r=new Image,s=ao.fromSrcAndPreview(i.getURL(),r,()=>this.onImageDataUpdate());s.setAltText(i.getAltText()??""),this.images.set([{data:s,element:r}]);}else o.length>0&&e.forEach(r=>r.clearSelection());this.submitButton.style.display="none",this.submitButton.addEventListener("click",async()=>{let r=[],s=T.identity,a=null;for(let{data:l}of this.images.get()){if(!l)continue;let c=new Image;c.src=l.getBase64Url();let d=l.getAltText();d&&c.setAttribute("alt",d);let p;try{p=await te.fromImage(c,s);}catch(m){console.error("Error loading image",m),this.statusView.innerText=this.localizationTable.imageLoadError("Image load error");return}let u=p.getBBox();if(u.area===0){this.statusView.innerText=this.localizationTable.errorImageHasZeroSize;return}r.push(p),a??=u,a.union(u);let h=exports.Vec2.of(0,u.height);s=s.rightMul(T.translation(h));}if(r.length>0){if(!a)throw new Error("Logic error: Full bounding box must be calculated when components are to be added.");if(this.hideDialog(),i){let l=new U([i]),c=i.getTransformation(),d=i.getBBox().width||1,p=a.transformedBoundingBox(c).width||1,u=T.scaling2D(d/p),h=[];for(let m of r)h.push(H.addComponent(m),m.transformBy(c.rightMul(u)),m.setZIndex(i.getZIndex()));this.editor.dispatch(j([...h,l])),e[0]?.setSelection(r);}else await this.editor.addAndCenterComponents(r);}});}};function Ta(n,t,e="html"){let o;if(e==="html")o=document.createElement(n);else if(e==="svg")o=document.createElementNS("http://www.w3.org/2000/svg",n);else throw new Error(`Unknown element type ${e}`);for(let[i,r]of Object.entries(t))if(i!=="children"){if(typeof r!="string"&&typeof r!="number")throw new TypeError(`Unsupported value type ${typeof r}`);o.setAttribute(i,r.toString());}if(t.children)for(let i of t.children)o.appendChild(i);return o}function xe(n,t){return Ta(n,t,"svg")}function fi(n,t){return t.map(e=>xe(n,e))}function gi(...n){return fi("path",n)}var G="http://www.w3.org/2000/svg",wa=0;function bi(){let n=`checkerboard-${wa++}`,t=xe("pattern",{id:n,viewBox:"0,0,10,10",width:"20%",height:"20%",patternUnits:"userSpaceOnUse",children:fi("rect",[{x:0,y:0,width:10,height:10,fill:"white"},{x:0,y:0,width:5,height:5,fill:"gray"},{x:5,y:5,width:5,height:5,fill:"gray"}])}),e=`url(#${n})`;return {patternDefElement:t,get patternDef(){return t.innerHTML},patternRef:e}}function ns(n){let t=document.createElementNS(G,"svg");t.innerHTML=`
		<style>
			.toolbar-svg-undo-redo-icon {
				stroke: var(--icon-color);
				stroke-width: 12;
				stroke-linejoin: round;
				stroke-linecap: round;
				fill: none;

				transform-origin: center;
			}
		</style>
	`;let e=document.createElementNS(G,"path");return e.setAttribute("d","M20,20 A15,15 0 0 1 70,80 L80,90 L60,70 L65,90 L87,90 L65,80"),e.classList.add("toolbar-svg-undo-redo-icon"),n&&(e.style.transform="scale(-1, 1)"),t.appendChild(e),t.setAttribute("viewBox","0 0 100 100"),t}var It=class{makeUndoIcon(){return ns(true)}makeRedoIcon(){return ns(false)}makeDropdownIcon(){let t=this.makeIconFromPath("M5,10 L50,90 L95,10 Z");return t.setAttribute("viewBox","-10 -10 110 110"),t}makeEraserIcon(t,e){t??=10;let o=t/4,i="#ff70af";return xe("svg",{viewBox:"0 0 120 120",children:[xe("defs",{children:[xe("linearGradient",{id:"dash-pattern",children:fi("stop",[{offset:"80%","stop-color":i},{offset:"85%","stop-color":"white"},{offset:"90%","stop-color":i}])})]}),xe("path",{fill:e==="partial-stroke"?"url(#dash-pattern)":i,stroke:"black",transform:"rotate(41.35)",d:`
						M 52.5 27
						C 50 28.9 48.9 31.7 48.9 34.8
						L 48.9 39.8
						C 48.9 45.3 53.4 49.8 58.9 49.8
						L 103.9 49.8
						C 105.8 49.8 107.6 49.2 109.1 48.3
						L 110.2 ${o+49.5} L 159.7 ${o+5}
						L 157.7 ${-o+5.2} L 112.4 ${49.5-o}
						C 113.4 43.5 113.9 41.7 113.9 39.8
						L 113.9 34.8
						C 113.9 29.3 109.4 24.8 103.9 24.8
						L 58.9 24.8
						C 56.5 24.8 54.3 25.7 52.5 27
						z
					`}),xe("rect",{stroke:"#cc8077",fill:"var(--icon-color)",width:65,height:75,x:48.9,y:-38.7,transform:"rotate(41.35)"})]})}makeSelectionIcon(t="rect"){let e=document.createElementNS(G,"svg");return t==="rect"?e.innerHTML=`
			<g>
				<rect x="10" y="10" width="70" height="70" fill="pink" stroke="black" stroke-dasharray="32 9"/>
				<rect x="75" y="75" width="10" height="10" fill="white" stroke="black"/>
			</g>
			`:e.innerHTML=`
			<g>
				<rect x="10" y="10" width="76" height="76" rx="50" stroke-dasharray="32 9" fill="pink" stroke="black"/>
				<rect x="71" y="71" width="10" height="10" fill="white" stroke="black"/>
			</g>
			`,e.setAttribute("viewBox","0 0 100 100"),e}makeRotateIcon(){let t=document.createElementNS(G,"svg");return t.innerHTML=`
			<defs>
				<marker
					id="arrow-marker"
					viewBox="0 0 10 10"
					refX="3" refY="5"
					markerWidth="3" markerHeight="3"
					orient="auto-start-reverse"
				>
					<path
						d="M0,0 L8,5 L0,10z"
						fill="var(--icon-color)"
					/>
				</marker>
			</defs>

			<path
				marker-start="url(#arrow-marker)"
				d="
					M20,20
					A30,30 0 1 1 80 80
				"
				fill="none"
				stroke="var(--icon-color)"
				stroke-width="12"
			/>
			<path
				d="
					M80,80
					A30,30 0 1 1 20 20
				"
				fill="none"
				stroke="var(--icon-color)"
				stroke-width="12"
				stroke-dasharray="30 10 20 10 20 10 10"
				style="stroke-linecap: butt;"
			/>
		`,t.setAttribute("viewBox","-5 -5 110 110"),t}makeHandToolIcon(){return this.makeIconFromPath(`
			m 10,60
				5,30
			H 90
			V 30
			C 90,20 75,20 75,30
			V 60
				20
			C 75,10 60,10 60,20
			V 60
				15
			C 60,5 45,5 45,15
			V 60
				25
			C 45,15 30,15 30,25
			V 60
				75
			L 25,60
			C 20,45 10,50 10,60
			Z
		`,"none","var(--icon-color)","3")}makeTouchPanningIcon(){return this.makeIconFromPath(`
			M 5,5.5
			V 17.2
			L 16.25,5.46
			Z

			m 33.75,0
			L 50,17
			V 5.5
			Z

			M 5,40.7
			v 11.7
			h 11.25
			z

			M 26,19
			C 19.8,19.4 17.65,30.4 21.9,34.8
			L 50,70
			H 27.5
			c -11.25,0 -11.25,17.6 0,17.6
			H 61.25
			C 94.9,87.8 95,87.6 95,40.7 78.125,23 67,29 55.6,46.5
			L 33.1,23
			C 30.3125,20.128192 27.9,19 25.830078,19.119756
			Z
		`,"none","var(--icon-color)","3")}makeAllDevicePanningIcon(){return this.makeIconFromPath(`
			M 5 5
			L 5 17.5
				17.5 5
				5 5
			z

			M 42.5 5
			L 55 17.5
				55 5
				42.5 5
			z

			M 70 10
			L 70 21
				61 15
				55.5 23
				66 30
				56 37
				61 45
				70 39
				70 50
				80 50
				80 39
				89 45
				95 36
				84 30
				95 23
				89 15
				80 21
				80 10
				70 10
			z

			M 27.5 26.25
			L 27.5 91.25
			L 43.75 83.125
			L 52 99
			L 68 91
			L 60 75
			L 76.25 66.875
			L 27.5 26.25
			z

			M 5 42.5
			L 5 55
			L 17.5 55
			L 5 42.5
			z
		`,"none","var(--icon-color)","3")}makeZoomIcon(){let t=document.createElementNS(G,"svg");t.setAttribute("viewBox","0 0 100 100");let e=(o,i,r)=>{let s=document.createElementNS(G,"text");s.appendChild(document.createTextNode(o)),s.setAttribute("x",i.toString()),s.setAttribute("y",r.toString()),s.style.textAlign="center",s.style.textAnchor="middle",s.style.fontSize="55px",s.style.fill="var(--icon-color)",s.style.fontFamily="monospace",t.appendChild(s);};return e("+",40,45),e("-",70,75),t}makeRotationLockIcon(){let t=this.makeIconFromPath(`
			M 40.1 25.1
			C 32.5 25 27.9 34.1 27.9 34.1
			L 25.7 30
			L 28 44.7
			L 36.6 40.3
			L 32.3 38.3
			C 33.6 28 38.1 25.2 45.1 31.8
			L 49.4 29.6
			C 45.9 26.3 42.8 25.1 40.1 25.1
			z

			M 51.7 34.2
			L 43.5 39.1
			L 48 40.8
			C 47.4 51.1 43.1 54.3 35.7 48.2
			L 31.6 50.7
			C 45.5 62.1 52.6 44.6 52.6 44.6
			L 55.1 48.6
			L 51.7 34.2
			z

			M 56.9 49.9
			C 49.8 49.9 49.2 57.3 49.3 60.9
			L 47.6 60.9
			L 47.6 73.7
			L 66.1 73.7
			L 66.1 60.9
			L 64.4 60.9
			C 64.5 57.3 63.9 49.9 56.9 49.9
			z

			M 56.9 53.5
			C 60.8 53.5 61 58.2 60.8 60.9
			L 52.9 60.9
			C 52.7 58.2 52.9 53.5 56.9 53.5
			z
		`);return t.setAttribute("viewBox","10 10 70 70"),t}makeInsertImageIcon(){return this.makeIconFromPath(`
			M 5 10 L 5 90 L 95 90 L 95 10 L 5 10 z
			M 10 15 L 90 15 L 90 50 L 70 75 L 40 50 L 10 75 L 10 15 z
			M 22.5 25 A 7.5 7.5 0 0 0 15 32.5 A 7.5 7.5 0 0 0 22.5 40 A 7.5 7.5 0 0 0 30 32.5 A 7.5 7.5 0 0 0 22.5 25 z
		`)}makeUploadFileIcon(){return this.makeIconFromPath(`
			M 48,10 32,34 43,33 42,68
			H 54
			L 53,33 64,34 Z

			M 8,66 V 86 H 88 V 66 H 78 V 76 H 18 V 66 Z
		`)}makeTextIcon(t){let e=document.createElementNS(G,"svg");e.setAttribute("viewBox","0 0 100 100");let o=document.createElementNS(G,"text");return o.appendChild(document.createTextNode("T")),o.style.fontFamily=t.fontFamily,o.style.fontWeight=t.fontWeight??"",o.style.fontVariant=t.fontVariant??"",o.style.fill=t.renderingStyle.fill.toHexString(),o.style.textAnchor="middle",o.setAttribute("x","50"),o.setAttribute("y","75"),o.style.fontSize="65px",o.style.filter="drop-shadow(0px 0px 10px var(--shadow-color))",e.appendChild(o),e}makePenIcon(t){let e=Math.round(Math.sqrt(t.thickness)*4),o=t.color,i=this.isRoundedTipPen(t),r=e/2,s=`
			M ${15-r},${80-r}
			  ${15-r},${80+r}
			  30,83
			  15,65
			Z
		`,a=80+r,l=`
			m ${15-r*1.1},${a}
			c 35,10 55,15 60,30
			l ${35+r*1.2},${ -10-r}
			C 80.47,98.32 50.5,${90+r} 20,${a} Z
		`,c=`
			M 72.45,35.67
			A 10,15 41.8 0 1 55,40.2 10,15 41.8 0 1 57.55,22.3 10,15 41.8 0 1 75,17.8 10,15 41.8 0 1 72.5,35.67
			Z
		`,d="M 85,-25 25,35 h 10 v 10 h 10 v 10 h 10 v 10 h 10 l -5,10 60,-60 z",p="M 25,35 H 35 L 90,-15 85,-25 Z",u="M 60,75 65,65 H 55 l 55,-55 10,5 z";i&&(d="M 85,-25 25,35 c 15,0 40,30 35,40 l 60,-60 z",p="m 25,35 c 3.92361,0.384473 7.644275,0.980572 10,3 l 55,-53 -5,-10 z",u="M 60,75 C 61,66 59,65 56,59 l 54,-54 10,10 z");let h=`M 25,35 ${10-r/4},${70-r/2} 20,75 25,85 60,75 70,55 45,25 Z`,g=w.fromHex("#f4d7d7").mix(o,r/40-.1).toHexString(),b=bi(),v=o.toHexString(),f=gi({fill:b.patternRef,d:s},{fill:b.patternRef,d:l},{fill:v,d:s},{fill:v,d:l}),x=gi({fill:b.patternRef,d:h},{fill:g,stroke:v,d:h}),S=gi({fill:"var(--icon-color)",stroke:"var(--icon-color)",d},{fill:"rgba(150, 150, 150, 0.3)",d:p},{fill:"rgba(100, 100, 100, 0.2)",d:u},{fill:b.patternRef,d:c},{fill:v,d:c}),C=document.createElementNS(G,"svg");C.setAttribute("viewBox","0 0 100 100");let k=xe("g",{children:[f,x,S].flat()}),B=xe("defs",{children:[b.patternDefElement]});return C.replaceChildren(B,k),C}makeIconFromFactory(t){let e=Math.sqrt(t.thickness)*3,o=performance.now(),i={pos:exports.Vec2.of(10,10),width:e,color:t.color,time:o-100},r={pos:exports.Vec2.of(90,90),width:e,color:t.color,time:o},s=new L(()=>{}),a=t.factory(i,s);a.addPoint(r);let l=document.createElementNS(G,"svg");l.setAttribute("viewBox","0 0 100 100"),s.updateScreenSize(exports.Vec2.of(100,100));let c;if(t.color.a<1){let u=bi(),h=document.createElementNS(G,"defs");h.appendChild(u.patternDefElement),l.appendChild(h);let m=document.createElementNS(G,"g");l.appendChild(m),c=new class extends oe{constructor(){super(l,s);}addPathToSVG(){let g=super.addPathToSVG();if(g){let b=g.cloneNode(true);b.style.zIndex="-1",b.hasAttribute("stroke")?b.setAttribute("stroke",u.patternRef):b.hasAttribute("fill")&&b.setAttribute("fill",u.patternRef),m.appendChild(b);}return g}};}else c=new oe(l,s);a.preview(c);let p=a.getBBox();return l.setAttribute("viewBox",`${p.x} ${p.y} ${p.w} ${p.h}`),l}makePipetteIcon(t){let e=document.createElementNS(G,"svg"),o=document.createElementNS(G,"g");o.style.rotate="45deg",o.style.transformOrigin="center";let i=document.createElementNS(G,"g");if(i.innerHTML=`
		<path
			style="fill: var(--icon-color); stroke-linecap:round; stroke-linejoin:round;"
			d="
				m 32,12 v 68
				c 0,1 0.5,2 1.33,2.5 1.67,1.15 3.67,2.1 5.17,3.2 1.4,1.1 2.3,2.1 2.5,3.1 0.6,2.1 1,4.6 1,6.2 0,3.7 5.45,4.1 6,0.4 l 0.9,-6.8
				c 0.3,-0.9 1.1,-1.9 2.6,-2.9 1.5,-1.1 3.4,-2 5.1,-3.2
				C 57.5,82 58,81 58,80
				V 12 Z m 20,25 v 41.3
				c 0,1.7 -2.5,1.6 -4,2.7 -1,0.76 -2.1,1.5 -3,2.6
				C 44,82.5 43.02,81.75 42,81 40.51,79.92 38,80 38,78.34
				V 51 Z
			"
		/>
		<rect
			style="fill: var(--icon-color);"
			width="32"
			height="9"
			x="29"
			y="2"
			ry="4.5"
		/>
		<path
			style="fill: var(--icon-color);"
			d="m 45,-25 c -5.54,0 -11,4.26 -11,9 V 0 h 22 v -16 c 0,-4.74 -5.46,-9 -11,-9 z"
		/>
		`,t){let r=bi(),s=document.createElementNS(G,"defs");s.appendChild(r.patternDefElement),e.appendChild(s);let a=document.createElementNS(G,"path"),l=document.createElementNS(G,"path"),c=`
				M 35,36 H 55 V 78.678012 83 L 45,87 35,83 Z
			`;l.setAttribute("d",c),a.setAttribute("d",c),l.style.fill=t.toHexString(),a.style.fill=r.patternRef,o.appendChild(a),o.appendChild(l);}return o.appendChild(i),e.appendChild(o),e.setAttribute("viewBox","5 -40 140 140"),e}makeShapeAutocorrectIcon(){return this.makeIconFromPath(`
			m 79.129476,33.847107 9.967823,-0.03218 v 55 h -55 l 0.03218,-9.96782
			M 71.1,40.8 a 30,30 0 0 1 -30,30 30,30 0 0 1 -30,-30 30,30 0 0 1 30,-30 30,30 0 0 1 30,30 L 71.1,40.8
			M 34.1,58.8 v -25 h 25 v 0
		`,"none","var(--icon-color)","7px")}makeStrokeSmoothingIcon(){return this.makeIconFromPath(`
			m 31,83.2 c -50,0 30,-65 -20,-65
			M 75,17.3 40,59.7 38.2,77.6 55.5,72.4 90.5,30 Z
		`,"none","var(--icon-color)","7px")}makeFormatSelectionIcon(){return this.makeIconFromPath(`
			M 5 10
			L 5 20 L 10 20 L 10 15 L 20 15 L 20 40 L 15 40 L 15 45 L 35 45 L 35 40 L 30 40 L 30 15 L 40 15 L 40 20 L 45 20 L 45 15 L 45 10 L 5 10 z
			M 90 10 C 90 10 86.5 13.8 86 14 C 86 14 76.2 24.8 76 25 L 60 25 L 60 65 C 75 70 85 70 90 65 L 90 25 L 80 25 L 76.7 25 L 90 10 z
			M 60 25 L 55 25 L 50 30 L 60 25 z
			M 10 55 L 10 90 L 41 90 L 41 86 L 45 86 L 45 55 L 10 55 z
			M 42 87 L 42 93 L 48 93 L 48 87 L 42 87 z
		`)}makeResizeImageToSelectionIcon(){return this.makeIconFromPath(`
			M 75 5 75 10 90 10 90 25 95 25 95 5 75 5 z
			M 15 15 15 30 20 30 20 20 30 20 30 15 15 15 z
			M 84 15 82 17 81 16 81 20 85 20 84 19 86 17 84 15 z
			M 26 24 24 26 26 28 25 29 29 29 29 25 28 26 26 24 z
			M 25 71 26 72 24 74 26 76 28 74 29 75 29 71 25 71 z
			M 15 75 15 85 25 85 25 80 20 80 20 75 15 75 z
			M 90 75 90 90 75 90 75 95 95 95 95 75 90 75 z
			M 81 81 81 85 82 84 84 86 86 84 84 82 85 81 81 81 z
		`)}makeResizeViewportIcon(){return this.makeResizeImageToSelectionIcon()}makeDuplicateSelectionIcon(){return this.makeIconFromPath(`
			M 45,10 45,55 90,55 90,10 45,10 z
			M 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z
		`)}makeCopyIcon(){return this.makeIconFromPath(`
			M 45,10 45,55 90,55 90,10 45,10 z
			M 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z
		`)}makePasteIcon(){let t=this.makeIconFromPath(`
			M 50 0 L 50 5 L 35 5 L 40 24.75 L 20 25 L 20 100 L 85 100 L 100 90 L 100 24 L 75.1 24.3 L 80 5 L 65 5 L 65 0 L 50 0 z
			M 10 15 L 10 115 L 110 115 L 110 15 L 85 15 L 83 20 L 105 20 L 105 110 L 15 110 L 15 20 L 32 20 L 30 15 L 10 15 z
			M 25 35 L 90 35 L 90 40 L 25 40 L 25 35 z
			M 25 45 L 90 45 L 90 50 L 25 50 L 25 45 z
			M 25 55 L 85 55 L 85 60 L 25 60 L 25 55 z
			M 25 65 L 90 65 L 90 70 L 25 70 L 25 65 z
		`);return t.setAttribute("viewBox","0 0 120 120"),t}#e(){return this.makeIconFromPath(`
			M 15,15 85,85
			M 15,85 85,15
		`,"none","var(--icon-color)","6px")}makeDeleteSelectionIcon(){return this.#e()}makeCloseIcon(){return this.#e()}makeSaveIcon(){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML=`
			<style>
				.toolbar-save-icon {
					stroke: var(--icon-color);
					stroke-width: 6;
					stroke-linejoin: round;
					stroke-linecap: round;
					fill: none;
				}
			</style>
			<path
				d='
					M 15,55 30,70 85,20
				'
				class='toolbar-save-icon'
			/>
		`,t.setAttribute("viewBox","0 0 100 100"),t}makeConfigureDocumentIcon(){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML=`
			<path
				d='
					M 5,5 V 95 H 95 V 5 Z m 5,5 H 90 V 90 H 10 Z
					m 5,10 V 30 H 50 V 25 H 20 v -5 z
					m 40,0 V 50 H 85 V 20 Z
					m 2,2 H 83 V 39 L 77,28 70,42 64,35 57,45 Z
					m 8.5,5 C 64.67,27 64,27.67 64,28.5 64,29.33 64.67,30 65.5,30 66.33,30 67,29.33 67,28.5 67,27.67 66.33,27 65.5,27 Z
					M 15,40 v 5 h 35 v -5 z
					m 0,15 v 5 h 70 v -5 z
					m 0,15 v 5 h 70 v -5 z
				'
				style='fill: var(--icon-color);'
			/>
		`,t.setAttribute("viewBox","0 0 100 100"),t}makeOverflowIcon(){return this.makeIconFromPath(`
			M 15 40
			A 12.5 12.5 0 0 0 2.5 52.5
			A 12.5 12.5 0 0 0 15 65
			A 12.5 12.5 0 0 0 27.5 52.5
			A 12.5 12.5 0 0 0 15 40
			z

			M 50 40
			A 12.5 12.5 0 0 0 37.5 52.5
			A 12.5 12.5 0 0 0 50 65
			A 12.5 12.5 0 0 0 62.5 52.5
			A 12.5 12.5 0 0 0 50 40
			z

			M 85 40
			A 12.5 12.5 0 0 0 72.5 52.5
			A 12.5 12.5 0 0 0 85 65
			A 12.5 12.5 0 0 0 97.5 52.5
			A 12.5 12.5 0 0 0 85 40
			z
		`)}makeHelpIcon(){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML=`
			<circle
				style="stroke-width:1.587; stroke: var(--icon-color);"
				fill="none"
				cx="13.23"
				cy="13.23"
				r="11.9"
			/>
			<path
				style="stroke-width: 3; stroke-linecap: butt; stroke: var(--icon-color);"
				fill="none"
				d="M 9.26,6.61 C 18.7,3.25 19.95,10.4 14.3,13.4 c -1.15,0.61 -1.32,1.32 -1.32,2.65 v 2.12"
			/>
			<circle
				style="fill: var(--icon-color);"
				cx="13"
				cy="21.32"
				r="1.9"
			/>
		`,t.setAttribute("viewBox","0 0 26.46 26.46"),t.setAttribute("width","100"),t.setAttribute("height","100"),t}makeIconFromPath(t,e="var(--icon-color)",o="none",i="0px"){let r=document.createElementNS(G,"svg"),s=document.createElementNS(G,"path");return s.setAttribute("d",t),s.style.fill=e,s.style.stroke=o,s.style.strokeWidth=i,r.appendChild(s),r.setAttribute("viewBox","0 0 100 100"),r}makeCheckerboardPattern(){return bi()}isRoundedTipPen(t){return t.factory===le||t.factory===Te}isPolylinePen(t){return t.factory===Te}licenseInfo(){return null}};var lo=class extends _{overflowChildren=[];overflowContainer;constructor(t,e){super(t,"overflow-widget",e),this.container.classList.add("toolbar-overflow-widget"),this.container.classList.add("dropdownShowable"),this.overflowContainer??=document.createElement("div");}shouldAutoDisableInReadOnlyEditor(){return  false}getTitle(){return this.localizationTable.toggleOverflow}createIcon(){return this.editor.icons.makeOverflowIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible());}fillDropdown(t){return this.overflowContainer??=document.createElement("div"),this.overflowContainer.parentElement&&this.overflowContainer.remove(),this.overflowContainer.classList.add("toolbar-overflow-widget-overflow-list"),t.appendChild(this.overflowContainer),true}clearChildren(){this.overflowContainer.replaceChildren(),this.container.classList.remove("horizontal");let t=this.overflowChildren;return this.overflowChildren=[],t}getChildWidgets(){return [...this.overflowChildren]}hasAsChild(t){for(let e of this.overflowChildren)if(t===e)return  true;return  false}addToOverflow(t){this.overflowChildren.push(t),t.addTo(this.overflowContainer),t.setIsToplevel(false),this.overflowChildren.length>2&&this.container.classList.add("horizontal");}canBeInOverflowMenu(){return  false}};function Pa(n){return new yi(n,n.getRootElement(),n.localization)}var yi=class extends Ve{container;resizeObserver;widgetOrderCounter=0;overflowWidget=null;constructor(t,e,o){super(t,o),this.container=document.createElement("div"),this.container.classList.add(`${E}root`),this.container.classList.add(`${E}element`),this.container.classList.add(`${E}dropdown-toolbar`),this.container.setAttribute("role","toolbar"),e.appendChild(this.container),"ResizeObserver"in window?(this.resizeObserver=new ResizeObserver(i=>{this.reLayout();}),this.resizeObserver.observe(this.container)):console.warn("ResizeObserver not supported. Toolbar will not resize.");}reLayoutQueued=false;queueReLayout(){this.reLayoutQueued||(this.reLayoutQueued=true,requestAnimationFrame(()=>this.reLayout()));}reLayout(){if(this.reLayoutQueued=false,!this.overflowWidget)return;let t=l=>{let c=0;for(let d of l)d.isHidden()||(c+=d.getButtonWidth());return c},e=l=>{let c=this.overflowWidget?.getChildWidgets()??[];return c.length===0?false:c[0].getButtonWidth()<=l},o=this.getAllWidgets(),i=t(this.overflowWidget.getChildWidgets()),r=t(o)-i,s=this.container.clientWidth*.87;window.innerHeight>s*1.75&&(s*=1.75);let a=false;if(e(s-r)){let l=this.overflowWidget.clearChildren();for(let c of l)c.addTo(this.container),c.setIsToplevel(true),c.isHidden()||(r+=c.getButtonWidth());i=0,a=true;}if(r>=s){for(let l=o.length-1;l>=0&&r>=s;l--){let c=o[l];this.overflowWidget.hasAsChild(c)||c.canBeInOverflowMenu()&&(r-=c.getButtonWidth(),this.overflowWidget.addToOverflow(c));}a=true;}this.overflowWidget.setHidden(this.overflowWidget.getChildWidgets().length===0),a&&this.setupColorPickers();}addWidgetInternal(t){let e=t.addTo(this.container);e.style.order=`${this.widgetOrderCounter++}`,this.queueReLayout();}removeWidgetInternal(t){t.remove(),this.queueReLayout();}addSpacer(t={}){let e=document.createElement("div");e.classList.add(`${E}spacer`),t.grow&&(e.style.flexGrow=`${t.grow}`),t.minSize&&(e.style.minWidth=t.minSize),t.maxSize&&(e.style.maxWidth=t.maxSize),e.style.order=`${this.widgetOrderCounter++}`,this.container.appendChild(e);}addOverflowWidget(){this.overflowWidget=new lo(this.editor,this.localizationTable),this.addWidget(this.overflowWidget);}addDefaults(){this.addDefaultToolWidgets(),this.addOverflowWidget(),this.addDefaultActionButtons();}onRemove(){this.container.remove(),this.resizeObserver.disconnect();}getWidgetById(t){for(let e of this.getAllWidgets())if(e.getId()===t)return e;return null}};var co=class{constructor(t,e,o,i,r){this.setSidebarContent=t;this.sidebarTitle=e;this.sidebarVisibility=o;this.announceForAccessibility=i;this.localization=r;}visibleWidgetContent=F.fromInitialValue(null);createToolMenu(t){let e=document.createElement("div"),o=null,i=F.fromCallback(()=>this.visibleWidgetContent.get()===o&&this.sidebarVisibility.get(),[this.visibleWidgetContent,this.sidebarVisibility]);return o={visible:i,requestShow:()=>{this.setSidebarContent(e),this.sidebarTitle.set(t.getTitle()),this.visibleWidgetContent.set(o),this.sidebarVisibility.set(true),this.announceForAccessibility(this.localization.dropdownShown(t.getTitle()));},onActivated:()=>{},requestHide:()=>{i.get()&&this.sidebarVisibility.set(false);},appendChild:r=>{e.appendChild(r);},clearChildren:()=>{e.replaceChildren();},destroy:()=>{o?.requestHide(),e.parentElement&&e.remove(),this.visibleWidgetContent.get()===o&&this.visibleWidgetContent.set(null);}},o}};function Ea(n){return new kt(n,n.getRootElement(),n.localization)}var kt=class extends Ve{toolbarContainer;toolbarActionRow;toolbarToolRow;toolRowResizeObserver;menuContainer;sidebarContainer;sidebarContent;closeButton;layoutManager;sidebarVisible;sidebarY;sidebarTitle;clearDragListeners=null;constructor(t,e,o){super(t,o),this.toolbarContainer=document.createElement("div"),this.toolbarContainer.classList.add(`${E}root`),this.toolbarContainer.classList.add(`${E}element`),this.toolbarContainer.classList.add(`${E}edge-toolbar`),this.toolbarContainer.setAttribute("role","toolbar"),this.toolbarActionRow=document.createElement("div"),this.toolbarActionRow.classList.add("toolbar-element","toolbar-action-row"),this.toolbarToolRow=document.createElement("div"),this.toolbarToolRow.classList.add("toolbar-element","toolbar-tool-row"),it(this.toolbarToolRow),"ResizeObserver"in window?(this.toolRowResizeObserver=new ResizeObserver(r=>{this.onToolbarRowResize();}),this.toolRowResizeObserver.observe(this.toolbarToolRow)):console.warn("ResizeObserver not supported. Toolbar will not resize."),this.toolbarContainer.replaceChildren(this.toolbarActionRow,this.toolbarToolRow),e.appendChild(this.toolbarContainer),this.sidebarVisible=F.fromInitialValue(false),this.sidebarY=F.fromInitialValue(0),this.menuContainer=document.createElement("div"),this.menuContainer.classList.add(`${E}edgemenu-container`),this.sidebarContainer=document.createElement("div"),this.sidebarContainer.classList.add(`${E}edgemenu`,`${E}element`),this.sidebarContainer.classList.add(`${E}tool-properties`),this.sidebarContent=document.createElement("div"),this.sidebarY.onUpdateAndNow(r=>{let s="dropdown-below-edge";r>0?(this.sidebarContainer.style.transform=`translate(0, ${r}px)`,this.sidebarContainer.style.paddingBottom="",this.menuContainer.classList.add(s)):(this.sidebarContainer.style.transform="",this.sidebarContainer.style.paddingBottom=`${-r}px`,this.menuContainer.classList.remove(s));}),this.closeButton=document.createElement("button"),this.closeButton.classList.add("drag-elem"),this.editor.handleKeyEventsFrom(this.closeButton,r=>r.code!=="Space"&&r.code!=="Enter"&&r.code!=="Tab"),this.sidebarContainer.addEventListener("keyup",r=>{!r.defaultPrevented&&r.code==="Escape"&&(this.sidebarVisible.set(false),r.preventDefault());}),this.initDragListeners();let i=(...r)=>{this.sidebarContent.replaceChildren(...r),this.setupColorPickers();};this.sidebarTitle=K.fromInitialValue(""),this.layoutManager=new co(i,this.sidebarTitle,this.sidebarVisible,t.announceForAccessibility.bind(t),o),this.sidebarTitle.onUpdateAndNow(r=>{this.closeButton.setAttribute("aria-label",o.closeSidebar(r));}),this.listenForVisibilityChanges(),this.sidebarContainer.replaceChildren(this.closeButton,this.sidebarContent),this.menuContainer.replaceChildren(this.sidebarContainer),e.appendChild(this.menuContainer);}listenForVisibilityChanges(){let t=null,e=170;this.sidebarVisible.get()||(this.menuContainer.style.display="none",this.menuContainer.style.opacity="0");let o=window.matchMedia?.("(prefers-reduced-motion: reduce)")??"";this.sidebarVisible.onUpdate(i=>{let r=`${e}ms ease`,s=o.matches?"-reduce-motion":"";i?(this.sidebarY.set(this.snappedSidebarY()),t&&(clearTimeout(t),t=null),this.menuContainer.style.display="",this.sidebarContainer.style.animation=`${r} ${E}-edgemenu-transition-in${s}`,this.menuContainer.style.animation=`${r} ${E}-edgemenu-container-transition-in${s}`,this.menuContainer.style.opacity="1",this.closeButton.focus({preventScroll:true})):(this.closeColorPickers(),t===null&&(this.sidebarContainer.style.animation=`${r} ${E}-edgemenu-transition-out${s}`,this.menuContainer.style.animation=`${r} ${E}-edgemenu-container-transition-out${s}`,this.menuContainer.style.opacity="0",this.editor.announceForAccessibility(this.localizationTable.dropdownHidden(this.sidebarTitle.get())),t=setTimeout(()=>{this.menuContainer.style.display="none",this.menuContainer.style.overflowY="",t=null;},e)));});}onToolbarRowResize(){let t=()=>{let r=this.toolbarToolRow.clientWidth,s=0,a=0,l=0;for(let d of this.toolbarToolRow.children){let p=d.clientHeight;if(s+=p,l++,s>r){a=r-s+p/2,a<0&&(a+=p);break}}let c=Math.round(a/l*10)/10;this.toolbarToolRow.style.setProperty("--extra-left-right-padding",`${c}px`);},e=this.toolbarActionRow.getBoundingClientRect(),o=this.toolbarToolRow.getBoundingClientRect();e.y+e.height<=o.y?this.toolbarContainer.classList.remove("one-row"):this.toolbarContainer.classList.add("one-row"),this.toolbarToolRow.clientWidth<this.toolbarToolRow.scrollWidth?(this.toolbarToolRow.classList.add("has-scroll"),t()):this.toolbarToolRow.classList.remove("has-scroll","extra-padding");}addSpacer(t){}addUndoRedoButtons(){super.addUndoRedoButtons(false);}addDefaults(){this.addDefaultActionButtons(),this.addDefaultToolWidgets();}updateWidgetCSSClasses(t){let e=t.getTags();t.removeCSSClassFromContainer("label-inline"),t.removeCSSClassFromContainer("label-left"),t.removeCSSClassFromContainer("label-right"),e.includes("save")&&(t.addCSSClassToContainer("label-inline"),t.addCSSClassToContainer("label-left")),e.includes("exit")&&(t.addCSSClassToContainer("label-inline"),t.addCSSClassToContainer("label-right"));}addWidgetInternal(t){this.updateWidgetCSSClasses(t),t.setLayoutManager(this.layoutManager),t.mustBeInToplevelMenu()?t.addTo(this.toolbarActionRow):t.addTo(this.toolbarToolRow);}removeWidgetInternal(t){t.remove();}onRemove(){this.toolbarContainer.remove(),this.menuContainer.remove(),this.toolRowResizeObserver.disconnect(),this.clearDragListeners?.();}initDragListeners(){let t=[this.closeButton,this.sidebarContainer,this.sidebarContent];this.manageListener(this.editor.handlePointerEventsExceptClicksFrom(this.menuContainer,(r,s)=>s.target===this.menuContainer?(r==="pointerdown"&&(this.sidebarVisible.set(false),setTimeout(()=>this.editor.focus(),0)),true):!this.sidebarVisible.get(),(r,s)=>s.target===this.menuContainer));let e=true,o=0,i=Ko(this.sidebarContainer,{draggableChildElements:t,onDrag:(r,s)=>this.handleDrag(r,s),onDragEnd:r=>{o=r.endTimestamp,e=r.roughlyClick,this.finalizeDrag();}});this.clearDragListeners=()=>i.removeListeners(),this.closeButton.addEventListener("click",()=>{let r=performance.now()-o<100;(r&&e||!r)&&this.sidebarVisible.set(false);});}handleDrag(t,e){this.sidebarContainer.style.transition="none",this.sidebarY.set(this.sidebarY.get()+e);}snappedSidebarY(t){let e=t??this.sidebarY.get(),o=[-100,0];this.sidebarContainer.clientHeight>window.innerHeight&&o.push(100);let i=o[0];for(let r of o)Math.abs(r-e)<Math.abs(i-e)&&(i=r);return i}finalizeDrag(){this.sidebarContainer.style.transition="",this.sidebarY.get()>this.sidebarContainer.clientHeight/2?this.sidebarVisible.set(false):this.sidebarY.set(this.snappedSidebarY());}serializeInternal(){return {menuSizeY:this.snappedSidebarY()}}deserializeInternal(t){typeof t=="object"&&typeof t.menuSizeY=="number"&&this.sidebarY.set(this.snappedSidebarY(t.menuSizeY));}};var Me=class n extends ue{clearedCount=0;renderedPathCount=0;lastFillStyle=null;lastPoint=null;objectNestingLevel=0;lastText=null;lastImage=null;pointBuffer=[];constructor(t){super(t);}displaySize(){let t=this.getViewport().getScreenRectSize();return t.x===0||t.y===0?exports.Vec2.of(640,480):t}clear(){if(this.clearedCount++,this.renderedPathCount=0,this.pointBuffer=[],this.lastText=null,this.lastImage=null,this.objectNestingLevel>0)throw new Error(`Within an object while clearing! Nesting level: ${this.objectNestingLevel}`)}beginPath(t){this.lastPoint=t,this.pointBuffer.push(t);}endPath(t){this.renderedPathCount++,this.lastFillStyle=t;}lineTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t);}moveTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t);}traceCubicBezierCurve(t,e,o){t=this.canvasToScreen(t),e=this.canvasToScreen(e),o=this.canvasToScreen(o),this.lastPoint=o,this.pointBuffer.push(t,e,o);}traceQuadraticBezierCurve(t,e){t=this.canvasToScreen(t),e=this.canvasToScreen(e),this.lastPoint=e,this.pointBuffer.push(t,e);}drawPoints(...t){}drawText(t,e,o){this.lastText=t;}drawImage(t){this.lastImage=t;}startObject(t,e){super.startObject(t),this.objectNestingLevel+=1;}endObject(){super.endObject(),this.objectNestingLevel-=1;}isTooSmallToRender(t){return  false}canRenderFromWithoutDataLoss(t){return t instanceof n}renderFromOtherOfSameType(t,e){if(!(e instanceof n))throw new TypeError(`${e} cannot be rendered onto ${this}`);this.renderedPathCount+=e.renderedPathCount,this.lastFillStyle=e.lastFillStyle,this.lastPoint=e.lastPoint,this.pointBuffer.push(...e.pointBuffer.map(o=>t.transformVec2(o)));}toString(){return "[DummyRenderer]"}};var po=class{constructor(t,e){this.onBeforeDeallocCallback=t;this.cacheState=e;this.renderer=e.props.createRenderer(),this.lastUsedCycle=-1,this.allocd=true;}renderer;lastUsedCycle;allocd=false;allocCount=0;startRender(){if(this.lastUsedCycle=this.cacheState.currentRenderingCycle,!this.allocd)throw new Error("Only alloc'd canvases can be rendered to");return this.renderer}dealloc(){this.onBeforeDeallocCallback?.(),this.allocd=false,this.onBeforeDeallocCallback=null,this.lastUsedCycle=0;}isAllocd(){return this.allocd}realloc(t){this.allocd&&this.dealloc(),this.allocd=true,this.onBeforeDeallocCallback=t,this.lastUsedCycle=this.cacheState.currentRenderingCycle,this.allocCount++;}getLastUsedCycle(){return this.lastUsedCycle}getTransform(t){return T.scaling2D(this.cacheState.props.blockResolution.x/t.size.x).rightMul(T.translation(t.topLeft.times(-1)))}setRenderingRegion(t){let e=this.getTransform(t);this.renderer.setTransform(e),this.renderer.overrideVisibleRect(t.grownBy(1/e.getScaleFactor()));}};var vi=class{cacheRecords=[];maxCanvases;cacheState;constructor(t){this.maxCanvases=Math.ceil(t.cacheSize/4/t.blockResolution.x/t.blockResolution.y);}setSharedState(t){this.cacheState=t;}allocCanvas(t,e){if(this.cacheRecords.length<this.maxCanvases){let o=new po(e,this.cacheState);return o.setRenderingRegion(t),this.cacheRecords.push(o),this.cacheState.debugMode&&console.log("[Cache] Cache spaces used: ",this.cacheRecords.length," of ",this.maxCanvases),o}else {let o=this.getLeastRecentlyUsedRecord();return this.cacheState.debugMode&&console.log("[Cache] Re-alloc. Times allocated: ",o.allocCount,`
Last used cycle: `,o.getLastUsedCycle(),`
Current cycle: `,this.cacheState.currentRenderingCycle),o.realloc(e),o.setRenderingRegion(t),this.cacheState.debugMode&&(console.log("[Cache] Now re-alloc'd. Last used cycle: ",o.getLastUsedCycle()),console.assert(o.cacheState===this.cacheState,"[Cache] Unequal cache states! cacheState should be a shared object!")),o}}getLeastRecentlyUsedRecord(){return this.cacheRecords.sort((t,e)=>t.getLastUsedCycle()-e.getLastUsedCycle()),this.cacheRecords[0]}getDebugInfo(){let t=0,e=0;for(let i of this.cacheRecords)e+=i.allocCount,i.isAllocd()&&t++;return e/=Math.max(this.cacheRecords.length,1),[`${this.cacheRecords.length} cache records (max ${this.maxCanvases})`,`${t} assigned to screen regions`,`Average number of times reassigned: ${Math.round(e*100)/100}`].join(`
`)}};var Ie=3,uo=class n{constructor(t,e){this.region=t;this.cacheState=e;}instantiatedChildren=[];parent=null;cachedRenderer=null;renderedIds=[];renderedMaxZIndex=null;generateParent(){if(this.parent)return this.parent;let t=P.fromCorners(this.region.topLeft.minus(this.region.size),this.region.bottomRight.plus(this.region.size)),e=new n(t,this.cacheState);e.generateChildren();let o=this.region.maxDimension/100,i=(e.instantiatedChildren.length-1)/2;if(!e.instantiatedChildren[i].region.eq(this.region,o))throw console.error(e.instantiatedChildren[i].region,"\u2260",this.region),new Error("Logic error: [this] is not contained within its parent's center child");return e.instantiatedChildren[i]=this,this.parent=e,e}generateChildren(){if(this.instantiatedChildren.length===0){if(this.region.size.x/Ie===0||this.region.size.y/Ie===0){console.warn("Cache element has zero size! Not generating children.");return}let t=this.region.divideIntoGrid(Ie,Ie);console.assert(t.length===Ie*Ie,"Warning: divideIntoGrid created the wrong number of subrectangles!");for(let e of t){let o=new n(e,this.cacheState);o.parent=this,this.instantiatedChildren.push(o);}}this.checkRep();}getChildren(){return this.checkRep(),this.generateChildren(),this.instantiatedChildren}smallestChildContaining(t){let e=t.maxDimension>this.region.maxDimension/Ie;if(!this.region.containsRect(t)||e)return null;for(let o of this.getChildren())if(o.region.containsRect(t))return o.smallestChildContaining(t)??o;return null}renderingWouldBeHighEnoughResolution(t){let e=this.region.w/this.cacheState.props.blockResolution.x;return !(t.getScaleFactor()*e>this.cacheState.props.maxScale)}allChildrenCanRender(t,e){if(this.instantiatedChildren.length===0)return  false;for(let o of this.instantiatedChildren)if(o.region.intersects(t.visibleRect)&&!o.renderingIsUpToDate(this.idsOfIntersecting(e)))return  false;return  true}computeSortedByLeafIds(t){let e=t.slice();return e.sort((o,i)=>o.getId()-i.getId()),e}idsOfIntersecting(t){let e=[];for(let o of t)o.getBBox().intersects(this.region)&&e.push(o.getId());return e}allRenderedIdsIn(t){if(this.renderedIds.length>t.length)return  false;for(let e=0;e<this.renderedIds.length;e++)if(t[e]!==this.renderedIds[e])return  false;return  true}renderingIsUpToDate(t){return this.cachedRenderer===null||t.length!==this.renderedIds.length?false:this.allRenderedIdsIn(t)}renderItems(t,e,o){if(!o.visibleRect.intersects(this.region)||e.length===0)return;if(e=(s=>{let a=[];for(let l of s){let c=l.getBBox();c.intersects(this.region)&&(c.maxDimension>=this.region.maxDimension?a.push(...l.getChildrenOrSelfIntersectingRegion(this.region)):a.push(l));}return a})(e),!this.cacheState.props.isOfCorrectType(t)){for(let s of e)s.render(t,o.visibleRect);return}if(this.cacheState.debugMode&&t.drawRect(this.region,o.getSizeOfPixelOnCanvas(),{fill:w.yellow}),this.renderingWouldBeHighEnoughResolution(o)){let s=p=>p.w/this.region.w<1/this.cacheState.props.blockResolution.x,a=[];for(let p of e)a.push(...p.getLeavesIntersectingRegion(this.region,s));We(a);let l=this.computeSortedByLeafIds(a);if(l.length===0)return;let c=l.map(p=>p.getId()),d;if(this.renderingIsUpToDate(c))d=this.cachedRenderer.startRender();else {if(this.allChildrenCanRender(o,l)){for(let u of this.getChildren())u.renderItems(t,e,o);return}let p=0;for(let u of l)s(u.getBBox())||(p+=u.getContent().getProportionalRenderingTime());if(p>this.cacheState.props.minProportionalRenderTimePerCache){let u=true;if(!this.cachedRenderer)this.cachedRenderer=this.cacheState.recordManager.allocCanvas(this.region,()=>this.onRegionDealloc());else if(l.length>this.renderedIds.length&&this.allRenderedIdsIn(c)&&this.renderedMaxZIndex!==null){let m=null;for(let[g,b]of l.entries()){let f=b.getContent().getZIndex();(g>=this.renderedIds.length||b.getId()!==this.renderedIds[g])&&((m===null||f<m)&&(m=f));}if(m!==null&&m>this.renderedMaxZIndex){u=false,d=this.cachedRenderer.startRender();for(let g of a){let b=g.getContent().getZIndex();b>this.renderedMaxZIndex&&(g.render(d,this.region),this.renderedMaxZIndex=b);}this.cacheState.debugMode&&t.drawRect(this.region,2*o.getSizeOfPixelOnCanvas(),{fill:w.clay});}}else this.cacheState.debugMode&&console.log("Decided on a full re-render. Reason: At least one of the following is false:",`
 leafIds.length > this.renderedIds.length: `,c.length>this.renderedIds.length,`
 this.allRenderedIdsIn(leafIds): `,this.allRenderedIdsIn(c),`
 this.renderedMaxZIndex !== null: `,this.renderedMaxZIndex!==null,`

this.rerenderedIds: `,this.renderedIds,", leafIds: ",c);if(u){d=this.cachedRenderer.startRender(),d.clear(),this.renderedMaxZIndex=null;let h=Fi(a,this.region);for(let m=h;m<a.length;m++){let g=a[m],b=g.getContent();this.renderedMaxZIndex??=b.getZIndex(),this.renderedMaxZIndex=Math.max(this.renderedMaxZIndex,b.getZIndex()),g.render(d,this.region);}this.cacheState.debugMode&&t.drawRect(this.region,3*o.getSizeOfPixelOnCanvas(),{fill:w.red});}this.renderedIds=c;}else {this.cachedRenderer?.dealloc();let u=o.getSizeOfPixelOnCanvas(),h=new P(this.region.x,this.region.y,this.region.w+u,this.region.h+u);t.startObject(h,true);for(let g of a)g.render(t,this.region.intersection(o.visibleRect));t.endObject(),this.cacheState.debugMode&&t.drawRect(this.region,2*o.getSizeOfPixelOnCanvas(),{fill:w.green});}}if(d){let p=this.cachedRenderer.getTransform(this.region).inverse();t.renderFromOtherOfSameType(p,d);}this.instantiatedChildren.every(p=>p.isEmpty())&&(this.instantiatedChildren=[]);}else for(let s of this.getChildren())s.renderItems(t,e.filter(a=>a.getBBox().intersects(s.region)),o);this.checkRep();}isEmpty(){return this.cachedRenderer!==null?false:this.instantiatedChildren.every(t=>t.isEmpty())}onRegionDealloc(){this.cachedRenderer=null,this.isEmpty()&&(this.instantiatedChildren=[]);}checkRep(){if(this.instantiatedChildren.length!==Ie*Ie&&this.instantiatedChildren.length>0)throw new Error(`Repcheck: Wrong number of children. Got ${this.instantiatedChildren.length}`);if(this.renderedIds[1]!==void 0&&this.renderedIds[0]>=this.renderedIds[1])throw console.error(this.renderedIds),new Error("Repcheck: First two ids are not in ascending order!");for(let t of this.instantiatedChildren)if(t.parent!==this)throw new Error("Children should be linked to their parents!");if(this.cachedRenderer&&!this.cachedRenderer.isAllocd())throw new Error("this' cachedRenderer != null, but is dealloc'd")}};var ho=class{sharedState;recordManager;rootNode;constructor(t){this.recordManager=new vi(t),this.sharedState={props:t,currentRenderingCycle:0,recordManager:this.recordManager,debugMode:false},this.recordManager.setSharedState(this.sharedState);}render(t,e,o){let i=o.visibleRect;if(this.sharedState.currentRenderingCycle++,!this.sharedState.props.isOfCorrectType(t)){e.render(t,i);return}if(!this.rootNode){let a=this.sharedState.props.blockResolution,l=i.topLeft;this.rootNode=new uo(new P(l.x,l.y,a.x,a.y),this.sharedState);}for(;!this.rootNode.region.containsRect(i);)this.rootNode=this.rootNode.generateParent();this.rootNode=this.rootNode.smallestChildContaining(i)??this.rootNode;let r=e.getLeavesIntersectingRegion(o.visibleRect,a=>t.isTooSmallToRender(a)),s=0;for(let a of r)s+=a.getContent().getProportionalRenderingTime();s>this.sharedState.props.minProportionalRenderTimeToUseCache?this.rootNode.renderItems(t,[e],o):e.render(t,i);}getDebugInfo(){return this.recordManager.getDebugInfo()}setIsDebugMode(t){this.sharedState.debugMode=t;}};var mo=class extends ue{constructor(e,o){super(e);this.localizationTable=o;}descriptionBuilder=[];pathCount=0;textNodeCount=0;imageNodeCount=0;displaySize(){return exports.Vec2.of(500,500)}clear(){this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0,this.imageNodeCount=0;}getDescription(){return [this.localizationTable.pathNodeCount(this.pathCount),...this.textNodeCount>0?[this.localizationTable.textNodeCount(this.textNodeCount)]:[],...this.imageNodeCount>0?[this.localizationTable.imageNodeCount(this.imageNodeCount)]:[],...this.descriptionBuilder].join(`
`)}beginPath(e){}endPath(e){this.pathCount++;}lineTo(e){}moveTo(e){}traceCubicBezierCurve(e,o,i){}traceQuadraticBezierCurve(e,o){}drawText(e,o,i){this.descriptionBuilder.push(this.localizationTable.textNode(e)),this.textNodeCount++;}drawImage(e){let o=e.label?this.localizationTable.imageNode(e.label):this.localizationTable.unlabeledImageNode;this.descriptionBuilder.push(o),this.imageNodeCount++;}isTooSmallToRender(e){return e.maxDimension<15/this.getSizeOfCanvasPixelOnScreen()}drawPoints(...e){}};var Hr=(e=>(e[e.DummyRenderer=0]="DummyRenderer",e[e.CanvasRenderer=1]="CanvasRenderer",e))(Hr||{}),Rt=class{constructor(t,e,o){this.editor=t;this.parent=o;if(e===1)this.initializeCanvasRendering();else if(e===0)this.dryInkRenderer=new Me(t.viewport),this.wetInkRenderer=new Me(t.viewport);else throw new Error(`Unknown rendering mode, ${e}!`);this.textRenderer=new mo(t.viewport,t.localization),this.initializeTextRendering();let i=exports.Vec2.of(600,600);this.cache=new ho({createRenderer:()=>{if(e===0)return new Me(t.viewport);if(e!==1)throw new Error("Unspported rendering mode");let r=document.createElement("canvas");r.width=i.x+1,r.height=i.y+1;let s=r.getContext("2d");return new he(s,t.viewport)},isOfCorrectType:r=>this.dryInkRenderer.canRenderFromWithoutDataLoss(r),blockResolution:i,cacheSize:600*600*4*90,maxScale:Math.max(1,1.3/window.devicePixelRatio),minProportionalRenderTimePerCache:20*4,minProportionalRenderTimeToUseCache:105*4}),this.editor.notifier.on(8,r=>{if(r.kind!==8)throw new Error("Mismatched event.kinds!");this.resizeSurfacesCallback?.();});}dryInkRenderer;wetInkRenderer;textRenderer;textRerenderOutput=null;cache;devicePixelRatio=window.devicePixelRatio??1;resizeSurfacesCallback;flattenCallback;get width(){return this.dryInkRenderer.displaySize().x}get height(){return this.dryInkRenderer.displaySize().y}getCache(){return this.cache}getColorAt=t=>null;initializeCanvasRendering(){let t=document.createElement("canvas"),e=document.createElement("canvas"),o=t.getContext("2d"),i=e.getContext("2d");this.dryInkRenderer=new he(o,this.editor.viewport),this.wetInkRenderer=new he(i,this.editor.viewport),t.className="dryInkCanvas",e.className="wetInkCanvas",this.parent&&(this.parent.appendChild(t),this.parent.appendChild(e)),this.resizeSurfacesCallback=()=>{let r=l=>Math.ceil(l.clientWidth*this.devicePixelRatio)||l.width,s=l=>Math.ceil(l.clientHeight*this.devicePixelRatio)||l.height,a=l=>s(l)!==l.height||r(l)!==l.width;(a(t)||a(e))&&(t.width=r(t),t.height=s(t),e.width=r(e),e.height=s(e),i.resetTransform(),o.resetTransform(),o.scale(this.devicePixelRatio,this.devicePixelRatio),i.scale(this.devicePixelRatio,this.devicePixelRatio),this.editor.notifier.dispatch(8,{kind:8,newSize:exports.Vec2.of(this.width,this.height)}));},this.resizeSurfacesCallback(),this.flattenCallback=()=>{o.save(),o.resetTransform(),o.drawImage(e,0,0),o.restore();},this.getColorAt=r=>{let s=r.times(this.devicePixelRatio),l=o.getImageData(s.x,s.y,1,1)?.data;return l?w.ofRGBA(l[0]/255,l[1]/255,l[2]/255,l[3]/255):null};}initializeTextRendering(){let t=document.createElement("div");t.classList.add("textRendererOutputContainer");let e=document.createElement("button");e.classList.add("rerenderButton"),e.innerText=this.editor.localization.rerenderAsText,this.textRerenderOutput=document.createElement("div"),this.textRerenderOutput.setAttribute("aria-live","polite"),e.addEventListener("click",()=>{this.rerenderAsText();}),t.replaceChildren(e,this.textRerenderOutput),this.editor.createHTMLOverlay(t);}setDevicePixelRatio(t){if(isFinite(t)&&t>=.001&&t<=10&&t!==this.devicePixelRatio)return this.devicePixelRatio=t,this.resizeSurfacesCallback?.(),this.editor.queueRerender()}getDevicePixelRatio(){return this.devicePixelRatio}rerenderAsText(){this.textRenderer.clear(),this.editor.image.render(this.textRenderer,this.editor.viewport),this.textRerenderOutput&&(this.textRerenderOutput.innerText=this.textRenderer.getDescription());}startRerender(){return this.resizeSurfacesCallback?.(),this.dryInkRenderer.clear(),this.dryInkRenderer}setDraftMode(t){this.dryInkRenderer.setDraftMode(t);}getDryInkRenderer(){return this.dryInkRenderer}getWetInkRenderer(){return this.wetInkRenderer}flatten(){this.flattenCallback?.();}};function Ia(n){let t=0,e=n.map(o=>o.id);e.sort();for(let o of e)t===o&&(t=o+1);return t}var xi=Ia;function ka(n,t,e,o,i=0){let r=xi(o??[]),s=de.ofCanvasPoint(e,t!==2,n.viewport,r,i);return n.toolController.dispatchInputEvent({kind:t,allPointers:o??[s],current:s}),s}var Nr=ka;function Ra(n,t,e,o){let i=n.viewport.screenToCanvas(e),r=xi(o??[]),s=de.ofCanvasPoint(i,t!==2,n.viewport,r,2);return n.toolController.dispatchInputEvent({kind:t,allPointers:[...o??[],s],current:s}),s}var La=Ra;var Ur=class{constructor(t,e,o){this.editor=t;this.announceRedoCallback=e;this.announceUndoCallback=o;this.#e=[],this.#t=[];}#e;#t;maxUndoRedoStackSize=700;fireUpdateEvent(t,e){this.editor.notifier.dispatch(3,{kind:3,undoStackSize:this.#e.length,redoStackSize:this.#t.length,command:e,stackUpdateType:t});}push(t,e=true){e&&t.apply(this.editor),this.#e.push(t);for(let o of this.#t)o.onDrop(this.editor);if(this.#t=[],this.#e.length>this.maxUndoRedoStackSize){let o=Math.ceil(this.maxUndoRedoStackSize/100);this.#e.splice(0,o).forEach(r=>r.onDrop(this.editor));}this.fireUpdateEvent(0,t),this.editor.notifier.dispatch(4,{kind:4,command:t});}undo(){let t=this.#e.pop();if(t){this.#t.push(t);let e=t.unapply(this.editor);return this.announceUndoCallback(t),this.fireUpdateEvent(1,t),this.editor.notifier.dispatch(5,{kind:5,command:t}),e}}redo(){let t=this.#t.pop();if(t){this.#e.push(t);let e=t.apply(this.editor);return this.announceRedoCallback(t),this.fireUpdateEvent(2,t),this.editor.notifier.dispatch(4,{kind:4,command:t}),e}}get undoStackSize(){return this.#e.length}get redoStackSize(){return this.#t.length}clearAll(){for(;this.undoStackSize>0;)this.undo();this.#e=[],this.#t=[];}},Wr=Ur;function Ba(n,t){let e=n.getRootElement(),o=[["--background-color-1","--foreground-color-1",true,true],["--background-color-2","--foreground-color-2",true,true],["--background-color-3","--foreground-color-3",true,true],["--background-color-2","--primary-action-foreground-color",false,true],["--selection-background-color","--selection-foreground-color",false,true]];if(!t?.dontClearOverrides)for(let[a,l]of o)e.style.setProperty(a,null),e.style.setProperty(l,null);let i=getComputedStyle(e),r=Object.create(null),s=(a,l,c,d,p)=>{let u=r[a]?r[a]:w.fromString(i.getPropertyValue(a)),h=r[l]?r[l]:w.fromString(i.getPropertyValue(l));if(u.relativeLuminance()<h.relativeLuminance()){let v=u;u=h,h=v;let f=l;l=a,a=f;let x=d;d=p,p=x;}let m=false,g=w.contrastRatio(u,h),b=0;for(;g<c&&b<8;){let v=exports.Vec3.of(.1,.1,.1);d&&(h.eq(w.white)&&!p&&(h=w.black),u=w.fromRGBVector(u.rgb.plus(v))),p&&(h.eq(w.black)&&!d&&(h=w.white),h=w.fromRGBVector(h.rgb.minus(v))),g=w.contrastRatio(u,h),m=true,b++;}m&&(e.style.setProperty(a,u.toHexString()),e.style.setProperty(l,h.toHexString()),r[a]=u,r[l]=h);};s("--selection-background-color","--background-color-2",1.29,true,false);for(let[a,l,c,d]of o)s(a,l,4.5,c,d);}var za=Ba;var fo={number:"1.28.0"};function Aa(n,t){let e=pi(n,{title:n.localization.about,contentClassNames:["about-dialog-content"]});for(let o of t){let i=document.createElement(o.minimized?"details":"div");i.classList.add("about-entry");let r=document.createElement(o.minimized?"summary":"h2");if(typeof o.heading=="string")r.innerText=o.heading;else {let s=document.createElement("a");s.href=o.heading.href.replace(/^javascript:/i,""),s.text=o.heading.text,r.appendChild(s);}if(i.appendChild(r),o.text){let s=document.createElement("div");s.innerText=o.text,i.appendChild(s);}e.appendChild(i);}return {close:()=>e.close()}}var ss=Aa;function Da(n,t,e){let o=t.w,i=t.h;if(e?.minDimension&&o<e.minDimension){let r=e.minDimension;i*=r/(o||1),o=r;}if(e?.minDimension&&i<e.minDimension){let r=e.minDimension;o*=r/(i||1),i=r;}n.setAttribute("width",J(o)),n.setAttribute("height",J(i));}var as=Da;function ls(n,t,e){let o=n.getImportExportViewport().getTemporaryClone();if(e?.minDimension){let s=o.visibleRect,a=s;a.w<=0&&(a=new P(a.x,a.y,e.minDimension,a.h)),a.h<=0&&(a=new P(a.x,a.y,a.w,e.minDimension)),a.eq(s)||o.updateScreenSize(a.size);}let{element:i,renderer:r}=oe.fromViewport(o,{sanitize:e.sanitize??false,useViewBoxForPositioning:true});return t(r,()=>{n.getAutoresizeEnabled()?i.classList.add(ui):i.classList.remove(ui);let s=o.visibleRect;return as(i,s,e),i}),i}function cs(n,t){return ls(n,(e,o)=>{n.renderAll(e),o();},t)}function ds(n,t,e){return new Promise(o=>{ls(n,async(i,r)=>{await n.renderAllAsync(i,t);let s=r();o(s);},e);})}var go=class extends ce{canShowContextMenu=false;contextMenuTriggerPointer;contextMenuStartPoint;stationaryDetector=null;clickTolerance=12;constructor(){super();}canMakeLongPressMenuEvent(t){let e=[2];return t.allPointers.length===1&&e.includes(t.current.device)}onEvent(t){let e=()=>Nt(t)&&this.canShowContextMenu&&this.emit({kind:9,screenPos:t.current.screenPos,canvasPos:t.current.canvasPos})?(this.emit({kind:3}),true):false;if(t.kind===0)t.allPointers.length===1?(this.canShowContextMenu=true,this.contextMenuTriggerPointer=t.current,this.contextMenuStartPoint=t.current.screenPos,this.canMakeLongPressMenuEvent(t)&&(this.stationaryDetector=new Pe(t.current,ct,e))):this.canShowContextMenu=false;else if(t.kind===1){if(this.canShowContextMenu){this.stationaryDetector?.onPointerMove(t.current);let o=t.current.screenPos.minus(this.contextMenuStartPoint),i=this.clickTolerance;o.length()>i&&(this.canShowContextMenu=false);}}else if(t.kind===2&&(this.stationaryDetector?.destroy(),this.contextMenuTriggerPointer?.id===t.current.id&&this.contextMenuTriggerPointer.device===4&&e()))return  true;return this.emit(t)}};var bo=class n extends ce{constructor(e,o){super();this.shortcuts=e;this.viewport=o;}snapToGridEnabled=false;angleLockEnabled=false;startPointCanvas=null;xyAxesSnap(e){if(!this.startPointCanvas)return e;let o=this.viewport.canvasToScreen(this.startPointCanvas);return e.lockedToXYAxesScreen(o,this.viewport)}mapPointerEvent(e){let o=i=>e.allPointers.length>1?i:this.snapToGridEnabled?i.snappedToGrid(this.viewport):this.angleLockEnabled&&this.startPointCanvas?this.xyAxesSnap(i):i;return {kind:e.kind,current:o(e.current),allPointers:e.allPointers.map(o)}}onEvent(e){let o=this.shortcuts;(e.kind===0||e.kind===1||e.kind===2)&&(e.kind===0&&(this.startPointCanvas=e.current.canvasPos),e=this.mapPointerEvent(e));let i=this.emit(e);if(e.kind===6||!i&&e.kind===5){let r=e.kind===5;o.matchesShortcut(lt,e)&&(this.snapToGridEnabled=r,i=true),o.matchesShortcut(ur,e)&&(this.angleLockEnabled=r,i=true);}return i}static fromEditor(e){return new n(e.shortcuts,e.viewport)}};var ps={Control:"ControlLeft","=":"Equal","-":"Minus",";":"Semicolon"," ":"Space"};function Va(n){let t=n.toUpperCase();return "A"<=t&&t<="Z"?`Key${t}`:"0"<=n&&n<="9"?`Digit${n}`:n in ps?ps[n]:n}var us=Va;function Ma(n,t){let e=[],o=(l,c)=>l.key===c.key&&l.code===c.code,i=l=>e.some(c=>o(c,l)),r=l=>({code:l.code,key:l.key,ctrlKey:l.ctrlKey,altKey:l.altKey,shiftKey:l.shiftKey,metaKey:l.metaKey}),s=l=>{if(l.type==="keydown"){if(i(l)||e.push(r(l)),!t.filter(l))return;t.handleKeyDown(l);}else {if(console.assert(l.type==="keyup"),e=e.filter(c=>!o(c,l)),!t.filter(l))return;t.handleKeyUp(l);}};n.addEventListener("keydown",l=>{s(l);}),n.addEventListener("keyup",l=>{s(l);}),n.addEventListener("focusout",l=>{let c=false;if(l.relatedTarget){let d=l.relatedTarget;c=n.contains(d)||t.getHandlesKeyEventsFrom(d);}if(!c){for(let d of e)t.handleKeyUp(new KeyboardEvent("keyup",{...d}));e=[];}});let a=l=>{let c=false,d=false,p=false,u=false;for(let g of e){let b=g.code;c||=!!/^Shift(Left|Right)$/.test(b),d||=!!/^Control(Left|Right)$/.test(b),p||=!!/^Alt(Left|Right)$/.test(b),u||=!!/^Meta(Left|Right)$/.test(b);}let h=g=>g?"keydown":"keyup",m={shiftKey:l.shiftKey,altKey:l.altKey,metaKey:l.metaKey,ctrlKey:l.ctrlKey};l.shiftKey!==c&&s(new KeyboardEvent(h(l.shiftKey),{...m,key:"Shift",code:"ShiftLeft"})),l.altKey!==p&&s(new KeyboardEvent(h(l.altKey),{...m,key:"Alt",code:"AltLeft"})),l.ctrlKey!==d&&s(new KeyboardEvent(h(l.ctrlKey),{...m,key:"Control",code:"ControlLeft"})),l.metaKey!==u&&s(new KeyboardEvent(h(l.metaKey),{...m,key:"Meta",code:"MetaLeft"}));};n.addEventListener("mousedown",l=>{a(l);}),n.addEventListener("mousemove",l=>{a(l);});}var hs=Ma;function Fa(n){return (e=>e.replace(/([^\n])\n([^\n])/g,"$1 $2"))(`
MIT License

Copyright (c) ${n}

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.`)}var Si=Fa;var Kr=class{container;renderingRegion;display;history;image;viewport;localization;icons;shortcuts;toolController;notifier;loadingWarning;accessibilityAnnounceArea;accessibilityControlArea;eventListenerTargets=[];readOnly;settings;constructor(t,e={}){if(this.localization={...qi(),...e.localization},this.settings={wheelEventsEnabled:e.wheelEventsEnabled??true,renderingMode:e.renderingMode??1,localization:this.localization,minZoom:e.minZoom??2e-10,maxZoom:e.maxZoom??1e12,keyboardShortcutOverrides:e.keyboardShortcutOverrides??{},iconProvider:e.iconProvider??new It,notices:e.notices??[],appInfo:e.appInfo?{...e.appInfo}:null,pens:{additionalPenTypes:e.pens?.additionalPenTypes??[],filterPenTypes:e.pens?.filterPenTypes??(()=>true)},text:{fonts:e.text?.fonts??["sans-serif","serif","monospace"]},image:{showImagePicker:e.image?.showImagePicker??void 0},svg:{loaderPlugins:e.svg?.loaderPlugins??[]},clipboardApi:e.clipboardApi??null,disableZoom:e.disableZoom??false},this.settings.minZoom>this.settings.maxZoom)throw new Error("Minimum zoom must be lesser than maximum zoom!");this.readOnly=K.fromInitialValue(false),this.icons=this.settings.iconProvider,this.shortcuts=new A(this.settings.keyboardShortcutOverrides),this.container=document.createElement("div"),this.renderingRegion=document.createElement("div"),this.container.appendChild(this.renderingRegion),this.container.classList.add("imageEditorContainer","easydrawer"),this.loadingWarning=document.createElement("div"),this.loadingWarning.classList.add("loadingMessage"),this.loadingWarning.ariaLive="polite",this.container.appendChild(this.loadingWarning),this.accessibilityControlArea=document.createElement("textarea"),this.accessibilityControlArea.setAttribute("placeholder",this.localization.accessibilityInputInstructions),this.accessibilityControlArea.style.opacity="0",this.accessibilityControlArea.style.width="0",this.accessibilityControlArea.style.height="0",this.accessibilityControlArea.style.position="absolute",this.accessibilityAnnounceArea=document.createElement("div"),this.accessibilityAnnounceArea.setAttribute("aria-live","assertive"),this.accessibilityAnnounceArea.className="accessibilityAnnouncement",this.container.appendChild(this.accessibilityAnnounceArea),this.renderingRegion.style.touchAction="none",this.renderingRegion.className="imageEditorRenderArea",this.renderingRegion.appendChild(this.accessibilityControlArea),this.renderingRegion.setAttribute("tabIndex","0"),this.renderingRegion.setAttribute("alt",""),this.notifier=new ge,this.viewport=new L((o,i)=>{this.notifier.dispatch(7,{kind:7,newTransform:i,oldTransform:o});}),this.display=new Rt(this,this.settings.renderingMode,this.renderingRegion),this.history=new Wr(this,this.announceRedoCallback,this.announceUndoCallback),this.toolController=new Et(this,this.localization),this.toolController.addInputMapper(bo.fromEditor(this)),this.toolController.addInputMapper(new go),t.appendChild(this.container),this.image=new H(this.display.width,this.display.height),this.viewport.updateScreenSize(exports.Vec2.of(this.display.width,this.display.height)),this.registerListeners(),this.queueRerender(),this.hideLoadingWarning(),this.notifier.on(7,o=>{if(o.kind!==7)return;let i=s=>s.transformVec3(exports.Vec2.unitX).length(),r=i(o.newTransform);if(r>this.settings.maxZoom||r<this.settings.minZoom){let s=i(o.oldTransform),a=T.identity;s<=this.settings.maxZoom&&s>=this.settings.minZoom?a=o.oldTransform:a=T.scaling2D((this.settings.minZoom+this.settings.maxZoom)/2),this.viewport.resetTransform(a);}else isFinite(r)||(console.warn(`Non-finite zoom (${r}) detected. Resetting the viewport. This was likely caused by division by zero.`),isFinite(i(o.oldTransform))?this.viewport.resetTransform(o.oldTransform):this.viewport.resetTransform());});}getCurrentSettings(){return {...this.settings}}getRootElement(){return this.container}getOutputBBoxInDOM(){return P.of(this.renderingRegion.getBoundingClientRect())}showLoadingWarning(t){let e=Math.round(t*100);this.loadingWarning.innerText=this.localization.loading(e),this.loadingWarning.style.display="block";}hideLoadingWarning(){this.loadingWarning.style.display="none",this.announceForAccessibility(this.localization.doneLoading);}previousAccessibilityAnnouncement="";announceForAccessibility(t){t===this.previousAccessibilityAnnouncement&&(t=t+". "),this.accessibilityAnnounceArea.innerText=t,this.previousAccessibilityAnnouncement=t;}addToolbar(t=true){let e=new kt(this,this.container,this.localization);return t&&e.addDefaults(),e}registerListeners(){this.handlePointerEventsFrom(this.renderingRegion),this.handleKeyEventsFrom(this.renderingRegion),this.handlePointerEventsFrom(this.accessibilityAnnounceArea);let t=[this.renderingRegion,this.accessibilityAnnounceArea,this.accessibilityControlArea,this.loadingWarning];for(let i of t)i.addEventListener("drag",r=>(r.preventDefault(),false)),i.addEventListener("dragstart",r=>(r.preventDefault(),false));this.container.addEventListener("wheel",i=>{this.handleHTMLWheelEvent(i);});let e=()=>{this.viewport.updateScreenSize(exports.Vec2.of(this.display.width,this.display.height)),this.image.updateScreenSizeImage(this.display.width,this.display.height),this.rerender(),this.updateEditorSizeVariables();};if("ResizeObserver"in window){let i=new ResizeObserver(e);i.observe(this.renderingRegion),i.observe(this.container);}else addEventListener("resize",e);this.accessibilityControlArea.addEventListener("input",()=>{this.accessibilityControlArea.value="";});let o=new pe(this);document.addEventListener("copy",async i=>{this.isEventSink(document.querySelector(":focus"))&&o.copy(i);}),document.addEventListener("paste",i=>{this.handlePaste(i);});}updateEditorSizeVariables(){this.container.style.setProperty("--editor-current-width-px",`${this.container.clientWidth}px`),this.container.style.setProperty("--editor-current-height-px",`${this.container.clientHeight}px`),this.container.style.setProperty("--editor-current-display-width-px",`${this.renderingRegion.clientWidth}px`),this.container.style.setProperty("--editor-current-display-height-px",`${this.renderingRegion.clientHeight}px`);}handleHTMLWheelEvent(t){let e=exports.Vec3.of(t.deltaX,t.deltaY,t.deltaZ);if(!t.ctrlKey&&!t.metaKey)if(this.settings.wheelEventsEnabled){if(this.settings.wheelEventsEnabled==="only-if-focused"&&!this.container.querySelector(":focus"))return}else return;t.deltaMode===WheelEvent.DOM_DELTA_LINE?e=e.times(15):t.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(e=e.times(100)),(t.ctrlKey||t.metaKey)&&(e=exports.Vec3.of(0,0,t.deltaY));let o=this.getOutputBBoxInDOM(),i=exports.Vec2.of(t.clientX,t.clientY).minus(o.topLeft);return this.toolController.dispatchInputEvent({kind:4,delta:e,screenPos:i})?(t.preventDefault(),true):false}pointers={};getPointerList(){let t=performance.now(),e=[];for(let o in this.pointers)this.pointers[o]&&t-this.pointers[o].timeStamp<2e3&&e.push(this.pointers[o]);return e}setPointerCapture(t,e){try{t.setPointerCapture(e);}catch(o){console.warn("Failed to setPointerCapture",o);}}releasePointerCapture(t,e){try{t.releasePointerCapture(e);}catch(o){console.warn("Failed to releasePointerCapture",o);}}handleHTMLPointerEvent(t,e){let o=this.renderingRegion,i=e.target??this.renderingRegion;if(t==="pointerdown"){let r=de.ofEvent(e,true,this.viewport,o);this.pointers[r.id]=r,this.setPointerCapture(i,r.id);let s={kind:0,current:r,allPointers:this.getPointerList()};return this.toolController.dispatchInputEvent(s),true}else if(t==="pointermove"){let r=de.ofEvent(e,this.pointers[e.pointerId]?.down??false,this.viewport,o);if(r.down){let s=this.pointers[r.id];if(s&&r.screenPos.distanceTo(s.screenPos)<2)return  false;this.pointers[r.id]=r,this.toolController.dispatchInputEvent({kind:1,current:r,allPointers:this.getPointerList()})&&e.preventDefault();}return  true}else if(t==="pointercancel"||t==="pointerup"){let r=de.ofEvent(e,false,this.viewport,o);return this.pointers[r.id]?(this.pointers[r.id]=r,this.releasePointerCapture(i,r.id),this.toolController.dispatchInputEvent({kind:2,current:r,allPointers:this.getPointerList()})&&e.preventDefault(),delete this.pointers[r.id],true):false}return t}isEventSink(t){let e=t;for(;e!==null;){for(let o of this.eventListenerTargets)if(o===e)return  true;e=e.parentElement;}return  false}async handleDrop(t){t.preventDefault(),await this.handlePaste(t);}async handlePaste(t){let e=document.querySelector(":focus")??t.target;if(this.isEventSink(e))return await new pe(this).paste(t)}handlePointerEventsFrom(t,e,o){let s={touchstart:l=>{o&&!o("touchstart",l)||l.preventDefault();},contextmenu:l=>{o&&!o("contextmenu",l)||l.preventDefault();}},a=["pointerdown","pointermove","pointerup","pointercancel"];for(let l of a)s[l]=c=>{let d=c;if(!(e&&!e(l,d)))return this.handleHTMLPointerEvent(l,d)};for(let l in s)t.addEventListener(l,s[l]);return {remove:()=>{for(let l in s)t.removeEventListener(l,s[l]);}}}handlePointerEventsExceptClicksFrom(t,e,o){let i=Object.create(null);return this.handlePointerEventsFrom(t,(r,s)=>{if(e&&!e(r,s))return  false;let a=exports.Vec2.of(s.pageX??s.clientX,s.pageY??s.clientY),l=s.pointerId??0,c=true;if(r==="pointerdown")i[l]={eventBuffer:[[r,s]],startPoint:a,hasMovedSignificantly:false},this.setPointerCapture(t,s.pointerId),c=false;else if(r==="pointermove"&&i[l]){let d=i[l].startPoint,p=i[l].eventBuffer;if(d&&a.distanceTo(d)<10&&!i[l].hasMovedSignificantly)p.push([r,s]),c=false;else {for(let[m,g]of p)this.handleHTMLPointerEvent(m,g);i[l].eventBuffer=[],i[l].hasMovedSignificantly=true,c=true;}}else r==="pointermove"?c=true:(r==="pointerup"||r==="pointercancel")&&i[l]&&i[l].eventBuffer.length>0&&(this.releasePointerCapture(t,s.pointerId),c=false,delete i[l]);return c},o)}handleHTMLKeyDownEvent(t){console.assert(t.type==="keydown",`handling a keydown event with type ${t.type}`);let e=$o(t);return this.toolController.dispatchInputEvent(e)?(t.preventDefault(),true):e.key==="t"||e.key==="T"?(t.preventDefault(),this.display.rerenderAsText(),true):e.key==="Escape"?(this.renderingRegion.blur(),true):false}handleHTMLKeyUpEvent(t){console.assert(t.type==="keyup",`Handling a keyup event with type ${t.type}`);let e=Wo(t);return this.toolController.dispatchInputEvent(e)?(t.preventDefault(),true):false}handleKeyEventsFrom(t,e=()=>true){hs(t,{filter:e,handleKeyDown:o=>{this.handleHTMLKeyDownEvent(o);},handleKeyUp:o=>{this.handleHTMLKeyUpEvent(o);},getHandlesKeyEventsFrom:o=>this.eventListenerTargets.includes(o)}),t.addEventListener("dragover",o=>{o.preventDefault();}),t.addEventListener("drop",o=>{this.handleDrop(o);}),this.eventListenerTargets.push(t);}setReadOnly(t){t!==this.readOnly.get()&&(this.readOnly.set(t),this.notifier.dispatch(10,{kind:10,editorIsReadOnly:t}));}isReadOnlyReactiveValue(){return this.readOnly}isReadOnly(){return this.readOnly}dispatch(t,e=true){let o=this.dispatchNoAnnounce(t,e),i=t.description(this,this.localization);return this.announceForAccessibility(i),o}dispatchNoAnnounce(t,e=false){let o=t.apply(this);return e&&this.history.push(t,false),o}async asyncApplyOrUnapplyCommands(t,e,o){console.assert(o>0),this.display.setDraftMode(true);for(let i=0;i<t.length;i+=o){this.showLoadingWarning(i/t.length);for(let r=i;r<t.length&&r<i+o;r++){let s=t[r];e?s.apply(this):s.unapply(this);}i+o<t.length&&await new Promise(r=>{this.rerender(),requestAnimationFrame(r);});}this.display.setDraftMode(false),this.hideLoadingWarning();}asyncApplyCommands(t,e){return this.asyncApplyOrUnapplyCommands(t,true,e)}asyncUnapplyCommands(t,e,o=false){return o&&(t=[...t],t.reverse()),this.asyncApplyOrUnapplyCommands(t,false,e)}announceUndoCallback=t=>{this.announceForAccessibility(this.localization.undoAnnouncement(t.description(this,this.localization)));};announceRedoCallback=t=>{this.announceForAccessibility(this.localization.redoAnnouncement(t.description(this,this.localization)));};nextRerenderListeners=[];rerenderQueued=false;queueRerender(){return this.rerenderQueued||(this.rerenderQueued=true,requestAnimationFrame(()=>{this.rerenderQueued&&(this.rerender(),this.rerenderQueued=false);})),new Promise(t=>{this.nextRerenderListeners.push(()=>t());})}isRerenderQueued(){return this.rerenderQueued}rerender(t=true){if(this.display.startRerender(),this.display.width===0||this.display.height===0)return;let e=this.display.getDryInkRenderer();this.image.renderWithCache(e,this.display.getCache(),this.viewport),this.rerenderQueued=false,this.nextRerenderListeners.forEach(o=>o()),this.nextRerenderListeners=[];}drawWetInk(...t){for(let e of t)this.display.getWetInkRenderer().drawPath(e);}clearWetInk(){this.display.getWetInkRenderer().clear();}focus(){this.renderingRegion.focus();}createHTMLOverlay(t){return t.classList.add("overlay","easydrawer-editor-overlay"),this.container.appendChild(t),{remove:()=>t.remove()}}anchorElementToCanvas(t,e){e instanceof T&&(e=No.fromImmutable(e));let o=document.createElement("div");o.classList.add("anchored-element-overlay");let i=document.createElement("div");i.classList.add("content-wrapper"),t.classList.add("content");let r=()=>{let d=e.get().transformVec3(exports.Vec2.unitX).angle()+this.viewport.getRotationAngle(),p=this.viewport.canvasToScreenTransform.rightMul(e.get());o.style.setProperty("--full-transform",p.toCSSMatrix());let u=p.transformVec2(exports.Vec2.zero);o.style.setProperty("--position-x",`${u.x}px`),o.style.setProperty("--position-y",`${u.y}px`),o.style.setProperty("--rotation",`${d*180/Math.PI}deg`),o.style.setProperty("--scale",`${p.getScaleFactor()}`);};r();let s=e.onUpdate(r),a=this.notifier.on(7,r);return i.appendChild(t),o.appendChild(i),o.classList.add("overlay","easydrawer-editor-overlay"),this.renderingRegion.insertAdjacentElement("afterend",o),{remove:()=>{o.remove(),s.remove(),a.remove();}}}addStyleSheet(t){let e=document.createElement("style");return e.innerText=t,this.container.appendChild(e),e}sendKeyboardEvent(t,e,o=false,i=false,r=void 0){r??=e.toUpperCase()===e&&e.toLowerCase()!==e,this.toolController.dispatchInputEvent({kind:t,key:e,code:us(e),ctrlKey:o,altKey:i,shiftKey:r});}sendPenEvent(t,e,o){Nr(this,t,e,o);}async addAndCenterComponents(t,e=true,o){let i=null;for(let u of t)i?i=i.union(u.getBBox()):i=u.getBBox();if(!i)return;let r=this.viewport.visibleRect,s=r.width/i.width,a=r.height/i.height,l=s;(i.width*l>r.width||i.height*l>r.height)&&(l=a),l*=2/3,l=L.roundScaleRatio(l);let c=T.translation(r.center.minus(i.center)).rightMul(T.scaling2D(l,i.center)),d=[];for(let u of t)d.push(H.addComponent(u)),d.push(u.transformBy(c));if(await this.dispatch(j(d,{applyChunkSize:100,description:o}),true),e)for(let u of this.toolController.getMatchingTools(re))u.setEnabled(true),u.setSelection(t);}toDataURL(t="image/png",e){let{element:o,renderer:i}=he.fromViewport(this.image.getImportExportViewport(),{canvasSize:e});return this.image.renderAll(i),o.toDataURL(t)}toSVG(t){return cs(this.image,t??{})}async toSVGAsync(t={}){let e=t.pauseAfterCount??100;return await ds(this.image,async(o,i,r)=>t.onProgress&&await t.onProgress(i,r)===false?false:(i%e===0&&await we(),true),{minDimension:t.minDimension})}async loadFrom(t){this.showLoadingWarning(0),this.display.setDraftMode(true);let e=this.image.getBackgroundComponents(),o=new U(e);await t.start(async i=>{await this.dispatchNoAnnounce(H.addComponent(i));},(i,r)=>i%500===0?(this.showLoadingWarning(i/r),this.rerender(),we()):null,(i,r)=>{this.dispatchNoAnnounce(this.setImportExportRect(i),false),this.dispatchNoAnnounce(this.viewport.zoomTo(i),false),r&&this.dispatchNoAnnounce(this.image.setAutoresizeEnabled(r.autoresize),false);}),this.image.getBackgroundComponents().length!==e.length&&await this.dispatchNoAnnounce(o),this.hideLoadingWarning(),this.display.setDraftMode(false),this.queueRerender();}getTopmostBackgroundComponent(){let t=null;for(let e of this.image.getBackgroundComponents())e instanceof Y&&(t=e);return t}setBackgroundStyle(t){let e=this.getTopmostBackgroundComponent(),o=[];e&&o.push(new U([e]));let i=e?.getBackgroundType?.()??2,r=e?.getStyle?.().color??w.transparent,s=this.image.getAutoresizeEnabled(),a=t.color&&i===2?0:i,l=t.type??a,c=t.color??r,d=t.autoresize??s;if(l!==2){let p=new Y(l,c);o.push(H.addComponent(p));}return d!==s&&(o.push(this.image.setAutoresizeEnabled(d)),!d&&this.image.getImportExportRect().maxDimension===0&&o.push(this.image.setImportExportRect(this.image.getImportExportRect().resizedTo(exports.Vec2.of(500,500))))),j(o)}setBackgroundColor(t){let e=this.getTopmostBackgroundComponent();if(e)return e.updateStyle({color:t});{let o=t.eq(w.transparent)?2:0;return e=new Y(o,t),this.image.addComponent(e)}}estimateBackgroundColor(){let t=[];for(let e of this.image.getBackgroundComponents())e instanceof Y&&t.push(e.getStyle().color??w.transparent);return w.average(t)}getImportExportRect(){return this.image.getImportExportViewport().visibleRect}setImportExportRect(t){return this.image.setImportExportRect(t)}async loadFromSVG(t,e=false){let o=De.fromString(t,{sanitize:e,plugins:this.getCurrentSettings().svg?.loaderPlugins});await this.loadFrom(o);}closeAboutDialog=null;showAboutDialog(){let t=this.icons.licenseInfo(),e=[];if(this.settings.appInfo){let i=[];this.settings.appInfo.version&&i.push(`v${this.settings.appInfo.version}`,""),this.settings.appInfo.description?i.push(this.settings.appInfo.description+`
`):i.push(`easydrawer v${fo.number}`),e.push({heading:`${this.settings.appInfo.name}`,text:i.join(`
`)});}else e.push({heading:"easydrawer",text:`v${fo.number}`});let o=this.viewport.getScreenRectSize();e.push({heading:this.localization.developerInformation,text:["Image debug information (from when this dialog was opened):",`    ${this.viewport.getScaleFactor()}x zoom, ${180/Math.PI*this.viewport.getRotationAngle()}\xB0 rotation`,`    ${this.image.estimateNumElements()} components`,`    auto-resize: ${this.image.getAutoresizeEnabled()?"enabled":"disabled"}`,`    image size: ${this.getImportExportRect().w}x${this.getImportExportRect().h}`,`    screen size: ${o.x}x${o.y}`,`    device pixel ratio: ${this.display.getDevicePixelRatio()}`,"    cache:",`        ${this.display.getCache().getDebugInfo().replace(/(\n)/g,`
        `)}`].join(`
`),minimized:true}),e.push({heading:this.localization.softwareLibraries,text:[`This image editor is powered by easydrawer v${fo.number}.`,"","At runtime, easydrawer uses"," - The Coloris color picker: https://github.com/mdbassit/Coloris"," - The bezier.js B\xE9zier curve library: https://github.com/Pomax/bezierjs","","Both are licensed under the MIT license:","","","== Coloris ==",Si("2021 Mohammed Bassit"),"","","== Bezier.js ==",Si('2023 Mike "Pomax" Kamermans'),"","","== easydrawer ==",Si("2023-2025 Henry Heino"),""].join(`
`),minimized:true}),t&&e.push({heading:"Icon Pack",text:t,minimized:true}),e.push(...this.settings.notices),this.closeAboutDialog?.(),this.closeAboutDialog=ss(this,e).close;}remove(){this.container.remove(),this.toolController.onEditorDestroyed();}async uploadImages(t){let e=Array.from(t);if(e.length===0)return;let o=(await Promise.all(e.map(async a=>yt(a)))).flat(),i=[],r=T.identity,s=null;for(let a of o){let l=new Image;l.src=a;let c;try{c=await te.fromImage(l,r);}catch(u){console.error("Error loading image",u);return}let d=c.getBBox();if(d.area===0)return;i.push(c),s??=d,s.union(d);let p=exports.Vec2.of(0,d.height);r=r.rightMul(T.translation(p));}i.length>0&&this.addAndCenterComponents(i);}},$r=Kr;var Lw=$r;exports.Abstract2DShape=xo;exports.AbstractComponent=N;exports.AbstractRenderer=ue;exports.AbstractToolbar=Ve;exports.ActionButtonWidget=ye;exports.BackgroundComponent=Y;exports.BackgroundComponentBackgroundType=Yt;exports.BaseTool=M;exports.BaseToolWidget=ee;exports.BaseWidget=_;exports.CanvasRenderer=he;exports.Color4=w;exports.Command=fe;exports.ComponentSizingMode=At;exports.Display=Rt;exports.DocumentPropertiesWidget=pt;exports.DummyRenderer=Me;exports.Duplicate=bt;exports.Editor=$r;exports.EditorEventType=Rs;exports.EditorImage=H;exports.Erase=U;exports.EraserMode=ii;exports.EraserTool=Ae;exports.EraserToolWidget=ut;exports.EventDispatcher=ge;exports.HTMLToolbar=Ve;exports.HandToolWidget=ht;exports.IconProvider=It;exports.ImageComponent=te;exports.InputEvtType=Uo;exports.InputMapper=ce;exports.InsertImageWidget=mi;exports.KeyBinding=nt;exports.KeyboardShortcutManager=A;exports.LineSegment2=Q;exports.Mat33=T;exports.MutableReactiveValue=K;exports.PanZoomMode=ri;exports.PanZoomTool=ae;exports.Parameterized2DShape=So;exports.PasteHandler=Ct;exports.Path=R;exports.PathCommandType=$;exports.PenTool=Ee;exports.PenToolWidget=mt;exports.Pointer=de;exports.PointerDevice=Jo;exports.QuadraticBezier=me;exports.ReactiveValue=F;exports.Rect2=P;exports.RenderingMode=Hr;exports.SVGLoader=De;exports.SVGRenderer=oe;exports.SelectAllShortcutHandler=Tt;exports.SelectionMode=Jt;exports.SelectionTool=re;exports.SelectionToolWidget=xt;exports.SerializableCommand=V;exports.SoundUITool=hi;exports.Stroke=D;exports.StrokeComponent=D;exports.StrokeSmoother=Xs;exports.Text=q;exports.TextComponent=q;exports.TextTool=ve;exports.TextToolWidget=St;exports.ToolController=Et;exports.ToolEnabledGroup=Je;exports.ToolSwitcherShortcut=wt;exports.ToolbarShortcutHandler=Re;exports.ToolbarWidgetTag=wn;exports.Triangle=Li;exports.UndoEventType=Ls;exports.UndoRedoHistory=Wr;exports.UndoRedoShortcut=Pt;exports.Viewport=L;exports.__easy_draw__version=fo;exports.adjustEditorThemeForContrast=za;exports.comparePathIndices=Io;exports.createRestyleComponentCommand=$e;exports.default=Lw;exports.defaultEditorLocalization=Be;exports.getLocalizationTable=qi;exports.invertCommand=ba;exports.isPointerEvt=Nt;exports.isRestylableComponent=Fo;exports.keyPressEventFromHTMLEvent=$o;exports.keyUpEventFromHTMLEvent=Wo;exports.makeArrowBuilder=Gt;exports.makeCircleBuilder=Dt;exports.makeColorInput=Os;exports.makeDropdownToolbar=Pa;exports.makeEdgeToolbar=Ea;exports.makeFilledRectangleBuilder=Zt;exports.makeFreehandLineBuilder=le;exports.makeLineBuilder=jt;exports.makeOutlinedRectangleBuilder=Xi;exports.makePolylineBuilder=Te;exports.makePressureSensitiveFreehandLineBuilder=ze;exports.matchingLocalizationTable=Go;exports.pathFromRenderable=Ne;exports.pathToRenderable=z;exports.pathVisualEquivalent=zi;exports.sendPenEvent=Nr;exports.sendTouchEvent=La;exports.stepPathIndexBy=Ri;exports.toRoundedString=J;exports.uniteCommands=j;